<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>Secure Login Service</title><link rel="stylesheet" type="text/css" href="docbook-xsl.css" /><meta name="generator" content="DocBook XSL Stylesheets Vsnapshot" /></head><body><div xml:lang="en" class="book" lang="en"><div class="titlepage"><div><div><h1 class="title"><a id="idm1"></a>Secure Login Service</h1></div><div><h2 class="subtitle">Administrators Guide</h2></div><div><p class="copyright">Copyright © 2024 United Security Providers AG</p></div><div><div class="legalnotice"><a id="idm9"></a><p>
    This document is protected by copyright under the applicable laws and
    international treaties. No part of this document may be reproduced in any
    form and distributed to third parties by any means without prior written
    authorization of United Security Providers AG.
  </p><p>
    DOCUMENTATION IS PROVIDED "AS IS" AND ALL EXPRESSED OR
    IMPLIED REPRESENTATIONS AND WARRANTIES, INCLUDING BUT
    NOT LIMITED TO ANY IMPLIED WARRANTY OF MERCHANTABILITY,
    FITNESS FOR A PARTICULAR PURPOSE OR NON-INFRINGEMENT,
    ARE DISCLAIMED TO THE EXTENT PERMISSIBLE UNDER THE
    APPLICABLE LAWS.
  </p></div></div></div><hr /></div><div class="toc"><p><strong>Table of Contents</strong></p><dl class="toc"><dt><span class="part"><a href="#_sls_core">I. SLS Core</a></span></dt><dd><dl><dt><span class="chapter"><a href="#_overview">1. Overview</a></span></dt><dd><dl><dt><span class="section"><a href="#_purpose_of_this_document">1.1. Purpose Of This Document</a></span></dt><dt><span class="section"><a href="#_target_audience">1.2. Target Audience</a></span></dt><dt><span class="section"><a href="#_introduction">1.3. Introduction</a></span></dt><dt><span class="section"><a href="#x81027_Heading1Tarsec_Overview">1.4. Features</a></span></dt><dt><span class="section"><a href="#_security_relevant_features">1.5. Security-relevant features</a></span></dt><dt><span class="section"><a href="#_delivery_contents">1.6. Delivery Contents</a></span></dt></dl></dd><dt><span class="chapter"><a href="#x75699_Heading1Tarsec_Deployment">2. Installation</a></span></dt><dd><dl><dt><span class="section"><a href="#_overview_2">2.1. Overview</a></span></dt><dt><span class="section"><a href="#x56605_Heading2Tarsec_Prerequisites">2.2. Prerequisites</a></span></dt><dt><span class="section"><a href="#_java_version_support">2.3. Java Version Support</a></span></dt><dt><span class="section"><a href="#_hsp_srmanager">2.4. HSP SRManager</a></span></dt><dt><span class="section"><a href="#_apache_tomcat_installation">2.5. Apache Tomcat installation</a></span></dt><dt><span class="section"><a href="#x22317_Heading2Tarsec_SLS">2.6. deployment</a></span></dt><dt><span class="section"><a href="#_adapter_installation">2.7. Adapter installation</a></span></dt></dl></dd><dt><span class="chapter"><a href="#x98288_Heading2Tarsec_SLS_Configuration">3. Configuration</a></span></dt><dd><dl><dt><span class="section"><a href="#_overview_3">3.1. Overview</a></span></dt><dt><span class="section"><a href="#_configuration_directory_and_files">3.2. Configuration Directory And Files</a></span></dt><dt><span class="section"><a href="#_configuration_files">3.3. Configuration Files</a></span></dt><dt><span class="section"><a href="#_variables_in_property_values">3.4. Variables In Property Values</a></span></dt><dt><span class="section"><a href="#_sls_seal_dataprotector_replacement">3.5. SLS Seal (DataProtector replacement)</a></span></dt><dt><span class="section"><a href="#x93365_Heading2Tarsec_Dynamic_Properties">3.6. Dynamic Properties</a></span></dt><dt><span class="section"><a href="#_deprecated_properties">3.7. Deprecated Properties</a></span></dt><dt><span class="section"><a href="#_system_properties">3.8. System Properties</a></span></dt><dt><span class="section"><a href="#x22044_Heading3Tarsec_SLS_properties">3.9. SLS Properties</a></span></dt></dl></dd><dt><span class="chapter"><a href="#x91247_Heading1Tarsec_Recommended_Settings">4. Recommended Settings</a></span></dt><dd><dl><dt><span class="section"><a href="#_jvm_startup_parameters">4.1. JVM startup parameters</a></span></dt><dt><span class="section"><a href="#_tomcat_server_settings">4.2. Tomcat server settings</a></span></dt><dt><span class="section"><a href="#_sls_settings">4.3. SLS Settings</a></span></dt><dt><span class="section"><a href="#_disable_debug_logging">4.4. Disable debug logging</a></span></dt><dt><span class="section"><a href="#_concurrent_connections_in_hsp_and_sls">4.5. Concurrent connections in HSP and SLS</a></span></dt><dt><span class="section"><a href="#_encrypt_configuration_properties">4.6. Encrypt configuration properties</a></span></dt><dt><span class="section"><a href="#_avoid_mock_up_test_classes">4.7. Avoid Mock-Up / Test Classes</a></span></dt></dl></dd><dt><span class="chapter"><a href="#x60248_Heading1Tarsec_Deprecated_Features">5. Deprecated And Removed Features</a></span></dt><dd><dl><dt><span class="section"><a href="#_deprecated_features">5.1. Deprecated Features</a></span></dt><dt><span class="section"><a href="#_removed_features">5.2. Removed Features</a></span></dt></dl></dd><dt><span class="chapter"><a href="#x15273_Heading1Tarsec_Commands">6. Commands ("cmd" parameter)</a></span></dt><dd><dl><dt><span class="section"><a href="#x112244_Heading1Tarsec_Ping_Action">6.1. "pingsls" - Ping SLS</a></span></dt><dt><span class="section"><a href="#x112233_Heading1Tarsec_Cancel_Action">6.2. "cancel" - Cancel action / flow</a></span></dt><dt><span class="section"><a href="#x112233_Heading1Tarsec_Display_Single_JSP_Command">6.3. "displayjsp" - Display JSP Command</a></span></dt></dl></dd><dt><span class="chapter"><a href="#x29792_Heading1Tarsec_Model">7. Model</a></span></dt><dd><dl><dt><span class="section"><a href="#_overview_4">7.1. Overview</a></span></dt><dt><span class="section"><a href="#_model_anatomy">7.2. Model Anatomy</a></span></dt><dt><span class="section"><a href="#_configuration_structure">7.3. Configuration Structure</a></span></dt><dt><span class="section"><a href="#x77246_Heading2Tarsec_Model_to_Dispatch_mapping">7.4. Model to dispatch mapping</a></span></dt><dt><span class="section"><a href="#_examples">7.5. Examples</a></span></dt><dt><span class="section"><a href="#_customization">7.6. Customization</a></span></dt><dt><span class="section"><a href="#x26318_Heading2Tarsec_Triggering_a_model">7.7. Triggering a model</a></span></dt><dt><span class="section"><a href="#x91864_Heading2Tarsec_Trigger_Priority">7.8. Trigger Priority</a></span></dt><dt><span class="section"><a href="#x11534_Heading2Tarsec_List_of_model_states">7.9. List of model states</a></span></dt></dl></dd><dt><span class="chapter"><a href="#x38692_Heading1Tarsec_Credential_Providers">8. Credential Providers</a></span></dt><dd><dl><dt><span class="section"><a href="#_overview_5">8.1. Overview</a></span></dt><dt><span class="section"><a href="#x16078_Heading2Tarsec_Configuration">8.2. Configuration</a></span></dt><dt><span class="section"><a href="#_providers">8.3. Providers</a></span></dt><dt><span class="section"><a href="#x99987_Heading2Tarsec_Semantic_Types">8.4. Semantic Types</a></span></dt></dl></dd><dt><span class="chapter"><a href="#title2_Challenge_Response">9. Challenge / Response</a></span></dt><dd><dl><dt><span class="section"><a href="#_challenge_response_adapter_configuration">9.1. Challenge / Response Adapter Configuration</a></span></dt><dt><span class="section"><a href="#_sms_challenge_response_with_http_adapter">9.2. SMS Challenge / Response with HTTP adapter</a></span></dt></dl></dd><dt><span class="chapter"><a href="#x84028_Heading1Tarsec_Session_Handling">10. Session Handling</a></span></dt><dd><dl><dt><span class="section"><a href="#_introduction_2">10.1. Introduction</a></span></dt><dt><span class="section"><a href="#_configuration">10.2. Configuration</a></span></dt><dt><span class="section"><a href="#_avoiding_container_sessions">10.3. Avoiding Container Sessions</a></span></dt><dt><span class="section"><a href="#x84418_Heading2Tarsec_DEBUG_TRACE_Logging">10.4. DEBUG / TRACE Logging</a></span></dt></dl></dd><dt><span class="chapter"><a href="#x10002_Heading1Tarsec_Redirecting">11. Redirecting</a></span></dt><dd><dl><dt><span class="section"><a href="#_after_login_logout">11.1. After Login / Logout</a></span></dt><dt><span class="section"><a href="#_url_parameter_target">11.2. URL parameter "target"</a></span></dt><dt><span class="section"><a href="#_configuration_properties">11.3. Configuration Properties</a></span></dt><dt><span class="section"><a href="#_redirect_response_to_post_requests">11.4. Redirect Response to POST requests</a></span></dt><dt><span class="section"><a href="#_mapped_redirects">11.5. Mapped Redirects</a></span></dt><dt><span class="section"><a href="#_application_logout">11.6. Application Logout</a></span></dt></dl></dd><dt><span class="chapter"><a href="#x10004_Heading1Tarsec_Parameter_Checker">12. Parameter Checker / Aliases</a></span></dt><dd><dl><dt><span class="section"><a href="#_parameter_aliases">12.1. Parameter Aliases</a></span></dt><dt><span class="section"><a href="#_parameter_checker">12.2. Parameter Checker</a></span></dt></dl></dd><dt><span class="chapter"><a href="#x67409_Heading1Tarsec_Concurrency_Issues_with_Browser_Tabs">13. Concurrency Issues with Browser Tabs</a></span></dt><dd><dl><dt><span class="section"><a href="#_hsp_srm_configuration">13.1. HSP SRM configuration</a></span></dt><dt><span class="section"><a href="#_sls_configuration">13.2. SLS configuration</a></span></dt><dt><span class="section"><a href="#_disabling_password_policy">13.3. Disabling Password Policy</a></span></dt><dt><span class="section"><a href="#_policy_attributes">13.4. Policy Attributes</a></span></dt></dl></dd><dt><span class="chapter"><a href="#x10001_Heading2Tarsec_Localization">14. Localization</a></span></dt><dd><dl><dt><span class="section"><a href="#_overview_6">14.1. Overview</a></span></dt><dt><span class="section"><a href="#x18580_Heading2Tarsec_Selecting_User_Language">14.2. Selecting User Language</a></span></dt><dt><span class="section"><a href="#_language_cookie">14.3. Language Cookie</a></span></dt><dt><span class="section"><a href="#x17268_Heading3Tarsec_Message_Resource_Files">14.4. Message Resource Files</a></span></dt><dt><span class="section"><a href="#_asian_language_support">14.5. Asian Language Support</a></span></dt></dl></dd><dt><span class="chapter"><a href="#_jsps">15. JSPs</a></span></dt><dd><dl><dt><span class="section"><a href="#_jsp_files">15.1. JSP Files</a></span></dt><dt><span class="section"><a href="#_jsp_tag_library">15.2. JSP Tag Library</a></span></dt><dt><span class="section"><a href="#_jsp_configuration_settings">15.3. JSP Configuration Settings</a></span></dt><dt><span class="section"><a href="#_bootstrap_upgrade">15.4. Bootstrap Upgrade</a></span></dt></dl></dd><dt><span class="chapter"><a href="#_user_filtering_anchor_id_14243_heading1tarsec_user_filtering_xreflabel_14243_heading1tarsec_user_filtering">16. User Filtering</a></span></dt><dd><dl><dt><span class="section"><a href="#_introduction_3">16.1. Introduction</a></span></dt><dt><span class="section"><a href="#_user_filter_file_format">16.2. User Filter File Format</a></span></dt><dt><span class="section"><a href="#_filter_configuration">16.3. Filter Configuration</a></span></dt></dl></dd><dt><span class="chapter"><a href="#x33260_Heading1Tarsec_Sending_eMail">17. Sending E-Mail</a></span></dt><dd><dl><dt><span class="section"><a href="#_sending_e_mail">17.1. Sending E-Mail</a></span></dt><dt><span class="section"><a href="#_e_mail_environment">17.2. E-Mail Environment</a></span></dt></dl></dd><dt><span class="chapter"><a href="#x18987_Heading1Tarsec_Multitenancy_Support">18. Multitenancy Support</a></span></dt><dd><dl><dt><span class="section"><a href="#_how_it_works">18.1. How it works</a></span></dt><dt><span class="section"><a href="#_activation">18.2. Activation</a></span></dt><dt><span class="section"><a href="#_defining_tenants">18.3. Defining tenants</a></span></dt><dt><span class="section"><a href="#_resolving_tenants">18.4. Resolving tenants</a></span></dt><dt><span class="section"><a href="#_using_tenants">18.5. Using Tenants</a></span></dt><dt><span class="section"><a href="#_complete_simple_example">18.6. Complete Simple Example</a></span></dt></dl></dd><dt><span class="chapter"><a href="#x76105_Heading1Tarsec_Blacklist">19. Browser Blacklist</a></span></dt><dd><dl><dt><span class="section"><a href="#_introduction_4">19.1. Introduction</a></span></dt><dt><span class="section"><a href="#_ssl_session_id_fixation">19.2. SSL Session ID Fixation</a></span></dt><dt><span class="section"><a href="#_blacklist_configuration_properties">19.3. Blacklist Configuration Properties</a></span></dt><dt><span class="section"><a href="#_blacklist_file_format">19.4. Blacklist File Format</a></span></dt></dl></dd><dt><span class="chapter"><a href="#x27589_Heading1Tarsec_Login_Slowdown">20. Login Slowdown</a></span></dt><dd><dl><dt><span class="section"><a href="#_introduction_5">20.1. Introduction</a></span></dt><dt><span class="section"><a href="#_slowdown_model_states">20.2. Slowdown Model States</a></span></dt><dt><span class="section"><a href="#_configuration_properties_3">20.3. Configuration Properties</a></span></dt></dl></dd><dt><span class="chapter"><a href="#x38834_Heading1Tarsec_Basic_Authentication">21. HTTP Basic Authentication</a></span></dt><dd><dl><dt><span class="section"><a href="#_introduction_6">21.1. Introduction</a></span></dt><dt><span class="section"><a href="#_https_only">21.2. HTTPS Only</a></span></dt><dt><span class="section"><a href="#_user_agent_header_matching">21.3. User-Agent Header Matching</a></span></dt></dl></dd><dt><span class="chapter"><a href="#x60248_Heading1Tarsec_Browser_ID_Check_BID">22. Browser ID Check ("BID")</a></span></dt><dt><span class="chapter"><a href="#x53260_Heading1Tarsec_SSO_Integration">23. SSO Integration</a></span></dt><dd><dl><dt><span class="section"><a href="#_overview_7">23.1. Overview</a></span></dt><dt><span class="section"><a href="#x49306_Heading2Tarsec_Request_Filtering">23.2. SSO HTTP headers</a></span></dt><dt><span class="section"><a href="#x62555_Heading2Tarsec_J2EE_Authentication_Filter">23.3. SSO Request Filters</a></span></dt><dt><span class="section"><a href="#x66726_Heading2Tarsec_SSO_Configuration_Examples">23.4. SSO Configuration Examples</a></span></dt><dt><span class="section"><a href="#x97662_Heading2Tarsec_Application_Server">23.5. Application Server Authentication</a></span></dt></dl></dd><dt><span class="chapter"><a href="#x75173_Heading1Tarsec_Cookies">24. Cookies</a></span></dt><dd><dl><dt><span class="section"><a href="#_tomcat_cookie_compliance">24.1. Tomcat Cookie Compliance</a></span></dt><dt><span class="section"><a href="#_tomcat_double_cookie_issue">24.2. Tomcat Double Cookie Issue</a></span></dt><dt><span class="section"><a href="#_sls_cookies_2">24.3. SLS Cookies</a></span></dt><dt><span class="section"><a href="#_using_stored_values">24.4. Using stored values</a></span></dt><dt><span class="section"><a href="#_custom_cookies">24.5. Custom Cookies</a></span></dt></dl></dd><dt><span class="chapter"><a href="#x19283_Heading1Tarsec_Logging">25. Logging</a></span></dt><dd><dl><dt><span class="section"><a href="#_overview_8">25.1. Overview</a></span></dt><dt><span class="section"><a href="#_log4j_1_vs_log4j_2">25.2. Log4j 1 vs Log4j 2</a></span></dt><dt><span class="section"><a href="#_fixed_known_log4j_1_2_vulnerabilities">25.3. Fixed Known Log4j 1.2 Vulnerabilities</a></span></dt><dt><span class="section"><a href="#_functionality">25.4. Functionality</a></span></dt><dt><span class="section"><a href="#x81732_Heading2Tarsec_Log4J_configuration">25.5. Log4J Configuration</a></span></dt><dt><span class="section"><a href="#_enabling_disabling_logging">25.6. Enabling / Disabling logging</a></span></dt><dt><span class="section"><a href="#x59059_Heading2Tarsec_Tenant_specific_logging">25.7. Tenant-specific logging</a></span></dt><dt><span class="section"><a href="#_syslog_support">25.8. Syslog support</a></span></dt><dt><span class="section"><a href="#x98754_Logstash_Elasticsearch_support">25.9. Logstash and Elasticsearch support</a></span></dt><dt><span class="section"><a href="#Filtering_Passwords">25.10. Filtering Passwords</a></span></dt><dt><span class="section"><a href="#Disabling_Multiline_Stacktraces">25.11. Disabling Multiline Stacktraces</a></span></dt><dt><span class="section"><a href="#x123123_SLS_Logging_Variables">25.12. SLS Logging Variables</a></span></dt><dt><span class="section"><a href="#_custom_log_messages">25.13. Custom Log Messages</a></span></dt><dt><span class="section"><a href="#_performance_log">25.14. Performance Log</a></span></dt></dl></dd><dt><span class="chapter"><a href="#_hsp_load_balancing">26. HSP Load Balancing</a></span></dt><dd><dl><dt><span class="section"><a href="#_introduction_7">26.1. Introduction</a></span></dt><dt><span class="section"><a href="#_sls_load_calculation">26.2. SLS Load Calculation</a></span></dt></dl></dd><dt><span class="chapter"><a href="#x12345_Heading1Tarsec_loadbalancing_failover">27. Load-Balancing / Failover</a></span></dt><dd><dl><dt><span class="section"><a href="#_simple_failover_default">27.1. Simple Failover (default)</a></span></dt><dt><span class="section"><a href="#_failover_with_primary_system">27.2. Failover with primary system</a></span></dt><dt><span class="section"><a href="#_load_balancing">27.3. Load-Balancing</a></span></dt></dl></dd><dt><span class="chapter"><a href="#x12345_Heading1Tarsec_Connection_monitoring">28. Backend Monitoring</a></span></dt><dd><dl><dt><span class="section"><a href="#_configuration_property">28.1. Configuration Property</a></span></dt><dt><span class="section"><a href="#_temporarily_exlude_backend_from_monitoring">28.2. Temporarily Exlude Backend From Monitoring</a></span></dt></dl></dd><dt><span class="chapter"><a href="#x10003_Heading1Tarsec_Parameter_Passing">29. HSP Parameter Passing / Gateway</a></span></dt><dd><dl><dt><span class="section"><a href="#_overview_9">29.1. Overview</a></span></dt><dt><span class="section"><a href="#_how_it_works_2">29.2. How it works</a></span></dt><dt><span class="section"><a href="#_installing_required_jar_file">29.3. Installing Required ".jar" file</a></span></dt><dt><span class="section"><a href="#x37596_Heading2Tarsec_Configuration_Properties">29.4. Configuration Properties</a></span></dt><dt><span class="section"><a href="#_url_parameter_usage">29.5. URL Parameter Usage</a></span></dt><dt><span class="section"><a href="#_example_2">29.6. Example</a></span></dt><dt><span class="section"><a href="#x99995_Heading3Tarsec_Modifying_Gateway_Parameters">29.7. Modifying Parameters with "gw-param."</a></span></dt></dl></dd><dt><span class="chapter"><a href="#x66021_Heading1Tarsec_SES_Login_Ticket">30. SES Login Ticket</a></span></dt><dd><dl><dt><span class="section"><a href="#_introduction_8">30.1. Introduction</a></span></dt><dt><span class="section"><a href="#_issuing_ses_login_tickets">30.2. Issuing SES Login Tickets</a></span></dt><dt><span class="section"><a href="#_configuration_3">30.3. Configuration</a></span></dt><dt><span class="section"><a href="#_example_3">30.4. Example</a></span></dt><dt><span class="section"><a href="#_ses_ticket_credential_provider">30.5. SES Ticket Credential Provider</a></span></dt></dl></dd><dt><span class="chapter"><a href="#x66021_Heading1Tarsec_JSON_Web_Tokens">31. JSON Web Tokens</a></span></dt><dd><dl><dt><span class="section"><a href="#_introduction_9">31.1. Introduction</a></span></dt><dt><span class="section"><a href="#_issuing_json_web_tokens">31.2. Issuing JSON Web Tokens</a></span></dt><dt><span class="section"><a href="#_parsing_and_validating_jwts">31.3. Parsing and validating JWTs</a></span></dt><dt><span class="section"><a href="#_direct_use_of_jwt_java_objects">31.4. Direct use of JWT Java Objects</a></span></dt></dl></dd><dt><span class="chapter"><a href="#x49003_Heading1Tarsec_Expressions">32. JEXL Expressions</a></span></dt><dd><dl><dt><span class="section"><a href="#_introduction_10">32.1. Introduction</a></span></dt><dt><span class="section"><a href="#x75969_Heading2Tarsec_JEXL_Versions">32.2. JEXL Versions</a></span></dt><dt><span class="section"><a href="#_expressions">32.3. Expressions</a></span></dt><dt><span class="section"><a href="#_variable_types">32.4. Variable Types</a></span></dt><dt><span class="section"><a href="#x00000_Heading2Tarsec_Request_Variables">32.5. Request Variables</a></span></dt><dt><span class="section"><a href="#x80274_Heading2Tarsec_Special_Variables">32.6. Special Variables</a></span></dt><dt><span class="section"><a href="#_other_variables">32.7. Other Variables</a></span></dt><dt><span class="section"><a href="#x59773_Heading2Tarsec_Functions">32.8. Functions</a></span></dt><dt><span class="section"><a href="#x92172_Heading2Tarsec_JEXL_Version_Issues">32.9. JEXL Known Issues</a></span></dt><dt><span class="section"><a href="#_usage_examples">32.10. Usage Examples</a></span></dt><dt><span class="section"><a href="#x93809_Heading2Tarsec_Custom_JEXL_Expressions">32.11. Custom JEXL Expressions</a></span></dt><dt><span class="section"><a href="#_custom_encryption_functions">32.12. Custom Encryption Functions</a></span></dt></dl></dd><dt><span class="chapter"><a href="#_groovy_scripting_2">33. Groovy Scripting</a></span></dt><dd><dl><dt><span class="section"><a href="#_introduction_11">33.1. Introduction</a></span></dt><dt><span class="section"><a href="#_basic_usage">33.2. Basic Usage</a></span></dt><dt><span class="section"><a href="#_groovy_utility_scripts">33.3. Groovy Utility Scripts</a></span></dt><dt><span class="section"><a href="#_groovy_provider_configuration">33.4. Groovy Provider Configuration</a></span></dt><dt><span class="section"><a href="#_using_java_classes">33.5. Using Java Classes</a></span></dt><dt><span class="section"><a href="#_json_map_list_handling_in_groovy">33.6. JSON + Map/List handling in Groovy</a></span></dt><dt><span class="section"><a href="#_jexl_to_groovy_migration">33.7. JEXL to Groovy migration</a></span></dt><dt><span class="section"><a href="#_groovy_resources">33.8. Groovy Resources</a></span></dt></dl></dd><dt><span class="chapter"><a href="#x66021_Heading1Tarsec_SES_Session_Attributes">34. SES Session Attributes</a></span></dt><dd><dl><dt><span class="section"><a href="#_background">34.1. Background</a></span></dt><dt><span class="section"><a href="#_configuration_5">34.2. Configuration</a></span></dt><dt><span class="section"><a href="#x30341_Heading2Tarsec_Session_Attribute_Value_Encoding">34.3. Session Attribute Value Encoding</a></span></dt><dt><span class="section"><a href="#_jexl_functions">34.4. JEXL Functions</a></span></dt><dt><span class="section"><a href="#_examples_2">34.5. Examples</a></span></dt></dl></dd><dt><span class="chapter"><a href="#x91117_Heading1Tarsec_Errorcodes">35. Error Handling</a></span></dt><dd><dl><dt><span class="section"><a href="#_introduction_12">35.1. Introduction</a></span></dt><dt><span class="section"><a href="#x74841_Heading2Tarsec_Displaying_Internal_Error_Code">35.2. Displaying Internal Error Code</a></span></dt><dt><span class="section"><a href="#x19350_Heading2Tarsec_Internal_Error_Code_HTTP_Response_Header">35.3. Internal Error Code HTTP Response Header</a></span></dt><dt><span class="section"><a href="#x79584_Heading2Tarsec_Error_Code_Mapping_Configuration">35.4. Error Code Mapping Configuration</a></span></dt><dt><span class="section"><a href="#x43339_Heading2Tarsec_Multiple_Errors_Showing_First_Or_Last">35.5. Multiple Errors / Showing First Or Last</a></span></dt><dt><span class="section"><a href="#_triggering_enforcing_errors">35.6. Triggering / Enforcing Errors</a></span></dt><dt><span class="section"><a href="#_state_specific_error_messages">35.7. State-Specific Error Messages</a></span></dt><dt><span class="section"><a href="#x82593_Heading2Tarsec_Displaying_Debug_Information">35.8. Displaying Debug Information</a></span></dt></dl></dd><dt><span class="chapter"><a href="#Geode">36. Apache Geode Support</a></span></dt><dt><span class="chapter"><a href="#_storing_reading_data">37. Storing / Reading Data</a></span></dt><dt><span class="chapter"><a href="#_headers">38. Headers</a></span></dt><dd><dl><dt><span class="section"><a href="#_hsp_response_header_filtering">38.1. HSP Response Header Filtering</a></span></dt><dt><span class="section"><a href="#x121212_Heading1Tarsec_SLSStatus_Header">38.2. Header "SLSStatus"</a></span></dt><dt><span class="section"><a href="#_header_slserror">38.3. Header "SLSError"</a></span></dt><dt><span class="section"><a href="#_header_accessarea">38.4. Header "AccessArea"</a></span></dt></dl></dd><dt><span class="chapter"><a href="#x30434_Heading1Tarsec_Tools">39. Support Tools</a></span></dt><dd><dl><dt><span class="section"><a href="#_introduction_13">39.1. Introduction</a></span></dt><dt><span class="section"><a href="#_jsp_compile_tool">39.2. JSP Compile Tool</a></span></dt><dt><span class="section"><a href="#x33956_Heading2Tarsec_DataProtector">39.3. SLS Seal (DataProtector replacement)</a></span></dt><dt><span class="section"><a href="#x97591_Heading2Tarsec_SES_Ticket_API_Tool">39.4. SES Ticket API Tool</a></span></dt><dt><span class="section"><a href="#x23363_Heading2Tarsec_SLS_Tool">39.5. SLS Tool</a></span></dt></dl></dd><dt><span class="chapter"><a href="#x34533_Heading1Tarsec_SLS_Modules">40. SLS Modules</a></span></dt><dd><dl><dt><span class="section"><a href="#_modules_file_content">40.1. Modules File Content</a></span></dt><dt><span class="section"><a href="#_list_of_sls_modules">40.2. List Of SLS Modules</a></span></dt></dl></dd><dt><span class="chapter"><a href="#x50805_Heading1Tarsec_SSL_JSSE">41. TLS/SSL (JSSE)</a></span></dt><dd><dl><dt><span class="section"><a href="#_jsse_information">41.1. JSSE Information</a></span></dt><dt><span class="section"><a href="#_login_service_as_ssl_client">41.2. Login Service as SSL client</a></span></dt><dt><span class="section"><a href="#_client_mutual_authentication_setup">41.3. Client (Mutual) Authentication Setup</a></span></dt><dt><span class="section"><a href="#_debugging_ssl_jsse">41.4. Debugging SSL / JSSE</a></span></dt><dt><span class="section"><a href="#_tlsv1_3">41.5. TLSv1.3</a></span></dt></dl></dd><dt><span class="chapter"><a href="#x34533_Heading1Tarsec_HTTP_Methods">42. HTTP Methods</a></span></dt><dd><dl><dt><span class="section"><a href="#_get_head_and_post">42.1. GET, HEAD and POST</a></span></dt><dt><span class="section"><a href="#_options">42.2. OPTIONS</a></span></dt><dt><span class="section"><a href="#_other_methods">42.3. Other Methods</a></span></dt><dt><span class="section"><a href="#_handling_http_request_body">42.4. Handling HTTP Request Body</a></span></dt><dt><span class="section"><a href="#_body_for_other_methods">42.5. Body for other Methods</a></span></dt></dl></dd></dl></dd><dt><span class="part"><a href="#x10006_Heading1Tarsec_SOAP">II. SOAP</a></span></dt><dd><dl><dt><span class="chapter"><a href="#_overview_10">43. Overview</a></span></dt><dd><dl><dt><span class="section"><a href="#_sending_soap_requests_to_a_web_service">43.1. Sending SOAP Requests to a web service</a></span></dt><dt><span class="section"><a href="#_sending_soap_step_by_step">43.2. Sending SOAP, Step by Step</a></span></dt></dl></dd></dl></dd><dt><span class="part"><a href="#_saml">III. SAML</a></span></dt><dd><dl><dt><span class="chapter"><a href="#_saml_2_identity_provider">44. SAML 2 Identity Provider</a></span></dt><dt><span class="chapter"><a href="#_saml_2_service_provider">45. SAML 2 Service Provider</a></span></dt><dd><dl><dt><span class="section"><a href="#x10000_Heading1Tarsec_SAML_XML_SigRefDigAlg">45.1. XML Signature Reference Digest Algorithm</a></span></dt></dl></dd></dl></dd><dt><span class="part"><a href="#_adapters_authentication_systems">IV. Adapters / Authentication Systems</a></span></dt><dd><dl><dt><span class="chapter"><a href="#x76733_Heading1Tarsec_File_Adapter">46. File Adapter</a></span></dt><dd><dl><dt><span class="section"><a href="#_introduction_14">46.1. Introduction</a></span></dt><dt><span class="section"><a href="#_features">46.2. Features</a></span></dt><dt><span class="section"><a href="#_configuration_6">46.3. Configuration</a></span></dt><dt><span class="section"><a href="#_example_user_configuration">46.4. Example User Configuration</a></span></dt></dl></dd><dt><span class="chapter"><a href="#_google_authenticator_adapter">47. Google Authenticator Adapter</a></span></dt><dd><dl><dt><span class="section"><a href="#_introduction_15">47.1. Introduction</a></span></dt><dt><span class="section"><a href="#_configuration_7">47.2. Configuration</a></span></dt><dt><span class="section"><a href="#x_googleauth_adapter_doc_Heading3Tarsec_Secret_Configuration">47.3. Secret Configuration</a></span></dt><dt><span class="section"><a href="#_jsp">47.4. JSP</a></span></dt><dt><span class="section"><a href="#_jexl_functions_2">47.5. JEXL Functions</a></span></dt><dt><span class="section"><a href="#_sls_properties">47.6. SLS Properties</a></span></dt><dt><span class="section"><a href="#_models">47.7. Models</a></span></dt><dt><span class="section"><a href="#_qr_code_model">47.8. QR-Code Model</a></span></dt></dl></dd><dt><span class="chapter"><a href="#x12089_Heading1Tarsec_HTTP_Adapter">48. HTTP Adapter</a></span></dt><dd><dl><dt><span class="section"><a href="#_introduction_16">48.1. Introduction</a></span></dt><dt><span class="section"><a href="#_features_2">48.2. Features</a></span></dt><dt><span class="section"><a href="#_configuration_8">48.3. Configuration</a></span></dt><dt><span class="section"><a href="#x55606_Heading3Tarsec_Scripting_Variables">48.4. Scripting</a></span></dt><dt><span class="section"><a href="#_http_adapter_configuration_properties">48.5. HTTP Adapter Configuration Properties</a></span></dt><dt><span class="section"><a href="#x1234_Heading1Tarsec_HTTP_Connection_monitoring">48.6. HTTP Connection monitoring</a></span></dt><dt><span class="section"><a href="#x_http_adapter_adoc_Proxy_Support">48.7. Proxy Support</a></span></dt><dt><span class="section"><a href="#x51261_Heading3Tarsec_Authentication_Realms">48.8. Authentication Realms</a></span></dt><dt><span class="section"><a href="#_custom_http_actions">48.9. Custom HTTP Actions</a></span></dt></dl></dd><dt><span class="chapter"><a href="#x10009_Heading1Tarsec_Web_Service_Adapter">49. Web Service Adapter</a></span></dt><dd><dl><dt><span class="section"><a href="#_introduction_17">49.1. Introduction</a></span></dt><dt><span class="section"><a href="#_features_3">49.2. Features</a></span></dt><dt><span class="section"><a href="#_configuration_10">49.3. Configuration</a></span></dt><dt><span class="section"><a href="#_proxy_support">49.4. Proxy Support</a></span></dt><dt><span class="section"><a href="#_authentication_realms">49.5. Authentication Realms</a></span></dt><dt><span class="section"><a href="#_soap_xpath_namespace_issues">49.6. SOAP / XPath Namespace Issues</a></span></dt></dl></dd><dt><span class="chapter"><a href="#x51438_Heading1Tarsec_LDAP_Adapter">50. LDAP Adapter</a></span></dt><dd><dl><dt><span class="section"><a href="#_introduction_18">50.1. Introduction</a></span></dt><dt><span class="section"><a href="#_authentication_2">50.2. Authentication</a></span></dt><dt><span class="section"><a href="#_password_change">50.3. Password Change</a></span></dt><dt><span class="section"><a href="#_mapping">50.4. Mapping</a></span></dt><dt><span class="section"><a href="#_referral_handling">50.5. Referral Handling</a></span></dt><dt><span class="section"><a href="#_custom_ldap_operations">50.6. Custom LDAP Operations</a></span></dt><dt><span class="section"><a href="#_environment_prerequisites_3">50.7. Environment / Prerequisites</a></span></dt><dt><span class="section"><a href="#_configuration_12">50.8. Configuration</a></span></dt><dt><span class="section"><a href="#_examples_3">50.9. Examples</a></span></dt></dl></dd><dt><span class="chapter"><a href="#_ntlm_adapter">51. NTLM Adapter</a></span></dt><dd><dl><dt><span class="section"><a href="#_introduction_19">51.1. Introduction</a></span></dt><dt><span class="section"><a href="#_features_4">51.2. Features</a></span></dt><dt><span class="section"><a href="#_known_limitations_2">51.3. Known Limitations</a></span></dt><dt><span class="section"><a href="#_environment_prerequisites_4">51.4. Environment / Prerequisites</a></span></dt><dt><span class="section"><a href="#x24188_Heading2Tarsec_Computer_Account_Password_Setup">51.5. Computer Account Password Setup</a></span></dt><dt><span class="section"><a href="#_configuration_13">51.6. Configuration</a></span></dt><dt><span class="section"><a href="#_ntlmv2_configuration_example">51.7. NTLMv2 Configuration Example</a></span></dt><dt><span class="section"><a href="#_pre_ntlmv2">51.8. Pre-NTLMv2</a></span></dt><dt><span class="section"><a href="#_ses_configuration">51.9. SES configuration</a></span></dt><dt><span class="section"><a href="#_browser_single_sign_on">51.10. Browser Single Sign On</a></span></dt><dt><span class="glossary"><a href="#_glossary">Glossary</a></span></dt></dl></dd><dt><span class="chapter"><a href="#_radius_adapter">52. RADIUS Adapter</a></span></dt><dd><dl><dt><span class="section"><a href="#_introduction_20">52.1. Introduction</a></span></dt><dt><span class="section"><a href="#_jexl_variables_2">52.2. JEXL Variables</a></span></dt><dt><span class="section"><a href="#_configuration_14">52.3. Configuration</a></span></dt><dt><span class="section"><a href="#_radius_challenge_response">52.4. RADIUS Challenge-/Response</a></span></dt><dt><span class="section"><a href="#_sls_properties_3">52.5. SLS Properties</a></span></dt></dl></dd><dt><span class="chapter"><a href="#_pki_adapter">53. PKI Adapter</a></span></dt><dd><dl><dt><span class="section"><a href="#_introduction_21">53.1. Introduction</a></span></dt><dt><span class="section"><a href="#_features_5">53.2. Features</a></span></dt><dt><span class="section"><a href="#_jexl_variable">53.3. JEXL Variable</a></span></dt><dt><span class="section"><a href="#_configuration_15">53.4. Configuration</a></span></dt><dt><span class="section"><a href="#_crl">53.5. CRL</a></span></dt><dt><span class="section"><a href="#_validation_process">53.6. Validation Process</a></span></dt><dt><span class="section"><a href="#x48025_Heading2Tarsec_Certificate_mapping">53.7. Certificate mapping</a></span></dt><dt><span class="section"><a href="#_apache_tomcat_configuration">53.8. Apache Tomcat configuration</a></span></dt><dt><span class="section"><a href="#_trust_groups">53.9. Trust Groups</a></span></dt><dt><span class="glossary"><a href="#_glossary_2">Glossary</a></span></dt></dl></dd><dt><span class="chapter"><a href="#_rsa_adapter">54. RSA Adapter</a></span></dt><dd><dl><dt><span class="section"><a href="#_introduction_22">54.1. Introduction</a></span></dt><dt><span class="section"><a href="#_features_6">54.2. Features</a></span></dt><dt><span class="section"><a href="#_environment_prerequisites_5">54.3. Environment / Prerequisites</a></span></dt><dt><span class="section"><a href="#_configuration_16">54.4. Configuration</a></span></dt><dt><span class="section"><a href="#_installation">54.5. Installation</a></span></dt></dl></dd><dt><span class="chapter"><a href="#SPNEGO_Adapter_Topic">55. SPNEGO Adapter</a></span></dt><dd><dl><dt><span class="section"><a href="#_introduction_23">55.1. Introduction</a></span></dt><dt><span class="section"><a href="#_features_7">55.2. Features</a></span></dt><dt><span class="section"><a href="#_environment_prerequisites_6">55.3. Environment / Prerequisites</a></span></dt><dt><span class="section"><a href="#_background_2">55.4. Background</a></span></dt><dt><span class="section"><a href="#_configuration_17">55.5. Configuration</a></span></dt><dt><span class="section"><a href="#_installation_checklist">55.6. Installation checklist</a></span></dt><dt><span class="section"><a href="#x44667_Heading1Tarsec_Example">55.7. Example</a></span></dt><dt><span class="section"><a href="#_troubleshooting">55.8. Troubleshooting</a></span></dt><dt><span class="glossary"><a href="#_glossary_3">Glossary</a></span></dt></dl></dd><dt><span class="chapter"><a href="#x10007_Heading1Tarsec_SAML_IdP_Adapter">56. SAML IdP Adapter</a></span></dt><dd><dl><dt><span class="section"><a href="#SAML_IdP_Adapter_Introduction">56.1. Introduction</a></span></dt><dt><span class="section"><a href="#_features_8">56.2. Features</a></span></dt><dt><span class="section"><a href="#_configuration_18">56.3. Configuration</a></span></dt><dt><span class="section"><a href="#_sls_as_saml_2_0_idp_broker">56.4. SLS as SAML 2.0 IdP Broker</a></span></dt><dt><span class="section"><a href="#_change_of_username_credential">56.5. Change of Username Credential</a></span></dt><dt><span class="section"><a href="#SAML_IdP_Adapter_Replace_Key_Pair_Cert">56.6. Replacing the IdP key pair and certificate</a></span></dt><dt><span class="section"><a href="#_assertion_creation_by_state_or_scripted">56.7. Assertion creation by state or scripted</a></span></dt><dt><span class="section"><a href="#_sample_saml_messages_and_metadata">56.8. Sample SAML messages and Metadata</a></span></dt></dl></dd><dt><span class="chapter"><a href="#x10008_Heading1Tarsec_SAML_SP_Adapter">57. SAML SP Adapter</a></span></dt><dd><dl><dt><span class="section"><a href="#SAML_SP_Adapter_Introduction">57.1. Introduction</a></span></dt><dt><span class="section"><a href="#_features_9">57.2. Features</a></span></dt><dt><span class="section"><a href="#_environment_prerequisites_8">57.3. Environment / prerequisites</a></span></dt><dt><span class="section"><a href="#_configuration_19">57.4. Configuration</a></span></dt><dt><span class="section"><a href="#SAML_SP_Adapter_Replace_Key_Pair_Cert">57.5. Replacing the SP key pair and certificate</a></span></dt></dl></dd><dt><span class="chapter"><a href="#x10007_Heading1Tarsec_OIDC_OP_Adapter">58. OIDC OP Adapter</a></span></dt><dd><dl><dt><span class="section"><a href="#OIDC_OP_Adapter_Introduction">58.1. Introduction</a></span></dt><dt><span class="section"><a href="#_features_10">58.2. Features</a></span></dt><dt><span class="section"><a href="#_environment_prerequisites_9">58.3. Environment / prerequisites</a></span></dt><dt><span class="section"><a href="#_configuration_20">58.4. Configuration</a></span></dt><dt><span class="section"><a href="#_op_as_a_hybrid_oidc_saml_broker">58.5. OP as a Hybrid OIDC/SAML Broker</a></span></dt><dt><span class="section"><a href="#_revocation_of_refresh_tokens">58.6. Revocation of refresh_tokens</a></span></dt><dt><span class="section"><a href="#_sample_android_app">58.7. Sample Android App</a></span></dt><dt><span class="section"><a href="#_internal_format_of_tokens">58.8. Internal Format of Tokens</a></span></dt><dt><span class="section"><a href="#plain_oauth_mode">58.9. Plain OAuth 2.0 Mode</a></span></dt></dl></dd><dt><span class="chapter"><a href="#x10243_Heading1Tarsec_OIDC_RP_Adapter">59. OIDC RP Adapter</a></span></dt><dd><dl><dt><span class="section"><a href="#OIDC_RP_Adapter_Introduction">59.1. Introduction</a></span></dt><dt><span class="section"><a href="#_features_11">59.2. Features</a></span></dt><dt><span class="section"><a href="#_environment_prerequisites_10">59.3. Environment / prerequisites</a></span></dt><dt><span class="section"><a href="#_configuration_21">59.4. Configuration</a></span></dt></dl></dd><dt><span class="chapter"><a href="#x10008_Heading1Tarsec_WebAuthn_Adapter">60. WebAuthn Adapter</a></span></dt><dd><dl><dt><span class="section"><a href="#_features_12">60.1. Features</a></span></dt><dt><span class="section"><a href="#_limitations">60.2. Limitations</a></span></dt><dt><span class="section"><a href="#WebAuthn_Adapter_Introduction">60.3. Introduction</a></span></dt><dt><span class="section"><a href="#_how_it_works_3">60.4. How it works</a></span></dt><dt><span class="section"><a href="#_flows">60.5. Flows</a></span></dt><dt><span class="section"><a href="#_configuration_22">60.6. Configuration</a></span></dt><dt><span class="section"><a href="#webauthn_credential_storage">60.7. Credential Storage</a></span></dt><dt><span class="section"><a href="#_script_functions">60.8. Script Functions</a></span></dt></dl></dd><dt><span class="chapter"><a href="#IDM_Adapter">61. IDM (SES Identity) Adapter</a></span></dt><dd><dl><dt><span class="section"><a href="#_introduction_24">61.1. Introduction</a></span></dt><dt><span class="section"><a href="#_jexl_variables_3">61.2. JEXL Variables</a></span></dt><dt><span class="section"><a href="#_authentication_6">61.3. Authentication</a></span></dt><dt><span class="section"><a href="#_configuration_23">61.4. Configuration</a></span></dt></dl></dd><dt><span class="chapter"><a href="#MobileID_Login">62. Mobile ID Login</a></span></dt><dd><dl><dt><span class="section"><a href="#_configuration_details">62.1. Configuration Details</a></span></dt><dt><span class="section"><a href="#_sim_vs_app_mode">62.2. SIM vs App mode</a></span></dt><dt><span class="section"><a href="#_mobile_id_jsps">62.3. Mobile ID JSPs</a></span></dt><dt><span class="section"><a href="#_scripting_variables_2">62.4. Scripting Variables</a></span></dt></dl></dd></dl></dd><dt><span class="part"><a href="#_frontend">V. Frontend</a></span></dt><dd><dl><dt><span class="chapter"><a href="#_sls_frontends">63. SLS Frontends</a></span></dt><dd><dl><dt><span class="section"><a href="#_introduction_25">63.1. Introduction</a></span></dt><dt><span class="section"><a href="#_configuration_24">63.2. Configuration</a></span></dt></dl></dd><dt><span class="chapter"><a href="#x51351_Heading1Tarsec_SOAP_Frontend">64. SOAP Frontend</a></span></dt><dd><dl><dt><span class="section"><a href="#_introduction_26">64.1. Introduction</a></span></dt><dt><span class="section"><a href="#_features_13">64.2. Features</a></span></dt><dt><span class="section"><a href="#x27229_Heading2Tarsec_Configuration">64.3. Configuration</a></span></dt><dt><span class="section"><a href="#_soap_webservice_frontend_logging">64.4. SOAP / Webservice Frontend Logging</a></span></dt><dt><span class="section"><a href="#_web_service_api">64.5. Web Service API</a></span></dt><dt><span class="section"><a href="#_wsdl">64.6. WSDL</a></span></dt></dl></dd></dl></dd><dt><span class="part"><a href="#x17734_Heading1Tarsec_Usage_scenarios">VI. Usage Scenarios</a></span></dt><dd><dl><dt><span class="chapter"><a href="#_use_case_examples">65. Use Case Examples</a></span></dt><dd><dl><dt><span class="section"><a href="#_overview_12">65.1. Overview</a></span></dt><dt><span class="section"><a href="#_authentication_7">65.2. Authentication</a></span></dt><dt><span class="section"><a href="#_authorization">65.3. Authorization</a></span></dt><dt><span class="section"><a href="#_combining_weak_and_strong_authentication">65.4. Combining Weak and Strong Authentication</a></span></dt><dt><span class="section"><a href="#_logout">65.5. Logout</a></span></dt></dl></dd><dt><span class="chapter"><a href="#_sorbay_risk_integration">66. sorbay_risk Integration</a></span></dt><dd><dl><dt><span class="section"><a href="#_introduction_27">66.1. Introduction</a></span></dt><dt><span class="section"><a href="#_prerequisites">66.2. Prerequisites</a></span></dt><dt><span class="section"><a href="#_login_jsp">66.3. Login JSP</a></span></dt><dt><span class="section"><a href="#_login_model_4">66.4. Login Model</a></span></dt><dt><span class="section"><a href="#_sls_properties_6">66.5. SLS Properties</a></span></dt><dt><span class="section"><a href="#_groovy_script">66.6. Groovy Script</a></span></dt></dl></dd><dt><span class="chapter"><a href="#_yubikey_support">67. Yubikey Support</a></span></dt><dd><dl><dt><span class="section"><a href="#_introduction_28">67.1. Introduction</a></span></dt><dt><span class="section"><a href="#_implementation">67.2. Implementation</a></span></dt></dl></dd></dl></dd><dt><span class="part"><a href="#_appendix">VII. Appendix</a></span></dt><dd><dl><dt><span class="chapter"><a href="#HSP_timeouts_appendix">68. HSP Timeouts</a></span></dt><dt><span class="chapter"><a href="#_migration_guide">69. Migration Guide</a></span></dt><dd><dl><dt><span class="section"><a href="#_mandator_8594_tenant">69.1. Mandator -→ Tenant</a></span></dt></dl></dd><dt><span class="chapter"><a href="#_faq">70. FAQ</a></span></dt><dd><dl><dt><span class="section"><a href="#_usage_4">70.1. Usage</a></span></dt><dt><span class="section"><a href="#_troubleshooting_2">70.2. Troubleshooting</a></span></dt></dl></dd><dt><span class="chapter"><a href="#_additions">71. Additions</a></span></dt><dd><dl><dt><span class="section"><a href="#_documentation">71.1. Documentation</a></span></dt><dt><span class="glossary"><a href="#_glossary_4">Glossary</a></span></dt><dt><span class="section"><a href="#x44448_Heading2Tarsec_Regular_expressions">71.2. Regular expressions reference</a></span></dt></dl></dd></dl></dd></dl></div><div class="list-of-tables"><p><strong>List of Tables</strong></p><dl><dt>1.1. <a href="#idm148">Delivery CD</a></dt><dt>5.1. <a href="#idm1017">Deprecated Settings</a></dt><dt>5.2. <a href="#idm1069">Deprecated Functions</a></dt><dt>7.1. <a href="#idm1415">State Attributes And Values</a></dt><dt>7.2. <a href="#idm1857">Alphabetical list of JSP states</a></dt><dt>7.3. <a href="#x39680_TableTitleTarsec_Table_4_Alphabetical_list_of_action_states">Alphabetical list of action states</a></dt><dt>8.1. <a href="#idm2590">Sample credential provider configuration</a></dt><dt>14.1. <a href="#idm3410">Resource Properties Groups</a></dt><dt>19.1. <a href="#idm4180">Blacklist actions</a></dt><dt>23.1. <a href="#idm4487">Filter Mode Support</a></dt><dt>32.1. <a href="#idm6578">List of all variable types and their possible values.</a></dt><dt>32.2. <a href="#idm7269">Available semantic credential types</a></dt><dt>33.1. <a href="#idm7728">JEXL to Groovy migration table</a></dt><dt>55.1. <a href="#idm12109">Possible properties in spnegoLogin.conf</a></dt><dt>71.1. <a href="#idm16101">Additions</a></dt><dt>71.2. <a href="#idm16153">Glossary</a></dt></dl></div><div class="part"><div class="titlepage"><div><div><h1 class="title"><a id="_sls_core"></a>Part I. SLS Core</h1></div></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="_overview"></a>Chapter 1. Overview</h2></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_purpose_of_this_document"></a>1.1. Purpose Of This Document</h2></div></div></div><p>This document describes how to set up, configure and deploy the SLS (Secure Login Service) web application.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_target_audience"></a>1.2. Target Audience</h2></div></div></div><p>The target audience for this document are systems administrators who install and maintain the SLS.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_introduction"></a>1.3. Introduction</h2></div></div></div><p>The Secure Login Service (called  hereafter) is a sub-component of the Secure Entry Server (SES). In order to de-couple the session authorization from the authentication process, the SES delegates the authentication step to the SLS.</p><p>The SLS provides a centralized and customizable application-independent login mechanism. The following core functions are provided by the SLS:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
authentication (login)
</li><li class="listitem">
mapping of login ID to actual user ID
</li><li class="listitem">
gathering authorization information
</li><li class="listitem">
logout (invalidating the SES session)
</li><li class="listitem">
propagating authentication information to the back-end application
</li></ul></div><p>Technically, the SLS is a Java web application running in a standard servlet container such as Apache Tomcat. It handles login requests forwarded from the SES and signals back the result of an authentication process to the SES through custom HTTP response headers. Those headers never reach the browser client, they're processed only by the SES revers proxy.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="x81027_Heading1Tarsec_Overview"></a>1.4. Features</h2></div></div></div><p><span class="strong"><strong>Flexible and extensible</strong></span></p><p>The SLS uses a custom dispatching framework which allows to add new actions or
pages based on custom requirements, if new functionality must be added to the
login service. The SLS can also be customized in many other ways (JSPs, text
message resources, actions, extending the provided default
implementations with custom Java code etc.).</p><p><span class="strong"><strong>Framework</strong></span></p><p>All generic (aka not customer-specific), re-usable functionality of the SLS is
part of the "SLS Framework". This framework represents, together all its 3rd
party libraries, the base upon which the actual SLS implementation is built.
The main functionality of the toolkit is:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
communication with HSP (SES) through custom HTTP request and response headers.
</li><li class="listitem">
custom, lean session handling coupled with HSP sessions
</li><li class="listitem">
generic parameter checking
</li><li class="listitem">
flexible error mapping
</li><li class="listitem">
login slowdown
</li><li class="listitem">
browser blacklist
</li><li class="listitem">
authentication back-end adapter interfaces
</li><li class="listitem">
challenge-response functionality
</li><li class="listitem">
configuration handling
</li><li class="listitem">
logging (performance, audit)
</li><li class="listitem">
multi-language-support
</li></ul></div><p>etc.</p><p><span class="strong"><strong>Dynamic Process Model</strong></span></p><p>The SLS implements a small, efficient state machine which supports dynamically configurable models for performing different operations such as authentication, authorization etc. New, customer-specific processes or steps can easily be implemented and integrated.</p><p><span class="strong"><strong>No Container Sessions</strong></span></p><p>The SLS does not use servlet container sessions for several reasons. The most important one is preventing Denial-of-Service attacks based on exceeding the container's session limit. Instead, the SLS uses a custom session implementation which is coupled to the SSL-sessions controlled by the HSP.</p><p><span class="strong"><strong>Authentication Types</strong></span></p><p>The SLS implements an interface for any kind of adapters to back-end systems for the following actions:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
authentication
</li><li class="listitem">
mapping
</li><li class="listitem">
authorization
</li><li class="listitem">
re-authentication
</li><li class="listitem">
challenge-/response
</li><li class="listitem">
handling user attributes
</li><li class="listitem">
fail-over
</li><li class="listitem">
monitoring connectivity
</li></ul></div><p>It depends on the type of back-end system which of these actions are actually supported. Currently, adapter implementations exist for the following back-end system types:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
LDAP
</li><li class="listitem">
RADIUS
</li><li class="listitem">
RSA SecurID
</li><li class="listitem">
PKI (Certificates)
</li><li class="listitem">
NTLM (Windows Domain authentication)
</li><li class="listitem">
SPNEGO (Kerberos-based authentication)
</li><li class="listitem">
File (based on local XML file)
</li></ul></div><p>Different adapters may be used in combination. Furthermore, the SLS also supports</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
SAML 1.1 Identity Provider for SSO (SAP certified)
</li><li class="listitem">
SAML 2 Service Provider
</li></ul></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_security_relevant_features"></a>1.5. Security-relevant features</h2></div></div></div><p>In order to increase the security level for the authentication process, the following features have been implemented in the :</p><p><span class="strong"><strong>SLS Seal (DataProtector replacement) support</strong></span></p><p>SLS Seal is a utility from United Security Providers, which allows to encrypt passwords or other sensitive values stored in configuration files. Although it does not and cannot provide 100% security, it still raises the bar for someone who accidentally gets access to a configuration file with sensitive data.</p><p><span class="strong"><strong>X-Site-Scripting Prevention</strong></span></p><p>The  prevents potential attackers from having a user unknowingly executing malicious script code on his client system (known as "cross-site scripting attacks"). This is done by ensuring that all parameters sent from the client and included in a response HTML page are HTML-encoded, so that no executable JavaScript code can be secretly included in the response page.</p><p><span class="strong"><strong>Secure User Credentials</strong></span></p><p>User credentials available to the application are provided by the secure  identity header, which can contain just simple credentials or a Kerberos-like ticket with lists of attributes etc.</p><p><span class="strong"><strong>Input Parameter Checker</strong></span></p><p>While the various back-end adapters, actions and JSPs may validate any given request parameter on their own, the SLS also includes a global request parameter check functionality, which serves as an additional layer of security. It performs checks similar to those performed by the HSP, so it is especially important in environments where the SLS is used without the HSP reverse proxy.</p><p><span class="strong"><strong>Re-Authentication</strong></span></p><p>The application can enforce a re-authentication of an already authenticated user (for example when a user performs a critical transaction) to minimize the risks of session-stealing attacks.</p><p><span class="strong"><strong>Challenge-Response</strong></span></p><p>The SLS provides an extensible challenge-response functionality which can also be combined with existing authentication schemes.</p><p><span class="strong"><strong>Login Slowdown</strong></span></p><p>If several login attempts are performed with the same user ID but an invalid password within a short time, the SLS may optionally slow down further login attempts in various, configurable ways. This can help to make password guessing or denial-of-service-attacks harder.</p><p><span class="strong"><strong>User Whitelist</strong></span></p><p>Through a username whitelist functionality, it is possible to restrict access to a running SLS instance immediately to a limited group of people without stopping and restarting the service.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_delivery_contents"></a>1.6. Delivery Contents</h2></div></div></div><p>The following list gives an overview of the files and directories structure of the CD.</p><div class="table"><a id="idm148"></a><p class="title"><strong>Table 1.1. Delivery CD</strong></p><div class="table-contents"><table class="table" summary="Delivery CD" cellpadding="4px" style="border-collapse: collapse;border-top: 3px solid #527bbd; border-bottom: 3px solid #527bbd; border-left: 3px solid #527bbd; border-right: 3px solid #527bbd; "><colgroup><col class="col_1" /><col class="col_2" /></colgroup><thead><tr><th style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top">Description </th><th style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><span class="strong"><strong>Files / Directories</strong></span></th></tr></thead><tbody><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>License</p></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><p><code class="literal">LICENSE.txt</code></p></td></tr><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>Documentation files.</p></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><p><code class="literal">/docs</code></p></td></tr><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>3rd-party licenses (Apache etc.)</p></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><p><code class="literal">/third-party-licenses/</code></p></td></tr><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>HTML files for CD browsing</p></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><p><code class="literal">/html</code></p></td></tr><tr><td style="border-right: 1px solid #527bbd; " align="left" valign="top"><p>SLS web application</p></td><td style="" align="left" valign="top"><p><code class="literal">/sls</code></p></td></tr></tbody></table></div></div><br class="table-break" /></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="x75699_Heading1Tarsec_Deployment"></a>Chapter 2. Installation</h2></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_overview_2"></a>2.1. Overview</h2></div></div></div><p>This chapter contains instructions for getting an SLS instance up and running. All configuration files that are subject to manual change are  described here. Files that have been left out by the descriptions do not need to be changed, at least not in relation to the .</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="x56605_Heading2Tarsec_Prerequisites"></a>2.2. Prerequisites</h2></div></div></div><p>The  is a J2EE-compliant web application. It can be deployed into any J2EE container that supports the following API versions.</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
Servlet API: 3.0
</li><li class="listitem">
JSP API: 1.2
</li></ul></div><p>Furthermore, the SLS has been tested and used with the following environment and component versions:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
Linux &gt;= 2.4
</li><li class="listitem">
Sun Solaris version &gt;= 7
</li><li class="listitem">
Sun Java 2 Platform, Standard Edition (J2SE) version 8 (JDK 1.8.x) and 11. The SLS has been tested and used in
  production environments with Java 8 and 11; see below for more information about Java version support.
</li><li class="listitem">
The "Unlimited Strength Jurisdiction Policy Files" for the "Java Cryptography Extension" (JCE)
  must be installed in the JVM as well.
</li><li class="listitem">
Apache Tomcat 8, 8.5 and 9.
  (TLSv1.3 for SLS front as server requires Tomcat 8.5 (and Java 8u261) or later,
  see <a class="link" href="#x50805_Heading1Tarsec_SSL_JSSE" title="Chapter 41. TLS/SSL (JSSE)">"TLS/SSL (JSSE)"</a> for more details.)
</li><li class="listitem">
App Server components require JDK 6 or later, with exception of the Tomcat 8 Authenticator
  which requires JDK 7 or later (because Tomcat 8 does).
</li></ul></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_tomcat_8_note"></a>2.2.1. Tomcat 8 Note</h3></div></div></div><p>Tomcat 8 will automatically insert a "JSessionID" value into every redirect URL created by the web application,
which can cause a number of issues in the SLS / HSP setup. This can be globally disabled in Tomcat in the file
"<code class="literal">$CATALINA_BASE/conf/web.xml</code>", with this tag:</p><pre class="screen">&lt;session-config&gt;
    &lt;tracking-mode&gt;COOKIE&lt;/tracking-mode&gt;
&lt;/session-config&gt;</pre></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_java_version_support"></a>2.3. Java Version Support</h2></div></div></div><p>All SLS components (except App Server components) have been built with Java 8 and with Java 8 set as the target
(bytecode format). Special notes:</p><p><span class="emphasis"><em>The SLS has been tested to run with Java 8 and Java 11.
Any other runtime Java versions have not been tested and are not officially supported!</em></span></p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_hsp_srmanager"></a>2.4. HSP SRManager</h2></div></div></div><p>The following changes and additional entries have to be added to the SRManager configuration file (usually named "<code class="literal">conf/httpd.conf</code>").</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_hsp_cookie_store"></a>2.4.1. HSP Cookie Store</h3></div></div></div><p>Generally, cookies exchanged between the browser client and the login service are blocked by the SES for security reasons. However, this happens completely transparent to the protected application server. The HSP stores cookies created by a protected application server (and also the SLS) in its cookie-store instead of sending them through to the client, and inserts them in any subsequent request coming from the client. So, to an application server which sets a cookie, this process is transparent, and it cannot determine if the cookie comes from the actual client or the HSP cookie store.</p><p>Cookies in the HSP's cookie store are not stored persistently. They exist only as long as the SSL session between the HSP and the client browser.</p><p>If a cookie needs to be sent to the client in order to be stored there persistently (a typical example for this are GUI preferences), it must be enabled in the SRManager configuration. This process is called setting the cookie 'transparent\'. For more detailled information about the functionality of the HSP Cookie Store, please refer to <a class="link" href="#HTTPADMIN">[HTTPADMIN]</a>.</p><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="_sls_cookies"></a>SLS Cookies</h4></div></div></div><p>The SLS uses a such a 'transparent\' cookie to persistently store the language preference setting of the end-user on the client system. Therefore, that cookie must be defined as transparent in the SRManager configuration.</p><p>The following example shows how to do this for a cookie named "<code class="literal">LSLanguage</code>" globally:</p><pre class="screen">###
# Definitions for cookie filter
###
&lt;IfModule mod_l1_cd_store.c&gt;
&lt;IfModule mod_session_int_handler_cookie.c&gt;
SE_IntCookie_PersistentCookies SLSLanguage
&lt;/IfModule&gt;
&lt;/IfModule&gt;</pre><p>After the instruction <code class="literal">SL_IntCookie_PersistentCookies</code> there can be any number from 1 - n cookies that will then be made transparent. In the example above, <code class="literal">SLSLanguage</code> is the actual language cookie of the SLS.</p></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_locations"></a>2.4.2. Locations</h3></div></div></div><p>In the configuration of the SRManager, appropriate locations must be specified for the protected application as well as for the SLS instance used to authenticate the users of that application.</p><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="_sls_location"></a>SLS Location</h4></div></div></div><p>A location similar to the one shown below must be configured in the SRManager. The URI may differ but should follow the same pattern:</p><pre class="screen">&lt;Location /sls/auth&gt;
AC_StartPage                /sls/auth
AC_LoginPage                /sls/auth
AC_StartQueryString         ^.\*$
&lt;/Location&gt;</pre><p>(Optional) The second location is used for the static content used within       the SLS (custom pictures, scripts, etc…).</p><pre class="screen">&lt;Location /staticfiles&gt;
AC_AccessArea                                                           Public
&lt;/Location&gt;</pre></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="_application_location"></a>Application Location</h4></div></div></div><p>The location for an application secured by the  could then look like this example:</p><pre class="screen">&lt;Location /demo/app&gt;
SetHandler                  http_1_1_gw_handler
# The following setting points to the SLS Tomcat
HGW_Host                    slshost.acme.com:8080
HGW_RequestHeaders          %HTTP11_std %HSP_std %HSP_ssl %HLS_std
AC_AccessArea               Customer
AC_AuthorizedPath           /demo
AC_LoginPage                /demo/sls/auth
&lt;/Location&gt;</pre></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_apache_tomcat_installation"></a>2.5. Apache Tomcat installation</h2></div></div></div><p>The SLS is a standard J2EE Servlet / JSP web application (however, it is <span class="emphasis"><em>not</em></span> an EJB application). Therefore, it can be deployed in a Tomcat instance just as any other web application.</p><p>See the Tomcat documentation for more detailed information about the installation and configuration at <a class="ulink" href="http://tomcat.apache.org" target="_top">http://tomcat.apache.org</a>. A sample server.xml is included on the SLS CD.</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_pre_configured_sls_base"></a>2.5.1. Pre-configured SLS base</h3></div></div></div><p>USP supplies a pre-configured Apache Tomcat installation with the according JDK to simplify your installation process. Currently there is a Solaris package available.</p><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="_solaris_sls_base_installation"></a>Solaris SLS base installation</h4></div></div></div><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">
First you have to manually create the required user and group. The username is
<span class="strong"><strong>sls</strong></span> and the group that should contain the user is <span class="strong"><strong>webadm</strong></span>.
</li></ol></div><p>To create the required accounts log in as root on your desired system and execute the following commands:</p><pre class="screen"># groupdadd webadm
# useradd -G webadm sls</pre><div class="orderedlist"><ol class="orderedlist" start="2" type="1"><li class="listitem">
Change to the directory where the Solaris package
usp-sls-base-solaris-x-x-x.pkg is located and execute the following command:
</li></ol></div><pre class="screen"># pkgadd -d usp-sls-base-solaris-x-x-x.pkg</pre><div class="orderedlist"><ol class="orderedlist" start="3" type="1"><li class="listitem">
Thereafter, the actual package should be listed on the command prompt. Type
  <code class="literal">all</code> to continue.
</li><li class="listitem">
Afterwards you might be asked to create a directory where the SLS will be
  installed to. Confirm it with typing <code class="literal">y</code>.
</li><li class="listitem">
Finally, the SLS base is installed to the directory /opt/usp/sls. Make sure
  that the following message appears:
</li></ol></div><p><code class="literal">Installation of &lt;usp-sls-base-solaris&gt; was successful.</code></p></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="x22317_Heading2Tarsec_SLS"></a>2.6. deployment</h2></div></div></div><p>On the SLS CD in the <code class="literal">/sls/</code> directory you're able to find the exploded web application. Just copy this directory into the 
<code class="literal">&lt;tomcat_base&gt;/webapps</code> directory. See the configuration chapter for further information about the properties files and be aware that you have the ability to highly customize your SLS deployment. You may want to customize the JSP's to your CD (Corporate Design).</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_adapter_installation"></a>2.7. Adapter installation</h2></div></div></div><p>There are multiple backend authentication adapters available to use with the Secure Login Service. Usually, adapters are shiped seperately on different CD's. Basically, they consist of one JAR library and one example property file and the adapters manual for detailed informations about the configuration.</p><p>There are 3 easy steps to complete when installing an adapter into your SLS installation:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">
Open the SLS home folder. (this folder is mostly installed at <code class="literal">&lt;tomcat_base&gt;/webapps/sls</code>)
</li><li class="listitem">
Copy the adapters JAR file into the <code class="literal">&lt;sls_home&gt;/WEB-INF/lib</code> folder. (This JAR file is located on the CD in the /lib folder)
</li><li class="listitem">
Copy the example configuration File of the adapter to the <code class="literal">&lt;sls_home&gt;/WEB-INF/</code> folder. In most cases you must adapt some configuration properties like IP addresses.  (This property file is located most likely on the CD in the /conf folder)
</li></ol></div></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="x98288_Heading2Tarsec_SLS_Configuration"></a>Chapter 3. Configuration</h2></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_overview_3"></a>3.1. Overview</h2></div></div></div><p>This chapter contains basic instructions about how to configure an  instance.
All configuration files that are subject to manual change are mentioned and
described. Files that have been left out by the descriptions do not need to be
changed. This chapter serves as an index of all configuration properties which
are explained more detailed in separate chapters.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_configuration_directory_and_files"></a>3.2. Configuration Directory And Files</h2></div></div></div><p>The base configuration directory is the subdirectory "<code class="literal">WEB-INF</code>" of the  web
application. All the property files mentioned further below are usually in that
directory and, optionally, in custom subdirectories.</p><p>At startup time, the SLS processes ALL files with the suffixes</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
"<code class="literal">.properties</code>"
</li><li class="listitem">
"<code class="literal">.overrides</code>"
</li></ul></div><p>Except for two special cases, the properties can really be stored in separate
properties files as desired. The SLS will just read all these files and merge
them into one configuration internally</p><p>The two exceptions are:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
the contents of the file "<code class="literal">sls-errormap.properties</code>" have to be in that file
</li><li class="listitem">
the property (or properties) for defining additional custom configuration
  directories (<code class="literal">"custom.properties.path"</code>) MUST be in a <code class="literal">".properties"</code> file
  inside the SLS <code class="literal">"WEB-INF"</code> directory, due to the configuration bootstrap
  process. They CAN NOT be in an <code class="literal">".overrides"</code> file (see <a class="xref" href="#overriding-properties" title="3.2.2. Overriding Properties">Section 3.2.2, “Overriding Properties”</a>.
</li></ul></div><p>The files with the suffix ".overrides" can be used (as the suffix suggests) to
override properties in the ".properties" files (see further below).</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_conflicting_settings"></a>3.2.1. Conflicting Settings</h3></div></div></div><p><span class="emphasis"><em>NOTE: In case of conflicting properties (a certain property appears multiple
times in the configuration), the SLS will either log a WARN message about it,
if the properties all have the same values, or fail startup with an ERROR log
message, if the properties have conflicting values (since it cannot know which
value would be the "correct" one).</em></span></p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="overriding-properties"></a>3.2.2. Overriding Properties</h3></div></div></div><p>It is possible to override properties defined in "<code class="literal">.properties</code>" files by setting
them with a different value in a file with the suffix "<code class="literal">.overrides</code>". This could
be used, for example, to have default values in the file "<code class="literal">sls.properties</code>",
but override some of them in test environments etc., just by adding a file
"<code class="literal">test-environment-xy.overrides</code>".</p><p><span class="emphasis"><em>NOTE: The only property that MUST NOT be in an "<code class="literal">.overrides"</code> file is the property
that allows to define custom configuration directories, <code class="literal">"custom.config.path"</code>.
This property MUST be in a file with the suffix <code class="literal">".properties"</code>.</em></span></p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_conflicting_overrides"></a>3.2.3. Conflicting Overrides</h3></div></div></div><p><span class="emphasis"><em>NOTE: In case of conflicting overrides (a certain property appears multiple
times in the override file(s)), the SLS will either log a WARN message about it,
if the properties all have the same values, or fail startup with an ERROR log
message, if the override properties have conflicting values (since it cannot
know which value would be the "correct" one).</em></span></p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_custom_configuration_subdirectories"></a>3.2.4. Custom configuration subdirectories</h3></div></div></div><p>It is possible to define custom subdirectories within the SLS' "<code class="literal">WEB-INF</code>"
directory to contain configuration property and overrides files as well. This
allows, for example, to use such sub-directories for grouping certain property files
together, e.g. model configurations where each model is in a separate property file.</p><p><span class="strong"><strong><code class="literal">custom.properties.path[suffix]</code></strong></span></p><p>This optional property can be stored just once without any "suffix" part, if
only one custom subdirectory shall be defined. It has to be in a properties file
in the <code class="literal">"WEB-INF"</code> directory, e.g. the default <code class="literal">"sls.properties"</code> file. Example:</p><pre class="screen">custom.properties.path=customconfigs</pre><p>In which case the SLS would look for a subdirectory "<code class="literal">WEB-INF/customconfigs</code>"
and scan it for property files as well. If multiple custom config directories
should be added, a suffix can be added to the property, e.g.</p><pre class="screen">custom.properties.path.1=customconfigs
custom.properties.path.2=models</pre></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_configuration_files"></a>3.3. Configuration Files</h2></div></div></div><p>The configuration files explained in the following paragraphs are all located in
the subdirectory "<code class="literal">WEB-INF</code>" of the  web application:</p><p><span class="strong"><strong>sls.properties</strong></span></p><p>Core SLS configuration (static properties).</p><p><span class="strong"><strong>sls-dynamic.properties</strong></span></p><p>Core SLS configuration (see chapter <a class="link" href="#x93365_Heading2Tarsec_Dynamic_Properties" title="3.6. Dynamic Properties">"Dynamic Properties"</a>).</p><p><span class="strong"><strong>log4j.xml</strong></span></p><p>Logging configuration, see chapter <a class="link" href="#x81732_Heading2Tarsec_Log4J_configuration" title="25.5. Log4J Configuration">"Log4J Configuration"</a>.</p><p><span class="strong"><strong>browser-blacklist.properties</strong></span></p><p>Browser Blacklist properties, see chapter <a class="link" href="#x76105_Heading1Tarsec_Blacklist" title="Chapter 19. Browser Blacklist">"Browser Blacklist"</a>.</p><p><span class="strong"><strong>…-adapter.properties</strong></span></p><p>Adapter properties</p><p><span class="strong"><strong>sls-resources</strong></span>.properties*</p><p>Language resources, in the subdirectory "<code class="literal">WEB-INF/classes</code>". See chapter <a class="link" href="#x17268_Heading3Tarsec_Message_Resource_Files" title="14.4. Message Resource Files">"Message Resource Files"</a> for detailled explanations.</p><p>These are the files that may potentially be adapted to the current needs and environment. All other files such as "<code class="literal">web.xml</code>" are usually better left unchanged.</p><p><span class="emphasis"><em>Note that changing the dispatching configuration file  "<code class="literal">struts-config.xml</code>" may easily break the SLS functionality if not done correctly. As changes in that file require - to a certain degree - knowledge of the SLS's inner workings, it is strongly advised to leave that file unchanged or consult customer support before changing it.</em></span></p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="x37297_Heading3Tarsec_Configuration_File_Loading"></a>3.3.1. Configuration File Loading</h3></div></div></div><p>Usually the SLS loads all property files found in the "<code class="literal">WEB-INF</code>"-directory and merges them internally to one configuration. It is also possible to define a finite list of files to be processed:</p><p><span class="strong"><strong><code class="literal">config.files</code></strong></span></p><p>Defines a comma-separated list of file names. Each name must be defined relative to the "<code class="literal">WEB-INF</code>"-directory of the SLS.</p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_variables_in_property_values"></a>3.4. Variables In Property Values</h2></div></div></div><p>Note that in many configuration properties variables can be used within the property value, as explained in chapter <a class="link" href="#x49003_Heading1Tarsec_Expressions" title="Chapter 32. JEXL Expressions">"JEXL Expressions"</a>.</p><p>Please read the variable documentation carefully in order to be sure that the variable used really is available at that time (as some variables are created only in the final steps of the login process).</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_sls_seal_dataprotector_replacement"></a>3.5. SLS Seal (DataProtector replacement)</h2></div></div></div><p>The SLS includes SLS Seal which allows to encrypt and decrypt values using a symmetric key stored in a keystore file. The chapter <a class="link" href="#x33956_Heading2Tarsec_DataProtector" title="39.3. SLS Seal (DataProtector replacement)">"SLS Seal (DataProtector replacement)"</a> describes how to create a keystore and encrypt or decrypt values using the commandline tool.</p><p>If a DataProtector/Seal keystore is enabled in the configuration, the SLS checks for each configuration value in the "sls.properties" or the "*-adapter.properties" files if it is encrypted. A typical use case is a technical password in the authentication adapter configuration.</p><p>If a property is encrypted, it is automatically being decrypted before it is processed. This way it is easy to have a critical value be plain text in an integration test environment and then use an encrypted value for that property in the production environment.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="x93365_Heading2Tarsec_Dynamic_Properties"></a>3.6. Dynamic Properties</h2></div></div></div><p>The properties in the file "<code class="literal">sls-dynamic.properties</code>" are dynamic in the sense that the file itself is checked for changes (based on the file's last change timestamp) at each request. If it has changed, all properties in it are refreshed. So, this allows to implement certain configuration changes "dynamically" at runtime, without having to restart the SLS. However, the login service defines exactly which properties can or must be in this file.</p><p><span class="emphasis"><em>It is not possible to move just any property from the static "<code class="literal">sls.properties</code>" file into the "<code class="literal">sls-dynamic.properties</code>" file. If the moved property is not designated to be a "dynamic" property, the SLS will ignore it completely if it's in the wrong file!</em></span></p><p>The sample configuration file provided in the SLS web application contains all properties that can be used in this file. In this guide, each property that can or must be put in the dynamic properties file is documented accordingly.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_deprecated_properties"></a>3.7. Deprecated Properties</h2></div></div></div><p>If the name of a configuration property is defined as "deprecated", it means that the property has been renamed once, usually for reasons of better consistency with other, newly introduced configuration settings. In such cases, the old names are always still supported as there may be many productive, customized installations around which cannot be changed easily without a considerable effort.</p><p>If a configuration property has become obsolete completely, it will no longer be listed in the table below. Instead, there will be remarks in the provided release notes text file about which properties are to be removed from the configuration.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_system_properties"></a>3.8. System Properties</h2></div></div></div><p>It is possible to set system properties by setting a property with the name prefix "<code class="literal">system.property.</code>" in the file "<code class="literal">sls.properties</code>", followed by the name of the actual system property. Example:</p><pre class="programlisting">system.property.logdir=/var/log</pre><p>will set the system property "<code class="literal">logdir</code>" to the value "<code class="literal">/var/log</code>" at SLS startup time.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="x22044_Heading3Tarsec_SLS_properties"></a>3.9. SLS Properties</h2></div></div></div><p>The file "<code class="literal">sls.properties</code>" is the main configuration file. This file is processed when the  is starting up. Other, additional configuration files may be loaded as well, sometimes depending on the configuration values in this file.</p><p>The configuration properties are (in alphabetical order):</p><p><span class="strong"><strong><code class="literal">adapter.authentication</code></strong></span></p><p>See <a class="link" href="#x17734_Heading1Tarsec_Usage_scenarios" title="Part VI. Usage Scenarios">"Usage Scenarios"</a> for details.</p><p><span class="strong"><strong><code class="literal">adapter.authorization</code></strong></span></p><p><span class="strong"><strong><code class="literal">adapter.challenge</code></strong></span></p><p><span class="strong"><strong><code class="literal">adapter.changepassword</code></strong></span></p><p><span class="strong"><strong><code class="literal">adapter.mapping</code></strong></span></p><p><span class="strong"><strong><code class="literal">adapter.reauthentication</code></strong></span></p><p><span class="strong"><strong><code class="literal">adapter.token</code></strong></span></p><p><span class="strong"><strong><code class="literal">already.loggedin.page</code></strong></span></p><p>Defaults to "<code class="literal">false</code>". If set to "<code class="literal">true</code>", a page which shows a message like
"you are already logged in" is displayed to the user, if she accesses the login
service and already has a valid HSP session.</p><p><span class="strong"><strong>NOTE</strong></span>: This page (the "Loggedin.jsp") is only displayed in the login model, NOT
any other models. Obviously, an authenticated user still needs to be able to
access password-change models etc. The SLS sees a model as a login model based
on the fact that it contains one of the following states:</p><pre class="screen">do.auth
do.auth2
...
do.auth6

do.cert.auth
do.cert.auth2
...
do.cert.auth6

do.auth.novalidate
do.auth.novalidate2
...
do.auth.novalidate6

do.ntlmauth
do.ntlmauth2
...
do.ntlmauth6</pre><p><span class="strong"><strong><code class="literal">already.loggedin.redirect</code></strong></span></p><p>Defaults to "<code class="literal">false</code>". If set to "<code class="literal">true</code>", a client which accesses the HSP and already has a valid session will just be redirected to the requested page (if available) or default redirect page. NOTE: This property will be ignored if "<code class="literal">already.loggedin.page</code>" is set.</p><p><span class="strong"><strong><code class="literal"><code class="literal">app.header.*</code></code></strong></span></p><p>See <a class="link" href="#x59485_Heading3Tarsec_LoginData_Header" title="23.2.1. &quot;LoginUserData&quot; Header">""LoginUserData" Header"</a> for details.</p><p><span class="strong"><strong><code class="literal">auth.type</code></strong></span></p><p>See <a class="link" href="#x72488_Heading2Tarsec_Authentication_Schemes" title="23.5.1. Authentication Schemes">"Authentication Schemes"</a> for details.</p><p><span class="strong"><strong><code class="literal">blacklist</code></strong></span></p><p>See <a class="link" href="#x76105_Heading1Tarsec_Blacklist" title="Chapter 19. Browser Blacklist">"Browser Blacklist"</a> for details.</p><p><span class="strong"><strong><code class="literal">bid.check.enable</code></strong></span></p><p>See <a class="link" href="#x60248_Heading1Tarsec_Browser_ID_Check_BID" title="Chapter 22. Browser ID Check (&quot;BID&quot;)">"Browser ID Check ("BID")"</a> for details.</p><p><span class="strong"><strong><code class="literal">basic.auth.enable</code></strong></span>
<span class="strong"><strong><code class="literal">basic.auth.realm</code></strong></span>
<span class="strong"><strong><code class="literal"><code class="literal">basic.auth.match.*</code></code></strong></span>
<span class="strong"><strong><code class="literal">basic.auth.https.only</code></strong></span></p><p>See <a class="link" href="#x38834_Heading1Tarsec_Basic_Authentication" title="Chapter 21. HTTP Basic Authentication">"HTTP Basic Authentication"</a> for details.</p><p><span class="strong"><strong><code class="literal"><code class="literal">challenge.*</code></code></strong></span></p><p>See <a class="link" href="#title2_Challenge_Response" title="Chapter 9. Challenge / Response">"Challenge / Response"</a> for details.</p><p><span class="strong"><strong><code class="literal"><code class="literal">certificate.*</code></code></strong></span></p><p>See <a class="link" href="#x77503_Heading3Tarsec_Certificate_Handling" title="32.8.7. Certificate Handling">"Certificate Handling"</a> for details.</p><p><span class="strong"><strong><code class="literal">cookie.set.successful.name</code></strong></span></p><p>See <a class="link" href="#x75173_Heading1Tarsec_Cookies" title="Chapter 24. Cookies">"Cookies"</a> for details.</p><p><span class="strong"><strong><code class="literal">cookie.&lt;name&gt;.comment</code></strong></span></p><p><span class="strong"><strong><code class="literal">cookie.&lt;name&gt;.domain</code></strong></span></p><p><span class="strong"><strong><code class="literal">cookie.&lt;name&gt;.maxage</code></strong></span></p><p><span class="strong"><strong><code class="literal">cookie.&lt;name&gt;.path</code></strong></span></p><p><span class="strong"><strong><code class="literal">cookie.&lt;name&gt;.value</code></strong></span></p><p><span class="strong"><strong><code class="literal"><code class="literal">concurrent.*</code></code></strong></span></p><p>See <a class="link" href="#x67409_Heading1Tarsec_Concurrency_Issues_with_Browser_Tabs" title="Chapter 13. Concurrency Issues with Browser Tabs">"Concurrency Issues with Browser Tabs"</a> for details.</p><p><span class="strong"><strong><code class="literal"><code class="literal">cred.*</code></code></strong></span></p><p>See <a class="link" href="#x38692_Heading1Tarsec_Credential_Providers" title="Chapter 8. Credential Providers">"Credential Providers"</a> for details.</p><p><span class="strong"><strong><code class="literal">config.files</code></strong></span></p><p>See <a class="link" href="#x37297_Heading3Tarsec_Configuration_File_Loading" title="3.3.1. Configuration File Loading">"Configuration File Loading"</a> for details.</p><p><span class="strong"><strong><code class="literal">custom.resources.path</code></strong></span></p><p>See <a class="link" href="#x112233_Message_Resource_Files" title="14.4.1. Custom Message Resource Files">"Custom Message Resource Files"</a> for details.</p><p><span class="strong"><strong><code class="literal">disable.requested. page.check</code></strong></span></p><p><span class="emphasis"><em>Optional:</em></span> Allows to disable the check used to detect a change of the 'requested page\' during one login session. This should be disabled only if an existing installation / login model has a problem with it, and any potential security problems are properly addressed by the login model itself.</p><p><span class="strong"><strong><code class="literal">dataprotector.keystore</code></strong></span></p><p>See <a class="link" href="#x85318_Heading3Tarsec_SLS_Keystore_Configuration" title="39.3.6. SLS Keystore Configuration">"SLS Keystore Configuration"</a> for details.</p><p><span class="strong"><strong><code class="literal">default.cookie.domain</code></strong></span></p><p>See <a class="link" href="#x75173_Heading1Tarsec_Cookies" title="Chapter 24. Cookies">"Cookies"</a> for details.</p><p><span class="strong"><strong><code class="literal">debug.info</code></strong></span></p><p>See<a class="link" href="#x82593_Heading2Tarsec_Displaying_Debug_Information" title="35.8. Displaying Debug Information">"Displaying Debug Information"</a> for details.</p><p><span class="strong"><strong><code class="literal"><code class="literal">email.*</code></code></strong></span></p><p>See <a class="link" href="#x33260_Heading1Tarsec_Sending_eMail" title="Chapter 17. Sending E-Mail">"Sending E-Mail"</a> for details.</p><p><span class="strong"><strong><code class="literal">error.details</code></strong></span></p><p>See <a class="link" href="#x74841_Heading2Tarsec_Displaying_Internal_Error_Code" title="35.2. Displaying Internal Error Code">"Displaying Internal Error Code"</a> for details.</p><p><span class="strong"><strong><code class="literal">error.header</code></strong></span></p><p>See <a class="link" href="#x19350_Heading2Tarsec_Internal_Error_Code_HTTP_Response_Header" title="35.3. Internal Error Code HTTP Response Header">"Internal Error Code HTTP Response Header"</a> for details.</p><p><span class="strong"><strong><code class="literal">form.use.dynamic.actions</code></strong></span></p><p><code class="literal">true</code> or <code class="literal">false</code> (defaults to <code class="literal">false</code>). Enables dynamic correction of the
"action" URI generated by the "sls:form" JSP tag. In a case where the current
model was triggered by a different URI than the one configured in the tag's "action" attribute, the resulting "action" will
have the same URI as the original request. This kind of situation can occur in
cases where the same JSP is used in different models that are configured for
different request URIs.</p><p><span class="strong"><strong><code class="literal">fix.ssl.sid</code></strong></span></p><p>See <a class="link" href="#x29935_Heading4Tarsec_SSL_Session_ID_Fixation" title="19.4.4. SSL Session ID Fixation">"SSL Session ID Fixation"</a> for details.</p><p><span class="strong"><strong><code class="literal"><code class="literal">frontend.soap.*</code></code></strong></span></p><p>See <a class="link" href="#x51351_Heading1Tarsec_SOAP_Frontend" title="Chapter 64. SOAP Frontend">"SOAP Frontend"</a> for details.</p><p><span class="strong"><strong><code class="literal"><code class="literal">gw-param.*</code></code></strong></span></p><p>See <a class="link" href="#x99995_Heading3Tarsec_Modifying_Gateway_Parameters" title="29.7. Modifying Parameters with &quot;gw-param.&quot;">"Modifying Parameters with "gw-param.""</a> for details.</p><p><span class="strong"><strong><code class="literal">hsp.access.area</code></strong></span></p><p>The SLS has to define an access area after each successful authentication. The possible values are either "<code class="literal">Member</code>" or "<code class="literal">Customer</code>". Please verify, that this property correlates to the SRM configuration.</p><p><span class="strong"><strong><code class="literal"><code class="literal">hsp.header.*</code></code></strong></span></p><p>See <a class="link" href="#x11777_Heading3Tarsec_Propagating_HTTP_Headers" title="23.2.2. Propagating Custom HTTP Headers">"Propagating Custom HTTP Headers"</a> for details.</p><p><span class="strong"><strong><code class="literal">hsp.header.LoginData</code></strong></span></p><p>See <a class="link" href="#x59485_Heading3Tarsec_LoginData_Header" title="23.2.1. &quot;LoginUserData&quot; Header">""LoginUserData" Header"</a> for details.</p><p><span class="strong"><strong><code class="literal"><code class="literal">hsp.param.*</code></code></strong></span></p><p>See <a class="link" href="#x10003_Heading1Tarsec_Parameter_Passing" title="Chapter 29. HSP Parameter Passing / Gateway">"HSP Parameter Passing"</a> for details.</p><p><span class="strong"><strong><code class="literal">http.parameter.check.enforce</code></strong></span></p><p>See <a class="link" href="#x10004_Heading1Tarsec_Parameter_Checker" title="Chapter 12. Parameter Checker / Aliases">"Parameter Checker / Aliases"</a> for details.</p><p><span class="strong"><strong><code class="literal">ignore.requested.page</code></strong></span></p><p>See <a class="link" href="#x10002_Heading1Tarsec_Redirecting" title="Chapter 11. Redirecting">"Redirecting"</a> for details.</p><p><span class="strong"><strong><code class="literal">jexl.class.<span class="emphasis"><em>&lt;alias&gt;</em></span></code></strong></span></p><p>See <a class="link" href="#x93809_Heading2Tarsec_Custom_JEXL_Expressions" title="32.11. Custom JEXL Expressions">"Custom JEXL Expressions"</a> for details.</p><p><span class="strong"><strong><code class="literal">jexl.clear.request.vars</code></strong></span></p><p>See <a class="link" href="#x13698_Heading3Tarsec_Clearing_Variables_at_request_entry" title="32.3.14. Clearing Variables at request entry">"Clearing Variables at request entry"</a> for details.</p><p><span class="strong"><strong><code class="literal">jexl.timestamp.format</code></strong></span></p><p>See <a class="link" href="#x73528_Heading3Tarsec_Timestamp_Creation" title="32.8.5. Timestamp Creation">"Timestamp Creation"</a> for details.</p><p><span class="strong"><strong><code class="literal">jexl2.lenient</code></strong></span></p><p>See <a class="link" href="#x92172_Heading2Tarsec_JEXL_Version_Issues" title="32.9. JEXL Known Issues">"JEXL Version Issues"</a> for details.</p><p><span class="strong"><strong><code class="literal"><code class="literal">jsonpath.*</code></code></strong></span></p><p>See <a class="link" href="#x1234_updating_variables_from_json" title="32.8.3. Updating variables from JSON data with templates">"Updating variables from JSON data with templates"</a> for details.</p><p><span class="strong"><strong><code class="literal">lang.default</code></strong></span></p><p>See <a class="link" href="#x10001_Heading2Tarsec_Localization" title="Chapter 14. Localization">"Localization"</a> for details.</p><p><span class="strong"><strong><code class="literal">lang.default.<span class="emphasis"><em>&lt;tenant&gt;</em></span></code></strong></span></p><p><span class="strong"><strong><code class="literal">lang.cookie.domain</code></strong></span></p><p><span class="strong"><strong><code class="literal">lang.cookie.age</code></strong></span></p><p><span class="strong"><strong><code class="literal">lang.cookie.path</code></strong></span></p><p><span class="strong"><strong><code class="literal"><code class="literal">jsp.globalerror.*</code></code></strong></span></p><p>See <a class="link" href="#x43339_Heading2Tarsec_Multiple_Errors_Showing_First_Or_Last" title="35.5. Multiple Errors / Showing First Or Last">"Multiple Errors / Showing First Or Last"</a> for details.</p><p><span class="strong"><strong><code class="literal"><code class="literal">log.filter.creds.secrets</code></code></strong></span></p><p>See <a class="link" href="#Filtering_Passwords" title="25.10. Filtering Passwords">"Filtering Passwords"</a> for details.</p><p><span class="strong"><strong><code class="literal"><code class="literal">mail.*</code></code></strong></span></p><p>See <a class="link" href="#x33260_Heading1Tarsec_Sending_eMail" title="Chapter 17. Sending E-Mail">"Sending E-Mail"</a> for details.</p><p><span class="strong"><strong><code class="literal"><code class="literal">model.*</code></code></strong></span></p><p>See <a class="link" href="#x29792_Heading1Tarsec_Model" title="Chapter 7. Model">"Model"</a> for details.</p><p><span class="strong"><strong><code class="literal">modules.usage.file</code></strong></span></p><p>See <a class="link" href="#x34533_Heading1Tarsec_SLS_Modules" title="Chapter 40. SLS Modules">"SLS Modules"</a> for details.</p><p><span class="strong"><strong><code class="literal">monitor.check.interval</code></strong></span></p><p>See <a class="link" href="#x12345_Heading1Tarsec_Connection_monitoring" title="Chapter 28. Backend Monitoring">"Connection monitoring"</a> for details.</p><p><span class="strong"><strong><code class="literal"><code class="literal">multitenancy.*</code></code></strong></span></p><p>See <a class="link" href="#x18987_Heading1Tarsec_Multitenancy_Support" title="Chapter 18. Multitenancy Support">"Multitenancy Support"</a> for details.</p><p><span class="strong"><strong><code class="literal"><code class="literal">persist.*</code></code></strong></span></p><p>See <a class="link" href="#Expressions_Persistent_variables" title="32.3.2. Persistent Variables">"Expressions / Persistent Variables"</a> for details.</p><p><span class="strong"><strong><code class="literal"><code class="literal">parameter.*</code></code></strong></span></p><p>See <a class="link" href="#x10004_Heading1Tarsec_Parameter_Checker" title="Chapter 12. Parameter Checker / Aliases">"Parameter Checker / Aliases"</a> for details.</p><p><span class="strong"><strong><code class="literal"><code class="literal">prefs.*</code></code></strong></span></p><p>See <a class="link" href="#x18895_Heading3Tarsec_Preferences_Cookie" title="24.3.4. Preferences Cookie">"Preferences Cookie"</a> for details.</p><p><span class="strong"><strong><code class="literal"><code class="literal">redirect.*</code></code></strong></span></p><p>See <a class="link" href="#x10002_Heading1Tarsec_Redirecting" title="Chapter 11. Redirecting">"Redirecting"</a> for details.</p><p><span class="strong"><strong><code class="literal"><code class="literal">resources.encoding.legacy</code></code></strong></span></p><p><span class="emphasis"><em>Optional:</em></span> Allows to disable UTF-8 handling when reading message resource
bundles. If this property is set to "true" (default is "false"), the bundles
will be read with the legacy default encoding ISO-8859-1.</p><p><span class="strong"><strong><code class="literal"><code class="literal">session.*</code></code></strong></span></p><p>See <a class="link" href="#x84028_Heading1Tarsec_Session_Handling" title="Chapter 10. Session Handling">"Session Handling"</a> for details.</p><p><span class="strong"><strong><code class="literal"><code class="literal">slowdown.*</code></code></strong></span></p><p>See <a class="link" href="#x27589_Heading1Tarsec_Login_Slowdown" title="Chapter 20. Login Slowdown">"Login Slowdown"</a> for details.</p><p><span class="strong"><strong><code class="literal">sls.response.buffer.size</code></strong></span></p><p>Allows to override the size of the response buffer of the HTTP response.
Increasing the buffer size from the container default can help in cases where
a response from the SLS is incomplete
(i.e. some response headers are missing) because the buffer is too small. This
can be an issue with certain Tomcat 8 versions where the size of this buffer
is not configurable. Also, adjusting the buffer size allows to adjust memory
usage in such situation.</p><p><span class="strong"><strong><code class="literal">sls.title</code></strong></span></p><p>Defines a title written to log files at startup. Can be left unchanged or, for example, changed to an instance-specific name.</p><p><span class="strong"><strong><code class="literal">static.files.path</code></strong></span></p><p>Defines the URI path for static files. This serves as the base URI for all relative file references used with the "<code class="literal">staticResource</code>" JSP tag. Defaults to "<code class="literal">/staticfiles</code>" if not specified.</p><p><span class="strong"><strong><code class="literal"><code class="literal">tenant.*</code></code></strong></span></p><p>See <a class="link" href="#x18987_Heading1Tarsec_Multitenancy_Support" title="Chapter 18. Multitenancy Support">"Multitenancy Support"</a> for details.</p><p><span class="strong"><strong><code class="literal"><code class="literal">tenant.*.regex</code></code></strong></span></p><p><span class="strong"><strong><code class="literal">url.encoder.legacy</code></strong></span></p><p>Allows to enable the legacy behaviour of the SLS URL encoder, where all URL-encoded contents will substitute a blank with a "+" character, instead of "%20" (the latter being the correct, standard-conform string). Defaults to "false".</p><p><span class="strong"><strong><code class="literal">wait.on.locking</code></strong></span></p><p>See <a class="link" href="#x67409_Heading1Tarsec_Concurrency_Issues_with_Browser_Tabs" title="Chapter 13. Concurrency Issues with Browser Tabs">"Concurrency Issues with Browser Tabs"</a> for details.</p><p><span class="strong"><strong><code class="literal">xpath.ignore.empty.nodes</code></strong></span></p><p>See <a class="link" href="#x10009_Heading1Tarsec_Web_Service_Adapter" title="Chapter 49. Web Service Adapter">"Web Service Adapter"</a> for details.</p></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="x91247_Heading1Tarsec_Recommended_Settings"></a>Chapter 4. Recommended Settings</h2></div></div></div><p>This chapter lists recommended configuration settings for various software components.</p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_jvm_startup_parameters"></a>4.1. JVM startup parameters</h2></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_java_memory_settings"></a>4.1.1. Java Memory Settings</h3></div></div></div><p><span class="emphasis"><em>Note: It is very difficult to define reasonable default values for JVM memory settings,
since the memory consumption of any given SLS instance depends heavily on how it is used,
what features are enabled, the number of logins per minute etc.</em></span></p><p>A very bare-bone, minimal SLS setup can already run with less than 100MB ram. However,
as soon as more sophisticated functionality (especially Groovy/JEXL scripting) is used,
and the number of concurrent users rises, the required value can be much higher. The following
settings seem reasonable for a standard setup which may have to serve up to a few
thousand users within minutes in peak times:</p><pre class="screen">-Xms128m -Xmx2048m -XX:MaxMetaspaceSize=512m</pre><p>This configures the JVM to reserve 128MB RAM from the start, and use up to 2GB if
necessary. Also, the "Metadata" space of the Java 8 VM can use up to 512MB, which
should be enough even for high traffic environments.</p><p><span class="strong"><strong>Note:</strong></span></p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
MaxMetaspaceSize is a Java 8 setting; it cannot be used with older JVMs!
</li><li class="listitem">
The example above is for running one single SLS webapp in one Tomcat instance.
  If multiple SLS webapps are used, it may be necessary to increase those
  settings, especially the Java 8 parameter "MaxMetaspaceSize".
</li></ul></div><p>For more information on this complex topic, please consult the JVM documentation of Oracle.</p><p>Other useful settings for dealing with situations where the SLS does run out
of memory would be:</p><pre class="screen">-XX:+HeapDumpOnOutOfMemoryError</pre><p>This settings will trigger a complete dump of the memory (RAM) into a file at
the moment of an OutOfMemoryError. This file can be useful for the USP 3rd level
support to analyze the problem and find the cause, especially in a situation
where there is reason to assume there might be some kind of memory leak.</p><p><span class="emphasis"><em>Note: The following parameter should be used together with this one, otherwise
the JVM will save the memory dump file in an undefined location in the filesystem.</em></span></p><pre class="screen">-XX:HeapDumpPath=/.../logs/sls-dump.hprof</pre><p>This defines the path where the JVM should write the memory dump file. It is
important to make sure that the SLS process has the correct, required permissions
to do so.</p><p>Also, the following parameter can be very helpful:</p><pre class="screen">-XX:OnOutOfMemoryError=...restart-trigger-script...</pre><p>This one allows to define a custom shell script which is executed the moment the
OutOfMemoryError occurs. That script can then do anything - including restarting
the SLS instance. Since an OutOfMemoryError usually means a complete breakdown of
the SLS functionality, requiring a restart anyway, this feature can help to
reduce downtime of the service.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_default_character_encoding_utf_8"></a>4.1.2. Default Character Encoding UTF-8</h3></div></div></div><p>Nowadays, it is almost always a good idea to use UTF-8 as the default encoding
in the SLS and the application servers, so that in cases where headers with
special non-ASCII characters should be propagated to the application, the values
can be properly processed on the receiving end.</p><p>Since the Java VM usually relies on the default encoding of the underlying
operating system as its own default encoding, it’s a good practice to enforce
the use of a certain encoding with this JVM system property in the startup script:</p><pre class="screen">-Dfile.encoding=UTF-8</pre><p>Despite the confusing name, this property does not only affect file-related
operations, but has a general impact on situations where strings are to be
created from an array of raw byte data.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_cryptography_entropy_generator"></a>4.1.3. Cryptography Entropy Generator</h3></div></div></div><pre class="screen">-Djava.security.egd=file:/dev/./urandom</pre><p><span class="strong"><strong>NOTE:</strong></span> This settings is really <span class="strong"><strong>mandatory</strong></span> on Linux platforms. It configures
the JVM to use a technically (cryptographically) less secure random number
generator, but one that will ALWAYS be able to provide entropy. Without this
setting, the default random number generator can occasionally run out of entropy
data (which is generated from things like I/O traffic, mouse movements etc.).
When that happens, any crypto operation within the SLS can get stuck in a reading
operation, waiting until new entropy data becomes available. This is usually far
less acceptable than the slightly reduced level of security caused by the
software-only random value generator.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_tomcat_jar_scanning"></a>4.1.4. Tomcat Jar Scanning</h3></div></div></div><p>Tomcat 7 introduced scanning of an application’s JAR files at startup time, in order to support certain types of dynamic feature registration. However, this
feature is not used by the SLS webapp, and can slow down startup considerably. Therefore, it’s recommended to disable it completely by setting the following
Java System property in the startup script:</p><pre class="screen">-Dtomcat.util.scan.StandardJarScanFilter.jarsToSkip=*.jar</pre></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_tomcat_server_settings"></a>4.2. Tomcat server settings</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
NOTE: The SLS requires at least Tomcat 6.
</li><li class="listitem">
The "conf/server.xml" file should begin with this:
</li></ul></div><pre class="screen">&lt;?xml version="1.0" encoding="UTF-8" standalone="yes"?&gt;</pre><p>The important detail here is the "UTF-8" encoding, which should be enforced
everywhere in the SLS setup.</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
The following are all attributes of the "Connector" element in the "server.xml" file:
</li></ul></div><pre class="screen">maxHttpHeaderSize=68192</pre><p>Sets the maximum size limit for request headers to 66KB (default is only 8KB).
The default value is often a problem with PKI-related login flows, where entire
certificates (or chains) are sent back and forth between the HSP and SLS in
request headers.</p><pre class="screen">enableLookups="false"</pre><p>Disables DNS lookups for resolving the actual hostname of the remote client.
With this setting, the client IP is returned (by "request.getRemoteHost()")
instead. Since the client in this case is always an HSP / SRM, DNS resolution
makes no sense.</p><pre class="screen">minSpareThreads="25"</pre><p>The minimum number of threads always ready to process new requests.</p><pre class="screen">URIEncoding="UTF-8"</pre><p>This specifies the character encoding used to decode the URI bytes,
after decoding the URL. If not specified, ISO-8859-1 will be used.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_sls_settings"></a>4.3. SLS Settings</h2></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_sls_core_2"></a>4.3.1. SLS Core</h3></div></div></div><p>The following properties are usually set in the file "sls.properties".</p><pre class="programlisting"># Automatically adapt POST action in JSPs based
# on URI which triggered the model
form.use.dynamic.actions=true


# Avoid having the same error show up multiple times in the global error message
jsp.globalerror.last=true

# Make sure JEXL 2 is not fault-tolerant by default.
jexl2.lenient=false

# JSP bean should show internal error ID. Should
# be used for testing purposes only.
error.details=false

# Send HTTP header "SLSError" with error information
# to client (useful for automated clients, but use
# with caution)
error.header=false


# Allows to restrict basic auth to HTTPS locations
basic.auth.https.only=true


# Make sure SLS session attribute values are URL-encoded by default
session-attribute.encodings=true

# Enable BID-check functionality by default
bid.check.enable=true

# Disable creating Log4j variables for headers and parameters
log.disable.log4j.vars=true

# Respond with a self-redirect to POST requests
# (instead of a 200 with a HTML page)
selfredirect.enable=true

# Allows to enable automatic setting of the "host" request
# header through the SLS HttpRequestWrapper implementation, based on
# the always-present HSP header "hsp_https_host". This eliminates the
# need for setting the SRM directive "HGW_ForceHost" for SAML logins.
auto.host.header.enable=true

# Optional: If set to "true", the SLS will fail at startup if strong cryptography
# is not available (which is usually caused by not having installed the unlimited
# jurisdiction strength policy files in the JVM). Defaults to "false" for reasons
# of backwards compatibility. It it is false, only a warning will be logged.
fail.on.limited.crypto=true


# Login slowdown mechanism
slowdown.active=true
slowdown.usepage=false
slowdown.time=10
slowdown.type=doubling
slowdown.threshold=3</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_ldap_adapter_properties"></a>4.3.2. LDAP adapter properties</h3></div></div></div><p><span class="strong"><strong><code class="literal">ldap.enable.escaping=true</code></strong></span></p><p>Performs LDAP escaping on configuration strings for LDAP URLs and filters.</p><p><span class="strong"><strong><code class="literal">com.sun.jndi.ldap.connect.timeout=60000</code></strong></span></p><p>Timeout for opening a new LDAP connection during a bind operation.</p><p><span class="strong"><strong><code class="literal">com.sun.jndi.ldap.read.timeout=10000</code></strong></span></p><p>Timeout for read operations on an existing connection.</p><p><span class="strong"><strong><code class="literal">com.sun.jndi.ldap.connect.pool=false</code></strong></span></p><p>Enables or disables connection pooling (defaults to "true"). Although using
connection pooling generally seems to be a good idea, long-lived connections
can sometimes cause hard to track issues with firewall infrastructures that
don’t allow for long-lived connections. So, as long as there are no performance
issues that indicate that a connection pooling might be required, it is recommended
to keep it disabled.</p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_disable_debug_logging"></a>4.4. Disable debug logging</h2></div></div></div><p>To avoid performance issues and unnecessary consumption of disk space, disable
logging of debug messages. This can be done by changing the debug level in the
Log4J configuration file "<code class="literal">log4j.xml</code>". The suggested level for a productive
environment is "<code class="literal">WARN</code>":</p><pre class="screen">&lt;category name="com.usp"&gt;
  &lt;priority value="WARN" /&gt;
  &lt;appender-ref ref="SLS_LOG" /&gt;
  &lt;appender-ref ref="EXCEPTION_LOG" /&gt;
  &lt;appender-ref ref="STDOUT" /&gt;
&lt;/category&gt;</pre><p>For more information about the SLS logging functionality see chapter
<a class="link" href="#x19283_Heading1Tarsec_Logging" title="Chapter 25. Logging">"Logging"</a>.</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_disable_internal_error_codes"></a>4.4.1. Disable internal error codes</h3></div></div></div><p>If an error occurs during the login process the SLS will show a human readable
info message and the internal error code if configured. In most cases displaying
the internal error codes is not necessary in a productive environment and should
therefore be disabled:</p><pre class="screen">error.details=false</pre><p>If not needed by a non-browser client, it is also recommended to disable the
creation of an HTTP response header containing the internal error code:</p><pre class="screen">error.header=false</pre><p>Please note that both of these configuration options are disabled by default,
if the properties are not set at all.</p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_concurrent_connections_in_hsp_and_sls"></a>4.5. Concurrent connections in HSP and SLS</h2></div></div></div><p>There are certain settings in the HSP HTTP(S) listeners that define how many
requests can be processed concurrently:</p><p><span class="strong"><strong><code class="literal">MaxServer</code></strong></span>: Number of processes.</p><p><span class="strong"><strong><code class="literal">ThreadsPerChild</code></strong></span>: Number of threads per process</p><p>So in the following example, a total of 10x50 (=500) requests can be processed
at once:</p><pre class="screen">MaxServer        10
ThreadsPerChild  50</pre><p>It is reasonable to configure the SLS in about the same way. To do this, the
following Tomcat settings are relevant:</p><p><span class="strong"><strong><code class="literal">maxThreads</code></strong></span></p><p>Defines the maximum number of requests processed concurrently by Tomcat. So the
value of this setting should usually correlate with the calculated total of the
HTS settings
above:</p><p><span class="strong"><strong><code class="literal">maxThreads=500</code></strong></span></p><p>Optionally, the following setting can be used to limit the number of connections
accepted by Tomcat:</p><p><span class="strong"><strong><code class="literal">acceptCount</code></strong></span></p><p>The value of this setting, which defaults to 10’000, <span class="strong"><strong>should always be higher
than that of "<code class="literal">maxThreads</code>"</strong></span>, and at least as high as or a little higher than
the HTS connection total:</p><p><span class="strong"><strong><code class="literal">acceptCount=5000</code></strong></span></p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_sls_load_reduction"></a>4.5.1. SLS Load Reduction</h3></div></div></div><p>In a case where the SLS instance cannot handle as many requests at once as the
HSP settings would allow, it may make sense to reduce the thread pool of Tomcat
and thereby reduce the number of requests the SLS will process concurrently, e.g.</p><p><span class="strong"><strong><code class="literal">maxThreads=100</code></strong></span></p><p>As a result, as soon as all 100 threads are busy processing a request, any newly
incoming requests will still be accepted (until the value of "acceptCount" is
exceeded), but are kept waiting until one of the busy threads is freed up.</p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_encrypt_configuration_properties"></a>4.6. Encrypt configuration properties</h2></div></div></div><p>The SLS Seal tool allows to encrypt sensitive configuration values such
as technical passwords in any property file. Please see chapter
<a class="link" href="#x33956_Heading2Tarsec_DataProtector" title="39.3. SLS Seal (DataProtector replacement)">"SLS Seal (DataProtector replacement)"</a> for details on how to
create and configure a keystore, and how to encrypt values.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_avoid_mock_up_test_classes"></a>4.7. Avoid Mock-Up / Test Classes</h2></div></div></div><p>There are two Jar-files in the "WEB-INF/lib" directory of the SLS web
application which contain actual SLS functionality:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">
<code class="literal">sls-core-<code class="literal"><span class="emphasis"><em>&lt;version&gt;</em></span></code>.jar</code>
</li><li class="listitem">
<code class="literal">sls-core-<code class="literal"><span class="emphasis"><em>&lt;version&gt;</em></span></code>-tests.jar</code>
</li></ol></div><p>The first file contains the core of the login service framework. The second
library is optional and contains functionality useful in testing and development
environments, namely</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
Various mock-up-implementation of all adapter interfaces, for functions such as
authentication, authorization etc. This allows to use these classes to perform
local authentications without any actual back-end callouts.
</li><li class="listitem">
HSP parameter passing (see chapter
<a class="link" href="#x10003_Heading1Tarsec_Parameter_Passing" title="Chapter 29. HSP Parameter Passing / Gateway">"HSP Parameter Passing"</a>  for details).
</li></ul></div><p>In order to make sure that these features cannot be used in a production
environment even if someone by mistake enables them in the configuration,
remove the jar-file "<code class="literal">sls-core-<span class="emphasis"><em>&lt;version&gt;</em></span>-tests.jar</code>" from the SLS
"<code class="literal">WEB-INF/lib</code>" directory.</p></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="x60248_Heading1Tarsec_Deprecated_Features"></a>Chapter 5. Deprecated And Removed Features</h2></div></div></div><p>This chapter lists functionality and features that have either been declared
as deprecated, to be removed at an unspecified point in the future, or that
have already been removed.</p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_deprecated_features"></a>5.1. Deprecated Features</h2></div></div></div><p>"Deprecated" means that these features are still available in the SLS, but will
be subject to removal or change in a future release. So, wherever one of the
deprecated configuration settings or JEXL functions is used, it is recommended
to change it with its designated replacement to ensure a smooth update in the
future.</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_deprecated_configuration_settings"></a>5.1.1. Deprecated Configuration Settings</h3></div></div></div><div class="table"><a id="idm1017"></a><p class="title"><strong>Table 5.1. Deprecated Settings</strong></p><div class="table-contents"><table class="table" summary="Deprecated Settings" cellpadding="4px" style="border-collapse: collapse;border-top: 3px solid #527bbd; border-bottom: 3px solid #527bbd; border-left: 3px solid #527bbd; border-right: 3px solid #527bbd; "><colgroup><col class="col_1" /><col class="col_2" /><col class="col_3" /></colgroup><tbody><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>Property</p></td><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>Component</p></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>Description</p></td></tr><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p><code class="literal">authentication.signkeyfile</code> and <code class="literal">keyindex</code></p></td><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>Tomcat Authenticator</p></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>replaced with the new property <code class="literal">authentication.keyindex</code> (the
       old two were redundant and, in one case, misnamed).</p></td></tr><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p><code class="literal">already.loggedin.active</code></p></td><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>SLS</p></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>replaced with the new property <code class="literal">already.loggedin.page</code>.</p></td></tr><tr><td style="border-right: 1px solid #527bbd; " align="left" valign="top"><p><code class="literal">selfredirect.enable</code></p></td><td style="border-right: 1px solid #527bbd; " align="left" valign="top"><p>SLS</p></td><td style="" align="left" valign="top"><p>replaced with the new property <code class="literal">redirect.response.to.post</code>.</p></td></tr></tbody></table></div></div><br class="table-break" /></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_other"></a>5.1.2. Other</h3></div></div></div><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
In the Password Policy file, the XML attribute <code class="literal">nummeric</code> was renamed to <code class="literal">numeric</code>
</li></ul></div><p></p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_deprecated_jexl_functions"></a>5.1.3. Deprecated JEXL Functions</h3></div></div></div><div class="table"><a id="idm1069"></a><p class="title"><strong>Table 5.2. Deprecated Functions</strong></p><div class="table-contents"><table class="table" summary="Deprecated Functions" cellpadding="4px" style="border-collapse: collapse;border-top: 3px solid #527bbd; border-bottom: 3px solid #527bbd; border-left: 3px solid #527bbd; border-right: 3px solid #527bbd; "><colgroup><col class="col_1" /><col class="col_2" /></colgroup><tbody><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>Old Function</p></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>New Function</p></td></tr><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p><code class="literal">session.getLanguageCode()</code></p></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><p><code class="literal">session.getLanguage()</code></p></td></tr><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p><code class="literal">session.getCountryCode()</code></p></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><p><code class="literal">session.getCountry()</code></p></td></tr><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p><code class="literal">function.getAuthorizations(String)</code></p></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><p><code class="literal">session.getAuthorizations(String)</code></p></td></tr><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p><code class="literal">function.getCred(String name)</code></p></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><p><code class="literal">session.getCred(String)</code></p></td></tr><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p><code class="literal">function.getModelState()</code></p></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><p><code class="literal">session.getModelState()</code></p></td></tr><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p><code class="literal">function.getVerifiedCred(String name)</code></p></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><p><code class="literal">session.getVerifiedCred(String)</code></p></td></tr><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p><code class="literal">function.isVerifiedCred(String semanticType)</code></p></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><p><code class="literal">session.isVerifiedCred(String)</code></p></td></tr><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p><code class="literal">function.sha1(String input)</code></p></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><p><code class="literal">function.sha256(String)</code> or <code class="literal">function.sha512(String)</code></p></td></tr><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p><code class="literal">function.sha1hex(String input)</code></p></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><p><code class="literal">function.sha256(String)</code> or <code class="literal">function.sha512(String)</code></p></td></tr><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p><code class="literal">function.md5(String input)</code></p></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><p><code class="literal">function.sha256(String)</code> or <code class="literal">function.sha512(String)</code></p></td></tr><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p><code class="literal">function.md5hex(String input)</code></p></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><p><code class="literal">function.sha256(String)</code> or <code class="literal">function.sha512(String)</code></p></td></tr><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p><code class="literal">idp.getSsoAttribute(String key)</code></p></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><p><code class="literal">idp.getSsoAttributeValue(String)</code></p></td></tr><tr><td style="border-right: 1px solid #527bbd; " align="left" valign="top"><p><code class="literal">sp.getUserAssertion()</code></p></td><td style="" align="left" valign="top"><p><code class="literal">sp.getAssertion()</code></p></td></tr></tbody></table></div></div><br class="table-break" /><p></p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_removed_features"></a>5.2. Removed Features</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
Support for Java versions older than 8. Since version 5.x, the SLS requires a
  Java 8 runtime (Oracle or OpenJDK). Older Java versions are no longer supported.
</li><li class="listitem">
The obsolete configuration property prefix <code class="literal">character.illegal.</code> was removed,
     because this whole "illegal character" check mechanism has become obsolete by the
     introduction of the "parameter checker" some time ago. The hard-coded internal
     checks for <span class="emphasis"><em>evil</em></span> characters such as <code class="literal">&lt;</code> and <code class="literal">/&gt;</code> have been removed as well. In
     order to prevent the use of such characters, the parameter checker must now be
     configured accordingly, or the HSP / SRM.
</li><li class="listitem">
Challenge adapter of type <code class="literal">smschallenge</code> has been removed. Use the HTTP
     adapter to send the challenge to the SMS provider, and the <code class="literal">basechallenge</code>
     adapter to create the challenge and verify the response. See the corresponding
     chapter in the "SLS Administration Guide", "Challenge / Response" for details.
</li><li class="listitem">
The setting <code class="literal">groovy.script.timeout.secs</code> has been removed, because it fundamentally
   cannot be made to work as desired, due to the nature of the Groovy JDK and the Java VM.
</li><li class="listitem">
The "Struts" framework has been removed and replaced with a custom dispatching
  functionality that still supports the same configuration file, "struts-config.xml",
  for backwards-compatibility. NOTE: Because of this removal, the "Struts" JSP tag
  libaries are no longer included, so if you have JSPs that used them, they must
  be adapted (use SLS JSP tag library instead).
</li><li class="listitem">
The Axsionics adapter has been discontinued and removed.
</li><li class="listitem">
The SiteMinder adapter has been discontinued and removed.
</li><li class="listitem">
The obsolete and rarely used feature called "Triggers" has been entirely
   removed. NOTE: This has nothing to do with model triggers. It was an old
   mechanism that allowed to trigger certain actions during a flow based on
   the user ID, using either the model state <code class="literal">do.trigger</code> or the JEXL
   function <code class="literal">function.checkTriggers()</code>. The same kind of functionaliy can
   nowadays be implemented in many, and more flexible ways using conditional
   model actions or states, JEXL and Groovy scripts etc. The "Triggers"
   feature had to be enabled with the configuration property
   <code class="literal">triggers.enabled=true</code> (which is not supported as well anymore). So
   you may need to search your configuration for this property to check if
   that functionality was used. If so, the configuration will have to be
   adapted using the regular conditiona actions and scripting mechanisms.
</li><li class="listitem">
The obsolete "Info Portal" functionaliy was removed from the SLS, since it
   provides no useful functionality beyond the SES appliance GUI.
</li><li class="listitem">
Support for the named Log4j logger "stdout" has been discontinued. This
   logger would redirect the JVM stdout stream into the "sls.log" file. This
   was required a long time ago when not all application servers supported
   proper rotation of the standard-output-logfile. However, this feature
   is not only needed anymore nowadays, it is also potentially problematic
   if there are multiple web applications running inside the same cotainer,
   because one could then capture the standard output of all the other
   web applications too. For these reasons, this feature has been removed.
   Existing Log4j configuration files with the "stdout" logger can safely be
   updpated by removing this logger, but it also isn’t a problem if the
   logger entry is still there; it’s just not used anymore.
</li><li class="listitem">
Support for the named Log4j logger "statistics" and the related functionality
   has been discontinued. Mainly because it has become obsolete by now where
   the SLS is used mostly in appliances or managed environments, where other
   means exist for gaining statistical data from the log files.
</li><li class="listitem">
JEXL 1 has been removed entirely. The SLS now always only uses JEXL 2 when
  evaluating a JEXL expression.
</li></ul></div></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="x15273_Heading1Tarsec_Commands"></a>Chapter 6. Commands ("cmd" parameter)</h2></div></div></div><p>The URL parameter "cmd", when inserted into the request sent to the SLS, can
be used to trigger a number of certain behaviors. By default, using this parameter
with a matching model URI will trigger the start of that model, as explained
in chapter <a class="link" href="#x29792_Heading1Tarsec_Model" title="Chapter 7. Model">"Model"</a>.</p><p>This following paragraphs document all the special, reserved "cmd"-parameter
values that will instead trigger a specific functionality in the SLS.</p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="x112244_Heading1Tarsec_Ping_Action"></a>6.1. "pingsls" - Ping SLS</h2></div></div></div><p>The URL parameter <code class="literal">"cmd=pingsls"</code> triggers a simple HTTP 200 status response,
with the custom SLS response header "SLSStatus", which allows to determine if
the SLS is functional and available. See <a class="link" href="#x121212_Heading1Tarsec_SLSStatus_Header" title="38.2. Header &quot;SLSStatus&quot;">"SLSStatus header"</a>
for details about this response header and its values.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="x112233_Heading1Tarsec_Cancel_Action"></a>6.2. "cancel" - Cancel action / flow</h2></div></div></div><p>The URL parameter <code class="literal">"cmd=cancel"</code> can be used in a link in an SLS form, and when clicked,
it will trigger a reset of the current model. Also, the page will then display
the "USER_CANCEL" error (the exact text being dependent on the mapping of the
messages to this SLS error code).</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="x112233_Heading1Tarsec_Display_Single_JSP_Command"></a>6.3. "displayjsp" - Display JSP Command</h2></div></div></div><p>The special reserved "cmd"-parameter value <code class="literal">"displayjsp"</code> allows to directly
display a specific JSP, independently of the currently active model. This
<code class="literal">"cmd"</code> value is <code class="literal">"displayjsp"</code>; it basically triggers a direct internal
invocation of the "show.jsp" state. Therefore, it also requires a second
URL parameter, <code class="literal">"jsp"</code>, with the alias or path of the JSP to display, e.g.</p><pre class="screen">../sls?cmd=displayjsp&amp;jsp=jsp.login</pre><p>when the alias from the message resource file should be used, or</p><pre class="screen">../sls?cmd=displayjsp&amp;jsp=/WEB-INF/jsp/Login.jsp</pre><p>to use the actual JSP file path directly.</p></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="x29792_Heading1Tarsec_Model"></a>Chapter 7. Model</h2></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_overview_4"></a>7.1. Overview</h2></div></div></div><p>The  implements a model-based state-machine mechanism which allows to implement
even very specific authentication processes, all just through the configuration.</p><p>Once the first request from a client reaches the SLS, a new login session with
the appropriate model is created. It depends on some attributes of the
request - such as the request URI, or the values of certain
parameters - which model is used.</p><p>For example, a request to the action-URI "<code class="literal">/auth</code>" will trigger the standard
login model, while a request for the URI "<code class="literal">/changepwd</code>" could trigger the
change-password-model for an already logged in user.</p><p>As long as the user does not have an authenticated SES session, only the URI
"<code class="literal">/auth</code>" is available to the client. In order to still be able to start a
different model than the default login model (for instance a password change
process), it is also possible to use the URL parameter "<code class="literal">cmd</code>" with the URI
path of the model, just without the slash, like:</p><pre class="screen">http://acme.com/sls/auth?cmd=changepwd</pre><p>Which would trigger the model configured for the URI "<code class="literal">/changepwd</code>".</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_post_vs_get_requests"></a>7.1.1. POST vs. GET requests</h3></div></div></div><p>Each time the SLS receives a GET requests, the model state remains unchanged (with some exceptions
for login procedures that require GET requests). This means that the current state (usually a JSP
state like "get.cred") remains active, and the page is displayed again. Which is the common, expected
behaviour if the user, for instance, performs a page refresh in the browser.</p><p>On POST requests, the model is forwarded at request entry, from the current state to the next state, specifically:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
The current state itself (such as "<code class="literal">get.cred</code>") is not executed anymore
</li><li class="listitem">
Any JEXL actions that the state may have ARE executed
</li><li class="listitem">
All "<code class="literal">nextStates</code>" of the current state are evaluated, and if there is a follow-up state with a matching condition, that state will be used to forward the model to it.
</li></ul></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_no_op_states"></a>7.1.2. NO-OP States</h3></div></div></div><p>There is a special model state named "do.generic" which, by itself, does nothing. It’s typical use-case
is executing custom JEXL- or Groovy-actions somewhere in the model. But there is another special use
related to the previously mentioned behaviour of the SLS when processing a POST request.</p><p>Because POST requests always immediately advance the model to the next state at request entry, there are
some special cases where this can be a problem. A typical example is when the exactly same model should
be used for cases where the very first request can be both a GET request (e.g. from a web browser, after
being redirected to the SLS) or a POST request (e.g. from a rich client, as explained in the following
paragraphs). Another example is a SAML-based login model, where the first request can be a GET or a POST,
depending on the chosen binding.</p><p>In such cases, it may be necessary to put an additional "do.generic" state at the beginning of the model,
knowing that it will have no effect for a GET request (it will just pass through to the following state),
while during a POST request, it will be skipped - instead of the next state, which is really the first
one, and which should always be processed.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_saml_or_oidc_login_and_post_on_first_request"></a>7.1.3. SAML or OIDC Login and POST on first request</h3></div></div></div><p>Usually, in any SAML Identity Provider login model or any OpenID Connect (OIDC) login model, the first model
state is one which processes the incoming SAML or OIDC message, e.g.</p><pre class="screen">do.saml.idp.handlemsg</pre><p>or</p><pre class="screen">do.oidc.op.handlemsg</pre><p>This state (which is explained in more detail later) basically extracts all SAML or OIDC elements from the
incoming request and processes them. But if the incoming request is a POST request, and this state
was the first in the model, it would immediately be skipped, and the SAML or OIDC request would not be
processed at all. Which would then lead to a number of errors in the rest of the model. So, in order
to support POST-binding in SAML and OIDC flows, an additional "dummy" state must be put in front of the message
processing state, e.g.</p><pre class="screen">do.generic
do.saml.idp.handlemsg</pre><p>That way, when the first request is a POST, it will skip the first state - but that is just a dummy
no-operation state. In case of a GET, the "do.generic" will be executed, but since it doesn’t do
anything by itself, the model also continues to the next state, and processes the SAML or OIDC message.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_rich_clients_and_post_on_first_request"></a>7.1.4. Rich-Clients and POST on first request</h3></div></div></div><p>The previously described SLS behaviour is often (ab-)used to support authentication for rich-clients in the same login model as for browser clients. For example, consider this simple model:</p><pre class="programlisting">model.login.uri=/auth
model.login.failedState=get.cred
model.login.state.10.name=get.cred
model.login.state.20.name=do.auth
model.login.state.30.name=do.success</pre><p>Also we are assuming that the SLS will be configured to accept basic authentication credentials, and that the rich-client will send a basic authentication header in its POST request.</p><p>With a browser client, the first request is a GET request (redirect sent from the HSP reverse proxy to the SLS). The model starts at the first state "<code class="literal">get.cred</code>", the corresponding JSP is displayed.</p><p>With a rich-client sending a POST request, the model also starts at the "<code class="literal">get.cred</code>" request, but because it is a POST request, is immediately forwarded to the next state - "<code class="literal">do.auth</code>". So, conveniently, no JSP will be displayed, which is fine for the rich-client (which couldn't handle a HTML page anyway).</p><p>However, the problem starts as soon as there are other states before the "<code class="literal">get.cred</code>" state, e.g. something like</p><pre class="programlisting">model.login.uri=/auth
model.login.failedState=get.cred
model.login.state.10.name=do.generic-log
model.login.state.10.action.1=${function.logAudit('Starting login')}
model.login.state.20.name=get.cred
model.login.state.30.name=do.auth
model.login.state.40.name=do.success</pre><p>In this example, the POST request from the rich-client will result in skipping the "<code class="literal">do.generic-log</code>" state (which doesn't to anyhing by itself), altough the JEXL-action attached to it will still be executed. But then, obviously, the next state is "<code class="literal">get.cred</code>", so the HTML page will be sent back to the client. In cases like these, there are two options:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">
Implement a separate login model for the rich-clients, triggered either by a JEXL condition or through the "<code class="literal">cmd</code>" parameter
</li><li class="listitem">
Skip the "<code class="literal">get.cred</code>" state using a conditional nextState, e.g.:
</li></ol></div><pre class="programlisting">model.login.uri=/auth
model.login.failedState=get.cred
model.login.state.10.name=do.generic-log
model.login.state.10.action.1=${function.logAudit('Starting login')}
model.login.state.10.nextState.1=do.auth
model.login.state.10.nextState.1.if=${...is rich-client...}
model.login.state.20.name=get.cred
model.login.state.30.name=do.auth
model.login.state.40.name=do.success</pre></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_model_anatomy"></a>7.2. Model Anatomy</h2></div></div></div><p>Each model consists of some global attributes and a number of states. The global model attributes are:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">uri</code>: <span class="emphasis"><em>(Optional)</em></span> Defines the URI path which triggers this model. A switch to this model can also be enforced by setting the request parameter "cmd" to the value of the URI, without the slash (like "<code class="literal">cmd=auth</code>" to trigger the model configured for the URI "<code class="literal">/auth</code>"). It is also possible to define multiple URLs for one model.
</li><li class="listitem">
<code class="literal">alwaysIf</code>: <span class="emphasis"><em>(Optional)</em></span> The model will be triggered if the specified script condition resolves to "<code class="literal">true</code>" (this is true for every request, even if there is already a model in the session).
</li><li class="listitem">
<code class="literal">credentialState</code>: <span class="emphasis"><em>(Optional)</em></span> The model will be triggered if the SES session credential state is in the configured value. The SES session credential state is "<code class="literal">valid</code>" after a successful authentication, but the application could change it to a custom value in order to trigger a special process (like a transaction verification, for example).
</li><li class="listitem">
<code class="literal">missingAuthorization</code>: <span class="emphasis"><em>(Optional)</em></span> The model will be triggered if the client was redirected to the SLS due to a
   certain missing authorization. <span class="emphasis"><em>NOTE: This trigger only works IF the user has a valid, authenticated SES session! The simple reason for this
  is that before any kind of authorization can be performed, authentication must be completed. Therefore, as long
  as the "credentialState" value of the SES session is "none", this trigger will be ignored!</em></span>
</li><li class="listitem">
<code class="literal">if</code>: <span class="emphasis"><em>(Optional)</em></span> The model will be triggered if the specified script condition resolves to "<code class="literal">true</code>" (but only if there is no model in the session yet).
</li><li class="listitem">
<code class="literal">failedState</code>: <span class="emphasis"><em>(Mandatory)</em></span> A default failed state must be defined (must
point to one of the states, usually one displaying a page). The model processing
will switch to that state if an error occurs, as long as no other failed state
has been defined for the current state.
</li><li class="listitem">
<code class="literal">credentials</code>: <span class="emphasis"><em>(Optional)</em></span> Defines a comma-separated list of credential types,
e.g. <code class="literal">username,password,challenge</code>. The "<code class="literal">do.success</code>" step will then verify if
the session contains all the specified credentials, and all of them have been
verified by some adapter. The value can also be a dynamic scripting expression
that must result in a comma-separated list of credential types.
</li></ul></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_selecting_a_model"></a>7.2.1. Selecting A Model</h3></div></div></div><p>See <a class="link" href="#x26318_Heading2Tarsec_Triggering_a_model" title="7.7. Triggering a model">"Triggering a model"</a> for details on how to use a certain model under certain conditions.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_model_state_attributes"></a>7.2.2. Model State Attributes</h3></div></div></div><p>Each state has the following attributes:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">name</code>: Defines what the SLS should do; the value either points to a JSP that
should be displayed, or an action to be performed (details later). The dispatch
mapping mechanism is used to map this value to an actual JSP path or action class.
</li><li class="listitem">
<code class="literal">failedState[.x]</code>: Reference to the state to which the model should switch in
case that the execution of this current state failed. A typical example is a
state that displays an error page. There can be several follow-up failed states
coupled with conditions.
</li><li class="listitem">
<code class="literal">nextState[.x]</code>: Reference to the next follow-up state, if this current state was executed successfully. There can be several follow-up states coupled with conditions.
</li><li class="listitem">
<code class="literal">action[.x]</code>: Optional, dynamic action(s), defined by a JEXL-function that should be executed. An action can have 1 - n conditions, which must all resolve to "<code class="literal">true</code>" in order for the action to be executed.
</li><li class="listitem">
<code class="literal">param.<span class="emphasis"><em>&lt;name&gt;</em></span></code>: Optional parameters that can be used to fine-tune the behaviour of the action that belongs to the state.
</li><li class="listitem">
<code class="literal">property</code>: Optional property which is just a string value that serves as a
parameter for the dispatch-action mapped to the state (used just by a few
specific actions).
</li><li class="listitem">
<code class="literal">adapter</code>: Optional, allows to override the adapter to use for action states that
  allow different kinds of adapters like <code class="literal">do.auth</code> or <code class="literal">do.changepassword</code>.
</li></ul></div><p>A state can have more than one "<span class="emphasis"><em>Failed States</em></span>", and more than one "<span class="emphasis"><em>Next States</em></span>". In that case, conditions (usually based on JEXL expressions) are used to determine at runtime to which state to switch. This allows to implement logical branches in the login flow, just by changing the configuration.</p><p>The model itself also requires that a default "<span class="emphasis"><em>Failed State</em></span>" is defined, which will be used for all states in case of a failure, as long as no specific failed state has been defined.</p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_configuration_structure"></a>7.3. Configuration Structure</h2></div></div></div><p>The models are configured in the "<code class="literal">sls.properties</code>"-file through a number of properties grouped by their name structure. Each model is always defined by a set of properties with the prefix "<code class="literal">model.</code>" followed by the <span class="emphasis"><em>name</em></span> of that model. The following sample configuration properties would define the model named "login":</p><pre class="programlisting">model.login.uri=..
model.login.state.1=...
model.login.state.2=...</pre><p>The following basic - but complete - example explains the various parts of a model configuration. The numbers in front of the brackets are NOT part of the actual configuration, they are just used here to refer to the explanations below:</p><pre class="screen">1&gt; model.login.uri=/auth
2&gt; model.login.credentials=username,password
3&gt; model.login.failedState=get.cred
4&gt; model.login.state.1.name=get.cred
5&gt; model.login.state.2.name=do.auth
6&gt; model.login.state.3.name=do.success</pre><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">
The model "login" is mapped to the request-URI "<code class="literal">/auth</code>"
</li><li class="listitem">
The model requires the credentials of semantic type "username" and "password" to be verified in order for the login process to complete successfully.
</li><li class="listitem">
The default failed state for this model is "<code class="literal">get.cred</code>"
</li><li class="listitem">
The first state is "<code class="literal">get.cred</code>", which shows the login page
</li><li class="listitem">
The second state is "<code class="literal">do.auth</code>", which performs the authentication
</li><li class="listitem">
The third step performs everyting necessary after a successful authentication.
</li></ol></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_model_state_syntax"></a>7.3.1. Model State Syntax</h3></div></div></div><p>A model state property always has certain attributes:</p><pre class="programlisting">model.login.state.1.&lt;attribute&gt;=&lt;value&gt;</pre><p>An example would be:</p><pre class="programlisting">model.login.state.1.nextState=15</pre><p>Where "nextState" is the attribute, and "15" the value. The following list shows all possible attributes and the meaning of their property values, and which ones are optional:</p><div class="table"><a id="idm1415"></a><p class="title"><strong>Table 7.1. State Attributes And Values</strong></p><div class="table-contents"><table class="table" summary="State Attributes And Values" cellpadding="4px" style="border-collapse: collapse;border-top: 3px solid #527bbd; border-bottom: 3px solid #527bbd; border-left: 3px solid #527bbd; border-right: 3px solid #527bbd; "><colgroup><col class="col_1" /><col class="col_2" /><col class="col_3" /></colgroup><thead><tr><th style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top">Attribute </th><th style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top">Value </th><th style="border-bottom: 1px solid #527bbd; " align="left" valign="top">Optional</th></tr></thead><tbody><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p><code class="literal">name</code></p></td><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>Mapping to a JSP or action. See
<a class="link" href="#x77246_Heading2Tarsec_Model_to_Dispatch_mapping" title="7.4. Model to dispatch mapping">"Model to dispatch mapping"</a> for
details. Note that a state name may have a suffix after a "-" character. This
suffix is just a custom text that serves as a differentiator between multiple
states with the same name within a model.</p>
<p>Example: "<code class="literal">get.cred</code>"</p>
<p>Example 2: "<code class="literal">do.generic-something</code>"</p></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>No</p></td></tr><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p><code class="literal">nextState</code></p></td><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>Name or number of state to jump to in case the current state successfully completes. Example:</p>
<p><code class="literal">..nextState=get.cred</code></p>
<p>If the name is not unique within the current model, either a suffix of the number must be used. Example for using a suffix:</p>
<p><code class="literal">..nextState=do.generic-first</code></p>
<p>If this attribute is not defined, the next state in the model configuration automatically becomes the "nextState" of this state.</p>
<div class="note" style="margin-left: 0; margin-right: 10%;"><h3 class="title">Note</h3><p>The default "<code class="literal">nextState</code>" <span class="emphasis"><em>cannot have a condition!</em></span> The reason is simple: If the condition was not <code class="literal">true</code>, there would be not state left to go to.</p></div>
<p>In other words: If a conditional "<code class="literal">nextState</code>" (or "<code class="literal">failedState</code>", for that matter) should be used, it is mandatory to use a numbered state (see below, and also <a class="link" href="#x22483_Heading3Tarsec_Conditional_Branching" title="7.6.4. Conditional Branching">"Conditional Branching"</a> for details).</p></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>Yes</p></td></tr><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p><code class="literal">nextState.&lt;no&gt;</code></p>
<p><code class="literal">nextState.&lt;no&gt;.if</code></p></td><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>Multiple "nextState" attributes can be set by adding a number suffix; in that case, each of these next states <span class="emphasis"><em>must</em></span> also have
a corresponding condition which defines in what case exactly the defined state should be used as next state.</p>
<p>The following example defines an optional next  state which will be used once the current state has been completed, and the JEXL variable 'myvar\' has the value 'duh\'. If the condition is not true, the default next state will be used.</p>
<p>Example:</p>
<p><code class="literal">..nextState.1=get.cred</code></p>
<p><code class="literal">..nextState.1.if=${myvar == <span class="emphasis"><em>duh</em></span>}</code></p>
<div class="note" style="margin-left: 0; margin-right: 10%;"><h3 class="title">Note</h3><p>Unlike the <code class="literal">".action"</code> property of a state, the <code class="literal">"nextState"</code> property <span class="emphasis"><em>does
 NOT support</em></span> multiple "if" conditions like <code class="literal">"..nextState.1.if.1"</code>.</p></div></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>Yes</p></td></tr><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p><code class="literal">failedState</code></p></td><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>Name or number of state to jump to in case the current state fails to complete. Basically the same rules apply as with the "<code class="literal">nextState</code>" attribute.</p>
<p>If this attribute is not defined, the global default failed state of the model automatically becomes the "<code class="literal">failedState</code>" of this state.</p></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>Yes</p></td></tr><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p><code class="literal">failedState.&lt;no&gt;</code></p>
<p><code class="literal">failedState.&lt;no&gt;.if</code></p></td><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>Multiple "failedState" attributes can be set by adding a number suffix (similar to the "nextState" attribute).</p>
<p>Again, every numbered "nextState" <span class="emphasis"><em>must</em></span> have a condition.</p>
<p>The following example defines an optional failed state which will be used if the current state failes to complete, and the JEXL variable '<code class="literal">myvar</code>\' has the value '<code class="literal">yes</code>\'. If the condition is not true, the default failed state will be used.</p>
<p>Example:</p>
<p><code class="literal">..failedState.1=get.cred</code></p>
<p><code class="literal">..failedState.1.if=${myvar == <span class="emphasis"><em>yes</em></span>}</code></p>
<div class="note" style="margin-left: 0; margin-right: 10%;"><h3 class="title">Note</h3><p>Unlike the <code class="literal">".action"</code> property of a state, the <code class="literal">"failedState"</code> property <span class="emphasis"><em>does
 NOT support</em></span> multiple "if" conditions like <code class="literal">"..failedState.1.if.1"</code>.</p></div></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>Yes</p></td></tr><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p><code class="literal">action[<span class="emphasis"><em>.&lt;no&gt;</em></span>]</code></p>
<p><code class="literal">action[<span class="emphasis"><em>.&lt;no&gt;</em></span>].if</code></p></td><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>JEXL/Groovy expression to evaluate <span class="emphasis"><em>after</em></span> the state itself has been successfully completed.
Typical use cases are functions like setting authorizations, propagating headers to the application etc.</p>
<p>For actions it is especially important to know that they are processed in the order of their numbering, if there is more than one. So in the example below, it is guaranteed that the action with the number "1" will be executed before the action with the number "2".</p>
<p>Example:</p>
<pre class="screen">..action.1=${function.doSomething()}
..action.2=${function.doMore()}
..action.2.if.1=${...cond 1...}
..action.2.if.2=${...cond 2...}</pre>
<p>NOTE 1: If an action has multiple conditions, they must ALL resolve to "true" for the action to be executed. In other words, the conditions have an "<code class="literal">AND</code>" dependency between them.</p>
<p>NOTE 2: As already mentioned, actions are only executed <span class="strong"><strong><span class="emphasis"><em>after</em></span></strong></span> the state has been successfully completed.
For all states that send a response back to the client this means that actions are only eventually
evaluated if/when a <span class="emphasis"><em>new request</em></span> comes into the SLS and the SLS login session had not been
invalidated. This includes all states that show a JSP, as well as states like <code class="literal">do.redirect</code>
and states that send SAML messages.</p>
<p>NOTE 3: If a JSP state like <code class="literal">get.cred</code> has an action which invokes a JEXL function
like <code class="literal">function.failWithCustomError(…)</code>, the SLS will respond with a 500 error
instead of jumping to the <code class="literal">failedState</code>. The reason is that the internal error
handling is different during all JSP states than with the other ones. In such
cases, consider moving the action to a separate <code class="literal">do.generic</code> state before or after
the JSP state (depending on your use-case).</p></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>Yes</p></td></tr><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p><code class="literal">param.<span class="emphasis"><em>&lt;name&gt;</em></span></code></p></td><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>Parameter for the action that belongs to this state. There can also be multiple parameters (see documentation of a state for details).</p>
<p>The actual name of the parameter is taken from the last part of the property name (after the ".param." string). The following example defines a parameter named "<code class="literal">url</code>" with the value "<code class="literal">/some/url</code>".</p>
<p>Example:</p>
<p><code class="literal">..param.url=/some/url</code></p></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>Yes</p></td></tr><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p><code class="literal">property</code></p></td><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>Similar to the "param" attribute(s), this single attribute allows to define a custom value for an action that can be used as a parameter to fine-tune the behaviour of the corresponding action.</p>
<p>This simple parameter mechanism existed before the more flexible "param" attributes, but is still used by some actions due to its simplicity.</p>
<p>Example:</p>
<p><code class="literal">..property=/some/url</code></p></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>Yes</p></td></tr><tr><td style="border-right: 1px solid #527bbd; " align="left" valign="top"><p><code class="literal">adapter</code></p></td><td style="border-right: 1px solid #527bbd; " align="left" valign="top"><p>Allows to to override the adapter to use for action states that
allow different kinds of adapters like <code class="literal">do.auth</code> or <code class="literal">do.changepassword</code>.</p>
<p>Has precedence over configured adapter mappings and has no effect on action states
that only support a specific adapter anyway, like <code class="literal">do.ldap</code>.</p>
<p>Example:</p>
<p><code class="literal">..adapters=ldap</code></p></td><td style="" align="left" valign="top"><p>Yes</p></td></tr></tbody></table></div></div><br class="table-break" /></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="x37214_Heading3Tarsec_do_success_must_be_last"></a>7.3.2. "do.success" / "do.success.jsp" must be last</h3></div></div></div><p>Note that the "<code class="literal">do.success</code>" (or "<code class="literal">do.success.jsp</code>") state must be the last in the process. It does not
have to be the last in the model, but all states following it can only be
reached through explicit branching from previous states.</p><p>The reason is that this state sends a response back to the client (either a redirect
or a JSP), so control is handed back to the client, and it also
terminates the SLS session (NOT the client’s session with the WAF).</p><p>So, if any custom operations should be performed using the "<code class="literal">do.generic</code>" state
in the case of success, it has to be done before the "<code class="literal">do.success</code>" state, like this:</p><pre class="screen">4&gt; model.login.state.2.name=do.auth
5&gt; model.login.state.2.name=do.generic
5&gt; model.login.state.2.action.1=${...do something...}
6&gt; model.login.state.3.name=do.success</pre></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="x77246_Heading2Tarsec_Model_to_Dispatch_mapping"></a>7.4. Model to dispatch mapping</h2></div></div></div><p>The ".<code class="literal">name</code>"-value of a state is, in itself, just a string without a meaning.
The mapping to an actual JSP or action happens by using that value as a global
forward for the dispatching mechanism.</p><p>Therefore, all the mappings described in the tables in the following chapters
can be looked up in the "<code class="literal">&lt;global-forwards&gt;</code>"-section in the dispatching
configuration file:</p><pre class="screen">&lt;sls webapp directory&gt;/WEB-INF/struts-config.xml</pre><p>Please note that most of the JSP mappings in the dispatch configuration do NOT
contain the actual path of the JSP file, but only a key like</p><pre class="screen">jsp.login</pre><p>This key is then used to retrieve the actual JSP file path from the SLS language resource file, based on the user's language (see <a class="link" href="#x17268_Heading3Tarsec_Message_Resource_Files" title="14.4. Message Resource Files">"Message Resource Files"</a>).</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_state_name_suffix"></a>7.4.1. State Name Suffix</h3></div></div></div><p>The optional suffix of a state name is ignored as far as dispatch mapping is
concerned. Example:</p><pre class="screen">do.generic-something</pre><p>In this example, "<code class="literal">do.generic</code>" is the actual name part that will be looked up
in the dispatch configuration. "<code class="literal">-something</code>" is the suffix that will be ignored.</p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_examples"></a>7.5. Examples</h2></div></div></div><p>The following simplified examples give a quick idea of what to achieve how with custom model configurations.</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_minimal_single_step_login"></a>7.5.1. Minimal Single-Step Login</h3></div></div></div><p>Here, the first step is displaying the login page ("<code class="literal">get.cred</code>"), then
performing the authentication ("<code class="literal">do.auth</code>"), and then executing the actions
after a successful authentication ("<code class="literal">do.success</code>"), such as creating
authorization headers etc.</p><pre class="programlisting">model.login.uri=/auth
model.login.failedState=get.cred
model.login.state.1.name=get.cred
model.login.state.2.name=do.auth
model.login.state.3.name=do.success</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_minimal_double_step_login"></a>7.5.2. Minimal Double-Step Login</h3></div></div></div><p>This slightly extended model tries to authenticate the user against two different back-end systems, first LDAP and then RADIUS. If the LDAP authentication attempt in step one fails, it just continues to the RADIUS authentication. If that fails as well, it will switch back to the default failed state, "<code class="literal">get.cred</code>" (the login page).</p><pre class="programlisting">model.login.uri=/auth
model.login.failedState=get.cred
model.login.state.1.name=get.cred
model.login.state.2.name=do.auth
model.login.state.2.adapter=ldap
model.login.state.2.nextState=do.success
model.login.state.2.failedState=do.auth-radius
model.login.state.3.name=do.auth-radius
model.login.state.3.adapter=radius
model.login.state.4.name=do.success</pre><p>Note that the "next state" for state 2 ("do.auth", the first authentication
attempt with LDAP) is set to "do.success". This means that in case of a
successful authentication, the regular next state should be state 4 ("do.success").</p><p>If the authentication fails, on the other hand, the model should just switch to
the next state in the list, no. 3 ("do.auth-radius"), in order to try to
perform the second authentication call with RADIUS. If that one fails too, it
will switch back to the default failed state of the model, "get.cred", which
is the first state, so the whole process begins anew.</p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_customization"></a>7.6. Customization</h2></div></div></div><p>It might be desirable to add some custom functionality at some point of the
model, for example in the last step after a successful authentication. There
are basically two extension points, custom actions and the "<code class="literal">do.generic</code>" state:</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="x47278_Heading3Tarsec_Custom_Actions"></a>7.6.1. Custom Actions</h3></div></div></div><p>As mentioned before, each state can have an optional action, which means a
JEXL-function that is executed at that time. Since custom JEXL-functions can
easily be implemented and actived through the configuration (see
<a class="link" href="#x49003_Heading1Tarsec_Expressions" title="Chapter 32. JEXL Expressions">"JEXL Expressions"</a>), this allows to
incorporate custom Java functionality to be executed in a login flow.</p><p>A custom action is configured like this:</p><pre class="programlisting">model.login.uri=/auth
model.login.failedState=get.cred
model.login.state.1.name=get.cred
model.login.state.2.name=do.auth
model.login.state.2.action=${session.setValue('myValue', 'abcdef')}
model.login.state.3.name=do.success</pre><p>After the authentication has been performed by the "<code class="literal">do.auth</code>"-State, the custom JEXL-function "<code class="literal">session.setValue()</code>" is executed, which stores a value in the SLS session (just for the sake of this example).</p><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="_multiple_actions"></a>Multiple Actions</h4></div></div></div><p>By adding numbers to the property name after the "<code class="literal">.action.</code>"-part, multiple actions can be defined:</p><pre class="programlisting">model.login.uri=/auth
model.login.failedState=get.cred
model.login.state.1.name=get.cred
model.login.state.2.name=do.auth
model.login.state.2.action.1=${session.setValue('myValue', 'abcdef')}
model.login.state.2.action.2=${session.setValue('otherValue', 'xyz')}
model.login.state.3.name=do.success</pre></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="_conditional_actions"></a>Conditional Actions</h4></div></div></div><p>The following example is the same as above, only that it adds a condition for executing the first action, while the second is always executed:</p><pre class="programlisting">model.login.uri=/auth
model.login.failedState=get.cred
model.login.state.1.name=get.cred
model.login.state.2.name=do.auth
model.login.state.2.action.1=${session.setValue('myValue', 'abcdef')}
model.login.state.2.action.1.if.1=${session.getValue('someValue') != ''}
model.login.state.2.action.2=${session.setValue('otherValue', 'xyz')}
model.login.state.3.name=do.success</pre><p><span class="emphasis"><em>NOTE: An action can have multiple conditions. In that case, ALL conditions must resolve to "<code class="literal">true</code>" for the action to be executed!</em></span></p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="_a_few_caveats"></a>A Few Caveats</h4></div></div></div><p>These custom JEXL-based actions are always executed AFTER the state itself had
been processed. This means that actions can be set only for states that refer
to dispatch-actions; if the state just displays a JSP, the request processing
stops after the JSP has been delivered to the client, and the custom action
will not be evaluated.</p><p>Also, all the final states of a model (such as "<code class="literal">do.success</code>") are special
cases, as the SLS processing stops once they are completed. For such cases, the
actions need to be attached to a <span class="emphasis"><em>generic</em></span> <span class="emphasis"><em>state</em></span> that is included in the model,
just before the final state (see below).</p></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_generic_states"></a>7.6.2. Generic States</h3></div></div></div><p>It is also possible to add so-called generic states to the model at any point,
which refer to a dummy (aka "do-nothing") action. Such generic states basically
just serve as holders to which to attach some custom JEXL-functions to be
executed.</p><p>An example would look like this:</p><pre class="programlisting">model.login.uri=/auth
model.login.failedState=get.cred
model.login.state.1.name=get.cred
model.login.state.2.name=do.auth
model.login.state.3.name=do.generic
model.login.state.3.action=${session.setValue('myValue', 'abcdef')}
odel.login.state.4.name=do.success</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_state_name_suffixes"></a>7.6.3. State Name Suffixes</h3></div></div></div><p>Especially the "<code class="literal">do.generic</code>" state is often used multiple times within the same model. In order to reference one as a failed- or next-state, the number must be used (because the name alone would be ambiguous), or a name with suffix. The suffix provides the advantage that no numerical references must be updated, should the model ever be changed by inserting new states or removing existing ones.</p><pre class="programlisting">model.login.uri=/auth
model.login.failedState=get.cred
model.login.state.1.name=get.cred
model.login.state.2.name=do.auth
model.login.state.2.nextState.1=do.generic-two
model.login.state.2.nextState.1.if=${some.variable == 'someValue'}
model.login.state.3.name=do.generic-one
model.login.state.3.action=${session.setValue('myValue', 'abcdef')}
model.login.state.4.name=do.generic-two
model.login.state.4.action=${session.setValue('myValue', 'xyz')}
oodel.login.state.5.name=do.success</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="x22483_Heading3Tarsec_Conditional_Branching"></a>7.6.4. Conditional Branching</h3></div></div></div><p>As shown in the previous examples, it is possible to define multiple "<code class="literal">nextState</code>" values for one given state. The following rules apply for adding "<code class="literal">nextState</code>" entries to one state:</p><p><span class="strong"><strong>There is always a default!</strong></span></p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">
Each state <span class="emphasis"><em>always</em></span> has a default "<code class="literal">nextState</code>". Either explicitely declared like this:
</li></ol></div><pre class="programlisting">model.state.10.name=do.ldap
model.state.10.nextState=get.cred</pre><p>or just the following state in the model, if nothing else is declared.</p><p><span class="strong"><strong>"if" required for additional</strong></span></p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">
Every additional "<code class="literal">nextState</code>", added with a number, <span class="emphasis"><em>must have</em></span> a corresponding condition, like this:
</li></ol></div><pre class="programlisting">model.state.10.name=do.ldap
model.state.10.nextState.1=do.auth
model.state.10.nextState.1.if=${myvar eq 'abc'}
model.state.20.name=create.challenge</pre><p>In this example, the default "<code class="literal">nextState</code>" of the state 10 ("<code class="literal">do.ldap</code>") is the following state in the model, state 20 ("<code class="literal">create.challenge</code>"). So, if the condition for the numbered "<code class="literal">nextState</code>" does not resolve to "true", the model will proceed to state 20.</p><p><span class="strong"><strong>"else" = default nextState</strong></span></p><p>In other words, the default "<code class="literal">nextState</code>" of a state always serves as the "else" case, if none of the conditions for the numbered "nextStates" are fulfilled. Example for "if" / "else" conditional branching:</p><pre class="screen">model.state.10.name=get.cred

# Go to state 50, if JEXL variable "domain" equals "acme.com"
# Otherwise ("else"), go to default nextState ("create.challenge")
model.state.10.nextState.1=do.ldap
model.state.10.nextState.1.if=${domain eq 'acme.com'}

# Perform some challenge / response
model.state.20.name=create.challenge
model.state.30.name=get.cred.challenge
model.state.40.name=do.authresponse

# Perform an LDAP lookup
model.state.50.name=do.ldap
model.state.50.property=userlookup
# By default ("else"), continue with state 80 ("do.auth")
model.state.50.nextState=80
# If LDAP attribute "grp" equals "admin", go to state 70
model.state.50.nextState.1=70
model.state.50.nextState.1.if=${attribute.ldap.grp eq 'admin'}

# Perform some HTTP callout notification
model.state.70.name=do.http
model.state.70.property=sendnotification

# Authenticate and complete.
model.state.80.name=do.auth
model.state.90.name=do.success</pre></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="x26318_Heading2Tarsec_Triggering_a_model"></a>7.7. Triggering a model</h2></div></div></div><p>To define what model must be used by the SLS when a new SLS session is created, the following attributes can be used:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
URI: Based on the URI of the incoming request
</li><li class="listitem">
Based on a custom scripting condition (two variants available)
</li><li class="listitem">
Based on a missing authorization
</li><li class="listitem">
Credential State: Based on the state of the user’s SES session (see below)
</li><li class="listitem">
"<code class="literal">REQ</code>"-Command: Based on the value of the "<code class="literal">cmd</code>"-field in the "<code class="literal">req</code>"-Parameter (see below)
</li></ul></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_multiple_triggers_per_model"></a>7.7.1. Multiple triggers per model</h3></div></div></div><p>It is possible to define multiple triggers for one model, e.g. an URI and a JEXL condition. Example:</p><pre class="programlisting">model.special.uri=/special
model.special.if=${header.trigger == 'special'}
model.special.failedState=get.cred
model.state.100.name=get.cred</pre><p>In this example, the model will be triggered by both a "/special" request URI, as well as a HTTP request header named "trigger" which contains the string "special". In such a case, those triggers will still be processed as explained in <a class="link" href="#x91864_Heading2Tarsec_Trigger_Priority" title="7.8. Trigger Priority">"Trigger Priority"</a>.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_uri"></a>7.7.2. URI</h3></div></div></div><p>This is the typical use-case. The default action URI of the SLS is "/auth", so the default login model should be configured to be used if for that URI (any incoming request with an unmapped / unconfigured URI will be forwarded to this path):</p><pre class="programlisting">model.login.uri=/auth</pre><p>For other processes, such as password change, other URIs should be defined (in the "web.xml" configuration file), and the models for those processes should be configured accordingly:</p><pre class="programlisting">model.changepwd.uri=/changepwd</pre><p>It is also possible to map multiple URLs to one model:</p><pre class="programlisting">model.changepwd.uri.1=/one
model.changepwd.uri.2=/two
model.changepwd.uri.3=/three</pre><p>The "<code class="literal">changepwd</code>" model could then be triggered by invoking any of the three URLs "<code class="literal">/one</code>", "<code class="literal">/two</code>" or "<code class="literal">/three</code>" (or using the "<code class="literal">cmd</code>" parameter, like "<code class="literal">cmd=one</code>", "<code class="literal">cmd=two</code>" or "<code class="literal">cmd=three</code>").</p><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="_cmd_parameter_trigger"></a>"CMD"-Parameter Trigger</h4></div></div></div><p>Please note that a URL-parameter "<code class="literal">cmd</code>" in a request to the SLS will trigger the use of the model configured for a URI with the same value as the "<code class="literal">cmd</code>"-parameter.</p><p>For example, the SLS request URI</p><pre class="screen">..../sls/auth?cmd=changepwd</pre><p>will force the SLS to invoke the model configured for the "<code class="literal">/changepwd</code>" URI. Actually, the value of this parameter always overrides the actual request URI value.</p><p>Please note that the model also begins from the first state. In other words, using the "<code class="literal">cmd</code>"-parameter resets the state of the model in the SLS session. Usually, the "<code class="literal">cmd</code>"-parameter is used in links to trigger direct invocation of certain actions on the login service.</p><p>The SLS login session remains intact, with all of its JEXL/Groovy variables, but all credentials are removed.</p><p><span class="strong"><strong>Reserved "cmd" Values</strong></span></p><p>There are some reserved values for the "cmd" parameter:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">displayjsp</code> - Used to directly invoke the "show.jsp" state. See <a class="link" href="#x112233_Heading1Tarsec_Display_Single_JSP_Command" title="6.3. &quot;displayjsp&quot; - Display JSP Command">"Display Single JSP Command"</a> for details.
</li><li class="listitem">
<code class="literal">pingsls</code> - Triggers a simple HTTP response to see if the SLS is available.
</li></ul></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_alwaysif_scripting_condition"></a>7.7.3. "alwaysIf" Scripting condition</h3></div></div></div><p>Triggers the model if the script expression evaluates to "<code class="literal">true</code>". This trigger is
evaluated on every request, so it can also be used to re-start the model already
being processed in the current session, or to switch to another model entirely.
In this example, if the request has a parameter "<code class="literal">restart</code>" with the value "<code class="literal">yes</code>":</p><pre class="programlisting">model.login.alwaysIf=${parameter.restart == 'yes'}
model.login.failedState=get.usererror
model.login.state.1.name=get.cred.token
model.login.state.100.name=get.usererror</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_if_scripting_condition"></a>7.7.4. "if" Scripting condition</h3></div></div></div><p>Triggers the model if the script expression evaluates to "<code class="literal">true</code>" (but only if there was
no model yet in the session). In this example, if the request has a parameter "<code class="literal">abc</code>" with the value "<code class="literal">dothis</code>":</p><pre class="programlisting">model.login.if=${parameter.abc == 'dothis'}
model.login.failedState=get.usererror
model.login.state.1.name=get.cred.token
model.login.state.100.name=get.usererror</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="x86589_Heading4Tarsec_Missing_Authorization"></a>7.7.5. Missing Authorization</h3></div></div></div><p>If a missing authorization was the reason for the redirect of the client to the SLS, that authorization is signaled to the SLS through some custom HTTP headers by the reverse proxy. The authorization itself is just a string, defined with the "<code class="literal">AC_RequireAz</code>" directive in the SRM location.</p><p>The following example would trigger the SLS to use the "<code class="literal">tokenlogin</code>" model in case that a user needs the authorization "<code class="literal">token</code>":</p><pre class="screen">model.tokenlogin.missingAuthorization=token</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_credential_state"></a>7.7.6. Credential State</h3></div></div></div><p>The HSP/SES session (which has no direct correlation to the SLS session) carries an internal state. At the beginning, when a client browser connects to the HSP but isn't authenticated yet, the state is "<code class="literal">Invalid</code>". After a successful authentication, the state changes to "<code class="literal">Valid</code>".</p><p>For certain special functionality such as transaction verification, the HSP (or the application, to be specific) will change the value of an active, authenticated session to any custom value such as "<code class="literal">CredVerify</code>" in order to start a process like verification of a pending transaction.  Once the HSP session is not in state "<code class="literal">Valid</code>" anymore, any following request from the client will be directed to the SLS. The application session is still valid at this point, though; this serves just as a mechanism to implement processes that require interaction with the SLS while a user is working with an application.</p><p>A good example is an E-Banking application, where the user needs to verify transactions. While the application session remains active, the user must be forced to switch to the SLS in order to perform a transaction verification. To achieve this, the application will change the state of the HSP session (by setting a special HTTP header) to a custom value, like "<code class="literal">CredVerify</code>". The next request from the client is then redirected to the SLS by the HSP automatically.</p><p>At that point, a special model should be invoked to process the verification of a transaction, but the request URI will just be the default URI of the SLS (such as "<code class="literal">/auth</code>"), so the URI cannot be used to trigger the right model. Instead, the HSP session credential state can be used:</p><pre class="programlisting">model.trxverify.credentialState=CredVerify</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_req_command"></a>7.7.7. "REQ"-Command</h3></div></div></div><p>In some cases, the SLS might need to cooperate with adjoining services to perform certain operations. In cases where no direct communication with these services is possible, data is exchanged through the client redirect, in an encrypted URL-parameter named "req".</p><p>This parameter internally consists of a number of key/value-pairs; one of which is named "cmd" and can be used to trigger a certain model:</p><pre class="programlisting">model.clearvr.reqCmd=clearvr</pre></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="x91864_Heading2Tarsec_Trigger_Priority"></a>7.8. Trigger Priority</h2></div></div></div><p>The various trigger mechanisms outlined above are processed in a certain order. So it may be important to know which one has higher priority than the other one:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">
<code class="literal">cmd</code>: The request parameter "<code class="literal">cmd</code>" always triggers and restarts the model with the corresponding URI (also "<code class="literal">reqCmd</code>")
</li><li class="listitem">
<code class="literal">alwaysIf</code>: This scripting condition is evaluated on every request and always triggers and restarts the model if the expression evaluates to <span class="emphasis"><em><code class="literal">true</code></em></span>.
</li><li class="listitem">
<code class="literal">missingAuthorization</code>: The authorization that was required, but missing, for accessing the requested page.
  <span class="emphasis"><em>NOTE: This trigger only works IF the user has a valid, authenticated SES session! The simple reason for this
  is that before any kind of authorization can be performed, authentication must be completed. Therefore, as long
  as the "credentialState" value of the SES session is "none", this trigger will be ignored!</em></span>
</li><li class="listitem">
<code class="literal">if</code>: This scripting condition is evaluated only if there is no model in the session yet.
</li><li class="listitem">
<code class="literal">credentialState</code>: The SES session credential state
</li><li class="listitem">
<code class="literal">uri</code>: The request URI path
</li></ol></div><p>The following example shows two models, one with a URI trigger  (model "<code class="literal">login</code>"), and one with a "<code class="literal">credentialState</code>" trigger (model "<code class="literal">reauth</code>"). If a new SLS session is started, both triggers will be evaluated; if the incoming request carries information about the SES session credential state being "<code class="literal">Reauth</code>", the "<code class="literal">reauth</code>"-model will be instantiated. If not, the URI-based model will be triggered.</p><pre class="programlisting"># This is the default login model
model.login.uri=/auth
model.login.failedState=get.usererror
model.login.state.100.name=get.cred
model.login.state.200.name=do.auth
model.login.state.300.name=do.success
model.login.state.400.name=get.usererror

# If the field "credentialState" in the incoming
# "SessionInfo" HTTP request header is "Reauth",
# this model will be triggered.
model.reauth.credentialState=Reauth
model.reauth.failedState=get.usererror
model.reauth.state.100.name=get.cred
model.reauth.state.200.name=do.auth2
model.reauth.state.300.name=do.success
model.reauth.state.400.name=get.usererror</pre></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="x11534_Heading2Tarsec_List_of_model_states"></a>7.9. List of model states</h2></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_jsp_states"></a>7.9.1. JSP states</h3></div></div></div><p>This table lists all available model states that are mapped to a JSP.</p><div class="table"><a id="idm1857"></a><p class="title"><strong>Table 7.2. Alphabetical list of JSP states</strong></p><div class="table-contents"><table class="table" summary="Alphabetical list of JSP states" cellpadding="4px" style="border-collapse: collapse;border-top: 3px solid #527bbd; border-bottom: 3px solid #527bbd; border-left: 3px solid #527bbd; border-right: 3px solid #527bbd; "><colgroup><col class="col_1" /><col class="col_2" /></colgroup><thead><tr><th style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top">State </th><th style="border-bottom: 1px solid #527bbd; " align="left" valign="top">Description</th></tr></thead><tbody><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>get.changepassword</p></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>Page for regular password change.</p>
<p>JSP file: <code class="literal">ChangePwd.jsp</code></p></td></tr><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>get.changeexppassword</p></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>Page for changing expired password during login.</p>
<p>JSP file: <code class="literal">ChangePwd.jsp</code></p></td></tr><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>get.changepasswordsuccessful</p></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>Confirmation page for successfully completed password change.</p>
<p>JSP file: <code class="literal">ChangePwd_Ok.jsp</code></p></td></tr><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>get.cred</p></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>Default login page (usually with username and password input fields).</p>
<p>JSP file: <code class="literal">Login.jsp</code></p></td></tr><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>get.cred.challenge</p></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>Page for entering a challenge / response code.</p>
<p>JSP file: <code class="literal">ChallengeResponse.jsp</code></p></td></tr><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>get.cred.token</p></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>Can be used instead of "<code class="literal">get.cred</code>"; is mapped to the same JSP ("<code class="literal">jsp.login</code>") as the regular "<code class="literal">get.cred</code>" state, but changes that page's behaviour.</p>
<p>The default login JSP page delivered with the SLS incorporates a check, which displays an additional, third input field for a secret (such as a one-time-password) for this state.</p>
<p>Therefore, if for example the RSA adapter is used with SecurID tokens for the authentication, this state should be used in place of the "<code class="literal">get.cred</code>" state.</p>
<p>JSP file: <code class="literal">Login.jsp</code></p></td></tr><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>show.logged.out</p></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>Page which shows that the user has been logged out.</p>
<p>JSP file: <code class="literal">LogoutResult.jsp</code></p></td></tr><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>get.hspparm</p></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>Page for entering host and/or port information for the HSP back-end connection mapping (see <a class="link" href="#x10003_Heading1Tarsec_Parameter_Passing" title="Chapter 29. HSP Parameter Passing / Gateway">"HSP Parameter Passing"</a>).</p>
<p>JSP file: <code class="literal">ParameterPassing.jsp</code></p></td></tr><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>get.mobileid.error</p></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>Error page adapted specifically for the MobileID login flow.</p>
<p>JSP file: <code class="literal">MobileIDError.jsp</code></p></td></tr><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>get.mobileid.state</p></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>Page which contains the response for the AJAX request sent
during the MobileID login, informing the JavaScript client in the browser about
the state of the confirmation process.</p>
<p>JSP file: <code class="literal">MobileIDState.jsp</code></p></td></tr><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>get.mobileid.wait</p></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>Notification page used in a MobileID login process, which
polls the status of the user’s verification process through AJAX requests sent
to the SLS.</p>
<p>JSP file: <code class="literal">MobileIDWait.jsp</code></p></td></tr><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>get.reauth</p></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>Re-authentication page (usually contains an input field for
entering the name of the user for whom to reset the password).</p>
<p>JSP file: <code class="literal">Reauth.jsp</code></p></td></tr><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>get.resetpassword</p></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>Password reset page (usually contains an input field for
entering a one-time-password, such as a SecurID code).</p>
<p>JSP file: <code class="literal">ResetPwd.jsp</code></p></td></tr><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>get.resetpasswordsuccessful</p></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>Password reset success page; is shown after a
successful password reset.</p>
<p>JSP file: <code class="literal">ResetPwd_ok.jsp</code></p></td></tr><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>get.slowdown</p></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>Notification page which tells the user during a slowdown phase (triggered by several successive failed login attempts) that a short wait period is necessary before the next login attempt.</p>
<p>JSP file: <code class="literal">Slowdown.jsp</code></p></td></tr><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>get.systemerror</p></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>Error page for displaying critical system errors.</p>
<p>JSP file: <code class="literal">SystemError.jsp</code></p></td></tr><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>get.token</p></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>Authentication token selection page.</p>
<p>JSP file: <code class="literal">SelectToken.jsp</code></p></td></tr><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>get.usererror</p></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>Error page for displaying logical errors.</p>
<p>JSP file: <code class="literal">UserError.jsp</code></p></td></tr><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>get.useragent</p></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>Displays message about no longer supported client browser.</p>
<p>JSP file: <code class="literal">UserAgent.jsp</code></p></td></tr><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>get.trx</p></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>Transaction confirmation page.</p>
<p>JSP file: <code class="literal">Trx.jsp</code></p></td></tr><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>get.wait</p></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>Notification page used in a delayed login process, which triggers the start of a time-consuming  authentication call through an automatic page reload. While the page reloads, it displays a "please wait" message to the user.</p>
<p>This page must be activated explicitly, if for some reason the authentication call-out always takes a long time (like more than 10 seconds).</p>
<p>JSP file: <code class="literal">Wait.jsp</code></p></td></tr><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>get.webauthn.reg.sendmsg</p></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>Renders the page for WebAuthn registration.</p>
<p>JSP file: <code class="literal">WebAuthnReg.jsp</code></p></td></tr><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>get.webauthn.auth.sendmsg</p></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>Renders the page for WebAuthn authentication.</p>
<p>JSP file: <code class="literal">WebAuthnAuth.jsp</code></p></td></tr><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>show.logged.in</p></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>Can be activated in the configuration to display a "<span class="emphasis"><em>You are already logged in</em></span>" message to any user who invokes the SLS location again after being  authenticated already.</p>
<p>JSP file: <code class="literal">Loggedin.jsp</code></p></td></tr><tr><td style="border-right: 1px solid #527bbd; " align="left" valign="top"><p>show.jsp</p></td><td style="" align="left" valign="top"><p>Allows to display any JSP. But since this state is actually mapped to an action and not directly to a JSP, it is documented in the table of Action states below.</p>
<p>JSP file: <code class="literal">none, depends on parameter</code></p></td></tr></tbody></table></div></div><br class="table-break" /></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="x93524_Heading3Tarsec_Action_states"></a>7.9.2. Action states</h3></div></div></div><p>This table lists all available model states that are mapped to actions.</p><div class="table"><a id="x39680_TableTitleTarsec_Table_4_Alphabetical_list_of_action_states"></a><p class="title"><strong>Table 7.3. Alphabetical list of action states</strong></p><div class="table-contents"><table class="table" summary="Alphabetical list of action states" cellpadding="4px" style="border-collapse: collapse;border-top: 3px solid #527bbd; border-bottom: 3px solid #527bbd; border-left: 3px solid #527bbd; border-right: 3px solid #527bbd; "><colgroup><col class="col_1" /><col class="col_2" /></colgroup><thead><tr><th style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top">State </th><th style="border-bottom: 1px solid #527bbd; " align="left" valign="top">Description</th></tr></thead><tbody><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>create.challenge</p></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>Creates the challenge to be sent or displayed to the user in a challenge-/response process.</p></td></tr><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>create.tokens</p></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>Retrieves a list of authentication tokens from the authentication back-end system (such as a SecurID device, or a mobile phone) available to the user currently trying to log in.</p></td></tr><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>do.applogout</p></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>Redirects the client to a logout URI of an application. This is used to enforce an application logout if a problem occurs within certain processes, such as transaction verification.</p></td></tr><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>do.auth</p></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>Performs the authentication with the adapter type specified in the configuration property "adapter.authentication".</p>
<p><span class="strong"><strong>NOTE</strong></span>: Some adapters allow to override the default configuration settings used for the "do.auth" state, such
as backend URLs, with custom action properties; see the corresponding adapter documentation for details:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<a class="link" href="#x123123_using_custom_properties_for_http_do_auth" title="48.9.1. Using custom properties for &quot;do.auth*&quot; states">"HTTP adapter <span class="emphasis"><em>do.auth</em></span> with custom settings"</a>
</li><li class="listitem">
<a class="link" href="#x123123_using_custom_properties_for_ldap_do_auth" title="Using custom properties for &quot;do.auth*&quot; states">"LDAP adapter <span class="emphasis"><em>do.auth</em></span> with custom settings"</a>
</li></ul></div></td></tr><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>do.auth2</p></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><p><span class="strong"><strong>NOTE</strong></span>: Since SLS 5.1.0.0, this use case is better handled with <code class="literal">do.auth</code> plus specifying the adapter directly
in the model state with the <code class="literal">adapter</code> model state atttribute.
It is no longer necessary to define additional states <code class="literal">do.auth2</code> etc. nor to add mappings
to properties and dispatch configuration as described below.</p>
<p>Performs the additional, second authentication with the adapter type specified in the configuration property</p>
<pre class="screen">adapter.authentication2</pre>
<p>More such additional authentication steps could be added by copying the
corresponding mappings in the dispatch configuration:</p>
<pre class="programlisting">&lt;action path="/doauth" scope="request"
  parameter="adapter.authentication"
  name="loginForm" validate="true"
  input="jsp.login" type="....LoginAction"&gt;
&lt;/action&gt;

&lt;action path="/doauth2" scope="request"
  parameter="adapter.authentication2"
  name="loginForm" validate="true"
  input="jsp.login" type="....LoginAction"&gt;
&lt;/action&gt;

&lt;action path="/doauth3" scope="request"
  parameter="adapter.authentication3"
  name="loginForm" validate="true"
  input="jsp.login" type="....LoginAction"&gt;
&lt;/action&gt;</pre>
<p>This also requires a new entry in the "&lt;global-forwards&gt;"-section:</p>
<pre class="programlisting">&lt;forward name="do.auth" path="/doauth.do"/&gt;
&lt;forward name="do.auth2" path="/doauth2.do" /&gt;
&lt;forward name="do.auth3" path="/doauth3.do" /&gt;</pre>
<p>In the SLS configuration, the adapter type used for that additional authentication must then be defined accordingly:</p>
<pre class="programlisting">adapter.*authentication3*=radius</pre></td></tr><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>do.authorize</p></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>Optional HSP authorization step, which performs the authorization by invoking the corresponding back-end adapter function.</p>
<p>Note that for many adapters, such as LDAP, creating the authorization values can also be performed with just one single authentication call, based on the user's attributes, for example.</p></td></tr><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>do.authresponse</p></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>Verifies the response code entered by the user during a challenge / response process.</p></td></tr><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>do.auth.novalidate</p></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>Same as "do.auth", but does not perform any validation of the input parameters
(and therefore doesn't even require that there are any parameters in the request).
Used only for special cases of authentication (like Kerberos), where the credentials are not sent in request parameters.</p></td></tr><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>do.changepassword</p></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>Performs a password-change callout with the back-end system, if it supports the password change functionality.</p></td></tr><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>do.cert.auth</p></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>Authenticates the user based on the SSL client certificate if the PKI adapter is used.</p></td></tr><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>do.generic</p></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>Dummy action which does nothing by itself. It serves only as a point within the model to which to attach custom actions.</p></td></tr><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>do.hspparm</p></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>Checks if all information is available that is required to provide the information for the HSP for a dynamic application back-end connection (see <a class="link" href="#x10003_Heading1Tarsec_Parameter_Passing" title="Chapter 29. HSP Parameter Passing / Gateway">"HSP Parameter Passing"</a>).</p>
<p>If the check finds that something is missing, the model will be switched to the state "get.hspparm".</p></td></tr><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>do.http</p></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><p><span class="emphasis"><em>Only available with HTTP adapter!</em></span></p>
<p>Allows to execute one or several HTTP operations that must be configured in the HTTP configuration file (see <a class="link" href="#x12089_Heading1Tarsec_HTTP_Adapter" title="Chapter 48. HTTP Adapter">"HTTP Adapter"</a> for details).</p>
<p>This state always requires a "property" which contains a string identifier. This identifier points to the group of properties in the HTTP configuration which define the operation(s) to be performed.</p>
<pre class="programlisting">model.xyz.state.3.name=do.http
model.xyz.state.3.property=myoperation</pre></td></tr><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>do.ldap</p></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><p><span class="emphasis"><em>Only available with LDAP adapter!</em></span></p>
<p>Allows to execute one or several LDAP operations that must be configured in the LDAP configuration file (see <a class="link" href="#x51438_Heading1Tarsec_LDAP_Adapter" title="Chapter 50. LDAP Adapter">"LDAP Adapter"</a> for details).</p>
<p>This state always requires a "property" which contains a string identifier. This identifier points to the group of properties in the LDAP configuration which define the operation(s) to be performed.</p>
<pre class="programlisting">model.xyz.state.3.name=do.ldap
model.xyz.state.3.property=myoperation</pre></td></tr><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>do.logout</p></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>Performs a logout by invalidating the user's HSP session (sets a response header "<code class="literal">InvalidateAll</code>").</p>
<div class="note" style="margin-left: 0; margin-right: 10%;"><h3 class="title">Note</h3><p>This will NOT terminate the application session, so it is recommended to
perform the logout over the application if possible. Otherwise, lingering open
sessions could consume a lot of resources on the application server.</p></div>
<p>It is possible to specify the URL where the SLS will redirect the client to
after the logout by sending a URL parameter "target" in the logout request,
or by using the following model state parameter.</p>
<p><code class="literal">model.state.10.param.url=&lt;target URL&gt;</code></p>
<p>The "target" parameter will always override the model state "url" parameter.</p>
<div class="note" style="margin-left: 0; margin-right: 10%;"><h3 class="title">Note</h3><p>To allow redirects to other hosts use the following setting (else only the URL location is considered):</p></div>
<p><code class="literal">model.state.10.param.url.absolute.allow=true</code></p>
<div class="note" style="margin-left: 0; margin-right: 10%;"><h3 class="title">Note</h3><p>Also, the existing optional redirect blacklists or whitelists can be used
to restrict allowed redirect URLs.
See <a class="link" href="#x95875_Heading3Tarsec_Redirect_After_Successful_Login" title="11.3.2. Redirect After Successful Login">"Redirect After Successful Login"</a> for details.</p></div></td></tr><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>do.mapping</p></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>Optional mapping step, which performs the mapping by invoking the corresponding back-end adapter function.</p>
<p>Note that for many adapters, such as LDAP, a mapping of the user ID can also be performed with just one single authentication call, based on the user's attributes, for example.</p></td></tr><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>do.ntlmauth</p></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>Authenticates the user against a domain controller.</p></td></tr><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>do.ntlminit</p></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>Initiates an NTLM authentication handshake.</p></td></tr><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>do.ntlmwait</p></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>Sends information to the client during the multi-step NTLM authentication process, if necessary.</p></td></tr><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>do.reauth</p></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>Performs a re-authentication with the back-end system, using the one-time-password or secret code sent by the user in the "get.reauth" state.</p></td></tr><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>do.redirect</p></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>Redirects the client to the URL specified in the value defined in the additional "property"-field (or "param.url"):</p>
<pre class="programlisting">model.state.10.name=do.redirect
model.state.10.property=/some/app</pre>
<p>or</p>
<pre class="programlisting">model.state.10.name=do.redirect
model.state.10.param.url=/some/app</pre>
<div class="note" style="margin-left: 0; margin-right: 10%;"><h3 class="title">Note</h3><p>After a do.redirect state has been reached in the model, the redirect to the specified location will take place and there will be no next state executed.</p></div>
<div class="note" style="margin-left: 0; margin-right: 10%;"><h3 class="title">Note</h3><p>The SLS login session <span class="emphasis"><em>will be invalidated</em></span> by this model state <span class="emphasis"><em>by default</em></span>. This can be prevented by adding the following optional parameter:</p></div>
<pre class="programlisting">model.state.10.param.invalidate=false</pre>
<div class="note" style="margin-left: 0; margin-right: 10%;"><h3 class="title">Note</h3><p>To allow redirects to other hosts use the following setting (else only the URL location is considered):</p></div>
<pre class="programlisting">model.state.10.param.url.absolute.allow=true</pre>
<p>Also, actions attached to the do.redirect model state are only executed if the
SLS login session is not invalidated and only if/when a following request comes in.</p>
<div class="note" style="margin-left: 0; margin-right: 10%;"><h3 class="title">Note</h3><p>To enforce that the SLS will remain in the same redirect model state in
a case where, after a redirect to an external site, a redirect back to the SLS
is received, the following parameter can be set:</p></div>
<pre class="programlisting">model.state.10.param.goto.next.state=false</pre>
<p>The default value is <code class="literal">true</code>, which means that after the <code class="literal">do.redirect</code>, with the
next incoming request (if the session still exists), the model will be forwarded
to the next state, even for a GET request.</p></td></tr><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>do.saml.idp.
     create.assertion</p></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>Creates a SAML assertion using the configured SAML IdP adapter.</p>
<p>This state is optional. If omitted, the response SAML message will automatically be created by the model state(s) "<code class="literal">do.saml.idp.createmsg</code>" and / or "<code class="literal">do.saml.idp.sendmsg</code>".</p></td></tr><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>do.saml.idp.createmsg</p></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>Creates a SAML message using the configured SAML IdP adapter.</p>
<p>If the profile is SSO (default), a SAML Response message is created. (The profile SLO is not allowed.)</p>
<p>This state also allows to enforce the creation of a SAML error message, using additional parameters:</p>
<p><code class="literal">mainStatusCode</code> - The main status code (usually not necessary; there are only 4 supported values, and the SLS automatically sets the most appropriate one by default).</p>
<p><code class="literal">statusCode</code> - The actual SAML error code (URN), such as "urn:oasis:names:tc:SAML:2.0:status:VersionMismatch"</p>
<p><code class="literal">statusMessage</code> - Optional free-form text, which can be used by the receiving SP to be logged, in order to give some more information about the cause.</p>
<p>Example:</p>
<p><code class="literal">..name=do.saml.idp.sendmsg-customError</code></p>
<p><code class="literal">..param.statusCode=urn:…VersionMismatch</code></p>
<p><code class="literal">..param.statusMessage=User unknown</code></p>
<p>This state is optional. If omitted, the response SAML message will automatically be created by the model state "<code class="literal">do.saml.idp.sendmsg</code>".</p></td></tr><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>do.saml.idp.handlemsg</p></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>Handles an incoming SAML message using the configured SAML IdP adapter.</p>
<p>If the profile is SSO (default), a SAML AuthnRequest message is expected, if the profile is SLO, a SAML LogoutResponse message is expected.</p></td></tr><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>do.saml.idp.sendmsg</p></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>Sends a SAML message using the configured SAML IdP adapter. The profile defaults to "SSO", but can
be set to either <code class="literal">"SLO"</code> or <code class="literal">"SSO"</code> with the optional parameter <code class="literal">"profile"</code>, e.g.:</p>
<p>+..state.1000.param.profile=SSO</p>
<p>If the profile is SSO (default), a SAML Response message is sent, if the profile is SLO, a SAML LogoutRequest message is sent.</p>
<p>In case of the SSO profile, this state also allows to enforce the creation and sending of a SAML error message,
see model state "<code class="literal">do.saml.idp.createmsg</code>" for a description of the parameters.</p>
<div class="note" style="margin-left: 0; margin-right: 10%;"><h3 class="title">Note</h3><p>After this state has been executed, the next incoming request will forward the model to the next state, no matter if it is a GET or POST request.</p></div></td></tr><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>do.saml.sp.createmsg</p></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>Creates a SAML message using the configured SAML SP adapter.</p>
<p>If the profile is SSO (default), a SAML AuthnRequest message is created. (The profile SLO is not allowed.)</p>
<p>Allows to access the AuthnRequest (JEXL variable "<code class="literal">sp_auth_request</code>") before it's being sent to the IdP, to perform operations like adding  IdP-List entries etc.</p>
<p>This state is optional. If omitted, the response SAML message will automatically be created by the model state "<code class="literal">do.saml.sp.sendmsg</code>".</p></td></tr><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>do.saml.sp.handlemsg</p></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>Handles an incoming SAML message using the configured SAML SP adapter. The profile defaults to "SSO", but can
be set to either <code class="literal">"SLO"</code> or <code class="literal">"SSO"</code> with the optional parameter <code class="literal">"profile"</code>, e.g.:</p>
<p>+..state.1000.param.profile=SSO</p>
<p>If the profile is SSO (default), a SAML Response message is expected, if the profile is SLO, a SAML LogoutRequest message is expected.</p></td></tr><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>do.saml.sp.sendmsg</p></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>Sends a SAML message using the configured SAML SP adapter. The profile defaults to "SSO", but can
be set to either <code class="literal">"SLO"</code> or <code class="literal">"SSO"</code> with the optional parameter <code class="literal">"profile"</code>, e.g.:</p>
<p>+..state.1000.param.profile=SSO</p>
<p>If the profile is SSO (default), a SAML AuthnRequest message is sent, if the profile is SLO, a SAML LogoutResponse message is sent.</p>
<p>In case of the SLO profile, this state also allows to enforce the creation and sending of a SAML error message, see model state "<code class="literal">do.saml.idp.createmsg</code>" for a description of the parameters.</p>
<div class="note" style="margin-left: 0; margin-right: 10%;"><h3 class="title">Note</h3><p>After this state has been executed, the next incoming request will forward the model to the next state, no matter if it is a GET or POST request.</p></div></td></tr><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>do.oidc.op.handlemsg</p></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>Handles an incoming OIDC message using the configured OIDC OP adapter.</p>
<div class="note" style="margin-left: 0; margin-right: 10%;"><h3 class="title">Note</h3><p>By default, the SLS will run in OIDC mode. If simple OAuth 2.0 should be used,
the state parameter <code class="literal">".mode"</code> must be set to the value <code class="literal">"oauth"</code>:</p></div>
<p><code class="literal">..state.1000.param.mode=oauth</code></p>
<p>For more details on OAuth 2.0 mode, see <a class="link" href="#plain_oauth_mode" title="58.9. Plain OAuth 2.0 Mode">"Plain OAuth 2.0 Mode"</a>.</p>
<p><code class="literal">..state.1000.param.verifyRedirectUri=true|false</code></p>
<p>The state parameter <code class="literal">"verifyRedirectUri"</code> allows to enforce verification of the
request parameter <code class="literal">"redirect_uri"</code> against the configured redirect URIs of the RP.</p>
<p>In case of the Authentication request in an OpenID Connect flow, the verification
is always done, irrespective of this state parameter, because the check is mandatory
and there is no good alternative way to handle it in the login model instead.</p>
<p>In other cases, namely in OAuth Authorization requests and in Token requests
(both for OAuth and OpenID Connect flows), the state parameter can be explicitly
set to <code class="literal">"true"</code> to enforce verification. It defaults to <code class="literal">"false"</code> in these cases.</p>
<p><code class="literal">..state.1000.param.verifySecret=true|false</code></p>
<p>The state parameter <code class="literal">"verifySecret"</code> allows to disable any verification of the client
secret (usually only for test purposes) by setting it to <code class="literal">"false"</code>.
It defaults to <code class="literal">"true"</code>.</p>
<p><code class="literal">..state.1000.param.clientIdSource=${header.client_id}</code></p>
<p>The state parameter <code class="literal">"clientIdSource"</code> allows to define a custom source for the
value of the <code class="literal">"client_id"</code> attribute of the current request. This parameter will
usually use some kind of scripting expression to dynamically provide a value for
the <code class="literal">client_id</code>. If this parameter is set, the usual request parameters or basic
auth headers are ignored completely. So, this parameter effectively overrides
whatever value is in the request parameter or authorization header.</p></td></tr><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>do.oidc.op.createmsg</p></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>Creates a response OIDC message using the configured OIDC OP adapter.</p>
<p>This state is optional. If omitted, the response OIDC message will automatically be created by the model state "do.oidc.op.sendmsg".</p></td></tr><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>do.oidc.op.sendmsg</p></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>Sends a response OIDC message using the configured OIDC OP adapter.</p></td></tr><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>do.oidc.rp.createmsg</p></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>Creates an OIDC request message.</p>
<p>The optional parameter <code class="literal">mode</code> defaults to <code class="literal">oidc</code>, which is so far also the
only allowed mode (as the RP does so far not support plain OAuth 2.0).</p>
<p>The optional parameter <code class="literal">request</code> defines the type of request to create;
allowed values are <code class="literal">authentication</code> and <code class="literal">token</code> for the corresponding requests;
default is <code class="literal">authentication</code>.</p>
<p>The parameter <code class="literal">alias</code> defines the alias of the client/OP pairing.
It is mandatory in the first <code class="literal">do.oidc.rp.createmsg</code> action
(normally the Authentication Request), and optional afterwards
in the same SLS login session.</p></td></tr><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>do.oidc.rp.sendmsg</p></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>Sends a previously created OIDC request message.</p>
<p>Note that unlike in other adapters, it is mandatory to explicitly create
a message before sending it.</p>
<p>There are no parameters, uses the ones defined previously when the message
was created.</p>
<p>The Authentication Request is sent with a 302 Redirect, while the Token
Request is sent with a direct HTTP callout to the respective OP.</p></td></tr><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>do.oidc.rp.handlemsg</p></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>Validates a received OIDC response message.</p>
<p>There are no parameters, uses the ones defined previously when the request
message was created.</p>
<p>In case of a received Token Response if validation is successful, a verified
username credential is created with the subject from the received id_token
as the username.</p></td></tr><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>do.webauthn.createmsg</p></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>Creates a WebAuthn message.</p>
<p>The mandatory parameter <code class="literal">flow</code> indicates the flow; it can have the values
<code class="literal">registration</code> and <code class="literal">authentication</code>.</p>
<p>Normally afterwards sent with the actions <code class="literal">get.webauthn.reg.sendmsg</code>
resp. <code class="literal">get.webauthn.auth.sendmsg</code>.</p></td></tr><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>do.webauthn.handlemsg</p></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>Validates a WebAuthn response message.</p></td></tr><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>do.sendmail</p></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>Sends an e-mail (see <a class="link" href="#x33260_Heading1Tarsec_Sending_eMail" title="Chapter 17. Sending E-Mail">"Sending E-Mail"</a> for details).</p></td></tr><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>do.spnegoinit</p></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>Initiates an SPNEGO- (aka Kerberos) based authentication.</p></td></tr><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>do.success</p></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>Performs the steps required to complete a successful authentication.
This action creates all headers required to signal a successful authentication to
the reverse proxy, create custom SES session attributes, forward custom HTTP
headers to the application, create tickets etc.</p>
<p>A simple way to "extend" this action with custom functionality is to add a
"do.generic"-state right before this state, and attach some JEXL-actions to
it (see <a class="link" href="#x47278_Heading3Tarsec_Custom_Actions" title="7.6.1. Custom Actions">"Custom Actions"</a>).</p>
<div class="note" style="margin-left: 0; margin-right: 10%;"><h3 class="title">Note</h3><p>This action performs the redirect to the application and terminates the
SLS session, so processing ends here (also see
<a class="xref" href="#x37214_Heading3Tarsec_do_success_must_be_last" title="7.3.2. &quot;do.success&quot; / &quot;do.success.jsp&quot; must be last">Section 7.3.2, “"do.success" / "do.success.jsp" must be last”</a> for details).</p></div>
<p>Optionally, the state property / parameter "<code class="literal">credentials</code>" can be used to
define a comma-separated list of credential types that should be validated. For
example, to ensure that a <code class="literal">"challenge"</code> credential had been verified too, in
addition to the username and password, the model state would look like this:</p>
<p><code class="literal">..state.name=do.success</code></p>
<p><code class="literal">..state.param.credentials=username,password,challenge</code></p></td></tr><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>do.success.jsp</p></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>Is equal to <code class="literal">do.success</code>, except that this state does not perform
a redirect after the login, but instead shows a JSP, like the <code class="literal">show.jsp</code> state.
It will invalidate the SLS session by default. If the session should be kept
alive (because the JSP needs information from it), the state parameter "<code class="literal">invalidate</code>"
can be set to "<code class="literal">false</code>":</p>
<p><code class="literal">..state.param.invalidate=false</code></p>
<p>As with "<code class="literal">do.success</code>", the list of required credentials can be specified with
the same state parameter, "<code class="literal">credentials</code>":</p>
<p><code class="literal">..state.param.credentials=username,password,challenge</code></p></td></tr><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>do.trxcancel</p></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>Handles a "cancel"-request of the user during the transaction verification process, by redirecting the client back to the application.</p></td></tr><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>do.trxinit</p></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>Must be at the beginning of the model for the transaction verification process. This action extracts the transaction data from the incoming request and stores it in the SLS session for later verification.</p></td></tr><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>do.trxresponse</p></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>Verifies if the response provided by the user during the transaction verification process is correct, by invoking the corresponding functionality of the back-end adapter.</p></td></tr><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>do.wait</p></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>Either displays the "jsp.wait" page, or forwards to the next action if the wait-page has already been delivered to the client.</p></td></tr><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>do.validatepassword</p></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>Validates one or multiple password credentials using the password policy. By default, the action will validate the NEWPASSWORD-type credential.</p>
<p>It will also compare the values of the credentials NEWPASSWORD and  NEWPASSWORD2, if (and only if) both are available. In that case, both must have the same value.</p>
<p>Optionally, the the state property / parameter "<code class="literal">credentials</code>" can be used to define a comma-separated list of credential types that should be validated. For example, to validate the login password in an authentication process, the model state would look like this:</p>
<p><code class="literal">..state.name=do.validatepassword</code></p>
<p><code class="literal">..state.property=password</code></p>
<p>But to validate the passwords in a password change process, the model state would look like this:</p>
<p><code class="literal">..state.name=do.validatepassword</code></p>
<p><code class="literal">..state.property=newpassword,newpassword2</code></p></td></tr><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>get.passwordpolicy</p></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>Retrieves the policy for passwords (needed for the password change process, for example) from the authentication back-end system, or from the local password policy configuration.</p></td></tr><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>select.token</p></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>Sets the token selected by the user in the "<code class="literal">get.token</code>" state in the SLS session.</p></td></tr><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>show.json</p></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>Sends a plain JSON  response back to the client.</p>
<p>This state supports the following parameters:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">json</code> - the actual JSON content (inline)
</li><li class="listitem">
<code class="literal">jsonFile</code> - a relative file path within the SLS webapp, of a JSON file
</li><li class="listitem">
<code class="literal">contentType</code> - for overriding the content-type header (defaults to "application/json")
</li><li class="listitem">
<code class="literal">statusCode</code> - for overriding the HTTP status code (defaults to 200)
</li><li class="listitem">
<code class="literal">invalidate</code> - allows to immediately terminate the SLS session if set to "<code class="literal">true</code>"
</li></ul></div>
<p>The resulting JSON content is always evaluated by the scripting engine, so any JEXL or
Groovy expressions, function calls etc. inside it will be resolved in the final response.</p>
<p>The <span class="emphasis"><em>jsonFile</em></span> parameter must be a valid relative file path within the
SLS web application, e.g. <code class="literal">WEB-INF/json/someResponse.json</code>.</p>
<pre class="programlisting">model.example.state.1.name=show.json
# 1st Example: Define relative file path
model.example.state.1.param.jsonFile=/WEB-INF/json/SomeResponse.json
# Set custom HTTP response code
model.example.state.1.param.statusCode=277</pre>
<pre class="programlisting">model.example.state.1.name=show.json
# 2nd Example: Define inline JSON
model.example.state.1.param.json={ "content": { "say": "hello" }}
# And invalidate session right here
model.example.state.1.param.invalidate=true</pre>
<pre class="programlisting">model.example.state.1.name=show.json
# 3rd Example: Define inline JSON, but get content from a template file
model.example.state.1.param.json=#{function.getTemplateContent('jsonResponse')}
# also set custom content-type
model.example.state.1.param.contentType=text/json</pre></td></tr><tr><td style="border-right: 1px solid #527bbd; " align="left" valign="top"><p>show.jsp</p></td><td style="" align="left" valign="top"><p>Displays any JSP of the SLS, independent of any actual login process.
Requires either the URL-parameter "<code class="literal">jsp</code>" or the state property / parameter
"<code class="literal">jsp</code>" to contain the name of the JSP to display.</p>
<p>The <span class="emphasis"><em>JSP name</em></span> must be either the resource key of the JSP in the message
resource file, such as "<code class="literal">jsp.login</code>", or a valid relative file path within the
SLS web application.</p>
<p>Alternatively, it is possible to use the URL parameter <code class="literal">displayjsp</code>, which
directly invoked this state, without the need of a model in the session.
See <a class="link" href="#x112233_Heading1Tarsec_Display_Single_JSP_Command" title="6.3. &quot;displayjsp&quot; - Display JSP Command">"Display Single JSP Command"</a> for details.</p>
<pre class="programlisting">model.example.state.1.name=show.jsp
# 1st Example: Define relative file path
model.example.state.1.param.jsp=/WEB-INF/jsp/My.jsp</pre>
<pre class="programlisting">model.example.state.1.name=show.jsp
# 2nd Example: Define file with resource key
model.example.state.1.param.jsp=jsp.login</pre></td></tr></tbody></table></div></div><br class="table-break" /></div></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="x38692_Heading1Tarsec_Credential_Providers"></a>Chapter 8. Credential Providers</h2></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_overview_5"></a>8.1. Overview</h2></div></div></div><p>In order to support any possible authentication scheme, the SLS implements an internal abstraction and separation of authentication credentials and so-called "providers" of such credentials. One default provider creates credentials from HTTP request parameters and / or headers.</p><p>Internally, the SLS assigns a technical and a semantic type to each credential. The technical type is defined by the type of credential provider, the semantic type of each credential must be configured as explained below.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="x16078_Heading2Tarsec_Configuration"></a>8.2. Configuration</h2></div></div></div><p>To define how to create the authentication credentials, a number of  properties must be set in the configuration file "<code class="literal">sls.properties</code>". Each credential requires a group of properties like this example, which configures how to obtain the username (login ID) credential:</p><pre class="programlisting">cred.provider.&lt;pn&gt;.cred.&lt;cn&gt;.type=username
cred.provider.&lt;pn&gt;.cred.&lt;cn&gt;.source=parameter
cred.provider.&lt;pn&gt;.cred.&lt;cn&gt;.name=userid</pre><p>Where <code class="literal"><span class="emphasis"><em>&lt;pn&gt;</em></span></code> means "provider number" and is used to group a set of properties for one credential provider together. <code class="literal"><span class="emphasis"><em>&lt;cn&gt;</em></span></code> means "credential number and is used to define 1 - n credentials for the given provider.</p><p>As shown in this example, each credential requires three attributes: ".<code class="literal">type</code>", "<code class="literal">.source</code>" and "<code class="literal">.name</code>":</p><p><span class="strong"><strong><code class="literal">type</code></strong></span></p><p>Defines the semantic type, so this field must contain one of the predefined values as listed in <a class="link" href="#x99987_Heading2Tarsec_Semantic_Types" title="8.4. Semantic Types">"Semantic Types"</a>.</p><p><span class="strong"><strong><code class="literal">source</code></strong></span></p><p>Defines where to the credential is taken / extracted from. The possible values of this attribute depend on the corresponding credential provider. In case of the HTTP credential provider (see below), the possible values are "parameter", "header" or "cookie" (meaning that the value of the credential will be the value of a request parameter, header or cookie).</p><p><span class="strong"><strong><code class="literal">name</code></strong></span></p><p>Defines the name of the source, like the name of the request parameter, header or cookie from which to take the value.</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_example"></a>8.2.1. Example</h3></div></div></div><p>A real-world example for the default JSP login forms provided with the SLS delivery package would look like this:</p><div class="table"><a id="idm2590"></a><p class="title"><strong>Table 8.1. Sample credential provider configuration</strong></p><div class="table-contents"><table class="table" summary="Sample credential provider configuration" cellpadding="4px" style="border-collapse: collapse;border-top: 3px solid #527bbd; border-bottom: 3px solid #527bbd; border-left: 3px solid #527bbd; border-right: 3px solid #527bbd; "><colgroup><col class="col_1" /></colgroup><thead><tr><th style="border-bottom: 1px solid #527bbd; " align="left" valign="top">[source,properties]
----
# Use "HTTP" credential provider as provider no. 1
cred.provider.1=http

# Credential from request parameter "userid"
cred.provider.1.cred.1.type=username
cred.provider.1.cred.1.source=parameter
cred.provider.1.cred.1.name=userid

# Credential from request parameter "password"
cred.provider.1.cred.2.type=password
cred.provider.1.cred.2.source=parameter
cred.provider.1.cred.2.name=password
----</th></tr></thead><tbody></tbody></table></div></div><br class="table-break" /><p>In this example, the request parameter "<code class="literal">userid</code>" (which is defined by the name "userid" of the corresponding HTML form field in the login JSP) is used as a credential of the semantic type "<span class="emphasis"><em>username</em></span>". And the request parameter "<code class="literal">password</code>" is used for a credential of the semantic type "<span class="emphasis"><em>password</em></span>".</p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_providers"></a>8.3. Providers</h2></div></div></div><p>The following credential provider values are available:</p><p><span class="strong"><strong><code class="literal">http</code></strong></span></p><p>Provides credentials from HTTP request parameters and / or headers.</p><p><span class="strong"><strong><code class="literal">basicauth</code></strong></span></p><p>Provides credentials from a HTTP basic authentication header.</p><p><span class="strong"><strong><code class="literal">sesticket</code></strong></span></p><p>Provides credentials from an SES ticket..</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_jexl_credential_provider"></a>8.3.1. JEXL Credential Provider</h3></div></div></div><p>As a special case, there is also a JEXL credential provider available. This provider is always active, so it is not necessary to configure just to activate it. It is also always the last one in the list, so it will always override the credentials of the other providers. But this also means that it can be used to "post-process" credentials created by other providers through JEXL.</p><p>Because the JEXL provider does not have a number, but an internal ID "<code class="literal">jexl</code>", the configuration properties used to configure credentials handled by it must always have the prefix</p><pre class="screen">cred.provider.jexl.cred.</pre><p>The following example shows how to add a prefix to the value of the username credential created by the "<code class="literal">http</code>" provider:</p><pre class="programlisting">cred.provider.jexl.cred.1.type=username
cred.provider.jexl.cred.1.source=${'acme:' + session.getCred('username')}
cred.provider.jexl.cred.1.name=undefined</pre><p><span class="emphasis"><em>Note: Due to internal dependencies, the property ".name" must be set with some value, altough it is really ignored by the JEXL credential provider. But not setting it will result in a configuration error.</em></span></p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="x99987_Heading2Tarsec_Semantic_Types"></a>8.4. Semantic Types</h2></div></div></div><p>Each authentication credential has a unique semantic type. The following credential types are available, as explained in chapter :</p><p><span class="strong"><strong><code class="literal">username</code></strong></span></p><p>Credential that represents the username / login ID.</p><p><span class="strong"><strong><code class="literal">password</code></strong></span></p><p>Credential that represents the login password.</p><p><span class="strong"><strong><code class="literal">newpassword
newpassword2</code></strong></span></p><p>Credentials that represent the two values for a new password, entered in a password-change form.</p><p><span class="strong"><strong><code class="literal">secret</code></strong></span></p><p>A third login credential, such as a token code or strike list number.</p><p><span class="strong"><strong><code class="literal">challenge</code></strong></span></p><p>A challenge value, such as an SMS- or token-code, entered for a challenge-/response authentication scheme.</p><p><span class="strong"><strong><code class="literal">mappedid</code></strong></span></p><p>An alternative user ID which is the result of some mapping process. Some authentication adapters may create such a credential in the login process depending on their own configuration.</p><p><span class="strong"><strong><code class="literal">tokenselection</code></strong></span></p><p>Contains the alias of the selected token (meaning a hardware token, such as a SecurID or Vasco USB token). This credential is required if the "create.tokens" state in a model resulted in a list of more than 1 authentication tokens available to the user for the login process. In that case, the user must select which token to use for the authentication step, and the selection form will post a parameter which contains the alias of the selected token.</p><p><span class="strong"><strong><code class="literal">certificate</code></strong></span></p><p>An X509 certificate (usually created by the PKI adapter).</p><p><span class="strong"><strong><code class="literal">sesticket</code></strong></span></p><p>Contains an SES ticket (see <a class="link" href="#x66021_Heading1Tarsec_SES_Login_Ticket" title="Chapter 30. SES Login Ticket">"SES Login Ticket"</a> for details).</p><p><span class="strong"><strong><code class="literal">string</code></strong></span></p><p>A generic, additional string credential. For example, if a custom / legacy back-end authentication system requires an additional credential such as the IP-address of the reverse proxy server used to connect, this could be used to define this credential and where to take it from. It is up to the authentication adapter and its configuration then how to deal with such generic credentials.</p><p>Internally, there are even more credential types, such as a "mapped ID". But these are created automatically by the authentication adapter during the login process, depending on the adapter's capabilities and the configuration. Consult the documentation of the authentication adapter for details.</p></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="title2_Challenge_Response"></a>Chapter 9. Challenge / Response</h2></div></div></div><p>As mentioned before, the SLS supports challenge / response authentication procedures. There is quite a wide variety of authentication schemes available that use some form of challenge / response flow, for example:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
Google Authenticator
</li><li class="listitem">
NTLM (transparent for the user)
</li><li class="listitem">
RADIUS
</li><li class="listitem">
SMS
</li></ul></div><p>While the first three examples are tightly coupled to their respective authentication adapter, the third one is more generic. For example:</p><p><span class="strong"><strong><span class="emphasis"><em>NTLM</em></span></strong></span></p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
If NTLM authentication is used, the NTLM adapter must also be configured as "challenge" adapter (not only authentication). It will then perform a challenge / response handshake with the client webbrowser, completely transparent for the user.
</li></ul></div><p><span class="strong"><strong><span class="emphasis"><em>RADIUS</em></span></strong></span></p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
With RADIUS challenge / response, it's basically the same as with NTLM (the RADIUS adapter is responsible for all steps), but the user has to perform the challenge-/response step manually.
</li></ul></div><p><span class="strong"><strong><span class="emphasis"><em>Generic (SMS)</em></span></strong></span></p><p>But there is also a more generic adapter available in the SLS. This adapter simply generates a random number or string and makes it available as a JEXL variable. It is then possible to use, for example, the HTTP adapter to perform a HTTP request to the SMS Sender Web-Interface of a mobile provider, and post the challenge code there so that it is sent to the user by SMS. The same generic random challenge generator adapter will then verify the response entered by the user in the SLS HTML form.</p><p>The following chapter will explain how to set up challenge / response authentication with SMS by means of a HTTP-interface of some mobile provider (to actually send out the SMS with the response code).</p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_challenge_response_adapter_configuration"></a>9.1. Challenge / Response Adapter Configuration</h2></div></div></div><p>First, the type of the adapter used for challenge creation and response verification must be defined by setting the property</p><p><code class="literal">adapter.challenge=<span class="emphasis"><em>&lt;type&gt;</em></span></code></p><p>The following types are supported:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">basechallenge</code> - The generic generator for challenge strings or numbers that can be used in an SMS login process, for example.
</li><li class="listitem">
<code class="literal">ntlm</code> - For handling the NTLM challenge and response exchanged between the browser client and the domain controller in an NTLM login flow.
</li><li class="listitem">
<code class="literal">file</code> - Providing a hard-configured challenge and response from the "<code class="literal">user-config.xml</code>" file, useful for local testing purposes.
</li></ul></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_base_challenge_adapter"></a>9.1.1. Base Challenge Adapter</h3></div></div></div><p>The "<code class="literal">basechallenge</code>" adapter creates either a 6-digit number or a text string.
The following properties can be set in "sls.properties" to configure the base
challenges:</p><p><span class="strong"><strong><code class="literal">adapter.challenge</code></strong></span></p><p>Set to "<code class="literal">basechallenge</code>" to activate using the internal base challenge / response adapter.</p><p><span class="strong"><strong><code class="literal">challenge.type</code></strong></span></p><p><span class="emphasis"><em>Optional</em></span>: Set to "<code class="literal">numeric</code>" to create a number, by default with 6 digits, or
to "<code class="literal">string</code>" to create a random alphanumeric string, by default with 40 characters.
Defaults to "<code class="literal">numeric</code>" if not set.</p><p><span class="strong"><strong><code class="literal">challenge.lifespan</code></strong></span></p><p><span class="emphasis"><em>Optional</em></span>: Allows to define the lifespan (validity period) of the response, in
number of seconds. Defaults to 1800 (generous 30 minutes) if not set.</p><p><span class="strong"><strong><code class="literal">challenge.characters</code></strong></span></p><p><span class="emphasis"><em>Optional</em></span>: Allows to define the list of characters to be used in the generated
challenges; this should usually be alphanumeric ASCII characters. Defaults to:</p><pre class="screen">ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz23456789</pre><p><span class="emphasis"><em>NOTE: The default characters intentionally avoid using any characters that are
easily confused, such as one ("1") and lower-case L ("l"), or zero ("0") and "O".
Consider this issue when configuring a custom set of characters.</em></span></p><p><span class="strong"><strong><code class="literal">challenge.length</code></strong></span></p><p><span class="emphasis"><em>Optional</em></span>: Allows to define the length of the generated challenge. For numeric
challenges, the default is 6 characters, for strings it is 40 characters.</p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_sms_challenge_response_with_http_adapter"></a>9.2. SMS Challenge / Response with HTTP adapter</h2></div></div></div><p>This chapter serves as a simplified "how-to" for the implementation of a challenge- / response authentication process with SMS. Assumptions / prerequisites (for the sake of this example):</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
The internal, generic challenge-response adapter is used to generate the challenge and verify the response.
</li><li class="listitem">
The LDAP adapter is used to verify the password.
</li><li class="listitem">
In order to send an SMS, the mobile phone number of the user must be available. This example assumes that it can be read from an LDAP attribute of the user. Since the LDAP adapter is used to verify the password, the attribute is available as a JEXL variable after the authentication step.
</li><li class="listitem">
The HTTP adapter is used to send the response code to the user, by performing a HTTP POST call to the HTTP-interface of some mobile phone provider.
</li></ul></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_step_1_configure_challenge_response_adapter"></a>9.2.1. Step 1: Configure challenge- / response adapter</h3></div></div></div><p>The generic challenge-/response adapter is referred to by the alias "<code class="literal">basechallenge</code>":</p><p><span class="strong"><strong>sls.properties</strong></span></p><pre class="programlisting">adapter.challenge=basechallenge</pre><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="_optional_define_type_of_response_code"></a>Optional: Define type of response code</h4></div></div></div><p>The base challenge / response adapter generates a six-digit number by default
(which is usually appropriate for SMS login procedures). If for any reason a
longer, alphanumeric string should be created, the following property can be set:</p><pre class="programlisting">challenge.type=string</pre><p>This will result in an alphanumeric response code string.</p></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_step_2_configure_ldap_authentication"></a>9.2.2. Step 2: Configure LDAP authentication</h3></div></div></div><p><span class="strong"><strong>sls.properties</strong></span></p><pre class="programlisting">adapter.authentication=ldap</pre><p><span class="strong"><strong>ldap-adapter.properties</strong></span></p><pre class="programlisting">ldap.url=ldap://ldap.acme.com:389
ldap.principal.default=cn=Manager,dc=acme,dc=com
ldap.password.default=humptydumpty
ldap.auth.type=bind
ldap.auth.bind.dn.1=cn=${session.getCred('USERNAME')}, org=usa,dc=acme,dc=com</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_step_3_configure_sending_response_code_with_http"></a>9.2.3. Step 3: Configure sending response code with HTTP</h3></div></div></div><p>Define a group of HTTP adapter properties with the group alias "<span class="emphasis"><em>sendsms</em></span>" (which will be used in the model to refer to these properties). This example assumes that the HTTP interface of the mobile phone provider takes four POST parameters:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">customer</code> - The company sending the SMS (the ficticious "acme.com"), which is a customer of the mobile provider.
</li><li class="listitem">
<code class="literal">password</code> - The password required by "acme.com" to send an SMS
</li><li class="listitem">
<code class="literal">number</code> - The mobile phone number of the receiver of the SMS (the end-user currently being authenticated by "acme.com")
</li><li class="listitem">
<code class="literal">text</code> - The message text of the SMS.
</li></ul></div><p><span class="strong"><strong>http-adapter.properties</strong></span></p><pre class="programlisting"># The url of the sms provider.
http.sendsms.url=http://global.phone.com/sendsms

# The HTTP method.
http.sendsms.method=post

# HTTP Header properties
http.sendsms.header.Content-Type=text/xml

# The body of the HTTP request. The challenge is stored
# in the JEXL variable "challenge", and the mobile phone
# number in the variable "attribute.ldap.phone".
http.sendsms.body=customer=acme&amp;password=secu8932&amp;number=${attribute.ldap.phone}&amp;text=code:${challenge}

# Error codes
http.sendsms.code.error=500,503

# Deny codes
http.sendsms.code.denied=401,403</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_how_to_send_an_xml_request"></a>9.2.4. How to send an XML request</h3></div></div></div><p>If the SMS provider CGI interface requires to post an XML structure, the JEXL templating mechanism can be used. See <a class="link" href="#x12304_Heading3Tarsec_Templates" title="32.8.2. Templates">"Templates"</a> for details on how to define and use templates.</p><p>Once a template is defined, insert it into the body of the HTTP POST request:</p><pre class="programlisting">http.sendsms.body=${function.getTemplateContent('msg')}</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_step_4_challenge_response_login_model"></a>9.2.5. Step 4: Challenge / Response Login Model</h3></div></div></div><p>The following model puts everything together:</p><p><span class="strong"><strong>sls.properties</strong></span></p><pre class="programlisting">model.login.uri=/auth
model.login.failedState=get.cred

# Show login page
model.login.state.1.name=get.cred

# Perform authentication (password check with LDAP)
model.login.state.2.name=do.auth

# Create challenge
model.login.state.3.name=create.challenge

# Use HTTP adapter to send response code with SMS
model.login.state.4.name=do.http
model.login.state.4.property=sendsms

# Display response code page
model.login.state.5.name=get.cred.challenge

# Verify response code
model.login.state.6.name=do.authresponse
model.login.state.6.failedstate=get.cred.challenge

# Authentication completed.
model.login.state.10.name=do.success</pre></div></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="x84028_Heading1Tarsec_Session_Handling"></a>Chapter 10. Session Handling</h2></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_introduction_2"></a>10.1. Introduction</h2></div></div></div><p>The SLS implements a custom session handling mechanism. This allows the SLS web application to gain full control over the login sessions without any dependencies to the servlet container within which it is running. The SLS sessions are also tightly coupled to the "client correlator" ID created by the HSP proxy, in that the value of the HTTP header "ClientCorrelator" is used as the session ID.</p><p>The SLS also handles session expiration and clean-up by itself. This also allows to avoid any potential problems that might be related to the session handling implementation of the servlet container.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_configuration"></a>10.2. Configuration</h2></div></div></div><p><span class="strong"><strong><code class="literal">session.inactivity.timeout</code></strong></span></p><p>This property in the "<code class="literal">sls.properties</code>"-file defines the inactivity period in seconds after which the SLS session expires. Defaults to 300 (5 minutes) if not set.</p><p>Please note that SLS sessions have no direct relation to application or HSP sessions. While application and HSP sessions usually require longer timeout settings, login sessions are by definition very short-lived; hence, the inactivity timeout should always be small.</p><p><span class="strong"><strong><code class="literal">session.final.timeout.minutes</code></strong></span></p><p>This property in the "<code class="literal">sls.properties</code>"-file defines the final timeout duration in minutes after which the SLS session
is terminated and removed under all circumstances. Defaults to 60 (1 hour) if not set. Supported values are:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
number of minutes larger than zero - sets final timeout duration to the given number of minutes
</li><li class="listitem">
zero - completely disables the final timeout - <span class="emphasis"><em>only use if necessary!</em></span>
</li><li class="listitem">
Not set the property at all - sets final timeout duration to 60 minutes.
</li></ul></div><p><span class="strong"><strong><code class="literal">session.cleanup.period</code></strong></span></p><p>This property in the "<code class="literal">sls.properties</code>"-file defines the interval in seconds for the session clean-up thread. This is somewhat similar to the Java garbagge collector settings, because defining a higher interval means quicker clean-up of expired sessions (freeing up memory), but also interfering with ongoing logins more often. This is due to the fact that the clean-up process needs to lock the internal session table while removing expired session from it.</p><p>Defaults to  30 seconds if not specified.</p><p><span class="strong"><strong>IMPORTANT NOTES ABOUT TIMEOUTS</strong></span></p><p><span class="emphasis"><em>All timeouts are in general enforced by the same one thread, which runs in the interval defined by <code class="literal">session.cleanup.period</code>.
Therefore, if the final timeout is set to 1 hour, and the clean-up interval to 5 minutes, it is possible that the final
timeout will indeed be actually enforced after 1 hour + 5 minutes - this may depend a little on at what point in time exactly
the session was created (relative to the clean-up interval).</em></span></p><p><span class="emphasis"><em>Secondly, once the number of open sessions exceeds 500 (this is currently not configurable), the SLS will start enforcing
the session timeout checks on every request, independent from the clean-up thread. This is meant to help avoid a situation
where a sudden spike of new sessions within the clean-up interval would cause memory problems because it takes too long
until they are removed again.</em></span></p><p><span class="strong"><strong><code class="literal">session.enable.cookie</code></strong></span></p><p>This property, if set to "<code class="literal">true</code>" in the "<code class="literal">sls.properties</code>"-file, activates a persistent cookie named "<code class="literal">SLSsecrnd</code>". The purpose of this cookie (the value of which is not security-relevant) is to help the SLS to recognize if requests with different client-correlator values are really coming from the same client. This is a concurrency issue that can pop up with multi-tab support of todays web-browsers (see <a class="link" href="#x67409_Heading1Tarsec_Concurrency_Issues_with_Browser_Tabs" title="Chapter 13. Concurrency Issues with Browser Tabs">"Concurrency Issues with Browser Tabs"</a> for details).</p><p>Note: The cookie "<code class="literal">SLSsecrnd</code>" must be configured to be transparent in the SRM configuration ("<code class="literal">AC_GlobalCookies</code>") as well!</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_avoiding_container_sessions"></a>10.3. Avoiding Container Sessions</h2></div></div></div><p>As explained in <a class="link" href="#x81027_Heading1Tarsec_Overview" title="1.4. Features">"Features"</a>, the SLS avoids the usage of servlet container sessions.</p><p>Therefore, it is important not to create container sessions inadvertently by adding custom session-related configuration entries in the "web.xml" file or with invalid JSP files. Each JSP file must contain - just as the provided sample files - a directive which declares that no session is to be created:</p><p><code class="literal">&lt;%@ page session="false" %&gt;</code></p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="x84418_Heading2Tarsec_DEBUG_TRACE_Logging"></a>10.4. DEBUG / TRACE Logging</h2></div></div></div><p>It is possible to enable DEBUG or TRACE logging for a single session based on the user login ID, through the following two dynamic configuration properties (in the file "<code class="literal">sls-dynamic.properties</code>"):</p><p><span class="strong"><strong><code class="literal">log.debug.enable</code></strong></span></p><p><span class="emphasis"><em>Optional:</em></span> Contains a comma-separated list of login IDs. If the user sends a login ID that is in this list, the session of that user will be switched to <code class="literal">DEBUG</code> log level.</p><p>Example definitions:</p><pre class="programlisting">log.debug.enable=billmiller,johndoe,clarkgable</pre><p><span class="strong"><strong><code class="literal">log.trace.enable</code></strong></span></p><p><span class="emphasis"><em>Optional:</em></span> Contains a comma-separated list of login IDs. If the user sends a login ID that is in this list, the session of that user will be switched to <code class="literal">TRACE</code> log level (which includes <code class="literal">DEBUG</code>).</p><p>Example definitions:</p><pre class="programlisting">log.trace.enable=billmiller,johndoe,clarkgable</pre><p><span class="emphasis"><em>Hint</em></span>: In order to enable DEBUG or TRACE logging for such a user before an actual authentication attempt is made, the user may just fill in only the username into the login page and post it. Since no password is given, the SLS will not even try to authenticate the user. But because the username credential has already been received, DEBUG or TRACE logging will be active in the session of that user from that moment on, until the session ends or expires.</p><p>It is also possible to enable DEBUG or TRACE logging dynamically based on
arbitrary conditions by calling the script functions
<code class="literal">session.activateDebugLog(boolean activate) resp.
`session.activateTraceLog(boolean activate)</code>.</p></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="x10002_Heading1Tarsec_Redirecting"></a>Chapter 11. Redirecting</h2></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_after_login_logout"></a>11.1. After Login / Logout</h2></div></div></div><p>After a successful login, the client browser must usually be redirected to an application page. Usually, a browser client tries to access some application URL first and gets redirected to the login service by the HSP.  When the redirected request is sent to the SLS, the HSP inserts meta-information about the originally requested URL. The SLS extracts that information and will automatically redirect the browser back to that URL after a successful login.</p><p>However, it is also possible that the browser client accessed the SLS directly, for example because a user bookmarked the login page. In such a case, it depends on the configuration in "<code class="literal">sls.properties</code>" to what URL the client will be redirected after a successful login.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_url_parameter_target"></a>11.2. URL parameter "target"</h2></div></div></div><p>The URL parameter "target", if available in the URI of the current request that
was sent to the SLS, will always override the current requested page. So if for
any reason a redirect to a certain location should be enforced in some cases,
it is possible to prepare links pointing to the SLS, and then defining the
final redirection URI in the "target" parameter, e.g.</p><pre class="screen">&lt;a href="/sls?target=/myapp"&gt;SLS link&lt;/a&gt;</pre><p>This parameter can be especially useful for the logout flow, where it can be
used to trigger the logout model and then enforce a redirect to a special
page.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_configuration_properties"></a>11.3. Configuration Properties</h2></div></div></div><p>The following properties in "sls.properties" are used to define how to handle
redirects.</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_redirect_after_every_post"></a>11.3.1. Redirect after every POST</h3></div></div></div><p>Background: If a user enters data into a HTML form and posts it, current
browsers will cache the form data if the response to the request was a HTTP 200
- but not when it's a redirect (HTTP 302). In environments where computers are
potentially shared by multiple users, one user could perform a complete login,
and another malicious user could then later "replay" that login by pressing the
"back" button of the Browser in order to have it post the same form data again.</p><p><span class="strong"><strong><code class="literal">selfredirect.enable</code></strong></span></p><p><span class="emphasis"><em>Optional:</em></span> If set to "<code class="literal">true</code>" the SLS will perform a redirect to itself after
every POST request, in order to eliminate that problem. Defaults to "<code class="literal">false</code>"
for reasons of backward compatibility.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="x95875_Heading3Tarsec_Redirect_After_Successful_Login"></a>11.3.2. Redirect After Successful Login</h3></div></div></div><p><span class="strong"><strong><code class="literal">ignore.requested.page</code></strong></span></p><p>Forces the SLS to redirect the client always to the configured default redirect
URL (property "<a class="link" href="#x15932_Sidehead_BoldTarsec_redirect_default">redirect.default</a>"),
regardless of what page the client originally wanted to
access.</p><p><a id="x15932_Sidehead_BoldTarsec_redirect_default"></a><span class="strong"><strong><code class="literal">redirect.default</code></strong></span></p><p>Default URL to which the client browser should be redirected after a successful
login. Usually, if a browser tries to access an application URL and the HSP
redirects the request to the SLS, the originally requested application URL is
preserved in the request, and the SLS will automatically redirect the client to
it after successful authentication. But if a browser accessed the SLS directly
(due to a bookmark, for example), and no requested page could be retrieved from
the request, this default URL will be used instead.</p><p>The <code class="literal">redirect.default</code> URL is also used as the default redirect location during
logout, unless an explicit <code class="literal">redirect.logout</code> URL has been configured. See this
property below.</p><p><span class="strong"><strong><code class="literal">requested.page.whitelist</code></strong></span></p><p>This optional property holds a regular expression which is a whitelist for
allowed requested pages. Only if the regex matches, the requeste page is valid,
else it is rejected ant the SLS will redirect to the default page
"<a class="link" href="#x15932_Sidehead_BoldTarsec_redirect_default">redirect.default</a>".</p><p><span class="strong"><strong><code class="literal">requested.page.blacklist</code></strong></span></p><p>This optional property holds a regular expression which is a blacklist for
allowed requested pages. If the regex matches, the requeste page is is rejected
ant the SLS will redirect to "<a class="link" href="#x15932_Sidehead_BoldTarsec_redirect_default">redirect.default</a>".</p><p><span class="strong"><strong><code class="literal">requested.page.postinform</code></strong></span></p><p>Defines if the requested page is included in any &lt;sls:form&gt; as a hidden POST
parameter to distinguish different tabs. Default is true.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_redirect_after_logout"></a>11.3.3. Redirect After Logout</h3></div></div></div><p><span class="strong"><strong><code class="literal">redirect.logout</code></strong></span></p><p>URL to which the client browser should be redirected after a successful logout.
This can be overridden by a "<code class="literal">target</code>" request parameter.</p><p>If <code class="literal">redirect.logout</code> is not set, the <code class="literal">redirect.default</code> property is instead used
as the default redirect location.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_redirect_with_do_redirect_state"></a>11.3.4. Redirect with "do.redirect" state</h3></div></div></div><p>The model state "<code class="literal">do.redirect</code>" also allows to perform a redirect at any point
in the model (see <a class="link" href="#x93524_Heading3Tarsec_Action_states" title="7.9.2. Action states">"Action states"</a>).
Please note that this state, by default, invalidates the login session before
executing the redirect! If a redirect should be performed without invalidating
the SLS session, the state parameter "<code class="literal">.param.invalidate=false</code>" must be set:</p><pre class="programlisting">model.state....name=do.redirect
model.state....param.invalidate=false</pre><p>Note also, that actions attached to the do.redirect model state are only executed
if the SLS login session is not invalidated and only if/when a following request comes in.</p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_redirect_response_to_post_requests"></a>11.4. Redirect Response to POST requests</h2></div></div></div><p>In a login flow with multiple pages, such as a challenge-/response procedure, the SLS usually responds with an HTTP 200 code when the first page with the username and password is posted. The HTTP 200 response contains the next HTML page, with the challenge form. This behaviour can be problematic in an environment where multiple people are using, or have access to, the same client computer. For example, user A could log in to an application, then later log out without closing the browser, and leave the desk. User B might then press the "back" button of the browser multiple times, until the challenge page of the login flow should be displayed. Since that page was the result of a POST request, the browser will usually ask the user if the POST request should be done again; this would potentially give user B access to the POST data, in this case the username and password of user A.</p><p>To prevent this, it is possible to force the SLS to use 302 responses whenever a POST requests results in displaying another page.</p><p><span class="strong"><strong><code class="literal">redirect.response.to.post</code></strong></span></p><p><span class="emphasis"><em>Optional</em></span>: Allows to enable the SLS to respond to POST requests with 302 instead of HTTP 200 (the following GET will automatically load the current JSP). Will apply to all client requests, if no white- or blacklists are configured. Example:</p><pre class="programlisting">redirect.response.to.post=true</pre><p><span class="strong"><strong><code class="literal">redirect.response.whitelist.regex</code></strong></span></p><p><span class="emphasis"><em>Optional</em></span>: Allows to define a whitelist for all user-agents for which NOT to respond with a 302 status code. Multiple properties can be set by adding a suffix to this property name. Example:</p><pre class="programlisting">redirect.response.whitelist.regex=Mozilla/[123].</pre><p>or</p><pre class="programlisting">redirect.response.whitelist.regex.1=Mozilla/[123].
redirect.response.whitelist.regex.2=MSIE/[789].</pre><p><span class="strong"><strong><code class="literal">redirect.response.blacklist.regex</code></strong></span></p><p><span class="emphasis"><em>Optional</em></span>: Allows to define a blacklist for all user-agents for which to USE 302 status code responses. The syntax is the same as for the whitelist property.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_mapped_redirects"></a>11.5. Mapped Redirects</h2></div></div></div><p><a id="x50966_Sidehead_BoldTarsec_redirect_for"></a><span class="strong"><strong><code class="literal">redirect.for.<code class="literal"><span class="emphasis"><em>&lt;id&gt;</em></span></code>
<code class="literal">redirect.to.</code><span class="emphasis"><em>&lt;id&gt;</em></span></code></strong></span></p><p>In conjunction, these properties allows to specify multiple redirect URLs if one single SLS instance has to process authentication requests from different locations, and / or the SLS does not receive that information as meta data in the client request from the HSP. Typical use cases are programmatic clients which send direct POST requests to the SLS instance.</p><p>The <code class="literal"><span class="emphasis"><em>&lt;id&gt;</em></span></code> part of the property name has no specific meaning, it is just an identifier used to match two properties with each other.</p><p>"redirect.for.*" defines the URI path for which the client originally requested authorization, and which the SLS has to specify in certain internal directives sent to the HSP to make clear for which URIs the client may be authorized.</p><p>"redirect.to.*" then defines the path to which such a client must be redirected and for which it must be authorized.</p><p>For example, one SLS installation may be configured, in the Tomcat deployment descriptor, to process requests for both URIs:</p><pre class="screen">/apps/x/login
/otherapp/sls</pre><p>The mapping configuration would then look like this:</p><pre class="programlisting">redirect.for.appone=/apps/x/login
redirect.to.appone=/apps/x

redirect.for.apptwo=/otherapp/sls
redirect.to.apptwo=/otherapp</pre><p>In this example, the SLS is configured to authorize any authenticated client which authenticated itself through a specific SLS location for a corresponding path:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
Clients authenicated through "<code class="literal">/apps/x/login</code>" get authorized for path "<code class="literal">/app/x</code>"
</li><li class="listitem">
Clients authenticated through "<code class="literal">/otherapps/sls</code>" get authorized for path "/otherapps".
</li></ul></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_session_handling"></a>11.5.1. Session Handling</h3></div></div></div><p><span class="emphasis"><em>IMPORTANT: The SLS session will NOT be terminated automatically if an internal forward is made, instead of the usual redirect performed by the "do.success" state.</em></span></p><p>As a consequence, when using an internal forward, it is the responsibility of the JSP or custom action, to handle and invalidate the session properly (in a JSP, the JEXL function "<code class="literal">session.invalidate()"</code> may be used with the "<code class="literal">getJexl</code>" JSP tag).</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_forward_after_logout"></a>11.5.2. Forward After Logout</h3></div></div></div><p><span class="strong"><strong><code class="literal">forward.logout</code></strong></span></p><p>Internal SLS path to which the request should be forwarded after a successful logout.</p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_application_logout"></a>11.6. Application Logout</h2></div></div></div><p>The SLS allows to redirect the client to an application logout location with the model state "<code class="literal">do.applogout</code>". This state redirects to a URL of an application in order to be able to terminate that application session and freeing up resources in the application server.</p><p><span class="strong"><strong><code class="literal">redirect.app.logout</code></strong></span></p><p>Defines the location to which to redirect the client. This should be a path without any protocal and hostname information. Example:</p><pre class="programlisting">redirect.app.logout=/theapp/actions/logout</pre><p><span class="strong"><strong><code class="literal">redirect.app.logout.az</code></strong></span></p><p>Defines the authorization required to access the logout location. The value must correspond to the value of the "Require_AZ" setting in the SRM configuration for the logout location.</p></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="x10004_Heading1Tarsec_Parameter_Checker"></a>Chapter 12. Parameter Checker / Aliases</h2></div></div></div><p>The SLS implements a generic parameter check functionality. It allows to define through the configuration which input parameters may be accepted at all and what the valid value ranges are for each of those parameters. The checker functionality is configured through a set of properties in the global configuration file "<code class="literal">sls.properties</code>".</p><p>Also, it is possible to define aliases for any of the well-known parameters supported by the SLS, such as "<code class="literal">target</code>" or "<code class="literal">cmd</code>".</p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_parameter_aliases"></a>12.1. Parameter Aliases</h2></div></div></div><p>To define one or multiple aliases for a parameter, the following property must be defined:</p><p><span class="strong"><strong><code class="literal">parameter.alias.<span class="emphasis"><em>&lt;name&gt;</em></span>=<span class="emphasis"><em>&lt;alias[,alias2,alias3..]&gt;</em></span></code></strong></span></p><p>The <code class="literal"><span class="emphasis"><em>&lt;name&gt;</em></span></code> part contains the name of the parameter for which to define alias(ses), e.g. "<code class="literal">target</code>", and the value of the property contains the alias (comma-separated values for multiple aliases). Example:</p><pre class="programlisting">parameter.alias.target=MyTarget,endpoint,customerPage</pre></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_parameter_checker"></a>12.2. Parameter Checker</h2></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_configuration_properties_2"></a>12.2.1. Configuration Properties</h3></div></div></div><p>The checker can be enabled or disabled globally through this configuration property:</p><p><span class="strong"><strong><code class="literal">http.parameter.check.enforce</code></strong></span></p><p>Default is "false". The checker can be enabled by setting it to "true".</p><p><span class="emphasis"><em>However, since verifying the request parameters is also a security issue, it is strongly advised to keep this functionality enabled.</em></span></p><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="_rule_properties"></a>Rule Properties</h4></div></div></div><p>For each parameter that should be checked, a group of properties must be defined with the following prefix:</p><pre class="programlisting">parameter.http.&lt;id&gt;.xxx=...</pre><p>where <code class="literal"><span class="emphasis"><em>&lt;id&gt;</em></span></code> is just used to group all properties for one parameter together.</p><p><span class="strong"><strong><code class="literal">parameter.http.&lt;id&gt;.name</code></strong></span></p><p>Name of the request parameter to check.</p><p><span class="strong"><strong><code class="literal">parameter.http.&lt;id&gt;.uri</code></strong></span></p><p>URI path for which the parameter is checked (exclusive context path). This
property is optional. If uri is not set, the parameter is checked for each uri,
and for POST and GET requests. If an uri is specified, the parameter is only
checked for POST request to the specified dispatching action path.</p><p><span class="strong"><strong><code class="literal">parameter.http.&lt;id&gt;.neverlog</code></strong></span></p><p>This optional property is enabled if set to "true". When "neverlog" is enabled, the SLS creates a log filter for the parameter value, at the time the parameter is checked. So you can ensure that a parameter is never logged. This can be useful for passwords.</p><p><span class="strong"><strong><code class="literal">parameter.http.&lt;id&gt;.methods</code></strong></span></p><p>Defines for which HTTP methods the parameter is allowed (comma-separated list for more than one method). Example:</p><pre class="programlisting">parameter.http.x.methods=POST,GET</pre><p><span class="strong"><strong><code class="literal">parameter.http.&lt;id&gt;.required</code></strong></span></p><p>If set to "<code class="literal">true</code>", the parameter is mandatory, if set to "<code class="literal">false</code>" (default), the parameter is optional.</p><p><span class="strong"><strong><code class="literal">parameter.http.&lt;id&gt;.regex</code></strong></span></p><p>This optional property defines a set of valid characters of a parameter. The character set is specified like a regular expresson character class. This is the subset of a regular expression (often between the square barckets). 
The following example allows only capital characters from A-Z: 
<code class="literal">parameter.http.&lt;id&gt;.regex=[A-Z]</code></p><p>For more flexibility see the property: <code class="literal">parameter.http.&lt;id&gt;.fullregex</code></p><p><span class="strong"><strong><code class="literal">parameter.http.&lt;id&gt;.min-length</code></strong></span></p><p>Required minimum number of characters in parameter value.</p><p><span class="strong"><strong><code class="literal">parameter.http.&lt;id&gt;.max-length</code></strong></span></p><p>Allowed maximum number of characters in parameter value.</p><p><span class="strong"><strong><code class="literal">parameter.http.&lt;id&gt;.fullregex</code></strong></span></p><p>This optional property is a regular expression (as always in SLS a Java-Style-Regex ) that must match for the parameter  check to succeed.</p><p><span class="strong"><strong><code class="literal">parameter.http.&lt;id&gt;.trim</code></strong></span></p><p>If set to true, the parameter is trimmed at the begin of the check, allleading and trailing whitespaces are removed, before further checks.</p><p><span class="strong"><strong><code class="literal">parameter.http.&lt;id&gt;.tenant</code></strong></span></p><p>This optional property refers to a tenant. The parameter checker is only active, if the specified tenant is selected at the time of checking. Mostly there is no need for tenant-specific Parameter Checker rules. If this subproperty <code class="literal">.tenant</code> is not specified for a rule <code class="literal">&lt;id&gt;</code>, the rule  is valid for all tenants.</p><p><span class="strong"><strong><code class="literal">parameter.http.&lt;id&gt;.mand</code></strong></span></p><p>This deprecated optional property refers to a tenant. "paramter.http.&lt;id&gt;.tenant" should be used instead. They are both used in the same way.</p></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_password_parameter_example"></a>12.2.2. "password"-Parameter Example</h3></div></div></div><pre class="programlisting">parameter.http.loginpage1.name=password
parameter.http.loginpage1.uri=/doauth.do
parameter.http.loginpage1.methods=POST,GET
parameter.http.loginpage1.required=false
parameter.http.loginpage1.regex=[a-zA-Z0-9]
parameter.http.loginpage1.min-length=6
parameter.http.loginpage1.max-length=20</pre><p>In this example, the request parameter "<code class="literal">password</code>" is allowed to be sent through both GET and POST requests to the URI path</p><p>"<code class="literal">/doauth.do</code>".</p><p>According to the regular expression, the parameter may contain all characters from "a-z", "A-Z" and "0-9", and must be between 6 and 20 characters.</p></div></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="x67409_Heading1Tarsec_Concurrency_Issues_with_Browser_Tabs"></a>Chapter 13. Concurrency Issues with Browser Tabs</h2></div></div></div><p>With automatic multi-step authentication types like NTLM, problems can arise when a user starts up a browser with multiple tabs open, where each tab points to an application protected by NTLM. In that situation, the browser tries to perform multiple NTLM authentications in parallel, which doesn't work because the SLS has only one session per client and expects certain steps to be performed in a certain order.</p><p>The problems begins with the fact that the cookie check in the HSP reverse proxy can already fail, or create multiple SCDID cookies with different session IDs for the same client, in such situations.</p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_hsp_srm_configuration"></a>13.1. HSP SRM configuration</h2></div></div></div><p>The following SRM configuration directive helps to alleviate this (should be set in the application / SLS location):</p><pre class="screen">SE_SupCredGenerationTime 2</pre></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_sls_configuration"></a>13.2. SLS configuration</h2></div></div></div><p>In the "<code class="literal">sls.properties</code>" file, the following properties should be set:</p><pre class="programlisting">already.loggedin.redirect=true
concurrent.use.wait.jsp=true
concurrent.waiting.time=6
session.enable.cookie=true
wait.on.locking=false</pre><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
"<code class="literal">already.loggedin.redirect</code>" will redirect any request in a session, that has already a "valid" SES session state, to the application, regardless of the current SLS model state.
</li><li class="listitem">
"<code class="literal">concurrent.use.wait.jsp</code>" instructs the SLS to send the concurrent requests the "<code class="literal">WaitConcurrent.jsp</code>" as the response (after the waiting period defined by "<code class="literal">concurrent.waiting.time</code>"). That JSP will try to reload the application URL after a few seconds.
</li><li class="listitem">
"<code class="literal">concurrent.waiting.time</code>" defines the number of seconds which concurrently processed requests have to wait before the self-refreshing page is returned to the client. This should usually be something around 5 - 10 seconds.
</li><li class="listitem">
"<code class="literal">session.enable.cookie</code>"  will enable the SLS to recognize multiple concurrent requests from the same physical client through the persistent session ID cookie "SLSsecrnd", even when the requests come with different client-correlator IDs.
</li><li class="listitem">
"<code class="literal">wait.on.locking</code>" means that if requests from the same client are really entering the SLS concurrently, while the first one is processed, the other ones immediately recieve a self-reloading page ("<code class="literal">WaitConcurrent.jsp</code>"), which waits a short while and then tries to load the application URL again.
== Password Policy
</li></ul></div><p>During a password change or reset operation, the new password must be checked
for compliance to a certain set of rules.
Typically, at the very least there is a minimum and maximum length.</p><p>The SLS allows to define a policy for these password checks by defining
a set of rules in a separate XML configuration file:</p><pre class="screen">WEB-INF/password-policy.xml</pre><p>The content of that file is a very simple XML tag with some attributes
that define the result, like this example:</p><pre class="screen">&lt;password-policy
upperCaseCount="1"
lowerCaseCount="1"
numericCount="0"
minLength="4"
maxLength="8"
generatedLength="8"
regularExpression="regularExpression=""
inclusionPattern="-_./\\=$+*%@#%&amp;gt;&amp;lt;&amp;amp;&amp;quot"
/&gt;</pre></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_disabling_password_policy"></a>13.3. Disabling Password Policy</h2></div></div></div><p>To disable the policy, simply remove or rename the policy file.
If the file does not exist or cannot be processed, the policy mechanism is disabled.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_policy_attributes"></a>13.4. Policy Attributes</h2></div></div></div><p>The password policy is applied in two steps:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
Verifies that the password length is between <code class="literal">minLength</code> and <code class="literal">maxLength</code> and
  that it does not contain upper/lower case letters or numbers if that is
  strictly forbidden (i.e. if <code class="literal">upperCase</code>, <code class="literal">lowerCase</code> or <code class="literal">number</code> is
  set to <code class="literal">NONE</code> and the password still contains the corresponding characters).
  Note that in this case, the policy check always fails immediately,
  irrespective of a potential <code class="literal">checkCount</code> configuration.
</li><li class="listitem">
Next all configured checks are applied.
  If <code class="literal">checkCount</code> is set to 1 or higher, all configured checks are performed
  and the overall check only fails if less than the indicated <code class="literal">checkCount</code>
  number of checks have succeeded.
  If <code class="literal">checkCount</code> is 0 (resp. not set) then checking fails immediately
  at the first check that fails.
  Note that the inclusion pattern is only considered if no regex is defined
  and it is configured, while the regex is always considered unless it is
  not configured or configured to a blank string.
  Checks that count are:
  <code class="literal">checkUpperCase</code> (can only fail here if <code class="literal">upperCase</code> is set to <code class="literal">MUST</code>),
  <code class="literal">checkLowerCase</code> (can only fail here if <code class="literal">lowerCase</code> is set to <code class="literal">MUST</code>),
  <code class="literal">checkNumeric</code> (can only fail here if set <code class="literal">numeric</code> is set to <code class="literal">MUST</code>),
  if <code class="literal">regularExpression</code> is set to a non-blank string, regex check,
  else <code class="literal">checkInclusionPattern</code>.
</li></ul></div><p>The following paragraphs explain each attribute of the XML tag.</p><p><span class="strong"><strong><code class="literal">minLength</code></strong></span></p><p>Defines the minimum length of the password.
Typical values are 4 or 6.</p><p><span class="strong"><strong><code class="literal">maxLength</code></strong></span></p><p>Defines the maximum length of the password.
A typical value is 8 (often used in older authentication systems).</p><p><span class="strong"><strong><code class="literal">generatedLength</code></strong></span></p><p>Defines the length of the password generated during the password reset
(aka forgotten password) process.
Since the allowed maximum length for a user-chosen password may be set
to a large value like 20, the length of generated passwords should
usually be set to a sensible, short value, like 8.</p><p><span class="strong"><strong><code class="literal">upperCase</code></strong></span></p><p>Defines if the password must contain 0, 0-n or 1-n uppercase characters.
Possible values are:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">NONE</code> = The password must not contain any uppercase characters
</li><li class="listitem">
<code class="literal">ALLOW</code> = The password may contain uppercase characters
</li><li class="listitem">
<code class="literal">MUST</code> = The password must contain uppercase characters
</li></ul></div><p><span class="strong"><strong><code class="literal">lowerCase</code></strong></span></p><p>Defines if the password must contain 0, 0-n or 1-n lowercase characters.
Possible values are:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">NONE</code> = The password must not contain any lowercase characters
</li><li class="listitem">
<code class="literal">ALLOW</code> = The password may contain lowercase characters
</li><li class="listitem">
<code class="literal">MUST</code> = The password must contain lowercase characters
</li></ul></div><p><span class="strong"><strong><code class="literal">numeric</code></strong></span></p><p>Defines if the password must contain 0, 0-n or 1-n numeric characters.
Possible values are:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">NONE</code> = The password must not contain any numeric characters
</li><li class="listitem">
<code class="literal">ALLOW</code> = The password may contain numeric characters
</li><li class="listitem">
<code class="literal">MUST</code> = The password must contain numeric characters
</li></ul></div><p><span class="strong"><strong><code class="literal">regularExpression</code></strong></span></p><p>Allows to freely define a regular expression that the password has to match.
If a regular expression is defined, the password will always be checked against it.
This property overrides the inclusionPattern property</p><p><span class="strong"><strong><code class="literal">inclusionPattern</code></strong></span></p><p>A simplified variant of the "regularExpression" attribute, which is used to define
a list of characters that are allowed. This property is only valid if:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
the property "checkInclusionPattern" has value "true", otherwise is ignored.
</li><li class="listitem">
the property "regularExpression" is not configured.
  Otherwise is ignored, since the regular expression overrides the inclussion pattern.
</li></ul></div><p><span class="strong"><strong><code class="literal">checkUpperCase</code></strong></span></p><p>Check that the password contains uppercase characters if upperCase="MUST".</p><p><span class="strong"><strong><code class="literal">checkLowerCase</code></strong></span></p><p>Check that the password contains lowercase characters if lowerCase="MUST".</p><p><span class="strong"><strong><code class="literal">checkNumeric</code></strong></span></p><p>Check that the password contains numbers if numeric="MUST".</p><p><span class="strong"><strong><code class="literal">checkInclusionPattern</code></strong></span></p><p>Check that the password does not contain special characters other than
the ones defined in inclusionPattern.
If this property is set to "true", the property inclusionPattern must be configured,
otherwise the check of the password will produce an error.</p><p><span class="strong"><strong><code class="literal">checkCount</code></strong></span></p><p>Defines the number of MUST-rules that have to be fulfilled in order to accept
a new password.
This means that if this attribute is set, for example, to "2",
only two MUST-criterias have to be met by the new password.
If this attribute is not set, all MUST-rules have to be followed.</p></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="x10001_Heading2Tarsec_Localization"></a>Chapter 14. Localization</h2></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_overview_6"></a>14.1. Overview</h2></div></div></div><p>The following SLS components can be localized to match the end-user's languages:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
Java Server Pages (JSP)
</li><li class="listitem">
Error messages in JSPs
</li></ul></div><p>This can be achieved by adapting the language resources properties files (see following chapters). These files contain key-/value pairs, where the key uniquely represents a message or a JSP.</p><p>The standard approach for localizing a Java application is to avoid hard-coded text in JSPs. Instead, only IDs of resources should be used (through some taglibs for example), and the text messages themselves should be externalized in the resource properties files.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="x18580_Heading2Tarsec_Selecting_User_Language"></a>14.2. Selecting User Language</h2></div></div></div><p>If multiple languages are supported through message resource files (as described in the following paragraphs), the user can choose the preferred language through links in the JSPs or the URI of the requested page (the application that the user tried to access).</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_language_selection_with_sls_uri_parameter"></a>14.2.1. Language Selection With SLS URI Parameter</h3></div></div></div><p>The links must point to the SLS application, with the parameter "<code class="literal">language</code>" containing the 2-character code of the desired language ("<code class="literal">de</code>" for german, "<code class="literal">en</code>" for english etc.). For example:</p><pre class="screen">&lt;a href="?language=en"&gt;English&lt;/a&gt;
&lt;a href="?language=de"&gt;Deutsch&lt;/a&gt;
&lt;a href="?language=it"&gt;Italiano&lt;/a&gt;</pre><p>The user's language choice is then stored in a persistent cookie named "<code class="literal">SLSLanguage</code>" so that the same language will be used automatically the next time the same user performs an authentication again.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_language_selection_with_requested_page_uri"></a>14.2.2. Language Selection With Requested Page URI</h3></div></div></div><p>Sometimes applications use their URI to decide which language to use, e.g. an application "<code class="literal">/demoapp</code>" might use URIs such as:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">/demoapp/<span class="emphasis"><em>en</em></span>/something</code> → English
</li><li class="listitem">
<code class="literal">/demoapp/<span class="emphasis"><em>fr</em></span>/something</code> → French
</li></ul></div><p>If a user tries to access such a URI and is redirected to the SLS, the URI of the requested page is sent to the SLS as well. This makes it possible to select the language for the login session based on this URI.  There are two options available:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">
Using a regular expression
</li><li class="listitem">
Defining the index number of the language part of the URI
</li></ol></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="_using_a_regular_expression"></a>Using a regular expression</h4></div></div></div><p>When using a regular expression, the language part of the URI should usually be a substring of the entire URI, such as the "<code class="literal">/fr/</code>" part in the following example:</p><p><code class="literal">/demoapp/one/<span class="emphasis"><em>fr</em></span>/xyz/anything</code></p><p>The following example shows how to configure a regular expression that matches the language part of that URI:</p><p><span class="strong"><strong><code class="literal">lang.uri.regex</code></strong></span></p><p><span class="emphasis"><em>Optional</em></span>: Defines a regular expression which is used to match against the requested page URI. If it matches, the matching part will be used as the language code, e.g.:</p><pre class="programlisting">lang.uri.regex=/.*/(.*?)/</pre><p>Note: This check uses the "<code class="literal">matcher.group(1)</code>" method of the Java regular expression matcher for the resulting language code. So, in order to test a regular expression with some Java regex tool, make sure the "<code class="literal">matcher.group(1)</code>" method returns the desired result.</p><p>Then again, sometimes a regular expression might be overkill when the language part of the URI is always at the exact same location within the URI; in those cases, using the index number might be easier (see following chapter).</p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="_using_the_index_number"></a>Using the index number</h4></div></div></div><p>When using an index number instead of a regular expression, the URI of the requested page is simply split up into parts, using the slash ("/") character as a separator. The parts are then numbered, beginning with 0 (zero), e.g.</p><p>Requested page URI: <code class="literal">/demoapp/one/en/so/something</code></p><p>Part 0: <code class="literal">demoapp</code></p><p>Part 1: <code class="literal">one</code></p><p>Part 2: <code class="literal">en</code></p><p>Part 3: <code class="literal">so</code></p><p>Part 4: <code class="literal">something</code></p><p>For the example above, the configuration would look like this:</p><p><span class="strong"><strong><code class="literal">lang.uri.part.no</code></strong></span></p><p><span class="emphasis"><em>Optional</em></span>: Defines the index number of the requested page URI part which represents the language code, e.g.</p><pre class="programlisting">lang.uri.part=2</pre></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_set_default_language"></a>14.2.3. Set Default Language</h3></div></div></div><p>See <a class="link" href="#x92024_Heading3Tarsec_Language_Cookie" title="24.3.3. Language Cookie">"Language Cookie"</a> for information on how to configure the default language.</p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_language_cookie"></a>14.3. Language Cookie</h2></div></div></div><p>The creation of the language cookie can be configured through a number of configuration properties that are explained in detail in the chapter <a class="link" href="#x92024_Heading3Tarsec_Language_Cookie" title="24.3.3. Language Cookie">"Language Cookie"</a>.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="x17268_Heading3Tarsec_Message_Resource_Files"></a>14.4. Message Resource Files</h2></div></div></div><p>In the subdirectory <code class="literal">"WEB-INF/classes"</code>, there are  property files named <code class="literal">"sls-resources.properties"</code> or, for specific languages,  +"sls-resources_XX.properties",+where "<span class="emphasis"><em>XX</em></span>" is a language code, like "de" for german. These files are used to provide internationalization support. They contain the text messages used by the . So, an example file list looks like this:</p><pre class="screen">WEB-INF/classes/
  sls-resources.properties - Default (fallback)
  sls-resources_de.properties - German version</pre><p>There are various groups of message properties:</p><div class="table"><a id="idm3410"></a><p class="title"><strong>Table 14.1. Resource Properties Groups</strong></p><div class="table-contents"><table class="table" summary="Resource Properties Groups" cellpadding="4px" style="border-collapse: collapse;border-top: 3px solid #527bbd; border-bottom: 3px solid #527bbd; border-left: 3px solid #527bbd; border-right: 3px solid #527bbd; "><colgroup><col class="col_1" /><col class="col_2" /></colgroup><thead><tr><th style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top">Property Name Prefix </th><th style="border-bottom: 1px solid #527bbd; " align="left" valign="top">Usage</th></tr></thead><tbody><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>jsp.*</p></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>Relative path to JSP page within SLS web application directory.</p></td></tr><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>errors.*</p></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>HTML header and footer for error messages.</p></td></tr><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>sls.*</p></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>Error messages displayed in the JSPs.</p></td></tr><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>label.id.*</p></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>Credential type names.</p></td></tr><tr><td style="border-right: 1px solid #527bbd; " align="left" valign="top"><p>text.*</p></td><td style="" align="left" valign="top"><p>Text labels used in JSPs (title, page text etc.)</p></td></tr></tbody></table></div></div><br class="table-break" /><p>The existing messages are all listed in the provided default resource files. Please read the contents of these files for detailled information.</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="x112233_Message_Resource_Files"></a>14.4.1. Custom Message Resource Files</h3></div></div></div><p>It is possible to configure additional subdirectories in the "<code class="literal">WEB-INF</code>" directory,
which can contain more message resource property files. These files must follow
the exact same name conventions as explained above; and they will ALWAYS have
precedence over the files in the "classes" directory. This means that by adding
an additional subdirectory for custom resource files, it is possible to just
override the properties that need to be different than the SLS’s own default
values; either per language, or per tenant, or both.</p><p><span class="strong"><strong><code class="literal">custom.resources.path</code></strong></span></p><p>This property allows to define either an absolute path to a directory anywhere
in the filesystem, or a relative path for a subdirectory of the SLS "<code class="literal">WEB-INF</code>"
directory, to contain additional message resources, e.g.</p><pre class="screen">custom.resources.path=more_resources</pre><p>If multiple subdirectories should be used (for example, if message resources
should be split up in separate directories for each tenant), then an arbitrary
suffix can be added to this property to add it multiple times, e.g.</p><pre class="screen">custom.resources.path.1=acme_resources
custom.resources.path.2=store_resources</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_multi_jsp_localization_example"></a>14.4.2. Multi-JSP Localization Example</h3></div></div></div><p>The resource files also contain properties which hold names of JSP-files that could be used for the given language. The default login page JSP, for example, is named <code class="literal">"Login.jsp"</code>. The file used for a german user, however, could be named <code class="literal">"Login_de.jsp"</code>, or it could be in a separated directory, like <code class="literal">"de/Login.jsp"</code>.</p><p>This is somewhat contrary to the 'official\' approach of JSP applications as propagated by Sun, where there is only one single JSP page which localizes text through a Java bean. Of course a JSP developer is still free to do it this way. But experience shows that in many companies tools are not available to efficiently handle JSPs with bean-based text localization, and the preferred way is to just create static text for each language by creating a separate set of JSP files. That is why the SLS provides the mechanism to use a custom JSP for each language.</p><p>An example file and directory structure could look like this:</p><pre class="screen">sls-webapp/
  WEB-INF/...
  jsp_en/
      Login.jsp
      Welcome.jsp
      ...
  jsp_de
      Login.jsp
      Welcome.jsp
      ...
  jsp_fr
      Login.jsp
      Welcome.jsp
      ...</pre><p>In each "<code class="literal">sls-resources_XX.properties</code>" file, all the jsp path properties would have to be adjusted acordingly as follows:</p><p><span class="strong"><strong><span class="emphasis"><em>sls-resources.properties</em></span></strong></span></p><pre class="programlisting">jsp.login=/jsp_en/Login.jsp
jsp.welcome=/jsp_en/Welcome.jsp</pre><p><span class="strong"><strong><span class="emphasis"><em>sls-resources_de.properties</em></span></strong></span></p><pre class="programlisting">jsp.login=/jsp_de/Login.jsp
jsp.welcome=/jsp_de/Welcome.jsp</pre></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_asian_language_support"></a>14.5. Asian Language Support</h2></div></div></div><p>The common encoding used for dealing with chinese, japanese etc. characters is UTF-8. But Java message resource property files have to be ASCII-encoded, with all special characters in Unicode-escaping notation. See this Sun documentation for details:</p><p><a class="ulink" href="https://docs.oracle.com/cd/E19773-01/819-5070/adgjt/index.html" target="_top">https://docs.oracle.com/cd/E19773-01/819-5070/adgjt/index.html</a></p><p>In order to get a JSP in the SLS to properly display asian characters, the following steps must be taken. First, the JSP file must begin with this line:</p><pre class="screen">&lt;%@ page contentType="text/html;charset=utf-8" pageEncoding="utf-8" %&gt;</pre><p>This ensures, that the resulting output stream sent to the browser client is really UTF-8 encoded.</p><p>Furthermore, when a property file is edited with some UTF-8 capable editor, and the special characters are inserted, it must be converted to the proper ASCII encoding before it is deployed in the SLS. This is done using the "native2ascii" tool which comes with Java:</p><pre class="screen">native2ascii -encoding UTF-8 &lt;inputfile&gt; &lt;outputfile&gt;</pre><p>So, if there was a resource bundle file "<code class="literal">SLSResources.properties</code>" that was processed with a UTF-8 editor, and which contains UTF-8 encoded chinese characters, it would have to be converted like this:</p><pre class="screen">native2ascii -encoding UTF-8 SLSResources.properties SLSResources-cn.properties</pre><p>Then the resulting file "SLSResources-cn.properties" could be deployed in an SLS instance (where it would have to be renamed to its original name of course).</p></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="_jsps"></a>Chapter 15. JSPs</h2></div></div></div><p>This chapter covers everything related to the SLS JSPs (Java Server Pages) and the SLS JSP tag library.</p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_jsp_files"></a>15.1. JSP Files</h2></div></div></div><p>The various HTML pages displayed by the SLS are created through JSP files. These files are usually located in this
directory within the SLS web application:</p><pre class="screen">WEB-INF/jsp</pre><p>The mapping of model steps to JSPs works as follows:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">
Model state (e.g. "<code class="literal">get.cred</code>") is resolved with the dispatch configuration
  ("<code class="literal">struts-config.xml</code>") to an internal fordward, such as "<code class="literal">jsp.login</code>".
</li><li class="listitem">
That internal forward is then resolved again through the Java language
  resource file (localization) to an actual filename and path. So, in the
  language resource file ("<code class="literal">sls-resources.properties</code>"), there is an entry like
</li></ol></div><pre class="programlisting">jsp.login=WEB-INF/jsp/Login.jsp</pre><p>The reason for the second step is to allow for the possibility of having completely separated JSP files for each
language (see <a class="link" href="#x10001_Heading2Tarsec_Localization" title="Chapter 14. Localization">"Localization"</a> for details).</p><p>See <a class="link" href="#x112233_Heading1Tarsec_Display_Single_JSP_Command" title="6.3. &quot;displayjsp&quot; - Display JSP Command">"Display Single JSP Command"</a>
for details on how to directly display a certain JSP (for testing purposes).</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_customization_2"></a>15.1.1. Customization</h3></div></div></div><p>The following components can be adapted to customize the JSPs (besides the JSP
files themselves):</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">/staticfiles/includes/*.css</code> : Contains all CSS stylesheet definitions.
</li><li class="listitem">
<code class="literal">/staticfiles/includes/page-heading.inc</code> : Contains the header section HTML.
</li><li class="listitem">
<code class="literal">/staticfiles/includes/error-message.inc</code> : Contains the error message section HTML.
</li><li class="listitem">
<code class="literal">/staticfiles/includes/page-footer.inc</code> : Contains the footer section HTML.
</li></ul></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_jsp_tag_library"></a>15.2. JSP Tag Library</h2></div></div></div><p>The SLS provides a JSP tag library that simplifies creating the various HTML forms the way the SLS needs them to be.
Some tags also provide the possibility of using JEXL/Groovy to display dynamic content in a page, or render parts of a page
only if a certain JEXL/Groovy condition is met etc.</p><p>Moreover (since SLS 4.41.0.0) JEXL/Groovy expressions can generally be used in all tag attributes,
except very basic inherited attributes like "id".</p><p>Please consult the <a class="link" href="#TABLIBGUIDE">[TABLIBGUIDE]</a> for a complete list of all available JSP tags, and documentation on
how to use them.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_jsp_configuration_settings"></a>15.3. JSP Configuration Settings</h2></div></div></div><p>There are some global configuration properties that have influence on the rendered HTML pages.</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_avoiding_duplicate_error_messages"></a>15.3.1. Avoiding Duplicate Error Messages</h3></div></div></div><p><span class="strong"><strong><code class="literal">jsp.globalerror.first</code></strong></span></p><p><span class="emphasis"><em>Optional:</em></span> If set to "<code class="literal">true</code>", only the first error message from the parameter checker is shown when the message tag
(<code class="literal">&lt;sls:message&gt;</code>) is called with the special key "<code class="literal">global.error.msg</code>". If set to "<code class="literal">false</code>", all error messages are
displayed. When i.e. the username is too short and contains an illegal character, both messages are displayed.</p><p>Defaults to <code class="literal">false</code>.</p><p><span class="strong"><strong>NOTE</strong></span>: This property has higher priority than <code class="literal">jsp.globalerror.last</code>, if both
are set to "<code class="literal">true</code>".</p><p><span class="strong"><strong><code class="literal">jsp.globalerror.last</code></strong></span></p><p><span class="emphasis"><em>Optional:</em></span> If set to "<code class="literal">true</code>", only the last error message from the parameter checker is shown when the message tag
(<code class="literal">&lt;sls:message&gt;</code>) is called with the special key "<code class="literal">global.error.msg</code>". If set to "<code class="literal">false</code>", all error messages are
displayed. When i.e. the username is too short and contains an illegal character, both messages are displayed.</p><p>Defaults to <code class="literal">false</code>.</p><p><span class="strong"><strong>NOTE</strong></span>: This property has lower priority than <code class="literal">jsp.globalerror.first</code>, if both
are set to "<code class="literal">true</code>".</p><p><span class="strong"><strong><code class="literal">jsp.javascript.minimize</code></strong></span></p><p><span class="emphasis"><em>Optional:</em></span> If set to "<code class="literal">true</code>", all the SLS JSP tags that would normally render JavaScript for some functions just
won't do it. This should only be used in cases where it is certain that the client browsers do not support JavaScript,
and it is important to keep the HTML free of any JavaScript as a result.</p><p>Defaults to <code class="literal">"false"</code>.</p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_bootstrap_upgrade"></a>15.4. Bootstrap Upgrade</h2></div></div></div><p>The latest SLS release comes with Bootstrap 5. If existing JSPs from previous SLS releases should be used with the new
Bootstrap version, the following adaptations should be made:</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_style_name_changes"></a>15.4.1. Style name changes</h3></div></div></div><p>A few style names were changed with Bootstrap 4 and 5. Replace the name prefixes of these style classes accordingly
in the JSPs and/or include files:</p><div class="informaltable"><table class="informaltable" cellpadding="4px" style="border-collapse: collapse;border-top: 3px solid #527bbd; border-bottom: 3px solid #527bbd; border-left: 3px solid #527bbd; border-right: 3px solid #527bbd; "><colgroup><col class="col_1" /><col class="col_2" /></colgroup><thead><tr><th style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top">State </th><th style="border-bottom: 1px solid #527bbd; " align="left" valign="top">Description</th></tr></thead><tbody><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout">*Old*</pre></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout">*New*</pre></td></tr><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout">col-xs-*</pre></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout">col-*</pre></td></tr><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout">col-sm-offset-*</pre></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout">offset-sm-*</pre></td></tr><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout">col-md-offset-*</pre></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout">offset-md-*</pre></td></tr><tr><td style="border-right: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout">col-lg-offset-*</pre></td><td style="" align="left" valign="top"><pre class="literallayout">offset-lg-*</pre></td></tr></tbody></table></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_obsolete_includes"></a>15.4.2. Obsolete includes</h3></div></div></div><p>Remove the following include statements from all JSPs and/or include files:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">&lt;link rel="stylesheet" href="staticfiles/includes/bootstrap-theme.min.css"&gt;</code>
</li><li class="listitem">
<code class="literal">&lt;script src="staticfiles/includes/jquery-3.5.1.min.js"&gt;&lt;/script&gt;</code>
</li><li class="listitem">
<code class="literal">&lt;script src="staticfiles/includes/bootstrap.min.js"&gt;&lt;/script&gt;</code>
</li></ul></div><p>Unless, of course, you are making explicit use of any functionality in the Bootstrap
JavaScript files in your customized JSPs. Please consult the official Bootstrap 5
documentation page for more information about breaking changes in the new Bootstrap
releases.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_bootstrap_js"></a>15.4.3. Bootstrap JS</h3></div></div></div><p>The "bootstrap.min.js" file is still included in the "includes" folder of the SLS
static files, but it’s not used by the SLS JSPs by default. But it can be used if
its functionality is required for any customized JSPs.</p></div></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="_user_filtering_anchor_id_14243_heading1tarsec_user_filtering_xreflabel_14243_heading1tarsec_user_filtering"></a>Chapter 16. User Filtering<a id="14243: Heading1Tarsec: User Filtering"></a></h2></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_introduction_3"></a>16.1. Introduction</h2></div></div></div><p>The SLS optionally supports whitelisting or blacklisting of users, based on
their login ID . It allows to immediately restrict access to an SLS instance
independently of the actual back-end service. This can be useful if it is
necessary to quickly lock a user or all but a few users in case of an emergency,
and when the people (administrators) with the rights to do that are just not
available (at a weekend, for example).</p><p>The filter works very simple: It reads a plain text file with login IDs and uses
these entries as a white- or blacklist, depending on the configuration setting.
If the filter is activated, the SLS will monitor the filter file and re-read
it when it is changed, without requiring an SLS restart.</p><p>The user filter is triggered, by default, by the following to model states:</p><pre class="screen">do.auth
do.reauth</pre><p>In cases where a model does not use these states at all, but still requires the
user filter functionality, there is an additional option
(see property <a class="link" href="#user-filter-credential-verify">"user.filter.username.credential.verify"</a>).</p><p><span class="strong"><strong>User Blacklisting</strong></span></p><p>If the filtering mode is set to blacklisting, all login attempts performed with
one of the user IDs found in the filter file will be denied.</p><p><span class="strong"><strong>User Whitelisting</strong></span></p><p>If the filtering mode is set to whitelisting, all login attempts performed with
a user ID not listed in the filter file will be denied. This can be used to
restrict access for all but one or a few users quickly.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_user_filter_file_format"></a>16.2. User Filter File Format</h2></div></div></div><p>The filter file is a plain text file with the default name and location:</p><pre class="screen">WEB-INF/UserFilterFile.txt</pre><p>The format is simple; it consists of one login ID per line, like:</p><pre class="screen">johnmiller
nobody
baduser
janearcher</pre></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_filter_configuration"></a>16.3. Filter Configuration</h2></div></div></div><p>The following properties in the "<code class="literal">sls.properties</code>" file are relevant to the user
filter functionality:</p><p><span class="strong"><strong><code class="literal">user.filter.file</code></strong></span></p><p>Path of a text file with a list of user IDs. By default, the file is interpreted
as a whitelist. If the value is not an absolute file path, it is interpreted as
a relative path within the "<code class="literal">WEB-INF</code>" subdirectory of the SLS web application.</p><p>If the property is not set, the filter mechanism is disabled.</p><p>If the property is set but defines a file that does not exist (yet), the access
to all users will be granted.</p><p><span class="emphasis"><em>Note: The filter mechanism will become active as soon as the configured file is
created. In whitelisting mode, this will immediately block access for all users
(as long as the file is empty). In blacklisting mode, this will have no effect.</em></span></p><p>Example:</p><pre class="screen">user.filter.file=UserFilterFile.txt</pre><p>The user filter is not limited to one file. Multiple comma separated files can
be set. In this case the SLS merges the userIDs from all the files to one big
list. This can for example be useful for handling groups of users, or sharing
lists for multiple SLS instances.</p><p>Example:</p><pre class="screen">user.filter.file=Local.txt,/share/allSlsFilter.txt</pre><p><span class="strong"><strong><code class="literal">user.filter.dynamic</code></strong></span></p><p>Boolean property which enables the dynamic filter-file mode. If set to true, the
filter mechanism is enabled and the refresh-thread is running. The property
<code class="literal">user.filter.file</code> can be set in <code class="literal">sls-dynamic.properties</code>, but it must not be
set in the static configuration file. The advantage of this dynamic filter mode
is, that the list of filter files can be changed when the SLS is running.</p><p>Also, the property "<code class="literal">user.filter.blacklist</code>" (see below) can be put in the
"<code class="literal">sls-dynamic.properties</code>" file, which allows to switch between white- and
blacklist-mode on the fly, without restarting the SLS.</p><p><span class="strong"><strong><code class="literal">user.filter.blacklist</code></strong></span></p><p>Set this property to "<code class="literal">true</code>" to make the filter list work as a blacklist
instead of a whitelist (as it does by default). If the filter is not enabled,
this property will be ignored.</p><p>Example:</p><pre class="screen">user.filter.blacklist=true</pre><p>Note: An empty blacklist does allow all users, where an empty whitelist does
block all users.</p><p>If the property "<code class="literal">user.filter.dynamic</code>" is enabled, this property can also be
put into the "<code class="literal">sls-dynamic.properties</code>" file.</p><p><a id="user-filter-credential-verify"></a><span class="strong"><strong><code class="literal">user.filter.username.credential.verify</code></strong></span></p><p>As mentioned before, the user filter is triggered only by pre-defined model
states by default. In some cases, this might not be sufficient; for example
when a model uses only generic states like <code class="literal">do.http</code>, and then sets the
credentials to verified state using JEXL functions.</p><p>For such cases, this property can be set to one of the following two values:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p class="simpara">
<code class="literal">create</code>
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem">
This value means that the user filter will be triggered as soon as the
   credential is created (basically, when the POST request from a login form
   ist processed). And therefore before any backend adapter would be invoked.
</li></ul></div></li><li class="listitem"><p class="simpara">
<code class="literal">markverified</code>
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem">
This value means that the user filter will be triggered only when the
   credential is marked as verified (either by an adapter, or by means of JEXL).
</li></ul></div></li></ul></div><p>Examples:</p><pre class="screen">user.filter.username.credential.verify=create</pre><p>or</p><pre class="screen">user.filter.username.credential.verify=markverified</pre></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="x33260_Heading1Tarsec_Sending_eMail"></a>Chapter 17. Sending E-Mail</h2></div></div></div><p>The SLS allows to send any desired e-mail. This function can be used to send notification or information to any receiver by e-mail.</p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_sending_e_mail"></a>17.1. Sending E-Mail</h2></div></div></div><p>There are two possibilities of activating the sending e-mail mechanism, both of them are configurable in the model.</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
The model state <code class="literal">do.sendmail</code> (requires a property)
</li><li class="listitem">
The <code class="literal">sendMail()</code> JEXL Function
</li></ul></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_model_state_configuration"></a>17.1.1. Model State Configuration</h3></div></div></div><p>To send a mail, the model state "<code class="literal">do.sendmail</code>" can be used. It requires an additional "<code class="literal">property</code>"-State to define which group of properties to use:</p><pre class="programlisting">model.state.50.name=do.sendmail
model.state.50.property=&lt;alias&gt;</pre><p>The "<code class="literal"><span class="emphasis"><em>&lt;alias&gt;</em></span></code>" value refers to a group of properties which define the details of the mail to be sent:</p><p><span class="strong"><strong><code class="literal">email.<code class="literal"><span class="emphasis"><em>&lt;alias&gt;</em></span></code>.to</code></strong></span></p><p>The list of receiver e-mail addresses. It can be a single address or a comma-separated list.</p><p><span class="strong"><strong><code class="literal">email.<code class="literal"><span class="emphasis"><em>&lt;alias&gt;</em></span></code>.from</code></strong></span></p><p>Address which will be set as sender in the e-mail header.</p><p><span class="strong"><strong><code class="literal">email.<code class="literal"><span class="emphasis"><em>&lt;alias&gt;</em></span></code>.subject</code></strong></span></p><p>The subject of the message</p><p><span class="strong"><strong><code class="literal">email.<code class="literal"><span class="emphasis"><em>&lt;alias&gt;</em></span></code>.body</code></strong></span></p><p>The body/content of the message. As it is desirable to have longer message there are two ways to fill this property:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
In the property like manner:
</li></ul></div><pre class="screen">email.&lt;alias&gt;.body=This is the body.</pre><p>If the text should continue on the next line add a back-slash ("\") at the end of the line.</p><pre class="screen">email.&lt;alias&gt;.body=This is a long line of the body \
which continues here.</pre><p>Be aware the whole text will be shown as one line in the body. It will not create a line break at the intended position.</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
Using the JEXL Template function (see <a class="link" href="#x12304_Heading3Tarsec_Templates" title="32.8.2. Templates">"Templates"</a>), e.g.
</li></ul></div><pre class="screen">email.&lt;alias&gt;.body=${function.getTemplateContent('XY')}</pre><p><span class="strong"><strong><code class="literal">email.&lt;alias&gt;.mimeType</code></strong></span></p><p><span class="emphasis"><em>Optional:</em></span> The MIME type of the mail. Defaults to "<code class="literal">text/plain</code>".</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_jexl_function_sendmail"></a>17.1.2. JEXL Function sendMail()</h3></div></div></div><p>The function needs four parameters similar to the model state. The method header is:</p><pre class="screen">sendMail(to, from, subject, body)</pre><p>The body can use the same template function as the model state. A complete model state could look like this:</p><pre class="programlisting">model.sendmail.state.25.name=do.generic
model.sendmail.state.25.action.1=${function.sendMail('receiver@domain.com', 'sender@domain.com', 'Mail Subject', function.getTemplateContent('infomail'))}</pre></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_e_mail_environment"></a>17.2. E-Mail Environment</h2></div></div></div><p>In order to use this mechanism, the e-mail environment must be configured. The following configuration property must be enabled in the "<code class="literal">sls.properties</code>" file:</p><p><span class="strong"><strong><code class="literal">mail.transport.protocol</code></strong></span></p><p>Specifies the default message transport protocol. Usually to send email it should be <span class="emphasis"><em><code class="literal">smtp</code></em></span>.</p><p><span class="strong"><strong><code class="literal">mail.auth.user</code></strong></span></p><p><span class="emphasis"><em>Optional</em></span>: Username when authentication is required.</p><p><span class="strong"><strong><code class="literal">mail.auth.password</code></strong></span></p><p><span class="emphasis"><em>Optional</em></span>: Corresponding password for the username. This should be encrypted by the DataProtector/Seal. See <a class="link" href="#x33956_Heading2Tarsec_DataProtector" title="39.3. SLS Seal (DataProtector replacement)">"SLS Seal (DataProtector replacement)"</a></p><p><span class="strong"><strong><code class="literal">mail.smtp.user</code></strong></span></p><p><span class="emphasis"><em>Optional</em></span>: Default user name to connect to the SMTP server.</p><p><span class="strong"><strong><code class="literal">mail.smtp.host</code></strong></span></p><p>The SMTP server to connect to.</p><p><span class="strong"><strong><code class="literal">mail.smtp.auth</code></strong></span></p><p><span class="emphasis"><em>Optional</em></span>: Set this to "<code class="literal">true</code>" to authenticate the user. Defaults to "<code class="literal">false</code>".</p><p><span class="strong"><strong><code class="literal">mail.smtp.port</code></strong></span></p><p><span class="emphasis"><em>Optional</em></span>: The SMTP server port to connect to. Common port numbers are <span class="emphasis"><em>25</em></span> and <span class="emphasis"><em>465</em></span>(SMTP over SSL). Defaults to "<code class="literal">25</code>".</p><p><span class="strong"><strong><code class="literal">mail.smtp.ssl.enable</code></strong></span></p><p><span class="emphasis"><em>Optional</em></span>: Set this to "<code class="literal">true</code>" to use SSL to connect the server. Defaults to  "<code class="literal">false</code>".</p><p>In general all the JavaMail API Properties can be used for more detailed configuration.</p><p><span class="strong"><strong><code class="literal">mail.smtp.ssl.protocols</code></strong></span></p><p>Allows to define SSL/TLS protocols to use, whitespace-separated list with the same constants
as  also used in JDK settings, e.g. "TLSv1.2 TLSv1.1".</p><p>See documentation of the javax.mail client for
<a class="ulink" href="https://javaee.github.io/javamail/docs/api/com/sun/mail/smtp/package-summary.html" target="_top">additional settings</a>
and javax.mail-&lt;version&gt;.jar in the SLS WEB-INF/lib directory for currently included version.</p></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="x18987_Heading1Tarsec_Multitenancy_Support"></a>Chapter 18. Multitenancy Support</h2></div></div></div><p>The SLS provides multitenancy support, which means that the JSP pages from one single SLS instance can be customized to look differently for different users, depending on things like the request URL or the hostname etc.</p><p>Even the login flow can be customized to behave differently, depending on the current tenant.</p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_how_it_works"></a>18.1. How it works</h2></div></div></div><p>The basic idea is that the language resource mechanism used to implement support for different languages (see <a class="link" href="#x17268_Heading3Tarsec_Message_Resource_Files" title="14.4. Message Resource Files">"Message Resource Files"</a>) is extended in order to also support multiple tenants. In other words, the tenant is basically just an attribute of the current session, just like the user's language.</p><p>The reason is that all paths to resources such as images, style sheets etc., but also the paths of the various JSP files can be put into the language resource files. The JSP tags provided with the SLS provide the simple means to work with these resources from within a JSP (see "<code class="literal">taglib-guide.pdf</code>" for details about using the JSP taglib). While usually the language of the current session is used to resolve the path of a resource, the tenant alias is taken into account as well if necessary.</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_multitenancy_specific_resources"></a>18.1.1. Multitenancy specific resources</h3></div></div></div><p>All tenant specific resources should be in separate resource property files
which follow the regular Java language resource file naming convention, extended
with a tenant prefix:</p><p><code class="literal">sls-resources-&lt;tenant&gt;_&lt;lang&gt;.properties</code></p><p>Where "<code class="literal"><span class="emphasis"><em>&lt;lang&gt;</em></span></code>" is a two-letter language code like "<code class="literal">en</code>", "<code class="literal">it</code>" etc., and
"<code class="literal"><span class="emphasis"><em>&lt;tenant&gt;</em></span></code>" is the tenant alias, like "<code class="literal">acme</code>". For example, in addition to
the regular resource file holding all english messages, named</p><p><code class="literal">sls-resources_en.properties</code></p><p>there could also be an additional file named</p><p><code class="literal">sls-resources-acme_en.properties</code></p><p>which holds all paths, messages etc. that are different for the tenant "<code class="literal">acme</code>".</p><div class="note" style="margin-left: 0; margin-right: 10%;"><h3 class="title">Note</h3><p>When there is no specific message resource for the current tenant, the
SLS will just fall back to the default resource properties files. So the
tenant-specific properties file can be used to just override those message keys
that need to be changed for a tenant.</p></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_activation"></a>18.2. Activation</h2></div></div></div><p>In order to use tenant support, it must be activated explicitely:</p><p><span class="strong"><strong><code class="literal">multitenancy.enabled</code></strong></span></p><p>Set this property to "<code class="literal">true</code>" to enable support for multitenancy. Defaults to "<code class="literal">false</code>" if not set.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_defining_tenants"></a>18.3. Defining tenants</h2></div></div></div><p>Each tenant needs to be given an alias, which is then used as an extension to the name of the language resource file, or in logical JEXL conditions within the login model.</p><p>To define tenants, the following property prefix must be used:</p><p><span class="strong"><strong><code class="literal">tenant.<span class="emphasis"><em>&lt;no&gt;</em></span></code></strong></span></p><p>The "<code class="literal"><span class="emphasis"><em>&lt;no&gt;</em></span></code>" part of the property name is a numeric value, beginning with "1". The value of the property is a simple string, which can then be used as an extension for language resource keys, or in JEXL functions.</p><p>Example definitions:</p><pre class="programlisting">tenant.1=acme
tenant.2=multicorp</pre></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_resolving_tenants"></a>18.4. Resolving tenants</h2></div></div></div><p>When a request is processed by the SLS, there must be some criteria for deciding which tenant to use. There are some types of attributes for distinguish tenants:</p><p><span class="strong"><strong><code class="literal">multitenancy.resolving.<span class="emphasis"><em>&lt;no&gt;</em></span></code></strong></span></p><p>Where "<code class="literal"><span class="emphasis"><em>&lt;no&gt;</em></span></code>" is a numeric value which also defines the priority of each kind of tenant resolution. Example definitions:</p><pre class="programlisting">multitenancy.resolving.1=&lt;type&gt;
multitenancy.resolving.2=&lt;type&gt;</pre><p>The following types are available:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">samlalias</code>
</li><li class="listitem">
<code class="literal">urlregex</code>
</li><li class="listitem">
<code class="literal">urlparam</code>
</li><li class="listitem">
<code class="literal">hostprefix</code>
</li></ul></div><p>Another option is to set the tenant specifically within the model, using the JEXL function "<code class="literal">session.setTenant(<span class="emphasis"><em>alias</em></span>)</code>" (see <a class="link" href="#x83667_Heading3Tarsec_JEXL_Function" title="18.4.5. JEXL Function">"JEXL Function"</a>).</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_url_path"></a>18.4.1. URL path</h3></div></div></div><p>Determine the tenant based on a part of the requests' URL path, defined through a regular expression. Example:</p><pre class="programlisting">multitenancy.resolving.1=urlregex</pre><p>The regular expression for matching the URL must be defined in a property of the following type:</p><p><span class="strong"><strong><code class="literal">tenant.<span class="emphasis"><em>&lt;no&gt;</em></span>.regex</code></strong></span></p><p>Regular expression for matching with the URL path (or a part of it).</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_url_parameter"></a>18.4.2. URL parameter</h3></div></div></div><p>The value of a URL parameter is used to determine the tenant. Example:</p><pre class="programlisting">multitenancy.resolving.1=urlparam</pre><p>The URL parameter name is pre-defined:</p><pre class="screen">mand</pre><p>So by invoking the SLS URL with the URL-parameter "<code class="literal">mand</code>" set to one of the defined tenant aliases, the corresponding tenant can be triggered:</p><pre class="screen">..../sls/auth?mand=acme</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_hostname"></a>18.4.3. Hostname</h3></div></div></div><p>The first part (prefix) of the hostname of the request is used to determine the tenant. Example configuration property:</p><pre class="programlisting">multitenancy.resolving.1=hostprefix</pre><p>So if this property is set like this, and the incoming request would be for the host</p><pre class="screen">acme.corp.com</pre><p>it would result in the usage of the tenant "<code class="literal">acme</code>".</p><p><span class="emphasis"><em>NOTE: For this type of tenant resolution, the SRM configuration must also be adapted correctly, or the SLS will not receive the correct host header value. See <a class="link" href="#x87937_Heading3Tarsec_Step_3_Configure_SRM" title="18.6.3. Step 3: Configure SRM">"Step 3: Configure SRM"</a> for details.</em></span></p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_saml_alias"></a>18.4.4. SAML alias</h3></div></div></div><p>Determine the tenant based on the alias of the sender of the current SAML message.
For example, in an SLS Identity Provider setup, all registered Service Providers
are configured and usually given an alias, to easily refer to them when using
SAML-related JEXL functions etc. Based on that alias, the tenant can be triggered
as well.</p><pre class="programlisting">multitenancy.resolving.1=samlalias</pre><p>The alias for each tenant, that corresponds to the alias of the SAML provider,
must be configured like that:</p><p><span class="strong"><strong><code class="literal">tenant.<span class="emphasis"><em>&lt;no&gt;</em></span>.samlalias</code></strong></span></p><p>Example of an SP registered in the Identity Provider under the alias "acme-ltd-sp":</p><pre class="screen">idp.sp.1.alias=acme-ltd-sp
idp.sp.1.metadata.provider=file
idp.sp.1.metadata.location=WEB-INF/idp/acmesp-metadata.xml
...</pre><pre class="screen">tenant.2.samlalias=acme-ltd-sp</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="x83667_Heading3Tarsec_JEXL_Function"></a>18.4.5. JEXL Function</h3></div></div></div><p>The JEXL function "<code class="literal">session.setTenant(<span class="emphasis"><em>alias</em></span>)</code>" allows to enforce a certain tenant from within the model:</p><pre class="screen">model...state.10.name=do.generic
model...state.10.action=${session.setTenant('acme')}</pre><p><span class="emphasis"><em>Note: Even if this JEXL function is used, at least one of the previously mentioned resolve mechanisms must still be configured, if the multi tenancy feature is enabled!</em></span></p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_using_tenants"></a>18.5. Using Tenants</h2></div></div></div><p>The following paragraphs describe how to actually implement custom pages or page content, or even a custom login model for different tenants.</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="x81272_Heading3Tarsec_JEXL_Variable"></a>18.5.1. JEXL Variable</h3></div></div></div><p>There is a JEXL variable that holds the value of the current tenant:</p><pre class="screen">current.tenant</pre><p>So, in order to define a condition - for example in a customized model - based on the tenant, the JEXL expression would look something like this:</p><pre class="screen">..state.3.nextState.if=${current.tenant eq 'acme'}</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_separate_jsps_per_tenant"></a>18.5.2. Separate JSPs per tenant</h3></div></div></div><p>If the goal is to have a complete set of JSPs for each tenant, the JSP paths must be defined in the tenant-specific resource files in the SLS web application subdirectory "<code class="literal">WEB-INF/classes</code>". For example:</p><p>In file "<code class="literal">sls-resources</code><span class="strong"><strong><code class="literal">-acme</code></strong></span><code class="literal">_en.properties</code>":</p><pre class="programlisting">jsp.login=/jsp/acme/Login.jsp</pre><p>In file "<code class="literal">sls-resources</code><span class="strong"><strong><code class="literal">-multicorp</code></strong></span><code class="literal">_en.properties</code>":</p><pre class="programlisting">jsp.login=/jsp/multicorp/Login.jsp</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_multitenancy_specific_content_in_jsps"></a>18.5.3. Multitenancy specific content in JSPs</h3></div></div></div><p>If there should be only one single set of JSPs that should display different content for different tenants, a number of JSP tags can be used. All relevant SLS JSP tags automatically support usage of tenant-specific resource files, if they are available. So in order to have tenant-specific messages, a message key must be moved from the default resource file "<code class="literal">sls-resources.properties</code>" into the tenant-specific resource files.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_tenant_specific_default_language"></a>18.5.4. Tenant-specific default language</h3></div></div></div><p>See <a class="link" href="#x92024_Heading3Tarsec_Language_Cookie" title="24.3.3. Language Cookie">"Language Cookie"</a> for information on how to configure a default language for a certain tenant.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_tenant_specific_sls_configuration"></a>18.5.5. Tenant-specific SLS configuration</h3></div></div></div><p>There is a jexl function <code class="literal">session.getTenantSpecific()</code>, wich allows setting of the following configuration properties in a tenant specific way:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">redirect.default</code>
</li><li class="listitem">
<code class="literal">requested.page.whitelist</code>
</li><li class="listitem">
<code class="literal">requested.page.blacklist</code>
</li><li class="listitem">
<code class="literal">redirect.app.logout</code>
</li><li class="listitem">
<code class="literal">browser.blacklist</code>
</li><li class="listitem">
<code class="literal">fake.token.list</code>
</li></ul></div><p>Consult the <a class="link" href="#JEXLGUIDE">[JEXLGUIDE]</a> for details about the jexl function.</p><p>There are more SLS features, that can be used tenant specific. For example the <a class="link" href="#x10004_Heading1Tarsec_Parameter_Checker" title="Chapter 12. Parameter Checker / Aliases">"Parameter Checker / Aliases"</a> and the <a class="link" href="#x76105_Heading1Tarsec_Blacklist" title="Chapter 19. Browser Blacklist">"Browser Blacklist"</a>.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_tenant_specific_logging"></a>18.5.6. Tenant-specific logging</h3></div></div></div><p>It is possible to use separate log files for each tenant. In case of URI-separated tenants, it is even recommended, because of potential problems that might occur with log file rotation (see <a class="link" href="#x98293_Heading3Tarsec_Log_rotation_problem_with_URI_based_multi_tenancy" title="25.7.1. Log rotation problem with URI-based multi-tenancy">"Log rotation problem with URI-based multi-tenancy"</a> for details).</p><p>For details on how to configure Log4J to use separate log files for each tenant, please read <a class="link" href="#x59059_Heading2Tarsec_Tenant_specific_logging" title="25.7. Tenant-specific logging">"Tenant-specific logging"</a>.</p><p><span class="emphasis"><em>NOTE: If multitenancy is enabled, but the logging configuration is not adapted accordingly, some log records may not get written anywhere as a result!</em></span></p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_complete_simple_example"></a>18.6. Complete Simple Example</h2></div></div></div><p>Here is a complete example for using tenants, based on the details described in the previous chapters and paragraphs. The sample tenants used here will be:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
Tenant 1: "asia" (the asian part of the company)
</li><li class="listitem">
Tenant 2: "euro" (the european part)
</li></ul></div><p>They shall use the same sets of JSPs, but the page should contain a heading - defined in the message resource key "page.heading" - that is different for each tenant.</p><p>The tenant should be triggered by two different virtual hosts:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong><code class="literal">asia.</code></strong></span><code class="literal">acme.com</code> - Hosts the asian company site
</li><li class="listitem">
<span class="strong"><strong><code class="literal">euro.</code></strong></span><code class="literal">acme.com</code> - Hosts the european company site
</li></ul></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_step_1_create_resource_files"></a>18.6.1. Step 1: Create resource files</h3></div></div></div><p>First, the additional resource files with the tenant-specific messages should be created. They are to be put into the SLS web applications\' subdirectory "WEB-INF/classes".</p><p>The first file, "<code class="literal">sls-resources</code><span class="strong"><strong><code class="literal">-asia</code></strong></span><code class="literal">_en.properties</code>" must contain the following property:</p><pre class="programlisting">page.heading=Welcome to ASIA Corp.</pre><p>And the other resource file, "<code class="literal">sls-resources</code><span class="strong"><strong><code class="literal">-euro</code></strong></span><code class="literal">_en.properties</code>", must contain the same property, but with a different value:</p><pre class="programlisting">page.heading=Welcome to EURO Corp.</pre><p>Now in order to have a JSP display the correct heading for the current tenant, include this JSP tag:</p><pre class="programlisting">&lt;sls:message key="page.heading" /&gt;</pre><p>However, it will not work yet as long as the following steps are not completed.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_step_2_configure_sls"></a>18.6.2. Step 2: Configure SLS</h3></div></div></div><p>A few properties must be defined in the "<code class="literal">sls.properties</code>" configuration file, as described above:</p><pre class="programlisting">multitenancy.enabled=true

tenant.1=asia
tenant.2=euro

tenant.resolving.1=hostprefix</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="x87937_Heading3Tarsec_Step_3_Configure_SRM"></a>18.6.3. Step 3: Configure SRM</h3></div></div></div><p>If tenant resolution is done by hostname (hostprefix), it is mandatory to add the following directive to the login location of the SRM configuration:</p><pre class="screen">HGW_ForceHost    &lt;hostname&gt;</pre><p><code class="literal"><span class="emphasis"><em>&lt;hostname&gt;</em></span></code> must be the actual hostname of the virtual host, e.g.</p><pre class="screen">HGW_ForceHost    www.acme.com</pre><p>If this directive is not set, the SLS usually receives "<code class="literal">127.0.0.1</code>" as the hostname. This prevents the hostname-based tenant resolution from working correctly.</p></div></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="x76105_Heading1Tarsec_Blacklist"></a>Chapter 19. Browser Blacklist</h2></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_introduction_4"></a>19.1. Introduction</h2></div></div></div><p>The SLS supports an optional blacklist for browser (or client) agents. This blacklist allows to react with different actions to requests from  "unsupported" clients.</p><p><span class="emphasis"><em>Please note: This is not a security feature!</em></span> Its main purpose is to reject, for example, browsers which do not have an appropriate SSL implementation and may therefore pose a problem to the application, the HSP or the client itself. But since determining the browser type is based entirely on the "<code class="literal">User-Agent</code>" HTTP request header which can easily be faked, this mechanism cannot and must not be used for any security-relevant purposes.</p><p>The blacklist uses regular expressions to match a set of rules to a certain browser agent type. Each set of rules consists of a group of properties. Such a set of properties  shares the same name prefix, as explained below. The blacklist basically allows to specify two things for each browser agent:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">
If SSL session ID fixation should be used
</li><li class="listitem">
What action should be taken before (or instead) performing an authentication (see <a class="link" href="#x52684_Heading3Tarsec_Actions" title="19.4.6. Actions">"Actions"</a> for details).
</li></ol></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_ssl_session_id_fixation"></a>19.2. SSL Session ID Fixation</h2></div></div></div><p>The HSP supports SSL session ID fixation for increased security. This functionality can either be globally enabled or disabled in the HSP configuration, or the HSP can let the SLS disable or enable it per session, based on the client agent type.</p><p>If the HSP delegates the decision to the SLS, it is possible to define a default setting for the SLS using this property:</p><p><span class="strong"><strong><code class="literal">fix.ssl.sid</code></strong></span></p><p>If it is set to "<code class="literal">true</code>", the SLS will enable SSL session ID fixation for every client for which no overriding rule exists in the blacklist file. If not set, the property defaults to "<code class="literal">false</code>".</p><p>Example:</p><pre class="programlisting">fix.ssl.sid=true</pre><p>As mentioned, the rules in the blacklist file can override the global default for a certain browser type.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_blacklist_configuration_properties"></a>19.3. Blacklist Configuration Properties</h2></div></div></div><p>To activate the blacklist mechanism, a blacklist file must be specified in "<code class="literal">sls.properties</code>" with this property:</p><p><span class="strong"><strong><code class="literal">blacklist</code></strong></span></p><p>Defines the path of a blacklist file. Can be either an absolute path, or relative to the SLS "WEB-INF" subdirectory.</p><p>Example:</p><pre class="screen">blacklist=BrowserBlacklist.properties</pre><p>If the blacklist file is changed, it is being reloaded automatically as soon as the next request is processed.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_blacklist_file_format"></a>19.4. Blacklist File Format</h2></div></div></div><p>The blacklist file is basically a Java properties file. It contains groups of properties for each browser agent rule, like this:</p><pre class="screen">&lt;rule name&gt;=&lt;regular expression&gt;
&lt;rule name&gt;.desc=Default description text
&lt;rule name&gt;.desc.&lt;lang&gt;=Language-specific description text
&lt;rule name&gt;.fixsslsid=off
&lt;rule name&gt;.action=[popup | info | deny]</pre><p>An example of properties for a rule matching all Mozilla browsers, older than version 4:</p><pre class="programlisting">MOZPREV4=Mozilla/[123].
MOZPREV4.desc=Mozilla browser older than version 4 (default)
MOZPREV4.desc.de=Mozilla Browser &amp;auml;lter als Version 4 (deutsch)
MOZPREV4.fixsslsid=off
MOZPREV4.action=popup</pre><p>Another example with a more complex regular expression matching all Versions of Internet Explorer except 5.0.1, 5.5 and above 6 for Windows 2000:</p><pre class="programlisting">IE_WIN2K_LOWER=MSIE.([1-4])|(5\.0[^1]).*Windows.NT.5\.0
IE_WIN2K_LOWER.desc=IE_W2000_older_than_5_5
IE_WIN2K_LOWER.fixsslsid=off
IE_WIN2K_LOWER.action=info</pre><p>The value for the &lt;+rule name+&gt; part can be any free text, but ideally it should relate to the browser type it addresses, because this name is also written to the log for clients with the action "deny" (see below).</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_expression_processing_ordering"></a>19.4.1. Expression Processing Ordering</h3></div></div></div><p>The order in which the regular expressions in the file are processed is unspecified. Therefore, it is not guaranteed that the expressions are processed top-down.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_regular_expression"></a>19.4.2. Regular Expression</h3></div></div></div><pre class="screen">Syntax: &lt;rule name&gt;=&lt;regular expression&gt;</pre><p>The first property contains the regular expression. That expression is used to evaluate the HTTP header "User-Agent" sent by the client. If it matches, the action defined by the property set is performed.</p><p>See <a class="link" href="#x44448_Heading2Tarsec_Regular_expressions" title="71.2. Regular expressions reference">"Regular expressions reference"</a> for more information about regular expressions in the SLS.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_description"></a>19.4.3. Description</h3></div></div></div><pre class="screen">Syntax: &lt;rule name&gt;.desc=Default description
Syntax: &lt;rule name&gt;.desc.&lt;lang&gt;=Language-specific description</pre><p>This property allows to specify a text description that will be displayed to the user by the actions "popup" and "info". Since each session has a language defined by the SLS language cookie, it is possible to create descriptions for each supported language. The &lt;lang&gt; part of the property name must be a 2-letter language code similar to the codes used by the Java localization API ("de", "en", "fr" etc.).</p><p>If no description is found for the language code of the session, the default description is used. If no default description is available, an empty String will be used.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="x29935_Heading4Tarsec_SSL_Session_ID_Fixation"></a>19.4.4. SSL Session ID Fixation</h3></div></div></div><pre class="screen">Syntax: &lt;rule name&gt;.fixsslsid=on</pre><p>This property allows to enable or disable the SSL session ID fixation functionality of the HSP for a client that matches with this rule. This value will override the global default setting.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_tenant_specific_rule"></a>19.4.5. Tenant Specific Rule</h3></div></div></div><pre class="screen">Syntax: &lt;rule name&gt;.tenant=&lt;tenant&gt;</pre><p>The scope of a rule can be limited to a tenant. If this rule-limitation +.tenant=&lt;tenant&gt;+is used, that rule it is only valid for the given tenant. If an other - or no - tenant is selected, the rule is not active.</p><p>The followin rule would deny the IE browser for tenant "secur".</p><pre class="programlisting">IE=MSIE.
IE.desc=No IE Browser allowed.
IE.tenant=secur</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="x52684_Heading3Tarsec_Actions"></a>19.4.6. Actions</h3></div></div></div><pre class="screen">Syntax: &lt;rule name&gt;.action=[popup | info | deny]</pre><p>This property defines the action that should be performed for requests sent by clients matched by this rule. There are three possible values:</p><div class="table"><a id="idm4180"></a><p class="title"><strong>Table 19.1. Blacklist actions</strong></p><div class="table-contents"><table class="table" summary="Blacklist actions" cellpadding="4px" style="border-collapse: collapse;border-top: 3px solid #527bbd; border-bottom: 3px solid #527bbd; border-left: 3px solid #527bbd; border-right: 3px solid #527bbd; "><colgroup><col class="col_1" /><col class="col_2" /></colgroup><thead><tr><th style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top">Action </th><th style="border-bottom: 1px solid #527bbd; " align="left" valign="top">Description</th></tr></thead><tbody><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>popup</p></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>This action means that the JSP developer who writes the login JSP should present a popup dialog with the description to the user. This is used mainly to inform users that support for their client will stop soon, and that they should upgrade to a supported browser version.</p>
<p>Since a popup dialog is very intrusive, it is only used in cases where it is deemed urgent to have users upgrade their browser. In other, less urgent cases, the "info" action should be used.</p></td></tr><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>info</p></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>This is basically the same as the popup action, only that the description should be presented to the user within the login page and not in a separate popup window.</p></td></tr><tr><td style="border-right: 1px solid #527bbd; " align="left" valign="top"><p>deny</p></td><td style="" align="left" valign="top"><p>This is the default action. If this action is set, any request from a client which matches with this rule is forwarded (not redirected) to the page "useragent.jsp". This page should inform the user that an update of the browser is mandatory, and the browser currently used is no longer supported.</p></td></tr></tbody></table></div></div><br class="table-break" /></div></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="x27589_Heading1Tarsec_Login_Slowdown"></a>Chapter 20. Login Slowdown</h2></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_introduction_5"></a>20.1. Introduction</h2></div></div></div><p>The SLS implements a forced slow-down of authentication processes in case several subsequent login attempts are performed for the same user ID but with an invalid password. This feature can serve as an addtitional protection against password guessing attackers or certain types of denial-of-service attacks.</p><p>Slowdown means that a user will, for example, after the 2nd failed login attempt be forced to wait for 30 seconds before trying for a 3rd time. That does not mean, however, that there will be any hanging requests; the client browser will instead immediately recieve a response, notifying the user that he or she must wait for <span class="emphasis"><em>x</em></span> seconds before a login can be attempted again.</p><p>It is also possible to increase that waiting time after each failed login attempt in different ways, depending on the configuration.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_slowdown_model_states"></a>20.2. Slowdown Model States</h2></div></div></div><p>The following model states currently trigger the slowdown mechanism:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">do.auth</code>
</li><li class="listitem">
<code class="literal">do.authresponse</code>
</li><li class="listitem">
<code class="literal">do.trxresponse</code>
</li></ul></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_configuration_properties_3"></a>20.3. Configuration Properties</h2></div></div></div><p>The following properties in the "<code class="literal">sls.properties</code>" file are used to specify the slow-down behaviour.</p><p><span class="strong"><strong><code class="literal">slowdown.active</code></strong></span></p><p>Enables the slow-down mechanism if set to "<code class="literal">true</code>". Defaults to "<code class="literal">false</code>" if not set.</p><p><span class="strong"><strong><code class="literal">slowdown.usepage</code></strong></span></p><p>If this property is set to "<code class="literal">true</code>", the separate page defined in the JSP "<code class="literal">Slowdown.jsp</code>" will be sent to the client with the notification message about the required waiting time. This JSP contains a self-refreshing meta header which will have the login page being loaded again automatically once the waiting time has passed.</p><p>If this property is set to "<code class="literal">false</code>", the login page will be returned to the client just as usually when a login fails. It will display the waiting notification message like any error message.</p><p>If the property is not set, it defaults to "<code class="literal">true</code>" (using "<code class="literal">Slowdown.jsp</code>").</p><p><span class="strong"><strong><code class="literal">slowdown.time</code></strong></span></p><p>Specifies the number of seconds of a base waiting time unit. The actual waiting time between login attempts depends on the property "slowdown.type" as well, though.</p><p><span class="strong"><strong><code class="literal">slowdown.type</code></strong></span></p><p>Defines the mode of calculating the required waiting time between login attempts. The following values are supported:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">constant</code>
</li></ul></div><p>The waiting time between invalid login requests will always stay the same.</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">linear</code>
</li></ul></div><p>The waiting time will increase after each failed login by adding the value defined.</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">doubling</code>
</li></ul></div><p>Doubles the waiting time after each invalid login attempt.</p><p><span class="strong"><strong><code class="literal">slowdown.threshold</code></strong></span></p><p>Defines the number of failed login attempts allowed before the slow-down
mechanism kicks in. If set to 2, for example, after 2 failed login attempts
the user will be forced to wait before trying a 3rd time.</p></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="x38834_Heading1Tarsec_Basic_Authentication"></a>Chapter 21. HTTP Basic Authentication</h2></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_introduction_6"></a>21.1. Introduction</h2></div></div></div><p>There are two areas involving the SLS and HTTP basic authentication:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">
Integration with an existing back-end application server which uses basic authentication. This is explained in chapter <a class="link" href="#x53260_Heading1Tarsec_SSO_Integration" title="Chapter 23. SSO Integration">"SSO Integration"</a>.
</li><li class="listitem">
The SLS itself using HTTP basic authentication instead of HTLM form-based login to authenticate a user.
</li></ol></div><p>The second option means that the SLS will use HTTP request and response headers instead of JSP pages to authenticate a user. These headers will trigger the user's webbrowser to show a popup dialog for entering username and password. There may be cases where this can be useful; however, it should be noted that it does not make sense to use this feature together with a 2-step-login (challenge-response), since the second step will always display a custom page for entering the challenge value.</p><p>Basic authentication by the SLS is configured with the following properties in the "<code class="literal">sls.properties</code>" configuration file:</p><p><span class="strong"><strong><code class="literal">basic.auth.enable</code></strong></span></p><p>Enables basic authentication by the SLS if set to "<code class="literal">true</code>" (defaults to "<code class="literal">false</code>").</p><p><span class="strong"><strong><code class="literal">basic.auth.realm</code></strong></span></p><p>Defines the text string for the basic authentication realm (displayed in the username / password popup dialog window of the webbrowser). Defaults to "<code class="literal">Secure Login Service</code>".</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_https_only"></a>21.2. HTTPS Only</h2></div></div></div><p><span class="strong"><strong><code class="literal">basic.auth.https.only</code></strong></span></p><p>Prevents basic authentication over HTTP connections if set to "<code class="literal">true</code>" (defaults to "<code class="literal">false</code>"). In many cases - especially when basic authentication is used over the public internet - it is advisable to allow it only for HTTPS connections. This helps to prevent clients from sending their passwords over the network unencrypted.</p><p>Since the SES reverse proxy handling the client connections could be configured to provide both HTTP and HTTPS connectivity for any given application (or certain parts of it), a configuration error could easily lead to clients authenticating themselves on plain HTTP connections.</p><p>Therefore, this setting in the SLS is just an additional precaution.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_user_agent_header_matching"></a>21.3. User-Agent Header Matching</h2></div></div></div><p>It is possible to use Basic-Auth only for clients which send a certain type of "<code class="literal">User-Agent</code>" header. An example would be some rich client or mobile application which needs to authenticate with Basic Authentication, while browser clients still should perform form-based login.</p><p>In order to use this, there must be 1 - n configuration properties with the prefix "<code class="literal">basic.auth.match</code>":</p><p><span class="strong"><strong><code class="literal">basic.auth.match_[.n]_</code></strong></span></p><p>Each such property contains a regular expression defining a pattern for a "<code class="literal">User-Agent</code>" header value for which to use Basic Authentication. Example:</p><pre class="programlisting">basic.auth.match.1=HttpClient.
basic.auth.match.2=SomeRichClient/[34].</pre><p>Which would use Basic Authentication for all clients with a "<code class="literal">User-Agent</code>" header which contains "<code class="literal">HttpClient</code>", "<code class="literal">SomeRichClient 3</code>" or "<code class="literal">SomeRichClient 4</code>".</p><p>See <a class="link" href="#x44448_Heading2Tarsec_Regular_expressions" title="71.2. Regular expressions reference">"Regular expressions reference"</a> for more information about regular expressions in the SLS.</p></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="x60248_Heading1Tarsec_Browser_ID_Check_BID"></a>Chapter 22. Browser ID Check ("BID")</h2></div></div></div><p>The HSP reverse proxy provides an SSL session ID locking mechanism that helps preventing various types of session stealing attacks. This  locking mechanism is usually based on the client's IP address. In addition, certain attributes of the actual client browser software can be taken into account to further increase security. This is implemented through client-side JavaScripts that use browser-specific features to provide this additional information.</p><p>For more information about this "Browser ID" (in short: "BID") check mechanism, see <a class="link" href="#HTTPADMIN">[HTTPADMIN]</a>, chapter 6.x "Browser ID" for details.</p><p>In order to use this mechanism, the following configuration property must be enabled in the "<code class="literal">sls.properties</code>" file:</p><p><span class="strong"><strong><code class="literal">bid.check.enable</code></strong></span></p><p><span class="emphasis"><em>Optional</em></span>: Set this to "<code class="literal">true</code>" to enable BID check functionality in the SLS. Defaults to "<code class="literal">false</code>".</p><p>Note that enabling this functionality only works if the SLS JSP tag library is used and, in particular, the following two tags are present:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">&lt;sls:head&gt;</code> - Must be inside the &lt;head&gt; section of the JSP.
</li><li class="listitem">
<code class="literal">&lt;sls:mandatoryFooter&gt;</code> - must be below the form in the JSP.
</li></ul></div><p>If the feature is enabled, the two JSP tags will render certain HTML fragments (CSS and JavaScript) that activate the BID-check functionality on the client side.</p></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="x53260_Heading1Tarsec_SSO_Integration"></a>Chapter 23. SSO Integration</h2></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_overview_7"></a>23.1. Overview</h2></div></div></div><p>There are several aspects of integration with application servers that need to
be considered:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
SSO (single-sign-on) HTTP headers propagated to the application
</li><li class="listitem">
SSO Request Filters in the application servers
</li><li class="listitem">
Application Server Authentication
</li></ul></div><p><span class="strong"><strong>SSO HTTP headers</strong></span></p><p>The first one is about configuring custom HTTP headers to be propagated to the
application servers through the HSP. These headers carry the user credentials
gathered and provided by the SLS during the authentication process. The actual
value of the header can consists of just a plain user ID (the actual login ID
or a mapped one), a more complex set of key-/value pairs, protected with a
timestamp and a signature, or an SES ticket.
See <a class="link" href="#x49306_Heading2Tarsec_Request_Filtering" title="23.2. SSO HTTP headers">"SSO HTTP headers"</a> for
information on how to set up such custom HTTP headers.</p><p><span class="strong"><strong>SSO Request Filters</strong></span></p><p>The second one is about various kinds of filter mechanisms that can be enabled
in an application server in order to extract the credentials of an authenticated
user from the SSO HTTP headers, and make it available to the application through
standard APIs.</p><p>This relieves the applications from the need to check each request for valid
credentials themselves, and also reduces the potential of security problems
caused by the lack of such checks etc.
(see <a class="link" href="#x62555_Heading2Tarsec_J2EE_Authentication_Filter" title="23.3. SSO Request Filters">"SSO Request Filters"</a>
for details about available filters).</p><p><span class="strong"><strong>Application Server Authentication</strong></span></p><p>The third aspect is about application servers that perform the user authentication
on their own, be it with some HTML login page or through HTTP basic authentication
or NTLM. In some cases, such login processes cannot be easily switched off and
replaced with some kind of SSO filters, especially in cases where the applications
perform the authentication themselves (custom-made legacy applications etc.).
Changing such hard-coded behaviour would require code-change and new release of
the application which often is not an option with tight integration project budgets.</p><p>In these cases, the HSP provides ways to act as a browser client towards such an
application server and transparently perform the authentication, using credentials
received from the SLS
(see <a class="link" href="#x97662_Heading2Tarsec_Application_Server" title="23.5. Application Server Authentication">"Application Server Authentication"</a>).</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="x49306_Heading2Tarsec_Request_Filtering"></a>23.2. SSO HTTP headers</h2></div></div></div><p>In order for any SSO filter in the application server to extract the credentials
of the authenticated user from a request header, that header must first be created
somehow. There are a few different ways to instruct the SLS to propagate custom
HTTP headers to the application server after a successful login.</p><p>There are basically two possible approaches:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
Setting the "<code class="literal">LoginUserData</code>" header
</li><li class="listitem">
Propagating a custom named header
</li></ul></div><p>The first one means that the SLS sets an HTTP response header with the specific
name "<code class="literal">LoginUserData</code>" in its response. This header is then recognized by the
HSP as a header containing user credentials. Its value can then be propagated
to application servers while the name of the header as it is sent to the
application can be changed separately for each location, for example:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
SLS sets an HTTP <span class="strong"><strong>response</strong></span> header "<code class="literal">LoginUserData</code>" with the value "<code class="literal">user=mrjones</code>".
</li><li class="listitem">
HSP is configured to send this header value in an HTTP <span class="strong"><strong>request</strong></span> header named
  "<code class="literal">userinfo</code>" to application "A"
</li><li class="listitem">
HSP is configured to send this header value in an HTTP <span class="strong"><strong>request</strong></span> header named
  "<code class="literal">credentials</code>" to application "B"
</li></ul></div><p>And so forth. So, this approach requires only one configuration property in the
SLS configuration, but also some directives in the HSP location settings, either
per (virtual) host or per application location.</p><p>Option two means using only SLS configuration properties to define what headers
to propagate to the application servers. In that case, the names of the headers
sent to the applications and the values are all completely defined within the
SLS configuration. This reduces the HSP configuration overhead, but also takes
away the flexibility of mapping the header name there.</p><p>The following chapters explain both options in more detail.</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="x59485_Heading3Tarsec_LoginData_Header"></a>23.2.1. "LoginUserData" Header</h3></div></div></div><p>There is a header that the SLS can set in its response which has a special
semantical meaning for the HSP. This HTTP header is usually referred
to as  "<code class="literal">LoginUserData</code>" header throughout SLS and HSP documentation files.</p><p>This HTTP response header is basically the standard means for the SLS to
propagate any kind of  credential to the application after a successful login.
The mechanism works like this:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
The SLS sets an HTTP <span class="strong"><strong>response</strong></span> header with name "<code class="literal">LoginUserData</code>", for example
  with the plain user ID
</li><li class="listitem">
The HSP catches that header and checks its configuration for instructions on
  what to do with it
</li><li class="listitem">
In the HSP location, a directive tells the HSP to propagate an HTTP <span class="strong"><strong>request</strong></span>
  header named "<code class="literal">UserID</code>" containing the value of the SLS HTTP <span class="strong"><strong>response</strong></span> header
  "<code class="literal">LoginUserData</code>" with every request to the application.
</li></ul></div><p>In the SLS, the configuration looks like this:</p><pre class="programlisting">hsp.header.LoginData=${session.getCred('username')}</pre><p>This will instruct the SLS to create an HTTP <span class="strong"><strong>response</strong></span> header named
"<code class="literal">LoginUserData</code>"  with the value of the username credential.</p><p>Now, to have this information sent to the application in a custom HTTP
<span class="strong"><strong>request</strong></span> header  "<code class="literal">UserCreds</code>", the corresponding application location in the
HSP configuration  would need this directive:</p><p><span class="strong"><strong>HSP configuration</strong></span></p><pre class="screen">AC_LoginUserDataHeaderName    UserCreds</pre><p>(The default for the header name if not configured is "<code class="literal">LoginCredentials</code>".)</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="x11777_Heading3Tarsec_Propagating_HTTP_Headers"></a>23.2.2. Propagating Custom HTTP Headers</h3></div></div></div><p>There is also a generic mechanism for propagating custom headers to the application.
The main advantage over the "LoginUserData" header mechanism is that it doesn't
require any specific configuration on the HSP side. However, it also means that
the header will always have the same name for all applications, while the
"<code class="literal">LoginUserData</code>"-header mechanism allows to implement a mapping in the SRM
configuration.</p><p>This property triggers the HSP to send a custom HTTP header with a certain value
to the application server with each client request once authentication was completed:</p><p><code class="literal">app.header.<span class="emphasis"><em>&lt;headername&gt;</em></span>=<span class="emphasis"><em>&lt;headervalue&gt;</em></span></code></p><p>Where <code class="literal"><span class="emphasis"><em>&lt;headername&gt;</em></span></code> is the name of the HTTP request header that must be
propagated to  the application server, and <code class="literal">&lt;headervalue&gt;</code> the text value of
that header. The value can also contain variables
(see chapter <a class="link" href="#x49003_Heading1Tarsec_Expressions" title="Chapter 32. JEXL Expressions">"JEXL Expressions"</a>) or a
combination of hardcoded strings and variables. The following example shows
how to propagate a header with the name "<code class="literal">userid</code>" and the value of the username
credential to the application:</p><pre class="programlisting">app.header.userid=${session.getCred('username')}</pre><p>The same example but with a hardcoded prefix "User:" in the value:</p><pre class="programlisting">app.header.userid=User:${session.getCred('username')}</pre><p><span class="strong"><strong><span class="emphasis"><em>IMPORTANT NOTE!</em></span></strong></span></p><p><span class="emphasis"><em>Any custom HTTP header that should be sent to the application server must also
be enabled in the HSP configuration (see  <a class="link" href="#HTTPADMIN">[HTTPADMIN]</a>).
Otherwise, it will be blocked and not be forwarded to the application.</em></span></p><p>Encoding can be tailored. For example in order to propagate an ISO-8859-1 encoded
header to the application do this:</p><pre class="programlisting">app.header.userid=${function.urlEncode(session.getCred('username'), 'ISO-8859-1')}
app.header.userId.isValueEncoded=true
app.header.userId.encoding=url</pre><p>In this case the header is propagated from the SLS to the HSP using URL encoding
and the URL encoding is already provided in the expression for the header value.
The HSP then URL decodes the received header and forwards it URL decoded (and
thus now in ISO-8859-1 charset) to the application. That way headers can be
forwarded  to applications in practically any encodings that the Java VM supports.
(Note that this mechanism is meant to be used with encoding "url" (or "base64"),
but not with the legacy encoding "string".)</p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="x62555_Heading2Tarsec_J2EE_Authentication_Filter"></a>23.3. SSO Request Filters</h2></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_filter_types_and_modes"></a>23.3.1. Filter Types And Modes</h3></div></div></div><p>The following types of SSO filters are available currently:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
J2EE Servlet Filter - SSO with single Java Servlet applications
</li><li class="listitem">
Tomcat Authenticator Module - SSO with Tomcat Application Server
</li></ul></div><p>Not all filters support the exact same range of functionality. There are three filter modes:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
"<code class="literal">plaintext</code>": Processing a plaintext header with just the user ID
</li><li class="listitem">
"<code class="literal">regex</code>": Processing a plaintext header consisting of various key-/value pairs; this is called the "regex" mode because a regular expression is used to extract the user ID.
</li><li class="listitem">
"<code class="literal">sesticket</code>": Processing an SES ticket header
</li></ul></div><p>The following table shows which filters currently support which types of credential handling:</p><div class="table"><a id="idm4487"></a><p class="title"><strong>Table 23.1. Filter Mode Support</strong></p><div class="table-contents"><table class="table" summary="Filter Mode Support" cellpadding="4px" style="border-collapse: collapse;border-top: 3px solid #527bbd; border-bottom: 3px solid #527bbd; border-left: 3px solid #527bbd; border-right: 3px solid #527bbd; "><colgroup><col class="col_1" /><col class="col_2" /><col class="col_3" /><col class="col_4" /></colgroup><thead><tr><th style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"> </th><th style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top">plaintext </th><th style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top">regex </th><th style="border-bottom: 1px solid #527bbd; " align="left" valign="top">sesticket</th></tr></thead><tbody><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>J2EE Servlet Filter</p></td><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>yes</p></td><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>yes</p></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>yes</p></td></tr><tr><td style="border-right: 1px solid #527bbd; " align="left" valign="top"><p>Tomcat 
Authenticator</p></td><td style="border-right: 1px solid #527bbd; " align="left" valign="top"><p>yes</p></td><td style="border-right: 1px solid #527bbd; " align="left" valign="top"><p>yes</p></td><td style="" align="left" valign="top"><p>yes</p></td></tr></tbody></table></div></div><br class="table-break" /></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_filter_settings"></a>23.3.2. Filter Settings</h3></div></div></div><p>The various Java-based filter types provided by the SLS share the same core
functionality, and mostly the same configuration settings. The main difference
is that in one case (J2EE filter) those settings must be defined as
initialization parameters in a "<code class="literal">&lt;filter&gt;</code>"-tag in a "<code class="literal">web.xml</code>" file, and in
the other case (Tomcat Authenticator module) as properties in a Java property
file.</p><p>Since the settings themselves are the same, this chapter describes each setting
and what it does. It serves as a list of reference for the following chapters
about the configuration of the various filters.</p><p><span class="emphasis"><em>NOTE: The settings names (left column) in the list below are (depending on the
type of filter used) sometimes just a part of a full configuration property
name. Example:</em></span></p><p>The setting "<code class="literal"><span class="emphasis"><em>mode</em></span></code>" from the reference list maps to</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
the Tomcat Authenticator property name "<code class="literal">authentication.<span class="emphasis"><em>mode</em></span></code>"
</li><li class="listitem">
J2EE Filter "<code class="literal">&lt;init-param&gt;</code>" with "<code class="literal">&lt;param-name&gt;</code>" and value "<code class="literal"><span class="emphasis"><em>mode</em></span></code>".
</li></ul></div><p>There are some complete configuration examples for different types of
authentication setups in <a class="link" href="#x66726_Heading2Tarsec_SSO_Configuration_Examples" title="23.4. SSO Configuration Examples">"SSO Configuration Examples"</a>. The examples include both filter and SLS
configuration.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_special_characters_encoding_issues"></a>23.3.3. Special Characters / Encoding Issues</h3></div></div></div><p>Especially in cases where the SLS which performs the login and creates the
propagated header, and the application with the filter are not running on the
same platform / OS, problems may arise with headers containing special
characters. In that case, it is recommended to ensure the usage of the same
default encoding <span class="emphasis"><em>in both JVMs</em></span> (SLS and application server), by setting this
JVM startup option:</p><pre class="screen">-Dfile.encoding=&lt;encoding&gt;</pre><p>Where <code class="literal"><span class="emphasis"><em>&lt;encoding&gt;</em></span></code> is a value like "<code class="literal">UTF-8</code>" or "<code class="literal">UTF-16</code>".</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_apache_commons_logging_dependency"></a>23.3.4. Apache Commons Logging Dependency</h3></div></div></div><p>The filters provided by USP employ Apache’s Commons Logging API for their
logging functionality. The library is included in the delivery of each filter
for convenience.</p><p><span class="emphasis"><em>NOTE: The commons logging library may already be available in your servlet
container of choice. In that case, it may not be advisable to deploy the
<code class="literal">commons-logging-&lt;version&gt;.jar</code> file, or classloader issues may occur
(especially if the library version provided by the container differs from the
one in the filter delivery).</em></span></p><p><span class="strong"><strong>Commons Logging Configuration</strong></span></p><p>A general way to enable the Commons Logging mechanism and have simple debug
logs written to standard output would be by setting these two system properties,
usually as Java VM parameters:</p><pre class="screen">-Dorg.apache.commons.logging.Log=org.apache.commons.logging.impl.SimpleLog
-Dorg.apache.commons.logging.simplelog.defaultlog=trace</pre><p>This results in a lot of debug logging information in one of the Tomcat log files;
which one depends on the logging configuration of Tomcat. A typical default is
the file "localhost.&lt;timestamp&gt;.log".</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="x58635_Heading3Tarsec_Filter_Settings_Reference"></a>23.3.5. Filter Settings Reference</h3></div></div></div><p><span class="strong"><strong><code class="literal">mode</code></strong></span></p><p><span class="emphasis"><em>(Optional)</em></span> Allows to choose the type of authentication used. The following
types are available:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">plaintext</code> - The header just contains the plain user ID
</li><li class="listitem">
<code class="literal">regex</code> - The header contains some key-/value pairs, optionally with a
  timestamp and a signature. A regular expression must be defined to extract the
  user ID then. For example, for a header like:
</li></ul></div><pre class="screen">roid=123456;LoginKennung=Hugo;[SourceIP=172.130.4.101];</pre><p>a regex to parse "<code class="literal">Hugo</code>" as user name would be:</p><pre class="screen">regex=.*LoginKennung=([a-zA-Z]*);.*</pre><p>The regex mode also supports the possibility of verifiying a signature included
in the header. For using that, several configuration properties are needed (see
"<code class="literal">keyIndexFile</code>", "<code class="literal">checksign</code>" and "<code class="literal">signkeyid</code>").</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">sesticket</code> - The header contains an SES ticket.
</li></ul></div><p>Default is "<code class="literal">plaintext</code>".</p><p><span class="strong"><strong><code class="literal">headerName</code></strong></span></p><p>The name of the header to get the user credential information. This is the HTTP
SSO header propagated from the SLS which contains either just the user ID (if
"<code class="literal">mode</code>" = "<code class="literal">plaintext</code>"), or a list of key-/value pairs (if "<code class="literal">mode</code>" =
"<code class="literal">regex</code>") or an SES ticket (if "<code class="literal">mode</code>" = " <code class="literal">sesticket</code>").</p><p>Default is "<code class="literal">userinfo</code>".</p><p><span class="strong"><strong><code class="literal">requireValidUser</code></strong></span></p><p><span class="emphasis"><em>(Optional)</em></span> If the filter should enforce authentication and enforce an error if
a user is not authenticated. Set this property to "<code class="literal">false</code>" to disable this
behaviour.</p><p>Default is "<code class="literal">true".</code></p><p><span class="strong"><strong><code class="literal">checktimestamp</code></strong></span></p><p><span class="emphasis"><em>(Optional)</em></span> Can only be used with "<code class="literal">mode</code>" = "<code class="literal">regex</code>". If set to "<code class="literal">true</code>", the
filter will check the timestamp in the "<code class="literal">Timestamp=</code>"-key using the configured
"<code class="literal">threshold</code>". This is basically an expiration check, used to prevent replay
attacks. Note that if this option is used, the SLS must be configured
correspondingly to actually create a "<code class="literal">Timestamp=</code>"-key in the propagated custom
header.</p><p>Default is <code class="literal">"false".</code></p><p><span class="strong"><strong><code class="literal">threshold</code></strong></span></p><p><span class="emphasis"><em>(Optional)</em></span> Defines the expiration threshold in number of seconds, if
"<code class="literal">checktimestamp</code>" = "<code class="literal">true</code>".</p><p><span class="strong"><strong><code class="literal">denyResponseCode</code></strong></span></p><p>The HTTP response code to send to the client if access is denied.</p><p>Default is "<code class="literal">401</code>".</p><p><span class="strong"><strong><code class="literal">denyResponseMessage</code></strong></span></p><p>The HTTP response message to send to the client if access is denied.</p><p><span class="strong"><strong><code class="literal">keyIndexFile</code></strong></span></p><p><span class="emphasis"><em>(Optional)</em></span> Required if (a) "<code class="literal">mode</code>" = "<code class="literal">sesticket</code>", or (b) "<code class="literal">mode</code>" =
"<code class="literal">regex</code>" and "<code class="literal">checksign</code>" = "<code class="literal">true</code>". This key index file contains the path of
the public key required to verify the ticket or the regex signature, and
optionally the path to the encryption key required to decrypt a ticket.</p><p>Example Tomcat Authenticator:</p><pre class="programlisting">authentication.keyIndexFile=/var/list.keyindex</pre><p>Example J2EE Filter:</p><pre class="screen">&lt;init-param&gt;
  &lt;param-name&gt;keyIndexFile&lt;/param-name&gt;
  &lt;param-value&gt;/var/list.keyindex&lt;/param-value&gt;
&lt;/init-param&gt;</pre><p><span class="strong"><strong><code class="literal">regex</code></strong></span></p><p><span class="emphasis"><em>(Optional)</em></span> If "<code class="literal">mode</code>" = "<code class="literal">regex</code>", this parameter defines the regular
expression required to parse the user ID from the header.</p><p><span class="strong"><strong><code class="literal">checksign</code></strong></span></p><p><span class="emphasis"><em>(Optional)</em></span> Can be used only if "<code class="literal">mode</code>" = "<code class="literal">regex</code>". If set to "<code class="literal">true</code>", the
filter will verify the signature (key: "<code class="literal">Signature=</code>") in the header.</p><p>Default is <code class="literal">"false".</code></p><p><span class="strong"><strong><code class="literal">signkeyid</code></strong></span></p><p><span class="emphasis"><em>(Optional)</em></span> If "<code class="literal">checksign</code>" is set to "<code class="literal">true</code>", this parameter must be set to
define the ID of the public key used to verify the signature. This is the ID of
the key in the key index file configured with "<code class="literal">keyIndexFile</code>".</p><p>Example Tomcat Authenticator:</p><pre class="programlisting">authentication.signkey=key_2</pre><p>Example J2EE Filter:</p><pre class="screen">&lt;init-param&gt;
  &lt;param-name&gt;signkeyid&lt;/param-name&gt;
  &lt;param-value&gt;key_2&lt;/param-value&gt;
&lt;/init-param&gt;</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_retrieval_of_custom_attributes_from_the_principal"></a>23.3.6. Retrieval of custom attributes from the principal</h3></div></div></div><p>The application might need to retrieve further information from the principal
and not only the principal name. In this case, all needed information should be
added to the userdata header configured in SLS.</p><p>The authenticator will store all key-value pairs from this header in the
principal and make them available for a later retrieval by the application.</p><p>The application can access these values by casting the principal to the
following interface, which defines the customized principal with the added
key-value-pair store and retrieval capability:</p><pre class="screen">com.usp.sls.appserver.base.IExtendedPrincipal</pre><p>This class is an extension of the standard principal class
<code class="literal">java.security.Principal</code>. Now the proprietary method</p><pre class="screen">getValue(&lt;key&gt;)</pre><p>of the casted object instance can be called to retrieve a value. For example, if
the following header was configured in the SLS:</p><pre class="programlisting">app.header.userinfo=${function.addSigAndTime('LoginKennung=' + session.getCred('username') + ';SrcIP=' + header.hsp_client_addr + ';' )}</pre><p>Then the value of the source IP from the application could be retrieved  in the
following way:</p><pre class="screen">((com.usp.sls.appserver.base.IExtendedPrincipal)request.getUserPrincipal()).getValue("SrcIP");</pre><p>The same can be applied to all key-value pairs defined in the configuration file
of the SLS.</p><p>Please note that, in order to be able to use this feature, it is mandatory  to
configure the header key-value pairs (in the SLS properties file) in the
following format:</p><pre class="screen">...some content...;&lt;key&gt;=&lt;value&gt;;...more content...</pre><p>A semicolon must be used to separate each key-value pair from the other ones and
from the rest of the header. And an equal sign must separate the value and the
corresponding key.</p><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="_compile_classpath"></a>Compile Classpath</h4></div></div></div><p>In order to be able to compile your application code when using this feature
(cast to <code class="literal">IExtendedPrincipal</code>), the jar file of the filter in question (J2EE,
Tomcat Authenticator…) has to be added to the development environment
classpath, which is one of the following files:</p><pre class="screen">usp-j2ee-filter-&lt;version&gt;.jar
usp-tomcat-authenticator-&lt;version&gt;.jar</pre><p>At runtime, the jar is already available, since it must be added in the
container classpath when configuring the filter.</p></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_j2ee_authentication_filter"></a>23.3.7. J2EE Authentication Filter</h3></div></div></div><p>The J2EE filter provides the means to easily integrate J2EE applications with a
HSP (Secure Entry Server) environment. It allows to use either a SES ticket, a
plain text header or a header consisting of custom key-/value-pair strings to
map the username to. The extracted credentials are then made available to the
application through the following standard servlet API methods:</p><pre class="screen">javax.servlet.http.HttpServletRequest

java.lang.String getRemoteUser()</pre><p>Returns the login of the user making this request,</p><p>if the user has been authenticated, or null if the user has</p><p>not been authenticated.</p><pre class="screen">java.security.Principal         getUserPrincipal()</pre><p>Returns a java.security.Principal object containing the name of</p><p>the current authenticated user.</p><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="_usage"></a>Usage</h4></div></div></div><p>In order to integrate a web application, you must follow several steps:</p><p>**</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">
To enable the servlet filter in your web application, add the following filter to your web.xml.
</li></ol></div><pre class="screen">&lt;!-- HSP authentication filter --&gt;
&lt;filter&gt;
&lt;filter-name&gt;AuthenticationFilter&lt;/filter-name&gt;
&lt;filter-class&gt;com.usp.ses.authapi.AuthenticationFilter&lt;/filter-class&gt;
&lt;description&gt;This filter handles the user credentials.&lt;/description&gt;
...
&lt;init-param&gt;
&lt;param-name&gt;headerName&lt;/param-name&gt;
&lt;param-value&gt;&lt;/param-value&gt;
&lt;/init-param&gt;
...
&lt;/filter&gt;

&lt;filter-mapping&gt;
&lt;filter-name&gt;AuthenticationFilter&lt;/filter-name&gt;
&lt;url-pattern&gt;/*&lt;/url-pattern&gt;
&lt;/filter-mapping&gt;</pre><p>Copy the filter jar files into the applications\' "WEB-INF/lib" directory. The filter jar files can be found in this delivery subdirectory:</p><pre class="screen">/appserver/j2ee-filter/libs/</pre></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="_configuration_2"></a>Configuration</h4></div></div></div><p>All the settings listed in <a class="link" href="#x58635_Heading3Tarsec_Filter_Settings_Reference" title="23.3.5. Filter Settings Reference">"Filter Settings Reference"</a> can be used as "<code class="literal">init-param</code>"-values. Example:</p><pre class="screen">&lt;init-param&gt;
&lt;param-name&gt;mode&lt;/param-name&gt;
&lt;param-name&gt;regex&lt;/param-name&gt;
&lt;/init-param&gt;</pre></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_tomcat_authenticator_module"></a>23.3.8. Tomcat Authenticator Module</h3></div></div></div><p>The Apache Tomcat servlet container supports a proprietary filtering mechanism
called "Authenticators". An authenticator basically has a similar job as a
servlet filter, the main difference being the fact that it works server-wide,
for all applications deployed in that container. Hence, it is configured in the
Tomcat container itself, not in each applications "<code class="literal">web.xml</code>" file (see
<a class="link" href="#x16224_Heading4Tarsec_Step_for_Step_Installation_Notes" title="Step by Step Installation Notes">"Step by Step Installation Notes"</a> for details).</p><p><span class="emphasis"><em>Note: The JAAS module contained in the SLS Tomcat Authenticator delivery is a
requirement by the authenticator, but cannot be used in any other context.</em></span></p><p>The SLS "Tomcat Authenticator" allows to use either a SES ticket, a plain text
header or a header consisting of custom key-/value-pair strings to map the
username to. The credentials are then made available to the application through
the same servlet API methods as with the J2EE servlet filter (see
<a class="link" href="#x62555_Heading2Tarsec_J2EE_Authentication_Filter" title="23.3. SSO Request Filters">"SSO Request Filters"</a>).</p><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="x16224_Heading4Tarsec_Step_for_Step_Installation_Notes"></a>Step by Step Installation Notes</h4></div></div></div><p>First you have to patch Tomcat with a new Authenticator.</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
Unpack the original "<code class="literal">catalina.jar</code>" file
</li></ul></div><p>The exact location of the file depends on the Tomcat version:</p><p><span class="strong"><strong><span class="emphasis"><em>Tomcat 5.5</em></span></strong></span></p><p>Unpack <code class="literal">$CATALINA_HOME/server/lib/catalina.jar</code> into the <code class="literal">server/classes</code>
directory.</p><p><span class="strong"><strong><span class="emphasis"><em>Tomcat 6.0, 7.0, and 8.0</em></span></strong></span></p><p>Unpack <code class="literal">$CATALINA_HOME/lib/catalina.jar</code> into the <code class="literal">$CATALINA_HOME/lib</code>
directory.</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
Replace the original "<code class="literal">Authenticators.properties</code>" file:
</li></ul></div><p>Replace the file "<code class="literal">Authenticators.properties</code>" with the extended version found
in the SLS delivery directory:</p><p><span class="strong"><strong><span class="emphasis"><em>Tomcat 5.5 and 6.0</em></span></strong></span></p><p><code class="literal">appserver/tomcat-authenticator/tomcat55+6/conf/</code></p><p><span class="strong"><strong><span class="emphasis"><em>Tomcat 7.0</em></span></strong></span></p><p><code class="literal">appserver/tomcat-authenticator/tomcat7/conf/</code></p><p><span class="strong"><strong><span class="emphasis"><em>Tomcat 8.0</em></span></strong></span></p><p><code class="literal">appserver/tomcat-authenticator/tomcat8/conf/</code></p><p>The location of the file to replace depends on the Tomcat version:</p><p><span class="strong"><strong><span class="emphasis"><em>Tomcat 5.5</em></span></strong></span></p><p><code class="literal">$CATALINA_HOME/server/classes/org/apache/catalina/startup/Authenticators.properties</code></p><p><span class="strong"><strong><span class="emphasis"><em>Tomcat 6.0, 7.0, and 8.0</em></span></strong></span></p><p><code class="literal">$CATALINA_HOME/lib/org/apache/catalina/startup/Authenticators.properties</code></p><p>The unpacked "<code class="literal">catalina.jar</code>" file can be removed.</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
Install the new authenticator JAR file
</li></ul></div><p>The JAR file to copy depends on the Tomcat version:</p><p><span class="strong"><strong><span class="emphasis"><em>Tomcat 5.5 and 6.0</em></span></strong></span></p><p>Copy <code class="literal">usp-tomcat-authenticator-&lt;version&gt;.jar</code> to the Tomcat "<code class="literal">lib</code>" directory.</p><p><span class="strong"><strong><span class="emphasis"><em>Tomcat 7.0</em></span></strong></span></p><p>Copy <code class="literal">usp-tomcat7-authenticator-&lt;version&gt;.jar</code> to the Tomcat "<code class="literal">lib</code>" directory.</p><p><span class="strong"><strong><span class="emphasis"><em>Tomcat 8.0</em></span></strong></span></p><p>Copy <code class="literal">usp-tomcat8-authenticator-&lt;version&gt;.jar</code> to the Tomcat "<code class="literal">lib</code>" directory.</p><p>The location of the "<code class="literal">lib</code>" directory depends on the Tomcat version:</p><p><span class="strong"><strong><span class="emphasis"><em>Tomcat 5.5</em></span></strong></span></p><p><code class="literal">$CATALINA_HOME/server/lib</code></p><p><span class="strong"><strong><span class="emphasis"><em>Tomcat 6.0, 7.0, and 8.0</em></span></strong></span></p><p><code class="literal">$CATALINA_HOME/lib</code></p><p><span class="strong"><strong>Upgrading An Old Release</strong></span></p><p>Note: In previous releases, the authenticator also required to copy two files
named "<code class="literal">ses-ticket-*.jar</code>" and "<code class="literal">jaas-\*.jar</code>" into the Tomcat lib directory.
The content of these jar files has now been included directly into the
authenticator jar file, so there is now only one single jar file that must be
installed.</p><p><span class="emphasis"><em>IMPORTANT: Delete existing jar files "<code class="literal">ses-ticket-*.jar</code>" and/or
"<code class="literal">jaas-\*.jar"</code> from the "<code class="literal">lib</code>" directory in case they are there.</em></span></p><p><span class="strong"><strong>Servlet Filter Libraries</strong></span></p><p>Make sure that the application does not have the USP J2EE filter library in
it's own "<code class="literal">lib</code>" directory, or there will be classloader issues.</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
Prepare Java VM strong cryptography
</li></ul></div><p>First, in order to enable strong authentication without any limitations in
regard to key sizes, the "Unlimited Jurisdiction Strength Policy" files must be
installed in the Java VM. Please consult the download pages and instructions of
the JVM provider for details.</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
Enabling SLS JAAS module
</li></ul></div><p>Next you have to install the USP JAAS module. To enable JAAS, add the following
to <code class="literal">$CATALINA_BASE/conf/server.xml:</code></p><pre class="screen">&lt;Realm className="org.apache.catalina.realm.JAASRealm"
appName="SES"
userClassNames="com.usp.sls.appserver.jaas.UserPrincipalImpl"
roleClassNames="com.usp.sls.appserver.jaas.RolePrincipalImpl" /&gt;</pre><p>Make sure the "<code class="literal">&lt;Realm&gt;</code>"-tag is a direct child of the "<code class="literal">&lt;Engine&gt;</code>"-tag.</p><p><span class="emphasis"><em>Also, make sure there are no other "<code class="literal">&lt;Realm&gt;</code>"-tags configured that may have
side-effects, and even deny access for users that would be allowed by the USP
Tomcat Authenticator.</em></span></p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
Configure the JAAS module
</li></ul></div><p>Copy <code class="literal">"jaas.conf</code>" to "<code class="literal">$CATALINA_BASE/conf/".+The path to "+jaas.conf</code>" must be
given to Tomcat in the form of a java system property. i.e. add to
<code class="literal">$CATALINA_BASE/bin/setenv.sh</code>:</p><pre class="screen">JAVA_OPTS="$JAVA_OPTS -Djava.security.auth.login.config=$CATALINA_BASE/conf/jaas.conf"</pre><p><a id="x17424_Sidehead_BoldTarsec_Tomcat_as_a_Windows_Service"></a><span class="strong"><strong>Tomcat as a Windows Service</strong></span></p><p>Note: On a Windows System, setting environment variables the usual way won't
impact a Windows Service, because every service runs in an own environment.
Therefore, if the Tomcat container is run as a Windows Service, the startup
system properties must be set through the "<code class="literal">Properties</code>" dialog of that service,
in the "<code class="literal">Java</code>" tab.</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
Configure Tomcat Container, or the web application
</li></ul></div><p>At last, you have to configure either Tomcat, or the web application. Add
security constraint, role and auth method to the <code class="literal">web.xml</code> file of the
web-application ("<code class="literal">webapps/…/WEB-INF/web.xml</code>") or Tomcat ("<code class="literal">conf/web.xml</code>"):</p><pre class="screen">&lt;security-constraint&gt;
&lt;web-resource-collection&gt;
&lt;web-resource-name&gt;all&lt;/web-resource-name&gt;
&lt;url-pattern&gt;/\*&lt;/url-pattern&gt;
&lt;http-method&gt;POST&lt;/http-method&gt;
&lt;http-method&gt;GET&lt;/http-method&gt;
&lt;/web-resource-collection&gt;

&lt;auth-constraint&gt;
&lt;role-name&gt;role&lt;/role-name&gt;
&lt;/auth-constraint&gt;

&lt;/security-constraint&gt;

&lt;security-role&gt;
&lt;description&gt;unique role&lt;/description&gt;
&lt;role-name&gt;role&lt;/role-name&gt;
&lt;/security-role&gt;

&lt;login-config&gt;
&lt;auth-method&gt;SESTICKET&lt;/auth-method&gt;
&lt;realm-name&gt;any&lt;/realm-name&gt;
&lt;/login-config&gt;</pre><p>Note: If this configuration is added to the Tomcat "<code class="literal">web.xml</code>" file, just add it
at the beginning, right after the opening "<code class="literal">web-app</code>" XML tag.</p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="_configuration_of_tomcat_authenticator"></a>Configuration of Tomcat Authenticator</h4></div></div></div><p>The working mode of the authenticator has to be defined in a config file named
"<code class="literal">uspauth.properties</code>". The path of this configuration file should be set with
this JVM startup system property:</p><p><code class="literal">JAVA_OPTS=$JAVA_OPTS -Dcom.usp.sls.authenticator.configfile=$CATALINA_BASE/conf/uspauth.properties</code></p><p><span class="emphasis"><em>See <a class="link" href="#x17424_Sidehead_BoldTarsec_Tomcat_as_a_Windows_Service">"Tomcat as a Windows Service"</a>
for details on how to set these properties for a Tomcat running as Windows Service.</em></span></p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="_configuration_properties_4"></a>Configuration Properties</h4></div></div></div><p>There are several configuration properties.  The name of each property consists
of the prefix "<code class="literal">authentication.</code>" and the name of one of the settings listed in
<a class="link" href="#x58635_Heading3Tarsec_Filter_Settings_Reference" title="23.3.5. Filter Settings Reference">"Filter Settings Reference"</a>.</p><p>So, for example, to set the authentication mode to regex, set:</p><pre class="programlisting">authentication.mode=regex</pre><p>Authenticator looks for the configuration file at the following paths, in strict
order:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">
You can set a Java system property when starting Tomcat:

<code class="literal">com.usp.sls.authenticator.configfile=<span class="emphasis"><em>&lt;path&gt;</em></span></code>
</li><li class="listitem">
If the Java system property for <code class="literal">$CATALINA_HOME</code> is set (which usually is the
case with any regular Tomcat instance):
<code class="literal">$CATALINA_HOME/conf/uspauth.properties</code>
</li><li class="listitem">
At the current working directory path, which usually is <code class="literal">$CATALINA_BASE</code> or
<code class="literal">$CATALINA_BASE/bin</code>, depending on how exactly the Tomcat instance was started:
<code class="literal"><span class="emphasis"><em>&lt;currentdir&gt;</em></span>/uspauth.properties</code>
</li></ol></div><p><span class="strong"><strong><span class="emphasis"><em>Tomcat 7.0 only</em></span></strong></span></p><p>The setting <code class="literal">authenticator.authmethod</code> allows to set the value returned by the
getAuthMechanism() method of the Tomcat 7 Authenticator. Default if not
indicated is "SESTICKET".</p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="_authenticator_logging"></a>Authenticator Logging</h4></div></div></div><p>The Authenticator uses the "Apache Commons Logging" API, which, by default, will
output log into the standard output (the "<code class="literal">catalina.out</code>" file in a Tomcat
server).</p><p>In order to enable more detailled logs, the following property should be added
to the file "<code class="literal">logging.properties</code>" in the "<code class="literal">conf</code>" directory of the Tomcat
instance:</p><pre class="programlisting">com.usp.sls.appserver.level = FINE</pre><p>It's not important where in the file the property is inserted. Just set the
level back to INFO (or remove the property) once debugging is not necessary
anymore.</p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="_authenticator_logging_with_log4j"></a>Authenticator Logging with Log4J</h4></div></div></div><p>Since the "Apache Commons Logging" API also uses Log4J if it's available in the
JVM, it is also an option to add the Log4J libraries to the Tomcat lib
directory, and then configure a Log4J appender (as usual with Log4J, the
configuration file must be somewhere in the root of the classpath to be found):</p><pre class="screen">&lt;appender name="AUTHENTICATOR_LOG"
class="org.apache.log4j.DailyRollingFileAppender"&gt;
&lt;param name="Threshold" value="TRACE" /&gt;
&lt;param name="datePattern" value="\'.\'yyyy-MM-dd" /&gt;
&lt;param name="file" value="${catalina.base}/logs/authent.log" /&gt;
&lt;param name="Append" value="true" /&gt;
&lt;layout class="org.apache.log4j.PatternLayout"&gt;
&lt;param name="ConversionPattern"
value="%d %-5p %c:%M() %m%n" /&gt;
&lt;/layout&gt;
&lt;/appender&gt;

&lt;logger name="com.usp"&gt;
&lt;level value="TRACE" /&gt;
&lt;appender-ref ref="AUTHENTICATOR_LOG" /&gt;
&lt;/logger&gt;</pre></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="x66726_Heading2Tarsec_SSO_Configuration_Examples"></a>23.4. SSO Configuration Examples</h2></div></div></div><p>The following examples show different authentication mode scenarios, and what to
configure. This includes the SLS configuration in the "<code class="literal">sls.properties</code>" file
(for creating the header) and filter configuration (for processing it).</p><p>The following configuration files correspond to the component in the left
column:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
SLS - "<code class="literal">WEB-INF/sls.properties</code>"
</li><li class="listitem">
J2EE filter - "<code class="literal">&lt;filter&gt;</code>"-tag in "<code class="literal">web.xml</code>"-file of application
</li><li class="listitem">
Authenticator - "<code class="literal">uspauth.properties</code>" file in Tomcat
</li></ul></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_example_plaintext_mode"></a>23.4.1. Example: "plaintext" mode</h3></div></div></div><p>A custom header named "username" shall be propagated to the application. The
header is supposed to contain just the plain user ID.</p><p><span class="strong"><strong><span class="emphasis"><em>SLS</em></span></strong></span></p><p><code class="literal">app.header.username=${session.getCred(<span class="emphasis"><em>username</em></span>)}</code></p><p><span class="strong"><strong><span class="emphasis"><em>J2EE filter</em></span></strong></span></p><pre class="screen">&lt;init-param&gt;
&lt;param-name&gt;mode&lt;/param-name&gt;
&lt;param-value&gt;plaintext&lt;/param-value&gt;
&lt;/init-param&gt;
&lt;!--Optional (because "username" is default) --&gt;
&lt;init-param&gt;
&lt;param-name&gt;headerName&lt;/param-name&gt;
&lt;param-value&gt;username&lt;/param-value&gt;
&lt;/init-param&gt;</pre><p><span class="strong"><strong><span class="emphasis"><em>Tomcat Authenticator</em></span></strong></span></p><pre class="programlisting">authentication.mode=plaintext
# Optional (because "username" is default)
authentication.headerName=username</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_example_regex_mode"></a>23.4.2. Example: "regex" mode</h3></div></div></div><p>A header named "<code class="literal">userinfo</code>" containing various key-/value pairs with user
information should be created. One of the fields, "<code class="literal">loginName</code>", contains the
user ID. The header should also be signed and have a timestamp with a 4 hour
(14400 seconds) expiration time.</p><p><span class="strong"><strong>Signature Keys</strong></span></p><p>Note: This example assumes that there are "SES Ticket API" keys available, an
RSA public and private key pair. Each key is referenced in the index file (which
is a simple text file) "<code class="literal">list.keyindex</code>", which must be available on both the
SLS and the application server.</p><p>On the SLS, the file must contain the path of the private key with the alias
"<code class="literal">key_1</code>", on the application server it must hold the path of the public key
with the alias "<code class="literal">key_2</code>".</p><p>Please see <a class="link" href="#x66021_Heading1Tarsec_SES_Login_Ticket" title="Chapter 30. SES Login Ticket">"26 SES Login Ticket"</a>for
more information about SES Ticket API functionality in general, or
<a class="link" href="#x97591_Heading2Tarsec_SES_Ticket_API_Tool" title="39.4. SES Ticket API Tool">"SES Ticket API Tool"</a>
for information about how to create your own keys and key index files.</p><p><span class="strong"><strong><span class="emphasis"><em>SLS</em></span></strong></span></p><pre class="programlisting">app.header.userinfo=${function.addSigAndTime( + 'loginName=' + session.getCred('username') + ';SrcIP=' + header.hsp_client_addr + ';' )}</pre><p>This property configures the HTTP header "<code class="literal">userinfo</code>" to be propagated to the
application. The value of the header will be a key-/value pair string:</p><pre class="screen">loginName=&lt;loginName&gt;;SrcIP=&lt;Client-IP&gt;;sig=&lt;sig&gt;</pre><p>Where <code class="literal"><span class="emphasis"><em>&lt;loginName&gt;</em></span></code> contains the user’s login ID, <code class="literal"><span class="emphasis"><em>&lt;Client-IP&gt;</em></span></code> the IP
address of the browser client, and <code class="literal"><span class="emphasis"><em>&lt;sig&gt;</em></span></code> is the actual signature and a
timestamp, created by the JEXL function "<code class="literal">addSigAndTime()</code>".</p><p>The following properties are required to configure the private key with the
alias "<code class="literal">key_1</code>" defined in the index file "<code class="literal">list.keyindex</code>" to create the
signature:</p><pre class="programlisting">ses.ticketapi.keyIndexFile=/var/list.keyindex
ses.ticketapi.keyId=key_1</pre><p>Without these two properties, the JEXL function "<code class="literal">addSigAndTime()</code>" will fail
with a runtime error message!</p><p><span class="strong"><strong><span class="emphasis"><em>J2EE filter</em></span></strong></span></p><pre class="screen">&lt;init-param&gt;
&lt;param-name&gt;_mode_&lt;/param-name&gt;
&lt;param-value&gt;regex&lt;/param-value&gt;
&lt;/init-param&gt;
&lt;init-param&gt;
&lt;param-name&gt;_headerName_&lt;/param-name&gt;
&lt;param-value&gt;_userinfo_&lt;/param-value&gt;
&lt;/init-param&gt;
&lt;init-param&gt;
&lt;param-name&gt;regex&lt;/param-name&gt;
&lt;param-value&gt;.\*loginName=([a-zA-Z]\*);.*&lt;/param-value&gt;
&lt;/init-param&gt;
&lt;init-param&gt;
&lt;param-name&gt;keyIndexFile&lt;/param-name&gt;
&lt;param-value&gt;/var/list.keyindex&lt;/param-value&gt;
&lt;/init-param&gt;
&lt;init-param&gt;
&lt;param-name&gt;signkeyid&lt;/param-name&gt;
&lt;param-value&gt;key_2&lt;/param-value&gt;
&lt;/init-param&gt;
&lt;init-param&gt;
&lt;param-name&gt;checksign&lt;/param-name&gt;
&lt;param-value&gt;true&lt;/param-value&gt;
&lt;/init-param&gt;
&lt;init-param&gt;
&lt;param-name&gt;checktimestamp&lt;/param-name&gt;
&lt;param-value&gt;true&lt;/param-value&gt;
&lt;/init-param&gt;
&lt;init-param&gt;
&lt;param-name&gt;threshold&lt;/param-name&gt;
&lt;param-value&gt;14400&lt;/param-value&gt;
&lt;/init-param&gt;</pre><p><span class="strong"><strong><span class="emphasis"><em>Tomcat Authenticator</em></span></strong></span></p><pre class="programlisting">authentication.mode=regex
authentication.headerName=userinfo
authentication.regex=.*loginName=([a-zA-Z]*);.*
authentication.keyIndexFile=/var/list.keyindex
authentication.signkeyid=key_2
authentication.checksign=true
authentication.checktimestamp=true
authentication.threshold=14400</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_example_sesticket_mode"></a>23.4.3. Example: "sesticket" mode</h3></div></div></div><p>A header named "<code class="literal">sesticket</code>" containing a SES ticket should be created. The
ticket should have an expiration time of 4 hours.</p><p><span class="strong"><strong><span class="emphasis"><em>SLS</em></span></strong></span></p><pre class="programlisting">ses.ticket.One.realm=ACME Corp.
ses.ticket.One.lifetime=14400
ses.ticket.One.keyIndexFile=/var/list.keyindex
ses.ticket.One.public.key=key_2
ses.ticket.One.private.key=key_1
ses.ticket.One.attr.userid=${function.getVerifiedCred('username')}

app.header.sesticket=${function.createTicket('One',function.getCred('username'))}</pre><p><span class="strong"><strong><span class="emphasis"><em>J2EE filter</em></span></strong></span></p><pre class="programlisting">&lt;init-param&gt;
  &lt;param-name&gt;mode&lt;/param-name&gt;
  &lt;param-value&gt;sesticket&lt;/param-value&gt;
&lt;/init-param&gt;
&lt;init-param&gt;
  &lt;param-name&gt;headerName&lt;/param-name&gt;
  &lt;param-value&gt;sesticket&lt;/param-value&gt;
&lt;/init-param&gt;
&lt;init-param&gt;
  &lt;param-name&gt;keyIndexFile&lt;/param-name&gt;
  &lt;param-value&gt;/var/list.keyindex&lt;/param-value&gt;
&lt;/init-param&gt;</pre><p><span class="strong"><strong><span class="emphasis"><em>Tomcat Authenticator</em></span></strong></span></p><pre class="programlisting">authentication.mode=sesticket
authentication.headerName=sesticket
authentication.keyIndexFile=/var/list.keyindex</pre><p>Please read chapter <a class="link" href="#x66021_Heading1Tarsec_SES_Login_Ticket" title="Chapter 30. SES Login Ticket">"SES Login Ticket"</a> for detailed information about SES tickets.</p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="x97662_Heading2Tarsec_Application_Server"></a>23.5. Application Server Authentication</h2></div></div></div><p>If a user is authenticated by the SLS and then redirected to the application server, it is necessary to make the authentication information (such as user ID) available to the application.</p><p>Also, in some cases, the application server itself may already use basic or FORM-based authentication as a means to identify the client. the HSP provides the required functionality to integrate such an application server with an SLS authentication process, completely transparent to the end-user. This is called the "AAI" (Adaptive Application Integrator). This AAI feature in the HSP can basically do the following:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
After a client was successfully authenticated by the SLS, the HSP retrieves some information about the user credentials from the SLS's response.
</li><li class="listitem">
The HSP will then fill in the login form sent from the application server or perform basic authentication if necessary, using the credentials received from the SLS. This requires both some configuration in the HSP (see <a class="link" href="#HTTPADMIN">[HTTPADMIN]</a>) and in the SLS configuration ("<code class="literal">sls.properties</code>").
</li></ul></div><p>The HSP supports the following types of back-end authentication:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
Basic Auth - The application server required HTTP basic authentication)
</li><li class="listitem">
NTLM - The application server, usually a Microsoft IIS, authenticates the client through an NTLM handshake)
</li><li class="listitem">
Form - The application server sends a HTML login page which is filled in by the HSP automatically.
</li></ul></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="x72488_Heading2Tarsec_Authentication_Schemes"></a>23.5.1. Authentication Schemes</h3></div></div></div><p>If the application server is configured to identify clients through HTTP basic authentication, the HSP must send the required HTTP headers to the application server once the SLS has authenticated the user.</p><p>If the application server uses a custom HTML login form, the HSP must fill in the correct values into that login form and post it to the application server (completely transparent to the client browser) once the SLS has successfully authenticated the user.</p><p>In both cases, the SLS must send certain login information to the HSP after a successful login in order to enable the HSP to perform the automatic basic or form authentication against the application server.</p><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="_supporting_both_schemes"></a>Supporting Both Schemes</h4></div></div></div><p>Setting the property "<code class="literal">auth.type</code>" to "<code class="literal">all</code>" will let the SLS set the headers for both authentication schemes, basic auth and FORM-based.</p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="_basic_authentication_only"></a>Basic Authentication Only</h4></div></div></div><p>The SLS can trigger the HSP to send headers for basic authentication by setting this property:</p><pre class="programlisting">auth.type=basic</pre></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="x43582_Heading4Tarsec_FORM_based_Authentication_Only"></a>FORM-based Authentication Only</h4></div></div></div><p>The SLS can trigger the HSP to transparently fill in any login forms sent by the application servers by setting this property:</p><pre class="programlisting">auth.type=form</pre><p><span class="emphasis"><em>Note that it is also necessary to add appropriate AAI configuration statements in the HSP configuration (see <a class="link" href="#HTTPADMIN">[HTTPADMIN]</a>).</em></span></p><p>The names of the parameters as sent from the SLS to the HSP are defined as follows (and must be configured accordingly in the HSP):</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
Login username: "<code class="literal">FormUserName</code>"
</li><li class="listitem">
Login password: "<code class="literal">FormPassword</code>"
</li></ul></div><p>Any additional login-page form parameter that should be sent to the  backend servers in the FORM-based authentication must be defined with a property like this:</p><pre class="programlisting">formauth.parameter.&lt;name for HSP&gt;=&lt;field name in the login form&gt;</pre><p>In order to avoid confusion, both names should preferably be equal, like in this example:</p><pre class="programlisting">formauth.parameter.thirdCred=thirdCred</pre></div></div></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="x75173_Heading1Tarsec_Cookies"></a>Chapter 24. Cookies</h2></div></div></div><p>This chapter covers everything related to the creation of cookies. The SLS itself creates some cookies by default during any login or other processes, while the creation of custom cookies can also be configured, if necessary.</p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_tomcat_cookie_compliance"></a>24.1. Tomcat Cookie Compliance</h2></div></div></div><p>Sometimes a version "0" cookie created by a web application (such as the SLS) running in a Tomcat container is turned into a version "1" cookie by Tomcat. See the FAQ, <a class="link" href="#x41547_Important_TextTarsec_Q_A_cookie_that_was_created_by_the_SLS">"Q: A cookie that was created by the SLS as a version 0 cookie …"</a> for some information on why and what to do about it.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_tomcat_double_cookie_issue"></a>24.2. Tomcat Double Cookie Issue</h2></div></div></div><p>Sometimes the SLS will set the language in the session more than once during one
request, depending on the flow of logic etc. In such a case, this may result in
the same language cookie appearing twice in the HTTP response. This seems to be
an issue of some servlet containers, namely Tomcat. In order to avoid this,
the following property can be set:</p><p><span class="strong"><strong><code class="literal">response.avoid.double.cookie</code></strong></span></p><p>If set to "true", the SLS-internal response wrapper will make sure that any
cookie is always set not more than once within one response.</p><pre class="programlisting">response.avoid.double.cookie=true</pre></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_sls_cookies_2"></a>24.3. SLS Cookies</h2></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_domain_issues"></a>24.3.1. Domain Issues</h3></div></div></div><p>Each time a cookie is created, it can optionally have a "domain" attribute set. For the cookies described below, that value can be set specifically, but usually that is not desirable.</p><p>If a domain must be set, the following property allows to define a default domain value for all created cookies:</p><p><span class="strong"><strong><code class="literal">default.cookie.domain</code></strong></span></p><p>The default domain for all cookies created by the SLS, if no other domain has been specified for them. Example:</p><pre class="programlisting">default.cookie.domain=acme.com</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_avoid_cookie_domains"></a>24.3.2. Avoid cookie domains</h3></div></div></div><div class="note" style="margin-left: 0; margin-right: 10%;"><h3 class="title">Note</h3><p>It is not recommended to set a domain for cookies, because this can cause unwanted maintenance efforts each time a hostname changes. The browser clients by default set the domain of the host which created a cookie for that cookie, so a changing host name does not require a configuration change in the SLS.</p></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="x92024_Heading3Tarsec_Language_Cookie"></a>24.3.3. Language Cookie</h3></div></div></div><p>The language cookie is a persistent cookie, which means it's meant to be stored on the client, and basically for an infinite amount of time. It stores the language preferred by the user (see <a class="link" href="#x18580_Heading2Tarsec_Selecting_User_Language" title="14.2. Selecting User Language">"Selecting User Language"</a>). The language cookie can be configured through the following properties in "<code class="literal">sls.properties</code>":</p><p><span class="strong"><strong><code class="literal">lang.default</code></strong></span></p><p>Defines the default language code to be used ("<code class="literal">en</code>" for english, "<code class="literal">de</code>" for german etc.). For a complete list of codes see</p><p><code class="literal">http://ftp.ics.uci.edu/pub/ietf/http/related/iso639.txt</code></p><p><span class="strong"><strong><code class="literal">lang.default.</code>+<span class="emphasis"><em>&lt;tenant&gt;</em></span>+</strong></span></p><p>Defines the default language code to be used ("<code class="literal">en</code>" for english, "<code class="literal">de</code>" for german etc.), but only for the given tenant. <code class="literal"><span class="emphasis"><em>&lt;tentant&gt;</em></span></code> is the alias of the tenant.</p><p><span class="strong"><strong><code class="literal">lang.cookie.domain</code></strong></span></p><p>Defines the domain of the language cookie. If none is defined, either the globally defined default domain is used. If that is not defined either, no domain is set (which is the recommended approach!).</p><p><span class="strong"><strong><code class="literal">lang.cookie.age</code></strong></span></p><p>Specifies the life span of the cookie in seconds. The default value is 3 years (3 \* 365 \* 24 \* 60 \* 60).</p><p><span class="strong"><strong><code class="literal">lang.cookie.path</code></strong></span></p><p>The path for which the cookie is valid.</p><p><span class="strong"><strong><code class="literal">lang.cookie.name</code></strong></span></p><p>The name of the language cookie. Mostly, you do not need to set this property and use the default name "<code class="literal">SLSLanguage</code>". Anyway, if you set a custom name for the language cookie, make sure to enable it as a transparent cookie in the HSP configuration.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="x18895_Heading3Tarsec_Preferences_Cookie"></a>24.3.4. Preferences Cookie</h3></div></div></div><p>The "preferences" cookie allows to store any kind of custom user preferences in a persistent cookie, similar to the language cookie. The idea is that values requested from the user in customized JSPs can be stored, and be used again in later login attempts (for example, the value of a slider-element that allows to change the visual size of some GUI element in the login page).</p><p>The source for preference values are request parameters, since any user preference must have been entered in some HTLM form and then be posted to the SLS. The following property defines from which parameters to store the values.</p><p><span class="strong"><strong><code class="literal">prefs.parameters</code></strong></span></p><p>1-n parameters as a comma-separated list of parameter names, for example:</p><pre class="programlisting">prefs.parameters=preferredColor,preferredSize</pre><p>The SLS will automatically update the cookie every time one of the defined parameters is posted again.</p><p><span class="strong"><strong><code class="literal">prefs.cookie.name</code></strong></span></p><p>The name of the preferences cookie. Defaults to "<code class="literal">SLSprefs</code>" if not defined.</p><p><span class="strong"><strong><code class="literal">prefs.cookie.domain</code></strong></span></p><p>Defines the domain of the preferences cookie. If none is defined, either the globally defined default domain is used. If that is not defined either, no domain is set (which is the recommended approach!).</p><p><span class="strong"><strong><code class="literal">prefs.cookie.age</code></strong></span></p><p>The lifetime for the cookie in seconds. Defaults to 1 year if not specified.</p><p><span class="strong"><strong><code class="literal">prefs.cookie.path</code></strong></span></p><p>The path for this cookie. Defaults to the SLS own context path if not set.</p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_using_stored_values"></a>24.4. Using stored values</h2></div></div></div><p>In order to make use of values stored in the preferences value in a customized JSP, the "<code class="literal">getJexl</code>" JSP tag can be used with the JEXL function "<code class="literal">getPreferenceValue</code>()".</p><p>The following sample JSP / HTML code shows how to insert the stored preference value "mySize" into the page:</p><pre class="screen">&lt;sls:getScript expression="${function.getPreferenceValue('mySize')}" /&gt;"</pre><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_user_info_cookie"></a>24.4.1. User-Info Cookie</h3></div></div></div><p>The SLS creates a cookie during an authentication process which holds information about the user. That cookie is NOT meant to be sent to the client, so it should NOT be configured as a transparent cookie in the HSP. It's lifespan is just as long as the HSP session, and it serves as a convenience mechanism for the SLS to store some user information retrieved during the login, just in case the user accessed the SLS again.</p><p>For example, if a logged-in user invokes the password change process and is presented the password-change-page, it would be nice if the username would already be filled in. But the SLS's own session had been invalidated at the end of the login process, so the SLS would not have any information present about the user at that time anymore.</p><p>At this point the SLS needs this cookie to retrieve the authenticated user's name from it and fill it into the form.</p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_custom_cookies"></a>24.5. Custom Cookies</h2></div></div></div><p>Custom cookies can be defined that should be created after a successful login. For each custom cookie, a set of properties must be defined in the "<code class="literal">sls.properties</code>" configuration file.</p><p>First, one property must define the names of the custom cookies to be created:</p><p><span class="strong"><strong><code class="literal">cookie.set.successful.name</code></strong></span></p><p>A comma-separated list of 1-n cookie names, for example:</p><pre class="programlisting">cookie.set.successful.name=MyCookie,SomeValues</pre><p>For each cookie defined in that list, a set of properties must then be defined:</p><p><span class="strong"><strong><code class="literal">cookie.&lt;name&gt;.value</code></strong></span></p><p>The value for that cookie (may contain JEXL expressions).</p><p><span class="strong"><strong><code class="literal">cookie.&lt;name&gt;.path</code></strong></span></p><p>Optional: The path for that cookie. Defaults to the SLS\' own context path if not defined.</p><p><span class="strong"><strong><code class="literal">cookie.&lt;name&gt;.domain</code></strong></span></p><p>Optional: Defines the domain of the cookie. If none is defined, either the globally defined default domain is used. If that is not defined either, no domain is set (which is the recommended approach!).</p><p><span class="strong"><strong><code class="literal">cookie.&lt;name&gt;.maxage</code></strong></span></p><p>Optional: Sets the "maxage"-attribute of the cookie. Defaults to "-1" if not set, which means the cookie expires once the connection to the client ends.</p><p><span class="strong"><strong><code class="literal">cookie.&lt;name&gt;.comment</code></strong></span></p><p>Optional: Sets the "comment"-attribute of the cookie.</p><p>For example:</p><pre class="programlisting">cookie.MyCookie.value=Name: ${parameter.userid}
cookie.MyCookie.maxage=50000</pre></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="x19283_Heading1Tarsec_Logging"></a>Chapter 25. Logging</h2></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_overview_8"></a>25.1. Overview</h2></div></div></div><p>The SLS uses a custom USP logging library which is based on Apache’s open-source logging facility
"Log4J 1.2.17" for all logging operations.</p><p><span class="strong"><strong><span class="emphasis"><em>NOTE</em></span></strong></span>: The logging library is based on the legacy Log4j 1.2.x library, which is officially end-of-life
as far as the Apache group is concerned. In order to make it unmistakeably clear that the library in the SLS
is NOT end-of-life, but maintained by USP, it has been renamed to "usp-logging". This is why the jar file is
named "usp-logging-*.jar", and the configuration file "usp-logging.xml" (but it is backwards compatible and
will still work with existing "log4j.xml" configuration files).</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_log4j_1_vs_log4j_2"></a>25.2. Log4j 1 vs Log4j 2</h2></div></div></div><p>Log4j 1.2.x is NOT the same API as Log4j 2.x. While they share the same name, the latter is a completely new API,
which was newly written from the ground-up, and which is not backwards compatible to Log4j 1 in any way - not with
the configuration, and not on the API level. The SLS has never been "upgraded" to Log4j 2 because it would not be
an upgrade, but a jump to a new, completely different API, with lots of new functionality that the SLS does not need.
The case of the Log4Shell vulnerability demonstrates quite well why USP has followed a more conservative approach and
has been sticking to the logging library in use, following the mantra "don’t fix it if it ain’t broken".</p><p><span class="emphasis"><em>This means that all vulnerabilities discovered in Log4j 2, such as the infamous Log4Shell, are NOT relevant to Log4j 1,
and therefore NOT relevant to the SLS / USP logging library, as it is a completely different codebase.</em></span></p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_fixed_known_log4j_1_2_vulnerabilities"></a>25.3. Fixed Known Log4j 1.2 Vulnerabilities</h2></div></div></div><p>All currently known vulnerabilities of Log4j 1.2.x have been addressed in the USP logging library by removing the
corresponding / responsible components (mostly functionality not used by the SLS anyway).</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<a class="ulink" href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-4104" target="_top">https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-4104</a>
</li><li class="listitem">
Remote code execution based on class "JMSAppender"
</li><li class="listitem">
<a class="ulink" href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2020-9488" target="_top">https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2020-9488</a>
</li><li class="listitem">
Man-in-the-middle-attack based on class "SMTPAppender"
</li><li class="listitem">
<a class="ulink" href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2019-17571" target="_top">https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2019-17571</a>
</li><li class="listitem">
Remote code execution based on class "SocketServer"
</li><li class="listitem">
<a class="ulink" href="https://nvd.nist.gov/vuln/detail/CVE-2022-23302" target="_top">https://nvd.nist.gov/vuln/detail/CVE-2022-23302</a>
</li><li class="listitem">
JMSSink in all versions of Log4j 1.x is vulnerable to deserialization of untrusted data
</li><li class="listitem">
<a class="ulink" href="https://nvd.nist.gov/vuln/detail/CVE-2022-23305" target="_top">https://nvd.nist.gov/vuln/detail/CVE-2022-23305</a>
</li><li class="listitem">
JDBCAppender allows SQL injection
</li><li class="listitem">
<a class="ulink" href="https://nvd.nist.gov/vuln/detail/CVE-2022-23307" target="_top">https://nvd.nist.gov/vuln/detail/CVE-2022-23307</a>
</li><li class="listitem">
Vulnerability when using the Chainsaw companion app (log viewer)
</li></ul></div><p>The relevant classes and packages responsible for the issues listed above have all been removed from the jar file
in the SLS. Note that even in case they are still present (in older SLS releases), they cannot be exploited as long
as they are not explicitely used by configuring them in the Log4j configuration settings.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_functionality"></a>25.4. Functionality</h2></div></div></div><p>The  log records can be redirected to any log facility
(e.g. files, syslog, etc.) by changing the logging configuration file accordingly.</p><p>However, the servlet container also writes custom log records (about
servlet-related events, classloading etc.) and standard output info. It depends
on the configuration of the servlet container (Tomcat) where all this output
ends up.</p><p>In case of TOMCAT, all standard output is usually printed into this file:</p><pre class="screen">&lt;tomcat installation directory&gt;/logs/catalina.out</pre><div class="note" style="margin-left: 0; margin-right: 10%;"><h3 class="title">Note</h3><p>The SLS includes functionality to redirect "stdout" and "stderr" output to
the "<code class="literal">sls.log</code>" file. If configured, the mechanism becomes active shortly after
the start of the SLS, so only a few default logs of the Tomcat are visible in
the "<code class="literal">catalina.out"</code>. After that, all standard out and standard error output
appears in the "<code class="literal">sls.log</code>" file.</p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="x81732_Heading2Tarsec_Log4J_configuration"></a>25.5. Log4J Configuration</h2></div></div></div><p>SLS logging is configured through a separate XML file. This file is named "<code class="literal">usp-logging.xml</code>"
and must be located in the subdirectory "<code class="literal">WEB-INF</code>". However, the SLS is also fully backwards
compatible with existing Log4j 1 configuration files ("log4j.xml" and "log4j.dtd").</p><p>Example configuration files (XML configuration and corresponding DTD) can be found in the SLS
delivery archive, in the "samples" subdirectory:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">usp-logging.xml</code>
</li><li class="listitem">
<code class="literal">usp-logging.dtd</code>
</li></ul></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_log_files"></a>25.5.1. Log Files</h3></div></div></div><p>The SLS creates the following log files by default:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">sls.log</code> - The debug logfile
</li><li class="listitem">
<code class="literal">exception.log</code> - The exception stacktrace logfile
</li><li class="listitem">
<code class="literal">audit.log</code> - The audit message logfile
</li><li class="listitem">
<code class="literal">performance.log</code> - The performance measurement logfile
</li><li class="listitem">
<code class="literal">soap-frontend.log</code> - <span class="emphasis"><em>Optional:</em></span> Only if the SOAP frontend is used
</li></ul></div><p>There are five different levels for all log messages:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">ERROR</code>
</li><li class="listitem">
<code class="literal">WARN</code>
</li><li class="listitem">
<code class="literal">INFO</code>
</li><li class="listitem">
<code class="literal">DEBUG</code>
</li><li class="listitem">
<code class="literal">TRACE</code>
</li></ul></div><p>All log records written to the "<code class="literal">audit</code>", "<code class="literal">performance</code>" or "<code class="literal">exception</code>" log
are either of level "<code class="literal">ERROR</code>", "<code class="literal">WARN</code>" or "<code class="literal">INFO</code>". Debug and trace messages
are written only to the debug/trace logfile "<code class="literal">sls.log</code>".</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_audit_log_audit_log_file"></a>25.5.2. audit.log - Audit Log File</h3></div></div></div><p>The SLS usually writes one log record into this file for each important event
such as a completed or failed authentication, a challenge / response
verification etc.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_exception_log_error_log_file"></a>25.5.3. exception.log - Error Log File</h3></div></div></div><p>When there is an SLS error, the "<code class="literal">exception.log</code>" and sometimes also the
"<code class="literal">sls.log</code>" file get one or more log records on level ERROR, like this example:</p><pre class="screen">2009-03-13 17:36:44,126 [CC:...] [RC:...] - [ERROR] [USER_AUTH_FAILED_TECH] Authentication failed due to a technical problem. User: 'demo'. Reason: 'Authentication for user ''miller'' failed, reason: Receive timed out'</pre><p>This is an example of a RADIUS authentication that failed because the RADIUS
server became unavailable, and the connection attempt from the SLS to the RADIUS
server timed out.</p><p>The highlighted string <code class="literal">USER_AUTH_FAILED_TECH</code> is the SLS error message ID that
identifies this kind of error. All SLS error messages are documented in the
separate "<code class="literal">sls-log-messages.pdf</code>" file. Please read that documentation for more
information about any given error, its possible causes and what to do.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_performance_log_performance_log_file"></a>25.5.4. performance.log -Performance Log File</h3></div></div></div><p>In this file, the SLS writes two log records per request. The first marks the
entry (and beginning of processing) of a request, and the second one contains
the total elapsed time required to complete the request, and also the time that
was needed for each model state. An example log record would look like this:</p><pre class="screen">2011-12-01 09:48:28,311 [CC:...] [RC:...] - [Request entry]
2011-12-01 09:48:28,455 [CC:...] [RC:...] - [Request exit: 144 [get.cred: 113] ]
2011-12-01 09:48:32,608 [CC:...] [RC:...] - [Request entry]
2011-12-01 09:48:34,258 [CC:...] [RC:...] - [Request exit: 1866 [do.auth: 85 [radius: 26] ] [do.success: 1701] ]</pre><p>Which means that the "<code class="literal">get.cred</code>" state required 113 milliseconds from start of
request entry until the page was delivered. And in the following login POST
request, the entire request took 1.8 seconds, of which the "<code class="literal">do.auth</code>" state
took 85 milliseconds, of which again the actual RADIUS call-out took 26
milliseconds, and so on.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_sls_log_debug_log_file"></a>25.5.5. sls.log - Debug Log File</h3></div></div></div><p>This logfile, named "<code class="literal">sls.log</code>", is often called the "debug" or "trace" log
file. By default, the file contains only information on level "<code class="literal">ERROR</code>" or
"<code class="literal">INFO</code>", but if resolving a problem requires more information, this is the
file where the SLS will write it's debugging information into.</p><p><span class="strong"><strong>DEBUG vs. TRACE</strong></span></p><p>As a rule of thumb, <code class="literal">DEBUG</code> log level (while already a lot more verbose than
<code class="literal">INFO</code>) contains information that should still be more or less meaningful to
any administrator who is familiar with the SLS in general.</p><p><code class="literal">TRACE</code> log level, on the other hand, produces a lot (!) of information that is
useful to - and often required by - SLS 3rd level support. See
<a class="link" href="#x24285_Heading3Tarsec_DEBUG_and_TRACE_log_levels" title="25.6.1. DEBUG and TRACE log levels">"DEBUG and TRACE log levels"</a>
for details.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="x59531_Heading3Tarsec_soap_frontend_log_SOAP_Webservice_frontend_log"></a>25.5.6. soap-frontend.log - SOAP / Webservice frontend log</h3></div></div></div><p>When the SOAP webservice frontend of the SLS is used (see
<a class="link" href="#x51351_Heading1Tarsec_SOAP_Frontend" title="Chapter 64. SOAP Frontend">"SOAP Frontend"</a> for details), the log
records of that frontend will be written into this separate log file. The reason
for this is that the frontend is actually a separate HTTP request listener which
processes the incoming SOAP request and then sends a local HTTP request to the
regular SLS HTTP listener on the same system.</p><p>So, because it really is an additional service working with the SLS, it uses a separate log file.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="SLS_Log_Appender"></a>25.5.7. SLS Custom Appender</h3></div></div></div><p>The SLS provides an extension of the standard Log4j 1 "DailyRollingFileAppender",
which combines the features of that appender with the possibility of setting also
size-based limits. The custom SLS appender is called</p><pre class="screen">com.usp.sls.toolkit.log.SlsDailyRollingFileAppender</pre><p>And it allows to use all the parameters that can be used for the Log4j
"RollingFileAppender" and "DailyRollingFileAppender".</p><p>In addition, it supports some custom parameters that allow to deal with
multiline logging of stacktraces; see <a class="link" href="#Disabling_Multiline_Stacktraces" title="25.11. Disabling Multiline Stacktraces">"Disabling Multiline Stacktraces"</a> for details.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_json_or_xml_output_escaping"></a>25.5.8. JSON or XML output escaping</h3></div></div></div><p>If the output is formatted as JSON or XML, some characters in a stacktrace can
cause problem and break the JSON or XML structure. To avoid this, it is possible
with the "SlsDailyRollingFileAppender" to enable escaping of such problematic
characters, specificall for JSON or XML:</p><pre class="screen">    &lt;param name="EscapingMode" value="json" /&gt;</pre><p>or</p><pre class="screen">    &lt;param name="EscapingMode" value="xml" /&gt;</pre><p>This will escape the corresponding problematic characters in the actual log
message (Log4j pattern layout variable "%m").</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="x94721_Heading3Tarsec_SLS_Named_Loggers"></a>25.5.9. SLS Named Loggers</h3></div></div></div><p>The SLS uses some named loggers which <span class="emphasis"><em>must</em></span> be defined in the logging
configuration:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
"<code class="literal">com.usp</code>" - Used for info / debug / trace logs
</li><li class="listitem">
"<code class="literal">audit</code>" - Used for audit logs
</li><li class="listitem">
"<code class="literal">performance</code>" - Used for the performance logging
</li><li class="listitem">
"<code class="literal">exception</code>" - Used for the exception stacktrace logging
</li></ul></div><p>Some other named loggers are optional:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
"<code class="literal">com.usp.sesticket</code>" -  Eliminates some unwanted error log records.
</li></ul></div><p>If the SOAP frontend is used, the following logger must be defined as well:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
"<code class="literal">com.usp.sls.frontend.soap</code>" - Logs the processing steps of the SLS SOAP frontend.
</li></ul></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_sls_log_appenders"></a>25.5.10. SLS Log Appenders</h3></div></div></div><p>The SLS logging configuration usually contains the following appenders:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">SLS_LOG</code> - The debug / info log, set to threshold "<code class="literal">TRACE</code>".
</li><li class="listitem">
<code class="literal">SOAP_FRONTEND_LOG</code> - The SOAP / webservice frontend log, set to threshold
"<code class="literal">TRACE</code>".
</li><li class="listitem">
<code class="literal">SYSLOG_LOG</code> - The remote syslog host log, set to threshold "<code class="literal">INFO</code>".
</li><li class="listitem">
<code class="literal">LOCAL_SYSLOG_LOG</code> - The local syslog log, set to threshold "<code class="literal">INFO</code>".
</li><li class="listitem">
<code class="literal">PIPE_LOG</code> - An appender that allows to pipe log output into any local
executable binary, set to threshold "<code class="literal">INFO</code>".
</li><li class="listitem">
<code class="literal">AUDIT_LOG</code> - The audit log information; must be used as appender for the
named logger "<code class="literal">audit</code>", set to threshold "<code class="literal">INFO</code>".
</li><li class="listitem">
<code class="literal">PERFORMANCE_LOG</code> - The performance log information; must be used as appender
for the named logger "<code class="literal">performance</code>", set to threshold "<code class="literal">INFO</code>".
</li><li class="listitem">
<code class="literal">EXCEPTION_LOG</code> - The appender which will receive all exception stacktrace
logs, based on the log level <code class="literal">ERROR</code>, set to threshold "<code class="literal">ERROR</code>".
</li></ul></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_enabling_disabling_logging"></a>25.6. Enabling / Disabling logging</h2></div></div></div><p>To enable or disable a certain type of logging such as performance, simply
insert or remove the corresponding "<code class="literal">logger</code>" tag from the
"<code class="literal">usp-logging.xml</code>" file.</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="x24285_Heading3Tarsec_DEBUG_and_TRACE_log_levels"></a>25.6.1. DEBUG and TRACE log levels</h3></div></div></div><p>If there is a problem that cannot be solved with the error message from the
"<code class="literal">exception.log</code>" alone, it might be necessary to enable <code class="literal">DEBUG</code> or even <code class="literal">TRACE</code>
logging to gain more information about a problem:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">DEBUG</code> - Writes a lot of internal processing and status information to the
"<code class="literal">sls.log</code>" file. This might provide some interesting information such as
available back-end (e.g. LDAP) response attribute, JEXL variables, current
model state etc.
</li><li class="listitem">
<code class="literal">TRACE</code> - Writes even more internal information, including Java method
entrances and exits etc. This level of information is usually only helpful for
3rd level support through USP SLS developers.
</li></ul></div><p>To enable debug or trace logging in the "<code class="literal">sls.log</code>" file, set the
"<code class="literal">level</code>"-value of the "<code class="literal">logger</code>" for "<code class="literal">com.usp</code>" to "<code class="literal">DEBUG</code>" or "<code class="literal">TRACE</code>":</p><pre class="screen">&lt;category name="com.usp"&gt;
        &lt;priority value="DEBUG" /&gt;
        &lt;appender-ref ref="SLS_LOG" /&gt;
        &lt;appender-ref ref="EXCEPTION_LOG" /&gt;
&lt;/category&gt;</pre><p><span class="strong"><strong>No restart required</strong></span></p><p>Please note that the SLS is able to re-read its logging configuration file when it
changes, so it is not necessary to restart the SLS tomcat instance if the logging
configuration is changed. However, it may take about half a minute or a bit
longer until the changes become active.</p><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="x95379_Heading4Tarsec_DEBUG_TRACE_Logging_for_single_sessions"></a>DEBUG / TRACE Logging for single sessions</h4></div></div></div><p>See <a class="link" href="#x84418_Heading2Tarsec_DEBUG_TRACE_Logging" title="10.4. DEBUG / TRACE Logging">"DEBUG / TRACE Logging"</a>
for details about enabling DEBUG or TRACE logging only for single login sessions.</p></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_performance_memory_impact"></a>25.6.2. Performance / Memory Impact</h3></div></div></div><div class="important" style="margin-left: 0; margin-right: 10%;"><h3 class="title">Important</h3><p><code class="literal">DEBUG</code> logging (and to an even larger extent <code class="literal">TRACE</code> logging) has a
very severe, negative performance impact. Therefore, DEBUG and TRACE logging
must never be enabled in heavy traffic environments, or only for a very short
time, in order to prevent the log files to grow too large. If some users have
problems that must be analyzed, only their sessions should be set to DEBUG or
TRACE logging (see
<a class="link" href="#x84418_Heading2Tarsec_DEBUG_TRACE_Logging" title="10.4. DEBUG / TRACE Logging">"DEBUG / TRACE Logging"</a>).</p></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="x59059_Heading2Tarsec_Tenant_specific_logging"></a>25.7. Tenant-specific logging</h2></div></div></div><p>If multi-tenancy is used (see
<a class="link" href="#x18987_Heading1Tarsec_Multitenancy_Support" title="Chapter 18. Multitenancy Support">"Multitenancy Support"</a>), it is
possible to also use separate log files for each tenant.</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="x98293_Heading3Tarsec_Log_rotation_problem_with_URI_based_multi_tenancy"></a>25.7.1. Log rotation problem with URI-based multi-tenancy</h3></div></div></div><p><span class="emphasis"><em>NOTE: If multi-tenancy is used through different URI paths (as opposed to using
different virtual hosts), there may be problems with log file rotation. The
reason is that the servlet container may load the SLS web application multiple
times, because each URI path is a separate context. Those multiple application
instances (all running in the same JVM) are accessing the same log files, which
causes problems as soon as one application rotates a file.</em></span></p><p><span class="emphasis"><em>One solution for this is to use separate log files per tenant, and, if possible,
to avoid separate SLS context URIs, as explained in the paragraphs below.</em></span></p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_avoiding_logfile_rotation_issues"></a>25.7.2. Avoiding logfile rotation issues</h3></div></div></div><p>When using multiple tenants that are supposed to be distinguished through
different URIs, there are really two options, a bad and a better one:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">
Bad: Use completely separate URIs for the SLS webapp, e.g. "/acme/sls/auth" and
"/corp/sls/auth". This is the bad option, because this will make the Tomcat
container load the SLS webapp twice, as described in the previous chapter. To
avoid this, the tenant part of the URI must be part of the SLS webapp context
path, as described below.
</li><li class="listitem"><p class="simpara">
Good: Use one singular SLS context path with tenant-specific sub-URIs, e.g.
"/sls/acme/auth" and "/sls/corp/auth". This requires configuring those URIs
("/acme/auth" and "/corp/auth") in the SLS web.xml and struts-config.xml files.
But it also lets the Tomcat container load the webapp only once, and will
thereby automatically avoid all logfile rotation issues. So while it does
require slightly more configuration changes, it’s still recommended.
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
SLS Configuration Example
</li></ul></div></li></ol></div><p>In the "sls.properties", the multi-tenancy would be configured just like this:</p><pre class="programlisting">multitenancy.enabled=true
tenant.1=acme
tenant.2=corp
multitenancy.resolving.1=urlregex
tenant.1.regex=.*acme/.*
tenant.2.regex=.*corp/.*</pre><p>But then additional mappings need to be added to the "web.xml" file, in
addition to the existing mapping for "/auth". NOTE: The "/sls" part of the URI
is missing here because it is part of the SLS context webapp URI. Once the
request has been dispatched by the Tomcat container to the SLS webapp, only
the part after "/sls/.." is relevant for further dispatching:</p><pre class="screen">  &lt;servlet-mapping&gt;
     &lt;servlet-name&gt;action&lt;/servlet-name&gt;
     &lt;url-pattern&gt;/auth&lt;/url-pattern&gt;
  &lt;/servlet-mapping&gt;
  &lt;servlet-mapping&gt;
     &lt;servlet-name&gt;action&lt;/servlet-name&gt;
     &lt;url-pattern&gt;/acme/auth&lt;/url-pattern&gt;
  &lt;/servlet-mapping&gt;
  &lt;servlet-mapping&gt;
     &lt;servlet-name&gt;action&lt;/servlet-name&gt;
     &lt;url-pattern&gt;/corp/auth&lt;/url-pattern&gt;
  &lt;/servlet-mapping&gt;</pre><p>And the same goes for the "struts-config.xml". Look for the existing mapping
for "/auth" and add corresponding ones for the tenants:</p><pre class="screen">    &lt;action path="/auth" scope="request"
        type="com.usp.sls.toolkit.struts.actions.BaseAction" /&gt;
    &lt;action path="/acme/auth" scope="request"
        type="com.usp.sls.toolkit.struts.actions.BaseAction" /&gt;
    &lt;action path="/corp/auth" scope="request"
        type="com.usp.sls.toolkit.struts.actions.BaseAction" /&gt;</pre><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
HSP Configuration Example
</li></ul></div><p>It will be necessary to add those SLS sub-URIs as "StartPage" URIs in the
SRM configuration of the SLS location as well:</p><pre class="screen">AC_StartPageList /sls/auth /sls/acme/auth /sls/corp/auth</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_tenant_logfile_configuration"></a>25.7.3. Tenant Logfile Configuration</h3></div></div></div><p>Using separate log files per tenant requires two basic changes to the logging
configuration file:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">
Defining a separate file appender per log file and tenant, and one as the
default. So, for instance, if two tenants are used, there should be three
appenders for the audit log file, three appenders for the exception log file
and so on.
</li><li class="listitem">
Defining a separate named logger, with a tenant-specific name prefix, per log
file and tenant - and still the existing default one.
</li></ol></div><p>In short: Create an appender with any alias (name). Then create a named logger
which uses that additional appender. The logger must have a name prefix with
this syntax:</p><p><span class="strong"><strong>Logger name prefix</strong></span></p><p><code class="literal">tenant-<span class="emphasis"><em>&lt;tenant-alias&gt;</em></span>.<span class="emphasis"><em>&lt;logger-name&gt;</em></span></code></p><p>So, for instance, for the named logger "<code class="literal">audit</code>", the tenant-specific logger
must be named "<code class="literal">tenant-<span class="emphasis"><em>&lt;tenant&gt;</em></span>.audit</code>". And the SLS trace / debug logger
"<code class="literal">com.usp</code>" must be defined in a logger name "<code class="literal">tenant-<span class="emphasis"><em>&lt;tenant&gt;</em></span>.com.usp</code>".</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_default_appenders_and_loggers"></a>25.7.4. Default appenders and loggers</h3></div></div></div><p>The reason why the configuration should always contain a default appender and
logger for each log file is because there might always be some requests
reaching the SLS that don’t match any of the tenants. Also, even requests
belonging to a certain tenant, will at least on DEBUG and TRACE level write
some log records before the tenant is detected and set for the current
request / session, and those log records will be written to the default logger
and appender.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_example_for_tenants_acme_and_company"></a>25.7.5. Example for tenants "Acme" and "Company"</h3></div></div></div><p>Assuming that two tenants "<code class="literal">acme</code>" and "<code class="literal">company</code>" would be used, the logging
configuration would require the following three appenders for the audit
log file:</p><p><span class="strong"><strong>Default</strong></span></p><pre class="screen">&lt;appender name="AUDIT_LOG"
class="com.usp.sls.toolkit.log.SlsDailyRollingFileAppender"&gt;
....
&lt;/appender&gt;</pre><p><span class="strong"><strong>ACME</strong></span></p><pre class="screen">&lt;appender name="AUDIT_LOG_ACME"
class="com.usp.sls.toolkit.log.SlsDailyRollingFileAppender"&gt;
....
&lt;/appender&gt;</pre><p><span class="strong"><strong>Company</strong></span></p><pre class="screen">&lt;appender name="AUDIT_LOG_COMPANY"
class="com.usp.sls.toolkit.log.SlsDailyRollingFileAppender"&gt;
....
&lt;/appender&gt;</pre><p>Also, the following loggers would have to be defined:</p><p><span class="strong"><strong>Default</strong></span></p><pre class="screen">&lt;logger name="audit"&gt;
&lt;level value="INFO" /&gt;
&lt;appender-ref ref="AUDIT_LOG" /&gt;
&lt;appender-ref ref="SYSLOG_LOG" /&gt;
&lt;/logger&gt;</pre><p><span class="strong"><strong>ACME</strong></span></p><pre class="screen">&lt;logger name="tenant-acme.audit"&gt;
&lt;level value="INFO" /&gt;
&lt;appender-ref ref="AUDIT_LOG_ACME" /&gt;
&lt;appender-ref ref="SYSLOG_LOG" /&gt;
&lt;/logger&gt;</pre><p><span class="strong"><strong>Company</strong></span></p><pre class="screen">&lt;logger name="tenant-company.audit"&gt;
&lt;level value="INFO" /&gt;
&lt;appender-ref ref="AUDIT_LOG_COMPANY" /&gt;
&lt;appender-ref ref="SYSLOG_LOG" /&gt;
&lt;/logger&gt;</pre><p>The same applies to every other log file, such as "<code class="literal">com.usp</code>", "<code class="literal">exception</code>"
and "<code class="literal">performance</code>".</p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_syslog_support"></a>25.8. Syslog support</h2></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_remote_syslog_host_logging"></a>25.8.1. Remote Syslog Host Logging</h3></div></div></div><p>To send log information to a syslog server, an "<code class="literal">SlsSyslogAppender</code>" must be
configured, for example:</p><p><span class="strong"><strong>Syslog host appender</strong></span></p><pre class="screen">&lt;appender name="SYSLOG_LOG"
class="com.usp.sls.toolkit.log.SlsSyslogAppender"&gt;
&lt;param name="SyslogHost" value="_loghost.acme.com_" /&gt;
&lt;param name="Tag" value="SES-SLS" /&gt;
&lt;param name="Facility" value="USER" /&gt;
&lt;param name="FacilityPrinting" value="true" /&gt;
&lt;param name="Threshold" value="INFO" /&gt;
&lt;layout class="com.usp.logging.PatternLayout"&gt;
&lt;param name="ConversionPattern"
value="%d [CC:%X{cc}] [RC:%X{rc}] - %m%n" /&gt;
&lt;/layout&gt;
&lt;/appender&gt;</pre><p>The attribute "<code class="literal">SyslogHost</code>" must contain the host name of the syslog server,
and "<code class="literal">Facility</code>" the corresponding syslog facility. Also, the attribute
"<code class="literal">FacilityPrinting</code>" must be set to "<code class="literal">true</code>".</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_custom_sls_syslog_appender"></a>25.8.2. Custom SLS Syslog Appender</h3></div></div></div><div class="note" style="margin-left: 0; margin-right: 10%;"><h3 class="title">Note</h3><p>The SLS includes a custom Syslog appender, due to two
shortcomings of the original Syslog appender provided by Log4j 1:</p></div><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
The original syslog appender has no support for the "Tag" part of the
message, which contains an ID of the component / application that created the
log record (important when logs are sent to a central log host).
</li><li class="listitem">
The original syslog appender would also print stack traces to syslog. Due to
their multi-line nature, they usually break the functionality of log tracking
tools.
</li></ul></div><p>The custom SLS syslog appender features an additional "<code class="literal">Tag</code>"-attribute in the
configuration which defines the "<code class="literal">Tag</code>"-part of the message (sometimes also
referred to as "<code class="literal">Identity</code>").</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_example_1_audit_logging_for_syslog"></a>25.8.3. Example 1: Audit logging for syslog</h3></div></div></div><p>The appender alone doesn't do anything yet, however. In order to have the SLS
send some actual log records to it, it must also be added to a logger. One
suggested logger for syslog is "<code class="literal">audit</code>", since it contains only log messages
on info level, and usually of the type that is most interesting to collect on
a central log host:</p><pre class="screen">&lt;category name="audit"&gt;
        &lt;priority value="INFO" /&gt;
        &lt;appender-ref ref="AUDIT_LOG" /&gt;
        &lt;appender-ref ref="SYSLOG_LOG" /&gt;
&lt;/category&gt;</pre><p>This logger configuration would work with the syslog appender as shown in the
paragraph above.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_example_2_error_logging_for_syslog"></a>25.8.4. Example 2: Error logging for syslog</h3></div></div></div><p>If, however, syslog should be used to track errors (and maybe escalate them
if necessary), an other possibility would be to only send all error logs to
syslog with this configuration:</p><pre class="screen">&lt;appender name="SYSLOG_LOG"
        class="com.usp.sls.toolkit.log.SlsSyslogAppender"&gt;
        &lt;param name="SyslogHost" value="loghost.acme.com" /&gt;
        &lt;param name="Threshold" value="INFO" /&gt;
        &lt;param name="Tag" value="SES-SLS" /&gt;
        &lt;param name="Facility" value="USER" /&gt;
        &lt;param name="FacilityPrinting" value="true" /&gt;
        &lt;param name="Threshold" value="ERROR" /&gt;
        &lt;layout class="com.usp.logging.PatternLayout"&gt;
        &lt;param name="ConversionPattern"
                value="%d [CC:%X{cc}] [RC:%X{rc}] - %m%n" /&gt;
        &lt;/layout&gt;
&lt;/appender&gt;</pre><p>And instead of forwarding "audit" logs to this appender, the SLS info / debug /
trace logs would be sent:</p><pre class="screen">&lt;category name="com.usp"&gt;
        &lt;priority value="ERROR" /&gt;
        &lt;appender-ref ref="SYSLOG_LOG" /&gt;
        &lt;appender-ref ref="SLS_LOG" /&gt;
        &lt;appender-ref ref="EXCEPTION_LOG" /&gt;
&lt;/category&gt;</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_local_syslog_logging"></a>25.8.5. Local Syslog Logging</h3></div></div></div><p>To send log information to the local syslog facility, a "<code class="literal">SyslogPipeAppender</code>"
must be configured, for example:</p><p><span class="strong"><strong>Local syslog appender</strong></span></p><pre class="screen">&lt;appender name="LOCAL_SYSLOG_LOG"
        class="com.usp.sls.toolkit.log.SyslogPipeAppender"&gt;
        &lt;param name="Tag" value="SES-SLS" /&gt;
        &lt;param name="Facility" value="USER" /&gt;
        &lt;param name="Threshold" value="INFO" /&gt;
        &lt;param name="PipeCommand" value="/usr/info/logger" /&gt;
        &lt;layout class="com.usp.logging.PatternLayout"&gt;
        &lt;param name="ConversionPattern"
                value="%d [CC:%X{cc}] [RC:%X{rc}] - %m%n" /&gt;
        &lt;/layout&gt;
&lt;/appender&gt;</pre><p>The attribute "<code class="literal">PipeCommand</code>" must contain the absolute path of the "<code class="literal">logger</code>"
binary used to pipe data into syslog, and "<code class="literal">Facility</code>" the corresponding syslog
facility.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_pipe_appender"></a>25.8.6. Pipe Appender</h3></div></div></div><p>The pipe appender is a more generic version of the local syslog appender. It
allows to pipe SLS log output into any local executable binary, using an
arbitrary command, for example:</p><p><span class="strong"><strong>Pipe appender</strong></span></p><pre class="screen">&lt;appender name="PIPE_LOG"
        class="com.usp.sls.toolkit.log.PipeAppender"&gt;
        &lt;param name="Threshold" value="INFO" /&gt;
        &lt;param name="PipeCommand" value="/usr/info/logger -t SES-SLS -p USER.info" /&gt;
        &lt;layout class="com.usp.logging.PatternLayout"&gt;
        &lt;param name="ConversionPattern"
                value="%d [CC:%X{cc}] [RC:%X{rc}] - %m%n" /&gt;
        &lt;/layout&gt;
&lt;/appender&gt;</pre><p>The attribute "<code class="literal">PipeCommand</code>" must contain the absolute path of the binary used
to pipe data into.</p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="x98754_Logstash_Elasticsearch_support"></a>25.9. Logstash and Elasticsearch support</h2></div></div></div><p>To forward SLS log data to Logstash, a SocketAppender can be used in the
SLS logging configuration, in combination with a Log4j plugin in Logstash. But
it is important to understand the implications of this set-up for Elasticsearch.</p><div class="note" style="margin-left: 0; margin-right: 10%;"><h3 class="title">Note</h3><p>For information on the Log4j plugin for Logstash, please consult the
Logstash website, since that plugin is not a SES component.</p></div><p>All logging variables that are created by the SLS when a log message is written,
are automatically sent to Logstash through the SocketAppender, and Logstash
(or rather the Log4j Logstash plugin) then automatically creates Logstash fields
for all these variables. In other words, the SLS logging may lead to the
creation of fields in Logstash that are not really needed or wanted. If
Logstash then forwards the logs to Elasticsearch, things may get problematic,
if there are no format definitions for these new fields (e.g. there may be other
sources for Elasticsearch than the SLS, which may accidentally create fields
with the same names, but different content type, e.g. numeric instead of strings).
All of this can lead to problems later when creating indexes in Elasticsearch.</p><p>For these reasons, when using the SocketAppender as described below, to
forward logs to Logstash / Elasticsearch, it is advised to enable whitelisting
of logging variables, and define specifically which ones should actually be
created. Or, rename the variables created by the SLS, in order to avoid name
collisions with existing fields from other sources, e.g. rename the variable
"user" created by the SLS to "sls_user".</p><p>Please read chapter <a class="link" href="#x13755_Add_rename_and_block" title="25.12.1. Add, block or rename logging variables">"Add</a>
for information on how to whitelist, rename and add logging variables.</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_socket_appender"></a>25.9.1. Socket Appender</h3></div></div></div><pre class="screen">  &lt;appender class="org.apache.log4j.net.SocketAppender" name="LOG_LOGSTASH"&gt;
    &lt;param name="RemoteHost" value="localhost"/&gt;
    &lt;param name="ReconnectionDelay" value="60000"/&gt;
    &lt;param name="Port" value="5515"/&gt;
    &lt;param name="Application" value="SLS.standalone.default.sls"/&gt;
    &lt;param name="Threshold" value="INFO"/&gt;
  &lt;/appender&gt;</pre><p>The "Threshold" should be set according to what kind of log information is
supposed to be handled by the receiver. Only set it to <code class="literal">DEBUG</code> or <code class="literal">TRACE</code>
if debug or trace log records are actually expected by the receiver.</p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="Filtering_Passwords"></a>25.10. Filtering Passwords</h2></div></div></div><p>It is possible to enable a global filter for password credential values, so that
such values will be replaced by a "[hidden]" string even on "debug" and "trace"
log level. The following credential types will be filtered out:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">password</code>
</li><li class="listitem">
<code class="literal">newpassword</code>
</li><li class="listitem">
<code class="literal">newpassword2</code>
</li><li class="listitem">
<code class="literal">secret</code>
</li></ul></div><p>In order to enable this filter, the following property must be set:</p><p><span class="strong"><strong><code class="literal">log.filter.creds.secrets</code></strong></span></p><p>Set this to "<code class="literal">true</code>" to enable password filtering in all "debug" and "trace" logs.
Defaults to "<code class="literal">false</code>".</p><pre class="programlisting">log.filter.creds.secrets=true</pre><p><span class="emphasis"><em>NOTE: Enabling this filter further increases the performance impact of debug
and trace logs. However, as long as debug or trace logging is not actually
enabled, this feature can be left enabled without a noticable performance
penalty. It will then still help avoid accidental logging of sensitive values in
cases were trace logging is enabled only for single users.</em></span></p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="Disabling_Multiline_Stacktraces"></a>25.11. Disabling Multiline Stacktraces</h2></div></div></div><p>In cases where the log output is sent to log processing tools like Logstash,
it is often formatted into a structure like JSON or XML, and multi-line
stacktrace logs are often a problem in such situations.</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_disabline_line_breaks"></a>25.11.1. Disabline Line Breaks</h3></div></div></div><p>The following log appender parameter allows to disable new-line break characters
whenever a stacktrace is logged in the "exception.log" file:</p><pre class="screen">    &lt;param name="MultilineStacktraces" value="false" /&gt;</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_custom_line_delimiter"></a>25.11.2. Custom Line Delimiter</h3></div></div></div><p>If the parameter "MultilineStacktraces" is set to "false", and all lines of a
stacktrace are concatenated, these lines are separated by a pipe character (" | ")
by default. To change this, the following parameter can be set with a custom
delimiter character:</p><pre class="screen">    &lt;param name="MultilineDelimiter" value=" : " /&gt;</pre></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="x123123_SLS_Logging_Variables"></a>25.12. SLS Logging Variables</h2></div></div></div><p>The SLS provides custom variables that can be used in log records as a means to
correlate entries of the same client and / or request. The logging variables are:</p><p></p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
The client correlator ID. This value allows to correlate all log records that
belong to request coming from the same client .
</li></ul></div><p></p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
The request correlator ID. This value allows to correlate all log records of
one request from the client.
</li></ul></div><p></p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
The current model state. Is empty in all log records written by clean-up
threads or during initialization phase.
</li></ul></div><p></p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
The current tenant (if multitenancy support is enabled and used). Is empty
in all log records written by clean-up threads or during initialization phase.
</li></ul></div><p></p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
</li></ul></div><p>An example value for the formatter configuration property
<code class="literal">log4j.appender.stdout.layout</code> would be:</p><pre class="screen">%d %-5p %c{2}:%M() [%t] [CC:%X{cc}] [RC:%X{rc}] - %m%n</pre><p>Which would result in log records similar to this example:</p><pre class="screen">2006-09-05 13:12:53,315 INFO  toolkit.Toolkit:init() [main] [CC:VxfTVycOViU$]
[RC:80c053d0] - Starting Sample Secure Login Service (SLS)</pre><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="x13755_Add_rename_and_block"></a>25.12.1. Add, block or rename logging variables</h3></div></div></div><p>When using a Log4j SocketAppender, all MDC variables are sent to the
receiver automatically, which can have unwanted side effects depending on
how they are used (e.g. with a system like Logstash / Elasticsearch; see
<a class="link" href="#x98754_Logstash_Elasticsearch_support" title="25.9. Logstash and Elasticsearch support">"Logstash and Elasticsearch support"</a>
for more information).</p><p>Because of this, the SLS allows to add, block or rename existing log variables,
all just with some configuration properties. Additional custom variables can be
created for certain log messages, grouped by aliases. Blocking variables through
a whitelist mechanism, blocking variables with an empty value or renaming
already existing ones can all be done globally.</p><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="_adding_custom_variables"></a>Adding custom variables</h4></div></div></div><p>An alias can be defined with a set of variables that should be created for
every SLS log message that is marked as belonging to that alias. The syntax is:</p><p><span class="strong"><strong><code class="literal">log.variables.messages.&lt;alias&gt;=&lt;comma-separated list of SLS message IDs&gt;</code></strong></span></p><p>Defines which SLS messages belong to the given alias. Every SLS message can
be assigned to multiple aliases.</p><p><span class="strong"><strong><code class="literal">log.variables.add.&lt;alias&gt;.&lt;new variable name&gt;=&lt;variable value&gt;</code></strong></span></p><p>Defines a new log variable to be created with the given value, every time a log
message belonging to this alias is logged.</p><p><span class="strong"><strong>Value</strong></span></p><p>As for the value, there are two main sources for dynamic values:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
JEXL or Groovy expressions can be used (as usual) to access information
  related to the current session to which the log message belongs at the time of logging.
</li><li class="listitem">
Logging variables already created by the SLS. These can be accessed using
  the JEXL function "<code class="literal">function.getLogVariable(String name)</code>".
</li></ul></div><p>The following example should help understanding it:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
the SLS log message "<code class="literal">USER_AUTH_SUCCESS</code>" is assigned to the alias "<code class="literal">CHECK</code>"
</li><li class="listitem">
the SLS log message "<code class="literal">BACKEND_UNAVAILABLE</code>" is assigned to the alias "<code class="literal">SERVICE</code>"
</li><li class="listitem">
both messages are also assigned to the alias "<code class="literal">GLOBAL</code>"
</li><li class="listitem">
the alias "<code class="literal">CHECK</code>" gets an additional log variable "<code class="literal">user_id</code>"
</li><li class="listitem">
the alias "<code class="literal">SERVICE</code>" gets an additional log variable "<code class="literal">vhost</code>"
</li></ul></div><pre class="screen"># Assign USER_AUTH_SUCCESS to the alias CHECK
log.variables.messages.CHECK=USER_AUTH_SUCCESS

# Assign BACKEND_UNAVAILABLE to the alias SERVICE
log.variables.messages.SERVICE=BACKEND_UNAVAILABLE

# Assign both messages to the alias GLOBAL
log.variables.messages.GLOBAL=BACKEND_UNAVAILABLE,USER_AUTH_SUCCESS

# Create variable "user_id" for messages with alias CHECK
log.variables.add.CHECK.user_id=${session.getVerifiedCred('username')}

# Create variable "vhost" for messages with alias SERVICE
log.variables.add.SERVICE.vhost=${header.host}

# Create variable "sls_instance" for all messages
log.variables.add.GLOBAL.sls_instance=prod-1</pre><p>With the example configuration above, the following applies:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
Whenever "<code class="literal">USER_AUTH_SUCCESS</code>" is logged, the log variable "user_id" is
created with the value of the current verified user ID from the session, so
it could be referenced in the logging format like "<code class="literal">X%{user_id}</code>".
</li><li class="listitem">
Whenever "<code class="literal">BACKEND_UNAVAILABLE</code>" is logged, the log variable "vhost" is
created with the value of the request header "host" that was sent to the SLS, so
it could be referenced in the logging format like "<code class="literal">X%{vhost}</code>".
</li><li class="listitem">
Whenever one of these two messages is logged, the variable "<code class="literal">sls_instance</code>"
is created with the fixed value "prod-1", so it could be referenced in the
logging format like "<code class="literal">X%{sls_instance}</code>".
</li></ul></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="_renaming_existing_variables"></a>Renaming existing variables</h4></div></div></div><p>The SLS already creates a number of logging variables depending on which message
is being logged; some are also created always. For example, the current client-
and request-correlator values are always available in the SLS logging variables
"rc" (request correlator) and "cc" (client correlator); they are also ususally
referenced like that in the log format.</p><p>But in a scenario where log records are sent to another system through, for
example, a SocketAppender, there might be reasons for wanting to change the
names of the variables.</p><div class="note" style="margin-left: 0; margin-right: 10%;"><h3 class="title">Note</h3><p>Renaming works like a global filter, and it is applied <span class="emphasis"><em>after</em></span> all
variables are created. So even when variables are added as described above
using the "<code class="literal">log.variables.add...</code>" properties, their name would be changed if
they are matched by a renaming property as described here. The syntax for
configuring logging variable renaming is:</p></div><pre class="screen">log.variables.rename.&lt;old name&gt;=&lt;new name&gt;</pre><p>So, in order to rename the logging variable "backend_system" to "backend_ip", for example, the
following property would be needed:</p><pre class="screen">log.variables.rename.backend_system=backend_ip</pre><div class="note" style="margin-left: 0; margin-right: 10%;"><h3 class="title">Note</h3><p>The few custom variables always created by the SLS as documented in
<a class="link" href="#x123123_SLS_Logging_Variables" title="25.12. SLS Logging Variables">"SLS Logging Variables"</a> (such as "rc", "cc",
"tenant" etc.) cannot be renamed. They are always created with these names;
the reason is that those variables are also used for log records that do not
contain one of the documented SLS messages, specifically debug or trace logging.</p></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="_blocking_variables_without_value"></a>Blocking variables without value</h4></div></div></div><p>The following global configuration property will block all variables whose
value is empty from being created:</p><pre class="screen">log.variables.allowEmpty=true|false</pre><p>Set this to "<code class="literal">false</code>" to block the creation of variables without a value. If
not set, it defaults to "<code class="literal">false</code>", so a variable without a value will not be
sent out.</p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="_whitelisting_variables"></a>Whitelisting variables</h4></div></div></div><p>Similarly to renaming variables, it might be desirable to prevent them from
being sent out to the appender at all. Again, a typical use-case for that would
be using Logstash / Elasticsearch, where all logging variables would automatically
create a field which may be unwanted, or maybe contain sensitive values that
are not meant to leave the SLS. So for any such cases, the following global
property can be set:</p><pre class="screen">log.variables.whitelist=&lt;comma-separated list of variable names&gt;</pre><p>If this property is set, whitelist mode is active, and no variables will be
created anymore, except those explicitely listed in this property. However,
the following variables are <span class="emphasis"><em>automatically whitelisted</em></span>:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">cc</code> - The client correlator value
</li><li class="listitem">
<code class="literal">rc</code> - The request correlator value
</li><li class="listitem">
<code class="literal">state</code> - The SLS model state
</li><li class="listitem">
<code class="literal">tenant</code> - The SLS tenant (if multi-tenancy is used)
</li><li class="listitem">
Every custom variable specifically added with the "<code class="literal">log.variable.add..</code>"
  properties described above.
</li></ul></div><p>The main reason for using this whitelist mechanism is to block all <span class="emphasis"><em>other</em></span>
log variables created by the SLS internally, which are different for each log
message. For example, the "<code class="literal">USER_AUTH_SUCCESS</code>" message creates a logging variable
"<code class="literal">user</code>" which contains the user ID. The message "<code class="literal">BACKEND_UNAVAILABLE</code>" creates
(among others) the variable "<code class="literal">system</code>" with the IP or hostname of the backend
system. If the backend variable should be sent to the appender, but no other
ones like the user ID, then the following property must be set:</p><pre class="screen">log.variables.whitelist=system</pre><p>With this property, all logging variables except the ones listed above, and the
one defined by this property ("<code class="literal">system</code>") would be blocked.</p><div class="note" style="margin-left: 0; margin-right: 10%;"><h3 class="title">Note</h3><p>The few custom variables always created by the SLS as documented in
<a class="link" href="#x123123_SLS_Logging_Variables" title="25.12. SLS Logging Variables">"SLS Logging Variables"</a> (such as "rc", "cc",
"tenant" etc.) are not affected
by the whitelisting. They are always created with these names; the reason is
that those variables are also used for log records that do not contain one of
the documented SLS messages, specifically debug or trace logging.</p></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_header_parameter_logging"></a>25.12.2. Header / Parameter Logging</h3></div></div></div><p>The SLS creates custom logging variables for all request parameters and headers,
so that they can be printed with all log records as well. The logging variable
syntax in the layout string looks like this:</p><p><span class="strong"><strong><code class="literal">%X{parameter:&lt;name&gt;}</code></strong></span></p><p>Prints the value of the HTTP request parameter with the name <span class="emphasis"><em><code class="literal">&lt;name&gt;</code></em></span>.</p><p><span class="strong"><strong><code class="literal">%X{header:&lt;name&gt;}</code></strong></span></p><p>Prints the value of the HTTP request header with the name <span class="emphasis"><em><code class="literal">&lt;name&gt;</code></em></span>.</p><p><span class="emphasis"><em>IMPORTANT: Be aware that some parameters might carry sensitive information,
such as passwords. If they are exposed as logging variables, the SLS cannot filter
those values out of the log records.</em></span></p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_custom_log_messages"></a>25.13. Custom Log Messages</h2></div></div></div><p>It is possible to create new, custom log messages, or override the text,
severity and / or category of the existing ones. A new custom log message can
be defined through the following static configuration property in the
"sls.properties" file:</p><pre class="programlisting">log.message.&lt;id&gt;.text=&lt;text&gt;
log.message.&lt;id&gt;.category=&lt;category&gt;
log.message.&lt;id&gt;.severity=&lt;severity&gt;</pre><p>The first of these properties (with the text) is mandatory, the other two are
optional. The "<code class="literal"><span class="emphasis"><em>&lt;id&gt;</em></span></code>" part of the message defines the actual message ID,
that will be logged in square brackets in the log record (just like all the
message IDs documented in the "<code class="literal">sls-logmessages.pdf</code>" file).</p><p>A complete example for a new custom log message would be:</p><pre class="programlisting">log.message.HELLO.text=Hello user ${session.getCred('username')}
log.message.HELLO.category=USER
log.message.HELLO.severity=WARN</pre><p>Logging Custom Log Messages</p><p>Since the existing SLS code doesn’t know anything about new custom log
messages and will never log them, a JEXL function is required in order to
actually log such a message:</p><pre class="screen">function.logCustomMessage('&lt;id&gt;');</pre><p>With the example log message defined above, an example invocation in the
login model would be:</p><pre class="programlisting">model.login.state.50.name=do.generic-log
model.login.state.50.action.1=${function.logCustomMessage('HELLO')}</pre><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_custom_log_message_properties"></a>25.13.1. Custom Log Message Properties</h3></div></div></div><p>The detailed description for each property is as follows:</p><p><span class="strong"><strong><code class="literal">log.message.<code class="literal"><span class="emphasis"><em>&lt;id&gt;</em></span></code>.text</code></strong></span></p><p>Defines the log message text. NOTE: This text can contain JEXL / Groovy
expressions that will be evaluated at the time of writing the log record, so
it is possible to use session information in a custom log message. Example:</p><pre class="programlisting">log.message.HELLO.text=Hello user ${session.getCred('username')}</pre><p><span class="strong"><strong><code class="literal">log.message.<code class="literal"><span class="emphasis"><em>&lt;id&gt;</em></span></code>.category</code></strong></span></p><p><span class="emphasis"><em>Optional:</em></span> Defines the category of the message. Must be one of the following
values:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">AUDIT</code> - The message will be logged into the "<code class="literal">audit.log</code>" file.
</li><li class="listitem">
<code class="literal">SYSTEM</code> - The message will be logged into the "<code class="literal">sls.log</code>" file and indicates
some kind of technical / environment issue.
</li><li class="listitem">
<code class="literal">USER</code> - The message will be logged into the "<code class="literal">sls.log</code>" file and indicates a
user-related issue (like a problem with the credentials).
</li></ul></div><p>Defaults to "<code class="literal">AUDIT</code>" if not specified.</p><p><span class="strong"><strong><code class="literal">log.message.<code class="literal"><span class="emphasis"><em>&lt;id&gt;</em></span></code>.severity</code></strong></span></p><p><span class="emphasis"><em>Optional:</em></span> Defines the severity of the message. Must be one of the following
values:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">INFO</code> - For informational log message.
</li><li class="listitem">
<code class="literal">WARN</code> - For warning log messages.
</li><li class="listitem">
<code class="literal">ERROR</code> - For messages indicating errors.
</li></ul></div><p>These values correspond to the logger level defined in the logging configuration
file. Defaults to "<code class="literal">INFO</code>" if not specified.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_overriding_existing_log_message"></a>25.13.2. Overriding Existing Log Message</h3></div></div></div><p>It is also possible to re-define (and thereby override) existing log messages,
such as "<code class="literal">USER_AUTH_SUCCESS</code>", like in the following example:</p><pre class="programlisting">log.message.USER_AUTH_SUCCESS.text=id=${session.getCred('username')}</pre><p>This would change the text of the log message, so that each time a user
successfully completes a login, the following message would be logged to the
"audit.log" file:</p><pre class="screen">[AUDIT] [USER_AUTH_SUCCESS] id=MrX</pre><p>instead of the current message that is logged today:</p><pre class="screen">[AUDIT] [USER_AUTH_SUCCESS] Authentication successfully completed. User: 'MrX'</pre><p><span class="emphasis"><em>NOTE: Severity and Category of existing log messages will remain unchanged, as
long as they are not explicitely changed (so their existing values are the
defaults).</em></span></p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_performance_log"></a>25.14. Performance Log</h2></div></div></div><p>By default the SLS performance log logs durations in millseconds with microsecond
resolution, e.g. <code class="literal">12.345</code>. This behavior can be changed via the configuration
property <code class="literal">log.performance.resolution</code> with allowed values <code class="literal">millisecs</code> (e.g. <code class="literal">12</code>),
<code class="literal">microsecs</code> (e.g. <code class="literal">12.345</code>, the default) and <code class="literal">nanosecs</code> (e.g. <code class="literal">12.345678</code>).
If an illegal value is configured, a configuration error is logged once and
the performance log defaults to microsecond resolution.</p><p>Note that how precise logged times are depends on hardware and OS, but they
can usually help to analyze performance.</p></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="_hsp_load_balancing"></a>Chapter 26. HSP Load Balancing</h2></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_introduction_7"></a>26.1. Introduction</h2></div></div></div><p>The HSP reverse proxy supports load-balancing between multiple SLS instances. It is possible to have the SLS send information about its own load-status, in order to enforce a certain reaction on behalf of the HSP reverse proxy (like starting to send all requests to other SLS instances if one is under heavy load).</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_sls_load_calculation"></a>26.2. SLS Load Calculation</h2></div></div></div><p>Currently, the load of the SLS is calculated simply by the number of open login sessions as percentage of a given maximum threshold. The resulting load number sent to the HSP reverse proxy is always a number between 0 (no load) and 100 (completely used up).</p><p>There are a number of configuration properties that allow to activate and adapt how the SLS sends load information.</p><p><span class="strong"><strong><code class="literal">load.max.threshold</code></strong></span></p><p><span class="emphasis"><em>In "sls.properties":</em></span> The maximum number of login sessions for the SLS. If this number is reached or exceeded, the load value sent to the HSP will be 100.</p><p>Example for up to 200 concurrent login sessions:</p><pre class="programlisting">load.max.threshold=200</pre><p><span class="strong"><strong><code class="literal">load.header.overwrite</code></strong></span></p><p><span class="emphasis"><em>In "sls-dynamic.properties"</em></span>: This dynamic property allows to manually override the calculated load value, and instead send a configured one to the HSP. As soon as this property is set in the configuration file "sls-dynamic.properties", the value of that property will be sent to the HSP as the load value.</p><p>The idea here is that this allows to manually enforce that the SLS sends the HSP load information which indicates that it wants no more new sessions. This way, the SLS instance can be taken out of the loop for maintenance downtime, without interrupting any ongoing login sessions.</p><p>Example:</p><pre class="programlisting">load.header.overwrite=100</pre></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="x12345_Heading1Tarsec_loadbalancing_failover"></a>Chapter 27. Load-Balancing / Failover</h2></div></div></div><p>The SLS supports 3 modes of handling multiple backends for different adapters:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
Simple failover (default)
</li><li class="listitem">
Failover with a primary system
</li><li class="listitem">
Load-Balancing
</li></ul></div><p>These 3 modes of operation are mutually exclusive. It is possible, however, to
use a different mode for each group of backend systems. For example, simple
failover could be used for the LDAP authentication URLs, while load-balancing
would be activated for a HTTP adapter backend.</p><p>When multiple backends are configured for an adapter, the default behaviour is
simple failover. Here is an explanation of each mode, and how it relates to
backend-monitoring.</p><p>The following adapters support these features:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
LDAP
</li><li class="listitem">
HTTP
</li><li class="listitem">
Webservice
</li><li class="listitem">
RADIUS
</li><li class="listitem">
NTLM
</li></ul></div><p>See their corresponding chapters for details on how to enable the various
backend handling modes.</p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_simple_failover_default"></a>27.1. Simple Failover (default)</h2></div></div></div><p>When multiple backend URLs are configured for an adapter, and nothing else, the
SLS will perform a simple round-robin failover. Note: It will only perform a
failover whenever the currently used system becomes unavailable. So, in a scenario
with a backend "A" and "B", the SLS will start to use "A". Once "A" goes offline,
the SLS will switch to backend "B". But if "A" comes back online shortly after that,
the SLS will not fall back to it. It will continue using "B", until "B" goes offline,
or the SLS is restarted:</p><pre class="screen">...url=A,B

SLS starts -&gt; using "A"
"A" goes offline
SLS failover -&gt; using "B"
"A" goes back online
SLS continues using "B"
SLS restart -&gt; using "A"</pre><p>The second failover mode (failover with a primary system) supports an automatic
fallback to the first backend, as described in the next chapter.</p><p>Backend-monitoring, if enabled, will basically just trigger a failover in the
background, if the current system becomes unavailable (so it doesn’t happen
during the next login session). And it will of course write corresponding log
messages that might be evaluated externally.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_failover_with_primary_system"></a>27.2. Failover with primary system</h2></div></div></div><p>In this mode, the first system in the list of comma-separated backend URLs
is regarded as the "primary" system. This primary system always has higher
priority than the other ones, so if the SLS had to perform a failover to one
of the fallback systems and the primary becomes available again, the SLS will
automatically switch back to it.</p><p>Configuration:</p><pre class="screen">...url=A,B
...backendsMode=failoverWithPrimary</pre><p>Flow:</p><pre class="screen">SLS starts -&gt; using "A"
"A" goes offline
SLS failover -&gt; using "B"
"A" goes back online
SLS switches back to "A"</pre><p>This feature requires active backend-monitoring. Because of that, monitoring
will automatically be enabled when this type of failover functionality is used.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_load_balancing"></a>27.3. Load-Balancing</h2></div></div></div><p>As another option, a simple round-robin load-balancing can be used for handling
multiple backend URLs as well. In this case, the SLS will constantly switch
between all the listed backends, every time a new SLS session is started (so it
sticks to a given backend within one session). When one of the backends goes
offline, it will be marked as unavailable and no longer be used by the load
balancing mechanism.</p><p>This feature requires active backend-monitoring. Because of that, monitoring
will automatically be enabled when this type of failover functionality is used.
As soon as a backend comes online again and is picked up by the monitoring, it
will also be used for the load-balancing again.</p><p>Configuration:</p><pre class="screen">...url=A,B
...backendsMode=loadBalancing</pre></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="x12345_Heading1Tarsec_Connection_monitoring"></a>Chapter 28. Backend Monitoring</h2></div></div></div><p>Backend monitoring can be enabled optionally in simple failover mode, and is enabled
automatically for failover with a primary system or load-balancing.</p><p>In the default simple failover mode, its main purpose is to trigger a
failover outside of a running session, as soon as a backend goes offline,
so that the next login session will already work with the new backend, and not
be disturbed at all.</p><p>When using failover with a primary system, it is required to detect when the
primary system is available again, so a failover back to the primary can be
triggered.</p><p>With load-balancing it is needed in order to signal to the load-balancing mechanism
when a previously offline backend becomes available again.</p><p>Note: This monitoring feature can only be enabled or disabled on a global level.
If enabled, it will automatically be used for all adapters used in an SLS setup.</p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_configuration_property"></a>28.1. Configuration Property</h2></div></div></div><p><span class="strong"><strong><code class="literal">monitor.check.interval</code></strong></span></p><p>The time interval in seconds at which back-end systems are monitored. The
back-end systems monitor of the SLS will perform an adapter-specific connection
check to the configured backend.</p><p>If this property is not set, no back-end monitoring is performed, except if
load-balancing is enabled for any adapter. In that case, it will automatically
be enabled.</p><p>Example:</p><pre class="screen">monitor.check.interval=60</pre><p>See also <a class="link" href="#x1234_Heading1Tarsec_HTTP_Connection_monitoring" title="48.6. HTTP Connection monitoring">"HTTP Connection monitoring"</a> for
details about how to configure designated monitoring URLs for the HTTP adapter.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_temporarily_exlude_backend_from_monitoring"></a>28.2. Temporarily Exlude Backend From Monitoring</h2></div></div></div><p>There is a "dynamic" configuration property which allows to completely exclude
a certain backend system from the monitoring, and then enable it again, without
restarting the SLS.</p><p>Since this is a "dynamic" property, it must be stored in the configuration file</p><pre class="screen">WEB-INF/sls-dynamic.properties</pre><p>The name of the property is</p><p><span class="strong"><strong><code class="literal">unavailable.backends</code></strong></span></p><p>And the value is a comma-separated list of backend URLs or IPs that must match
the value of the given backend in the adapter configuration. For example, if
the LDAP adapter has this URL configured, with load-balancing:</p><pre class="screen">ldap.url=ldap://host-one.acme.com:389,ldap://host-two.acme.com:389
ldap.backendsMode=loadBalancing</pre><p>and the first system in the list should be taken down for maintenance for a
while, without having the SLS filling the log with <code class="literal">"BACKEND_UNAVAILABLE"</code>
messages during that time, the following property could be set in the
"sls-dynamic.properties" file:</p><pre class="screen">unavailable.backends=ldap://host-one.acme.com:389</pre><p>This means that the monitoring mechanism of the SLS will exclude that backend
from monitoring.</p><p>Since changes in the "sls-dynamic.properties" file do not require a restart,
this allows for a convenient handling of backend downtimes caused by
maintenance windows.</p></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="x10003_Heading1Tarsec_Parameter_Passing"></a>Chapter 29. HSP Parameter Passing / Gateway</h2></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_overview_9"></a>29.1. Overview</h2></div></div></div><p>This feature is useful in testing environments. It is disabled by default because
it has no practical use in a production environment and would pose a serious security risk.</p><p>As for the name of this feature - it is intended to allow to pass values for HSP
configuration directives dynamically, instead of using hard-coded settings as usual.
But as of now, only one value can be set this way, that of the <code class="literal">HGW_Host</code> directive.</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_difference_to_gw_param_property"></a>29.1.1. Difference to "gw-param"-Property</h3></div></div></div><p>In chapter <a class="link" href="#x99995_Heading3Tarsec_Modifying_Gateway_Parameters" title="29.7. Modifying Parameters with &quot;gw-param.&quot;">"Modifying Parameters with "gw-param.""</a>,
the configuration property "<code class="literal">gw-param.</code>" is described which also allows to
configure values to be generated for a variable in the HSP configuration.
However, with that approach, the generated value is set fix, independent
from the login request. There are possibilities to set the value depending
of certain login attributes through JEXL, but that can get quite complicated,
and is still limited.</p><p>The feature explained in this chapter extends that functionality in order to
explicitely support application development environments, so that application
programmers can use a shared SLS instance, but connect to their own local
application server instance after the login. The actual  host and port values
can be entered interactively, either as part of the login URL, or in a separate
HTML form provided by the SLS during the login process.</p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_how_it_works_2"></a>29.2. How it works</h2></div></div></div><p>It allows a developer / tester to dynamically specify the host and port of the
<span class="emphasis"><em>application</em></span> back-end server to which he or she will be connected after a
successful login. Usually, the (internal) hostnames or IP addresses of the
application server are fixed configuration settings in the SES/HSP location
configuration (or the SRManager, to be precise). The directive in a simplified
sample location usually looks like this:</p><pre class="screen">&lt;Location /web&gt;
SetHandler            http_1_1_gw_handler
HGW_Host              appserv.acme.com:13932
HGW_RequestHeaders    %HTTP11_std %HSP_std %HSP_ssl
AC_AccessArea         Customer
AC_AuthorizedPath     /web
AC_LoginPage          /web/sls/auth
&lt;/Location&gt;</pre><p>However, in integration testing and training environments, it may be useful to
be able to use a shared, central SLS instance for authentication, but to be
connected to a specific test application server afterwards - for example, an
application server instance running on the developers\' local workstation. The
following location replaces the fixed host and port value with a variable $ACA:</p><pre class="screen">&lt;Location /web&gt;
SetHandler            http_1_1_gw_handler
HGW_Host              $ACA
HGW_RequestHeaders    %HTTP11_std %HSP_std %HSP_ssl
AC_AccessArea         Customer
AC_AuthorizedPath     /web
AC_LoginPage          /web/sls/auth
&lt;/Location&gt;</pre><p>The SLS can now pass the host and port value for the $ACA variable to the HSP
through special HTTP headers after a successful authentication. The actual
values can either be provided by the user through URL parameters (when the
SLS login page is invoked), or from some optional SLS configuration properties,
or a combination of both. The parameter gateway functionality is configured
through a set of properties in the global configuration file "<code class="literal">sls.properties</code>".</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_installing_required_jar_file"></a>29.3. Installing Required ".jar" file</h2></div></div></div><p>Even if this feature is enabled in the configuration (see below), it is not
actually available, unless an additional, optional Java library is installed
in the SLS classpath directory. The reason for this approach was that it is
absolutely imperative that this functionality is not accidentally enabled in
a production environment. For this reason, the actual implementation resides
in a separate Java library, that can be found in the SLS delivery archive,
in the subdirectory "jars":</p><pre class="screen">sls-delivery-&lt;version&gt;/jars/sls-param-gw-impl-&lt;version&gt;.jar</pre><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
Copy this jar file into the subdirectory <code class="literal">"WEB-INF/lib"</code> of the SLS instance
where this feature should be used, and restart the servlet container.
</li></ul></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="x37596_Heading2Tarsec_Configuration_Properties"></a>29.4. Configuration Properties</h2></div></div></div><p>The HSP parameter passing feature can be enabled or disabled globally through
this configuration property:</p><p><span class="strong"><strong><code class="literal">hsp.param.passing.active</code></strong></span></p><p>If set to "<code class="literal">true</code>", the functionality is enabled, if set to "<code class="literal">false</code>", it is
disabled. As soon as this mechanism is enabled, and an application is accessed
which has its <code class="literal">HGW_Host</code> value set to <code class="literal">$ACA</code>, the SLS must provide host and
port values to the HSP. This means that for any such application location the
authenticating user must either provide those values through URL parameters,
or default values must have been configured as described below.</p><p><span class="strong"><strong><span class="emphasis"><em>Property grouping</em></span></strong></span></p><p>The following three configuration properties are always grouped together
through the <code class="literal"><span class="emphasis"><em>&lt;name&gt;</em></span></code> segment of the property name. One such group of
properties defines defaults for one application location.</p><p>Note that this <code class="literal"><span class="emphasis"><em>&lt;name&gt;</em></span></code> part is also used as a prefix for the names of the
URL parameters explained in the next chapter.</p><p><span class="strong"><strong><code class="literal">hsp.param.<code class="literal"><span class="emphasis"><em>&lt;name&gt;</em></span></code>.loc</code></strong></span></p><p>Specifies the application path to which all default values of the <code class="literal"><span class="emphasis"><em>&lt;name&gt;</em></span></code>
settings belong. As soon as this property is defined, corresponding host and
port values must be either provided dynamically through URL parameters, or
through the following two default value configuration properties.</p><p>The SLS will, after a successful login, create special HTTP headers (so-called
"SES Session Attributes) for the HSP, instructing the SRM to use the host and
port value for the <code class="literal">$ACA</code> variable in the corresponding location configuration.</p><p>So, if this property is set with the value <code class="literal">"/webapp/myapp"</code>, there should also
be an application location <code class="literal">"/webapp/myapp"</code> configured in the HSP, with the
<code class="literal">HGW_Host directive</code> set to <code class="literal">$ACA</code>.</p><p><span class="strong"><strong><code class="literal">hsp.param.<code class="literal"><span class="emphasis"><em>&lt;name&gt;</em></span></code>.host</code></strong></span></p><p>Defines a default hostname value for the application referred to by <code class="literal"><span class="emphasis"><em>&lt;name&gt;</em></span></code>.</p><p><span class="strong"><strong><code class="literal">hsp.param.<code class="literal"><span class="emphasis"><em>&lt;name&gt;</em></span></code>.port</code></strong></span></p><p>Defines a default port value for the application referred to by <code class="literal"><span class="emphasis"><em>&lt;name&gt;</em></span></code>.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_url_parameter_usage"></a>29.5. URL Parameter Usage</h2></div></div></div><p>In order to set custom host and port values, those values must be sent to the
SLS as URL parameters when invoking the login page. The best way to do this is
by creating a shortcut / bookmark in the browser with an appropriate link to
the SLS, such as</p><pre class="screen">http://www.acme.com/webapp/sls/auth?Xhost=172.17.8.92&amp;Xport=5000</pre><div class="note" style="margin-left: 0; margin-right: 10%;"><h3 class="title">Note</h3><p>The names of those parameters depend on the configuration, as described
before (see <a class="xref" href="#x37596_Heading2Tarsec_Configuration_Properties" title="29.4. Configuration Properties">Section 29.4, “Configuration Properties”</a>). The name of
the host and port parameters are always built like this:</p></div><pre class="screen">&lt;name&gt;Host
&lt;name&gt;Port</pre><p>The <code class="literal"><span class="emphasis"><em>&lt;name&gt;</em></span></code> prefix refers to the corresponding group of configuration
properies as explained in the previous chapter.</p><p>If the parameters are not provided, the SLS has to resort to default values
(if there are any in the configuration). If the SLS cannot determine any
default value, it will display an additional form, requesting proper values
for the missing host and port.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_example_2"></a>29.6. Example</h2></div></div></div><p>The following example configuration works like this:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
It supposes that there are two applications, for which the reference names
"A" and "B" are used. For application "A", default values for the host and
port are configured. This means that if anyone logs in and accesses application
"A" without providing any custom host and port values in URL parameters, these
defaults will be used.
</li><li class="listitem">
For application "B", no defaults are configured. If anyone accesses that
application without providing the host and port values as URL parameters,
an HTML form page will be displayed after the login step, requesting the
user to enter the required values. Otherwise, the HSP cannot connect the
client to any back-end system.
</li></ul></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_example_configuration"></a>29.6.1. Example configuration</h3></div></div></div><pre class="programlisting"># Mandatory: Define path of the "A" application
hsp.param.A.loc=/web/a

# Define default host and port
hsp.param.A.host=appserver.acme.com
hsp.param.A.port=80

# Mandatory: Define path for which the "B"
# parameter definitions are valid.
hsp.param.B.loc=/web/b</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_example_usage"></a>29.6.2. Example Usage</h3></div></div></div><p>The following URL would invoke the login page and, after a successful login,
redirect the client to the application "<code class="literal">/web/a</code>", while connecting the client
to the application server with the IP address 172.17.2.92 on port 81:</p><pre class="screen">http://www.acme.com/web/sls/auth?AHost=172.17.2.92&amp;APort=81&amp;target=%2fwebapp%2fa</pre><p>The following URL intends to invoke the login page and, after a successful
login, redirect the client to the application "<code class="literal">/web/b</code>". However, since no
host and port values are provided in the URL, and no defaults had been
configured, the SLS will show a HTML form where the missing host and port
values must be entered.</p><pre class="screen">http://www.acme.com/web/sls/auth?target=%2fwebapp%2fb</pre><p>It is of course also possible to set URL parameters for applications "A" and
"B" all at once:</p><pre class="screen">http://www.acme.com/web/sls/auth?AHost=172.17.2.92&amp;APort=81&amp;BHost=172.17.3.65&amp;BPort=90&amp;target=%2fwebapp%2fa</pre></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="x99995_Heading3Tarsec_Modifying_Gateway_Parameters"></a>29.7. Modifying Parameters with "gw-param."</h2></div></div></div><p>As mentioned in the previous chapters, there is also a more generic way to
override values of the SES configuration by using the SLS parameter passing
functionality. This mechanism is configured through properties in the
configuration file "<code class="literal">sls.properties</code>":</p><p><span class="strong"><strong><code class="literal">gw-param.&lt;HGW-directive&gt;</code></strong></span></p><p><code class="literal">&lt;host:port&gt;</code></p><p>The following example shows how to configure it appropriately.</p><p>SRManager configuration:</p><pre class="screen">&lt;Location /demo/sls&gt;
  SetHandler                  http_1_1_gw_handler
  HGW_Host                    $ACA
  AC_AuthorizedPath           /demo/app
  AC_LoginPage                /demo/sls/auth
&lt;/Location&gt;</pre><p>And the corresponding SLS property in "<code class="literal">sls.properties</code>":</p><p><code class="literal">gw-param.</code><span class="strong"><strong>HGW_Host</strong></span>=192.168.1.54:4566</p><p>Of course it is possible to use expressions which enhances the flexibility
enormously. The following example shows an expression with a "if" condition.</p><pre class="screen">gw-param.HGW_Host=${if(header.myHeader==2) {'132.23.23.2:234'} else {'132.23.23.2:235'}}</pre></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="x66021_Heading1Tarsec_SES_Login_Ticket"></a>Chapter 30. SES Login Ticket</h2></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_introduction_8"></a>30.1. Introduction</h2></div></div></div><p>The SLS may be configured to generate one or more SES login tickets after every successful login. Such login tickets can then be propagated to the application server in custom HTTP request headers through the HSP reverse proxy.</p><p>An SES login ticket contains encrypted authentication information and is digitally signed by the SLS to ensure integrity and authenticity. Backend applications may later make use of the login ticket's information by using the <span class="emphasis"><em>SES Ticket API</em></span> to extract user specific attributes such as the username or custom attributes.</p><p>For the application server (or filters therein) to be able to verify tickets and decrypt information stored in them, they need to be equipped with the appropriate keys. Please read the SES Ticket API developers guide for information about key creation and configuration.</p><p>This <span class="emphasis"><em>SES Ticket API</em></span> provides the necessary functionality to verify the Login Ticket's validity and to access the encrypted data. It supports different application server technologies by providing implementations in Java, C, COM, and Perl. For more informations about the <span class="emphasis"><em>SES Ticket API</em></span> and its appliance, consult the SES Ticket API developers guide.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_issuing_ses_login_tickets"></a>30.2. Issuing SES Login Tickets</h2></div></div></div><p>The SLS can issue one or multiple login tickets. Tickets can then be propagated to the application either in custom HTTP headers, or as request parameters etc., based on the various configuration options described in <a class="link" href="#x53260_Heading1Tarsec_SSO_Integration" title="Chapter 23. SSO Integration">"SSO Integration"</a>. The typical way of using it is to propagate the ticket in a custom HTTP header to the application..</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_configuration_3"></a>30.3. Configuration</h2></div></div></div><p>For every ticket to be created after a successful login (well, usually only one), a group of properties must be defined in the "sls.properties" file. Such a group of properties always has a prefix</p><p><code class="literal">ses.ticket.<code class="literal"><span class="emphasis"><em>&lt;name&gt;</em></span></code>.</code></p><p>where the &lt;name&gt; part is used to group the properties for one ticket definition together. This <code class="literal"><span class="emphasis"><em>&lt;name&gt;</em></span></code> value also corresponds to the first argument of the JEXL function for creating tickets (see chapter <a class="link" href="#x49003_Heading1Tarsec_Expressions" title="Chapter 32. JEXL Expressions">"JEXL Expressions"</a>).</p><p>The following properties are available to configure one login ticket:</p><p><span class="strong"><strong><code class="literal">ses.ticket.&lt;name&gt;.realm</code></strong></span></p><p>The realm of the login ticket.</p><p><span class="strong"><strong><code class="literal">ses.ticket.&lt;name&gt;.lifetime</code></strong></span></p><p>The lifetime of the ticket in milliseconds.</p><p><span class="strong"><strong><code class="literal">ses.ticket.&lt;name&gt;.keyIndexFile</code></strong></span></p><p>The location of the key index file. This file specifies the actual file locations of the keys referred to by alias in the following properties.</p><p><span class="strong"><strong><code class="literal">ses.ticket.&lt;name&gt;.public.key</code></strong></span></p><p>The alias of the public key to use (must be an alias for which a key file is defined in the key index file, e.g.: <code class="literal">key_2</code>). This is the key that the application must use to verify the ticket signature.</p><p><span class="strong"><strong><code class="literal">ses.ticket.&lt;name&gt;.private.key</code></strong></span></p><p>The alias of the private key to use (must be an alias for which a key file is defined in the key index file, e.g.: <code class="literal">key_1</code>). This is the key that the SLS uses to sign the ticket.</p><p><span class="strong"><strong><code class="literal">ses.ticket.&lt;name&gt;.encryption.key</code></strong></span></p><p>Optional: A symmetric encryption key, used to encrypt the ticket payload.</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_custom_ticket_attributes"></a>30.3.1. Custom Ticket Attributes</h3></div></div></div><p>An SES ticket can optionally contain custom attributes, where each attribute is just a key-/value pair of strings. Custom attributes can be defined using the following pattern:</p><pre class="programlisting">ses.ticket.&lt;name&gt;.attr.&lt;key&gt;=&lt;value&gt;</pre></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_example_3"></a>30.4. Example</h2></div></div></div><p>With an appropriate set of properties to configure a ticket, such tickets can be created using the JEXL function <code class="literal">createTicket()</code> (see chapter <a class="link" href="#x59773_Heading2Tarsec_Functions" title="32.8. Functions">"Functions"</a>).</p><p>The following example demonstrates how to propagate an SES ticket to the application in a custom HTTP header "<code class="literal">userinfo</code>". The ticket name in the configuration is "<code class="literal">loginticket</code>" and the username is the value of the request parameter "<code class="literal">userid</code>" (which would be the name of the form field in the login page):</p><pre class="programlisting"># Define ticket 'loginticket'
ses.ticket.loginticket.realm=ACME
ses.ticket.loginticket.lifetime=30000
ses.ticket.loginticket.keyIndexFile=/opt/usp/sls/keys/list.keyindex
ses.ticket.loginticket.public.key=key_2
ses.ticket.loginticket.private.key=key_1

# Custom attribute \'pwd\' containing users password,
# is encrypted with symmetrical key
ses.ticket.loginticket.attr.pwd.key_3=${parameter.password}

# For the application to know which key to use to decrypt the
# password attribute, set another attribute holding the alias
# of the encryption key.
ses.ticket.loginticket.attr.pwdid=key_3

# Another custom attribute with a fixed value
ses.ticket.loginticket.attr.location=Connecticut

# Create and propagate ticket
app.header.userinfo=${function.createTicket('loginticket',parameter.userid)}</pre><p><span class="strong"><strong>HSP Configuration</strong></span></p><p>Any custom HTTP header that should be sent to the application server must also be enabled in the HSP configuration (for details see  <a class="link" href="#HTTPADMIN">[HTTPADMIN]</a>). Otherwise, it will be blocked and not be forwarded to the application. The following directive enables the custom header "userinfo" for the application "/app". This is the header we need to enable for the above example.</p><pre class="screen">&lt;Location /app&gt;
[...]
HGW_RequestHeaders        +userinfo</pre><p><code class="literal">&lt;/Location&gt;</code></p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_ses_ticket_credential_provider"></a>30.5. SES Ticket Credential Provider</h2></div></div></div><p>The SES ticket credential provider allows the login service to process existing SES tickets of logged-in users and extract the username. .</p><p>To activate and use this credential provider, the following properties must be added to the "<code class="literal">sls.properties</code>" file:</p><pre class="programlisting"># Internal: Name of provider implementation class
cred.provider.class.sesticket=
com.usp.sls.toolkit.http.cred.SesTicketCredentialProvider

# Extract username credential from SES login tickets
# in incoming HTTP header 'SES_TICKET'
cred.provider.1=sesticket
cred.provider.1.cred.1.type=username
cred.provider.1.cred.1.source=header
cred.provider.1.cred.1.name=SES_TICKET</pre><p>Certain JSPs such as the login or change password page will then automatically insert the user ID into the appropriate form field.</p></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="x66021_Heading1Tarsec_JSON_Web_Tokens"></a>Chapter 31. JSON Web Tokens</h2></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_introduction_9"></a>31.1. Introduction</h2></div></div></div><p>The SLS supports creation and parsing of JSON Web Tokens (JWTs).</p><p>JSON Web Tokens are an open, industry standard RFC 7519 method for representing
claims securely between two parties, see <a class="ulink" href="http://jwt.io/" target="_top">http://jwt.io/</a>.</p><p>They are used in OpenID Connect and often in OAuth 2.0, but their usage is not
limited to that context.</p><p>In particular, all major web servers offer filters for authentication with JWTs.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_issuing_json_web_tokens"></a>31.2. Issuing JSON Web Tokens</h2></div></div></div><p>The SLS can issue one or multiple JWTs.
JWTs can then be propagated to the application in HTTP headers or request parameters etc.,
as desired. A common way to propagate JWTs is as an "Authorization" HTTP Header with
its value prefixed with "Bearer ".</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_configuration_4"></a>31.2.1. Configuration</h3></div></div></div><p>All of the following items are optional per JWT standard, but usually most of them
are set to create a meaningful JWT.</p><p>Note that date claims "exp", "nbf" and "iat" must be given in ISO 8601 UTC date+time
format, e.g. "2016-11-16T12:34:53Z".
Use the script functions <code class="literal">jwt.getIso8601UtcDateForNow()</code>
and <code class="literal">jwt.getIso8601UtcDateFor(Date date)</code> to get date strings for now or for
a <code class="literal">java.util.Date</code> obtained/calculated in another way.</p><p><code class="literal">jwt.def.&lt;alias&gt;.iss</code></p><p>The issuer of the JWT. A string value, optional.</p><p><code class="literal">jwt.def.&lt;alias&gt;.sub</code></p><p>The subject to which the JWT is issued. A string value, optional.</p><p><code class="literal">jwt.def.&lt;alias&gt;.aud</code></p><p>The intended audience for the JWT. String values separated by spaces, optional.
Stored in the JWT as an array of audiences.</p><p><code class="literal">jwt.def.&lt;alias&gt;.exp</code></p><p>When the JWT expires ("expiration time").
A string value in ISO 8601 UTC time format (see above), optional.</p><p><code class="literal">jwt.def.&lt;alias&gt;.nbf</code></p><p>From when on ("not before") the JWT is valid.
A string value in ISO 8601 UTC time format (see above), optional.</p><p><code class="literal">jwt.def.&lt;alias&gt;.iat</code></p><p>When the JWT was issued ("issued at").
A string value in ISO 8601 UTC time format (see above), optional.</p><p><code class="literal">jwt.def.&lt;alias&gt;.claim.&lt;name&gt;=&lt;value&gt;</code></p><p>Custom string claims to add to the JWT, optional.</p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_parsing_and_validating_jwts"></a>31.3. Parsing and validating JWTs</h2></div></div></div><p>See the corresponding <code class="literal">jwt</code> script functions.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_direct_use_of_jwt_java_objects"></a>31.4. Direct use of JWT Java Objects</h2></div></div></div><p>The SLS uses the Nimbus JOSE JWT Library.</p><p>Script functions that create a JWT from scratch or by parsing a string
yield a com.nimbusds.jwt.JWT object that can be further operated on
for handling use cases not currently supported by SLS configuration
and <code class="literal">jwt</code> script functions.</p></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="x49003_Heading1Tarsec_Expressions"></a>Chapter 32. JEXL Expressions</h2></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_introduction_10"></a>32.1. Introduction</h2></div></div></div><p>Values of configuration properties can either have fixed values or can consist of (or contain) JEXL expressions. JEXL (_J_ava _Ex_pression _L_anguage) is a light-weight, efficient open-source expression scripting system that allows to create and use values and access functions dynamically. More information about it can be found on Apache's website:</p><p><a class="ulink" href="http://commons.apache.org/jexl/" target="_top">http://commons.apache.org/jexl/</a></p><p>For the SLS this means two things:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
During any process such as authentication, mapping etc., the SLS creates JEXL variables for values such as request parameters or headers, authentication adapter response attributes etc. These variables can be used within of or as values of configuration properties. More detailled explanations and a few examples follow below.
</li><li class="listitem">
JEXL also allows to provide access to simple functions, such as string manipulations, de- or encodings, regular expressions etc. Such functions can be used to dynamically set the value of a configuration property based on the values of the current session.
</li></ul></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="x75969_Heading2Tarsec_JEXL_Versions"></a>32.2. JEXL Versions</h2></div></div></div><p>As of release 5.0.0.1, JEXL 2 is supported (JEXL 1 is no longer supported).</p><p>See <a class="link" href="#x92172_Heading2Tarsec_JEXL_Version_Issues" title="32.9. JEXL Known Issues">"JEXL Version Issues"</a> if you need to migrate from JEXL 1.
Note that JEXL 2 in general is almost 100% backward compatible with JEXL 1.
Besides of some rare special cases (like a different behaviour in using "\" escape characters in strings)
a main difference is that it is not possible to set variables with "-" (dash) characters in their names anymore.
While this has always been deemed illegal by the official JEXL documentation, it was still possible with JEXL 1.
With JEXL 2 however, such variables cannot be used at all anymore.
The SLS replaces "-" (dash) characters in variable names with "_" (underscore) characters automatically
to work around this issue.</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_groovy_scripting"></a>32.2.1. Groovy Scripting</h3></div></div></div><p>Since release 4.24.0, Groovy can be used in addition to JEXL, if desired. See the next chapter for details.</p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_expressions"></a>32.3. Expressions</h2></div></div></div><p>All JEXL expressions must be defined by enclosing them in a "<code class="literal">${</code>"-prefix and a "<code class="literal">}</code>"-suffix, like this:</p><pre class="screen">${&lt;JEXL expression&gt;}</pre><p>Since a JEXL expression in the end always results in a String value,  the simplest and most common expression is just a variable name, like</p><pre class="screen">${ldap.attribute.mailAddress}</pre><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_variable_scope"></a>32.3.1. Variable scope</h3></div></div></div><p>All JEXL variables have a session scope, which means once they are created, they exist as long as the SLS login session.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="Expressions_Persistent_variables"></a>32.3.2. Persistent Variables</h3></div></div></div><p>It is possible to store JEXL variables automatically in the SLS "Userinfo"-cookie
at the end of the session. That cookie (which is only stored in the reverse proxy
session, and never reaches the client) stores various information for the SLS
about the current user, and is processed automatically whenever the SLS is
invoked again after the login (for example, for a password change flow).</p><p>In order to define certain JEXL variables to be stored in the user-info cookie,
the following property can be used.</p><p><span class="strong"><strong><code class="literal">persist.variable</code></strong></span></p><p>The value of the property must be the actual name of the variable (not an expression),
e.g. like this to persist the variable "userMail":</p><pre class="programlisting">persist.variable=userMail</pre><p>In order to store multiple variables, use a numbering suffix, e.g.</p><pre class="programlisting">persist.variable.1=userMail
persist.variable.2=streetName
persist.variable.3=city</pre><div class="note" style="margin-left: 0; margin-right: 10%;"><h3 class="title">Note</h3><p>By default, the variables are restored once per each request, from the
cookie. If it is preferable to have it restored only once per session, the
following property can be set:</p></div><pre class="screen">persist.mode=session</pre><p>By default, the property has the value <code class="literal">"request"</code>, which means restoring the
variables once per each incoming request.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_strings_in_expressions"></a>32.3.3. Strings In Expressions</h3></div></div></div><p>Strings within JEXL expressions (for function parameters, for example) must be enclosed in single apostrophs &lt;\'&gt;, e.g.:</p><p><code class="literal">${session.getCred(<span class="emphasis"><em>username</em></span>)}</code></p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_java_method_calls"></a>32.3.4. Java Method Calls</h3></div></div></div><p>JEXL usually allows to invoke methods of any Java object that is represented by a variable, as long as those methods have simple parameter- and return-types (like String, int etc.). The most typical use-case would be to directly access methods of "java.lang.String" on a JEXL variable, since most JEXL variables are just Java Strings.</p><p>This is a practical example of how to extract and change a part of the value of a RADIUS response attribute variable:</p><pre class="screen">${function.getVariable('attribute.radius.21').substring(1,2).toUpperCase()}</pre><p>This example extracts the second character of the value of the RADIUS response attribute 21 (by invoking the method "<code class="literal">substring()</code>" of "<code class="literal">java.lang.String</code>") and changes it to uppercase (by invoking "<code class="literal">toUpperCase()</code>").</p><p>Of course not all JEXL variables are always objects of type "java.lang.String", so using this JEXL feature requires some knowledge of the internals of a certain functionality (or a try- and error-approach).</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_static_method_calls"></a>32.3.5. Static Method Calls</h3></div></div></div><p>JEXL does not really support invocation of static methods the way it is usually done in Java, e.g. "<code class="literal">java.lang.Integer.parseInt(value)</code>". To do this in JEXL, the "new" keyword can be used to create an instance of any class, given that it has the corresponding constructors; then, that instance can be used to invoke the static methods. For example:</p><pre class="screen">// Create an instance of "java.lang.Integer" in the variable "myInteger"
myInteger = new ("java.lang.Integer", "0");
// Invoke method "java.lang.Integer.parseInt()" through the new prefix
myInteger.parseInt(value);</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_java_lang_math_vs_jexl_arithmetic"></a>32.3.6. java.lang.Math vs. JEXL Arithmetic</h3></div></div></div><p>Because "<code class="literal">java.lang.Math</code>" has only static methods and no public constructors, it is not possible to use the previously described approach to create an instance of it and use its methods. JEXL provides a custom class that substitutes some of the functionality of "<code class="literal">java.lang.Math</code>". The following example shows how to create an instance:</p><pre class="screen">mymath = new ("org.apache.commons.jexl2.JexlArithmetic", false);</pre><p>Please consult the online Javadoc for the "JexlArithmetic" class for more information about its functionality:</p><p><a class="ulink" href="http://commons.apache.org/proper/commons-jexl/apidocs/org/apache/commons/jexl2/JexlArithmetic.html" target="_top">http://commons.apache.org/proper/commons-jexl/apidocs/org/apache/commons/jexl2/JexlArithmetic.html</a></p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_nested_expressions"></a>32.3.7. Nested Expressions</h3></div></div></div><p>It is possible to use nested expressions as well. But in such a case, the whole nested expressions together need to be put within the brackets, and not each single expression.</p><p>Nesting of a JEXL variable ("<code class="literal">parameter.userid</code>") into a JEXL function:</p><p><span class="strong"><strong>${</strong></span><code class="literal"><span class="emphasis"><em>function.md5(parameter.userid)</em></span></code><span class="strong"><strong>}</strong></span></p><p><span class="strong"><strong><span class="emphasis"><em>Good nesting</em></span></strong></span></p><p><span class="emphasis"><em>Correct</em></span> nesting of two JEXL functions:</p><p><span class="strong"><strong>${</strong></span><code class="literal"><span class="emphasis"><em>function.md5(session.getCred(<span class="emphasis"><em>username</em></span>))</em></span></code><span class="strong"><strong>}</strong></span></p><p><span class="strong"><strong><span class="emphasis"><em>Bad nesting</em></span></strong></span></p><p><span class="emphasis"><em>Invalid</em></span> nesting example:</p><p><span class="strong"><strong>${</strong></span><code class="literal"><span class="emphasis"><em>function.md5(</em></span></code><span class="strong"><strong>${</strong></span><code class="literal"><span class="emphasis"><em>session.getCred(<span class="emphasis"><em>username</em></span>)</em></span></code><span class="strong"><strong>}</strong></span><code class="literal"><span class="emphasis"><em>)</em></span></code><span class="strong"><strong>}</strong></span></p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_model_state_based_jexl_invocation"></a>32.3.8. Model-state based JEXL invocation</h3></div></div></div><p>Note that it is also possible to invoke JEXL function calls from within the current model, through custom actions, as described in <a class="link" href="#x47278_Heading3Tarsec_Custom_Actions" title="7.6.1. Custom Actions">"Custom Actions"</a>. This also allows to, for example, invoke custom-written JEXL functions which would perform some kind of update or notification operation at any given point within the model.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="x26475_Heading3Tarsec_Array_Handling_Parsing_Bug"></a>32.3.9. Array Handling / Parsing Bug</h3></div></div></div><p>There is a bug in the current JEXL implementation when it comes to dealing with entries of array variables. Usually, when a JEXL variable isn't a simple string or integer value, but an array ob values, an entry of the array can be accessed by using one of two notation options:</p><pre class="screen">arrayVariable[&lt;index&gt;]
arrayVariable.&lt;index&gt;</pre><p>But as soon as the variable <span class="emphasis"><em>name</em></span> itself contains one or more dots, the parser fails to resolve the expression properly, and the result is unpredictable. So, the following example would not work</p><pre class="screen">array.variable[2]</pre><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="_workaround"></a>Workaround</h4></div></div></div><p>As a workaround, the variable containing the array can be copied into another variable with a simple name (without dots), and then that new variable can be used to access the array entries. In the SLS model, this could be done with two actions:</p><pre class="screen">...state.10.action.1=${function.setVariable('simple',array.variable)}
...state.10.action.2=${simple[2]}</pre><p><span class="strong"><strong><span class="emphasis"><em>Array Size</em></span></strong></span></p><p>The size of an array can be determined using the built-in JEXL function <code class="literal">size()</code>, e.g. "<code class="literal">size(myArray)</code>".</p></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_execution_of_external_jexl_scripts"></a>32.3.10. Execution of external JEXL Scripts</h3></div></div></div><p>Sometimes, it's preferable to put highly complex JEXL expressions in external, separate script files. The directory path for such scripts is</p><pre class="screen">&lt;sls-webapp&gt;/WEB-INF/scripts/</pre><p>The files are not required to have any specific suffix, but it is recommended to use something intuitive like "<code class="literal">.jexl</code>", e.g.:</p><pre class="screen">&lt;sls-webapp&gt;/WEB-INF/scripts/dostuff.jexl</pre><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="_jexl_script_syntax"></a>JEXL Script Syntax</h4></div></div></div><p>A JEXL script can contain 1 - n lines with JEXL expressions / statements. Each statement must be terminated with a semicolon.</p><p><span class="strong"><strong>Return Value</strong></span></p><p>If the script is supposed to work like a function and return a value, the variable holding that value must be put at the last line. If the script is used in a condition, the return value should be a string containing either "<code class="literal">true</code>" or "<code class="literal">false</code>".</p><p><span class="strong"><strong>Comments</strong></span></p><p>Comments can be inserted by starting a line with a double slash, e.g.:</p><pre class="screen">// This is a comment</pre></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="_example_1"></a>Example 1</h4></div></div></div><p>Returns a string with a "hello," message, greeting the user defined in the JEXL variable "<code class="literal">firstname</code>":</p><p>'hello, \' \+ firstname;</p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="_example_2_2"></a>Example 2</h4></div></div></div><p>A simple example of a JEXL script which creates a counter object named "<code class="literal">ctr</code>" on first invocation, then increases it with every following invocation, and returns the current value of the counter:</p><pre class="screen">if(function.getVariable('ctr') == null) {
    function.createCounter('ctr');
}
// Now the variable 'ctr' must exist and can be used
ctr.increase();
// Return current value of counter object 'ctr'
ctr.getCounter();</pre></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="_script_file_alias_definition_and_script_invocation"></a>Script-File Alias Definition and Script Invocation</h4></div></div></div><p>In order to use such a script file, an alias for it must be defined in the "<code class="literal">sls.properties</code>" file first, e.g.:</p><p><span class="strong"><strong>script.file.<span class="emphasis"><em>&lt;alias&gt;</em></span></strong></span></p><pre class="programlisting">script.file.doit=dostuff.jexl</pre><p>The script can then be executed from the model like this:</p><pre class="programlisting">model.state....action.1=${runscript.jexl('doit')}</pre></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_typical_sls_variables"></a>32.3.11. Typical SLS Variables</h3></div></div></div><p>For example, any parameters sent in the authentication request, such as the user login ID or the password, are stored - for the duration of the login session - in variables which can be used in strings in configuration properties.</p><p>A reference to a cached variable always follows this syntax:</p><p><code class="literal">${&lt;type&gt;.&lt;name&gt;}</code></p><p><code class="literal"><span class="emphasis"><em>&lt;type&gt;</em></span></code> defines the source for the variables\' value (a request parameter, a response attribute etc.) and must be one of the values listed in the table below. The allowed values for the <code class="literal"><span class="emphasis"><em>&lt;name&gt;</em></span></code> part depend on the type of the variable. This is also explained for each type in the following table.</p><p>Here are a few variable examples:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">${parameter.id}</code>
Contains the value of the HTTP request parameter "id".
</li><li class="listitem">
<code class="literal">${header.host}</code>
Contains the value of the HTTP request header "host".
</li></ul></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="x77878_Heading3Tarsec_Using_Arrays_Multiple_Value_Variables"></a>32.3.12. Using Arrays (Multiple-Value Variables)</h3></div></div></div><p>A variable might be an array, which means it contains multiple values. A typical real-world example is an LDAP multi-value attribute. The values of an array are referenced by adding an index number to the variable name (indexing starts with 0):</p><p><code class="literal">myvariable.<span class="emphasis"><em>0</em></span></code> - Refers to the first value</p><p><code class="literal">myvariable.<span class="emphasis"><em>1</em></span></code> - Refers to the second value</p><p>For example, in case of a multi-value LDAP attribute named "<code class="literal">groups</code>" with values "<code class="literal">admin</code>", "<code class="literal">users</code>" and "<code class="literal">other</code>", the result would be:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">attribute.ldap.groups.0</code> = <span class="emphasis"><em><code class="literal">admin</code></em></span>
</li><li class="listitem">
<code class="literal">attribute.ldap.groups.1</code> = <span class="emphasis"><em><code class="literal">users</code></em></span>
</li><li class="listitem">
<code class="literal">attribute.ldap.groups.2</code> = <span class="emphasis"><em><code class="literal">other</code></em></span>
</li></ul></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="_array_functions"></a>Array Functions</h4></div></div></div><p>There are some functions that are helpful to work with arrays, especially "<code class="literal">function.arrayContains()</code>". It allows to check if one of the values of an array equals a certain expected / required value. Example:</p><pre class="screen">..state.10.action.1=${response.setAuthorization('admin')}
..state.10.action.1.if=${function.arrayContains(attribute.ldap.groups, 'admin')}</pre></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_important_variable_naming_rules"></a>32.3.13. Important Variable Naming Rules</h3></div></div></div><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
Variables must not contain a dash "-". It would be interpreted as the subtracion of two variables:
</li></ul></div><p><code class="literal">myvar.custom-7</code> is an invalid expression. </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
Variables must not end with a dot followed by a number. It would be interpreted as array index:
</li></ul></div><p><code class="literal">attribute.radius.11==attribute.radius[11]</code></p><p>In cases where a variable has such a name, it is possible to get around this problem by resolving variables using the JEXL function <span class="emphasis"><em>function.getVariable()</em></span>.</p><p><code class="literal">${function.getVariable(<span class="emphasis"><em>attribute.radius.11</em></span>)}</code></p><p>A nested example for setting a response header "X":</p><p><code class="literal">${response.setHeader(<span class="emphasis"><em>X</em></span>,function.getVariable(<span class="emphasis"><em>attribute.radius.11</em></span>))}</code></p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="x13698_Heading3Tarsec_Clearing_Variables_at_request_entry"></a>32.3.14. Clearing Variables at request entry</h3></div></div></div><p>JEXL variables in the SLS have by default a session scope. This means that once a variable is created, it exists in the SLS session until it is removed, or the session ends.</p><p>In some cases, this can lead to unwanted behaviour. For any such cases, there is a configuration switch that instructs the SLS to clear out all JEXL variables everytime a new request is processed.</p><p><span class="strong"><strong><code class="literal">jexl.clear.request.vars</code></strong></span></p><p>Optional: If set to "<code class="literal">true</code>", the SLS will clear all JEXL variables in the current session for every new request. Defaults to "<code class="literal">false</code>".</p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_variable_types"></a>32.4. Variable Types</h2></div></div></div><p>List of available variable types (meaning prefix) and values:</p><div class="table"><a id="idm6578"></a><p class="title"><strong>Table 32.1. List of all variable types and their possible values.</strong></p><div class="table-contents"><table class="table" summary="List of all variable types and their possible values." cellpadding="4px" style="border-collapse: collapse;border-top: 3px solid #527bbd; border-bottom: 3px solid #527bbd; border-left: 3px solid #527bbd; border-right: 3px solid #527bbd; "><colgroup><col class="col_1" /><col class="col_2" /><col class="col_3" /></colgroup><thead><tr><th style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top">Variable Type </th><th style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top">Variable Name Value(s) </th><th style="border-bottom: 1px solid #527bbd; " align="left" valign="top">Variable Value</th></tr></thead><tbody><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p><code class="literal">parameter.</code></p></td><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>The SLS automatically creates a variable with this prefix and the name of the request parameter as the suffix for each request parameter.</p></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>The value of the request parameter (string).</p>
<p>Note that all form fields from the login page etc. are of course also available as variables, for example</p>
<p><code class="literal">${parameter.userid}</code></p></td></tr><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p><code class="literal">header.</code></p></td><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>The SLS automatically creates a variable with this prefix and the name of the request header as the suffix for each request header.</p></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>The value of the HTTP request header (string).</p></td></tr><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p><code class="literal">cookie.</code></p></td><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>The SLS automatically creates a variable with this prefix and the name of the cookie as the suffix for each cookie.</p></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>The value of that given cookie (string).</p></td></tr><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p><code class="literal">config.</code></p></td><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>Name of a configuration property read from any of the SLS configuration properties files.</p></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>The value of that configuration property (or an empty string if no such configuration property exists).</p></td></tr><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p><code class="literal">attribute.</code></p></td><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>Name (or ID) of an additional attribute received in the response from the authentication adapter. Usually, attribute variables have a second part in their type, defining the adapter which created them:</p>
<p>attribute.ldap.&lt;name&gt;</p>
<p>attribute.radius.&lt;name&gt;</p>
<p>What name or ID values can be used depends on the adapter implementation.</p>
<p>For example, with the RADIUS adapter, the name must be a numeric ID, referring to the RADIUS response attributes as defined by the standard.</p>
<p>With an HTTP / Webservice adapter, on the other hand, the name values would be HTTP response header names.</p></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>The value of the response attribute received in the authentication response of the adapter (string).</p>
<p>For example, a customized adapter could add additional response attributes which contain a user's account number etc.</p></td></tr><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p><code class="literal">request.</code></p></td><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>Additional properties of the HTTP request, like HTTP method or URI.</p></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><p><a class="link" href="#x00000_Heading2Tarsec_Request_Variables" title="32.5. Request Variables">See following section</a> for details.</p></td></tr><tr><td style="border-right: 1px solid #527bbd; " align="left" valign="top"><p><code class="literal">special.</code></p></td><td style="border-right: 1px solid #527bbd; " align="left" valign="top"><p>Special variables for special use cases.</p></td><td style="" align="left" valign="top"><p><a class="link" href="#x80274_Heading2Tarsec_Special_Variables" title="32.6. Special Variables">See upcoming section here</a> for details.</p></td></tr></tbody></table></div></div><br class="table-break" /></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="x00000_Heading2Tarsec_Request_Variables"></a>32.5. Request Variables</h2></div></div></div><p>Example: HTTP GET request to the following URL: <code class="literal">http://localhost:8080/myApp/A/B/C/hallo?q=a</code></p><p>All following variables have string values except where indicated.</p><p><span class="strong"><strong><code class="literal">request.method</code></strong></span></p><p>Contains the HTTP request method, usually either "GET" or "POST".
Corresponds essentially to <code class="literal">function.getCurrentRequest().getMethod()</code>.
Above sample request: "GET".</p><p><span class="strong"><strong><code class="literal">request.uri</code></strong></span></p><p>Contains the part of the URL from the protocol name up to the query string.
Corresponds essentially to <code class="literal">function.getCurrentRequest().getRequestURI()</code>.
Above sample request: "/myApp/A/B/C/hallo".</p><p><span class="strong"><strong><code class="literal">request.url</code></strong></span></p><p>Contains the URL of the request without the query string,
more precisely:
"Reconstructs the URL the client used to make the request.
The returned URL contains a protocol, server name, port
number, and server path, but it does not include query
string parameters.".
Corresponds essentially to <code class="literal">function.getCurrentRequest().getRequestURL().toString()</code>.
Above sample request: "http://localhost:8080/myApp/A/B/C/hallo".</p><p><span class="strong"><strong><code class="literal">request.contextPath</code></strong></span></p><p>Contains the context path of the request.
Corresponds essentially to <code class="literal">function.getCurrentRequest().getContextPath()</code>.
Above sample request: "/myApp".</p><p><span class="strong"><strong><code class="literal">request.servletPath</code></strong></span></p><p>Contains the servlet path of the request, may be an empty string.
Corresponds essentially to <code class="literal">function.getCurrentRequest().getServletPath()</code>.
Above sample request: "/A".</p><p><span class="strong"><strong><code class="literal">request.pathInfo</code></strong></span></p><p>Contains extra path info of the request, may be null.
Corresponds essentially to <code class="literal">function.getCurrentRequest().getPathInfo()</code>.
Above sample request: "/B/C/hallo".</p><p><span class="strong"><strong><code class="literal">request.pathTranslated</code></strong></span></p><p>Contains extra path info of the request, translated to a real path on the server,
may be null.
Corresponds essentially to <code class="literal">function.getCurrentRequest().getPathTranslated()</code>.</p><p><span class="strong"><strong><code class="literal">request.query</code></strong></span></p><p>Contains the query string of the request (without the leading question mark),
is null if there are no query parameters.
Corresponds essentially to <code class="literal">function.getCurrentRequest().getQueryString()</code>.
Above sample request: "q=a".</p><p><span class="strong"><strong><code class="literal">request.raw</code></strong></span></p><p>Contains the raw <code class="literal">javax.servlet.http.HttpServletRequest</code> object of the request.
Corresponds essentially to <code class="literal">function.getCurrentRequest()</code>.</p><p>For more details on the exact meanings of all above variables see the JavaDoc
of the corresponding methods of <code class="literal">javax.servlet.http.HttpServletRequest</code>.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="x80274_Heading2Tarsec_Special_Variables"></a>32.6. Special Variables</h2></div></div></div><p><span class="strong"><strong><code class="literal">special.authenticated</code></strong></span></p><p>Contains a string "<code class="literal">yes</code>" as soon as a successful authentication has been performed (defaults to "<code class="literal">no</code>").</p><p><span class="strong"><strong><code class="literal">special.certificate</code></strong></span></p><p>Contains the certificate of the user after a successful PKI login. The variable contains an object which is of the Java type "<code class="literal">java.security.cert.X509Certificate</code>", so all methods of that class can be invoked on this object. Example:</p><pre class="screen">${special.certificate.getIssuerDN()}</pre><p><span class="strong"><strong><code class="literal">special.mapped.id</code></strong></span></p><p>Contains the mapped user ID, if the login model contained the "<code class="literal">do.mapping</code>" step and an actual mapping was performed. However, in many cases it is easier to just use some adapter-specific attribute for mapping purposes. For example, after an LDAP lookup during the authentication step, all LDAP attributes of the user are available as JEXL variables and could also be used for mapping purposes, without a "<code class="literal">do.mapping</code>"-step in the model.</p><p><span class="strong"><strong><code class="literal">special.sls.path</code></strong></span></p><p>Contains the absolute path of the SLS web application directory in the local file system. This could be useful in cases where a third-party library / adapter is integrated with the SLS which requires an absolute path specified for a custom configuration file etc.</p><p><span class="strong"><strong><code class="literal">special.requested.page</code></strong></span></p><p><span class="emphasis"><em>Read-only:</em></span> Contains the value of the "RequestedPage"-parameter which was inserted into the incoming request by the HSP. This value represents the URL that the client wanted to access before the HSP redirected it to the SLS. In other words, this is the URL where the client should be redirected to by the SLS after a successful login.</p><p>This usually happens automatically in the "<code class="literal">do.success</code>"-step, but there might be special cases where the redirect is performed in some other ways, for example by using the "<code class="literal">do.redirect</code>"-state, and where this variable could be used to define the target:</p><pre class="programlisting">model.login.state.10.name=do.redirect
model.login.state.10.property=${special.requested.page}</pre><p><span class="emphasis"><em>This variable is read-only. Changing it won't impact the redirect behaviour of the SLS!</em></span></p><p><span class="strong"><strong><code class="literal">special.authorized.path</code></strong></span></p><p>Contains the value of the "<code class="literal">ReqAuthorizedPath</code>"-field of the header  "<code class="literal">SessionInfo</code>" sent by the HSP. This value essentially represents the URL path for which the client wants to be authorized. This value can be used, for example, for the "<code class="literal">path</code>"-attribute when configuring custom SES session attributes.</p><p><span class="strong"><strong><code class="literal">special.authorizations.missing</code></strong></span></p><p>Set just before displaying the already-logged-in page in order display the appropriate message, because when the page is displayed the session has already been invalidated. Contains the string "true" or "false".</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_undocumented_special_variables"></a>32.6.1. Undocumented Special Variables</h3></div></div></div><p>There may also be some other, undocumented internal variables of type "<code class="literal">special</code>". Please do not use them as they are likely to be either changed or removed in future releases.</p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_other_variables"></a>32.7. Other Variables</h2></div></div></div><p><span class="strong"><strong><code class="literal"><span class="emphasis"><em>&lt;type&gt;</em></span>.current.backend</code></strong></span></p><p>Contains the hostname / address of the currently used back-end system (in failover setups) of a certain type, e.g..</p><pre class="programlisting">radius.current.backend=172.17.4.15</pre><p><span class="strong"><strong><code class="literal">challenge</code></strong></span></p><p>Contains the text of the challenge created by the challenge / response adapter.</p><p><span class="strong"><strong><code class="literal">current.tenant</code></strong></span></p><p>The current tenant value; see <a class="link" href="#x81272_Heading3Tarsec_JEXL_Variable" title="18.5.1. JEXL Variable">"JEXL Variable"</a> for details.</p><p><span class="strong"><strong><code class="literal">sessioninfo.<span class="emphasis"><em>&lt;name&gt;</em></span></code></strong></span></p><p>For each field in the "<code class="literal">SessionInfo</code>" header sent by the HSP to the SLS, one such variable is created, where "<code class="literal"><span class="emphasis"><em>&lt;name&gt;</em></span></code>" is the actual name of the field in the header.</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_rsa_adapter_variables"></a>32.7.1. RSA Adapter Variables</h3></div></div></div><p><span class="strong"><strong><code class="literal">rsa.auth.status</code></strong></span></p><p>The current RSA token status (string); see <a class="link" href="#x93298_Heading4Tarsec_Next_Tokencode_Required_Problem" title="&quot;Next Tokencode Required&quot; Problem">""Next Tokencode Required" Problem"</a> for details.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_ldap_adapter_variables"></a>32.7.2. LDAP Adapter Variables</h3></div></div></div><p><span class="strong"><strong><code class="literal">ldap.error</code></strong></span></p><p>Contains the last LDAP error message (the message string of the Java "<code class="literal">NamingException</code>" which was thrown internally).</p><p><span class="strong"><strong><code class="literal">attribute.ldap.<span class="emphasis"><em>&lt;name&gt;</em></span></code></strong></span></p><p>One such variable (string or array) is created for each attribute of the last LDAP object that was found in a successful search
(with "<code class="literal"><span class="emphasis"><em>&lt;name&gt;</em></span></code>" being the actual name of the LDAP attribute). Note that the notation of the name begins with
"<code class="literal">attribute.</code>" for historical reasons, and because there are similar attributes available for other adapters like the
RADIUS adapter, e.g. "<code class="literal">attribute.radius.<span class="emphasis"><em>&lt;name&gt;</em></span>"</code>.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_radius_adapter_variables"></a>32.7.3. RADIUS Adapter Variables</h3></div></div></div><p><span class="strong"><strong><code class="literal">radius.response.type</code></strong></span></p><p>Contains the RADIUS packet type of the last RADIUS response
(number or string "unknown" if there was no RADIUS response).</p><p><span class="strong"><strong><code class="literal">attribute.radius.<span class="emphasis"><em>&lt;id&gt;</em></span></code></strong></span></p><p>One such variable (string) is created for each attribute in the last RADIUS response,
with "<code class="literal"><span class="emphasis"><em>&lt;id&gt;</em></span></code>" being the numeric identifier of the attribute.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="expression_adoc_HTTP_Adapter_Variables"></a>32.7.4. HTTP Adapter Variables</h3></div></div></div><p><span class="strong"><strong><code class="literal">http.error.code</code></strong></span></p><p>Contains the last HTTP callout error code (number, see <a class="link" href="#x55606_Heading3Tarsec_Scripting_Variables" title="48.4. Scripting">"Scripting"</a> for details).</p><p><span class="strong"><strong><code class="literal">response.holder</code></strong></span></p><p>A Java object containing all the response information. The class of the object
is "CloseableHttpResponse" from the Apache HttpClient 4 API.</p><p><span class="strong"><strong><code class="literal">response.content</code></strong></span></p><p>Stores the entire response body content (without the headers) as a string;
more precisely contains the response body bytes parsed with UTF-8 encoding to a string,
and results in an empty string if there was no response body.</p><p><span class="strong"><strong><code class="literal">response.contentBytes</code></strong></span></p><p>Stores the entire response body content (without the headers) as a byte array;
results in an empty byte array if there was no response body.</p><p><span class="strong"><strong><code class="literal">response.code</code></strong></span></p><p>Stores the HTTP response code of the last call (number).</p><p><span class="strong"><strong><code class="literal">response.header.<span class="emphasis"><em>&lt;name&gt;</em></span></code></strong></span></p><p>One such variable is created for each header in the response sent by the HTTP backend, where <code class="literal"><span class="emphasis"><em>&lt;name&gt;</em></span></code> is the name of the response header, e.g.:</p><pre class="screen">response.header.mimetype</pre><p><span class="strong"><strong><code class="literal">response.cookie.<span class="emphasis"><em>&lt;name&gt;</em></span></code></strong></span></p><p>One such variable is created for each "Set-cookie" header in the response sent by the HTTP backend, where <code class="literal"><span class="emphasis"><em>&lt;name&gt;</em></span></code> is
the name of the cookie, and the variable value is the cookie value, e.g.:</p><pre class="screen">response.cookie.JSessionID</pre><p><span class="strong"><strong><code class="literal">response.holder</code></strong></span></p><p>Contains a reference to a Java object which holds all the information about the last response received from the backend.
The object is of type <code class="literal">"org.apache.http.HttpResponse"</code>. The Javadoc API documentation for this class can be found on
the official Apache HttpClient webpage.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_ws_adapter_variables"></a>32.7.5. WS Adapter Variables</h3></div></div></div><p><span class="strong"><strong><code class="literal">ws.request</code></strong></span></p><p>The HTTP request body as a string.</p><p><span class="strong"><strong><code class="literal">ws.response</code></strong></span></p><p>The HTTP response body as a string.</p><p><span class="strong"><strong><code class="literal">ws.response.headers</code></strong></span></p><p>Map of HTTP response headers, where the map key is the header name, converted to lower-case and '-\' converted to '_', e.g. 'Content-type\' becomes 'content_type\'.</p><p><span class="strong"><strong><code class="literal">ws.response.statuscode</code></strong></span></p><p>The HTTP response status code (number).</p><p><span class="strong"><strong><code class="literal">ws.soap.fault.value</code></strong></span></p><p>The SOAP fault code value, if any (string).</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="x59373_Heading2Tarsec_SPNEGO_Adapter_Variables"></a>32.7.6. SPNEGO Adapter Variables</h3></div></div></div><p><span class="strong"><strong><code class="literal">spnego.realm</code></strong></span></p><p>Contains the SPNEGO realm of the user after a successful login (string).</p><p><span class="strong"><strong><code class="literal">spnego_ms_kerberos_password_login</code></strong></span></p><p>After a successful login:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
Set to true if it was a Microsoft Kerberos login with password
according to MS PAC data in the Kerberos ticket.
</li><li class="listitem">
Set to false if it was a certificate login
according to MS PAC data in the Kerberos ticket or if the ticket could not be decrypted
and parsed or if the decrypted ticket contained no MS PAC data.
</li></ul></div><p><span class="strong"><strong><code class="literal">spnego_ms_kerberos_certificate_login</code></strong></span></p><p>After a successful login:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
Set to true if it was a Microsoft Kerberos login with certificate
according to MS PAC data in the Kerberos ticket (i.e. typically login with a smartcard or with
a similar crypto token).
</li><li class="listitem">
Set to false if it was a password login
according to MS PAC data in the Kerberos ticket or if the ticket could not be decrypted
and parsed or if the decrypted ticket contained no MS PAC data.
</li></ul></div><p>So there are three different outcomes for the above two variables:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
true/false: Could decrypt+parse+extract, was certainly a password login
</li><li class="listitem">
false/true: Could decrypt+parse+extract, was certainly a certificate login
</li><li class="listitem">
false/false: Could not decrypt+parse+extract, no idea what was used for login
</li></ul></div><p>In practice this means the following:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
If you want to treat certificate login as "strong authentication" in a login
  model and everything else as "weak authentication", just check the value of
  <code class="literal">spnego_ms_kerberos_certificate_login</code>; if it is true, authentication was
  strong, otherwise treat as weak (could not prove that was strong).
</li><li class="listitem">
Should you need to know whether decrypting/parsing succeeded and the decrypted
  ticket contained MS PAC data with the above information, verify that one of
  the two variables is true and the other one is false, and not both are false.
  (A trace log typically gives more details why could not get the info.)
</li></ul></div><p>Decryption currently supports ETypes <code class="literal">Aes128CtsHmacSha1(17)</code>, <code class="literal">Aes256CtsHmacSha1EType(18)</code>
and <code class="literal">ArcFourHmac(23)</code>; if you set <code class="literal">spnego.mslogin.ticket.decipher.useJdkInternalsIfAccessible=true</code>
additionally the key types that the JDK supports are available, with JDK8 those are
<code class="literal">DesCbcCrc(1)</code>, <code class="literal">DesCbcMd5(3)</code> and <code class="literal">Des3CbcHmacSha1Kd(16)</code>.
JDK internals are available with JDK8; with version 9+ and later they would only be available
if access to the internal modules was given via a number of System Properties at web container
startup, and starting with JDK17 they will no longer be accessible be at all.</p><p>Therefore, please inform USP if you need to use JDK internals in practice so that support for
the corresponding  EType without using JDK internals could be considered for future releases.
Note however, that all three additional ETypes are officially deprecated for security reasons,
as is <code class="literal">ArcFourHmac(23)</code>, see RFC 6649 (2012) and RFC 8429 (2018).</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="x85389_Heading3Tarsec_SAML_Service_Provider"></a>32.7.7. SAML Service Provider Variables</h3></div></div></div><p><span class="strong"><strong><code class="literal"><code class="literal">[assertion.*]</code></code></strong></span></p><p>For many fields in the assertion, corresponding JEXL variables are created (string values). Which variables are actually created can depend on the assertion. Among typical values are:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
common name
</li><li class="listitem">
user id
</li><li class="listitem">
issuer
</li></ul></div><p>etc. Check the TRACE-Log of the SLS once to see a list of all variables that are created.</p><p><span class="strong"><strong><code class="literal">assertion.attribute.<span class="emphasis"><em>&lt;frienly-name&gt;</em></span></code></strong></span></p><p>For each user attribute in the assertion, a corresponding variable is created (string). The "<code class="literal"><span class="emphasis"><em>&lt;friendly-name&gt;</em></span></code>" part of the variable name is the friendly name of the attribute in the assertion. For multi-value-attributes, a separate variable is created for each value, where the names of the variables are numbered, e.g:</p><pre class="programlisting">assertion.attribute.myValue.0=...
assertion.attribute.myValue.1=...
assertion.attribute.myValue.2=...</pre></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="x59773_Heading2Tarsec_Functions"></a>32.8. Functions</h2></div></div></div><p>The built in JEXL functions are grouped by different prefixes:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">function.<span class="emphasis"><em>&lt;name&gt;</em></span></code>
Provides "static" utility functions.
</li><li class="listitem">
<code class="literal">session.<span class="emphasis"><em>&lt;name&gt;</em></span></code>
Provides functions that use or manipulate the SLS session.
</li><li class="listitem">
<code class="literal">response.<span class="emphasis"><em>&lt;name&gt;</em></span></code>
Provides functions for sending custom response headers, redirects, or other manipulation of the response.
</li></ul></div><p>So, to actually use a JEXL function in an expression, it must have the proper prefix. Examples:</p><pre class="screen">response.setHeader('myHeader', 'someValue');
session.createVariable('newVar', 'newValue');</pre><p><span class="strong"><strong>"sls-jexl-guide.pdf" documentation</strong></span></p><p>Please consult the "<code class="literal">sls-jexl-guide.pdf</code>" document for a complete list of all currently available JEXL functions. Each function as also its prefix listed.</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_counters"></a>32.8.1. Counters</h3></div></div></div><p>There's a special type of object that can be used with JEXL to implement a counter in a model. Such counter objects can be created using a method from the "function" class:</p><pre class="screen">function.createCounter('mycounter');</pre><p>This creates a counter object in the JEXL context. The object is stored in the variable with the given name, '<code class="literal">mycounter</code>\' in this example. To actually use the counter, its methods can be invoked directly on the variable:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">mycounter.increase()</code> - Increases the counter by 1
</li><li class="listitem">
<code class="literal">mycounter.decrease()</code> - Decreases the counter by 1
</li><li class="listitem">
<code class="literal">mycounter.getCounter()</code> - Returns the current numeric integer value of the counter
</li></ul></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="x12304_Heading3Tarsec_Templates"></a>32.8.2. Templates</h3></div></div></div><p>There is a template mechanism available through JEXL which allows to use any custom text file as a template. The contents of that file can then be used for the value of a custom cookie, for example, amended with user- or session-related values during a login process.</p><p>The following JEXL function returns the content of a template file, completely processed (all JEXL expressions in the template evaluated):</p><pre class="screen">${function.getTemplateContent('templateAlias')}</pre><p>or</p><pre class="screen">${function.getTemplateContent('templateAlias', 'unix')}</pre><p>The "templateAlias" argument refers to a template that must be defined first through a configuration property in "sls.properties":</p><pre class="programlisting">template.file.&lt;templateAlias&gt;=&lt;file path&gt;</pre><div class="note" style="margin-left: 0; margin-right: 10%;"><h3 class="title">Note</h3><p>The file path cannot be an absolute path! Only relative path values are
allowed. The value will always be used as a path relative to the
"<code class="literal">WEB-INF/templates/</code>" subdirectory of the SLS web application.</p></div><p>The "unix" argument referts to the line separator character which should be used
for a mulitline template. The allowed arguments are "unix", "windows", "system"
and "none" - where "none" is the default. "system" takes the line separator
property from the local running machine.</p><p>The parameter is needed when line structure of the template should be kept.
Otherwise the linebreak will get removed when reading the template in.</p><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="_example_4"></a>Example</h4></div></div></div><p>So, the following example refers to a file "<code class="literal">custom.xml</code>" in the SLS directory "<code class="literal">WEB-INF/templates/</code>":</p><pre class="programlisting">template.file.acme=custom.xml</pre><p>The following expression would use its content then as the value of a cookie named "<code class="literal">info</code>":</p><pre class="screen">${response.createCookie('info', function.getTemplateContent('acme'), '/app', -1)}</pre><p>The content of the file "<code class="literal">custom.xml</code>" could be something like this:</p><pre class="screen">&lt;acme&gt;
&lt;user&gt;${session.getVerifiedCred('username')}&lt;/user&gt;
&lt;timestamp&gt;${function.getTimestamp()}&lt;/timestamp&gt;
&lt;/acme&gt;</pre><p>So the resulting "<code class="literal">info</code>" cookie would have a value that consisted of this XML structure, but with the JEXL expressions evaluated and replaced with their actual values.</p></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="x1234_updating_variables_from_json"></a>32.8.3. Updating variables from JSON data with templates</h3></div></div></div><p>Another way of using templates is to use them to process JSON data and automatically
create or update variables, based on the contents of the JSON data. By putting
a JSON template structure in a JEXL template file, and then inserting special
markers that define which attribute value or node should end up in which variable,
all that is needed at runtime is a simple function call to <code class="literal">"function.updateVarsFromJson()"</code>,
with the JSON input data (e.g. the body of a HTTP response from a REST call),
and all the variables will be created automatically.</p><p><span class="strong"><strong>Markers / Variable Types</strong></span></p><p>The markers for variables to be created are strings of the following format:</p><pre class="screen">@&lt;type&gt;:&lt;name&gt;@</pre><p>e.g. "@string:userName@", which could create a JEXL variable "userName" containing
the value of the corresponding JSON attribute.</p><p>The following types are supported:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">string</code>: A text string, e.g. "hello" (Java.lang.String)
</li><li class="listitem">
<code class="literal">number</code>: An integer number, e.g. -15 (Java.lang.Integer)
</li><li class="listitem">
<code class="literal">float</code>: A floating point number, e.g. 0.234 (Java.lang.Double)
</li><li class="listitem">
<code class="literal">boolean</code>: A boolean value, <code class="literal">true</code> or <code class="literal">false</code> (Java.lang.Boolean)
</li><li class="listitem">
<code class="literal">node</code>: A Java POJO for simple JSON nodes which only have attributes.
          With Groovy, each attribute can be accessed with the same syntax
          as in the JSON structure (since in Groovy simple Java getter methods
          can be used like member attributes).
          <span class="emphasis"><em>This MUST be used for simple JSON nodes, NOT arrays!</em></span>
</li><li class="listitem">
<code class="literal">list_node</code>: A list of objects (net.minidev.json.JSONArray), but this is also
          a Java "ArrayList", so it can be handled easily in Groovy. Each
          entry in the list is then a POJO as described under <code class="literal">node</code>.
          <span class="emphasis"><em>This MUST be used for JSON array nodes!</em></span>
</li></ul></div><p><span class="strong"><strong>Configuration Properties</strong></span></p><p>There are two optional boolean configuration properties that allow to change the
behaviour of the JSON variable processing mechanism:</p><p><span class="strong"><strong><code class="literal">jsonpath.ignore.missing.nodes</code></strong></span></p><p><span class="emphasis"><em>Optional</em></span>: Allows to enable for an exception to be thrown if a variable
specified in the JSON template could not be matched at all with the given data.
Defaults to <code class="literal">false</code>, so if the JSON data does not contain the attribute or
node referenced in the template, the corresponding variable will just not be
created.</p><p><span class="strong"><strong><code class="literal">jsonpath.ignore.empty.nodes</code></strong></span></p><p><span class="emphasis"><em>Optional</em></span>: Allows to disable variables being created (or updated) if the JSON
data value made in the match was empty, e.g. an attribute like "name" existing
in the JSON data, but its value being an empty string. By default, the SLS will
always created and update variables, even if their value is empty in the JSON
data (NOTE: this refers only to existing nodes / attribute with empty values,
not to cases where the node/attribute is entirely missing - that would be what
the other property is for).</p><p><span class="strong"><strong>Example / How To</strong></span></p><p>This example assumes that a HTTP call was made to a REST service using the SLS
HTTP adapter, and a JSON structure was received in the response body. For the
sake of this example, the following JSON structure has been sent back to the SLS:</p><pre class="screen">{ "store": {
    "book": [
      { "category": "reference",
        "author": "Nigel Rees",
        "title": "Sayings of the Century",
        "price": 8.95
      },
      { "category": "fiction",
        "author": "Herman Melville",
        "title": "Moby Dick",
        "isbn": "0-553-21311-3",
        "price": 8.99
      },
    ],
    "members": [
      {
        "person": {
          "name": "Henry Miller",
          "age": 37
        }
      },
      {
        "person": {
          "name": "John Doe",
          "age": 99
        }
      }
    ],
    "bicycle": {
      "color": "red",
      "price": 19.95,
      "verified": true
    }
  }
}</pre><p>In this example, we want to have variables created for the price and color of the
"bicycle" node, and we also want to be able to retrieve information about the
books in the array. The "bicycle" part is used to demonstrate the simpler use-case
of creating string, integer or float variables from simple JSON attribute values.
The "books" and "members" parts are used to show how to use JSON nodes, in Groovy, to easily
access their information.</p><p><span class="strong"><strong>Example / How To</strong></span></p><p>The following example refers to a file "<code class="literal">myvars.json</code>" in the SLS directory "<code class="literal">WEB-INF/templates/</code>":</p><pre class="programlisting">template.file.myvars=myvars.json</pre><p>The file contains this JSON structure, which contains the definition to create or
update the variables <code class="literal">"myColor"</code> and <code class="literal">"myPrice"</code> from the attributes of the JSON node
<code class="literal">"store.bicycle"</code>, and a variable <code class="literal">"books"</code> with the JSON node <code class="literal">"store.book"</code> which will
contain a list of "Pojo" (simple Java objects) representing the nested JSON data.</p><p><span class="strong"><strong>Template Example</strong></span></p><pre class="screen">{
        "store": {
                "book": [
                        {
                                "@slsvariable@" : "@node:books@"
                        }
                ],
                "members": [
                        {
                                "@slsvariable@" : "@node:people@"
                        }
                ],
                "bicycle": {
                        "color": "@string:myColor@",
                        "price": "@float:myPrice@",
                        "verified": "@boolean:isVerified@",
                },
                "car": {
                    "maxSpeed": "number:maxSpeed"
                }
        }
}</pre><p>Next, a HTTP adapter call to a REST service would be performed in the model, e.g.</p><pre class="screen">model.login.state.1000.name=do.http-someRestCall
model.login.state.1000.property=restBackend</pre><p>After that, the JSON response body is available in the JEXL variable "response.content";
for this example, we assume the JSON response body received from the REST service
looks like this:</p><p><span class="strong"><strong>JSON Response Example</strong></span></p><pre class="screen">{
  "store": {
    "book": [
      { "category": "reference",
        "author": "Nigel Rees",
        "title": "Sayings of the Century",
        "price": 8.95
      },
      { "category": "fiction",
        "author": "Herman Melville",
        "title": "Moby Dick",
        "isbn": "0-553-21311-3",
        "price": 8.99
      }
    ],
    "members": [
      {
        "person": {
          "name": "Chuck Norris",
          "timesCountedToInfinity": 2
        }
      },
      {
        "person": {
          "name": "Bruce Lee",
          "specialty": "One Inch Punch"
        }
      }
    ],
    "bicycle": {
      "color": "red",
      "price": 19.95,
      "verified": true
    },
    "car": {
      "maxSpeed": "195"
    }
  }
}</pre><p>It could then be processed to create and update variables like this:</p><pre class="screen">model.login.state.1000.action.1=#{function.updateVarsFromJson('myvars', var('response.content'))}</pre><p>As a result, the variables will be created as explained below.</p><p><span class="strong"><strong>1: Simple Values</strong></span></p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">myColor=<span class="emphasis"><em>red</em></span></code> (string)
</li><li class="listitem">
<code class="literal">myPrice=19.95</code> (float)
</li><li class="listitem">
<code class="literal">isVerified=true</code> (boolean)
</li></ul></div><p><span class="strong"><strong>2: Single Node</strong></span></p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">myCar</code> (POJO)
</li></ul></div><p>Example Groovy expression to access the "maxSpeed" attribute:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">var(<span class="emphasis"><em>myCar</em></span>).maxSpeed</code>
</li></ul></div><p><span class="strong"><strong>3: List of Nodes</strong></span></p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">books</code> (List of POJOs)
</li><li class="listitem">
<code class="literal">people</code> (List of POJOs)
</li></ul></div><p>Example Groovy expression to access attributes of a certain book:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">var(<span class="emphasis"><em>books</em></span>)[0].author</code> (= "Nigel Rees")
</li><li class="listitem">
<code class="literal">var(<span class="emphasis"><em>books</em></span>)[1].isbn</code> (= "0-553-21311-3")
</li></ul></div><div class="note" style="margin-left: 0; margin-right: 10%;"><h3 class="title">Note</h3><p>The dynamic nature of Groovy (and JSON) allows to have somewhat irregular
structures like in this example, where one book has an attribute "isbn" and
another does not. So depending on the use case, it might be necessary to add
a null-check to the Groovy code.</p></div><p>Example Groovy expression to access attributes of a certain member:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">var(<span class="emphasis"><em>people</em></span>)[0].person.timesCountedToInfinity</code> (= "2")
</li><li class="listitem">
<code class="literal">var(<span class="emphasis"><em>people</em></span>)[1].person.specialty</code> (= "One Inch Punch")
</li></ul></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="x1234_updating_variables_from_xml"></a>32.8.4. Updating variables from XML data with templates</h3></div></div></div><p>Another way of using templates is to use them to process XML data and automatically
create or update variables, based on the contents of the XML data. This is the same
functionality as provided in the webservice adapter, but it works with the
normal standard templates (not the special request and response templates created
by the WSDL tool), in conjunction with a scripting function - completely independent
of any adapter.</p><p><span class="strong"><strong>Example / How To</strong></span></p><p>The following example refers to a file "<code class="literal">myvars.txt</code>" in the SLS directory "<code class="literal">WEB-INF/templates/</code>":</p><pre class="programlisting">template.file.myvars=myvars.txt</pre><p>The file contains this XML structure, which contains the definition to create or
update the variable <code class="literal">"fieldOne"</code> from XML node <code class="literal">"body/someunit/myfield"</code>:</p><p><span class="strong"><strong>XML Template Example</strong></span></p><pre class="screen">&lt;?xml version="1.0" encoding="UTF-8" ?&gt;
&lt;body&gt;
    &lt;someunit&gt;
        &lt;myfield&gt;@string:fieldOne@&lt;/myfield&gt;
    &lt;/someunit&gt;
&lt;/body&gt;</pre><p>For more details on possible variable definitions, please check the webservice adapter
chapter about <a class="link" href="#ws_adapter_response_template_format" title="XML response template format">"response templates"</a> (same
rules apply).</p><p>Next, a HTTP adapter call would be performed in the model, e.g.</p><pre class="screen">model.login.state.1000.name=do.http-someSoapCall
model.login.state.1000.property=soapBackend</pre><p>After that, the XML response body is available in the JEXL variable "response.content";
for this example, we assume the XML response body received from the SOAP service
looks like this:</p><p><span class="strong"><strong>XML Response Example</strong></span></p><pre class="screen">&lt;?xml version="1.0" encoding="UTF-8" ?&gt;
&lt;body&gt;
    &lt;someunit&gt;
        &lt;myfield&gt;FANTASTIC&lt;/myfield&gt;
    &lt;/someunit&gt;
&lt;/body&gt;</pre><p>It could then be processed to create and update variables like this:</p><pre class="screen">model.login.state.1000.action.1=#{function.updateVarsFromXml('myvars', var('response.content'))}</pre><p>As a result, the string variable <code class="literal">"fieldOne"</code> would be created, containing the
value <code class="literal">"FANTASTIC"</code>.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="x73528_Heading3Tarsec_Timestamp_Creation"></a>32.8.5. Timestamp Creation</h3></div></div></div><p>There are JEXL functions available for creating timestamp strings that could be used, for example, to be written to an LDAP attribute by using the LDAP adapter. The default functions create the timestamp string based on this global configuration property (in "<code class="literal">sls.properties</code>"):</p><p><span class="strong"><strong><code class="literal">jexl.timestamp.format</code></strong></span></p><p>A string defining the format of timestamps created by the JEXL timestamp functions. Defaults to "<code class="literal">yyyyMMddHHmmss</code>" if not set.</p><p>The string consists of characters as defined in Sun's Javadoc API for the class "java.text.SimpleDateFormat":</p><p><a class="ulink" href="http://java.sun.com/j2se/1.5.0/docs/api/java/text/SimpleDateFormat.html" target="_top">http://java.sun.com/j2se/1.5.0/docs/api/java/text/SimpleDateFormat.html</a></p><p>Example:</p><pre class="programlisting">jexl.timestamp.format=yyyyMMddHHmmss</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_timestamp_conversion_microsoft_ad_unix"></a>32.8.6. Timestamp conversion Microsoft AD / Unix</h3></div></div></div><p>If custom timestamp checks should be performed within the SLS login model, problems may arise if the SLS runs on a Unix / Linux platform, but the timestamp was read from a Microsoft Active Directory server. AD timestamps (such as the time of the last failed login) have a different format than the Unix timestamps, so a conversion is required.</p><p>This is the formula to convert a Microsoft AD timestamp (represented here by the JEXL variable "<code class="literal">badPasswordTime</code>") to a timestamp which can then be used for calculations:</p><pre class="screen">(badPasswordTime / 10000000) - ((1970-1601) * 365 - 3 + ((1970-1601)/4) ) * 86400)</pre><p>You can find more about this issue here:</p><p><a class="ulink" href="http://fieldmarshallhradek.com/2009/05/w32-versus-unix-time/" target="_top">http://fieldmarshallhradek.com/2009/05/w32-versus-unix-time/</a></p><p>An example in an SLS model would look something like this:</p><pre class="programlisting">model.login.state.15.action.1=${function.setVariable('now', function.currentSeconds())}
model.login.state.15.action.2=${function.setVariable('bad', ((attribute.ldap.badPasswordTime / 10000000) - ((1970-1601) * 365 - 3 + ((1970-1601)/4) ) * 86400))}
model.login.state.15.action.3=${function.setVariable('secFailed', (now - bad))}</pre><p>This example creates a timestamp for the current time and then compares it to the "<code class="literal">badPasswordTime</code>" timestamp that was read from the AD in a previous LDAP operation.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="x77503_Heading3Tarsec_Certificate_Handling"></a>32.8.7. Certificate Handling</h3></div></div></div><p>The SLS JEXL function "<code class="literal">function.signWithCertificate(certificateAlias, dataToSign)</code>" allows to sign data (a text string) using the private key of a configured certificate. The first argument of the function is the alias of the configured certificate. There must be a group of properties in the "<code class="literal">sls.properties</code>" configuration file that define the file, type, password etc. of a certificate with a certain alias.</p><p>A certificate is configured with the following group of (partially optional) properties</p><p><span class="strong"><strong><code class="literal">certificate.file.<span class="emphasis"><em>&lt;alias&gt;</em></span></code></strong></span></p><p><span class="emphasis"><em>Mandatory:</em></span> Defines the path of the certificate file. The path can be specified either absolute, in order to load a certificate from anywhere in the file system, or relative. In the latter case, the path will be interpreted as relative to the SLS "<code class="literal">WEB-INF</code>" directory. Example:</p><pre class="programlisting">certificate.file.acme=certificate/acme-cert.pem</pre><p><span class="strong"><strong><code class="literal">certificate.type.<span class="emphasis"><em>&lt;alias&gt;</em></span></code></strong></span></p><p><span class="emphasis"><em>Optional:</em></span> Defines the type of the certificate file. Defaults to "<code class="literal">der</code>" if not specified. Allowed values are "<code class="literal">der</code>" and "<code class="literal">pkcs12</code>". Example:</p><pre class="programlisting">certificate.type.acme=der</pre><p><span class="strong"><strong><code class="literal">certificate.key.file.<span class="emphasis"><em>&lt;alias&gt;</em></span></code></strong></span></p><p><span class="emphasis"><em>Optional:</em></span> Defines the path of the private key file. The path can be specified either absolute, in order to load a certificate from anywhere in the file system, or relative. In the latter case, the path will be interpreted as relative to the SLS "<code class="literal">WEB-INF</code>" directory. Is not necessary of PKCS12 certificates, because they already contain the private key. Example:</p><pre class="programlisting">certificate.key.file.acme=certificate/acme-key.pem</pre><p><span class="strong"><strong><code class="literal">certificate.key.password.<span class="emphasis"><em>&lt;alias&gt;</em></span></code></strong></span></p><p><span class="emphasis"><em>Optional:</em></span> Defines the password of the private key (file). In case of a PKCS12 certificate file, this must specify the password which protects the PKCS12 certificate keystore. Example:</p><pre class="programlisting">certificate.key.password.acme=12345678</pre><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="_usage_example"></a>Usage Example</h4></div></div></div><p>In order to sign a given text string with a certificate configured by the alias "acme" (as shown in the previous paragraphs), the following step can be performed:</p><pre class="screen">..state.name=do.generic
..state.action.1=${function.signWithCertificate('acme', myData)}</pre></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_credential_type_values"></a>32.8.8. Credential Type Values</h3></div></div></div><p>The JEXL session-related functions "<code class="literal">session.getVerifiedCred()</code>" and "<code class="literal">session.getCred()</code>" allow to retrieve the value of a user credential of the current session. Both functions take a string value as their single argument. That value specifies the <span class="emphasis"><em>semantic type</em></span> of the requested credential, no matter what the name of the original request parameter (or header etc.) was.</p><p>The main - and important - difference between these two functions is that "<code class="literal">getCred()</code>" returns the credential that represents the given type based on the current value received from the client, but without any guarantee that the value has been verified. "<code class="literal">getVerifiedCred()</code>" returns the value of the credential only if it was verified (which usually means only after a successfully completed authentication).</p><p>So, usually it is recommendable to use "<code class="literal">getVerifiedCred()</code>" for things like creating a login ticket with the user's name etc.</p><p>Available credential semantic types with description:</p><div class="table"><a id="idm7269"></a><p class="title"><strong>Table 32.2. Available semantic credential types</strong></p><div class="table-contents"><table class="table" summary="Available semantic credential types" cellpadding="4px" style="border-collapse: collapse;border-top: 3px solid #527bbd; border-bottom: 3px solid #527bbd; border-left: 3px solid #527bbd; border-right: 3px solid #527bbd; "><colgroup><col class="col_1" /><col class="col_2" /></colgroup><thead><tr><th style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top">Type </th><th style="border-bottom: 1px solid #527bbd; " align="left" valign="top">Description</th></tr></thead><tbody><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>username</p></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>The users\' login ID; usually what the user entered as user name in the login page.</p></td></tr><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>password</p></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>The users\' password (use with caution!)</p></td></tr><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>secret</p></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>The 3rd authentication credential, such as a SecurID token code, a strike-list value etc.</p></td></tr><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>challenge</p></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>Actually the response to the challenge, as entered by the user (for example in an SMS challenge-response login).</p></td></tr><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>mappedid</p></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>If mapping is activated in the SLS, this variable will contain the mapped ID of the user after the mapping step.</p></td></tr><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>newpassword</p></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>During a password change process, this credential holds the users' new password.</p></td></tr><tr><td style="border-right: 1px solid #527bbd; " align="left" valign="top"><p>newpassword2</p></td><td style="" align="left" valign="top"><p>During a password change process, this credential holds the users' new password.</p></td></tr></tbody></table></div></div><br class="table-break" /></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_ntlm_credentials"></a>32.8.9. NTLM Credentials</h3></div></div></div><p>With the NTLM adapter (and probably with other similar technologies), some of the user's login credentials are not available at all (like the password), and some only in the "verified" form. This has to do with the way those authentication adapters work internally.</p><p>So, in order to use the user’s login name, it is mandatory to use</p><pre class="screen">${session.getVerifiedCred('username')}</pre><p>The following function will <span class="emphasis"><em>not</em></span> return any value, because in case of an NTLM login, the users login name was never submitted as a regular request parameter:</p><pre class="screen">${session.getCred('username')}</pre></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="x92172_Heading2Tarsec_JEXL_Version_Issues"></a>32.9. JEXL Known Issues</h2></div></div></div><p>JEXL 2 is running in "strict" mode by default since SLS 5.1.0.0,
no longer in "lenient" mode as it was in earlier SLS versions
(for backwards compatibility with JEXL 1 behavior).
If JEXL 2 is set to lenient and it encounters undefined variables,
it will simply ignore them (just like JEXL 1 did).
When it's running in strict, non-lenient mode,
it will instead throw an exception in such a case,
providing usually a more accurate error message
and closer to where the issue ocurred.
Strict mode is recommended except in legacy setups, but also there
it is generally recommended to migrate to strict mode.</p><p>To switch to lenient mode, set the following property to "true":</p><p><span class="strong"><strong><code class="literal">jexl2.lenient</code></strong></span></p><p><span class="emphasis"><em>Optional:</em></span> Makes JEXL behave stricter while parsing expressions,
and throw errors when encountering unknown variables,
if set to "<code class="literal">false</code>". Defaults to "<code class="literal">false</code>".</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_usage_examples"></a>32.10. Usage Examples</h2></div></div></div><p>This chapter describes some simple typical use cases for variables.</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_propagating_values_in_headers_to_applications"></a>32.10.1. Propagating Values In Headers To Applications</h3></div></div></div><p>This simple example uses the configuration property "<code class="literal">app.header.</code>" to propagate a HTTP header named "<code class="literal">userinfo</code>" with the user's login ID to the application server after a successful login:</p><pre class="programlisting">app.header.userinfo=${parameter.userid}</pre><p>The interesting part here is the value of the property, which consists of  the variable "<code class="literal">${parameter.userid}</code>":</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
"<code class="literal">parameter</code>" is the variable type (refers to a request parameter)
</li><li class="listitem">
"<code class="literal">userid</code>" is the name of the parameter (aka login form field).
</li></ul></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_forwarding_a_radius_attribute"></a>32.10.2. Forwarding a RADIUS attribute</h3></div></div></div><p>This eample shows how to fetch a RADIUS response attribute and supply it as a HTTP header Base64-encoded to the application.</p><pre class="programlisting">app.header.userinfo=*${function.base64encode(function.getVariable('attribute.radius.15'))}</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_configuration_values"></a>32.10.3. Configuration Values</h3></div></div></div><p>The following example uses a text string with a hardcoded prefix "in:" and a variable part whose value is taken from the HTTP request header "domain" (custom header defined in the HSP configuration):</p><pre class="programlisting">app.header.appinfo=in: ${request.header.domain}</pre></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="x93809_Heading2Tarsec_Custom_JEXL_Expressions"></a>32.11. Custom JEXL Expressions</h2></div></div></div><p>The SLS allows to implement custom JEXL functions and use them in the configuration by following these steps:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
Creating a Java class with some instance (not static) methods that implement the functions. It is recommended to use only strings or numerical values as parameters and return values.
</li><li class="listitem">
Adding the JAR file to the classpath of the SLS by either putting it into the right subdirectory path in "<code class="literal">WEB-INF/classes</code>", or in a JAR-file in "<code class="literal">WEB-INF/lib</code>".
</li><li class="listitem">
Registering the class for JEXL by adding the following configuration property in the "<code class="literal">sls.properties</code>" file:
</li></ul></div><p><span class="strong"><strong><code class="literal">jexl.class.<span class="emphasis"><em>&lt;alias&gt;</em></span></code></strong></span></p><p>Defines the fully qualified name of a Java class with some instance methods which can be used in JEXL expressions. The "alias" part of the property name will be used as the name of the function provider in the JEXL expression.</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_example_5"></a>32.11.1. Example</h3></div></div></div><p>The sample Java class "<code class="literal">com.acme.OurFunctions</code>" implements a simple method which returns a string saying "Hello, " followed by a name:</p><pre class="screen">package com.acme;

public class OurFunctions {
  public String getHelloYou(String name) {
    return "Hello," + name;
  }
}</pre><p>The following configuration property in "<code class="literal">sls.properties</code>" will allow to use the new custom JEXL function:</p><pre class="programlisting">jexl.class.ourfunctions=com.acme.OurFunctions</pre><p>The following sample configuration property would propagate a custom header named "<code class="literal">hellotext</code>" to the application, where the content of that HTTP header would be "<code class="literal">Hello,<span class="emphasis"><em>&lt;username&gt;</em></span></code>" ("<code class="literal"><span class="emphasis"><em>&lt;username&gt;</em></span></code>" being the login ID of the user, of course):</p><pre class="programlisting">app.header.hellotext=${ourfunctions.getHelloYou(functions.getVerifiedCred('username'))}</pre><p>This example also shows again how nested functions are used in one expression, in this case one from "ourfunctions" and one from the SLS’s own "functions".</p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_custom_encryption_functions"></a>32.12. Custom Encryption Functions</h2></div></div></div><p>The function prefix "<code class="literal">crypto.</code>" provides various functions that allow to perform
encryption and decryption operations, based on settings configured with static
properties. Every one of these functions takes an alias as its first parameter, e.g.</p><pre class="screen">#{crypto.encrypt('one', data)}</pre><p>where <code class="literal"><span class="emphasis"><em>one</em></span></code> is the alias name, and <code class="literal">data</code> is a byte array or a string with the
plain data to be encrypted. Please see the JEXL Guide, prefix <code class="literal">crypto</code>, for details
about all available encryption and decryption functions.</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_saml_piggy_backing_functions"></a>32.12.1. SAML piggy-backing functions</h3></div></div></div><p>There are two SAML-related functions that use this encryption functionality:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">sp_authn_request.addEncryptedData(String, byte[])</code>
</li><li class="listitem">
<code class="literal">idp_authn_request.getDecryptedData(String)</code>
</li></ul></div><p>They allow to "abuse" the unused field "ServiceProviderName" in the SAML message
to add custom data; this can be used in an SLS-only setup to transport custom
information from a service provider to the identity provider in an authentication
request. Please see the JEXL Guide for details about these functions.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_crypto_settings_configuration"></a>32.12.2. Crypto Settings Configuration</h3></div></div></div><p>As mentioned before, all encryption and decryption functions take an alias as the
first parameter. That alias refers to a group of properties prefixed with <code class="literal">crypto.</code>,
followed by the alias, and then various suffixes. One such group of properties
defines all relevant settings for the encryption or decryption operation, such
as cipher algorithm, keystore to use, alias of key, or passphrase from which to
generate a key etc.</p><p><span class="emphasis"><em>Please check further below for complete configuration examples!</em></span></p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_crypto_settings_properties"></a>32.12.3. Crypto Settings Properties</h3></div></div></div><p><span class="strong"><strong><code class="literal">crypto.<span class="emphasis"><em>&lt;alias&gt;</em></span>.symmetric</code></strong></span></p><p>MANDATORY: Defines if a symmetric or asymmetric key is to be used. This property
must be set to "<code class="literal">true</code>" (for symmetric keys) or "<code class="literal">false</code>" for asymmetric keys. Example:</p><pre class="screen">crypto.dummy.symmetric=false</pre><p><span class="emphasis"><em>NOTE</em></span>: If this property is not set, the entire alias group will not be processed.</p><p><span class="strong"><strong><code class="literal">crypto.<span class="emphasis"><em>&lt;alias&gt;</em></span>.cipher</code></strong></span></p><p>MANDATORY: Defines the cipher to be used for the operations. This must be a cipher
that is supported by the Java Runtime used to operate the SLS. Example:</p><pre class="screen">crypto.dummy.cipher=RSA</pre><p><span class="strong"><strong><code class="literal">crypto.<span class="emphasis"><em>&lt;alias&gt;</em></span>.keytype</code></strong></span></p><p><span class="emphasis"><em>Optional:</em></span> This property allows to define the type (algorithm) of the key; this
may be necessary if the key is generated dynamically from a passphrase (which
is only possible for symmetric keys!).</p><p>If not specified, it defaults to "<code class="literal">AES</code>". Example:</p><pre class="screen">crypto.dummy.keytype=AES</pre><p><span class="strong"><strong><code class="literal">crypto.<span class="emphasis"><em>&lt;alias&gt;</em></span>.ivsize</code></strong></span></p><p><span class="emphasis"><em>Optional:</em></span> This property’s usage depends on the cipher algorithm that was
configured. Some block ciphers will require an initialization vector, in which
case its size must be configured with this property. It defines the number of
bytes to use for the initialization vector.</p><p>Example:</p><pre class="screen">crypto.dummy.ivsize=16</pre><p><span class="emphasis"><em>NOTE</em></span>: The receiver of the encrypted data may be some application, not the SLS
itself, in which case a developer on that side will need to implement the
decryption functionality. In order to do this, they will need to use the same
initialization vector that the SLS used for the encryption. For this reason, the
SLS adds the IV bytes to the resulting cipher message, at the beginning of it,
right before the actual encrypted data:</p><pre class="screen">&lt;plain iv bytes&gt;&lt;encrypted payload data&gt;</pre><p>So a Base64 string created using one of the "<code class="literal">crypto.encryptToBase()</code>" functions will
contain a byte array where the receiver needs to separate the IV bytes from the
actual payload data before attempting decryption.</p><p><span class="strong"><strong><code class="literal">crypto.<span class="emphasis"><em>&lt;alias&gt;</em></span>.saltsize</code></strong></span></p><p>MANDATORY: This property allows to configure the size of the salt value in number
of bytes. A salt value is a collection of random bytes which is injected at the
beginning of the encrypted data, in order to make sure that encrypting the same
data with the same key will never yield the same result, which helps to prevent
a number of possible attacks.</p><p>Similar to the initialization vector, the receiver needs to "know" how large
the salt part of the data is in order to strip it away after the encryption. If
the SLS itself encrypts and decrypts the data, that happens automatically.</p><p>Example setting:</p><pre class="screen">crypto.dummy.saltsize=16</pre><p><span class="strong"><strong><code class="literal">crypto.<span class="emphasis"><em>&lt;alias&gt;</em></span>.passphrase</code></strong></span></p><p><span class="emphasis"><em>Optional:</em></span> Allows to define a passphrase from which to derive a symmetric key.
Example:</p><pre class="screen">crypto.dummy.passphrase=This is my passphrase</pre><p><span class="strong"><strong><code class="literal">crypto.<span class="emphasis"><em>&lt;alias&gt;</em></span>.keystore</code></strong></span></p><p><span class="emphasis"><em>Optional:</em></span> Allows to define a Java keystore file with pre-generated keys. The
value must either be an absolute file path, or a path relative to the "<code class="literal">WEB-INF</code>"
directory of the SLS web application. Example:</p><pre class="screen">crypto.dummy.keystore=/usr/lib/keys/cryptokeys.kst</pre><p><span class="strong"><strong><code class="literal">crypto.<span class="emphasis"><em>&lt;alias&gt;</em></span>.storepwd</code></strong></span></p><p>MANDATORY: If a keystore is used, this property becomes mandatory. It allows to
define the password for the Java keystore. Defaults to "<code class="literal">changeit</code>" if not set.
Example:</p><pre class="screen">crypto.dummy.storepwd=SuperDuperPwd</pre><p><span class="strong"><strong><code class="literal">crypto.<span class="emphasis"><em>&lt;alias&gt;</em></span>.storetype</code></strong></span></p><p><span class="emphasis"><em>Optional:</em></span> Allows to define the type of the Java keystore. Defaults to "JCEKS"
is not set. Example:</p><pre class="screen">crypto.dummy.storetype=JCEKS</pre><p><span class="strong"><strong><code class="literal">crypto.<span class="emphasis"><em>&lt;alias&gt;</em></span>.keyalias</code></strong></span></p><p>MANDATORY: If a keystore is used, this property is mandatory. It defines the
alias of the key inside the keystore. Example:</p><pre class="screen">crypto.dummy.keyalias=mykey</pre><p><span class="strong"><strong><code class="literal">crypto.<span class="emphasis"><em>&lt;alias&gt;</em></span>.keypwd</code></strong></span></p><p><span class="emphasis"><em>Optional:</em></span> Allows to define the password of the key inside the keystore.
Defaults to the value of the keystore password if not set. Example:</p><pre class="screen">crypto.dummy.keypwd=12345678</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_examples_keytool_key_creation"></a>32.12.4. Examples: "keytool" Key Creation</h3></div></div></div><p>To create a symmetric key with the Java keytool, run the following command:</p><pre class="screen">keytool -genseckey -storetype JCEKS -keyalg AES -keysize 256 -alias &lt;key alias&gt; -keystore &lt;filename&gt; -storepass &lt;pwd&gt;</pre><p>To create a key pair with a private and a public key with the Java keytool, run the following command:</p><pre class="screen">keytool -genkeypair -storetype JCEKS -keyalg RSA -keysize 2048 -alias &lt;key pair alias&gt; -keystore &lt;filename&gt; -storepass &lt;pwd&gt;</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_example_1_symmetric_encryption_passphrase_no_iv"></a>32.12.5. Example 1: Symmetric Encryption, Passphrase, no IV</h3></div></div></div><p>Please note: Using a passphrase to generate a key is only supported with symmetric
encryption, e.g. AES ciphers.</p><p>In this example, the symmetric key for all operations with alias "myalias" is
generated from a passphrase, which eliminates the need to handle and manage
a Java keystore file:</p><pre class="screen">crypto.myalias.symmetric=true
crypto.myalias.cipher=AES
crypto.myalias.keytype=AES
crypto.myalias.saltsize=16
crypto.myalias.passphrase=This is my passphrase</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_example_2_symmetric_encryption_passphrase_with_iv"></a>32.12.6. Example 2: Symmetric Encryption, Passphrase, with IV</h3></div></div></div><p>In this example, the symmetric key is also generated from a passphrase, but with
and algorithm that requires an initialization vector. In this case, the
initialization vector needs to be 16 bytes long.</p><pre class="screen">crypto.myalias.symmetric=
crypto.myalias.cipher=AES/CBC/PKCS5Padding
crypto.myalias.ivsize=16
crypto.myalias.keytype=AES
crypto.myalias.saltsize=16
crypto.myalias.passphrase=This is my passphrase</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_example_3_symmetric_encryption_keystore"></a>32.12.7. Example 3: Symmetric Encryption, Keystore</h3></div></div></div><p>In this example, the symmetric key is in an existing Java keystore file named
"<code class="literal">cryptokeys.kst</code>" in the SLS "<code class="literal">WEB-INF</code>" directory. The key has the alias
"<code class="literal">mysecret</code>" inside the keystore, and the password for the keystore is
"<code class="literal">changeit</code>".</p><pre class="screen">crypto.myalias.symmetric=true
crypto.myalias.cipher=AES
crypto.myalias.saltsize=16
crypto.myalias.keystore=cryptokeys.kst
crypto.myalias.keyalias=mysecret
crypto.myalias.storepwd=changeit
crypto.myalias.storetype=JCEKS</pre><p>If the key itself had a different password than the keystore, then this additional
property would need to be set as well:</p><pre class="screen">crypto.myalias.keypwd=keypassword</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_example_4_asymmetric_encryption_keystore"></a>32.12.8. Example 4: Asymmetric Encryption, Keystore</h3></div></div></div><pre class="screen">crypto.myalias.symmetric=false
crypto.myalias.cipher=RSA
crypto.myalias.saltsize=16
crypto.myalias.keystore=cryptokeys.kst
crypto.myalias.keyalias=mykeypair
crypto.myalias.storepwd=changeit
crypto.myalias.storetype=JCEKS</pre></div></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="_groovy_scripting_2"></a>Chapter 33. Groovy Scripting</h2></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_introduction_11"></a>33.1. Introduction</h2></div></div></div><p>Everywhere where JEXL script expressions can be used with <code class="literal">${…}</code>,
Groovy script expressions can be used with <code class="literal">#{…}</code>,
i.e. using the pound sign instead of the dollar sign.</p><p>This applies to configuration properties, including login model actions,
as well as to SLS JSP tags, including <code class="literal">getJexl</code> and <code class="literal">doJexl</code>.</p><p>To execute a Groovy script, use the <code class="literal">#{runscript.groovy(…)}</code> functions,
just like the <code class="literal">${runscript.jexl(…)}</code> functions.</p><p>Groovy is a modern script language with features and a power of expression similar to Python and Ruby.
Its syntax is often identical to JEXL in simple cases. More generally, almost every Java source code
is syntactically valid Groovy, although many things can also be written much less verbosely in Groovy.
Hence learning Groovy in the context of SLS configuration should be quite easy for anyone familiar
with syntactically similar languages like JavaScript, Java, JEXL, C#, C, etc.</p><p>More information about Groovy can be found on its main web site:</p><p><a class="ulink" href="http://www.groovy-lang.org/" target="_top">http://www.groovy-lang.org/</a></p><p>In simple use cases, Groovy and JEXL can be used equivalently,
but in more complex cases Groovy can provide better solutions:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
Complex integrations and utility libraries written in Groovy.
</li><li class="listitem">
Temporary solutions to resolve issues in production by accessing functionality that JEXL cannot access.
</li></ul></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_basic_usage"></a>33.2. Basic Usage</h2></div></div></div><p>Usually it is sufficient to replace <code class="literal">${</code> with <code class="literal">#{</code> and you are using Groovy. For example, the following
configuration property that uses a JEXL expression,</p><pre class="screen">  app.header.plainuser=${function.getVerifiedCred('username')}</pre><p>is simply translated as follows to Groovy:</p><pre class="screen">  app.header.plainuser=#{function.getVerifiedCred('username')}</pre><p>Or the following scripting JSP Tag,</p><pre class="screen">  &lt;sls:getScript expression="${function.getVerifiedCred('username')}"/&gt;</pre><p>is simply as follows in Groovy:</p><pre class="screen">  &lt;sls:getScript expression="#{function.getVerifiedCred('username')}"/&gt;</pre><p>Instead of running a JEXL script as follows,</p><pre class="screen">  ${runscript.jexl('WEB-INF/scripts/foo.jexl')}</pre><p>run a Groovy script like this:</p><pre class="screen">  #{runscript.groovy('WEB-INF/scripts/Foo.groovy')}</pre><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_variable_names_that_contain_a_period"></a>33.2.1. Variable names that contain a period</h3></div></div></div><p>Access to variables that contain a period (".") in their names is not possible by indicating only the
name of the variable, as in JEXL, because Groovy expects the period to denote access to a field etc.</p><p>A JEXL expression like this one,</p><pre class="screen">  ${header.content_type}</pre><p>should usually be translated to Groovy as follows:</p><pre class="screen">  #{var('header.content_type')}</pre><p>Alternatively, you can also use the already existing (but more verbose) dedicated function</p><pre class="screen">  #{function.getVariable('header.content_type')}</pre><p>or the following more low-level/technical approach:</p><pre class="screen">  #{this.'header.content_type'}</pre><p>Technical background: <code class="literal">this</code> refers to the script class which contains the variables.</p><p>Note that the approach with <code class="literal">this</code> comes closest to the direct reference
to the variable name in JEXL,
since it throws an exception if the variable does not exist,
while all other methods yield null in this case.</p><p>To set a variable with a period in its name, use one of these:</p><pre class="screen">  #{setVar('header.content_type', 'text/html; charset=utf-8')}
  #{function.setVariable('header.content_type', 'text/html; charset=utf-8')}
  #{this.'header.content_type' = 'text/html; charset=utf-8'}</pre><p>There are also shortcuts for clearing variables, for checking if a variable
exists, for getting the variable with a default if not defined, and for getting
a sorted list of all variable names:</p><pre class="screen">  #{clearVar('header.content_type'))
  #{String prefix='header.'; clearVars(prefix)}
  #{boolean ok = hasVar('header.content_type')}
  #{String header = var('header.content_type', 'text/html; charset=utf-8')}
  #{def varNames = getVarNames()}</pre><p>(You could also use <code class="literal">binding</code> to get the <code class="literal">groovy.lang.Binding</code> of
the current script and then e.g. get the map of all variables with
<code class="literal">def varMap = binding.variables</code>, but note that this only works from
Groovy Script expressions, but not from  Groovy utility classes because
<code class="literal">getBinding()</code> is a method of the class <code class="literal">GroovyScript</code> to which script
expressions are compiled.)</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_strings_in_groovy"></a>33.2.2. Strings in Groovy</h3></div></div></div><p>It is important to know that there are two types of strings in Groovy. The regular (Java) strings that are
enclosed in single quotes and the Groovy <code class="literal">GString</code> strings that are enclosed in double quotes and allow to
enclose variables inline like this:</p><pre class="screen">  def name="Joe"
  def hello="hello $name"      // hello Joe
  def hello='hello $name'      // hello $name
  def helloToo="hello ${name}" // hello Joe</pre><p>This is only mentioned here because the last line contains the same syntax
as how JEXL expressions are invoked in the SLS.
There is no nesting of JEXL expressions within Groovy in the SLS
using this notation, everything within <code class="literal">#{…}</code> is interpreted as Groovy.</p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_groovy_utility_scripts"></a>33.3. Groovy Utility Scripts</h2></div></div></div><p>Besides using Groovy in SLS login models and JSPs and calling whole Groovy
scripts from these places, with Groovy (unlike with JEXL) it is also possible
to call <span class="emphasis"><em>individual methods</em></span> in Groovy scripts.
This makes it possible to write utility classes/libraries in Groovy
and to use them in the SLS, thus helping to express things more concisely
and with less duplicate text in login models.</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_utility_scripts_cookbook"></a>33.3.1. Utility Scripts "Cookbook"</h3></div></div></div><p>First some cookbook recipes how to do this in Groovy; later on some rather technical background,
but understanding that in detail is typically not necessary
in order to write utility Groovy scripts.</p><p>Take the following Groovy script in a file Bar.groovy, which defines a utility method that logs some info:</p><pre class="screen">  static def myLogInfoStatic(def info) {
    function.logInfo('&gt;&gt;')
    function.logInfo(info)
    function.logInfo('&lt;&lt;')
  }</pre><p><span class="strong"><strong>Important:</strong></span> Note that it is no longer necessary to define function prefixes like <code class="literal">function</code>
above with constructs like <code class="literal">def function = var('function')</code> before using the prefixes.
You still need to use <code class="literal">var('myVariable')</code> or <code class="literal">function.getVariable('myVariable')</code> to get a
variable that has been defined in the JEXL/Groovy context before.
Note also that this is <span class="emphasis"><em>not</em></span> necessary in a script that you call <span class="emphasis"><em>directly</em></span> with
<code class="literal">runscript.groovy(...)</code>; there, all variables are available.</p><p>Say, the file Bar.groovy is in a directory called <span class="emphasis"><em>script</em></span> inside the WEB-INF directory of the
SLS web application and the following configuration property has been set:</p><pre class="programlisting">groovy.classpath.add.scriptdir=WEB-INF/scripts</pre><p>The indicated path can be absolute or relative to the root directory of the SLS web application.</p><p>Now, anywhere where you can use Groovy expressions in the SLS,
you can use the following syntax to call the custom logging method:</p><pre class="screen"> #{Bar.myLogInfoStatic('Hello World!')}</pre><p><span class="strong"><strong>Important:</strong></span> For this to work, the name of the groovy file must start with an upper-case letter
(i.e. it must follow the Java naming convention for class names and file names of Java source files).</p><p>If you had more methods in Bar.groovy, it might become too verbose to define variables like <code class="literal">function</code>
in each method over and over again and, in addition, you might want to initialize you utility script
with some parameters that can be used in all methods. Then you could write Bar.groovy as follows:</p><pre class="screen">class Bar {
  def function = var('function')
  def prefix
  Bar(def prefix) {
    this.prefix = prefix
  }
  def myLogInfo(def info) {
    function.logInfo("$prefix: &gt;&gt;")
    function.logInfo("$prefix: $info")
    function.logInfo("$prefix: &lt;&lt;")
  }
}</pre><p>In a Groovy script that you run with <code class="literal">runscript.groovy(…)</code>, say Foo.groovy, you could use Bar.groovy as follows:</p><pre class="screen">def bar1 = new Bar(\'one\')
def bar2 = new Bar(\'two\')
bar1.myLogInfo(\'hello\')
bar2.myLogInfo(\'there\')</pre><p>In a login model, you could use Bar.groovy as follows:</p><pre class="programlisting">model.xy.state.20.name=do.generic-groovy-create-bar
model.xy.state.20.action.1=#{function.setVariable('bar', new Bar('my-prefix'))
[...]
model.xy.state.50.name=do.generic-groovy-use-bar
model.xy.state.50.action.1=#{bar.myLogInfo('hello'}</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_details_and_background"></a>33.3.2. Details and Background</h3></div></div></div><p>If you need more script directories, you can configure them with the setting
<code class="literal">groovy.classpath.add.scriptdir.&lt;suffix&gt;</code>.</p><p>The reason you have to "get" variables in a utility script with, e.g.,</p><pre class="screen">  def function = var('function')</pre><p>is that in Groovy (as in Java), variables are always part of an object or a class.
In the case of a Groovy script that is run with <code class="literal">runscript.groovy(…)</code>, variables like
<code class="literal">function</code> are part of the script class that is run and in Groovy expressions in
<code class="literal">#{…}</code> such a class is created on-the-fly (it appears as <code class="literal">GroovyExpression</code> in error logs).</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_automatic_recompilation_of_groovy_scripts"></a>33.3.3. Automatic Recompilation of Groovy Scripts</h3></div></div></div><p>A useful feature for testing/integration is to set</p><pre class="screen">groovy.scriptdirs.autorecompile=true</pre><p>If set, Groovy scripts are automatically updated when the Groovy scripts in the
configured script directories change, i.e. usually changes in Groovy scrips can
be applied and tested without needing to restart the SLS.</p><p>In productive environments it is generally recommended to switch this off, as
automatic recompilation with otherwise mostly static SLS configuration that is
only read once at startup or first use is not usually not desired. Besides that,
currently the feature would not be robust enough to work in all situations,
especially race conditions can occur under high load, in ways that are hard to
prevent without major changes in the SLS.</p><p>Conversely, if Groovy scripts are protected from unwanted changes, having the
autorecompile feature active in production could in some cases allow to deploy
workarounds without having to restart the SLS, which can be very helpful.</p><p>Note that each time the script files have been successfully recompiled, a message
with level INFO is logged, and each time this faile a message with level ERROR.</p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_groovy_provider_configuration"></a>33.4. Groovy Provider Configuration</h2></div></div></div><p>The SLS has a single provider for Groovy functionality, based on the Groovy JDK
plus an additional library, Grengine.
The provider is configured by default (or by explicitly setting the configuration
property <code class="literal">groovy.provider=grengine</code>;
the previous provider <code class="literal">jdk</code> is no longer supported).</p><p>There are two modes in which the Grengine Groovy provider can operate:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">groovy.grengine.shareclasses=true</code> (default)
  This is currently the recommended setting.
  All login sessions share Groovy classes and thus can also overwrite "each others"
  static (non-final) variables. This is not optimal in terms of security
  (login session isolation), which is why the SLS logs a warning
  [GROOVY_STATIC_VARIABLE] for each such variable encountered in Groovy scripts
  (if operated in this mode). You can choose to convert this warning to a log
  entry with level info, [GROOVY_STATIC_VARIABLE_INTENTIONALLY_SHARED], by renaming
  the variable such that its name contains the string "SlsIntentionallyShared"
  (not case sensitive).
</li><li class="listitem">
<code class="literal">groovy.grengine.shareclasses=false</code>
  All login sessions have their own set of Groovy classes, and yet are still based
  on compiling them only once (a unique feature of Grengine).
  So even static variables are completely separated, relieving operators and integrators
  of having to look after this.
</li></ul></div><p>Historically, the feature of sharing classes had only been introduced into the SLS
in order to work around some memory issues, more precisely with garbage collection
of classes compiled from Groovy scripts that could lead to an OutOfMemoryError
(Metaspace).</p><p>These issues are fixed in the current release, but note that loading classes into
a Java VM, especially Groovy classes with additional metainfo, is a relatively
expensive operation, which will in general reduce the maximal throughput of the SLS.</p><p>Therefore sharing classes (the default) is currently the recommended setting for general use.</p><p>If you want to use the mode where not sharing classes,
make sure you verify the following two things under load:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
How does Metaspace consumption behave, is it regularly garbage collected?
</li><li class="listitem">
Is throughput sufficient for your use cases?
</li></ul></div><p>In order to monitor Metaspace use e.g. <code class="literal">jstat</code> (which is part of the Oracle JDK)
like this:</p><pre class="screen">$ jstat -gc &lt;sls-process-id&gt; 2000 1000</pre><p>This runs jstat 1000 times, printing output every 2 seconds (2000ms) and look for
MC and MU in the output, which stand for claimed respectively used Metaspace.
Or attach to the Java VM using <code class="literal">jvisualvm</code> or a similar GUI tool.</p><p>Finally, note that there is a JEXL/Groovy function
<code class="literal">function.getGroovyConfig(filename)</code> which should normally be used instead of using a
Groovy ConfigSlurper directly for loading Groovy-based configuration files, because
this function automatically caches already parsed configurations and automatically
reparses if the file text has changed. This function is thus faster and prevents
memory issues, which would otherwise exist in this case even independently
of whether sharing classes or not, because each invocation of <code class="literal">ConfigSlurper.parse(...)</code>
implicitly compiles the Groovy config file and loads it into the Java VM.</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_low_level_configuration_settings"></a>33.4.1. Low-level Configuration Settings</h3></div></div></div><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">groovy.script.loginfo</code>: If set to true, logs at level INFO for each Groovy expression
  the  resulting class name (<code class="literal">Script&lt;MD5-hash-of-script-expression&gt;</code>) and script text
  at first compilation, as well as for each Groovy file the filename at first compiliation.
</li><li class="listitem">
<code class="literal">groovy.compile.jdk</code>: The JDK version to create bytecode for when compiling.
  Defaults to <code class="literal">1.8</code> and there is usually no reason to change this.
</li><li class="listitem">
<code class="literal">groovy.compile.indy</code>: Whether to compile to bytecode with "indy" = invoke dynamic.
  Defaults to <code class="literal">true</code> and there is usually no reason to change this.
</li></ul></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_using_java_classes"></a>33.5. Using Java Classes</h2></div></div></div><p>Groovy makes it very comfortable to use Java classes. By default common namespaces like
<code class="literal">java.io</code> are imported and even basic Java classes like <code class="literal">String</code> or <code class="literal">File</code> have been extended
in Groovy with additional methods. For example, to read a text file into a string in Groovy,
you can write the following:</p><pre class="screen">  def fileText = new File('/path/to/file').text</pre><p>Since Groovy is syntactically a superset of Java and since Groovy scripts are always compiled
to the Java VM, a Google search for a solution in Java is often helpful when Java APIs are involved.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_json_map_list_handling_in_groovy"></a>33.6. JSON + Map/List handling in Groovy</h2></div></div></div><p>Some quick tips for handling JSON rendered to maps and generally for handling maps and lists
in Groovy.</p><p>Say, you have the following JSON string:</p><pre class="screen">{
 "mystring": "hello there",
 "mylist": [
  "first"
 ],
 "level1": {
   "level2a": "2a"
 }
}</pre><p>Then you can parse, modify and render it as follows:</p><pre class="screen">String json = ...

def map = function.parseJson(json)

// change string value
map.mystring = 'hi there'

// add an item to the list with Java-style map operation
map.mylist.add('second')

// add an item to the list Groovy-style
map.mylist &lt;&lt; 'third'

// add several items to the list, first Java-style, then Groovy style
map.mylist.addAll(['4th', '5th'])
map.mylist &lt;&lt; '6th' &lt;&lt; '7th'

// note that you could also replace the whole list (commented out below)
// map.mylist = [ 'aaa', 'bbb' ]

// add item with nested selection
map.level1.level2b = '2b'

// add a sublevel
map.level1.level2c = [ 'level3' : '3' ]

String jsonNew = function.prettyPrintJson(map)</pre><p>This yields:</p><pre class="screen">{
    "mystring": "hi there",
    "mylist": [
        "first",
        "second",
        "third",
        "4th",
        "5th",
        "6th",
        "7th"
    ],
    "level1": {
        "level2a": "2a",
        "level2b": "2b",
        "level2c": {
            "level3": "3"
        }
    }
}</pre><p>See general tutorials about how to handle maps and lists in Groovy for more tricks.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_jexl_to_groovy_migration"></a>33.7. JEXL to Groovy migration</h2></div></div></div><p>When making the switch from JEXL to Groovy scripting, the following table should
help to use the right expressions and functions.</p><div class="table"><a id="idm7728"></a><p class="title"><strong>Table 33.1. JEXL to Groovy migration table</strong></p><div class="table-contents"><table class="table" summary="JEXL to Groovy migration table" cellpadding="4px" style="border-collapse: collapse;border-top: 3px solid #527bbd; border-bottom: 3px solid #527bbd; border-left: 3px solid #527bbd; border-right: 3px solid #527bbd; "><colgroup><col class="col_1" /><col class="col_2" /><col class="col_3" /></colgroup><thead><tr><th style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top">JEXL </th><th style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top">Groovy  </th><th style="border-bottom: 1px solid #527bbd; " align="left" valign="top">Notes</th></tr></thead><tbody><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>if(&lt;string&gt;) or if(!&lt;string)</p></td><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>if(&lt;string&gt; == <span class="emphasis"><em>true</em></span>) or if(&lt;string&gt;) == <span class="emphasis"><em>false</em></span>)</p></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><div class="important" style="margin-left: 0; margin-right: 10%;"><h3 class="title">Important</h3><p>In JEXL, a boolean check can be performed on a String containing
the value "true" or "false"; this is not possible in Groovy. Instead, the
String value must explicitely be compared to a certain String value.</p></div>
<p>The problem is that while JEXL checks for the String value to be "true" or "false",
Groovy only checks if the String is empty or not. So, either use actual
boolean variables instead of Strings, or compare against a fixed value.</p></td></tr><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>eq</p></td><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>\==</p></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>All conditional operators have to be changed to the Java format.</p></td></tr><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>function.setVariable("myvar", "..")</p></td><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>setVar("myvar", "..")</p></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>Use new lean Groovy function.</p></td></tr><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>function.getVariable("myvar")</p></td><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>var("myvar")</p></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>Use new lean Groovy function.</p></td></tr><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>function.getVariable("myvar", "defaultValue")</p></td><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>var("myvar", "defaultValue")</p></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>Use new lean Groovy function.</p></td></tr><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>function.hasVariable("myvar")</p></td><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>hasVar("myvar")</p></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>Use new lean Groovy function.</p></td></tr><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>function.hasNonEmptyVariable("myvar")</p></td><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>hasNonEmptyVar("myvar")</p></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>Use new lean Groovy function.</p></td></tr><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>function.clearVariable("myvar")</p></td><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>clearVar("myvar")</p></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>Use new lean Groovy function.</p></td></tr><tr><td style="border-right: 1px solid #527bbd; " align="left" valign="top"><p>function.clearVariables("prefix")</p></td><td style="border-right: 1px solid #527bbd; " align="left" valign="top"><p>clearVars("prefix")</p></td><td style="" align="left" valign="top"><p>Use new lean Groovy function.</p></td></tr></tbody></table></div></div><br class="table-break" /></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_groovy_resources"></a>33.8. Groovy Resources</h2></div></div></div><p>An introduction to Groovy as a language is beyond the scope of this document.
Instead, here are some basic resources and hints.</p><p>The already mentioned Groovy web site at <a class="ulink" href="http://www.groovy-lang.org/" target="_top">groovy-lang.org</a> is a good start.
The book <a class="ulink" href="https://www.manning.com/books/groovy-in-action-second-edition" target="_top"><span class="emphasis"><em>Groovy in Action, Second Edition</em></span></a> does a very good job at presenting the language from
the very basics to expert features, and the introductory chapter of it is available for free.
Google seems to usually yield good answers to queries related to Groovy.</p><p>And, of course, there is some Groovy know-how at United Security Providers.</p></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="x66021_Heading1Tarsec_SES_Session_Attributes"></a>Chapter 34. SES Session Attributes</h2></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_background"></a>34.1. Background</h2></div></div></div><p>The term "SES Session Attributes" refers to a proprietary, HTTP header based
communication interface between the SLS and the SES. It allows the SLS to
instruct the SES to perform certain actions within the client session after a
successful login, such as:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
propagating custom HTTP headers to the application, for example with some kind
of login ticket, the user ID etc.
</li><li class="listitem">
setting authorizations in the client session
</li><li class="listitem">
creating AAI variables that can be used by the SES to integrate form-based
logins of application servers (see
<a class="link" href="#x97662_Heading2Tarsec_Application_Server" title="23.5. Application Server Authentication">"Application Server Authentication"</a>)
</li><li class="listitem">
setting / overriding timeout settings of the reverse proxy
</li></ul></div><p>Technically, a SES session attribute is created by the SLS by setting an HTTP
response header in its response sent to the client. This header will be
intercepted and processed by the SES. The header consists of a number of
key-/value pairs. The mandatory keys are:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
"<code class="literal">usage</code>" - Defines how to handle the attribute / what action to take
</li><li class="listitem">
"<code class="literal">name</code>" - Defines the name of the AAI variable, or custom header etc.
</li><li class="listitem">
"<code class="literal">path</code>" - The URI path for which the attribute should be valid. Note that his
path must be equal to or below the "Authorized Path" of the requested location.
</li><li class="listitem">
"<code class="literal">value</code>" - The value of the AAI variable or custom header etc.
</li></ul></div><p>Two additional optional keys are:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
"<code class="literal">encoding</code>" - The encoding of the string in the "<code class="literal">value</code>" field (plain,
                 Base64 or URL).
</li><li class="listitem">
"<code class="literal">timeout</code>" - A timeout for the session attribute itself; this is only supported
                for authorization attributes (see "ac-app-az" below). It has nothing
                to do with setting / overriding HSP session timeout values; that is
                done with <code class="literal">usage</code> set to <code class="literal">ac-cred-tmo</code>.
</li></ul></div><p>The name of such a header consists of a prefix, followed by a number (the
numbering must start at 0 and not have any gaps). Examples of such headers set
by the SLS after a successful login:</p><pre class="screen">HSP_AC_SESSION_ATTRIBUTES-0=usage="aai-param",name="FormPassword",path="/ite",value="abcd1234"
HSP_AC_SESSION_ATTRIBUTES-1=usage="aai-param",name="FormUserName",path="/ite",value="dummy"
HSP_AC_SESSION_ATTRIBUTES-2=usage="prop-header",name="plainuser",path="/ite",value="dummy"
HSP_AC_SESSION_ATTRIBUTES-3=usage="ac-app-az",name="strong",path="/ite",value="allow"</pre><p>In this example, the session attribute headers "0" and "1" create AAI variables
"<code class="literal">FormPassword</code>" and "<code class="literal">FormUserName</code>" for the SES to use in an AAI script in the
SRM configuration.</p><p>Header "2" instructs the SES to start propagating a custom HTTP header named
"<code class="literal">plainuser</code>" to the application in all following requests, with the user ID as
its plaintext value.</p><p>Header "3" creates an authorization "<code class="literal">strong</code>" for the URI path "<code class="literal">/ite</code>".</p><p>The following chapters explain how to create SES session attributes "by hand",
using specific sets of configuration properties.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_configuration_5"></a>34.2. Configuration</h2></div></div></div><p>For every SES Session Attribute to be created after a successful login, a group
of properties must be defined in the "<code class="literal">sls.properties</code>" file. Such a group of
properties always consists of at least four mandatory and one optional property,
grouped by number suffixes.</p><p><span class="strong"><strong>Mandatory properties</strong></span></p><pre class="screen">session-attribute.type.&lt;number&gt;
session-attribute.name.&lt;number&gt;
session-attribute.path.&lt;number&gt;
session-attribute.value.&lt;number&gt;</pre><p><span class="strong"><strong>Optional properties</strong></span></p><pre class="screen">session-attribute.encoding.&lt;number&gt;
session-attribute.timeout.&lt;number&gt;</pre><p>where the <code class="literal"><span class="emphasis"><em>&lt;number&gt;</em></span></code> part is used to group the properties for one session
attribute definition together. The following properties are available to
configure one session attribute:</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_mandatory_properties"></a>34.2.1. Mandatory Properties</h3></div></div></div><p><span class="strong"><strong><code class="literal">session-attribute.type.</code></strong></span></p><p>The usage type of the session attribute.</p><pre class="screen">session-attribute.type.0=aai-param</pre><p>Supported values for usage type are:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">ac-app-az</code> : Grant the user the authorization (role) defined in the field <code class="literal">value</code>.
</li><li class="listitem">
<code class="literal">aai-param</code> : Propagate an AAI variable to the HSP. The name of the AAI variable
                is defined by the field <code class="literal">name</code>, its value by the field <code class="literal">value</code>.
</li><li class="listitem">
<code class="literal">prop-header</code> : Propagate a custom HTTP header to the application backend after
                  a successful login. The name of the header will be defined by
                  the <code class="literal">name</code> field, its value by the <code class="literal">value</code> field.
</li><li class="listitem">
<code class="literal">ac-cred-tmo</code> : Override a HSP timeout setting. The <code class="literal">value</code> field must contain
                  the number of seconds and the <code class="literal">name</code> field must contain one
                  of the following names, which corresponds to a certain HSP
                  timeout setting (see list below).
</li></ul></div><p><span class="strong"><strong><code class="literal">session-attribute.name.</code></strong></span></p><p>The name of the propagated header, the AAI variable, the autorization to create
or the name of the timeout setting to override. Example:</p><pre class="screen">session-attribute.name.0=FormUserName</pre><p>If <code class="literal">type</code> is set to <code class="literal">ac-cred-tmo</code>, the following values are supported for <code class="literal">name</code>:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">CredentialFinalTimeout</code> - to set the final timeout (default)
</li><li class="listitem">
<code class="literal">CredentialValidityPeriod</code> - to set the final timeout (default)
</li><li class="listitem">
<code class="literal">CredentialUpdateTrigger</code> - to set the validity period (default)
</li><li class="listitem">
<code class="literal">CredentialFinalTimeoutMember</code> - to set the final timeout for the security class "Member"
</li><li class="listitem">
<code class="literal">CredentialFinalTimeoutCustomer</code> - to set the final timeout for the security class "Customer"
</li><li class="listitem">
<code class="literal">CredentialValidityPeriodMember</code> - to set the validity period timeout for the security class "Member"
</li><li class="listitem">
<code class="literal">CredentialValidityPeriodCustomer</code> - to set the validity period timeout for the security class "Customer"
</li><li class="listitem">
<code class="literal">CredentialUpdateTriggerMember</code> - to set update trigger time for the security class "Member"
</li><li class="listitem">
<code class="literal">CredentialUpdateTriggerCustomer</code> - to set update trigger time for the security class "Customer"
</li></ul></div><p>For more information about these different types of timeouts, see
<a class="link" href="#HSP_timeouts_appendix" title="Chapter 68. HSP Timeouts">"HSP Timeouts Appendix"</a>.</p><p><span class="strong"><strong><code class="literal">session-attribute.path.</code></strong></span></p><p>The URI path for which the session attribute should be valid. Example:</p><pre class="screen">session-attribute.path.0=/apps</pre><p>Note 1: It is a good practice to set the value of the "Authorized Path" which was
currently requested. There is a special JEXL variable for this value (see
<a class="link" href="#x80274_Heading2Tarsec_Special_Variables" title="32.6. Special Variables">"Special Variables"</a>). Example:</p><pre class="screen">session-attribute.path.0=${special.authorized.path}</pre><p>This will set the same value for the "<code class="literal">path</code>" as was defined by the
"<code class="literal">AC_AuthorizedPath</code>" directive in the corresponding location in the SRM
configuration.</p><p>Note 2: The "path" field MUST not be set for WAF timeout session attributes,
i.e. attributes with usage type <code class="literal">ac-cred-tmo</code>.</p><p><span class="strong"><strong><code class="literal">session-attribute.value.</code></strong></span></p><p>The value of the propagated header, the AAI variable etc. Example:</p><pre class="screen">session-attribute.value.0=${session.getCred('username')}</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_optional_properties"></a>34.2.2. Optional Properties</h3></div></div></div><p><span class="strong"><strong><code class="literal">session-attribute.encoding.</code></strong></span></p><p><span class="emphasis"><em>Optional</em></span>: The encoding to use for the "<code class="literal">value</code>" part in the resulting HTTP
response header. Allowed values are "<code class="literal">string</code>" (value is set 1:1, regardless of
any special characters in it), "<code class="literal">url</code>" and "<code class="literal">base64</code>". Default is  "<code class="literal">url</code>" if
the configuration property "<code class="literal">session-attribute.encodings</code>" had been set to "true"
(see <a class="link" href="#x30341_Heading2Tarsec_Session_Attribute_Value_Encoding" title="34.3. Session Attribute Value Encoding">"Session Attribute Value Encoding"</a>). Otherwise, it's always "<code class="literal">string</code>".</p><p><span class="strong"><strong><code class="literal">session-attribute.timeout.</code></strong></span></p><p>The idle timeout for the attribute. Currently only supported for attributes of
usage type "ac-app-az" (authorizations). Example:</p><pre class="screen">session-attribute.timeout.0=300</pre><p>That way, the authorization expires after 5 minutes of inactivity.</p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="x30341_Heading2Tarsec_Session_Attribute_Value_Encoding"></a>34.3. Session Attribute Value Encoding</h2></div></div></div><p>If the value of a session attribute contains special characters, it may be
necessary to encode it. A typical use case is an AAI variable containing the
password. In some cases, users are allowed to have passwords with special,
non-ASCII characters in them. Which can be a problem if that value is then
used in a GET request to an application back-end.</p><p>In order to enable support for encodings, the following configuration property
must be set in "<code class="literal">sls.properties</code>":</p><pre class="screen">session-attribute.encodings=true</pre><p><span class="emphasis"><em>If it is enabled, all session attribute values will be "url" encoded by
default</em></span>. In a case where that is a problem for a single attribute, the
"<code class="literal">.encoding</code>" property for that one attribute can be set to "<code class="literal">string</code>".</p><pre class="screen">session-attribute.encoding.0=string</pre><p><span class="emphasis"><em>NOTE: If the property "<code class="literal">session-attribute.encodings</code>" is not set at all, all
values will not be encoded (equals to "<code class="literal">string</code>" ). Any properties with prefix
"<code class="literal">session-attribute.encoding.</code>" will be ignored!</em></span></p><p>If encoding needs to be using a specific charset, the encoding of the value can
be done in the script expression instead of letting the SLS do it:</p><pre class="screen">session-attribute.encodings=true
[...]
session-attribute.encoding.0=url
session-attribute.value=${function.urlEncode(session.getCred('username'), 'ISO-8859-1')}
session-attribute.isValueEncoded=true</pre><p>In other words provide a setting "<code class="literal">session-attribute.isValueEncoded=true</code>" and
make sure the value is already URL encoded. The HSP will URL decode but
otherwise not touch the bytes. That way e.g. headers can be forwarded
to applications in practically any encodings that the Java VM supports.
(Note that this mechanism is meant to be used with encoding "url" (or "base64"),
but not with the legacy encoding "string".)</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_jexl_functions"></a>34.4. JEXL Functions</h2></div></div></div><p>There are a few JEXL functions available to work with SES session attributes:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">session.getSessionAttributes()</code> - Returns a list of currently available
session attributes. See below (
<a class="link" href="#x75913_Heading3Tarsec_Session_Attribute_Object_Methods" title="34.4.1. Session Attribute Object Methods">"Session Attribute Object Methods"</a>) for more information.
</li><li class="listitem">
<code class="literal">session.hasSessionAttribute(usage, name, path, value)</code> and
<code class="literal">session.hasSessionAttribute(usage, name, path)</code>- Allow to check if a certain
session attribute exists in the current session.
</li></ul></div><p>Please read the <a class="xref" href="#JEXLGUIDE">[JEXLGUIDE]</a><a class="link" href="#JEXLGUIDE">[JEXLGUIDE]</a> for details about
syntax and usage of these functions.</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="x75913_Heading3Tarsec_Session_Attribute_Object_Methods"></a>34.4.1. Session Attribute Object Methods</h3></div></div></div><p>Each session attribute object in the list returned by
"<code class="literal">session.getSessionAttributes()</code>" has the following methods:</p><p><code class="literal">.getName()</code>- Returns the name of the attribute (aka the name of the AAI
variable, or the propagated header, or the HGW directive, or the authorization).</p><p><code class="literal">.getPath()</code> - Returns the URI path for which this session attribute is active.</p><p><code class="literal">.getValue()</code> - Returns the session attribute value. For propagated headers,
this is the header value, for AAI variables it's the variable value, and for
authorizations it's always the string "<code class="literal">allow</code>".</p><p><code class="literal">.getUsage()</code> - Returns the type of session attribute. Which is always one of
the following values:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">aai-param</code> - AAI parameter
</li><li class="listitem">
<code class="literal">prop-header</code> - Header propagation
</li><li class="listitem">
<code class="literal">ac-app-az</code> - Authorization
</li><li class="listitem">
<code class="literal">ac-cred-tmo</code> - HSP timeout override
</li></ul></div><p><code class="literal">.getEncoding()</code> - Returns the encoding of the attribute ("string", "url" or "base64").</p><p><span class="strong"><strong>Example JEXL script:</strong></span></p><pre class="screen">## Iterate through all session attributes
for(attr : session.getSessionAttributes()) {
  if(attr.getUsage() eq 'prop-header') {
    function.printToConsole('-- Propagated Header --');
    function.printToConsole('Name ' + attr.getName());
    function.printToConsole('Value ' + attr.getValue());
  }
}</pre></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_examples_2"></a>34.5. Examples</h2></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_overriding_hsp_session_timeout_settings"></a>34.5.1. Overriding HSP session timeout settings</h3></div></div></div><p>How to override the value for the "CredentialFinalTimeout" in the HSP configuration,
for the given authorized path:</p><pre class="screen"># Set the final timeout for Member logins to 3600 seconds
session-attribute.type.1=ac-cred-tmo
session-attribute.name.1=CredentialFinalTimeoutMember
session-attribute.path.1=${special.authorized.path}
session-attribute.value.1=3600</pre><p>The timeout is set to 3600 seconds. If the value set by the SLS is higher than
the maximum, or lower than the minimum configured in the HSP, the HSP will
automatically adjust the value to either the minimum or maximum.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_creating_an_aai_variable"></a>34.5.2. Creating an AAI variable</h3></div></div></div><p>Note: There is an easier way to create AAI variables after the login:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
Set a property 
"<code class="literal">formauth.parameter.<span class="emphasis"><em>&lt;variable name&gt;</em></span>=<span class="emphasis"><em>&lt;parameter name&gt;</em></span></code>" 
in the "<code class="literal">sls.properties</code>" file (see <a class="link" href="#x43582_Heading4Tarsec_FORM_based_Authentication_Only" title="FORM-based Authentication Only">"FORM-based Authentication Only"</a>).
</li></ul></div><p>So use the following properties only if for some reason the other approach is insufficient. Example:</p><pre class="screen"># Create an AAI variable "FormPassword" with the password, URL-encoded
session-attribute.type.0=aai-param
session-attribute.name.0=FormPassword
session-attribute.path.0=${special.authorized.path}
session-attribute.value.0=${session.getVerifiedCred('password')}
session-attribute.encoding.0=url</pre><p>Creates an AAI variable "<code class="literal">FormPassword</code>" that can be used in an AAI script for
any location that has the same authorized path as the current location. The
variable has the value of the verified credential with the semantic type
"<code class="literal">password</code>". In the AAI script in the SRM configuration, the variable is
referred to with the prefix "<code class="literal">AC.SessionAttributes.</code>":</p><pre class="screen">AC.SessionAttributes.FormPassword</pre><p>Example for creating two variables with the username and password (where the
password is URL-encoded), and then using the values of those variables in an
actual AAI script:</p><p><span class="strong"><strong>SLS configuration properies</strong></span></p><pre class="screen"># Create an AAI variable "FormPassword" with the password, URL-encoded
session-attribute.type.0=aai-param
session-attribute.name.0=FormPassword
session-attribute.path.0=${special.authorized.path}
session-attribute.value.0=${session.getVerifiedCred('password')}
session-attribute.encoding.0=url

# Create an AAI variable "FormUserName" with the user ID
session-attribute.type.1=aai-param
session-attribute.name.1=FormUserName
session-attribute.path.1=${special.authorized.path}
session-attribute.value.1=${session.getVerifiedCred('username')}</pre><p><span class="strong"><strong>AAI Script in SRM configuration</strong></span></p><pre class="screen">HGW_Aai_AddRule if (  STATE == 0 RC == 200 \
BODY =~ "j_security_check" ) { \
  METHOD = POST \
  URI = "/application/j_security_check" \
  HDR.Content-type = "application/x-www-form-urlencoded" \
  PARAM.j_username = AC.SessionAttributes._FormUserName_ \
  PARAM.j_password = AC.SessionAttributes._FormPassword_ \
  NEXT_STATE = 1 \
}</pre><p>This will finally POST the request parameters "<code class="literal">j_username</code>" and "<code class="literal">j_password</code>"
to the applications\' own login location.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_propagating_a_custom_header"></a>34.5.3. Propagating a custom header</h3></div></div></div><p>Note: There are two easier ways to propagate custom headers to the application
after the login:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">
Set a property "<code class="literal">app.header.+<span class="emphasis"><em>&lt;name&gt;</em></span></code>+=<code class="literal"><span class="emphasis"><em>&lt;value&gt;</em></span></code>" in the "<code class="literal">sls.properties</code>"
file (see <a class="link" href="#x11777_Heading3Tarsec_Propagating_HTTP_Headers" title="23.2.2. Propagating Custom HTTP Headers">"Propagating Custom HTTP Headers"</a>).
</li><li class="listitem">
Invoke the JEXL function "<code class="literal">response.propagateHeaderToApp()</code>" from an action in
the model (see <a class="link" href="#JEXLGUIDE">[JEXLGUIDE]</a> and
<a class="link" href="#x47278_Heading3Tarsec_Custom_Actions" title="7.6.1. Custom Actions">"Custom Actions"</a>).
</li></ol></div><p>So use the following properties only if for some reason the other two approaches
are insufficient. Example:</p><pre class="screen"># Propagate custom header "plainuser" with user ID
session-attribute.type.0=prop-header
session-attribute.name.0=plainuser
session-attribute.path.0=${special.authorized.path}
session-attribute.value.0=${session.getVerifiedCred('username')}</pre><p>Propagates a custom HTTP header named "<code class="literal">plainuser</code>" with the value of the
verified credential of type "<code class="literal">username</code>" to the authorized path of the requested location.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_creating_an_authorization"></a>34.5.4. Creating an authorization</h3></div></div></div><p>Note: There is an easier way to create an authorization after the login:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
Invoke the JEXL function "<code class="literal">response.setAuthorization()</code>" from an action in
the model (see <a class="link" href="#JEXLGUIDE">[JEXLGUIDE]</a> and
<a class="link" href="#x47278_Heading3Tarsec_Custom_Actions" title="7.6.1. Custom Actions">"Custom Actions"</a>).
</li></ul></div><p>So use the following properties only if for some reason the other  approache is
insufficient. Example:</p><pre class="screen"># Set authorization "strong" for current session
session-attribute.type.0=ac-app-az
session-attribute.name.0=strong
session-attribute.path.0=${special.authorized.path}
session-attribute.value.0=allow</pre><p>Sets the authorization "strong" to the authorized path of the requested
location. Note that the "value" field always has to be set to "<code class="literal">allow</code>" in
this case.</p></div></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="x91117_Heading1Tarsec_Errorcodes"></a>Chapter 35. Error Handling</h2></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_introduction_12"></a>35.1. Introduction</h2></div></div></div><p>While processing a request, the SLS may encounter various types of errors; technical or authentication-related. Usually when an error occurs, this results in a corresponding log message (see chapter   for details) and in a message displayed in the end-user's client. What message is displayed to the user for any given error can be customized by changing the error mapping.</p><p>Each error has an internal ID, and that ID is mapped to a text message which will be displayed in the HTML page. Usually, it is sufficient to adapt the text messages in the message resource file (see <a class="link" href="#x17268_Heading3Tarsec_Message_Resource_Files" title="14.4. Message Resource Files">"Message Resource Files"</a>), but if necessary, the mapping can be customized as well.</p><p>A list of all error codes is available in the <a class="link" href="#LOGMESSAGES">[LOGMESSAGES]</a>.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="x74841_Heading2Tarsec_Displaying_Internal_Error_Code"></a>35.2. Displaying Internal Error Code</h2></div></div></div><p>Sometimes it is useful to see the internal error code directly on the login page, and not only in a log file. The following property in the "<code class="literal">sls.properties</code>"-file enables displaying internal errorcodes in the JSP:</p><pre class="programlisting">error.details=true</pre><p>If not set, it defaults to "<code class="literal">false</code>".</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="x19350_Heading2Tarsec_Internal_Error_Code_HTTP_Response_Header"></a>35.3. Internal Error Code HTTP Response Header</h2></div></div></div><p>If any error occurs during a login, error messages are displayed to a human user in a page. However, programmatic clients require means to determine the reason for a failed login attempt properly, without having to parse a HTML page. This property allows to let the SLS set a HTTP reponse header with the name  "<code class="literal">SLSError</code>" in case of an error. The value of the header is the  message of the internal exception which originally caused the error.</p><p><span class="strong"><strong><code class="literal">error.header</code></strong></span></p><p>To enable the HTTP response header "<code class="literal">SLSError</code>" , set the property to "<code class="literal">true</code>". It defaults to "<code class="literal">false</code>" if not set.</p><p>Note: If this feature is enabled, the response header "<code class="literal">SLSError</code>" must also be enabled in the HSP configuration. Otherwise, the HSP will filter out the header from the response and it will not reach the client.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="x79584_Heading2Tarsec_Error_Code_Mapping_Configuration"></a>35.4. Error Code Mapping Configuration</h2></div></div></div><p>The mapping of internal SLS error codes to the external messages used to be presented to the user in a JSP, for example, can be configured through a set of Java properties in this file:</p><p><code class="literal">WEB-INF/sls-errormap.properties</code></p><p>This file contains key-/value-pairs, each one mapping from an internal error to
the ID of a message displayed to the user. Example:</p><pre class="screen"># General technical error
INVALID_CRED = sls.invalid.credentials</pre><p>In this example, the internal error "INVALID_CRED" is mapped to the generic
error message with the ID "<code class="literal">sls.invalid.credentials</code>", as defined in the message
resource properties file (see chapter
<a class="link" href="#x17268_Heading3Tarsec_Message_Resource_Files" title="14.4. Message Resource Files">"Message Resource Files"</a>
for details).</p><p>If there is no mapping defined, the default error message is returned with the ID "<code class="literal">sls.default.error</code>".</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="x43339_Heading2Tarsec_Multiple_Errors_Showing_First_Or_Last"></a>35.5. Multiple Errors / Showing First Or Last</h2></div></div></div><p>In cases where there are multiple errors ocurring during the processing of one single request by the SLS, the default behaviour is that the SLS will display all the messages combined in the login page. There are two configuration switches that allow to change that behaviour:</p><p><span class="strong"><strong><code class="literal">jsp.globalerror.first</code></strong></span></p><p><span class="emphasis"><em>Optional:</em></span> If set to "<code class="literal">true</code>", only the first error of all the errors that happened during the last request will be displayed.</p><p><span class="strong"><strong><code class="literal">jsp.globalerror.last</code></strong></span></p><p><span class="emphasis"><em>Optional:</em></span> If set to "<code class="literal">true</code>", only the last error of all the errors that happened during the last request will be displayed.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_triggering_enforcing_errors"></a>35.6. Triggering / Enforcing Errors</h2></div></div></div><p>Sometimes it may be desirable to trigger an error in a flow, based on some arbitrary condition. To do this, the desired error must actually be triggered in the SLS by using one of the corresponding JEXL functions. Simply showing the error JSP (such as "<code class="literal">UserError.jsp</code>") will not display any actual error message, because no error actually occurred (no Java exception was thrown within the SLS processing).</p><p>The following example shows how to enforce showing an error page with a certain error code. Example scenario:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
The users can log in from two different virtual hosts, "<span class="emphasis"><em>intranet.acme.com</em></span>" and "<code class="literal">extranet.acme.com</code>"; the same login model is used for both cases.
</li><li class="listitem">
When a user logs in over "<span class="emphasis"><em>extranet.acme.com</em></span>", he/she has to use a SecurID token. A two-step login procedure is used, where first the username and password is checked, then an LDAP lookup is performed to find out if the user owns a SecurID token, and then the token code must be entered.
</li><li class="listitem">
If the LDAP lookup reveals that the user doesn't have a token, an error should be triggered. The fictional LDAP attribute "<code class="literal">hasToken</code>" will be set to "<code class="literal">true</code>" if the user actually has a SecurID token; so if that attribute is set to "<code class="literal">false</code>", an error should be triggered.
</li></ul></div><pre class="programlisting">model.login.uri=/auth
model.login.failedState=get.usererror

# Show login page for username and password
model.login.state.100.name=get.cred

# Verify username and password (e.g. with LDAP)
model.login.state.200.name=do.auth

# Look up user information from LDAP.
model.login.state.300.name=do.ldap
model.login.state.300.property=lookup

# Check if user needs, and has, a SecurID token; trigger error if not.
model.login.state.400.name=do.generic-checkForToken
model.login.state.400.action.1=${function.failWithAuthenticationError('ERR_MISSING_CRED', 'User has no token')}
model.login.state.400.action.1.if.1=${header.hsp_https_host == 'extranet.acme.com' &amp;&amp; attribute.ldap.hasToken != 'true'}
model.login.state.400.nextState.1=do.success
model.login.state.400.nextState.1.if.1=${header.hsp_https_host == 'intranet.acme.com'}

# No error occurred, so user has token; show challenge page...
model.login.state.500.name=get.cred.challenge
#  ...and verify the SecurID code
model.login.state.600.name=do.authresponse

#  Complete the login
model.login.state.800.name=do.success

# Error page
model.login.state.900.name=get.usererror +</pre><p><span class="emphasis"><em>NOTE: It may make more sense to use the "function.failWithCustomError()" functions in order to show completely customized error messages. Alternatively, see <a class="link" href="#x79584_Heading2Tarsec_Error_Code_Mapping_Configuration" title="35.4. Error Code Mapping Configuration">"30.4 Error Code Mapping Configuration"</a> for details about how to map SLS error codes like "ERR_MISSING_CRED" to actual on-screen text messages.</em></span></p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_state_specific_error_messages"></a>35.7. State-Specific Error Messages</h2></div></div></div><p>In some situations it might be required to have different error messages for the
same internal error code, based on the current model state. For example, if
there are two different models in the SLS, one for login and one for a
challenge / response process, they might look like this:</p><pre class="programlisting">model.login.uri=/auth
model.login.failedState=get.cred
model.login.state.10.name=get.cred
model.login.state.20.name=do.auth
model.login.state.30.name=do.success

model.challenge.uri=/challenge
model.challenge.failedState=get.cred.challenge
model.challenge.state.10.name=get.cred.challenge
model.challenge.state.20.name=do.authresponse
model.challenge.state.30.name=do.success</pre><p>Entering an invalid password in the "<code class="literal">login</code>" model may result in the same
internal error code "<code class="literal">INVALID_CRED</code>" as entering an invalid response code in
the "<code class="literal">challenge</code>" model. But in some cases, it may be desirable to display
different messages for each case.</p><p>The key to do this is the fact that the SLS will be in the model state
"<code class="literal">get.cred</code>" for the "<code class="literal">login</code>" model, when showing the error message, and
in the state "<code class="literal">get.cred.challenge</code>" for the "<code class="literal">challenge</code>" model.</p><p>It is possible to trigger a specific error message based on the current model
state by adding the model state name enclosed in square brackets as a prefix
to the message key in the resource file:</p><p><span class="strong"><strong>sls-errormap.properties</strong></span></p><p>Example mapping for the error code "<code class="literal">INVALID_CRED</code>":</p><pre class="screen">INVALID_CRED = inv.cred</pre><p><span class="strong"><strong>sls-resources.properties</strong></span></p><p>Example definition of a global error message text for this mapping, and an alternative text to be displayed instead if the current model state is "<code class="literal">get.cred.challenge</code>":</p><pre class="programlisting"># Default message
inv.cred={0} Username or password invalid.

# Special message for model state 'get.cred.challenge'
[get.cred.challenge]inv.cred={0} Response code invalid.</pre><p>Additionally, the name of the model can be prefixed within the square brackets,
separated by an underscore ("_") character; in case the same state is used in
several models, and there should be a different message for each case:</p><pre class="programlisting"># Default message
inv.cred={0} Username or password invalid, login failed.

# Special message for model state 'get.cred.challenge',
# with name of model "reauth" prefixed
[reauth_get.cred.challenge]inv.cred={0} Response code invalid, re-authentication failed.

# Special message for model state 'get.cred.challenge',
# with name of model "changepassword" prefixed
[changepassword_get.cred.challenge]inv.cred={0} Response code invalid, password was not changed.</pre><p></p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="x82593_Heading2Tarsec_Displaying_Debug_Information"></a>35.8. Displaying Debug Information</h2></div></div></div><p><span class="strong"><strong>debug.info</strong></span></p><p><span class="emphasis"><em>Optional:</em></span> Allows to enable displaying session internal information in the footer of the current JSP, such as JEXL variables, current model state, mandator, credentials etc. This can be useful tu support debugging without needing access to a log file. Example:</p><pre class="programlisting">debug.info=true</pre><p>The debug info will be generated by the JSP-tag "<code class="literal">mandatoryFooter</code>". It will look something like this:</p><div class="informalfigure"><div class="mediaobject"><img src="footer_debuginfo.png" height="500" alt="footer_debuginfo.png" /></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_displaying_production_warnings"></a>35.8.1. Displaying Production Warnings</h3></div></div></div><p>If "debug.info" is not enabled (which is the default), the JSP-tag "<code class="literal">mandatoryFooter</code>" will generate a box with warnings about settings it detected in the SLS setup that may be critical in a production environment:</p><div class="informalfigure"><div class="mediaobject"><img src="footer_warnings.png" alt="footer_warnings.png" /></div></div></div></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="Geode"></a>Chapter 36. Apache Geode Support</h2></div></div></div><p>The SLS supports reading data from, and storing data in a Geode store. Apache Geode stores can be both distributed
in clusters, and also persisted if necessary.</p><p><span class="strong"><strong><code class="literal">geode.host</code></strong></span></p><p>Mandatory / Specifies the hostname (or IP address) of the Geode locator service.
Example:</p><pre class="programlisting">geode.host=geode.server.acme.com</pre><p><span class="strong"><strong><code class="literal">geode.port</code></strong></span></p><p>Optional / Specifies the port of the Geode locator listener. Defaults to 10334.
Example:</p><pre class="programlisting">geode.port=20334</pre></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="_storing_reading_data"></a>Chapter 37. Storing / Reading Data</h2></div></div></div><p>In order to store and read data, the corresponding scripting functions with prefix "geode." must be used:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">GeodeClient getClientForRegion(String region)</code> - Returns a client instance used to read and write data
</li><li class="listitem">
<code class="literal">void writeValue(GeodeClient client, String key, Object data)</code> - Stores a data object in Geode
</li><li class="listitem">
<code class="literal">Object readValue(GeodeClient client, String key)</code> - Reads a data object from Geode
</li><li class="listitem">
<code class="literal">void clode(GeodeClient client)</code> - Closes the connection to Geode
</li></ul></div><p>See "SLS Scripting Guide" for details.</p></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="_headers"></a>Chapter 38. Headers</h2></div></div></div><p>The SLS sets some custom HTTP headers in its response - some after every request, some only after a completed login attempt. This chapter documents those custom HTTP response headers, their meaning and what they are used for.</p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_hsp_response_header_filtering"></a>38.1. HSP Response Header Filtering</h2></div></div></div><p>Note that all these headers are not sent to the actual client by default. Since some of these headers can be especially useful for programmatic clients (as a very simple means of determining the state of an authentication attempt), it can make sense to enable them; see <a class="link" href="#HTTPADMIN">[HTTPADMIN]</a>  for documentation of these SRM directives:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">RF_ServerResponseHeaderAllow</code>
</li><li class="listitem">
<code class="literal">RF_LocationResponseHeaderAllow</code>.
</li></ul></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="x121212_Heading1Tarsec_SLSStatus_Header"></a>38.2. Header "SLSStatus"</h2></div></div></div><p>This header is always set in every response. It is meant to give a very basic indication of the state of the authentication. It contains a numeric value whose meaning is similar to the corresponding HTTP response codes. The possible values for this header are:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">200</code> - Authentication was successfully completed.
</li><li class="listitem">
<code class="literal">401</code> - Default: Authentication (still) required
</li><li class="listitem">
<code class="literal">500</code> - There was an internal error in the SLS (not the back-end)
</li><li class="listitem">
<code class="literal">503</code> - There was an error in the authentication back-end system
</li></ul></div><p><span class="emphasis"><em>Note</em></span>: If the authentication in the back-end system is simply denied (due to invalid credentials, for example), the value of the header will always be 401. 500 and 503 indicate real errors, such as technical problems, JVM errors etc.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_header_slserror"></a>38.3. Header "SLSError"</h2></div></div></div><p>This optional header is set by the SLS only if explicitely enabled in the SLS configuration. To enable it, set this property in "<code class="literal">sls.properties</code>":</p><pre class="programlisting">error.header=true</pre><p>If set, the header contains the last exception error message text (which is the message that is also logged to the "<code class="literal">exception.log</code>" in the stacktrace).</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_header_accessarea"></a>38.4. Header "AccessArea"</h2></div></div></div><p>This response header is processed by the HSP proxy. It is used by the SLS to either signal a successful authentication, or a logout to the HSP. The following values are allowed:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">Member</code> - The user has been authenticated on "Member" access level (usually used with weak authentication).
</li><li class="listitem">
<code class="literal">Customer</code> - The user has been authenticated on "Customer" access level (usually used with strong authentication).
</li><li class="listitem">
<code class="literal">Invalidate</code> - Terminate the session of the user for the current application (or, to be more accurate, the current authorized path).
</li><li class="listitem">
<code class="literal">InvalidateAll</code> - Terminate the entire SES session of the user (for all applications).
</li></ul></div><p><span class="emphasis"><em>Note: The "Member" and "Customer" values are accepted by the reverse proxy only if they are set in a response coming from a designated login location. So it is not possible for any application to just act as a login server by simply setting this response header.</em></span></p></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="x30434_Heading1Tarsec_Tools"></a>Chapter 39. Support Tools</h2></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_introduction_13"></a>39.1. Introduction</h2></div></div></div><p>The  delivery includes the following support tools:</p><p><span class="strong"><strong>JSP Compile Tool</strong></span></p><p>Allows to compile customized JSPs in a test directory. Useful if the JSPs are adapted and/or extended, for example with custom taglibs etc. By testing compilation with this tool, runtime compilation problems can be avoided.</p><p><span class="strong"><strong>SLS Seal (DataProtector replacement)</strong></span></p><p>Convenient commandline tool which allows to encrypt text values in the "<code class="literal">sls.properties</code>" file or the adapter configuration files. Useful to avoid having server passwords and similar sensitive values lying around in configuration files in plaintext.</p><p><span class="strong"><strong>SES Ticket API Tool</strong></span></p><p>Convenient commandline tool which allows to create key and index files to be used for SES tickets (RSA key pairs, 3DES encryption keys and samples of key index files), as well as SES tickets for testing and development purposes.</p><p><span class="strong"><strong>SLS Tool</strong></span></p><p>Convenient commandline tool which allows to do several things that would otherwise require a running SLS instance:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
Obtain metadata for the SAML 2.0 Identity Provider and Service Provider.
</li></ul></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_jsp_compile_tool"></a>39.2. JSP Compile Tool</h2></div></div></div><p>This tool allows to compile JSP files delivered by Login Service JSP developers before deploying them. The advantage of this approach is that any syntax errors and potentially also classpath configuration problems can be detected quickly, saving quite a lot of time.</p><p>Without this tool, any errors in the JSP files would be detected only once they are compiled by the Tomcat compiler the first that they are invoked by a user. It is also more cumbersome to search the reason for a compile problem in the Tomcat logfiles than to have it presented in a command line shell.</p><p>The directory structure of this tool in the delivery package is this:</p><pre class="screen">./tools/jspcompiler/
/compilejsp.sh
/work/
/lib/
/classes/
/webapp/</pre><p>To compile any JSP files, the JSP files must be copied into the "webapp" directory (not in any subdirectories!) and the compile script must be started:</p><pre class="screen">./compilejsp.sh</pre><p>It might be necessary to set the JAVA_HOME variable in the compile script to a valid path of a JDK installation. As long as no errors are displayed once the compilation has finished, the files are ok.</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_classpath_configuration"></a>39.2.1. Classpath Configuration</h3></div></div></div><p>If the JSPs are using any 3rd-party classes or libraries, it may be necessary to add those libraries or classes to the compile classpath. There are several possibilites to do so:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">
The variable "<code class="literal">CSLIB</code>" in the compile script can be changed to point to any additional class file directories or JAR files. This variable is included in the compile classpath.
</li><li class="listitem">
Single classfiles can be copied into the "<code class="literal">classes</code>" directory (with the correct package-subdirectory structure, of course).
</li><li class="listitem">
Any additional JAR files can be copied into the "<code class="literal">lib</code>" directory.
</li></ol></div><p>All JAR files in the "<code class="literal">lib</code>" directory and the "<code class="literal">classes</code>" directory are automatically added to the compile classpath.</p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="x33956_Heading2Tarsec_DataProtector"></a>39.3. SLS Seal (DataProtector replacement)</h2></div></div></div><p>SLS Seal is a commandline tool used to encrypt sensitive values in the SLS configuration files. The SLS will decrypt such values automatically, given that the correct keystore used for the encryption is configured accordingly.</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_security"></a>39.3.1. Security</h3></div></div></div><p>Simply put, SLS Seal is a tool for hiding sensitive values in configuration files. To do this, such values can be encrypted on the command line using the SLS Seal tool, and then the encrypted text string is entered in the configuration file. The SLS will then use the SLS Seal API at runtime to automatically decrypt the value again.</p><p>One requirement of this mechanism is that the SLS will not need any manual interaction for decryption (like entering a PIN code), since it must be possible to stop and restart the SLS service automatically in a production environment. This leads to the conclusion that, in the end, the key used for encryption must be available somewhere in the file system, and can therefore be stolen by anyone who knows how to use it. That person could then use the DataProtector with the key to decrypt and encrypted value again. So how does it improve security then?</p><p>The point is that in many large companies access to the production systems and the keystore files can be restricted through operating system mechanisms, such as file access rights. But quite often configurations are maintained in version control systems such as CVS, where often a large number of groups (also many developers) may have access to. In such situations it is useful to make sure that no production passwords are visible in those files.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_usage_2"></a>39.3.2. Usage</h3></div></div></div><p>The DataProtector can be found in the delivery archive's subdirectory "<code class="literal">tools/seal</code>". It can be started there directly by using the "<code class="literal">java -jar …</code>" command. See chapter <a class="link" href="#x56605_Heading2Tarsec_Prerequisites" title="2.2. Prerequisites">"Prerequisites"</a> for information about the Java version required for the command line client.</p><p>If the Jar file is executed without any parameters, it will print out all parameters available.</p><p><span class="emphasis"><em>Please read the README text file in the SLS Seal directory for up-to-date information about how to use the tool, and all possible options.</em></span></p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_creating_a_keystore"></a>39.3.3. Creating a Keystore</h3></div></div></div><p>First, a keystore file must be created before the DataProtector can be used. This file contains the seed for the symmetric encryption key. The key inside the file is usually protected with a password, which may also be host-specific (therefore restricting the use of the keystore file on a specific host system).</p><p>To create a keystore, run this command:</p><pre class="screen">java -Dfile.encoding=UTF-8 -jar sls-seal-&lt;version&gt;.jar create /path/to/keystore</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_enciphering_a_value"></a>39.3.4. Enciphering a Value</h3></div></div></div><p>To encipher a sensitive text string, run this command:</p><pre class="screen">java -Dfile.encoding=UTF-8 -jar sls-seal-&lt;version&gt;.jar encipher /path/to/keystore &lt;plaintext&gt;</pre><p>Enciphers the given <code class="literal"><span class="emphasis"><em>&lt;plaintext&gt;</em></span></code> and prints the enciphered base64-string to the console (standard output). This value can then be copied into the configuration file.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_deciphering_a_value"></a>39.3.5. Deciphering a Value</h3></div></div></div><p>To decipher a sensitive text string, run this command:</p><pre class="screen">java -Dfile.encoding=UTF-8 -jar sls-seal-&lt;version&gt;.jar decipher /path/to/keystore &lt;ciphertext&gt;</pre><p>Deciphers the given <code class="literal"><span class="emphasis"><em>&lt;ciphertext&gt;</em></span></code> and prints the deciphered string to the console (standard output).</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="x85318_Heading3Tarsec_SLS_Keystore_Configuration"></a>39.3.6. SLS Keystore Configuration</h3></div></div></div><p>To configure the SLS to use a keystore to decrypt any encrypted values, the following property in "<code class="literal">sls.properties</code>" must define the path of the keystore file:</p><p><span class="strong"><strong><code class="literal">dataprotector.keystore</code></strong></span></p><p>Path of a keystore file, either absolute or relative to the SLS subdirectory "WEB-INF".</p><p>Example:</p><pre class="programlisting">dataprotector.keystore=sls-dataprotector.keystore</pre></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="x97591_Heading2Tarsec_SES_Ticket_API_Tool"></a>39.4. SES Ticket API Tool</h2></div></div></div><p>The SES Ticket API Tool is a commandline tool that allows to create the keys required to create signed and encrypted SES tickets in the SLS, or verify and decrypt them in an application server (using the J2EE filter, for example - see <a class="link" href="#x53260_Heading1Tarsec_SSO_Integration" title="Chapter 23. SSO Integration">"SSO Integration"</a>).</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_usage_3"></a>39.4.1. Usage</h3></div></div></div><p>The SES Ticket API Tool can be found in the delivery archive's subdirectory "<code class="literal">tools/ses-ticket-api</code>". It can be started there directly using the "<code class="literal">java -jar …</code>" command. See chapter <a class="link" href="#x56605_Heading2Tarsec_Prerequisites" title="2.2. Prerequisites">"Prerequisites"</a> for information about the Java version required for the command line client.</p><p>If the Jar file is executed without any parameters, it will print out all parameters available.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_defining_the_target_directory_path"></a>39.4.2. Defining the target directory path</h3></div></div></div><p>For all operations, the argument <code class="literal">-path+<span class="emphasis"><em>&lt;directory&gt;</em></span></code> can be used to define a target directory where the files (index or keys) are created. If that directory does not exist yet, it will be created.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_defining_a_prefix"></a>39.4.3. Defining a prefix</h3></div></div></div><p>For all file creation operations, the argument <code class="literal">-prefix</code> <code class="literal"><span class="emphasis"><em>&lt;prefix&gt;</em></span></code> can be used to define a prefix for the resulting filenames. If all files are created together using the <code class="literal">-all</code> option (see <a class="link" href="#x13643_Heading3Tarsec_Creating_all_files_at_once" title="39.4.7. Creating all files at once">"Creating all files at once"</a>), the resulting filenames will have the given prefix, and the entries in the index file will correspond to them.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_creating_a_sample_key_index_file"></a>39.4.4. Creating A Sample Key Index File</h3></div></div></div><p>In order to use a set of keys to create SES tickets, an index file must be created as well. While this is basically just a simple text file that could easily be created by hand, the commandline tool can create one that can be used as a sample.</p><p>To create a key index file in the current directory, run this command:</p><pre class="screen">java -jar usp-ses-ticket-tool-1.0.0.jar -create -index</pre><p>To create a key index file in the directory "<code class="literal">/tmp/keys</code>", run this command:</p><pre class="screen">java -jar usp-ses-ticket-tool-1.0.0.jar -create -index -path /tmp/keys</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_creating_an_rsa_key_pair"></a>39.4.5. Creating an RSA key pair</h3></div></div></div><p>Creating an SES ticket requires an RSA private key which is used to sign the ticket. The corresponding public key must be provided to the application server which uses some kind of SSO filter to verify the ticket.</p><p>To create an RSA key pair in the current directory, run this command:</p><pre class="screen">java -jar usp-ses-ticket-tool-1.0.0.jar -create rsa</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_creating_a_3des_encryption_key"></a>39.4.6. Creating a 3DES encryption key</h3></div></div></div><p>SES tickets can optionally be encrypted with a symmetric 3DES key. This key must then also be provided to the application server which uses some kind of SSO filter to decrypt the ticket.</p><p>To create a 3DES key in the current directory, run this command:</p><pre class="screen">java -jar usp-ses-ticket-tool-1.0.0.jar -create 3des</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="x13643_Heading3Tarsec_Creating_all_files_at_once"></a>39.4.7. Creating all files at once</h3></div></div></div><p>There is also a shortcut to create all keys (RSA and 3DES) in one go:</p><pre class="screen">java -jar usp-ses-ticket-tool-1.0.0.jar -create -keyset</pre><p>And the following command creates all keys and a corresponding key index file:</p><pre class="screen">java -jar usp-ses-ticket-tool-1.0.0.jar -create all</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_creating_ses_tickets"></a>39.4.8. Creating SES Tickets</h3></div></div></div><p>This tool also allow to create SES tickets that can be used for testing or development purposes. The following parameters are available for use to create a ticket:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">-user</code> - The username in the ticket.
</li><li class="listitem">
<code class="literal">-realm</code> - The realm in the ticket.
</li><li class="listitem">
<code class="literal">-indexfile</code> - The path of the key index file which defines the path of each key file.
</li><li class="listitem">
<code class="literal">-privkey</code> - The alias of the private key used to sign the ticket.
</li><li class="listitem">
<code class="literal">-pubkey</code> - The alias of the public key required to verify the ticket.
</li><li class="listitem">
<code class="literal">-enckey</code> - Optional: The alias of the encryption key required to encrypt the payload or the entire ticket.
</li><li class="listitem">
<code class="literal">-lifespan</code> - Optional: The lifetime of the ticket in seconds (default is 300)
</li><li class="listitem">
<code class="literal">-encrypt</code> - Defines if only the payload (default) or the entire ticket (set to value "<code class="literal">ticket</code>") should be encrypted, if an encryption key was set. The SES ticket consists of a header part which contains the user ID and the realm, and all the optional attributes (the payload). The header part is usually plain text, and only attribute values are encrypted. If the entire ticket should be encrypted including the header, use the argument "<code class="literal">-encrypt ticket</code>".
</li><li class="listitem">
<code class="literal">-ticketfile</code> - Optional: Path of a text file where the ticket string will be stored. The ticket will always also be printed to the standard output console.
</li></ul></div><p>Example for creating an unencrypted ticket with a lifespan of only 10 seconds:</p><pre class="screen">java -jar usp-ses-ticket-tool-1.1.0.jar -create ticket -indexfile test.keyindex -privkey test_priv -pubkey test_pub -lifespan 10</pre><p>Example for creating a completely encrypted ticket with some payload attributes:</p><pre class="screen">java -jar usp-ses-ticket-tool-1.1.0.jar -create ticket -indexfile test.keyindex -privkey test_priv -pubkey test_pub -enckey test_enc -encrypt ticket -payload some=thing,here=there</pre></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="x23363_Heading2Tarsec_SLS_Tool"></a>39.5. SLS Tool</h2></div></div></div><p>This tool bundles practically all code of the SLS in a single JAR file and makes
some SLS functionality available via command line that otherwise would require
to install, configure and start an SLS instance.</p><p>To show general command line options, run this command:</p><pre class="screen">java -jar sls-tool-fat-&lt;version&gt;.jar -help</pre><p>To show command line options for a specific component (components were listed in
the command above):</p><pre class="screen">java -jar sls-tool-fat-&lt;version&gt;.jar -help &lt;component&gt;</pre><p>To show the version of the tool:</p><pre class="screen">java -jar sls-tool-fat-&lt;version&gt;.jar -version</pre><p>Otherwise, the general syntax for using the SLS tool is as follows:</p><pre class="screen">java -jar sls-tool-fat-&lt;version&gt;.jar &lt;component&gt; &lt;method&gt; {&lt;option&gt;}</pre><p>Component and method must be the first two arguments. The following sequence of
options can then be in any order and can contain both general options that work
for all components and methods and specific options.</p><p><span class="strong"><strong>NOTE</strong></span>: On Linux the SLS Tool may hang during execution due to lack of true
randomness available on the system. If this happens, start the SLS Tool
like this (note that the dot in the path is not a typo but necessary):</p><pre class="screen">java -Djava.security.egd=file:/dev/./urandom -jar sls-tool-fat-&lt;version&gt;.jar ...</pre><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_general_options"></a>39.5.1. General options</h3></div></div></div><p><span class="strong"><strong><code class="literal">-verbose</code></strong></span></p><p>Shows debug output. Equivalent to "-loglevel debug". Default is off (log level info).</p><p><span class="strong"><strong><code class="literal">-loglevel &lt;level&gt;</code></strong></span></p><p>Sets log level. Any log4j log level can be indicated (trace, debug, info, warn, error, …). Default log level is info.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_get_identity_provider_metadata_idp_getmetadata"></a>39.5.2. Get Identity Provider metadata (idp getMetadata)</h3></div></div></div><pre class="screen">java -jar sls-tool-fat-&lt;ver&gt;.jar *idp getMetadata* {&lt;option&gt;}</pre><p>This function allows to get SAML 2.0 Identity Provider (IdP) metadata.</p><p><span class="strong"><strong><code class="literal">-webapp &lt;dir&gt;</code></strong></span></p><p>A directory that contains at least minimal IdP configuration in its WEB-INF
subdirectory. Typically, an idp-adapter.properties file with minimal entries
plus the IdP keystore are sufficient, see example further below. This argument
is mandatory.</p><p><span class="strong"><strong><code class="literal">-keypairalias &lt;alias&gt;</code></strong></span></p><p>Key pair alias used to obtain the certificate from the key store. If this option
is not specified the global key pair alias in property
<code class="literal">idp.keystore.keypair.alias</code> is used as the key pair alias instead. Optional.</p><p><span class="strong"><strong><code class="literal">-variables &lt;name1&gt;=&lt;value1&gt;,&lt;name2&gt;=&lt;value2&gt;</code></strong></span></p><p>Optional script (JEXL/Groovy) variables to set.
Needed e.g. if the host is parametrized in EntityID and endpoint URLs:
<code class="literal">-variables header.host=acme.com</code>.
Separate multiple name/value pairs with commas.</p><p><span class="strong"><strong><code class="literal">-out &lt;file&gt;</code></strong></span></p><p>File to write metadata to. Optional, if not present, metadata is printed out to
console.</p><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="_example_6"></a>Example</h4></div></div></div><pre class="screen">java -jar sls-tool-fat-&lt;ver&gt;.jar idp getMetadata -webapp /some/path -out /some/other/path/metadata.xml</pre><p>Directory structure and files:</p><pre class="screen">/some/path/WEB_INF/
idp/idp.jks
idp-adapter.properties</pre><p>Sample idp-adapter properties (note the that the path to the IdP keystore is
indicated relative to the webapp):</p><pre class="programlisting">idp.entity.id=https://sestest2.tetrade.ch/idp/sls
idp.keystore.file=WEB-INF/idp/idp.jks
idp.keystore.keypair.alias=idp
idp.keystore.pass=changeit
idp.keystore.type=JKS
idp.sso.redirect.url=https://sestest2.tetrade.ch/ite/idp/sls/auth
idp.slo.redirect.url=https://sestest2.tetrade.ch/ite/idp/sls/auth</pre></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_get_service_provider_metadata_sp_getmetadata"></a>39.5.3. Get Service Provider metadata (sp getMetadata)</h3></div></div></div><pre class="screen">java -jar sls-tool-fat-&lt;ver&gt;.jar *sp getMetadata* {&lt;option&gt;}</pre><p>This function allows to get SAML 2.0 Service Provider (SP) metadata.</p><p><span class="strong"><strong><code class="literal">-webapp &lt;dir&gt;</code></strong></span></p><p>A directory that contains at least minimal SP configuration in its WEB-INF
subdirectory. Typically, an sp-adapter.properties file with minimal entries
plus the SP keystore are sufficient. This argument is mandatory.</p><p><span class="strong"><strong><code class="literal">-keypairalias &lt;alias&gt;</code></strong></span></p><p>Key pair alias used to obtain the certificate from the key store. If this option
is not specified the global key pair alias in property
<code class="literal">sp.keystore.keypair.alias</code> is used as the key pair alias instead. Optional.</p><p><span class="strong"><strong><code class="literal">-variables &lt;name1&gt;=&lt;value1&gt;,&lt;name2&gt;=&lt;value2&gt;</code></strong></span></p><p>Optional script (JEXL/Groovy) variables to set.
Needed e.g. if the host is parametrized in EntityID and endpoint URLs:
<code class="literal">-variables header.host=acme.com</code>.
Separate multiple name/value pairs with commas.</p><p><span class="strong"><strong><code class="literal">-out &lt;file&gt;</code></strong></span></p><p>File to write metadata to. Optional, if not present, metadata is printed out to
console.</p><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="_example_7"></a>Example</h4></div></div></div><pre class="screen">java -jar sls-tool-fat-&lt;ver&gt;.jar sp getMetadata -webapp /some/path -out /some/other/path/metadata.xml</pre><p>Directory structure and files:</p><pre class="screen">/some/path/WEB_INF/
sp/sp.jks
sp-adapter.properties</pre></div></div></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="x34533_Heading1Tarsec_SLS_Modules"></a>Chapter 40. SLS Modules</h2></div></div></div><p>The functionality of the SLS is defined by a number of modules. At startup time, the SLS detects which modules are in use and logs this information to the "sls.log" file on INFO level.</p><p>Additionally, it is also possible to configure the path of a property file that is generated by the SLS and contains the list of all used modules. The location of the file is configured through one property in the "<code class="literal">sls.properties</code>" file:</p><p><span class="strong"><strong><code class="literal">modules.usage.file</code></strong></span></p><p>Must contain the path of the file (not only the directory path, but also the name of the file itself). The path can be specified as an absolute directory path, or relative (to the SLS "<code class="literal">WEB-INF</code>" directory).</p><div class="note" style="margin-left: 0; margin-right: 10%;"><h3 class="title">Note</h3><p>The SLS process must have write permission for the given file and directory, or this functionality will cause problems at runtime!</p></div><p>Example:</p><pre class="programlisting">modules.usage.file=/var/logs/sls/modules-usage.properties</pre><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_modules_file_content"></a>40.1. Modules File Content</h2></div></div></div><p>The generated file contains properties with information about the modules that are in active use in the SLS instance. A sample file might look like this:</p><pre class="programlisting">#SLS Module Usage
#Thu Oct 28 19:10:27 CEST 2010
module.0.title=Basic
module.0.reason.1=Property "adapter.*" is set.
module.0.reason.0=Property "sls.title" is set.
module.1.title=HTTP
module.1.reason.0=Property "adapter.class.http" contains value: http
module.2.title=USP SSO
module.2.reason.0=Property "app.header.plainuser" contains value: function.getVerifiedCred</pre><p>Each module is described by a group of properties with the prefix "<code class="literal">module.</code>" followed by the same number. The property with the name suffix "<code class="literal">title</code>" shows the name of the module (see list below), and the other properties describe the reasons why this module was deemed to be used by the SLS instance.</p><p><span class="emphasis"><em>Note: The properties in this example have been sorted for the sake of better readability. Java property files are not sorted alphabetically, so the properties in the generated file will appear in random order.</em></span></p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_list_of_sls_modules"></a>40.2. List Of SLS Modules</h2></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_login_service_modules"></a>40.2.1. Login Service Modules</h3></div></div></div><p>The following SLS modules exist:</p><p><span class="strong"><strong>Base</strong></span></p><p>Contains all the core SLS functionality and supports login credential gathering through HTML forms (JSPs) or "Basic Authentication" between the SLS and the browser client. Also  includes the LDAP adapter, allowing for password verification and / or user information retrieval, and support for "Basic-Auth"-SSO-integration with application servers.</p><p><span class="strong"><strong>SSO</strong></span></p><p>Provides Single-Sign-On functionality between multiple web applications through propagation of custom HTTP headers that can be verified by the various application server filters (J2EE, etc.). It is possible to use either simple HTTP headers with custom key-/value pairs, protected through a signature only, or SES tickets (see <a class="link" href="#x66021_Heading1Tarsec_SES_Login_Ticket" title="Chapter 30. SES Login Ticket">"SES Login Ticket"</a> for details).</p><p><span class="strong"><strong>Certificate</strong></span></p><p>Provides certificate-based authentication. This is basically SSL mutual authentication, in which case the certificate can either be stored in the client web browser, or in a hardware token. In addition, the SLS can trigger an SSL re-negotiation on an existing anonymous SSL connection to start the mutual authentication later (and not right when the browser connects to the site).</p><p>The client certificate can be verified against one or multiple Certificate Authorities (CAs). Certificate Revocation Lists (CRLs) and Online Certificate Status Protocol (OCSP) are also supported. Finally, the user CN can be mapped in a flexible way to any custom user ID required by the application.</p><p><span class="strong"><strong>HTTP</strong></span></p><p>Allows to use any HTTP-based service to verify the user credential through simple HTTP requests and responses. The HTTP adapter also allows to perform custom HTTP callouts during the login process.</p><p><span class="strong"><strong>Kerberos</strong></span></p><p>Provides transparent, automatic Single-Sign-On (SSO) through Kerberos over HTTP (SPNEGO). The SLS processes the Kerberos Token sent by the browser client and verifies them either through a KDC or the configured keystore.</p><p><span class="strong"><strong>Nevis</strong></span></p><p>Allows to implement Single-Sign-On (SSO) with applications based on the Nevis framework through creation of a Nevis token.</p><p><span class="strong"><strong>NTLM</strong></span></p><p>Provides transparent, automatic Single-Sign-on (SSO) through NTLM. The verification of the credentials sent by the client browser is delegated to a Microsoft Windows Domain Controller.</p><p><span class="strong"><strong>RADIUS</strong></span></p><p>Allows to verify the user credentials through any existing RADIUS authentication service.</p><p><span class="strong"><strong>SAML IDP</strong></span></p><p>Provides Single-Sign-On (SSO) with an SAP application server through a SAML 1.1 identity provider.</p><p><span class="strong"><strong>SAML SP</strong></span></p><p>Processes authentication credentials from a SAML request. The SLS extracts the user credential information from the SAML message and performs the actual authentication in any way (using mechanisms like LDAP or RADIUS, for example).</p><p><span class="strong"><strong>SecurID</strong></span></p><p>Provides strong two-factor authentication with RSA SecurID tokens (up to RSA server 6.x).</p><p><span class="strong"><strong>SOAP Backend</strong></span></p><p>Allows to delegate the user credential verification to any HTTP SOAP back-end service.</p><p><span class="strong"><strong>SOAP Frontend</strong></span></p><p>Allows HTTP SOAP clients to perform authentication on the SLS through a SOAP interface.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_application_server_modules"></a>40.2.2. Application Server Modules</h3></div></div></div><p>The following modules contain functionality which is not implemented within the SLS, but relates to it, such as ticket verification filters for application servers:</p><p><span class="strong"><strong>NTLM Propagation</strong></span></p><p>Allows to propagate the user credentials to the HSP reverse proxy, which can then perform NTLM authentication against applications servers like a browser client.</p><p><span class="strong"><strong>Tomcat Authenticator</strong></span></p><p>Provides Single-Sign-On (SSO) for all applications within one Tomcat instance through a Tomcat Authenticator module. The eliminates the need to configure a J2EE filter in every application deployed in that Tomcat server.</p></div></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="x50805_Heading1Tarsec_SSL_JSSE"></a>Chapter 41. TLS/SSL (JSSE)</h2></div></div></div><p>A number of adapters support TLS/SSL based protocols, such as HTTPS or LDAPS. Usually, using these SSL protocols requires correct configuration of JSSE (Sun's default SSL implementation in the Java Runtime). This chapter describes how to configure and debug SSL.</p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_jsse_information"></a>41.1. JSSE Information</h2></div></div></div><p>In general, in-depth information about JSSE can be found on Sun’s Java documentation pages:</p><p><a class="ulink" href="https://docs.oracle.com/javase/8/docs/technotes/guides/security/jsse/JSSERefGuide.html" target="_top">https://docs.oracle.com/javase/8/docs/technotes/guides/security/jsse/JSSERefGuide.html</a></p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_login_service_as_ssl_client"></a>41.2. Login Service as SSL client</h2></div></div></div><p>Usually the SLS is the client in an SSL connection. For example if LDAPS is used in the LDAP adapter to perform an authentication or a user lookup during a login process.</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_importing_ssl_server_ca_certificate"></a>41.2.1. Importing SSL Server CA Certificate</h3></div></div></div><p>During an SSL handshake between the SLS and some SSL server, the server sends his certificate. The SSL implementation in the Java VM of the SLS will then try to verify that certificate, using its local store of known Certificate Authorities (CAs). By default, this CA store is a Java keystore file at this location:</p><pre class="screen">$JAVA_HOME/jre/lib/security/cacerts</pre><p>To import a CA certificate in a file "<code class="literal">customca.cer</code>" in DER encoded format, the Java "<code class="literal">keytool</code>" utility can be used:</p><pre class="screen">keytool -import -file customca.cer -trustcacerts -keystore $JAVA_HOME/jre/lib/security/cacerts</pre></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_client_mutual_authentication_setup"></a>41.3. Client (Mutual) Authentication Setup</h2></div></div></div><p>If the SSL connection between an SLS and some SSL server requires that the login service provides a client certificate, it must be configured in a separate keystore.</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_pkcs12_keystore_for_client_authentication"></a>41.3.1. pkcs12 keystore for client authentication</h3></div></div></div><p>It is possible to import PKCS12 certificates in the Java keystore, but there are some issues with importing PKCS12 files:</p><p>Generally it doesn't work with PKCS12 certificates exported from Microsoft IE. It is strongly recommended to export it from a Netscape based browser, such as Firefox. Otherwise JSSE won't be able to read the PKCS12 certificate correctly, and as a result there might occur an SSLException with the description "too Big".</p><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="_openssl_issues"></a>OpenSSL issues</h4></div></div></div><p>If you want to export a key from openssl it won't work when you just export it with the command:</p><pre class="screen">&gt; openssl pkcs12</pre><p>You have to re-encode the Java-Base64-encoded private key with the following command:</p><pre class="screen">&gt; openssl rsa -in private.key -out newprivate.key</pre><p>Thereafter, the re-encoded private key and the corresponding certificate can be converted to the PKCS12 format like this:</p><pre class="screen">&gt; openssl pkcs12 -export -out keystore.p12 -inkey newprivate.key -in cert.pem.crt</pre></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_configuring_pkcs12_client_certificate"></a>41.3.2. Configuring PKCS12 Client Certificate</h3></div></div></div><p>The resulting keystore "<code class="literal">keystore.p12</code>" can then be used by setting the following two system properties:</p><pre class="screen">-Djavax.net.ssl.keyStoreType=PKCS12
-Djavax.net.ssl.keyStorePassword=&lt;keystore password&gt;</pre><p>One place to set them is the "<code class="literal">bin/setenv.\*</code>" script in the SLS Tomcat instance:</p><pre class="screen">JAVA_OPTS="-Djavax.net...=... -Djavax.net..."</pre></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_debugging_ssl_jsse"></a>41.4. Debugging SSL / JSSE</h2></div></div></div><p>It is possible to enable some SSL debut output that will be printed to the standard output console (usually the "catalina.out" file in a Tomcat instance) through settings some system properties. The official documentation for this can be found here:</p><p><a class="ulink" href="http://java.sun.com/j2se/1.5.0/docs/guide/security/jsse/JSSERefGuide.html#Debug" target="_top">http://java.sun.com/j2se/1.5.0/docs/guide/security/jsse/JSSERefGuide.html#Debug</a></p><p>System properties can be set for an SLS by defining them in the <code class="literal">JAVA_OPTS</code> variable in the "<code class="literal">bin/setenv.*</code>" script of the Tomcat instance. For example:</p><pre class="screen">JAVA_OPTS=-Djavax.net.debug=ssl</pre><p>will enable debug output for all SSL operations. But since problems usually arise during the handshake, it can be restricted to that:</p><pre class="screen">JAVA_OPTS=-Djavax.net.debug=ssl:handshake</pre><p>The output shows which keystore files are actually used, the certificate chain received from the SSL server etc.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_tlsv1_3"></a>41.5. TLSv1.3</h2></div></div></div><p>TLSv1.3 requires Java 8u261 or later.</p><p>So far, it is experimentally necessary to set the system property
<code class="literal">jdk.tls.client.protocols</code> at startup of the JVM to a string that contains
<code class="literal">TLSv1.3</code>, for example:</p><pre class="screen">... -Djdk.tls.client.protocols=TLSv1.3,TLSv1.2 ...</pre><p>Note that setting the property in a JVM that has already started, like in an SLS
login model has no effect.</p><p>In the HTTP Adapter you additionally need to allow the protocol, as usual,
in the SLS config property <code class="literal">http.tls.versions</code>.</p><p>In other words, in order to use Protocol X with the HTTP (or WS) adapter, X
has  both to be contained in <code class="literal">http.tls.versions</code> and be allowed by the JDK,
either  implicitly or explicitly by setting <code class="literal">jdk.tls.client.protocols</code>.</p><p>Other callouts from the SLS should in principle automatically use TLSv1.3
(if allowed with the above system property) if the server on the other side
also allows and prefers it. There are so far no dedicated settings for these
other callouts (e.g. LDAP Adapter uses JNDI of the JDK).</p><p>TLSv1.3 in SLS front as server requires Tomcat 8.5.</p><p>No extra settings are necessary, optionally e.g. accepted protocols can be
limited in <code class="literal">server.xml</code> in the <code class="literal">Connector</code> tag  in the <code class="literal">sslEnabledProtocols</code>
attribute.</p></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="x34533_Heading1Tarsec_HTTP_Methods"></a>Chapter 42. HTTP Methods</h2></div></div></div><p>The SLS provides limited support for HTTP methods other than GET, HEAD, POST and OPTIONS.</p><p>Such methods might for example be used by rich clients to access REST webservices.</p><p>The methods GET, HEAD and POST are the ones that JSPs are guaranteed to support
and since Tomcat 8 those are the only ones supported by Tomcat.</p><p>The SLS can internally map other methods configuratively to GET or POST
and configure to some degree how to handle them.</p><p>Side remark: Note that the HSP must be configured to allow other methods to propagate to the SLS
(and after authentication to applications), using the directives <code class="literal">RF_ServerAllowMethod</code>
and/or <code class="literal">RF_LocationAllowMethod</code>.</p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_get_head_and_post"></a>42.1. GET, HEAD and POST</h2></div></div></div><p>HEAD is handled like GET in the SLS.</p><p>The main difference between GET and POST is that after a POST the SLS
automatically advances to the next step in the login model.</p><p>Moreover, after each POST the SLS redirects to itself ("302 Redirect")
to prevent replay attacks from a user reposting a form from an open
web browser.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_options"></a>42.2. OPTIONS</h2></div></div></div><p>OPTIONS requests are handled like GET requests, except that an additional
response header "Allow" is added with a configurable header value.</p><p>The header value is configured with the property <code class="literal">http.method.options.allow</code>.
The property value is a comma-separated list of HTTP methods (note that HTTP methods
are case-sensitive); the default value is "GET,HEAD,POST". Example:</p><pre class="programlisting">http.method.options.allow=GET,HEAD,POST,PUT,DELETE</pre></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_other_methods"></a>42.3. Other Methods</h2></div></div></div><p>Other methods are mapped either to GET or to POST.
In the case of GET, handling is as for a GET request,
for POST, too, except that there is no redirect to itself
afterwards, because neither would a replay usually be
possible from a browser, nor would the client necessarily
be able to handle a "302 Redirect".</p><p>By default unknown methods are mapped to POST and treated
as described above, but this can be configured.</p><p>The default can be set to one of three modes:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
advance (the default): Map to POST, adavance in model
</li><li class="listitem">
stay: Map to GET, do not advance in model
</li><li class="listitem">
error: Respond with an error, typically with a "405 Method not allowed".
</li></ul></div><p>Example:</p><pre class="programlisting">http.method.handle.defaultmode=error</pre><p>Methods can be specifically indicated for each of these threee modes
with comma-separated lists of HTTP methods.</p><p>Example:</p><pre class="programlisting">http.method.handle.advance=PUT
http.method.handle.stay=DELETE
http.method.handle.error=ACME, ROADRUNNER</pre><p>Defaults are empty.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_handling_http_request_body"></a>42.4. Handling HTTP Request Body</h2></div></div></div><p>Currently, the SLS provides only limited support for handling
an HTTP request body.</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_post_body"></a>42.4.1. POST Body</h3></div></div></div><p>In the case of a POST — an incoming POST, not another method mapped
internally to a POST for processing in the SLS — the body is normally
parsed as request parameters which are made available as JEXL
variables.</p><p>In case of e.g. a JSON body, the body typically ends up as the
<span class="emphasis"><em>name</em></span> of a request parameter with empty value. This parameter
can be accessed e.g. with Groovy by first getting the current
<code class="literal">HttpServletRequest</code> with the JEXL/Groovy function
<code class="literal">function.getCurrentRequest()</code> and then calling e.g.
<code class="literal">request.getParameterNames()</code> and searching for the JSON body in all
parameter names. JSON or XML can then be parsed in Groovy using a
<code class="literal">groovy.json.JsonSlurper</code> resp. a <code class="literal">groovy.util.XmlSlurper</code>
and elements can be conveniently accessed using "." as accessor.</p><p>Example:</p><pre class="screen">def request = function.getCurrentRequest()
def names = request.getParameterNames()
def body
names.each { name -&gt;
  if (&lt;some-condition&gt;) {
    body = name
  }
}
def slurper = new groovy.json.JsonSlurper()
def json = slurper.parseText(body)
def userid = json.auth.user.userid</pre></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_body_for_other_methods"></a>42.5. Body for other Methods</h2></div></div></div><p>For other methods, the body is typically not explicitly consumed
by the SLS. When needed, it can be read in a Groovy script by first
getting the <code class="literal">HttpServletRequest</code> as above and then consuming
a reader or input stream.</p><p>Example:</p><pre class="screen">def request = function.getCurrentRequest()
// short for request.getReader().getText()
def body = request.reader.text</pre></div></div></div><div class="part"><div class="titlepage"><div><div><h1 class="title"><a id="x10006_Heading1Tarsec_SOAP"></a>Part II. SOAP</h1></div></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="_overview_10"></a>Chapter 43. Overview</h2></div></div></div><p>There are two areas regarding the SLS where SOAP is involved:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
Sending SOAP requests from the SLS to an existing back-end web service, to perform an authentication, user data lookup etc. This is explained in the following paragraphs.
</li><li class="listitem">
Receiving and processing SOAP requests through the SOAP frontend. This is explained in more detail in the "Frontend" part of this documentation (see <a class="link" href="#x51351_Heading1Tarsec_SOAP_Frontend" title="Chapter 64. SOAP Frontend">"SOAP Frontend"</a> for details).
</li></ul></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_sending_soap_requests_to_a_web_service"></a>43.1. Sending SOAP Requests to a web service</h2></div></div></div><p>The SLS does not feature an actual SOAP adapter of any kind. Instead, for sending SOAP requests to web services and processing their SOAP responses, the following technologies are used:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
Using the USP "<code class="literal">wsdl-tool</code>" commandline utility, the WSDL file from the web service can be processed, and request-XML can be created for each operation defined in the WSDL.
</li><li class="listitem">
That XML request data can be copied into a JEXL template file (see <a class="link" href="#x12304_Heading3Tarsec_Templates" title="32.8.2. Templates">"Templates"</a>). The variable values in it can be replaced with the appropriate JEXL variables or functions.
</li><li class="listitem">
The HTTP adapter (see <a class="link" href="#x12089_Heading1Tarsec_HTTP_Adapter" title="Chapter 48. HTTP Adapter">"HTTP Adapter"</a>) can then be configured to use the content of that template file as the body of a POST request, using the JEXL function "<code class="literal">function.getTemplateContent()</code>".
</li><li class="listitem">
The SOAP response recieved from the web service is made available by the HTTP adapter in the JEXL variable "response.content".
</li><li class="listitem">
Using the various JEXL XPath functions, such as "<code class="literal">function.xPathGetString()</code>", the XML response can be parsed and handled dynamically in the SLS model.
</li></ul></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_known_limitations"></a>43.1.1. Known Limitations</h3></div></div></div><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
No support for WSDL 2.0
</li><li class="listitem">
No support for WSS (Web Service Security), like encrypted / signed SOAP messages etc.
</li></ul></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_sending_soap_step_by_step"></a>43.2. Sending SOAP, Step by Step</h2></div></div></div><p>This chapter gives a complete example of how to set up sending a SOAP request to a webservice. For the sake of this example, the following WSDL is used, which defines a login operation. That operation authenticates a user by verifying the username and password:</p><p><span class="strong"><strong><span class="emphasis"><em>Example WSDL file "login.wsdl"</em></span></strong></span></p><pre class="screen">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;wsdl:definitions targetNamespace="urn:ILogin"
xmlns:apachesoap="http://xml.apache.org/xml-soap"
xmlns:impl="urn:ILogin"
xmlns:intf="urn:ILogin"
xmlns:soapenc="http://schemas.xmlsoap.org/soap/encoding/"
xmlns:wsdl="http://schemas.xmlsoap.org/wsdl/"
xmlns:wsdlsoap="http://schemas.xmlsoap.org/wsdl/soap/"
xmlns:xsd="http://www.w3.org/2001/XMLSchema"&gt;

&lt;wsdl:message name="loginResponse"&gt;
&lt;wsdl:part name="loginReturn" type="xsd:boolean" /&gt;
&lt;/wsdl:message&gt;

&lt;wsdl:message name="loginRequest"&gt;
&lt;wsdl:part name="in0" type="soapenc:string" /&gt;
&lt;wsdl:part name="in1" type="soapenc:string" /&gt;
&lt;/wsdl:message&gt;

&lt;wsdl:portType name="ILogin"&gt;
&lt;wsdl:operation name="login" parameterOrder="in0 in1"&gt;
&lt;wsdl:input message="impl:loginRequest" name="loginRequest" /&gt;
&lt;wsdl:output message="impl:loginResponse" name="loginResponse" /&gt;
&lt;/wsdl:operation&gt;
&lt;/wsdl:portType&gt;

&lt;wsdl:binding name="LoginSoapBinding" type="impl:ILogin"&gt;
&lt;wsdlsoap:binding style="rpc"
transport="http://schemas.xmlsoap.org/soap/http" /&gt;

&lt;wsdl:operation name="login"&gt;
&lt;wsdlsoap:operation soapAction="/axis/services/Login" /&gt;
&lt;wsdl:input name="loginRequest"&gt;
&lt;wsdlsoap:body encodingStyle="http://schemas.xmlsoap.org/soap/encoding/"
namespace="urn:ILogin" use="encoded" /&gt;
&lt;/wsdl:input&gt;
&lt;wsdl:output name="loginResponse"&gt;
&lt;wsdlsoap:body encodingStyle="http://schemas.xmlsoap.org/soap/encoding/"
namespace="urn:ILogin" use="encoded" /&gt;
&lt;/wsdl:output&gt;
&lt;/wsdl:operation&gt;

&lt;/wsdl:binding&gt;

&lt;wsdl:service name="ILoginService"&gt;
&lt;wsdl:port binding="impl:LoginSoapBinding" name="Login"&gt;
&lt;wsdlsoap:address location="http://soap.acme.com/services/Login" /&gt;
&lt;/wsdl:port&gt;
&lt;/wsdl:service&gt;

&lt;/wsdl:definitions&gt;</pre><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_run_the_wsdl_tool"></a>43.2.1. Run the "wsdl-tool"</h3></div></div></div><p>Then run the USP "wsdl-tool" (to be found in the "tools" folder in the SLS delivery image) with that WSDL file:</p><pre class="screen">%&gt; java -jar usp-wsdl-tool-&lt;version&gt;.jar login.wsdl</pre><p>which will result in the following output:</p><pre class="screen">Progress: 1 - Caching Definition from url [file:/C:/devel/java/workspace/usp-wsdl-tool/target/login.wsdl]
Progress: 2 - Loading [file:/C:/devel/java/workspace/usp-wsdl-tool/target/login.wsdl]
Progress: 1 - Loading Definition from url
Retrieving document at 'file:/C:/devel/java/workspace/usp-wsdl-tool/target/login.wsdl'.

**** OPERATION: login:

&lt;soapenv:Envelope xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xmlns:xsd="http://www.w3.org/2001/XMLSchema"
        xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:urn="urn:ILogin"&gt;
&lt;soapenv:Header/&gt;
&lt;soapenv:Body&gt;
&lt;urn:login soapenv:encodingStyle="http://schemas.xmlsoap.org/soap/encoding/"&gt;
&lt;in0 xsi:type="soapenc:string"
xmlns:soapenc="http://schemas.xmlsoap.org/soap/encoding/"&gt;?&lt;/in0&gt;
&lt;in1 xsi:type="soapenc:string"
xmlns:soapenc="http://schemas.xmlsoap.org/soap/encoding/"&gt;?&lt;/in1&gt;
&lt;/urn:login&gt;
&lt;/soapenv:Body&gt;
&lt;/soapenv:Envelope&gt;

SOAPAction: /axis/services/Login</pre><p><span class="emphasis"><em>Note: The "<code class="literal">SOAPAction:</code>" value is only displayed if a SOAPAction was defined in the WSDL. Some web service containers need a HTTP request header named "<code class="literal">SOAPAction</code>" with that value in order to perform some internal dispatching - others don't.</em></span></p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_create_the_jexl_templates"></a>43.2.2. Create the JEXL templates</h3></div></div></div><p>Copy the XML structure (the entire "<code class="literal">&lt;soapenv:Envelope</code> .." tag) into a new file named "<code class="literal">login.xml</code>" in the SLS web application subdirectory "<code class="literal">WEB-INF/templates</code>":</p><pre class="screen">&lt;sls webapp&gt;/WEB-INF/templates/login.xml</pre><p>In the template, insert the JEXL variables for the username and password credential in the corresponding XML tags:</p><pre class="screen">&lt;soapenv:Envelope xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:urn="urn:ILogin"&gt;
&lt;soapenv:Header/&gt;
&lt;soapenv:Body&gt;
&lt;urn:login soapenv:encodingStyle="http://schemas.xmlsoap.org/soap/encoding/"&gt;
&lt;in0 xsi:type="soapenc:string"  +
               xmlns:soapenc="http://schemas.xmlsoap.org/soap/encoding/"&gt;${session.getCred('username')}&lt;/in0&gt;
&lt;in1 xsi:type="soapenc:string"
xmlns:soapenc="http://schemas.xmlsoap.org/soap/encoding/"&gt;${session.getCred('password')}&lt;/in1&gt;
&lt;/urn:login&gt;
&lt;/soapenv:Body&gt;
&lt;/soapenv:Envelope&gt;</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_configure_the_http_adapter"></a>43.2.3. Configure the HTTP adapter</h3></div></div></div><p>Set up the HTTP adapter to send the SOAP request by setting these properties in the "<code class="literal">http-adapter.properties</code>" file:</p><pre class="programlisting"># Configure template file with alias "soapbody" +
template.file.soapbody=login.xml

# Configure HTTP POST request
http.sendsoap.method=post
http.sendsoap.header.Content-Type=text/xml;charset=UTF-8
http.sendsoap.header.SOAPAction=/axis/services/Login
http.sendsoap.url=http://soap.acme.com/axis/services/Login
http.sendsoap.body=${function.getTemplateContent('soapbody')}
http.sendsoap.code.error=500,503
http.sendsoap.code.denied=401,403</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_send_the_soap_request"></a>43.2.4. Send the SOAP request</h3></div></div></div><p>To actually send the SOAP request, use the "<code class="literal">do.http</code>" model state:</p><pre class="programlisting">model.login.state.50.name=do.http
model.login.state.50.property=sendsoap</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_process_the_soap_response"></a>43.2.5. Process the SOAP response</h3></div></div></div><p>The SOAP response will look something like this:</p><pre class="screen">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:xsd="http://www.w3.org/2001/XMLSchema"
xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"&gt;
&lt;soapenv:Body&gt;
&lt;ns1:loginResponse soapenv:encodingStyle="http://schemas.xmlsoap.org/soap/encoding/" xmlns:ns1="urn:ILogin"&gt;
&lt;loginReturn xsi:type="xsd:boolean"&gt;false&lt;/loginReturn&gt;
&lt;/ns1:loginResponse&gt;
&lt;/soapenv:Body&gt;
&lt;/soapenv:Envelope&gt;</pre><p>In this example, the value "<code class="literal">false</code>" in the "loginReturn" tag means that the authentication failed.</p><p>Once the HTTP adapter receives the response, it is stored in the JEXL variable "<code class="literal">response.content</code>". Therefore, it can be evaluated using the XPath JEXL functions, e.g.</p><pre class="programlisting">model.login.state.60.name=do.generic
model.login.state.60.action.1=${function.failWithAuthenticationError('USER_AUTH_FAILED', 'User invalid')}
model.login.state.60.action.1.if=${function.xPathGetString(response.content, '//loginReturn') eq 'false'}</pre></div></div></div></div><div class="part"><div class="titlepage"><div><div><h1 class="title"><a id="_saml"></a>Part III. SAML</h1></div></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="_saml_2_identity_provider"></a>Chapter 44. SAML 2 Identity Provider</h2></div></div></div><p>The SAML 2.0 Identity Provider (IdP) is implemented as an SLS Adapter,
see <a class="link" href="#x10007_Heading1Tarsec_SAML_IdP_Adapter" title="Chapter 56. SAML IdP Adapter">"SAML IdP Adapter"</a>.</p></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="_saml_2_service_provider"></a>Chapter 45. SAML 2 Service Provider</h2></div></div></div><p>The SAML 2.0 Service Provider (SP) is implemented as an SLS Adapter,
see <a class="link" href="#x10008_Heading1Tarsec_SAML_SP_Adapter" title="Chapter 57. SAML SP Adapter">"SAML SP Adapter"</a>.
== SAML Global Settings</p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="x10000_Heading1Tarsec_SAML_XML_SigRefDigAlg"></a>45.1. XML Signature Reference Digest Algorithm</h2></div></div></div><p>The following configuration property allows to set the Digest Algorithm
in the Reference section of XML signatures (e.g. in SAML Assertions).</p><p><span class="strong"><strong><code class="literal">saml.securityConfiguration.signatureReferenceDigestMethod</code></strong></span></p><p>The default value is <code class="literal">http://www.w3.org/2001/04/xmlenc#sha256</code>.</p><p>Common values include:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">http://www.w3.org/2000/09/xmldsig#sha1</code>
  (cryptographically weak, should only be used where needed for compatibility with legacy systems)
</li><li class="listitem">
<code class="literal">http://www.w3.org/2001/04/xmlenc#sha256</code>
</li><li class="listitem">
<code class="literal">http://www.w3.org/2001/04/xmldsig-more#sha384</code>
</li><li class="listitem">
<code class="literal">http://www.w3.org/2001/04/xmlenc#sha512</code>
</li></ul></div><p>Example of an XML signature:</p><pre class="screen">&lt;ds:Signature xmlns:ds="http://www.w3.org/2000/09/xmldsig#"&gt;
  &lt;ds:SignedInfo&gt;
    &lt;ds:CanonicalizationMethod Algorithm="http://www.w3.org/2001/10/xml-exc-c14n#" /&gt;
    &lt;ds:SignatureMethod Algorithm="http://www.w3.org/2001/04/xmldsig-more#rsa-sha256" /&gt;
    &lt;ds:Reference URI="#_9047cac5-7ad8-4ca0-b43f-35d7fdac929b"&gt;
      &lt;ds:Transforms&gt;
        &lt;ds:Transform Algorithm="http://www.w3.org/2000/09/xmldsig#enveloped-signature" /&gt;
        &lt;ds:Transform Algorithm="http://www.w3.org/2001/10/xml-exc-c14n#" /&gt;
      &lt;/ds:Transforms&gt;
      &lt;ds:DigestMethod Algorithm="http://www.w3.org/2001/04/xmlenc#sha256" /&gt;
    &lt;/ds:Reference&gt;
  &lt;/ds:SignedInfo&gt;
  [...]
&lt;/ds:Signature&gt;</pre></div></div></div><div class="part"><div class="titlepage"><div><div><h1 class="title"><a id="_adapters_authentication_systems"></a>Part IV. Adapters / Authentication Systems</h1></div></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="x76733_Heading1Tarsec_File_Adapter"></a>Chapter 46. File Adapter</h2></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_introduction_14"></a>46.1. Introduction</h2></div></div></div><p>The File adapter is a simple adapter for testing purposes. Other adapters connect the SLS to a backend user authentication system. The File adapter uses a xml file as user authentication backend. All authentication and authorization information is stored in this xml file.</p><p>A typical login flow using File adapter:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">
A user requests a restricted site.
</li><li class="listitem">
The user is getting redirected from the SES to the SLS.
</li><li class="listitem">
The SLS displays the Login page to the user.
</li><li class="listitem">
The user fills in username and password.
</li><li class="listitem">
The File adapter checks the username and compares the password with the corresponding hash from xml file.
</li><li class="listitem">
If the username and the password were valid, the SLS grants the access rights to the client.
</li></ol></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_features"></a>46.2. Features</h2></div></div></div><p>The following features will give you a brief overview of the File Adapters functionalities:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
Support for user groups and authorizations.
</li><li class="listitem">
Supports user attributes which can be resolved by jexl-expressions for later usage.
</li><li class="listitem">
No need of SLS restart when changing the user-configuration file.
</li><li class="listitem">
Passwords are saved as SHA-1 hashes.
</li><li class="listitem">
Easy and simple set-up.
</li></ul></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_configuration_6"></a>46.3. Configuration</h2></div></div></div><p>In addition to basic SES/SLS set up, the File-adapter needs some special configurations.</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
Enable the File-adapter in SLS configuration.
</li><li class="listitem">
Add users to the user-config.xml.
</li></ul></div><p>The standard SLS distribution is shipped with a pre configured File-adapter and an example user configuration file.</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_sls_configuration_2"></a>46.3.1. SLS Configuration</h3></div></div></div><p>Make sure, that the file adapter is enabled. The following line in <code class="literal">sls.properties</code> activates the File-adapter.</p><pre class="programlisting">adapter.class.file=com.usp.sls.adapter.file.FileAdapter</pre><p>If the above line exists, the File-adapter can be used in several models, i.e. for authentication and authorization:</p><pre class="programlisting">adapter.authentication=file
adapter.authorization=file</pre><p><span class="strong"><strong><code class="literal">user.config.file</code></strong></span></p><p>Defaults to "<code class="literal">user-config.xml</code>". If set to an absolute file path, the file must exist at the specified location. If no such file exists, the value is treated as a path relative to the "<code class="literal">WEB-INF</code>"-directory of the SLS web application. Examples:</p><pre class="programlisting">user.config.file=my-users.xml</pre><p>Points to a file "<code class="literal">my-users.xml</code>" inside the SLS "<code class="literal">WEB-INF</code>" directory.</p><pre class="programlisting">user.config.file=/home/jim/some-users.xml</pre><p>Points to a file "<code class="literal">some-users.xml</code>" in the home directory of user "<code class="literal">jim</code>".</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_login_model"></a>46.3.2. Login Model</h3></div></div></div><pre class="programlisting">model.login.uri=/auth
model.login.failedState=get.usererror
model.login.state.1.name=get.cred
model.login.state.2.name=do.auth
model.login.state.3.name=do.success
model.login.state.5.name=get.usererror</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_user_configuration"></a>46.3.3. User Configuration</h3></div></div></div><p>The user-config.xml is the File adapter's backend system, containing all authentication and authorization information. This file can be edited with any text- or xml-editor to add or remove users and change their properties.</p><p>The syntax of the user configuration file (user-config.xml) is defined by its document type definition (user-config.dtd). Changing the file with an xml-editor can prevent from syntactic mistakes.</p><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="_description_of_example_user_configuration"></a>Description of example user configuration</h4></div></div></div><p>The following paragraphs reference to the example file listed in the appendix. The best way to read this guide is to consider the example in parallel to the following description.</p><p><span class="strong"><strong>user-config.xml</strong></span></p><p>Each user needs a unique name. With the optional attribute <code class="literal">locked=true</code> a user can be locked. In the user's body the password, group membership, and additional attributes are set. Usually an administrator sets the password in the <code class="literal">plaintext</code> tag.</p><pre class="screen">&lt;plaintext&gt;mypwd&lt;/plaintext&gt;</pre><p>The File-adapter will replace it with an SHA-1 hash, the next time the file is read. You can force the user to change the password the first time he logs in by setting the password attribute</p><p><code class="literal">forcechange="on"</code>.</p><p>The user needs at least one valid group membership. Valid means, that the file must contain the referenced group. The attributes are optional. Inside the <code class="literal">attributes</code> tag an arbitrary number of attributes can be defined, each containing a key-value pair.</p><p>Groups can contain authorizations and attributes. Both, the authorizations and the attributes will be available for all members of the group. Note: Do not use the same key in a group attribute and in a user attribute in the same file. There is no priority defined.</p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="_authorizations"></a>Authorizations</h4></div></div></div><p>The authorizations of a user can be resolved with the following jexl function. The parameter defines the delimiter, when more than one authorization is found.</p><p><code class="literal">${Session.getAuthorizations(',\')}</code></p><p>With the user in the example file, the above jexl call would evaluate to:</p><pre class="screen">fullAccess</pre></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="_evaluation_of_attributes"></a>Evaluation of Attributes</h4></div></div></div><p>The attributes can be referenced with jexl, i.e. to set a cookie with additional user or group attributes when a user successfully logged in. For a description of jexl consult the sls-core adminguide. The attributes from File-adapter has the prefix <code class="literal">attribute.file</code>.</p><p>I.e. resolving the "mykey" attribute from the example user "admin" would evaluate to "myval" :</p><p><code class="literal">${attribute.file.mykey}</code></p></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_example_user_configuration"></a>46.4. Example User Configuration</h2></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_authentication_backend"></a>46.4.1. Authentication Backend</h3></div></div></div><p><span class="strong"><strong>user-config.xml</strong></span></p><pre class="screen">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;!DOCTYPE user-config SYSTEM "user-config.dtd"&gt;
&lt;user-config&gt;
  &lt;users&gt;
    &lt;user name="admin"&gt;
      &lt;password forcechange="off"&gt;
        &lt;plaintext/&gt;
        &lt;hash&gt;\+eBZ8Okp7gMqv\+ybwqBzZfVPZZ4=&lt;/hash&gt;
      &lt;/password&gt;
      &lt;groupmember group="bosses"/&gt;
      &lt;attributes&gt;
        &lt;attribute key="mykey" val="myval" /&gt;
      &lt;/attributes&gt;
    &lt;/user&gt;
  &lt;/users&gt;
  &lt;groups&gt;
    &lt;group name="group1"/&gt;
    &lt;group name="bosses"&gt;
      &lt;az&gt;fullAccess&lt;/az&gt;
      &lt;attributes&gt;
        &lt;attribute key="groupatt" val="groupval" /&gt;
      &lt;/attributes&gt;
    &lt;/group&gt;
  &lt;/groups&gt;
&lt;/user-config&gt;</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_syntax_definition"></a>46.4.2. Syntax Definition</h3></div></div></div><p><span class="strong"><strong>user-config.dtd</strong></span></p><pre class="screen">&lt;!ELEMENT user-config (users, groups)&gt;
&lt;!ATTLIST user-config
mock (on | off) "off" &gt;

&lt;!ELEMENT users (user+)&gt;
&lt;!ELEMENT user  (password, groupmember+, attributes?)&gt;
&lt;!ATTLIST user
name ID #REQUIRED
state (ok | locked) "ok" &gt;
&lt;!ELEMENT password (plaintext, hash)&gt;
&lt;!ATTLIST password
forcechange (on | off) "off" &gt;

&lt;!ELEMENT plaintext (#PCDATA)&gt;
&lt;!ELEMENT hash (#PCDATA)&gt;

&lt;!ELEMENT mockservice (token*)&gt;
&lt;!ELEMENT token EMPTY&gt;

&lt;!ELEMENT attributes (attribute*)&gt;
&lt;!ELEMENT attribute EMPTY&gt;
&lt;!ATTLIST attribute
key CDATA #REQUIRED
val CDATA #REQUIRED &gt;

&lt;!ELEMENT groupmember EMPTY&gt;
&lt;!ATTLIST groupmember
group IDREF #REQUIRED &gt;

&lt;!ELEMENT groups (group+)&gt;
&lt;!ELEMENT group (az*, attributes?)&gt;
&lt;!ATTLIST group
name ID  #REQUIRED &gt;

&lt;!ELEMENT az (#PCDATA)&gt;</pre></div></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="_google_authenticator_adapter"></a>Chapter 47. Google Authenticator Adapter</h2></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_introduction_15"></a>47.1. Introduction</h2></div></div></div><p>The Google Authenticator adapter supports challenge / response login procedures
using a time-based one-time-passcode (OTP). The algorithm for this authentication
type is publicly available, and various open-source implementations of mobile
apps (Android, iOS etc.) exist.</p><p>This type of response / challenge is based on a shared, user-specific secret. This
means that both the SLS and the users mobile app have to know the secret. Both can then
build the same numeric response codes based on the current time, in specified intervals
(typically 30 seconds).</p><p>So, in order for a user to log in with a Google Authenticator app, the app must
first be initialized with the secret. The secret itself, which can either be
generated by the SLS in some form, or be read from a database or similar storage,
must be provided to the user in some kind of protected flow, either as a long
numeric code, or as a QR-code. The latter can just be photographed with the
Authenticator app to input the secret.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_configuration_7"></a>47.2. Configuration</h2></div></div></div><p>The Google Authenticator adapter is configured through a Java properties file,
usually named "<code class="literal">googleauth-adapter.properties</code>". The following paragraphs
explain all available configuration properties and values.</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_challenge_customization"></a>47.2.1. Challenge Customization</h3></div></div></div><p><span class="strong"><strong><code class="literal">googleauth.randomNumberAlgorithm</code></strong></span></p><p><span class="emphasis"><em>Optional</em></span>: Allows to configure the algorithm to be used for
generating secure random numbers. Defaults to "SHA1PRNG".</p><p><span class="strong"><strong><code class="literal">googleauth.randomNumberAlgorithmProvider</code></strong></span></p><p><span class="emphasis"><em>Optional</em></span>: Allows to configure the JCE provider to be used for generating
secure random numbers. Defaults to "SUN".</p><p><span class="strong"><strong><code class="literal">googleauth.secret.encoded</code></strong></span></p><p>Mandatory configuration property which defines the source for the user-specific
secret (seed):</p><pre class="programlisting">googleauth.secret.encoded=${function.base32encode(function.hmacSHA256('&lt;your-secret-here&gt;', session.getCred('username')))}</pre><div class="note" style="margin-left: 0; margin-right: 10%;"><h3 class="title">Note</h3><p>The resulting value MUST be base32 encoded, or the Authenticator app will
not recognize the secret.</p></div><p>Please see <a class="link" href="#x_googleauth_adapter_doc_Heading3Tarsec_Secret_Configuration" title="47.3. Secret Configuration">"Secret Configuration"</a> for more
information about different options for handling the secret and the implications
of each approach.</p><p><span class="strong"><strong><code class="literal">googleauth.qrcode.uri</code></strong></span></p><p>Mandatory configuration property used to configure the QR-code URI string. While
the format of that string is pre-defined for the most part by the mobile app,
and could therefore be hardcoded, it contains dynamic parts like the user ID,
which is why it must be a configurable value. Example value:</p><pre class="programlisting">googleauth.qrcode.uri=otpauth://totp/YourIssuerHere:${session.getCred('username')}?secret=${googleauth.getSecret(true, false)}&amp;issuer=YourIssuerHere</pre><div class="note" style="margin-left: 0; margin-right: 10%;"><h3 class="title">Note</h3><p>Some apps seem to have difficulties with the "Issuer:Username" part in the
URI. So you might have to adjust the URI, e.g.</p></div><pre class="programlisting">googleauth.qrcode.uri=otpauth://totp/${session.getCred('username')}?secret=${googleauth.getSecret(true, false)}&amp;issuer=YourIssuerHere</pre><p><span class="strong"><strong><code class="literal">googleauth.windowSize</code></strong></span></p><p><span class="emphasis"><em>Optional</em></span>: Allows to configure the size of the response code check window. In
case of an invalid response code, one possible reason is a time difference
between the mobile client and the server. In that case, the server will verify
a number of adjoining response codes along the timeline. Defaults to 10.</p><p><span class="strong"><strong><code class="literal">googleauth.timeStepSize</code></strong></span></p><p><span class="emphasis"><em>Optional</em></span>: Allows to configure the response code changing interval, i.e. the
timespan for which a code is being displayed on the mobile app until it switches
to the next code. Defaults to 30’000 milliseconds / 30 seconds.</p><p><span class="strong"><strong><code class="literal">googleauth.codeDigits</code></strong></span></p><p><span class="emphasis"><em>Optional</em></span>: Allows to configure the number of digits used for the response code.
Defaults to 6.</p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="x_googleauth_adapter_doc_Heading3Tarsec_Secret_Configuration"></a>47.3. Secret Configuration</h2></div></div></div><p>Techically, the secret is a string representing a secure random code. This code
must be different for every user, and could be persisted as user meta data,
e.g. in an LDAP attribute. However, this also means that using the Google
Authenticator means requiring an LDAP directory as well.</p><p>There are basically two approaches for handling user secrets, and they both
have their advantages and disadvantages, and potential consequences:</p><p><span class="strong"><strong>Self-Contained</strong></span></p><p>The quickest and cheapest approach is to configure the secret in a way that it
does not require any external user data: The secret is just built by combining
an SLS instance specific secret (a randomized string in the configuration) with
the user’s login ID:</p><pre class="programlisting">googleauth.secret.encoded=${function.base32encode(function.hmacSHA256('&lt;sls-instance-secret&gt;', session.getCred('username')))}</pre><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
Advantage: No user data backend (e.g. LDAP) of any kind required.
</li><li class="listitem">
Problem 1: If the user ever requires a new, different secret (because her mobile
  phone was stolen, for instance), the only way to change the secret without
  changing the username is by changing the SLS instance secret. But that would
  immediately render all secrets of all other users invalid, so this option basically
  means that the users could never change the secret.
</li><li class="listitem">
Problem 2: Since user login IDs are relatively simple strings, the cryptographic
  security level is diminished by this approach.
</li></ul></div><p><span class="strong"><strong>Externally Generated</strong></span></p><p>Alternatively, a pre-generated user-specific value could be used from an external
source like an LDAP service, e.g.:</p><pre class="programlisting">googleauth.secret.encoded=${function.base32encode(function.hmacSHA256('&lt;sls-instance-secret&gt;', ldap.attribute.userSecret))}</pre><p>This is the recommended way of configuring the secret; using both an SLS instance
secret, and a proper secure random code different for every user, but not
directly coupled with the login ID.</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
Advantage 1: Highest possible cryptographic level of security, given that the
  secret code was generated properly.
</li><li class="listitem">
Advantage 2: If the users device gets stolen and a new secret is required, a
  new one can be generated for that user and stored in the LDAP attribute. It
  will not have any negative impact on all the other users.
</li><li class="listitem">
Problem: Some kind of external storage required; also, organizational processes
  must exist to pre-generate the secret for each user and store them etc.
</li></ul></div><p><span class="strong"><strong>SLS Instance Secret</strong></span></p><p>While using an SLS instance secret is technically completely optional, it is
highly recommended to use it. Theoretically, it would also be possible to remove
it and configure the secret just like this, based only on user data:</p><pre class="programlisting">googleauth.secret.encoded=${function.base32encode(ldap.attribute.userSecret)}</pre><p>Problem: The LDAP directory itself is often not protected very well. It’s quite
common that a lot of administrators / operators etc. may have read access to
user objects, and could therefore gain access to the secrets of other
employees. Since the LDAP administrators may not necessarily be the same people as
the SES administrators, adding an SLS instance secret increases the security
considerably. Anyone who gains access to the LDAP secret value of another user
will still not be able to reproduce the Google Authenticator initialization
code without the SLS instance secret string.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_jsp"></a>47.4. JSP</h2></div></div></div><p>There is one JSP used specifically for the Google Authenticator adapter:</p><pre class="screen">QRCode.jsp</pre><p>This JSP renders a QRCode with the user’s secret, which can be used by the
Google Authenticator app to initialize the user account. In addition to the QR
code it also displays the secret as a human-readable string. This allows users
without a QR-compatible device to initialize the secret by entering this code.
The JSP can be showed to the user in an SLS model like this:</p><pre class="programlisting">model.qrcode.state.100.name=show.jsp-login
model.qrcode.state.100.property=/WEB-INF/jsp/QRCode.jsp</pre><p><span class="strong"><strong>NOTE</strong></span>: Generating a QR-code requires an authenticated session, because the code
is generated based on user-specific information. In other words, it must be
ensured that a user can only invoke this JSP after they have been properly
authenticated by other means. In the model, this could be implemented with
a check like this:</p><pre class="screen">model.qrcode.state.50.name=do.generic-checkLoggedIn
model.qrcode.state.50.action.1=${function.failWithAuthenticationError(...)}
model.qrcode.state.50.action.1.if.1=${!session.isAuthenticated()}</pre></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_jexl_functions_2"></a>47.5. JEXL Functions</h2></div></div></div><p>The following JEXL function allows to create a base64 encoded QR code picture:</p><pre class="screen">${googleauth.createQRcode()}</pre><p>The resulting base64-string can then be used for an embedded picture in a HTML
page, like this:</p><pre class="screen">&lt;img alt="QRCode Image" src="data:image/png;base64,&lt;sls:getScript expression='${googleauth.createQRcode()}' /&gt;" /&gt;</pre><p>The JSP "QRCode.jsp" contains the HTML code for rendering the QRCode. The
contents of the QRCode are defined by these two configuration properties:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
googleauth.qrcode.secretValue
</li><li class="listitem">
googleauth.qrcode.uri
</li></ul></div><p>The following JEXL function is a shortcut for getting the value of the property
"googleauth.secret.encoded":</p><pre class="screen">${googleauth.getSecret(boolean stripPadding, boolean humanReadable)}</pre><p>The first boolean parameter allows to define if base32 padding characters ("=")
should be stripped off; it is recommended to set this to "true", since the
Google Authenticator app on iOS currently does not work if there are padding
characters. The second boolean parameter will return the secret as in a
user-friendly, human-readable form, e.g.</p><pre class="screen">a4da ha38 jda7 85ey</pre><p>The following JEXL function creates a 16 characters long, base32 encoded random
secret, suitable as as user specific secret for authenticating:</p><pre class="screen">${googleauth.createSecret()}</pre></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_sls_properties"></a>47.6. SLS Properties</h2></div></div></div><p>The following property must be set in the "<code class="literal">sls.properties</code>" file to use the
Google Authenticator adapter for authentication and challenge / response:</p><pre class="programlisting">adapter.challenge=googleauth</pre></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_models"></a>47.7. Models</h2></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_login_model_2"></a>47.7.1. Login Model</h3></div></div></div><p>The login model is really just a standard challenge / response model, e.g.:</p><pre class="programlisting">model.google.uri=/auth
model.google.failedState=get.cred
model.google.state.100.name=get.cred
model.google.state.200.name=do.auth
model.google.state.250.name=get.cred.challenge
model.google.state.300.name=do.authresponse
model.google.state.900.name=do.success</pre></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_qr_code_model"></a>47.8. QR-Code Model</h2></div></div></div><p>The following model is an example for displaying the QR-code for the user,
after having performed a username / password authentication:</p><pre class="programlisting">model.qrcode.uri=/googleqrcode
model.qrcode.failedState=get.cred
model.qrcode.state.50.name=do.generic-checkLoggedIn
model.qrcode.state.50.action.1=${function.failWithAuthenticationError(...)}
model.qrcode.state.50.action.1.if.1=${!session.isAuthenticated()}
model.qrcode.state.100.name=get.cred
model.qrcode.state.200.name=do.auth
model.qrcode.state.300.name=show.jsp-qrcode
model.qrcode.state.300.property=/WEB-INF/jsp/QRCode.jsp</pre><p>This model could be invoked through a link which points to the SLS webapp
context with a URL parameter "cmd=googleqrcode".</p><div class="note" style="margin-left: 0; margin-right: 10%;"><h3 class="title">Note</h3><p>Displaying the secret to the user is something that should be available
only once, or maybe only in an otherwise protected environment. For instance,
in a company where users are authenticated through Kerberos in the internal
office network, the QR code model could be made available only for users
authenticated this way. So all employees could get their secret and set up their
Authenticator app while they are in the office. Once outside, and accessing the
company network over an extranet, only the Authenticator login model would be
made available.</p></div></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="x12089_Heading1Tarsec_HTTP_Adapter"></a>Chapter 48. HTTP Adapter</h2></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_introduction_16"></a>48.1. Introduction</h2></div></div></div><p>The HTTP adapter is a general adapter for multiple purposes. Unlike most of the
other adapters, which are meant for a specific usage such as authentication or
authorization, the HTTP adapter can be invoked from every step of the model
login.</p><p>Some examples:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
The HTTP adapter can be used for the authentication. In this case the backend
  authentication system is a HTTP server which receives a request and will send
  a response that determines whether the user was successfully authenticated or
  not.
</li><li class="listitem">
The HTTP adapter can be used to send notification messages to a HTTP server.
  For example, there could be a HTTP service which gets a message from the SLS
  system if the login process was succesful.
</li><li class="listitem">
Since the body/message part is freely configurable, it is also possible to
  send XML-messages to specialized services, such as a typical SMS message send
  service (which often provide HTTP/XML-based interfaces).
</li></ul></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_features_2"></a>48.2. Features</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
The HTTP adapter is able to send HTTP GET, POST, PUT, PATCH and DELETE methods.
</li><li class="listitem">
Both success and failure codes can be defined in the configuration file. That
  means, the behaviour of the system depending on the answer of the HTTP server
  host can be customized.
</li><li class="listitem">
The url of the host which is going to get the HTTP can be defined in the
  configuration file. Different hosts can be chosen for different purposes of
  the HTTP adapter.
</li><li class="listitem">
The content of the header and/or the body and the parameters of the call are
  also defined in the configuration file.
</li><li class="listitem">
Simple round-robin failover or load-balancing and connection monitoring.
</li><li class="listitem">
HTTP Proxy servers are supported, also with authentication.
</li><li class="listitem">
Authentication against the HTTP backend (web-)server is supported (Basic Auth,
  NTLM and SPNEGO/Kerberos).
</li><li class="listitem">
A connection timeout threshold can be defined.
</li></ul></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_configuration_8"></a>48.3. Configuration</h2></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_environment_prerequisites"></a>48.3.1. Environment / prerequisites</h3></div></div></div><p>The HTTP adapter is able to perform arbitrary HTTP calls to any server. However, be sure to allow the connection through
the specified protocol and port. Both HTTP and HTTPS are usually allowed protocols into a corporate network. In the same
way, the standard ports 80 and 443 are usually open to send requests through them. But if you want to send calls through
non-standard ports, you have to be sure that you are allowed to.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_configuration_9"></a>48.3.2. Configuration</h3></div></div></div><p>The HTTP adapter is configured through a Java properties file, usually named "<code class="literal">http-adapter.properties</code>" that must be
installed in the "<code class="literal">WEB-INF</code>" directory of the SLS web application.</p><p>The standard SLS distribution is shipped with a pre-configured HTTP adapter and an example configuration file.</p><p>The configuration of the HTTP adapter is not the same for the authentication as for the generic HTTP calls.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="x_http_adapter_adoc_HTTPS_SSL"></a>48.3.3. HTTPS / SSL/TLS</h3></div></div></div><p>Read chapter <a class="link" href="#x50805_Heading1Tarsec_SSL_JSSE" title="Chapter 41. TLS/SSL (JSSE)">"TLS/SSL (JSSE)"</a> for details on how to properly set up SSL with the Sun
Java VM. The login service uses the default SSL implementation available in the JVM, which is usually Sun's JSSE, so
all documentation about JSSE applies.</p><p><span class="strong"><strong><code class="literal">http.ssl.accepted.cns</code></strong></span></p><p><span class="emphasis"><em>Optional:</em></span> allows to specify a comma separated list of accepted CNs in the SSL server certificate, e.g.</p><pre class="programlisting">http.ssl.accepted.cns=www.acme.org,www.bar.com</pre><p>More precisely, either CN or any of the Subject Alterative Names (SANs)
in the certificate must be contained in the indicated list of accepted CNs.</p><p><span class="strong"><strong><code class="literal">http.ssl.enforce.host</code></strong></span></p><p><span class="emphasis"><em>Optional:</em></span> allows to enforce a check of the hostname in the common name attribute of the server certificate. If this
property is set to "<code class="literal">true</code>", the hostname in the server certificate must be the same as the hostname of the current TCP
connection. Defaults to "<code class="literal">false</code>".</p><pre class="programlisting">http.ssl.enforce.host=true</pre><p>More precisely, either CN or any of the Subject Alterative Names (SANs)
in the certificate must be equal to the hostname.</p><p><span class="strong"><strong><code class="literal">http.tls.versions</code></strong></span></p><p><span class="emphasis"><em>Optional:</em></span> allows to define which TLS versions may be used for backend
connections. Defaults to "<code class="literal">TLSv1.2</code>".</p><pre class="programlisting">http.tls.versions=TLSv1,TLSv1.2</pre><p>Known / supported values for this property include
<code class="literal">TLSv1.3</code>, <code class="literal">TLSv1.2</code>, <code class="literal">TLSv1.1</code> and <code class="literal">TLSv1</code>, but whether a protocol is available
is determined dynamically by trying to obtain an <code class="literal">SSLContext</code>.
Explicitly no longer supported is <code class="literal">SSLv3</code> (or older), for security reasons and
also since recent Java versions no longer support it (for the same reason).
<code class="literal">TLSv1.3</code> requires Java 8u261 or newer, but see
chapter <a class="link" href="#x50805_Heading1Tarsec_SSL_JSSE" title="Chapter 41. TLS/SSL (JSSE)">"TLS/SSL (JSSE)"</a> for more details
regarding <code class="literal">TLSv1.3</code>.</p><p>(Also affects the WS Adapter, there is currently no separate <code class="literal">ws.*</code> setting.)</p><p><span class="strong"><strong><code class="literal">http.tls.ciphers</code></strong></span></p><p><span class="emphasis"><em>Optional:</em></span> allows to define which ciphers (cipher suites) may be used for backend
connections. Defaults to no additional restriction to what the JDK supports
and what is restricted in JDK settings.
Allowed values are "JSSE Cipher Suite Names".</p><pre class="programlisting">http.tls.ciphers=TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384, TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256, TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384, TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256</pre><p>Note that it is only possible to reduce the set of ciphers that the JDK and its
settings allow, but for security reasons not to add ciphers.</p><p>(Also affects the WS Adapter, there is currently no separate <code class="literal">ws.*</code> setting.)</p><p><span class="strong"><strong><code class="literal">http.&lt;alias&gt;.key.alias"</code></strong></span></p><p><span class="emphasis"><em>Optional:</em></span> allows to define the alias of the key in the SLS keystore to be used
in an SSL handshake that requires mutual authentication. NOTE: This is only
necessary if the keystore of the SLS VM contains multiple private keys and
certificates that are a match for the CAs requested by the server during the
handshake. The Java SSL stack will automatically select the matching key, if there
is only one that matches. However, if there are multiple matching keys, this
property allows to make sure that the correct one is used.</p><pre class="programlisting">http.auth.key.alias=slstechuser</pre><p><span class="strong"><strong><code class="literal">http.dedicated.ssl.trustStore.allowSelfSigned</code></strong></span></p><p><span class="emphasis"><em>Optional and generally not recommended</em></span>:
If set to true and a dedicated truststore is used via system property
<code class="literal">javax.net.ssl.trustStore</code> then HTTP adapter callouts will accept any
self-signed server certificate, i.e. trust it blindly. Even though this
may come in handy in test setups, also in that case self-signed certificates
should rather be added to the dedicated truststore; the setting exists mainly
for migration of previous installations. Default value of this configuration
property is false. If the property is set to true, a warning is logged at SLS
startup. Note also that this setting has no effect if no dedicated truststore
is indicated and thus the truststore of the JDK is used, i.e. then self-signed
certificates are not accepted (except, of course, if they are in the truststore).</p><pre class="programlisting"># temporary hack
http.dedicated.ssl.trustStore.allowSelfSigned=true</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_the_http_adapter_as_an_authentication_adapter"></a>48.3.4. The HTTP adapter as an authentication adapter</h3></div></div></div><p>If the HTTP adapter should be used as an autentication adapter, it must be defined accordingly in the sls.properties file:</p><pre class="programlisting">adapter.authentication=http</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_connection_timeout"></a>48.3.5. Connection Timeout</h3></div></div></div><p>The following property allows to customize the default threshold for connection timeouts:</p><p><span class="strong"><strong><code class="literal">http.connection.timeout</code></strong></span></p><p><span class="emphasis"><em>Optional:</em></span> Defines the number of seconds after which the call-out will be interrupted if no connection can be made / no
data is received. Defaults to 60 (one minute) if not set. NOTE: A timeout can also be specified for each custom HTTP
call. See <a class="link" href="#http_setting_custom_timeouts" title="48.9.3. Setting custom timeouts">"Setting custom timeouts"</a> for details.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_maximal_number_of_connections"></a>48.3.6. Maximal Number of Connections</h3></div></div></div><p>The following property allows to define the maximal number of connections to use:</p><p><span class="strong"><strong><code class="literal">http.connection.total.max</code></strong></span></p><p><span class="emphasis"><em>Optional:</em></span> Defines the maximal number of connections to use in the connection
manager pool. Defaults to 400 if not set.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_maximal_number_of_connections_per_route_host"></a>48.3.7. Maximal Number of Connections per Route (Host)</h3></div></div></div><p>The following property allows to define the maximal number of connections to use
per route (host):</p><p><span class="strong"><strong><code class="literal">http.connection.perRoute.max</code></strong></span></p><p><span class="emphasis"><em>Optional:</em></span> Defines the maximal number of connections to use in the connection
manager pool per route (host). Defaults to 400 if not set.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_default_keep_alive"></a>48.3.8. Default Keep Alive</h3></div></div></div><p>The following property allows to define the default keepAlive in seconds:</p><p><span class="strong"><strong><code class="literal">http.connection.keepAlive.default</code></strong></span></p><p><span class="emphasis"><em>Optional:</em></span> Defines the default keepAlive in seconds for keeping an idle
connection open. Only has an effect if the server does not explicitly set
keepAlive via response headers. Defaults to 60 seconds if not set.</p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="x55606_Heading3Tarsec_Scripting_Variables"></a>48.4. Scripting</h2></div></div></div><p>Scripting is used to insert and access the request and response data. For example, in the case of an SMS delivery service
which requires a POST request which contains an XML structure with certain values in its body. In such a case, various
parts of the XML body would be user related attributes such as the telephone number, which might be available in an LDAP
attribute variable like "<code class="literal">attribute.ldap.mobile</code>".</p><pre class="programlisting">state...name=do.http
state...property=sendsms

# Example XML structure encoded in one line
http.sendsms.body=&lt;user phone="${ldap.attribute.mobile}"&gt;...&lt;/user&gt;</pre><p>Instead of encoding a complex XML (or any other) POST data structure into one single property value, it may be easier to
put that data into a separate template text file which can then be used (see <a class="link" href="#x12304_Heading3Tarsec_Templates" title="32.8.2. Templates">"Templates"</a>
for details). Example for using the contents of a configured template file with the alias "<code class="literal">sms</code>":</p><pre class="programlisting"># POST data taken from template file
http.sendsms.body=${function.getTemplateContent('sms')}</pre><p>For the authentication, we have to use scripting variables containing the user credentials, in order to use them as values for
HTTP parameters. The following example defines the HTTP request parameters "<code class="literal">user</code>" and "<code class="literal">pwd</code>", which contain the values
of the "<span class="emphasis"><em>username</em></span>" and "<span class="emphasis"><em>password</em></span>" credentials:</p><pre class="programlisting">http.auth.variable.user=${session.getCred('username')}
http.auth.variable.pwd=${session.getCred('password')}</pre><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_processing_json_xml_response_data"></a>48.4.1. Processing JSON/XML response data</h3></div></div></div><p>The easiest way to automatically create script variables from XML or JSON HTTP
responses is to configure a script template following the convention to name it
<code class="literal">template.file.http-response-&lt;alias&gt;</code> and to make sure the file extension of the
template is either <code class="literal">.xml</code> or <code class="literal">.json</code>, for example:</p><pre class="programlisting">template.file.http-response-myXmlHttpAction=myXmlTemplateFile.xml
template.file.http-response-myJsonHttpAction=myJsonTemplateFile.json</pre><p>If configured and the <code class="literal">content-type</code> header of the HTTP response contains
the corresponding string <code class="literal">xml</code> or <code class="literal">json</code>, the template is applied and variables
are created accordingly.</p><p>For more generic use cases using script functions, see the chapters
<a class="link" href="#x1234_updating_variables_from_xml" title="32.8.4. Updating variables from XML data with templates">"Updating variables from XML data with templates"</a>
and <a class="link" href="#x1234_updating_variables_from_json" title="32.8.3. Updating variables from JSON data with templates">"Updating variables from JSON data with templates"</a>.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_scripting_variables"></a>48.4.2. Scripting Variables</h3></div></div></div><p>Some scripting variables are created by the HTTP adapter after a HTTP callout which
 provide information about the response (see
 <a class="link" href="#expression_adoc_HTTP_Adapter_Variables" title="32.7.4. HTTP Adapter Variables">"HTTP Adapter Variables"</a> for details).</p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_http_adapter_configuration_properties"></a>48.5. HTTP Adapter Configuration Properties</h2></div></div></div><p>In order to use the HTTP adapter, some properties have to be defined in the
<code class="literal">http-adapter.properties</code> file.</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_authentication"></a>48.5.1. Authentication</h3></div></div></div><p>Here a configuration sample for the HTTP-adapter used as an authentication
adapter. For every property there is an example and its explanation below.</p><p><span class="strong"><strong><code class="literal">http.auth.url</code></strong></span></p><p>For the authentication step ("do.auth"), this property is mandatory. It defines
the HTTP URL of the service which verifies the user credentials. Example:</p><pre class="programlisting">http.auth.url=http://localhost:8080/authenticator.jsp</pre><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="_failover_load_balancing"></a>Failover / Load-Balancing</h4></div></div></div><p>Multiple URLs can be configured, separated by comma, for a simple round-robin
failover (if the SLS cannot connect to the HTTP backend system, it will try the
next one) or load-balancing.</p><p>This will enable simple failover by default. By adding the ".mode" property,
failover with a primary, or load-balancing can be enabled:</p><pre class="programlisting">http.auth.url=http://one/,http://two/,http://three/</pre><p>The <span class="strong"><strong>criterion for backend availability</strong></span> is:
Could connect to the server and the server returned an HTTP response
(with any status code, including 500).
Note that query parameters ("?abc=def") are removed from the URL before making
the callout when checking for backend availability.</p><p>It is possible to use JEXL/Groovy expressions, but only for individual urls in
the list, not for the whole list.</p><p>The feature to have backend URLs evaluate to "off" described below is <span class="strong"><strong>deprecated</strong></span>;
please use the generic mechanism using the dynamic property <code class="literal">unavailable.backends</code>
instead. That mechanism is supported for all backend types, not just for HTTP.</p><p>Expressions that evaluate to the string "off" when the adapter is loaded are skipped.
This allows to configure failover hosts separately from various callouts. Example:</p><pre class="programlisting">my.base.url.1=https://server1:33379/service/
my.base.url.2=https://server2:33379/service/
my.base.url.3=off

http.auth.url=${function.getConfigProperty('my.base.url.1')}, ${function.getConfigProperty('my.base.url.2')}, ${function.getConfigProperty('my.base.url.3')}}</pre><p>Example for enabling failover with a primary backend:</p><pre class="screen">http.auth.url=http://www.acme.com/notify.do,http://www2.acme.com/notify.do
http.auth.backendsMode=failoverWithPrimary</pre><p>Or alternatively, enabling load-balancing instead of failover:</p><pre class="screen">http.auth.url=http://www.acme.com/notify.do,http://www2.acme.com/notify.do
http.auth.backendsMode=loadBalancing</pre><p>The default backend mode is <code class="literal">failover</code>, simple round-robin failover.</p><p>Please see chapter <a class="link" href="#x12345_Heading1Tarsec_loadbalancing_failover" title="Chapter 27. Load-Balancing / Failover">"Load-Balancing / Failover"</a> for details
about failover and load-balancing.</p><p>See also the description of the monitoring or connection check URL setting
below.</p><p><span class="strong"><strong><code class="literal">http.auth.method</code></strong></span></p><p>Defines the HTTP method for the request. Must be one of the following values:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">GET</code>
</li><li class="listitem">
<code class="literal">POST</code>
</li><li class="listitem">
<code class="literal">PUT</code>
</li><li class="listitem">
<code class="literal">PATCH</code>
</li><li class="listitem">
<code class="literal">DELETE</code>
</li></ul></div><p>Example:</p><pre class="programlisting">http.auth.method=POST</pre><p><span class="strong"><strong><code class="literal">http.auth.code.error</code></strong></span></p><p>Defines the HTTP response codes which indicate something went wrong while
calling the HTTP authentication service. The HTTP adapter will consider it as a
failed authentication, due to a technical problem on the HTTP server side.
Example:</p><pre class="programlisting">http.auth.code.error=500,503</pre><p><span class="strong"><strong><code class="literal">http.auth.code.denied</code></strong></span></p><p>The HTTP codes which indicate the HTTP server denied the access for the
authenticating user. The HTTP adapter will consider it as a failed
authentication, due to invalid user credentials. Example:</p><pre class="programlisting">http.auth.code.denied=401,403</pre><p><span class="emphasis"><em>Either this property must be configured, or the regular expression which
defines a success response (<code class="literal">http.auth.response.ok</code>).</em></span></p><p><span class="strong"><strong><code class="literal">http.auth.response.ok</code></strong></span></p><p>The pattern to be found in the HTTP response body in order to consider the
authentication as successful. The adapter will use the value of this property
as a regular expression which has to match with any part of the response body.
For example, if the HTTP server response body contains "<span class="emphasis"><em>The authentication was
OK</em></span>", the value "<code class="literal">OK</code>" will lead to a successful authentication. Example:</p><pre class="programlisting">http.auth.response.ok=OK</pre><p><span class="emphasis"><em>Note: The Java (JDK) regular expression mechanisms apply here. If a match
should include preceding and following lines of HTML, including newline
characters, these characters must be matched explicitly, as .* does not match
\r (carriage return) or \n (newline). Example with "Login:" on one line
and "OK" further below in a "&lt;span&gt;" html tag (note double escaped \\r
and \\n - once for Java properties file, once for regex itself):</em></span></p><pre class="programlisting">http.auth.response.ok=Login:(.|[\\r\\n])*&lt;span&gt;OK&lt;/span&gt;</pre><p><span class="strong"><strong><code class="literal">http.auth.header.ok.&lt;name&gt;</code></strong></span></p><p>There is a third way to decide if a HTTP authentication was successfully or
not: to check the headers of the HTTP response. We can determine the name and
value of the header which define a successful authentication. By example:</p><p><code class="literal">http.auth.header.ok.userstate=granted</code></p><p>If the HTTP-Response contains a HTTP-Header named "user-state" with value
"granted", the user is authenticated.</p><p>This property works only if the property <code class="literal">http.auth.response.ok</code> is not used,
since configuring both properties would cause a conflict. In case both
properties were configured, the property http.auth.response.ok would be checked
and the property http.auth.header would be ignored.</p><p><span class="strong"><strong><code class="literal">http.auth.credentials</code></strong></span></p><p>The semantical types of the credentials that the HTTP adapter has to verify in
order to consider the authentication as successful. If those credentials are
not available, the HTTP adapter will fail the authentication with a
corresponding error message about missing credentials (without performing a
HTTP call at all). Example:</p><pre class="programlisting">http.auth.credentials=username,password</pre><p>For a list of all allowed, valid values, see <a class="link" href="#x99987_Heading2Tarsec_Semantic_Types" title="8.4. Semantic Types">"Semantic Types"</a></p><p>Also, all credentials listed in this property will be marked as verified after
a successfull completion of the HTTP call.</p></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_actions_after_http_call"></a>48.5.2. Actions after HTTP call</h3></div></div></div><p><span class="strong"><strong><code class="literal">http.&lt;alias&gt;.action.&lt;no&gt;</code></strong></span></p><p>A list of JEXL/Groovy actions to perform after a successful HTTP call.
The actions will be performed in order of the <code class="literal">&lt;no&gt;</code> number assigned to them.</p><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="_login_model_3"></a>Login Model</h4></div></div></div><p>By default, the HTTP adapter (when used as authentication adapter) requires
only the simplest login model:</p><pre class="programlisting">model.login.uri=/auth
model.login.failedState=get.usererror
model.login.state.1.name=get.cred
model.login.state.2.name=do.auth
model.login.state.3.name=do.success</pre><p><code class="literal">model.login.state.5.name=get.usererror</code></p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="_request_parameters"></a>Request Parameters</h4></div></div></div><p><span class="strong"><strong><code class="literal">http.auth.variable.<span class="emphasis"><em>&lt;name&gt;</em></span></code></strong></span></p><p>Defines a parameter for the HTTP request. The <span class="emphasis"><em>&lt;name&gt;</em></span> part of the property
name defines the name of the HTTP parameter. Example:</p><pre class="programlisting">http.auth.variable.user=${session.getCred('username')}
http.auth.variable.pwd=${session.getCred('password')}</pre><p>This example defines two request parameters, named "<code class="literal">user</code>" and "<code class="literal">pwd</code>",
containing the values of the session credentials of type "<code class="literal">username</code>" and
"<code class="literal">password</code>".</p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="_dynamic_selection_of_backend_group"></a>Dynamic Selection of Backend Group</h4></div></div></div><p>Backend groups can be selected dynamically at authentication,
in the example based on the <code class="literal">Host</code> header of an incoming HTTP request to the SLS.
Properties for HTTP URLs (backends):</p><pre class="programlisting"># Default HTTP URL
http.url=http://192.168.10.15:80,http://192.168.10.16:80

# Acme HTTP URL
http.acme.url=http://172.17.10.1:80,http://172.17.10.2:80</pre><p>Login Model:</p><pre class="programlisting">model.login.state.1000.name=do.generic-selectBackend
# use Acme HTTP backends instead of default for all users from virtual host "something.com"
model.login.state.1000.action.1=#{setVar('backendToUse', '')}
model.login.state.1000.action.2=#{setVar('backendToUse', 'acme')}
model.login.state.1000.action.2.if.1=#{var('header.host') == 'something.com'}
model.login.state.2000.name=do.auth
model.login.state.2000.property=#{backendToUse}</pre></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="x1234_Heading1Tarsec_HTTP_Connection_monitoring"></a>48.6. HTTP Connection monitoring</h2></div></div></div><p>The SLS has the capability to perform <span class="emphasis"><em>connection monitoring</em></span> as explained in
chapter <a class="link" href="#x12345_Heading1Tarsec_Connection_monitoring" title="Chapter 28. Backend Monitoring">"Connection monitoring"</a></p><p>In case of the HTTP adapter, the actual backend URLs can sometimes contain
dynamic parts like scripting variables, used in URL query parameters; since those
variables only contain meaningful or valid values in the context of a login
session, they can be a problem when used by the background monitoring process.
For this reason, it is possible to configure separate URLs for backend
monitoring for the HTTP adapter.</p><p>See also the properties <code class="literal">http.auth.url</code> and the property immediately below.</p><p><span class="strong"><strong><code class="literal">http.auth.connectionCheckUrl</code></strong></span></p><p>Property specifying the back-end URLs to use for monitoring. The format is the
same as for <code class="literal">http.auth.url</code>. This setting overrides the <code class="literal">http.auth.url</code> for
back-end monitoring purposes.</p><p>Note that the URLs in this property correspond to those in <code class="literal">http.auth.url</code>: The
list of auth URLs and connection check URLs must be of the same length, and must
have the same URLs active or "off". For each auth URL the corresponding
connection check URL is found at the corresponding position in the list.</p><p>The main use case for defining dedicated connection check URLs is when a URL
used for HTTP authentication contains variable parts, and cannot be used for the
simple monitoring requests as is. Example:</p><pre class="programlisting">monitor.check.interval=90

http.auth.url=https://auth.acme.com/B2B/Clients/${client_id}/${client_locale}
http.auth.connectionCheckUrl=https://auth.acme.com/B2B/Clients</pre><p>In this example, the URL
<code class="literal">https://auth.acme.com/B2B/Clients/${client_id}/${client_locale}</code> can not be
used directly since it contains JEXL expressions (<code class="literal">${}</code>). The custom
<code class="literal">http.auth.connectionCheckUrl</code> makes it possible to do back-end monitoring.</p><p>If connection monitoring is active and <code class="literal">http.auth.connectionCheckUrl</code> is not
defined, the URLs in <code class="literal">http.auth.url</code> will be used for monitoring.</p><p>As with the other HTTP adapter configuration properties, the connection check
URL feature is also available when performing monitoring with <span class="emphasis"><em>Custom HTTP
Actions</em></span>.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="x_http_adapter_adoc_Proxy_Support"></a>48.7. Proxy Support</h2></div></div></div><p>It is possible to define global proxy settings that will then be used by all
HTTP adapter calls. In addition, for each custom HTTP operation, separate proxy
settings can be defined.</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_global_proxy_settings"></a>48.7.1. Global Proxy Settings</h3></div></div></div><p>The following optional properties can be used to have the HTTP adapter send all
its requests through an HTTP forward proxy server.</p><p><span class="strong"><strong><code class="literal">http.proxy.host</code></strong></span></p><p><span class="emphasis"><em>Optional:</em></span> Defines the hostname of a HTTP proxy server which should be used for
all HTTP calls. Example:</p><pre class="programlisting">http.proxy.host=172.17.3.10</pre><p><span class="strong"><strong><code class="literal">http.proxy.port</code></strong></span></p><p>Defines the listener port of a HTTP proxy server which should be used for all
HTTP calls. NOTE: This property becomes mandatory once the property
"<code class="literal">http.proxy.host</code>" has been set. Example:</p><pre class="programlisting">http.proxy.port=3128</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_proxy_authentication"></a>48.7.2. Proxy Authentication</h3></div></div></div><p>Sometimes, the proxy server requires authentication; this has nothing to do
with authenticating the end-user. It is a "technical" authentication of the
SLS itself towards the proxy server. There are basically two ways to configure
this, either directly with the following properties, or by configuring an
authentication realm and referencing it (same as how authentication can be
configured for the HTTP calls towards the HTTP backend).</p><p><span class="strong"><strong>Option 1: Properties</strong></span></p><p><span class="strong"><strong><code class="literal">http.proxy.auth.password</code></strong></span></p><p><span class="emphasis"><em>Optional:</em></span> Defines the password to use to authenticate against the proxy.</p><p><span class="strong"><strong><code class="literal">http.proxy.auth.username</code></strong></span></p><p><span class="emphasis"><em>Optional:</em></span> Defines the username to use to authenticate against the proxy.</p><p><span class="strong"><strong><code class="literal">http.proxy.auth.type</code></strong></span></p><p><span class="emphasis"><em>Optional:</em></span> Defines the type of authentication to perform. Must be one of the
values <code class="literal">basic</code> (Basic Auth), <code class="literal">ntlm</code> or <code class="literal">spnego</code> (Kerberos over HTTP).</p><p><span class="strong"><strong><code class="literal">http.proxy.auth.domain</code></strong></span></p><p><span class="emphasis"><em>Optional:</em></span> Defines the authentication realm to use (e.g. the basic auth realm).</p><p>A complete example for authenticating at the proxy using NTLM:</p><pre class="programlisting">http.proxy.auth.username=slsuser
http.proxy.auth.password=slspwd
http.proxy.auth.type=ntlm
http.proxy.auth.domain=ACME</pre><p><span class="strong"><strong>Option 2: Authentication Realm</strong></span></p><p>See chapter "<a class="link" href="#x51261_Heading3Tarsec_Authentication_Realms" title="48.8. Authentication Realms">"Authentication Realms"</a>
for more general details on the subject.</p><p><span class="strong"><strong><code class="literal">http.proxy.realm</code></strong></span></p><p><span class="emphasis"><em>Optional:</em></span> Defines the authentication realm configuration settings to use for the authentication against the proxy
(see <a class="link" href="#x51261_Heading3Tarsec_Authentication_Realms" title="48.8. Authentication Realms">"Authentication Realms"</a> for details).  Set the alias (ID) of the
authentication realm property group to be used. Example:</p><pre class="programlisting">http.proxy.realm=_ntlmlogin_</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_custom_http_action_proxy_settings"></a>48.7.3. Custom HTTP Action Proxy Settings</h3></div></div></div><p>The following optional properties can be used to have the HTTP adapter use a
certain proxy for one specific custom HTTP action. The property names are almost the
same as for the global property settings, only with the additional custom action
alias included. Here is a complete example of a custom HTTP call with specific
proxy settings only for this call:</p><pre class="programlisting">http.sendsms.url=https://www.smsprovider.com
http.sendsms.method=post
http.sendsms.header.Content-Type=text/xml
http.sendsms.header.host=www.smsprovider.com
http.sendsms.body=...some custom body data...
http.sendsms.proxy.host=192.168.10.15
http.sendsms.proxy.port=3128
http.sendsms.proxy.realm=simpleauth</pre></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="x51261_Heading3Tarsec_Authentication_Realms"></a>48.8. Authentication Realms</h2></div></div></div><p><span class="emphasis"><em>The HTTP adapter supports authentication against the target HTTP service, and / or a proxy server. This has nothing to
do with authenticating the end-user; it is all about the SLS identifying itself towards the backend service, usually
with a technical user account.</em></span></p><p>The authentication information must be configured in property groups, each group defining one authentication realm, for
example:</p><pre class="programlisting">http.realm.1.id=simpleauth
http.realm.1.type=basic
http.realm.1.basicRealm=Sample App
http.realm.1.username=techuser
http.realm.1.password=abcd1234</pre><p>This example configures an authentication of type "<code class="literal">basic</code>" (Basic Authentication), for a Basic-Authentication-Realm
"<code class="literal">SampleApp</code>", with the username "<code class="literal">techuser</code>" and the password "<code class="literal">abcd1234</code>". This configuration property group can then
be referenced by its alias / ID "<code class="literal">simpleauth</code>", either in the proxy configuration or a custom HTTP action:</p><pre class="programlisting">http.auth.url=https://www.auth.com
http.auth.code.error=500,503
http.auth.code.denied=401,403
http.auth.response.ok=&lt;span&gt;OK&lt;/span&gt;
http.auth.method=post
http.auth.variable.username=${session.getCred('username')}
http.auth.variable.password=${session.getCred('password')}
http.auth.realm=simpleauth</pre><p>or</p><pre class="programlisting">http.proxy.host=127.0.0.1
http.proxy.port=3128
http.proxy.realm=simpleauth</pre><p>This allows to configure the authentication type and credentials only once for multiple HTTP operations and / or proxy
settings. The details of the authentication realms properties are explained in the following paragraphs.</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_authentication_realms_properties"></a>48.8.1. Authentication Realms Properties</h3></div></div></div><p>A group of authentication realm properties always follows this naming scheme:</p><pre class="programlisting">http.realm.&lt;no&gt;.id=&lt;alias&gt;
http.realm.&lt;no&gt;.type=basic | ntlm | spnego
http.realm.&lt;no&gt;.basicRealm=&lt;realm&gt;
http.realm.&lt;no&gt;.ntlmDomain=&lt;domain&gt;
http.realm.&lt;no&gt;.username=&lt;username&gt;
http.realm.&lt;no&gt;.password=&lt;password&gt;</pre><p><span class="strong"><strong><code class="literal">http.realm.<span class="emphasis"><em>&lt;no&gt;</em></span>.id</code></strong></span></p><p>Defines the alias (ID) of this group of properties. This alias is used to refer to these settings from other parts in
the configuration (see examples in previous paragraphs). Example:</p><pre class="programlisting">http.realm.1.id=ntlmlogin</pre><p><span class="strong"><strong><code class="literal">http.realm.<code class="literal"><span class="emphasis"><em>&lt;no&gt;</em></span></code>.type</code></strong></span></p><p>Defines the type of authentication to perform. Supported types are:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">basic</code> - Simple HTTP basic authentication
</li><li class="listitem">
<code class="literal">ntlm</code> - NTLM authentication
</li><li class="listitem">
<code class="literal">spnego</code> - Kerberos over HTTP authentication
</li></ul></div><p><span class="strong"><strong><code class="literal">http.realm.<span class="emphasis"><em>&lt;no&gt;</em></span>.basicRealm</code></strong></span></p><p><span class="emphasis"><em>Optional:</em></span> Is required only if "<code class="literal">type</code>" has been set to "<code class="literal">basic</code>". Defines the name of the basic authentication realm
of the target webserver for which the configured credentials are to be used.</p><p><span class="strong"><strong><code class="literal">http.realm.<span class="emphasis"><em>&lt;no&gt;</em></span>.ntlmDomain</code></strong></span></p><p><span class="emphasis"><em>Optional:</em></span> Is required only if "<code class="literal">type</code>" has been set to "<code class="literal">ntlm</code>". Defines the Windows domain for which the configured
credentials are valid.</p><p><span class="strong"><strong><code class="literal">http.realm.<span class="emphasis"><em>&lt;no&gt;</em></span>.username</code></strong></span></p><p><span class="emphasis"><em>Optional:</em></span> Is required only if "<code class="literal">type</code>" has been set to "<code class="literal">basic</code>" or "<code class="literal">ntlm</code>". Defines the username credential for the
login. For type "<code class="literal">spnego</code>", the credentials are configured in a separate JAAS configuration file
(see <a class="link" href="#x95157_Heading4Tarsec_SPNEGO_backend_authentication" title="SPNEGO backend authentication">"SPNEGO backend authentication"</a> for details).</p><p><span class="strong"><strong><code class="literal">http.realm.<span class="emphasis"><em>&lt;no&gt;</em></span>.password</code></strong></span></p><p><span class="emphasis"><em>Optional:</em></span> Is required only if "<code class="literal">type</code>" has been set to "<code class="literal">basic</code>" or "<code class="literal">ntlm</code>". Defines the password credential for the
login. For type "<code class="literal">spnego</code>", a Kerberos keytab file must be used instead (see
<a class="link" href="#x95157_Heading4Tarsec_SPNEGO_backend_authentication" title="SPNEGO backend authentication">"SPNEGO backend authentication"</a> for details).</p><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="x95157_Heading4Tarsec_SPNEGO_backend_authentication"></a>SPNEGO backend authentication</h4></div></div></div><p>The SLS HTTP adapter uses the "Apache HttpClient 4.x" library for all its HTTP functionality. That library, in turn,
uses the SPNEGO functionality of the underlying Java VM to perform SPNEGO authentication. Therefore, in case that there
are problems related to Java SPNEGO, please refer to either Oracle's Java SPNEGO documentation, or the Apache HttpClient
documentation:</p><p><a class="ulink" href="http://hc.apache.org/httpcomponents-client-ga/tutorial/html/authentication.html" target="_top">http://hc.apache.org/httpcomponents-client-ga/tutorial/html/authentication.html</a>
<a class="ulink" href="http://docs.oracle.com/javase/6/docs/technotes/guides/security/jgss/lab/part5.html" target="_top">http://docs.oracle.com/javase/6/docs/technotes/guides/security/jgss/lab/part5.html</a></p><p>In order to perform SPNEGO authentication towards the backend or proxy server, the "<code class="literal">type</code>" must be set to "<code class="literal">spnego</code>"
and some additional configuration files are needed:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
keytab - A Kerberos keytab file with the key (password) of the authentication principal.
</li><li class="listitem">
<code class="literal">krb5.conf</code> - The Kerberos configuration, containing necessary information about the DNS domains, realms, KDC addresses
etc. Please refer to general Kerberos documentation for in-depth information about this file. A simple example has been
added here below.
</li><li class="listitem">
<code class="literal">login.conf</code>- These are the settings required by the JAAS API employed by the Java SPNEGO implementation during the
authentication process. It defines the Kerberos principal name and keytab file location.
</li></ul></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="_kerberos_debug_output"></a>Kerberos Debug Output</h4></div></div></div><p>To enable Kerberos debug output, the following system property must be set (either as a JVM startup argument, or as a
property in one of the SLS properties files):</p><p><span class="strong"><strong><code class="literal">sun.security.krb5.debug</code></strong></span></p><p><span class="emphasis"><em>Optional:</em></span> Set to "<code class="literal">true</code>" to enable Kerberos debug output in the standard output logfile ("<code class="literal">catalina.out</code>"):</p><pre class="programlisting">sun.security.krb5.debug=true</pre><p>Also, to get maximum debug output, each module defined in the "<code class="literal">login.conf</code>" file can get a debug option as well, e.g:</p><p><code class="literal">com… …module.Krb5LoginModule required debug=true</code></p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="_krb5_conf"></a>krb5.conf</h4></div></div></div><p><span class="strong"><strong><code class="literal">java.security.krb5.conf</code></strong></span></p><p>Defines the path of the Kerberos configuration file, e.g.:</p><pre class="programlisting">java.security.krb5.conf=/opt/usp/sls/prod/webapps/sls/WEB-INF/krb5.conf</pre><p>This file must be provided by the Kerberos / KDC administrator(s). It configures the Kerberos realm, the mapping of DNS
names to Kerberos realms, the address of the KDC etc. Example:</p><pre class="screen">[libdefaults]
default_realm = ACME.COM
kdc_timesync = 60
forwardable = true
allow_weak_crypto = true
udp_preference_limit = 1

[realms]
ACME.COM = {
  kdc = 172.17.3.35:88
}

[domain_realms]
slskerberos = ACME.COM
.ourapp.acme.com = ACME.COM
ourapp.acme.com = ACME.COM</pre><p><span class="emphasis"><em>This is NOT an SLS specific configuration file; please refer to standard Kerberos documentation for in-depth
information about the syntax and contents of this file.</em></span></p><p>====== TCP vs UDP</p><p>UDP is limited in size (plus less certain that data arrives),
so in some situations TCP has to be used.
The line <code class="literal">udp_preference_limit = 1</code> above effectively forces that TCP will be used
and UDP not tried (maximal size of UDP packet 1 byte).
Java SE documentation says:</p><p><span class="emphasis"><em>When sending a message to the KDC, the Java SE Kerberos library will use TCP
if the size of the message is above udp_preference_list. If the message is smaller
than udp_preference_list, then UDP will be tried at most three times.
If the KDC indicates that the request is too big, the Java SE Kerberos library
will use TCP.</em></span></p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="_login_conf_file"></a>login.conf file</h4></div></div></div><p>This configuration file is required by the JAAS API, used by the Java GSS API. To define the location of the
"<code class="literal">login.conf</code>" file, set this property (in the "<code class="literal">http-adapter.properties</code>" file:</p><p><span class="strong"><strong><code class="literal">java.security.auth.login.config</code></strong></span></p><p>Defines the path of the JAAS login configuration file, e.g.:</p><pre class="programlisting">java.security.auth.login.config = /opt/usp/sls/prod/webapps/sls/WEB-INF/login.conf</pre><p>The "<code class="literal">login.conf</code>" file must define the Kerberos principal name and the path of the keytab file to use for the
authentication. Example:</p><pre class="screen">com.sun.security.jgss.login {
  com.sun.security.auth.module.Krb5LoginModule required
  client=TRUE
  useTicketCache=true;
};

com.sun.security.jgss.initiate {
  com.sun.security.auth.module.Krb5LoginModule required
  client=TRUE
  useTicketCache=true
  storeKey=true
  useKeyTab=true
  principal="&lt;principal&gt;"
  keyTab="&lt;absolute path of keytab file&gt;";
};

com.sun.security.jgss.accept {
  com.sun.security.auth.module.Krb5LoginModule required
  client=TRUE
  useTicketCache=true;
};</pre></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_custom_http_actions"></a>48.9. Custom HTTP Actions</h2></div></div></div><p>The HTTP adapter also allows to send custom HTTP requests for any purpose
(besides authentication) at any time from within the model, using the
"<code class="literal">do.http</code>" state.</p><p>For each such custom HTTP call, a set of properties must be defined. These are
exactly the same properties as for the authentication part. The only
difference is that the "<code class="literal"><span class="emphasis"><em>.auth.</em></span></code>" part of the property name is instead some
alias which is then used in the model to reference these properties. For
example, the following group of properties (stored in the file
"<code class="literal">http-adapter.properties</code>") are grouped with the alias "<code class="literal"><span class="emphasis"><em>notify</em></span></code>":</p><pre class="programlisting">http.notify.url=http://www.acme.com/notify.do
http.notify.method=POST
http.notify.body.one=ParameterOne
http.notify.body.two=ParameterTwo
http.notify.code.error=500,501
http.notify.response.ok=&lt;span&gt;OK&lt;/span&gt;</pre><p>In the model, the following state would then perform the HTTP call defined by
these properties:</p><pre class="programlisting">model.login.state.50.name=do.http
model.login.state.50.property=notify</pre><p>or, alternatively</p><pre class="programlisting">model.login.state.50.name=do.http
model.login.state.50.param.alias=notify</pre><p><span class="strong"><strong>NOTE:</strong></span> There are very minor differences between custom HTTP calls performed
with <code class="literal">"do.http"</code> and a custom alias, or the call performed during <code class="literal">"do.auth"</code>
with the <code class="literal">".auth."</code> alias:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
In the <code class="literal">"do.auth"</code> state, the alias is optional. If none is provided in the
model state (e.g. <code class="literal">"property=somethign"</code>, it will automatically fall back on
the default alias <code class="literal">"auth"</code> and use the corresponding properties.
</li><li class="listitem">
The HTTP call property <code class="literal">".credentials"</code> is mandatory during a <code class="literal">"do.auth"</code>
model state execution, but optional in a <code class="literal">"do.http"</code> state. But IF it is used
in a <code class="literal">"do.http"</code> call, that call will mark the specified credentials as
verified upon successful completion of the HTTP call, which means this will
basically be an authentication step similar to the one performed in <code class="literal">"do.auth"</code>.
</li></ul></div><p><span class="strong"><strong>IMPORTANT NOTE</strong></span></p><p><span class="emphasis"><em>The alias part of the property name MUST NOT CONTAIN DOTS! For example, a
property like "http.notify.me.url" is not allowed, because it leads to problems
for the SLS to properly recognize which part is the alias. The correct name
would be "http.notify-me.url" instead!</em></span></p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="x123123_using_custom_properties_for_http_do_auth"></a>48.9.1. Using custom properties for "do.auth*" states</h3></div></div></div><p>It is also possible to use a ".property" for a HTTP call in a "do.auth*"-state.
In this case, the HTTP adapter will use the corresponding properties of the
custom action, if - and only if - such properties exist. For example, if the
model states are configured like this:</p><pre class="programlisting">model.login.state.1000.name=do.auth
model.login.state.1000.property=myapp</pre><p>then the HTTP adapter will use the properties with the prefix "http.myapp."
instead of "http.auth.", as far as they are available, e.g.</p><pre class="programlisting"># Use "http.myapp.url" instead of "http.auth.url"
http.myapp.url=http://backend.acme.com/myapp

# Use "http.myapp.credentials" instead of "http.auth.credentials"
http.myapp.credentials=username,password

# etc.</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_failover"></a>48.9.2. Failover</h3></div></div></div><p>Just as with the "http.auth.url" property, multiple URLs can be configured,
separated by comma, for a simple round-robin failover (if the SLS cannot connect
to the HTTP backend system, it will try the next one):</p><pre class="programlisting">http.notify.url=http://one.com,http://two.com</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="http_setting_custom_timeouts"></a>48.9.3. Setting custom timeouts</h3></div></div></div><p>To specify a particular timeout value for a custom HTTP call, set the property
like this:</p><p><span class="strong"><strong><code class="literal">http.<span class="emphasis"><em>&lt;alias&gt;</em></span>.connection.timeout=&lt;number of seconds&gt;</code></strong></span></p><p>Sets the timeout for this connection to the given number of seconds, overriding
the global default timeout value. Example:</p><pre class="screen">http.notify.connection.timeout=10</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_setting_custom_headers"></a>48.9.4. Setting custom headers</h3></div></div></div><p>The HTTP-adapter also offers the possibility to set custom headers which will be
part of the HTTP request. The configuration property for defining a custom
request header looks like this:</p><p><span class="strong"><strong><code class="literal">http.<span class="emphasis"><em>&lt;alias&gt;</em></span>.header.<span class="emphasis"><em>&lt;header-name&gt;</em></span></code></strong></span></p><p>The <code class="literal"><span class="emphasis"><em>&lt;header-name&gt;</em></span></code> part of the property name defines the name of the actual
request header. Example:</p><p><code class="literal">http.<span class="emphasis"><em>notify</em></span>.header.<span class="emphasis"><em>myHeaderName</em></span>=myHeaderValue</code></p><p>This would add the following HTTP header to the call:</p><pre class="screen">myHeaderName: myHeaderValue</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_custom_http_call_example_sms_delivery"></a>48.9.5. Custom HTTP call example: SMS delivery</h3></div></div></div><p>The following example shows a setup for sending HTTP requests to an SMS sending
service.</p><pre class="programlisting">http.sendsms.url=http://www.smsprovider.com/send.asp</pre><p>The URL of the HTTP service of the SMS provider.</p><pre class="programlisting">http.sendsms.method=post</pre><p>The HTTP method, which has to be GET or POST.</p><pre class="programlisting">http.sendsms.code.error=500,503</pre><p>Defines the HTTP response codes which indicate  that something went wrong during
the HTTP call.</p><pre class="programlisting">http.sendsms.body=phone=079123123&amp;msg=hello</pre><p>The HTTP request body. In this case, the body is configured as an unique
parameter. Another option would be to configure key-value pairs as body of the
request:</p><pre class="programlisting">http.sendsms.body.key1=value1
http.sendsms.body.key2=value2</pre><p>The default Content-Type header is "text/plain; charset=UTF-8" if a single body
is defined and "application/x-www-form-urlencoded" if individual parameters are
indicated.</p><p>Alternatively, instead of encoding a complex XML (or any other) POST data
structure into property values, it may be easier to put that data into a
separate template text file which can then be used (see
<a class="link" href="#x12304_Heading3Tarsec_Templates" title="32.8.2. Templates">"Templates"</a> for details).
Example for using the contents of a
configured template file with the alias "<code class="literal">sms</code>":</p><pre class="programlisting"># POST data taken from template file
http.sendsms.body=${function.getTemplateContent('sms')}</pre><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="_authentication_error_check"></a>Authentication Error Check</h4></div></div></div><p>If the custom HTTP call is supposed to perform an operation that is really
considered to be an authentication check, such as verifying a credential, a
property with the suffix ".response.ok" can be configured with a regex which is
used to match the response content against. If the regex matches, the response
is OK; if it doesn’t, an authentication error occurs:</p><pre class="programlisting"># Check response body content
http.sendsms.response.ok=&lt;span&gt;OK&lt;/span&gt;</pre></div></div></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="x10009_Heading1Tarsec_Web_Service_Adapter"></a>Chapter 49. Web Service Adapter</h2></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_introduction_17"></a>49.1. Introduction</h2></div></div></div><p>The Web Service (WS) adapter is a general adapter for making HTTP Web Service (WS) callouts from the SLS. Currently, it
supports XML-based Web Services in a generic way,
with additional support specifically for SOAP-based Web Services.</p><p>The WS adapter extends the HTTP adapter, which allows to inherit features like failover / load-balancing or proxies and more from the
HTTP adapter.</p><p>Web Service requests and responses are generically configured via XML template files, which - for SOAP-based Web
Services - can be prepared using the WSDL tool, a simple Java command line tool, which parses a WSDL and creates base
material for the XML templates and adapter configuration properties.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_features_3"></a>49.2. Features</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
The WS adapter supports HTTP POST callouts with essentially the same features as the HTTP adapter (failover,
  load-balancing, authentication (to the backend), SSL including custom hostname verifiers, HTTP Proxies).
</li><li class="listitem">
The request body can be freely configured using template files and JEXL/Groovy variables and expressions embedded within.
</li><li class="listitem"><p class="simpara">
The response can be mapped in various ways to JEXL/Groovy variables, as well as to different reactions, as follows.
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem">
Placeholders in a response template file or explicit configurations by XPath expressions allow to extract variables
   of different types from the response. Variables can be of type string, number, float or node (for XML node objects),
   or lists of these basic types.
</li><li class="listitem">
HTTP status codes can be mapped to errors and warnings, as in the HTTP adapter.
</li><li class="listitem">
SOAP (1.1/1.2) fault messages are recognized and the fault code value can be mapped to configurable actions: ignore
   (debug log), warn, error. In case of error, the fault code can be mapped to either a technical error, a user error or
   an authentication error.
</li><li class="listitem">
A SLS session object can be created for using with the <code class="literal">&lt;sls:selection&gt;</code> JSP tag and - after the user posted the
   selection - via the <code class="literal">do.select</code> action to automatically create a JEXL/Groovy variable containing an XML subnode
   corresponding to the selected part of the WS response for further processing.
</li><li class="listitem">
A list of JEXL/Groovy commands can be run automatically after a successful call for further generic processing.
</li></ul></div></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_configuration_10"></a>49.3. Configuration</h2></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_environment_prerequisites_2"></a>49.3.1. Environment / prerequisites</h3></div></div></div><p>The WS adapter is able to perform arbitrary HTTP calls to any server. However, be sure to allow the connection through
the specified protocol and port. Both HTTP and HTTPS are usually allowed protocols into a corporate network. In the same
way, the standard ports 80 and 443 are usually open to send requests through them. But if you want to send calls through
non-standard ports, you have to be sure that you are allowed to.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_configuration_11"></a>49.3.2. Configuration</h3></div></div></div><p>The WS adapter is configured through a Java properties file, usually named "<code class="literal">ws-adapter.properties</code>" that must be
installed in the "<code class="literal">WEB-INF</code>" directory of the SLS web application.</p><p>Many settings are inhertited from the HTTP adapter, simply use <code class="literal">ws.*</code> instead of <code class="literal">http.\*</code> to configure these settings.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_connection_timeout_2"></a>49.3.3. Connection Timeout</h3></div></div></div><p>The following property allows to customize the default threshold for connection timeouts:</p><p><span class="strong"><strong><code class="literal">ws.connection.timeout</code></strong></span></p><p><span class="emphasis"><em>Optional:</em></span> Defines the number of seconds after which the call-out will be interrupted if no connection can be made / no
data is received. Defaults to 60 (one minute) if not set. NOTE: A timeout can also be specified for each custom HTTP
call. See <a class="link" href="#ws_setting_custom_timeouts" title="49.5.4. Setting custom timeouts">"Setting custom timeouts"</a> for details.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_maximal_number_of_connections_2"></a>49.3.4. Maximal Number of Connections</h3></div></div></div><p>The following property allows to define the maximal number of connections to use:</p><p><span class="strong"><strong><code class="literal">ws.connection.total.max</code></strong></span></p><p><span class="emphasis"><em>Optional:</em></span> Defines the maximal number of connections to use in the connection
manager pool. Defaults to 400 if not set.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_maximal_number_of_connections_per_route_host_2"></a>49.3.5. Maximal Number of Connections per Route (Host)</h3></div></div></div><p>The following property allows to define the maximal number of connections to use
per route (host):</p><p><span class="strong"><strong><code class="literal">ws.connection.perRoute.max</code></strong></span></p><p><span class="emphasis"><em>Optional:</em></span> Defines the maximal number of connections to use in the connection
manager pool per route (host). Defaults to 400 if not set.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_default_keep_alive_2"></a>49.3.6. Default Keep Alive</h3></div></div></div><p>The following property allows to define the default keepAlive in seconds:</p><p><span class="strong"><strong><code class="literal">ws.connection.keepAlive.default</code></strong></span></p><p><span class="emphasis"><em>Optional:</em></span> Defines the default keepAlive in seconds for keeping an idle
connection open. Only has an effect if the server does not explicitly set
keepAlive via response headers. Defaults to 60 seconds if not set.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_https_ssl"></a>49.3.7. HTTPS / SSL</h3></div></div></div><p>HTTPS / SSL can be configured in almost the same way as for the HTTP adapter (see
<a class="link" href="#x_http_adapter_adoc_HTTPS_SSL" title="48.3.3. HTTPS / SSL/TLS">"HTTPS / SSL"</a> for details). The only difference is that all the
configuration properties must be prefixed with "ws." instead of "http.", like this:</p><p><span class="strong"><strong><code class="literal">ws.ssl.accepted.cns</code></strong></span></p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_proxy_support"></a>49.4. Proxy Support</h2></div></div></div><p>It is possible to define global proxy settings that will then be used by all
WS adapter calls. In addition, for each custom webservice operation, separate proxy
settings can be defined.</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_global_proxy_settings_2"></a>49.4.1. Global Proxy Settings</h3></div></div></div><p>WS proxy support can be configured in almost the same way as for the HTTP adapter (see
<a class="link" href="#x_http_adapter_adoc_Proxy_Support" title="48.7. Proxy Support">"Proxy Support"</a> for details). The only difference is that all the
configuration properties must be prefixed with "ws." instead of "http.", like this:</p><p><span class="strong"><strong><code class="literal">ws.proxy.host</code></strong></span></p><p>instead of</p><p><span class="strong"><strong><code class="literal">http.proxy.host</code></strong></span></p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_custom_ws_action_proxy_settings"></a>49.4.2. Custom WS Action Proxy Settings</h3></div></div></div><p>The following optional properties can be used to have the Webservice adapter use a
certain proxy for one specific custom webservice action. The property names are almost the
same as for the global property settings, only with the additional custom action
alias included. Here is a complete example of a custom webservice call with specific
proxy settings only for this call:</p><pre class="programlisting">ws.restcall.proxy.host=192.168.10.15
ws.restcall.proxy.port=3128
ws.restcall.proxy.realm=simpleauth</pre></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_authentication_realms"></a>49.5. Authentication Realms</h2></div></div></div><p>Authentication realms (used for authenticating proxies or authenticating backends) can be configured in almost the same
way as for the HTTP adapter (see <a class="link" href="#x51261_Heading3Tarsec_Authentication_Realms" title="48.8. Authentication Realms">"Authentication Realms"</a> for details).
The only difference is that all the configuration properties must be prefixed with "ws." instead of "http.", like this:</p><pre class="programlisting">ws.realm.1.id=simpleauth
ws.realm.1.type=basic
ws.realm.1.basicRealm=Sample App
ws.realm.1.username=techuser
ws.realm.1.password=abcd1234</pre><p>Then reference this realm with the ID "simpleauth" as you would do with the
HTTP adapter; for example, to use it for a proxy, configure</p><p><span class="strong"><strong><code class="literal">ws.proxy.realm=simpleauth</code></strong></span></p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_xml_templates_and_ws_call_alias"></a>49.5.1. XML Templates and WS call alias</h3></div></div></div><p><span class="strong"><strong><code class="literal">ws.wscalls.directory</code></strong></span></p><p>Defines the directory that contains the XML templates, either an absolute path or relative to the web application. Example:</p><pre class="programlisting">ws.wscalls.directory=WEB-INF/ws-calls</pre><p>The directory must have the following structure:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p class="simpara">
&lt;ws-calls&gt;/
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p class="simpara">
request-templates/
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: square; "><li class="listitem">
&lt;ws-call-1-alias&gt;.xml
</li><li class="listitem">
&lt;ws-call-2-alias&gt;.xml
</li><li class="listitem">
…
</li></ul></div></li><li class="listitem"><p class="simpara">
response-templates/
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: square; "><li class="listitem">
&lt;ws-call-1-alias&gt;.xml
</li><li class="listitem">
&lt;ws-call-2-alias&gt;.xml
</li><li class="listitem">
…
</li></ul></div></li></ul></div></li></ul></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="_ws_call_alias"></a>WS call alias</h4></div></div></div><p>The WS call alias is used in various configuration properties to configure the WS callout and how to handle the response,
and it is also the name of the XML template files (without extension).</p><p>Aliases generated by the WSDL tool are usually of the form</p><p><code class="literal">&lt;wsdl-file-name&gt;_&lt;operation-name&gt;_soap&lt;soap-version&gt;</code></p><p>where camel case names are converted to lower-case plus underscores, for example for the operation <code class="literal">getABCDById</code> from
the WSDL <code class="literal">GenericABCD</code> the generated alias would be:</p><pre class="screen">generic_abcd_get_abcd_by_id_soap11</pre></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="_xml_response_template_format"></a>XML response template format</h4></div></div></div><p>The format is the same as in normal templates in the SLS, i.e. plain text plus JEXL/Groovy expressions in <code class="literal">${…}</code> resp.
<code class="literal">#{…}</code>. The file is read assuming UTF-8 encoding, then expressions are evaluated and the resulting string is sent as
the request body.</p><p>Very simple sample request template (not SOAP):</p><pre class="screen">&lt;custom&gt;
  &lt;method&gt;getSelection&lt;/method&gt;
  &lt;param name="userid"&gt;
    ${session.getCred('username')}
  &lt;/param&gt;
&lt;/custom&gt;</pre></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="ws_adapter_response_template_format"></a>XML response template format</h4></div></div></div><p>Here is a very simple sample response template (not SOAP):</p><pre class="screen">&lt;select&gt;
  &lt;id&gt;@list_string:selectId@&lt;/id&gt;
  &lt;text&gt;@list_string:selectText@&lt;/text&gt;
  &lt;node&gt;@list_node:selectNode@&lt;/node&gt;
&lt;/select&gt;</pre><p>Strings between <code class="literal">@…@</code> are interpreted as <code class="literal">&lt;variable-type&gt;:&lt;variable-name&gt;</code>.</p><p>The following variable data types are supported:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">string</code>: A text string, e.g. "hello" (Java.lang.String)
</li><li class="listitem">
<code class="literal">number</code>: An integer number, e.g. -15 (Java.lang.Integer)
</li><li class="listitem">
<code class="literal">float</code>: A floating point number, e.g. 0.234 (Java.lang.Double)
</li><li class="listitem">
<code class="literal">node</code>: An XML node object (org.w3c.dom.Node)
</li><li class="listitem">
<code class="literal">list_string</code>: A list of strings (List&lt;String&gt;)
</li><li class="listitem">
<code class="literal">list_number</code>: A list of numbers
</li><li class="listitem">
<code class="literal">list_float</code>: A list of floating point numbers
</li><li class="listitem">
<code class="literal">list_node</code>: A list of nodes
</li></ul></div><p>Technically, the placeholders are mapped to rules for mapping an XML XPath to a variable. For  example, the first
placeholder above implicitly defines a rule that maps the XPath <code class="literal">/select/id</code> to a variable <code class="literal">selectId</code>, which is a list
of strings.</p><p>The following response body would result in a variable <code class="literal">selectId</code> which contains three items, the numbers 1 to 3 as strings.</p><pre class="screen">&lt;select&gt;
  &lt;id&gt;1&lt;/id&gt;
  &lt;text&gt;Application A&lt;/text&gt;
  &lt;node&gt;
    &lt;sub&gt;
      &lt;key&gt;12345&lt;/key&gt;
    &lt;/sub&gt;
  &lt;/node&gt;
  &lt;id&gt;2&lt;/id&gt;
  &lt;text&gt;Application B&lt;/text&gt;
  &lt;node&gt;
    &lt;sub&gt;
      &lt;key&gt;998877&lt;/key&gt;
    &lt;/sub&gt;
  &lt;/node&gt;
  &lt;id&gt;3&lt;/id&gt;
  &lt;text&gt;Application C&lt;/text&gt;
  &lt;node&gt;
    &lt;sub&gt;
      &lt;key&gt;55555&lt;/key&gt;
    &lt;/sub&gt;
  &lt;/node&gt;
&lt;/select&gt;</pre><p>In case where a node contains subnodes that are to be mapped to variables, the node itself can be mapped itself to a
variable with the special attribute "slsvariable":</p><pre class="screen">&lt;select slsvariable="node:mySelection&gt;
&lt;id&gt;@list_string:selectId@&lt;/id&gt;
&lt;text&gt;@list_string:selectText@&lt;/text&gt;
&lt;node&gt;@list_node:selectNode@&lt;/node&gt;
&lt;/select&gt;</pre><p>For the sample response body further above, a variable with name "mySelection" of type "node" would have been created with a
value that is the &lt;select&gt; node, i.e. the node for the complete xml response.</p><p><span class="strong"><strong><code class="literal">ws.&lt;alias&gt;.var.&lt;type&gt;.&lt;name&gt;</code></strong></span></p><p>For cases where it is not possible or not desired to define the rules with placeholders, rules for mapping an XPath to a
variable can also be indicated explicitly. The value of the property is the XPath. Example:</p><pre class="programlisting">ws.sample_alias.var.list_string.selectId=/select/id</pre><p>Rules are read and processed from configuration at SLS startup. If errors occur, they are logged, but reading of rules
normally proceeds until all rules have been processed. Only then the SLS stops if errors occurred, in order to make it
easier to maintain the rules.</p><p>Common misconfigurations in rules are:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
Illegal variable type (e.g. list_sting)
</li><li class="listitem">
Two rules for the same XPath (if same alias)
</li><li class="listitem">
Two rules for the same variable name (if same alias)
</li></ul></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_ignore_empty_response_nodes"></a>49.5.2. Ignore empty response nodes</h3></div></div></div><p>By default, when a "string" variable has been configured for a certain XML node
in the SOAP response, the SLS will create or update that variable if the given
node exists, even if the node’s value is empty. In some use-cases, it makes sense
that variables in the session should only be updated if the XML node actually had
a value. For this case, the following configuration property can be set:</p><p><code class="literal">xpath.ignore.empty.nodes=true</code></p><p>It defaults to <code class="literal">false</code> if not set. If set to <code class="literal">true</code>, XML response nodes with empty
values will be ignored, and not update the corresponding JEXL/Groovy variables.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_do_wscall_action"></a>49.5.3. do.wscall action</h3></div></div></div><p>Besides the template directory, only two properties are mandatory to use the WS adapter with the <code class="literal">do.wscall</code> action:</p><p><span class="strong"><strong><code class="literal">ws.&lt;alias&gt;.url</code></strong></span></p><p>The URL for the callout, see HTTP adapter</p><p><span class="strong"><strong><code class="literal">ws.&lt;alias&gt;.backendsMode</code></strong></span></p><p>Allows to configure which mode of backend-handling to use (simple failover,
failover with a primary system or load-balancing).</p><p>The <span class="strong"><strong>criterion for backend availability</strong></span> is the same as for the HTTP adapter:
Could connect to the server and the server returned an HTTP response
(with any status code, including 500).
Note that query parameters ("?abc=def") are removed from the URL before making
the callout when checking for backend availability.</p><p>Please see chapter <a class="link" href="#x12345_Heading1Tarsec_loadbalancing_failover" title="Chapter 27. Load-Balancing / Failover">"Load-Balancing / Failover"</a> for details
about failover and load-balancing.</p><p><span class="strong"><strong><code class="literal">ws.&lt;alias&gt;.code.error</code></strong></span></p><p>The HTTP status codes to treat as an error, see HTTP adapter</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="ws_setting_custom_timeouts"></a>49.5.4. Setting custom timeouts</h3></div></div></div><p>To specify a particular timeout value for a webservice call, set the property
like this:</p><p><span class="strong"><strong><code class="literal">ws.&lt;alias&gt;.connection.timeout=&lt;number of seconds&gt;</code></strong></span></p><p>Sets the timeout for this connection to the given number of seconds, overriding
the global default timeout value. Example:</p><pre class="screen">ws.sample_alias.connection.timeout=10</pre><p><span class="strong"><strong><code class="literal">ws.&lt;alias&gt;.header.&lt;name&gt;</code></strong></span></p><p>Additional request headers can optionally be set, see HTTP adapter.</p><p>SOAP 1.1 example:</p><pre class="screen">  ws.sample_alias.header.Content-Type=text/xml;charset=UTF-8
  ws.sample_alias.header.SOAPAction=http://acme.org/Xyz</pre><p>SOAP 1.2 example (with action):</p><pre class="screen">  ws.sample_alias.header.Content-Type=application/soap-xml;charset=UTF-8
  ws.sample_alias.header.action=http://acme.org/Xyz</pre><p>The <code class="literal">do.wscall</code> action has a single mandatory property (resp. parameter with name "alias"), namely the alias of the WS
call. Example:</p><pre class="programlisting">model.login.state.3.name=do.wscall
model.login.state.3.property=sample_alias</pre><p>The callout is processed roughly as follows:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
Read request template and evaluate expressions
</li><li class="listitem">
Make HTTP callout
</li><li class="listitem"><p class="simpara">
Create the following JEXL/Groovy variables:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem">
<code class="literal">ws.request</code>: The HTTP request body as a string.
</li><li class="listitem">
<code class="literal">ws.response</code>: The HTTP response body as astring.
</li><li class="listitem">
<code class="literal">ws.response.headers</code>: Map of HTTP response headers, where the map key is the header name, converted to lower-case
and <span class="emphasis"><em>-</em></span> converted to <span class="emphasis"><em>_</em></span>, e.g. <span class="emphasis"><em>Content-type</em></span> becomes <span class="emphasis"><em>content_type</em></span>.
</li><li class="listitem">
<code class="literal">ws.response.statuscode</code>: HTTP response status code.
</li><li class="listitem">
<code class="literal">ws.soap.fault.value</code>: The SOAP fault code value, if any.
</li></ul></div></li><li class="listitem">
Process SOAP fault, if any (processing may end here).
</li><li class="listitem">
Process HTTP status code (processing may end here).
</li><li class="listitem">
Process rules, i.e. get data via XPath expressions from the response and create the respective variables.
</li><li class="listitem">
Process configured actions, if any are configured.
</li><li class="listitem">
Create session variables for the <code class="literal">&lt;sls:selection&gt;</code> JSP tag, if any are configured.
</li></ul></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_actions_after_ws_call"></a>49.5.5. Actions after WS call</h3></div></div></div><p><span class="strong"><strong><code class="literal">ws.&lt;alias&gt;.action.&lt;no&gt;</code></strong></span></p><p>A list of JEXL/Groovy actions to perform after a successful WS call. The actions will be performed in order of the
<code class="literal">&lt;no&gt;</code> number assigned to them.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_soap_fault_mapping"></a>49.5.6. SOAP fault mapping</h3></div></div></div><p>The fault code value of a SOAP fault can be detected automatically and depending on the fault, different reactions can
be configured. The XPaths to extract the fault code value are as follows, for SOAP 1.1 resp. SOAP 1.2:</p><pre class="screen">/Envelope/Body/Fault/faultcode
/Envelope/Body/Fault/Code/Value</pre><p>The default behaviour for faults is to log a warning.</p><p><span class="strong"><strong><code class="literal">ws.fault.default</code></strong></span></p><p>With this setting, the default behaviour for all aliases can be changed. Possible values are <code class="literal">ignore</code> (debug log entry),
<code class="literal">warn</code> and <code class="literal">error</code>.</p><p><span class="strong"><strong><code class="literal">ws.&lt;alias&gt;.fault.default</code></strong></span></p><p>With this setting, the default behaviour can be overridden for the given alias. Same possible values as above.</p><p><span class="strong"><strong><code class="literal">ws.&lt;alias&gt;.techFaults</code></strong></span></p><p><span class="strong"><strong><code class="literal">ws.&lt;alias&gt;.userFaults</code></strong></span></p><p><span class="strong"><strong><code class="literal">ws.&lt;alias&gt;.authFaults</code></strong></span></p><p>In the case where <code class="literal">error</code> is configured, specific fault code values can be mapped to different types of errors, namely
technical error (SLSException), user error (UserException) and authentication error (AuthenticationException). The
default is a technical error.</p><p>For each setting, a comma separated list of fault code values can be given. Example:</p><pre class="screen">   ws.sample_alias.userFaults=xy:IllegalUserName,xy:NoPassword</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_selection_with_lt_sls_selection_gt_and_do_select_action"></a>49.5.7. Selection with &lt;sls:selection&gt; and do.select action</h3></div></div></div><p>To simplify user selections from a list of options returned by a Web Service, there are configuration properties that
allow to easily create the necessary data to use the <code class="literal">&lt;sls:selection&gt;</code> JSP tag, plus a new action <code class="literal">do.select</code> to process
the user selection.</p><p><span class="strong"><strong><code class="literal">ws.&lt;alias&gt;.select.session.&lt;key&gt;.id</code></strong></span></p><p><span class="strong"><strong><code class="literal">ws.&lt;alias&gt;.select.session.&lt;key&gt;.text</code></strong></span></p><p><span class="strong"><strong><code class="literal">ws.&lt;alias&gt;.select.session.&lt;key&gt;.node</code></strong></span></p><p>These three settings define the data for the selection:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">id</code>: A <code class="literal">list_string</code> of IDs; an item from this list will be the posted selection. This setting is optional, if not
present, IDs 0, 1, 2, and so on will be posted.
</li><li class="listitem">
<code class="literal">text</code>: A <code class="literal">list_string</code> of texts; this is what that the user will see in the selection.
</li><li class="listitem">
<code class="literal">node</code>: A <code class="literal">list_node</code> of XML node objects; the selected node will be available after the <code class="literal">do.select</code> action.
</li></ul></div><p>The values of these settings must be the <span class="emphasis"><em>name</em></span> of a variable created by a mapping rule, either from template or explicit
rule setting.</p><p>Example properties:</p><pre class="screen">  ws.sample_alias.select.session.selectlist.id=selectId
  ws.sample_alias.select.session.selectlist.text=selectText
  ws.sample_alias.select.session.selectlist.node=selectNode</pre><p>unless you want to determine the variable name dynamically.</p><p>Example XML response template:</p><pre class="screen">&lt;select&gt;
&lt;id&gt;@list_string:selectId@&lt;/id&gt;
&lt;text&gt;@list_string:selectText@&lt;/text&gt;
&lt;node&gt;@list_node:selectNode@&lt;/node&gt;
&lt;/select&gt;</pre><p>The <code class="literal">&lt;sls:selection&gt;</code> JSP tag must then simply refer to the key. (Technically, the three properties cause an object to
be stored in the SLS session under the configured key, which the tag then uses.)</p><p>Example usage of the JSP tag:</p><pre class="screen">&lt;sls:selection
name="selection"
listKey="session.selectlist"
type="list"&gt;
&lt;/sls:selection&gt;</pre><p>The next model step after showing the JSP is then normally the <code class="literal">do.select</code> action. It has two mandatory parameters:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">id</code>: The value given in the name attribute of the JSP tag, i.e. the name of the posted parameter.
</li><li class="listitem">
<code class="literal">listkey</code>: The list key.
</li></ul></div><p>Example:</p><pre class="programlisting">model.login.state.5.name=do.select
model.login.state.5.param.id=select
model.login.state.5.param.listkey=session.selectlist</pre><p>The result of the selection is stored in a JEXL variable called <code class="literal">selection</code> which is a map which contains the following
fields:</p><p>XML Namespace Issues</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">id</code>: The id, i.e. the posted parameter value.
</li><li class="listitem">
<code class="literal">text</code>: The text that the user selected.
</li><li class="listitem">
<code class="literal">node</code>: The XML node object (org.w3c.dom.Node); this is the raw data, but relatively cumbersome to use - usually it is
much easier to use the <code class="literal">gpath</code> field instead.
</li><li class="listitem">
<code class="literal">xml</code>: The node object in text form, complete with XML declaration <code class="literal">&lt;?xml …?&gt;</code> and Namespaces. Theoretically, this
field can be null if creating the text from the node object failed, but in practice this should normally not be the case.
Note that the text can span multiple lines, depending on the contents of the node object.
</li><li class="listitem">
<code class="literal">gpath</code>: The node object in form of a Groovy <code class="literal">GPathResult</code> object, which allows to handle the node very easily in
Groovy expressions and scripts. Theoretically this field can be null, if creating the object failed, but in practice
this should normally not be the case.
</li></ul></div><p>Example usage in Groovy:</p><pre class="screen">  #{function.setVariable(\'key\', selection.gpath.sub.key.text())}</pre><p>This gets the tag &lt;sub&gt; of the selection node, then its subtag &lt;key&gt; and finally the text value of that &lt;key&gt; tag.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_xml_processing_with_groovy"></a>49.5.8. XML processing with Groovy</h3></div></div></div><p>An XML document in text form can be parsed into a Groovy GPathResult as follows:</p><pre class="screen">#{def gpath = new XmlSlurper().parseText(text)}</pre><p>For example, you could use the whole WS response or use the JEXL function nodeToXmlString() to process a node variable
from a rule:</p><pre class="screen">def gpath1 = new XmlSlurper().
parseText(var('ws.response'))
def gpath2 = new XmlSlurper().
parseText(function.nodeToXmlString(someNode))</pre><p>See e.g. here for some more advanced uses of GPathResult:</p><p><a class="ulink" href="http://groovy.codehaus.org/Reading+XML+using+Groovy%27s+XmlSlurper" target="_top">http://groovy.codehaus.org/Reading+XML+using+Groovy%27s+XmlSlurper</a></p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_soap_xpath_namespace_issues"></a>49.6. SOAP / XPath Namespace Issues</h2></div></div></div><p>Sometimes, the XML response template generated by the WSDL tool may contain different namespace prefixes than the actual
SOAP response sent back from the web service (depending on what kind of framework was used to implement the web service).</p><p>In a case like that, the XPath handler in the SLS will fail with an exception which indicates that the XPath expression
(generated based on the local response template) contained prefixes for which there were no namespace definitions in the
SOAP response. There are two ways to address this issue:</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_fix_the_local_template"></a>49.6.1. Fix the local template</h3></div></div></div><p>If the SOAP response really contains XML nodes of the same name, for which a namespace prefix MUST be used in order to
correctly match them, then there is no other way than to adapt the local template to the SOAP response. i.E., changing
the namespace prefixes in the response template until they match the responses from the server.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_disable_namespace_handling_altogether"></a>49.6.2. Disable namespace handling altogether</h3></div></div></div><p>In most cases, the easiest way is to simply disable namespaces in the SLS Web Service Adapter, by setting this
configuration property:</p><p><span class="strong"><strong><code class="literal">ws.adapter.ignore.namespaces</code></strong></span></p><p><span class="emphasis"><em>Optional</em></span>: If set to "<code class="literal">true</code>", all namespace definitions and prefixes are removed from the XPath expression which the
SLS generates based on the local response templates, as well as from the SOAP response before processing it. That way,
most namespace conflict issue can easily be eliminated. Defaults to "<code class="literal">false</code>".</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_fault_response_logging"></a>49.6.3. Fault Response Logging</h3></div></div></div><p>It is possible to enable logging of the entire response body on log level "ERROR"
if the response contained a SOAP fault (which basically resembles a technical
error in the SOAP backend):</p><p><span class="strong"><strong><code class="literal">ws.soap.fault.log</code></strong></span></p><p><span class="emphasis"><em>Optional</em></span>: If set to "<code class="literal">true</code>", the SOAP response body will be logged on level
"ERROR" if the response contained a SOAP fault (defaults to "<code class="literal">false</code>").</p><p><span class="strong"><strong><code class="literal">ws.soap.fault.log.filter</code></strong></span></p><p><span class="emphasis"><em>Optional</em></span>: If the property <code class="literal">ws.soap.fault.log</code> is set to <code class="literal">true</code>, this additional
property allows to define a comma-separated list of values that should be filtered
from the log output, in the same way the value of the password credential is usually
filtered from the SLS log output. For example, if the request template contained
a JEXL variable <code class="literal">userAccountNumber</code> which contains a sensitive account number, the
property would need to be set like this:</p><pre class="screen">ws.soap.fault.log.filter=#{userAccountNumber}</pre><p>The log mechanism will then evaluate this variable immediately before logging the
request and response body, and hide every occurence of the resulting value found
in either one (the values will be replaced with a string "[hidden]").</p><p>Multiple values can be defined separated by comma, e.g.</p><pre class="screen">ws.soap.fault.log.filter=#{userAccountNumber},#{userSocialSecurityNumber}</pre></div></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="x51438_Heading1Tarsec_LDAP_Adapter"></a>Chapter 50. LDAP Adapter</h2></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_introduction_18"></a>50.1. Introduction</h2></div></div></div><p>This LDAP adapter may be used within the Secure Login Service Framework. It allows to perform authentication, mapping and password change using an LDAP back-end server.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_authentication_2"></a>50.2. Authentication</h2></div></div></div><p>The LDAP-adapter supports two different types of authentication "bind authentication" and "Comparison authentication".</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="x79706_Heading3Tarsec_Bind_Authentication"></a>50.2.1. Bind Authentication</h3></div></div></div><p>This option uses the credentials (ID and password) provided by the user in the login page to bind to the LDAP directory server. This is the most basic and simple way of authenticating a user. Optionally, an additional search can be performed after the bind in order to make sure that the user also exists in a certain directory tree. This allows to generally restrict access to a group of people.</p><p>This type of authentication is used often, for example, with a Microsoft Active Directory, where this authentication uses the user's credentials to authenticate against a Windows domain controller.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="x29120_Heading3Tarsec_Comparison_Authentication"></a>50.2.2. Comparison Authentication</h3></div></div></div><p>In this case, the bind to the directory is performed with a technical user. The login name provided by the user in the login page is used to look up a user object based on a configurable base DN, and then the provided login password is compared with the value of an attribute of the user object.</p><p>The password value may either be an MD5 or SHA1 hash, or a plain text password.</p><p><span class="emphasis"><em>NOTE: This way of performing a password change is very unusual and not the common way to go. It is more of an additional option for the rare case that the actual authentication-functionality of the LDAP back-end system cannot be used for whatever reason.</em></span></p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_password_change"></a>50.3. Password Change</h2></div></div></div><p>The user password can be changed using the LDAP adapter my modifying the user
password attribute. If only default values are used, the configuration is
extremely simple. All that is really needed is an LDAP lookup operation first -
such as an authentication step - and then the "<code class="literal">do.changepassword"</code> step can be
performed in the model to change the password, if the LDAP adapter is set as the
password change adapter.</p><p>See <a class="link" href="#x14791_Heading3Tarsec_Password_Change" title="50.8.9. Password Change">"Password Change"</a> for details on how to configure the password change step.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_mapping"></a>50.4. Mapping</h2></div></div></div><p>Mapping can be achieved with a "<code class="literal">do.mapping</code>" step in the model and the LDAP adapter. All it basically does is perform an additional lookup which also creates an additional JEXL variable that can be used, for example, as the user ID in a login ticket.</p><p>See <a class="link" href="#x94857_Heading3Tarsec_Mapping" title="50.8.10. Mapping">"Mapping"</a> for details on how to configure the mapping  step.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_referral_handling"></a>50.5. Referral Handling</h2></div></div></div><p>An LDAP search result may sometimes (depending on the LDAP service and configuration) contain not only LDAP objects,
but also referrals, which are basically pointers to other objects. By default, these referrals are not supported by
the SLS and will be ignored in a search result. The SLS will log a warning message when it encounters referrals in
a search result, but not follow them.</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_referral_handling_configuration"></a>50.5.1. Referral Handling Configuration</h3></div></div></div><p>It is possible to attempt to change the behavior of the JNDI API in the Java VM by setting the following configuration property:</p><p><span class="strong"><strong><code class="literal">ldap.referral</code></strong></span></p><p>This property can have 3 possible, supported values:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">ignore</code> : With this setting, if the search result contains referrals, the search will abort immediately, only logging
             a warning, but not returning any results (default).
</li><li class="listitem">
<code class="literal">throw</code> : Any referrals in a search result will be ignored at first, until the search results are processed, and then
            an exception will be thrown.
</li><li class="listitem">
<code class="literal">follow</code> : Finally, with this value, the referrals <span class="emphasis"><em>may</em></span> be resolved, but that depends on the JNDI internals and the
             behavior of the LDAP backend. In case that it works, it may have a potentially big negative impact on the
             performance though, so using this is not recommended.
</li></ul></div><p>Example:</p><pre class="programlisting">ldap.referral=follow</pre><p>It is generally advised to not set this property unless there is a good reason to do so. There are other ways to get
around problems with referrals in search results, as outlined below.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_avoiding_referrals_with_ms_ad"></a>50.5.2. Avoiding Referrals with MS AD</h3></div></div></div><p>With Microsoft Active Directory servers, the behavior in regards to referrals is usually depending on the port that
is being used. On the standard LDAP ports (389, 636) the result may contain referrals. If the special, designated
ports 3268 (plain) or 3269 (SSL) are used, no referrals will be returned at all.</p><p>In other words, if problems occur caused by referrals detected in LDAP search results, just switch the port either
from 389 to 3268, or from 636 to 3269, to fix the issue.</p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_custom_ldap_operations"></a>50.6. Custom LDAP Operations</h2></div></div></div><p>It is also possible to perform custom LDAP operations at any point of a login model, where a number of searches, attribute updates / removals / inserts etc. can be performed at any such point.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_environment_prerequisites_3"></a>50.7. Environment / Prerequisites</h2></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_network_protocols_and_ports"></a>50.7.1. Network Protocols and Ports</h3></div></div></div><p>The LDAP adapter requires the following network protocols and ports to be enabled in local firewalls between the SLS and the authentication back-end service:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
TCP over port 389 for its standard communication
</li><li class="listitem">
TCP over port 636 if secure LDAP over SSL is used
</li></ul></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_configuration_12"></a>50.8. Configuration</h2></div></div></div><p>The LDAP adapter is configured through a Java properties file, usually named "<code class="literal">ldap-adapter.properties</code>" that must be installed in the "<code class="literal">WEB-INF</code>" directory of the SLS web application.</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_ldap_character_escaping_injection_prevention"></a>50.8.1. LDAP Character Escaping (Injection Prevention)</h3></div></div></div><p>For reasons of backwards compatibility, the LDAP adapter does not perform any kind of escaping of characters in the configured DN and filter strings. Blocking "evil" characters can be achieved (and often is) through proper filtering in the HSP and / or SLS parameter checker. However, the following property enables escaping of a number of special characters in the dynamic parts of configured LDAP search filters:</p><p><span class="strong"><strong><code class="literal">ldap.enable.escaping</code></strong></span></p><p><span class="emphasis"><em>Optional:</em></span> Set this to "<code class="literal">true</code>" to enable automatic escaping of illegal characters in LDAP search filters. NOTE: Only the dynamic parts of such strings will be escaped, i.e. the ones comprised of JEXL expressions. Defaults to "<code class="literal">false</code>" if not set.</p><div class="note" style="margin-left: 0; margin-right: 10%;"><h3 class="title">Note</h3><p>To escpape characters in LDAP DNs or to escape characters in LDAP search filters with more granularity, use the following JEXL functions instead of the global setting:</p></div><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">ldap.escapeDNValue(String)</code>
</li><li class="listitem">
<code class="literal">ldap.escapeFilterValue(String).</code>
</li></ul></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_jexl_variables"></a>50.8.2. JEXL Variables</h3></div></div></div><p>For general information about using JEXL scripting in SLS configuration files, see chapter <a class="link" href="#x49003_Heading1Tarsec_Expressions" title="Chapter 32. JEXL Expressions">"JEXL Expressions"</a>.</p><p><span class="strong"><strong><code class="literal">${ldap.search.dn}</code></strong></span></p><p>The last DN found in any search can always be referenced in other LDAP operations with the JEXL variable <code class="literal">${ldap.search.dn}</code>.</p><p><span class="strong"><strong><code class="literal">${ldap.search.dns}</code></strong></span></p><p>The last DNs found in any search, IF there were multiple search results. This is usually the case
for group searches. Please note the following facts:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
The variable is a string array
</li><li class="listitem">
The first entry equals the value of <code class="literal">ldap.search.dn</code>
</li><li class="listitem">
The LDAP adapter will only further process the first entry (or <code class="literal">ldap.search.dn</code>) and
  read the attributes of that object.
</li></ul></div><p><span class="strong"><strong><code class="literal">${attribute.ldap.&lt;name&gt;}</code></strong></span></p><p>All attributes of the LDAP object found in the last search can be referenced with JEXL variables that follow this syntax:</p><p><code class="literal">${attribute.ldap.&lt;attribute-name&gt;}</code></p><p>Example for using the value of the user's LDAP attribute "email":</p><p>$<code class="literal">{attribute.ldap.email}</code></p><p>The following example would trigger the HSP reverse proxy to forward a custom HTTP header named "<code class="literal">surname</code>" to the application server after the login. The header would contain the value of the LDAP attribute "<code class="literal">surName</code>" of the authenticated user:</p><pre class="programlisting">app.header.surname=${attribute.ldap.surName}</pre><p><span class="strong"><strong><code class="literal">${ldap.error}</code></strong></span></p><p>Contains the last LDAP error message (the message of the Java "<code class="literal">NamingException</code>" which was thrown internally).</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_multi_value_attributes"></a>50.8.3. Multi-Value Attributes</h3></div></div></div><p>For LDAP multi-value string (!) attributes, the SLS creates array variables (see <a class="link" href="#x77878_Heading3Tarsec_Using_Arrays_Multiple_Value_Variables" title="32.3.12. Using Arrays (Multiple-Value Variables)">"Using Arrays (Multiple-Value Variables)"</a>). This means that the single values of the variable can be referenced by using an index value:</p><p><code class="literal">attribute.ldap.groups.0</code> - The first value of the attribute "groups"</p><p><code class="literal">attribute.ldap.groups.1</code> - The second value of that attribute</p><p><span class="emphasis"><em>NOTE: A bug in the current JEXL implementation might require the use of a workaround to access entries of a multi-value array variable. See <a class="link" href="#x26475_Heading3Tarsec_Array_Handling_Parsing_Bug" title="32.3.9. Array Handling / Parsing Bug">"Array Handling / Parsing Bug"</a> for details.</em></span></p><p>Furthermore, there are various JEXL functions available to work with arrays, as explained in <a class="xref" href="#x77878_Heading3Tarsec_Using_Arrays_Multiple_Value_Variables" title="32.3.12. Using Arrays (Multiple-Value Variables)">Section 32.3.12, “Using Arrays (Multiple-Value Variables)”</a>. Also consult the <a class="link" href="#JEXLGUIDE">[JEXLGUIDE]</a> documentation for a complete reference of available JEXL functions.</p><p><span class="strong"><strong><code class="literal">${parameter.userid}</code></strong></span></p><p>When defining a search DN, the JEXL variable <code class="literal">${parameter.userid}</code> can be used to substitute any part of the search DN with the login ID as entered in the login form.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_search_for_named_attributes"></a>50.8.4. Search for Named Attributes</h3></div></div></div><p>There may be cases where special attributes in an LDAP object will not be returned by a search, unless the LDAP client specifically asks for them. For these cases, an additional configuration property can be set, whose name is the same as the corresponding "<code class="literal">..search</code>"-property, with an additional "<code class="literal">.attributes</code>"-suffix. It may contain one or a comma-separated list of attribute names. For example, if the following property is set for a custom search:</p><pre class="programlisting">ldap.mapping.search=...</pre><p>then this additional property would have the SLS specifically ask for the attribute "email":</p><pre class="programlisting">ldap.mapping.search.attributes=email</pre><p>Depending on the LDAP system, only the requested attribute may be returned, or all attributes of the user. In a case where the "<code class="literal">.search</code>"-property has a numerical suffix, the property for the attributes has the same name as the "<code class="literal">.search</code>"-property without the numerical suffix, followed by the "<code class="literal">.attributes</code>"-suffix, e.g.:</p><pre class="programlisting">ldap.auth.search.1=...
ldap.auth.search.2=...</pre><p>requires this property to specify the attribute names (for both searches):</p><pre class="programlisting">ldap.auth.search.attributes=email,subschemaSubentry</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_sun_jndi_environment_properties"></a>50.8.5. Sun JNDI Environment Properties</h3></div></div></div><p>Please note that the SLS LDAP adapter will generally use all properties with the prefix "com.sun.jndi.ldap." for the environment properties used to create a JNDI LDAP Context object. That way, new functionality in future JNDI releases that can be activated through such properties can also be used with the current LDAP adapter release.</p><p>Specify additional properties like this:</p><pre class="programlisting">com.sun.jndi.ldap.xx.yy.zz=...&lt;value&gt;...</pre><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="_connection_pooling"></a>Connection Pooling</h4></div></div></div><p>The LDAP adapter uses Sun's JNDI LDAP implementation which provides the mechanism for pooling LDAP connections. In order to use this pooling, the following properties can be set:</p><p>Limits the number of connections by configuring (activating) JNDI connection pooling (see Oracle's website at</p><p><a class="ulink" href="http://docs.oracle.com/javase/jndi/tutorial/ldap/connect/pool.html" target="_top">http://docs.oracle.com/javase/jndi/tutorial/ldap/connect/pool.html</a></p><p>for details about these settings).</p><p><span class="strong"><strong><code class="literal">com.sun.jndi.ldap.    connect.pool</code></strong></span></p><p>Enables or disables connection pooling (defaults to "<code class="literal">true</code>").</p><p><span class="strong"><strong><code class="literal">com.sun.jndi.ldap.    connect.pool.maxsize</code></strong></span></p><p>The maximum size of the connection pool (defaults to <code class="literal">50</code>).</p><p><span class="strong"><strong><code class="literal">com.sun.jndi.ldap.    connect.pool.initsize</code></strong></span></p><p>The initial size of the connection pool (defaults to <code class="literal">10</code>).</p><p><span class="strong"><strong><code class="literal">com.sun.jndi.ldap.    connect.pool.prefsize</code></strong></span></p><p>The preferred size of the connection pool (defaults to <code class="literal">20</code>).</p><p><span class="strong"><strong><code class="literal">com.sun.jndi.ldap.    connect.pool.timeout</code></strong></span></p><p>The number of milliseconds that an idle connection may remain in the pool without being closed and removed from the pool (defaults to 600000 ms = 10 minutes).</p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="_read_timeout"></a>Read Timeout</h4></div></div></div><p>See:</p><p><a class="ulink" href="http://docs.oracle.com/javase/tutorial/jndi/newstuff/readtimeout.html" target="_top">http://docs.oracle.com/javase/tutorial/jndi/newstuff/readtimeout.html</a></p><p><span class="strong"><strong><code class="literal">com.sun.jndi.ldap.    read.timeout</code></strong></span></p><p>Sets timeout for LDAP read operations in milliseconds (defaults to 60000 ms = 1 minute).</p></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_ldap_server_url"></a>50.8.6. LDAP Server URL</h3></div></div></div><p>This chapter describes all configuration properties for the LDAP adapter and some simple usage examples.</p><p><span class="strong"><strong><code class="literal">ldap.url</code></strong></span></p><p>Defines the URL of the LDAP directory server. This property is mandatory! It must always be set, even if only custom actions are used. In that case, its value is used as a fallback URL in case the custom URLs are not reachable.</p><p>Example:</p><pre class="programlisting">ldap.url=ldap://ldap.acme.com:389</pre><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="_simple_failover_or_load_balancing"></a>Simple Failover or Load-Balancing</h4></div></div></div><p>To define more than one LDAP directory that should be used as a fall-back in
case the connection to the current directory fails, specify additional LDAP URLs,
each one separated by comma:</p><pre class="programlisting">ldap.url=ldap://ldap.acme.com:389,ldap://ldap-shadow.acme.com:389</pre><p>This will enable simple failover by default. By adding the ".mode" property,
failover with a primary, or load-balancing can be enabled.</p><p>The <span class="strong"><strong>criterion for backend availability</strong></span> is:
Connect with principal username/password was successful,
i.e. a valid password is required;
configuration properties for a specific alias have precedence
over configuration properties without an alias (fallback).</p><p>Example for enabling failover with a primary backend:</p><pre class="screen">ldap.url=ldap://ldap.acme.com:389,ldap://ldap-shadow.acme.com:389
ldap.backendsMode=failoverWithPrimary</pre><p>Or alternatively, enabling load-balancing instead of failover:</p><pre class="screen">ldap.url=ldap://ldap.acme.com:389,ldap://ldap-shadow.acme.com:389
ldap.backendsMode=loadBalancing</pre><p>The default backend mode is <code class="literal">failover</code>, simple round-robin failover.</p><p>Please see chapter <a class="link" href="#x12345_Heading1Tarsec_loadbalancing_failover" title="Chapter 27. Load-Balancing / Failover">"Load-Balancing / Failover"</a> for details
about failover and load-balancing.</p></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_connection_principals"></a>50.8.7. Connection Principals</h3></div></div></div><p><span class="strong"><strong><code class="literal">ldap.principal.<code class="literal"><span class="emphasis"><em>&lt;alias&gt;</em></span></code>
<code class="literal">ldap.password.</code><span class="emphasis"><em>&lt;alias&gt;</em></span></code></strong></span></p><p>In some cases, it is necessary to use a technical user to bind to the directory and perform certain operations. As a general rule, any tech user principal used for a bind to the LDAP server must be specified using two properties:</p><pre class="programlisting">ldap.principal.&lt;alias&gt;=...&lt;username&gt;...
ldap.password.&lt;alias&gt;=...&lt;password&gt;...</pre><p>The <code class="literal">&lt;alias&gt;</code> part of the property names must be the same for the two properties to correspond to the same user. There are some "special" pre-defined aliases that are described in the examples below.</p><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="_default_tech_user_principal"></a>"default" tech user principal</h4></div></div></div><p>If the "comparison" authentication type is used, or some custom LDAP operations are performed, the following property should specify the technical user id for the bind to the LDAP service.</p><pre class="programlisting">ldap.principal.default=...&lt;username&gt;...
ldap.password.default=...&lt;password&gt;...</pre><p>"mapping" technical user principal</p><p>Optionally, a separate technical user "mapping" can be configured for the mapping search operation. If not specified, the "default" principal is used instead.</p><pre class="programlisting">ldap.principal.mapping=...&lt;username&gt;...
ldap.password.mapping=...&lt;password&gt;...</pre></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_authentication_3"></a>50.8.8. Authentication</h3></div></div></div><p><span class="strong"><strong><code class="literal">ldap.auth.type</code></strong></span></p><p>Defines which type of authentication to use (bind or comparison). Allowed values are:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">bind</code> - for "bind" authentication mode (see chapter <a class="link" href="#x79706_Heading3Tarsec_Bind_Authentication" title="50.2.1. Bind Authentication">"Bind Authentication"</a>).
</li><li class="listitem">
<code class="literal">comparison</code> - for "comparison" authentication mode (see chapter  <a class="link" href="#x29120_Heading3Tarsec_Comparison_Authentication" title="50.2.2. Comparison Authentication">"Comparison Authentication"</a>). Note that if this mode is enabled, it is mandatory to also specify a search DN for the look-up of the user object with the password attribute (see configuration  property <a class="link" href="#x89677_Sidehead_NormalTarsec_ldap_auth_search_no">"ldap.auth.search.&lt;no&gt;"</a>).
</li></ul></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="_authentication_bind_principal_dn"></a>Authentication Bind Principal / DN</h4></div></div></div><p><span class="strong"><strong><code class="literal">ldap.auth.bind.principal</code></strong></span></p><p><span class="emphasis"><em>Option 1</em></span>: Allows to use a fixed (known) DN as the credential for the bind. To use the actual client users login credentials instead of the "default" tech user for the bind, set the bind principal name with this property:</p><pre class="programlisting">ldap.auth.bind.principal=...&lt;user DN&gt;...</pre><p><span class="strong"><strong><code class="literal">ldap.auth.bind.dn.</code>+<span class="emphasis"><em>&lt;no&gt;</em></span>+</strong></span></p><p><span class="emphasis"><em>Option 2</em></span>: Search for user DN in several branches. If the DN of the user must first be looked up from a number of LDAP branches, use the following properties <span class="emphasis"><em>instead</em></span> of the previously  mentioned "<code class="literal">ldap.auth.bind.principal</code>":</p><pre class="programlisting">ldap.auth.bind.dn.1=...&lt;first user DN&gt;...
ldap.auth.bind.dn.2=...&lt;second user DN&gt;...
ldap.auth.bind.dn..=...etc...</pre><p>This approach performs the bind as follows:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">
If a specific bind credential has been configured with "<code class="literal">ldap.auth.bind.principal</code>", the bind for searching for these DNs will be performed with that principal and the user's login password. Once a matching DN was found, the user has been authenticated successfully.
</li><li class="listitem">
Otherwise, if a technical "<span class="emphasis"><em>default</em></span>" user has been configured, that "<span class="emphasis"><em>default</em></span>" user will be the bind credential while checking for the existence of each DN. Once a matching DN has been found, that DN will then be used as the credential for a follow-up bind with the user's login password.
</li><li class="listitem">
If no technical "<span class="emphasis"><em>default</em></span>" user was configured, and no specific bind principal was set as described in 1., each of the DNs to be checked will be used as the principal for the bind, with the user's login password. As soon as a bind was successful, it means the right DN was found, and the user was successfully authenticated.
</li></ol></div><p>In short: Either the "<code class="literal">ldap.auth.bind.principal</code>" must be configured, or a list of "<code class="literal">ldap.auth.bind.dn.+<span class="emphasis"><em>&lt;n&gt;</em></span></code>" entries,  but not both!</p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="_microsoft_active_directory_authentication"></a>Microsoft Active Directory Authentication</h4></div></div></div><p>If Windows Domain users are to be authenticated against an Active Directory Server (AD), the bind credential must usually be specified as follows:</p><pre class="programlisting">ldap.auth.bind.principal=&lt;DOMAIN&gt;\&lt;username&gt;</pre><p>Note that the properties described in the following paragraph allow to perform an additional lookup of the actual user DN for this kin d of environment (since the user principal does not represent a valid DN).</p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="_optional_authentication_search"></a>Optional Authentication Search</h4></div></div></div><p>**</p><p>If the bind was not performed using an actual LDAP DN (for instance in case of a Windows AD bind authentication), the following property (or properties) can be used to look up the DN of the authenticated user.</p><div class="note" style="margin-left: 0; margin-right: 10%;"><h3 class="title">Note</h3><p>If such a search is configured, it will be performed in the following two situations:</p></div><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">
If the configured "<code class="literal">ldap.auth.bind.principal</code>" contains the JEXL variable "<code class="literal">${ldap.search.dn}</code>". In that case, the variable <span class="emphasis"><em>might</em></span> not contain a valid value yet, so the search is performed (if configured) <span class="emphasis"><em>before</em></span> the actual bind is performed.
NOTE: In this case, a "<code class="literal">default</code>" tech user must be configured to be used for the pre-authentication search.
</li><li class="listitem">
If the bind was completed successfully, but after it no user DN had been found yet. This is usually the case with the Windows AD authentication setup as described above. So, if no DN is available yet <span class="emphasis"><em>after</em></span> a successful bind authentication, the search is performed (if configured).
</li></ol></div><p><a id="x89677_Sidehead_NormalTarsec_ldap_auth_search_no"></a><span class="strong"><strong><code class="literal">ldap.auth.search.&lt;no&gt;</code></strong></span></p><p>A list of DN / branches to search is configured like this:</p><pre class="programlisting">ldap.auth.search.1=...&lt;first user DN / branch&gt;...
ldap.auth.search.2=...&lt;second user DN / branch&gt;...</pre><p><span class="strong"><strong><code class="literal">ldap.auth.filter</code></strong></span></p><p>These additional searches can also use a filter, if necessary:</p><pre class="programlisting">ldap.auth.filter=...&lt;search filter for all DNs&gt;...</pre><p>The filter is used for all search DNs specified above.</p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="_enforcing_search_result"></a>Enforcing Search Result</h4></div></div></div><p><span class="strong"><strong><code class="literal">ldap.auth.successful. search.required</code></strong></span></p><p>The searches above are optional by default. If no object is found, there will just be no attributes to be used. However, the following property allows to enforce that the searches must return a matching DN:</p><pre class="programlisting">ldap.auth.successful.search.required=true</pre><p>This allows to make sure that the user must also be member of a certain LDAP branch. If the search does not find any matching DN, the authentication will fail at this point.</p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="_comparison_authentication"></a>"Comparison" Authentication</h4></div></div></div><p><span class="strong"><strong><code class="literal">ldap.attribute.password</code></strong></span></p><p>If "<code class="literal">comparison</code>" authentication mode is used, this property defines the name of the user LDAP attribute that holds the password or hash value.</p><p><span class="strong"><strong><code class="literal">ldap.attribute.password. hash</code></strong></span></p><p>Defines the type of password hash ("<code class="literal">MD5</code>" or "<code class="literal">SHA1</code>"). If this property is not set, the password is expected to be stored in plain text in the user's password attribute. Allowed values are:</p></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="x14791_Heading3Tarsec_Password_Change"></a>50.8.9. Password Change</h3></div></div></div><p>The password change functionality that is performed by the LDAP adapter during
the "<code class="literal">do.changepassword</code>" model state can be configured through the following properties.</p><p><span class="strong"><strong><code class="literal">ldap.principal.changepassword</code></strong></span> / <span class="strong"><strong><code class="literal">ldap.password.changepassword</code></strong></span></p><p><span class="emphasis"><em>Optional:</em></span> Tech user "<code class="literal">changepassword</code>" for password change. If not specified,
the "<code class="literal">default</code>" principal is used.</p><p><span class="strong"><strong><code class="literal">ldap.changepassword.search</code></strong></span></p><p><span class="emphasis"><em>Optional:</em></span> Search DN of user object whose password must be changed. NOTE: If
this property is not specified, a lookup must have been performed before; in
that case, the resulting value of the JEXL variable "<code class="literal">${ldap.search.dn}</code>" is used. Example:</p><pre class="programlisting">ldap.changepassword.search=cn=Users,dc=acme,dc=com</pre><p><span class="strong"><strong><code class="literal">ldap.changepassword.filter</code></strong></span></p><p><span class="emphasis"><em>Optional:</em></span> filter for the change password search. Example:</p><pre class="programlisting">ldap.changepassword.filter=(&amp;(group=admin,givenName=*))</pre><p><span class="strong"><strong><code class="literal">ldap.changepassword.attributeName</code></strong></span></p><p><span class="emphasis"><em>Optional:</em></span> Name of the password attribut to update. By default, the attribute "<code class="literal">userPassword</code>" will be used if this property is not specified. Example:</p><p><span class="emphasis"><em>Note:</em></span> Cannot be set per backend if dynamic backends are used. This property only works as a global setting!</p><pre class="programlisting">ldap.changepassword.attributeName=otherPwd</pre><p><span class="strong"><strong><code class="literal">ldap.changepassword.attributeValue</code></strong></span></p><p><span class="emphasis"><em>Optional:</em></span> Value for the updated attribute. For special requirements, this property allows to define fixed values or use any custom JEXL expression to create anything particular. By default, the value of the session credential of type <code class="literal">NEWPASSWORD</code> will be used if this property is not specified. Example:</p><p><span class="emphasis"><em>Note:</em></span> Cannot be set per backend if dynamic backends are used. This property only works as a global setting!</p><pre class="programlisting">ldap.changepassword.attributeValue=${'someFixedPwd'}</pre><p><span class="strong"><strong><code class="literal">ldap.changepassword.isOctet</code></strong></span></p><p><span class="emphasis"><em>Optional:</em></span> Allows to change a user password attribute of type "<code class="literal">octet</code>". This
is the case with Microsoft Active Directory servers. Defaults to "<code class="literal">false</code>".  Example:</p><p><span class="emphasis"><em>Note:</em></span> Cannot be set per backend if dynamic backends are used. This property only works as a global setting!</p><pre class="programlisting">ldap.changepassword.isOctet=true</pre><p><span class="strong"><strong><code class="literal">ldap.changepassword.isAD</code></strong></span></p><p><span class="emphasis"><em>Optional:</em></span> Allows to define if the LDAP server is a Microsoft Active Directory
server. If set to "<code class="literal">true</code>", the LDAP adapter will not perform a simple "<span class="emphasis"><em>modify</em></span>"
operation, but first "<span class="emphasis"><em>delete</em></span>" the password and then "<span class="emphasis"><em>add</em></span>" it again, as
specified by Microsoft:</p><p><a class="ulink" href="http://msdn.microsoft.com/en-us/library/cc223248.aspx" target="_top">http://msdn.microsoft.com/en-us/library/cc223248.aspx</a></p><p>Also, it will automatically treat the attribute as an octet value, so it
is not necessary to set the property "<code class="literal">ldap.changepassword.isOctet</code>" in this case.</p><p><span class="emphasis"><em>Note:</em></span> Cannot be set per backend if dynamic backends are used. This property only works as a global setting!</p><p>Defaults to "<code class="literal">false</code>".  Example:</p><pre class="programlisting">ldap.changepassword.isAD=true</pre><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="_dynamic_backends_considerations_and_limitations"></a>Dynamic Backends Considerations And Limitations</h4></div></div></div><p>Just as with the "<code class="literal">do.auth</code>" states, it is also possible to dynamically select
an LDAP backend with the "<code class="literal">do.changepassword</code>" state. However, only the actual
backend (URL, mode), the search DN and the corresponding connection principal
credentials can be set. Example:</p><p><span class="strong"><strong>Model</strong></span></p><pre class="screen">model.changepwd.state.1000.name=do.changepassword
model.changepwd.state.1000.property=acme</pre><p><span class="strong"><strong>LDAP configuration (AD example)</strong></span></p><pre class="screen"># Backend-specific settings for alias 'acme'
ldap.acme.url=ldap://ad.acme.com:389
ldap.acme.backendMode=loadbalancing
ldap.acme.search=OU=org,OU=acme
ldap.principal.acme=slsuser
ldap.password.acme=pass1234

# The following properties cannot be set per backend
ldap.changepassword.filter=CN=#{session.getCred('username')}
ldap.changepassword.isAD=true
#ldap.changepassword.isOctet=true
ldap.changepassword.attributeName=unicodePwd
ldap.changepassword.attributeValue=#{session.getCred('NEWPASSWORD')}</pre><p><span class="emphasis"><em>Note: It is a known issue and a limitation that the filter property can only
be set globally, while the search property can be set by backend. This is an
obvious inconsistency and may get changed in a future release.</em></span></p></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="x94857_Heading3Tarsec_Mapping"></a>50.8.10. Mapping</h3></div></div></div><p>Mapping the login ID to some other user ID is an optional, additional step to be performed after the actual authentication. Usually, that is not really necessary with LDAP since the lookup during the authentication usually already delivers all attributes of the user (that can then be used for mapping purposes).</p><p>However, if the mapping function is still to be used, it will create a special JEXL variable "<code class="literal">special.mapped.id</code>" which contains the mapped</p><p>user ID.</p><p>To enable this mapping function, the model state "<code class="literal">do.mapping</code>" must be added to the SLS login model in "<code class="literal">sls.properties</code>". Also, mapping must  be configured to use the LDAP adapter by setting this property in "<code class="literal">sls.properties</code>":</p><pre class="programlisting">adapter.mapping=ldap</pre><p>Define the LDAP attribute which should represent the mapped user ID.</p><div class="note" style="margin-left: 0; margin-right: 10%;"><h3 class="title">Note</h3><p>If the following search property is not specified, this will refer to an attribute created by the authentication. But this requires that a search was performed for the authentication. If the user was only authenticated through a simple bind, a search DN must be defined for the mapping, or the mapping step will not work.</p></div><p>If a mapping search is specified, it will refer to an attribute from the result of that search.</p><pre class="programlisting">ldap.mapping.attribute=racfId</pre><p>Optional: search for the mapping step. If this property is not set, the LDAP adapter will simply used the configured mapping value to create the mapped ID based on an attribute found in the authentication lookup. But if it is set, an additional search operation is performed.</p><pre class="programlisting">ldap.mapping.search=_...&lt;search DN&gt;..._</pre><p>Optional: It is possible to define a filter for the mapping search:</p><pre class="programlisting">ldap.mapping.filter=(&amp;(&lt;attribute-name&gt;=&lt;attribute-value&gt;)(&lt;attribute-name&gt;=&lt;attribute-value&gt;))</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_ldap_error_mapping"></a>50.8.11. LDAP Error Mapping</h3></div></div></div><p><span class="strong"><strong><code class="literal">ldap.errorcode.extract. pattern</code></strong></span></p><p>The LDAP adapter allows to map LDAP error codes to custom error messages to be displayed to the user in the login page. The list of LDAP error codes can be found at various website locations such as:</p><p><a class="ulink" href="http://java.sun.com/docs/books/tutorial/jndi/ldap/exceptions.html" target="_top">http://java.sun.com/docs/books/tutorial/jndi/ldap/exceptions.html</a></p><p>However, since the JNDI API unfortunately does not allow to extract the numerical LDAP error code in a well-defined manner, it must be extracted from the error message string as provided the the JNDI API. In order to remain independent of any changes in future JNDI implementations, this extraction mechanism as been implemented using a regular expression mechanism.</p><p>This LDAP code mapping mechanism is inactive by default. It can be  activated by setting the configuration property "<code class="literal">ldap.errorcode.extract.pattern</code>" as described below.</p><p>The following optional property can define a regular expression pattern which matches the LDAP error code in the message text of the LDAP exception (see SLS exception log for an example). The first group in the regex is the error code to extract.</p><p>Recommended default value as tested with JNDI in Java 6 and OpenLDAP:</p><pre class="programlisting">ldap.errorcode.extract.pattern=.*LDAP: error code (\d+) .*</pre><p>In order to define an actual mapping to a custom message,  add a mapping to the "sls-errormap.properties"-file with the prefix <code class="literal">ERR_LDAP_EXCEPTION_</code>.</p><p>Example entry in "<code class="literal">sls-errormap.properties</code>" for displaying the message with the resource key "<code class="literal">ldap.auth.failed</code>" for the LDAP error code 49:</p><pre class="screen">ERR_LDAP_EXCEPTION_49 = ldap.auth.failed</pre><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="_microsoft_active_directory_example"></a>Microsoft Active Directory Example</h4></div></div></div><p>Assuming the LDAP bind operation with a Microsoft AD server resulted in the following exception log entry:</p><p><code class="literal">Caused by: com.usp.sls.toolkit.error.AuthenticationException: [USER] [INVALID_CRED] Invalid credential(s). Reason: <span class="emphasis"><em>Principal was: cn=slsservice,ou=users,dc=testdomain,dc=local, cause: javax.naming.AuthenticationException: [LDAP: error code 49 - 80090308: LdapErr:DSID-0C090334, comment: AcceptSecurityContext error, data <span class="strong"><strong>525</strong></span>, vece]</em></span></code></p><p>Then the following regular expression can be used to extract the actual cause of the error:</p><pre class="programlisting">ldap.errorcode.extract.pattern=.*AcceptSecurityContext error, data *([0-9]+)*, .*</pre><p>The resulting code extracted from the exception message text would be "525". A corresponding entry in the "<code class="literal">sls-errormap.properties</code>" configuration file would then look like this:</p><pre class="screen">ERR_LDAP_EXCEPTION_525 = ldap.auth.failed</pre><p>Which would display the error message defined for the resource key "<code class="literal">ldap.auth.failed</code>" (in the SLS message resource files) in the login page.</p></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_password_policy"></a>50.8.12. Password Policy</h3></div></div></div><p>The following properties define names of LDAP attributes whose values are used to specify a policy for valid passwords, used for the change password and reset password functionality. If these properties  are not set, the SLS internal default password policy mechanism will be used instead (see admin guide for details).</p><p><span class="strong"><strong><code class="literal">ldap.policy.refresh</code></strong></span></p><p>Defines the interval in seconds for refreshing the policy attribute values. The refresh happens during the next login once the interval threshold is reached, and not in a separate thread. The value is specified in number of seconds, default is  once every 24 hours. Set 0 to refresh the policy with every login attempt. Example:</p><pre class="programlisting">ldap.policy.refresh=3600</pre><p><span class="strong"><strong><code class="literal">ldap.policy.dn</code></strong></span></p><p>Defines the DN of the object with the following attributes. Example:</p><pre class="programlisting">ldap.policy.dn=cn=policy,ou=global,o=acme.com</pre><p><span class="strong"><strong><code class="literal">ldap.policy.principal</code></strong></span></p><p>Mandatory: tech user principal and password for accessing the</p><p>policy object. NOTE: It is advised to use the DataProtector/Seal</p><p>to encrypt the password string (see admin guide for details). Example:</p><pre class="programlisting">ldap.policy.principal=techuser
ldap.policy.password=12345678</pre><p><span class="strong"><strong><code class="literal">ldap.policy.maxlen. attribute</code></strong></span></p><p>Name of LDAP attribute which defines the maximum length of a password.</p><p><span class="strong"><strong><code class="literal">ldap.policy.minlen. attribute</code></strong></span></p><p>Name of LDAP attribute which defines the minimum length of a password.</p><p><span class="strong"><strong><code class="literal">ldap.policy.lowercase. attribute</code></strong></span></p><p>Attribute which defines how to handle lower-case characters:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
-1 = must not contain lower-case characters in the password
</li><li class="listitem">
0 = may contain lower-case characters in the password
</li><li class="listitem">
&gt;0 = must at least contain x lower-case characters in the password
</li></ul></div><p><span class="strong"><strong><code class="literal">ldap.policy.uppercase. attribute</code></strong></span></p><p>Name of LDAP attribute which defines how to handle upper-case characters:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
-1 = must not contain upper-case characters in the password
</li><li class="listitem">
0 = may contain upper-case characters in the password
</li><li class="listitem">
&gt;0 = must at least contain x upper-case characters in the password
</li></ul></div><p><span class="strong"><strong><code class="literal">ldap.policy.numeric. attribute</code></strong></span></p><p>Name of LDAP attribute which defines how to handle numeric characters. Values:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
-1 = must not contain numeric characters in the password
</li><li class="listitem">
0 = may contain numeric characters in the password
</li><li class="listitem">
&gt;0 = must at least contain x numeric characters in the password
</li></ul></div><p><span class="strong"><strong><code class="literal">ldap.allowed.chars. attribute</code></strong></span></p><p>Name of LDAP attribute which defines a list of allowed characters for the password. NOTE: It is not advised to allow any non-ASCII special characters. If they have to be used, they must be defined as Unicode, e.g. '\\u0020\'. Example:</p><pre class="programlisting">ldap.allowed.chars.attribute=abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_custom_ldap_operations_2"></a>50.8.13. Custom LDAP Operations</h3></div></div></div><p>The SLS model engine and LDAP adapter allow for execution of any custom LDAP operations during the login model, such as special lookups and/or udpates of user attributes etc. The following operations are available today:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">search</code> - Performs a custom search / lookup
</li><li class="listitem">
<code class="literal">update</code> - Updates an attribute value on an LDAP object
</li><li class="listitem">
<code class="literal">add</code> - Adds an attribute to the LDAP object
</li><li class="listitem">
<code class="literal">delete</code> - Deletes an attribute from the LDAP object
</li><li class="listitem">
<code class="literal">create</code> - Create a new LDAP object, such as a user
</li><li class="listitem">
<code class="literal">remove</code> - Remove an LDAP object
</li></ul></div><p>The following example properties and comments demonstrate how to add a custom
LDAP operation to a simple login model. In the login model in the "<code class="literal">sls.properties</code>"
file, add a step (or several steps) like this:</p><pre class="programlisting">model.login.state.&lt;n&gt;.name=do.ldap
model.login.state.&lt;n&gt;.property=&lt;ldap-config-alias&gt;</pre><p>or, alternatively</p><pre class="screen">model.login.state.&lt;n&gt;.name=do.ldap
model.login.state.&lt;n&gt;.param.alias=&lt;ldap-config-alias&gt;</pre><p>"<code class="literal">do.ldap</code>" is a model state which refers to a generic LDAP action. It can be
used as many times as required. It allows to perform any arbitrary search
operation and / or insertion, update or removal of attributes at any point
during the login process.</p><p>The LDAP configuration properties for such a custom step must be grouped with
an alias which corresponds to the <code class="literal"><span class="emphasis"><em>&lt;ldap-config-alias&gt;</em></span></code>-value as shown in the
examples below.</p><pre class="programlisting">ldap.&lt;ldap-config-alias&gt;.&lt;type&gt;.url=...
ldap.&lt;ldap-config-alias&gt;.&lt;type&gt;.ignoreErrors=true|false
ldap.&lt;ldap-config-alias&gt;.&lt;type&gt;.attribute.1.name=...
ldap.&lt;ldap-config-alias&gt;.&lt;type&gt;.attribute.1.value=...</pre><p>Where <span class="emphasis"><em>&lt;type&gt;</em></span> refers to the LDAP operation, such as "<code class="literal">add</code>", "<code class="literal">delete</code>",
"<code class="literal">create</code>", "<code class="literal">remove</code>" etc. And <span class="emphasis"><em>&lt;ldap-config-alias&gt;</em></span> corresponds with the
alias / property used in the model with the "do.ldap" state. Example:</p><pre class="programlisting"># Perform custom LDAP operation "newUser" in model
model.login.state.100.name=do.ldap
model.login.state.100.property=newUser

# Create new user (operation alias "newUser")
ldap.newUser.create.url=ldap://ldap.acme.com:389
ldap.newUser.create.dn=cn=${session.getCred('username'),dc=acme.com
ldap.newUser.create.ignoreErrors=false
ldap.newUser.create.attribute.1.name=objectClass
ldap.newUser.create.attribute.1.value.1=person
ldap.newUser.create.attribute.1.value.2=organizationalPerson</pre><p>Just as with the default LDAP URL defined in "<code class="literal">ldap.url</code>", it is also possible
to define multiple URLs for a custom action to activate failover support, or
optionally load-balancing, e.g.:</p><pre class="screen"># Multiple URLs for failover support
ldap.newUser.create.url=ldap://ldap.acme.com:389,ldap://ldap2.acme.com:389</pre><pre class="screen">ldap.newUser.create.url=ldap://ldap.acme.com:389,ldap://ldap2.acme.com:389
# Enable load-balancing instead of failover
ldap.newUser.create.backendsMode=loadBalancing</pre><p>More examples can be found in chapter <a class="link" href="#x30459_Heading3Tarsec_Custom_LDAP_Operations" title="50.9.4. Custom LDAP Operations">"Custom LDAP Operations"</a>.</p><p>Please see chapter <a class="link" href="#x12345_Heading1Tarsec_loadbalancing_failover" title="Chapter 27. Load-Balancing / Failover">"Load-Balancing / Failover"</a> for details
about failover and load-balancing.</p><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="_custom_operation_credentials"></a>Custom Operation Credentials</h4></div></div></div><p>It is also possible to use custom credentials for the bind during a custom LDAP operation. To do this, define a corresponding set of properties with the credentials:</p><pre class="programlisting">ldap.principal.&lt;ldap-config-alias&gt;=&lt;username for bind&gt;
ldap.password.&lt;ldap-config-alias&gt;=&lt;password for bind&gt;</pre><p>For example:</p><pre class="programlisting"># Tech user for custom LDAP operation (if not "default")
ldap.principal.something=...&lt;username&gt;...
ldap.password.something=...&lt;password&gt;...</pre></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="_octet_attributes_ad_passwords"></a>Octet Attributes / AD Passwords</h4></div></div></div><p>In a Microsoft Active Directory server, the user passwords are stored in the field "<code class="literal">unicodePwd</code>", but not as simple plain text value. They are stored as octets as described in</p><p><a class="ulink" href="http://msdn.microsoft.com/en-us/library/cc223248.aspx" target="_top">http://msdn.microsoft.com/en-us/library/cc223248.aspx</a></p><p>If a custom LDAP "<code class="literal">update</code>" or "<code class="literal">add</code>" operation aims to change or add the value
of this "<code class="literal">unicodePwd</code>" attribute, the value must therefore be stored as an octet.
To achieve this, the additional custom operation attribute "<code class="literal">isOctet</code>" must be set to "<code class="literal">true</code>", e.g.</p><pre class="screen">ldap.&lt;alias&gt;.update.attribute.1.name=unicodePwd
ldap.&lt;alias&gt;.update.attribute.1.value="${session.getCred('NEWPASSWORD')}"
ldap.&lt;alias&gt;.update.attribute.1.isOctet=true</pre></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="x123123_using_custom_properties_for_ldap_do_auth"></a>Using custom properties for "do.auth*" states</h4></div></div></div><p>It is also possible to use a ".property" for an LDAP call in a "do.auth*"-state.
In this case, the LDAP adapter will use the corresponding properties of the
custom action, if - and only if - such properties exist. For example, if the
model states are configured like this:</p><pre class="programlisting">model.login.state.1000.name=do.auth
model.login.state.1000.property=myapp</pre><p>then the LDAP adapter will use the properties with the prefix "ldap.myapp."
instead of "ldap.auth." (see properties listed below), e.g.</p><pre class="programlisting"># Use "ldap.myapp.url" instead of "ldap.auth.url"
ldap.myapp.url=ldap://backend.acme.com:389</pre><p>Supported properties that can be configured separately to be used in a "do.auth"
state are:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">ldap.&lt;alias&gt;.url</code>
</li><li class="listitem">
<code class="literal">ldap.&lt;alias&gt;.bind.principal</code>
</li><li class="listitem">
<code class="literal">ldap.principal.&lt;alias&gt;</code>
</li><li class="listitem">
<code class="literal">ldap.password.&lt;alias&gt;</code>
</li></ul></div><div class="note" style="margin-left: 0; margin-right: 10%;"><h3 class="title">Note</h3><p>Since it is possible to use JEXL / Groovy expressions in almost every
configuration property except the backend URL, that one together with the
corresponding principal and password properties are really the only ones
that MUST be configured with separate properties with a custom alias, while
things like the bind DN, for example, could be solved by using an expression
for the normal property <code class="literal">ldap.auth.bind.principal</code> directly.</p></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="_fault_tolerance"></a>Fault tolerance</h4></div></div></div><p>In some cases, it might be useful to ignore any errors during attribute updates, deletes or custom LDAP operations. The default value is <code class="literal">update.ignoreErrors=false</code>.
In order to activate this fault-tolerance, set these properties for updates and / or deletes:</p><p><span class="strong"><strong><code class="literal">ldap.&lt;alias&gt;.update.ignoreErrors</code></strong></span></p><p>Globally ignore all attribute update errors. Example:</p><pre class="screen">ldap.&lt;alias&gt;.update.ignoreErrors=true</pre><p><span class="strong"><strong><code class="literal">ldap.&lt;alias&gt;.update.attribute.&lt;no&gt;.ignoreErrors</code></strong></span></p><p>Ignore only errors while updating a certain attribute. Example:</p><pre class="screen">ldap.&lt;alias&gt;.update.attribute.&lt;no&gt;.ignoreErrors=true</pre><p><span class="strong"><strong><code class="literal">ldap.&lt;alias&gt;.delete.ignoreErrors</code></strong></span></p><p>Globally ignore all attribute delete errors. Example:</p><pre class="screen">ldap.&lt;alias&gt;.delete.ignoreErrors=true</pre><p><span class="strong"><strong><code class="literal">ldap.&lt;alias&gt;.delete. attribute.&lt;no&gt;.ignoreErrors</code></strong></span></p><p>Ignore only errors while deleting a certain attribute. Example:</p><pre class="screen">ldap.&lt;alias&gt;.delete.attribute.&lt;no&gt;.ignoreErrors=true</pre></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_microsoft_active_directory_group_searches"></a>50.8.14. Microsoft Active Directory Group Searches</h3></div></div></div><p>One common issue with users and groups in an LDAP directory is the fact that a
group hierarchy may result in a user being member of some groups <span class="emphasis"><em>indirectly</em></span>, for example:</p><p>group "<code class="literal">employees</code>" contains sub-groups "<code class="literal">internal</code>" and "<code class="literal">external</code>". John Doe
is a member of group "<code class="literal">internal</code>", and as such, implicitely also a member of the
"<code class="literal">employees</code>" group. But in the LDAP object entry for John Doe, only the
membership for "<code class="literal">internal</code>" is registered:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
John Doe → memberOf "<code class="literal">internal</code>"
</li><li class="listitem">
"<code class="literal">internal</code>" → memberOf "<code class="literal">employee</code>"
</li><li class="listitem">
Result: John Doe is really member of "<code class="literal">internal</code>" and "<code class="literal">employee</code>"
</li></ul></div><p>In cases like this, it can be difficult to perform a search to find out all the
groups to which a given user belongs, or rather if the user is member of a certain
top-level group such as "<code class="literal">employees</code>", without having to resort to multiple,
potentially very slow, complicated LDAP searches.</p><p>With Microsoft Active Directory, this problem can be solved by using a filter
named <code class="literal">LDAP_MATCHING_RULE_IN_CHAIN</code>:</p><pre class="screen">"memberOf:1.2.840.113556.1.4.1941:="</pre><p>The result of such a search may return multiple LDAP objects (the DN of each group
that was found). This will be stored in the variable <code class="literal">ldap.search.dns</code>, as a string
array, in which each entry holds the DN string of a group.</p><div class="note" style="margin-left: 0; margin-right: 10%;"><h3 class="title">Note</h3><p><code class="literal">ldap.search.dns</code> (with an <code class="literal">s</code>) holds ALL DNs that were found, while the
variable <code class="literal">ldap.search.dn</code> holds only the first search result.</p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="_example_8"></a>Example</h4></div></div></div><p>The following example LDAP custom search properties demonstrate how to use this
filter. The first LDAP operation "<code class="literal">userlookup</code>" retrieves the LDAP object for the user:</p><pre class="programlisting"># Save the result of this query in the "ldap.userlookup.result" variable,
# which will be used below.
ldap.userlookup.url=ldap://msad.intra.net:389
ldap.userlookup.search.1=OU=acme,DC=com
ldap.userlookup.filter.1=(&amp;(sAMAccountName=${session.getCred('username')})(objectClass=user))</pre><p>The next LDAP operation, "<code class="literal">groupcheck</code>", first searches the LDAP entry for the "<code class="literal">employee</code>" group:</p><pre class="programlisting">ldap.groupcheck.url=ldap://msad.intra.net:389
# First LDAP query finds group
ldap.groupcheck.search.1=OU=acme,DC=com
ldap.groupcheck.filter.1=(&amp;(objectClass=group)(CN=employee}))</pre><p>Then a second search is performed which will only return a result, if the user
is member of the group "<code class="literal">employees</code>":</p><pre class="programlisting"># Second LDAP query finds whether user is in group or not.
ldap.groupcheck.search.2=${ldap.userlookup.result}
ldap.groupcheck.filter.2=(&amp;(objectClass=person)(memberOf:1.2.840.113556.1.4.1941:=${ldap.search.dn}))</pre><p>This allows to check for the membership in a certain group, even if the user
object itself does not directly contain that information.</p></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_examples_3"></a>50.9. Examples</h2></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_authentication_4"></a>50.9.1. Authentication</h3></div></div></div><p>The following paragraphs demonstrate how to set certain configuration properties
in order to use a specific kind of authentication.</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
The following examples also assume that there are four branches in the LDAP
directory which contain user objects. One for european and one for american
users, and within each of them one for internal and external users:
</li></ul></div><pre class="screen">cn=..&lt;userid&gt;..,cn=internal,ou=Europe,o=acme.com
cn=..&lt;userid&gt;..,cn=external,ou=Europe,o=acme.com
cn=..&lt;userid&gt;..,cn=internal,ou=USA,o=acme.com
cn=..&lt;userid&gt;..,cn=external,ou=USA,o=acme.com</pre><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
The windows domain for the users in the following example is called
</li></ul></div><pre class="screen">ACMECORP</pre><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
The login ID as entered by the user in the login form can be referenced within the configuration properties using the JEXL variable
</li></ul></div><pre class="screen">${parameter.userid}</pre><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="_simple_bind_non_ad_i"></a>Simple Bind, non-AD I</h4></div></div></div><p><span class="strong"><strong>Goal:</strong></span></p><p>The user is authenticated with the user ID and password entered in the login form. For the sake of this absolutely minimal example, the user is to be expected to be only from the "Europe" branch of the directory tree.</p><p><span class="strong"><strong>Properties:</strong></span></p><pre class="programlisting">ldap.auth.type=bind
ldap.auth.bind.principal=cn=${parameter.userid},cn=internal,ou=Europe,o=acme.com</pre></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="_simple_bind_non_ad_ii"></a>Simple Bind, non-AD II</h4></div></div></div><p><span class="strong"><strong>Goal:</strong></span></p><p>The user is authenticated with the user ID and password entered in the login form. The user must also be an "internal" user, but from either the european or the american branch. The non-AD example:</p><p><span class="strong"><strong>Properties:</strong></span></p><pre class="programlisting">ldap.auth.type=bind
ldap.auth.bind.dn.1=cn=${parameter.userid},cn=internal,ou=Europe,o=acme.com
ldap.auth.bind.dn.2=cn=${parameter.userid},cn=internal,ou=USA,o=acme.com</pre><p>There is another way to achieve the exact same result with AD:</p><pre class="programlisting">ldap.auth.type=bind
ldap.auth.bind.principal=*ACMECORP\${parameter.userid}
ldap.auth.search.1=cn=${parameter.userid},cn=internal,ou=Europe,o=acme.com
ldap.auth.search.2=cn=${parameter.userid},cn=internal,ou=USA,o=acme.com
ldap.auth.successful.search.required=true</pre><p>Why would anyone want to use the second approach? The answer is that it makes sense in a case where the user ID credential for the bind <span class="emphasis"><em>is not an actual DN</em></span>, which is usually the case when a Microsoft Active Directory server is used; see the following paragraphs for details.</p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="_simple_bind_microsoft_ad_i"></a>Simple Bind, Microsoft AD, I</h4></div></div></div><p><span class="strong"><strong>Goal:</strong></span></p><p>The user is authenticated with the user ID and password entered in the login form. The user is also a Windows Domain user.</p><p><span class="strong"><strong>Properties:</strong></span></p><pre class="programlisting">ldap.auth.type=bind
ldap.auth.bind.principal=ACMECORP\${parameter.userid}</pre><p>However, this extra-short configuration has a problem; while it does verify the user's password (and therefore also the existence of the user ID), it does not look up any actual DN in the LDAP tree. And for this reason, this operation also does not find any user attributes.</p><p>Also, it may be desirable to make sure that the user is member of a specific branch in the LDAP tree. For example, there could be separate SLS instances for company employees and for external users (customers, partners). The following paragraphs show how to deal with that.</p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="_simple_bind_microsoft_ad_ii"></a>Simple Bind, Microsoft AD, II</h4></div></div></div><p><span class="strong"><strong>Goal:</strong></span></p><p>The user is authenticated with the user ID and password entered in the login form. The user is also a Windows Domain user. Furthermore, it is ensured that the user object is part of a certain branch - or of one of a number of certain branches - in the LDAP tree. In this example, the user must be an internal user, but may be from Europe or the USA.</p><p><span class="strong"><strong>Properties:</strong></span></p><pre class="programlisting">ldap.auth.type=bind
ldap.auth.bind.principal=ACMECORP\${parameter.userid}
ldap.auth.search.1=cn=${parameter.userid},cn=internal,ou=Europe,o=acme.com
ldap.auth.search.2=cn=${parameter.userid},cn=internal,ou=USA,o=acme.com
ldap.auth.successful.search.required=true</pre></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="_dynamic_selection_of_backend_group_2"></a>Dynamic Selection of Backend Group</h4></div></div></div><p><span class="strong"><strong>Goal:</strong></span></p><p>Select backend group based on some conditions, in the example based on the <code class="literal">Host</code> header of the incoming HTTP request.</p><p><span class="strong"><strong>Properties:</strong></span></p><pre class="programlisting"># Default LDAP URL (AD)
ldap.url=ldap://192.168.10.15:389,ldap://192.168.10.16:389

# Domino LDAP URL
ldap.domino.url=ldap://172.17.10.1:389,ldap://172.17.10.2:389</pre><p><span class="strong"><strong>Login Model:</strong></span></p><pre class="programlisting">model.login.state.1000.name=do.generic-selectBackend
# use Domino LDAP instead of AD for all users from virtual host "something.com"
model.login.state.1000.action.1=#{setVar('backendToUse', '')}
model.login.state.1000.action.2=#{setVar('backendToUse', 'domino')}
model.login.state.1000.action.2.if.1=#{var('header.host') == 'something.com'}
model.login.state.2000.name=do.auth
model.login.state.2000.property=#{backendToUse}</pre></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_password_change_microsoft_ad"></a>50.9.2. Password Change, Microsoft AD</h3></div></div></div><p><span class="strong"><strong>Goal:</strong></span></p><p>The user changes their own password by themselves. They have to
provide both the old and the new password for this.</p><p>This flow can be configured using the password change functionality of the
LDAP adapter. Usually (for other LDAP servers), the password change operation
performs an LDAP <code class="literal">modify</code> operation. But in case of Microsoft AD, it is
necessary to first perform a <code class="literal">delete</code> operation, with the value of the old
password, and then an <code class="literal">add</code> operation with the value of the new password, as
documented by Microsoft:</p><p>SLS configuration:</p><pre class="programlisting">adapter.changepassword=ldap</pre><p>Model configuration:</p><pre class="programlisting">model.login.state.10.name=do.changepassword</pre><p>LDAP configuration:</p><pre class="programlisting">ldap.principal.changepassword=slsadmin
ldap.password.changepassword=pwd1234
# Set DN (either from previous search, or perform new one)
ldap.changepassword.search=${ldap.search.dn}
# Optional: set search filter
ldap.changepassword.attributeName=unicodePwd
ldap.changepassword.isOctet=true
ldap.changepassword.isAD=true</pre><p>The last attribute, "isAD", is important; it causes the LDAP adapter to perform
the aforementioned "<code class="literal">delete</code>" and "<code class="literal">add</code>" operations, instead of a "<code class="literal">modify</code>"
operation.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_password_reset_microsoft_ad"></a>50.9.3. Password Reset, Microsoft AD</h3></div></div></div><p><span class="strong"><strong>Goal:</strong></span></p><p>The password of the user is set to a predefined value by the administrator,
usually because the user forgot his or her password.</p><p>To implement this with a Microsoft AD, the LDAP attribute "<code class="literal">unicodePwd</code>" must be
modified with an actual "<code class="literal">update</code>" operation (as opposed to a "<code class="literal">delete</code>" and
"<code class="literal">add</code>" operation like in the password change flow). Therefore, a custom LDAP
"update" operation is used for this, NOT the regular password change functionality.</p><p>Also, the password attribute must be set as an octet value, and <span class="strong"><strong>must also be
enclosed in double quotes</strong></span>.</p><p>Furthermore, the tech-user principal used for this update operation must
have the permission to update a user password attribute, configured under
"Delegate Control…":</p><p>"Reset user passwords and force password change at next logon"</p><div class="informalfigure"><div class="mediaobject"><img src="ms_ad_pwdreset_perm_1.png" alt="ms_ad_pwdreset_perm_1.png" /></div></div><div class="informalfigure"><div class="mediaobject"><img src="ms_ad_pwdreset_perm_2.png" alt="ms_ad_pwdreset_perm_2.png" /></div></div><p>Model configuration (LDAP alias "pwdreset"):</p><pre class="programlisting">model.login.state.10.name=do.ldap
model.login.state.10.property=pwdreset</pre><p>LDAP configuration:</p><pre class="programlisting"># Credential of tech user with permissions for password reset
ldap.principal.pwdreset=slsadmin
ldap.password.pwdreset=pwd1234
# Define user DN
ldap.pwdreset.update.dn=${ldap.search.dn}
ldap.pwdreset.update.ignoreErrors=false
# Modify the "unicodePwd" attribute
ldap.pwdreset.update.attribute.1.name=unicodePwd
# Ensure it's written as an octet
ldap.pwdreset.update.attribute.1.isOctet=true
# Set value (MUST be encloded in double quotes!)
ldap.pwdreset.update.attribute.1.value="${session.getCred('PASSWORD')}"</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="x30459_Heading3Tarsec_Custom_LDAP_Operations"></a>50.9.4. Custom LDAP Operations</h3></div></div></div><p>Perform a custom LDAP execution step, such as searching, retrieving or adding / updating attributes etc. The complete minimal example login model (note the "<code class="literal">do.ldap</code>" action in state 3, with the "<code class="literal">something</code>"-alias):</p><pre class="programlisting">model.login.uri=/auth
model.login.failedState=get.cred
model.login.state.1.name=get.cred
model.login.state.2.name=do.auth
model.login.state.3.name=*do.ldap
model.login.state.3.property=something
model.login.state.11.name=do.success</pre><p>Corresponding LDAP configuration for the "<span class="emphasis"><em>something</em></span>" custom action(s):</p><pre class="programlisting"># Tech user for custom LDAP operation (if not "default")
ldap.principal.something=...&lt;username&gt;...
ldap.password.something=...&lt;password&gt;...</pre><p><span class="strong"><strong>search entry</strong></span></p><p>A custom search (if only one). Note that the second property with the filter is always optional.</p><pre class="programlisting">ldap.something.search.1=...&lt;search DN&gt;...
ldap.something.filter.1=...&lt;search filter&gt;...</pre><p><span class="strong"><strong>update attribute</strong></span></p><p>Update LDAP attribute "<code class="literal">email</code>" by changing it from its current value to lowercase, and set attribute "<code class="literal">upid</code>" to value "1":</p><pre class="programlisting">ldap.something.update.dn=${ldap.search.dn}
ldap.something.update.ignoreErrors=false
ldap.something.update.attribute.1.name=email
ldap.something.update.attribute.1.value=${function.getVariable('attribute.ldap. email').toLowerCase()}
ldap.something.update.attribute.2.name=upid
ldap.something.update.attribute.2.value=1</pre><p><span class="strong"><strong>add attribute</strong></span></p><p>Add LDAP attribute "<code class="literal">email</code>" with value "user@acme.com":</p><pre class="programlisting">ldap.something.add.dn=${ldap.search.dn}
ldap.something.add.attribute.1.name=email
ldap.something.add.attribute.1.value=user@acme.com</pre><p><span class="strong"><strong>delete attribute</strong></span></p><p>Delete LDAP attribute "<code class="literal">email</code>":</p><pre class="programlisting">ldap.something.delete.dn=${ldap.search.dn}
ldap.something.delete.attribute.1.name=email</pre><p><span class="strong"><strong>create subcontext (DN) entry</strong></span></p><p>Creates a new LDAP object, e.g. a user. Must define all multi-value attributes with all their values.</p><pre class="programlisting">ldap.newUser.create.dn=cn=${session.getCred('username')},ou=acme,dc=com
ldap.newUser.create.ignoreErrors=false
ldap.newUser.create.attribute.1.name=objectClass
ldap.newUser.create.attribute.1.value.1=organizationalPerson
ldap.newUser.create.attribute.1.value.2=person</pre><p><span class="strong"><strong>remove subcontext (DN) entry</strong></span></p><p>Removes (deletes) an LDAP object, e.g. a user.</p><pre class="programlisting">ldap.deleteUser.remove.dn=cn=${session.getCred('username')},ou=acme,dc=com
ldap.deleteUser.remove.ignoreErrors=false</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_more_custom_action_sample_properties"></a>50.9.5. More custom action sample properties</h3></div></div></div><p><span class="strong"><strong><span class="emphasis"><em>Default URL for operation</em></span></strong></span></p><p>While a separate URL can be defined for each subtype of operation (search, update, delete), it is also possible to define a "global" URL for a custom operation with the property "<code class="literal">ldap.+<span class="emphasis"><em>&lt;group-alias&gt;</em></span>.url</code>":</p><pre class="screen">ldap.something.url=...&lt;default URL for operation&gt;...</pre><p><span class="strong"><strong><span class="emphasis"><em>Custom Searches</em></span></strong></span></p><p>How to enumerate custom searches, if more than one DN should be searched</p><pre class="programlisting">ldap.something.search.1.url=...&lt;optional search URL&gt;...
ldap.something.search.1=...&lt;search DN&gt;...
ldap.something.filter.1=...&lt;optional search filter&gt;...

ldap.something.search.2.url=...&lt;optional search URL&gt;...
ldap.something.search.2=...&lt;search DN&gt;...
ldap.something.filter.2=...&lt;optional search filter&gt;...</pre><p><span class="strong"><strong><span class="emphasis"><em>Custom update and delete</em></span></strong></span></p><p>Defining a custom update and delete in one custom operation:</p><pre class="programlisting">ldap.something.update.url=&lt;LDAP url&gt;
ldap.something.update.dn=&lt;dn of object to modify, e.g. ${ldap.search.dn} &gt;
ldap.something.update.ignoreErrors=true | false
ldap.something.update.attribute.1.name=&lt;attribute-name&gt;
ldap.something.update.attribute.1.value=&lt;new value&gt;
ldap.something.update.attribute.1.ignoreErrors=true | false
ldap.something.update.attribute.2.name=&lt;attribute-name&gt;
ldap.something.update.attribute.2.value=&lt;new value&gt;
ldap.something.delete.url=&lt;LDAP url&gt;
ldap.something.delete.dn=&lt;dn of object to delete, e.g. ${ldap.search.dn} &gt;
ldap.something.delete.ignoreErrors=true | false
ldap.something.delete.attribute.1.name=&lt;attribute-name&gt;
ldap.something.delete.attribute.1.ignoreErrors=true | false
ldap.something.delete.attribute.2.name=&lt;attribute-name&gt;</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_multiple_ldap_directories"></a>50.9.6. Multiple LDAP Directories</h3></div></div></div><p>By setting different LDAP URLs for separate custom operations, more than one LDAP directory can be used by one SLS instance. Example model extract:</p><pre class="programlisting">model.login.state.3.name=do.ldap
model.login.state.3.property=updateHere
model.login.state.4.name=do.ldap
model.login.state.4.property=updateThere</pre><p>Corresponding configuration in "<code class="literal">ldap-adapter.properties</code>":</p><pre class="programlisting">ldap.updateHere.update.url=ldap://dir.one.acme.com:389
ldap.updateHere.update.dn=&lt;dn of object to modify, e.g. ${ldap.search.dn} &gt;
ldap.updateHere.update.attribute.1.name=myAttribute
ldap.updateHere.update.attribute.1.value=the new value
ldap.updateThere.update.url=ldap://dir.two.acme.com:389
ldap.updateThere.update.dn=&lt;dn of object to modify, e.g. ${ldap.search.dn} &gt;
ldap.updateThere.update.attribute.1.name=otherAttribute
ldap.updateThere.update.attribute.1.value=the second new value</pre></div></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="_ntlm_adapter"></a>Chapter 51. NTLM Adapter</h2></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_introduction_19"></a>51.1. Introduction</h2></div></div></div><p>The NTLM adapter allows users to perform authentication over the NTLM protocol. This form of authentication is a user friendly solution in a trusted network environment. End users may not have explicitely to log in if they are already authenticated by a Windows Domain Controller.</p><p>The following steps explain how the NTLM login works:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">
A user requests a restricted site.
</li><li class="listitem">
The user is getting redirected from the SES to the SLS.
</li><li class="listitem">
The SLS initiates an NTLM authentication.
</li><li class="listitem">
A challenge from the domain controller will be encrypted by the client with a key derived from the client's password.
</li><li class="listitem">
If the authentication was successful, the SLS grants the requested access rights to the client.
</li></ol></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_features_4"></a>51.2. Features</h2></div></div></div><p>The following features will give you a brief overview of the NTLM Adapters functionalities:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
Windows 2003/XP compatible
</li><li class="listitem">
Support for NTLMv2
</li><li class="listitem">
SSO (Single Sign On)
</li><li class="listitem">
Failover / Load-Balancing
</li></ul></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_known_limitations_2"></a>51.3. Known Limitations</h2></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_netlogon_secure_channel_connection_is_not_supported"></a>51.3.1. "Netlogon secure channel connection" is not supported</h3></div></div></div><p>This is a feature introduced by Microsoft to improve the security of Netlogon
Remote Protocol, and is being enforced in newer AD installations. In such cases,
the NTLM adapter will no longer be able to work correctly. Since NTLM is a
proprietary legacy protocol, support for the feature will not be implemented
anymore in the NTLM adapter.</p><p>In such cases, USP advises to migrate to using the SPNEGO (Kerberos) adapter
instead. See chapter <a class="link" href="#SPNEGO_Adapter_Topic" title="Chapter 55. SPNEGO Adapter">"SPNEGO Adapter"</a> for more
information.</p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_environment_prerequisites_4"></a>51.4. Environment / Prerequisites</h2></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_netlogon_session_computer_account"></a>51.4.1. NETLOGON Session Computer Account</h3></div></div></div><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
The SLS requires a computer account for its connection to the domain controller (see  for details).
</li></ul></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_network_protocols_and_ports_2"></a>51.4.2. Network Protocols and Ports</h3></div></div></div><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
445/TCP — SMB (used here to authenticate against a domain controller)
</li></ul></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="x24188_Heading2Tarsec_Computer_Account_Password_Setup"></a>51.5. Computer Account Password Setup</h2></div></div></div><p>The computer account used for the connection between the SLS and the Windows domain controller also requires a password to be able to connect. However, there seems to be no standard utility for setting the password of a computer account. For this reason, a VB script has been included in the "<code class="literal">tools</code>" directory of the SLS delivery / web application:</p><pre class="screen">tools/vb-scripts/SetComputerAccountPassword.vbs</pre><p>This script must be executed on the domain controller by an administrator. It requires the DN (distinguished name) of the computer account in the Active Directory, e.g.</p><pre class="screen">CN=SLSUSER$,CN=Computers,OU=Acme,OU=Corp</pre><p>So, to set the password, the script can be executed like this:</p><pre class="screen">C:&gt; cscript SetComputerAccountPassword.vbs CN=SLSUSER$,CN=Computers,...</pre></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_configuration_13"></a>51.6. Configuration</h2></div></div></div><p>The NTLM adapter is configured through a property file, usually named "<code class="literal">ntlm-adapter.properties</code>", but some basic settings are made in the "<code class="literal">sls.properties</code>" file.</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_sls_properties_2"></a>51.6.1. sls.properties</h3></div></div></div><p>The following properties are required to use the NTLM adapter for the authentication (certificate verification) and mapping step:</p><pre class="programlisting">adapter.authentication=ntlm
adapter.challenge=ntlm</pre><p>And the following states are required in the login model:</p><pre class="programlisting">model.login.uri=/auth
model.login.failedState=do.generic-ERROR

model.login.state.1000.name=do.ntlminit
model.login.state.2000.name=create.challenge
model.login.state.3000.name=do.ntlmwait
model.login.state.4000.name=do.ntlmauth
model.login.state.5000.name=do.success

model.login.state.8000.name=do.generic-ERROR
model.login.state.8000.action.1=#{response.setHttpStatusCode(401)}
model.login.state.8000.action.2=#{response.setHeader("WWW-Authenticate", "NTLM")}
model.login.state.9000.name=get.usererror</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_error_handling_jsp"></a>51.6.2. Error Handling JSP</h3></div></div></div><p>The model above will show the contents of the "UserError.jsp" if the user entered invalid credentials.
In order to enforce a complete new start of the model for the next request, add the following line to
the end of the JSP in order to forcibly invalidate the current session:</p><pre class="screen">&lt;sls:doJexl expression='${session.invalidate()}' /&gt;</pre><p>This line should be the very last line in the JSP, after all the HTML code. As a result, when the page
is displayed, the SLS login session is invalidated, and when the user sends another request, a new session
will be started to try the login again from scratch.</p><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="_browser_tab_concurrency_issues"></a>Browser Tab / Concurrency Issues</h4></div></div></div><p>Due to it's nature of being a fully automatic multi-step login (takes more than one request / response to complete), the NTLM authentication process can cause problems with clients sending multiple authentication requests concurrently. A typical cause of that would be a web browser with multiple tabs, trying to restore the application session in each tab at startup time.</p><p>Please see chapter <a class="link" href="#x67409_Heading1Tarsec_Concurrency_Issues_with_Browser_Tabs" title="Chapter 13. Concurrency Issues with Browser Tabs">"Concurrency Issues with Browser Tabs"</a> for information about how to deal with this.</p></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_ntlm_adapter_properties"></a>51.6.3. ntlm-adapter.properties</h3></div></div></div><p><span class="strong"><strong><code class="literal">ntlm.dc</code></strong></span></p><p>This property specifies the domain controller thru the DNS or IP address.
It is possible to specify multiple addresses comma seperated. The SLS will
use the domain controller addresses in the order they are listed. If a domain
controller isn't responding, it will use the next available domain controller
in the list. Example:</p><pre class="programlisting">ntlm.dc=hostone.acme.com,hosttwo.acme.com</pre><p><span class="strong"><strong><code class="literal">ntlm.hostname</code></strong></span></p><p>Defines the DNS hostname (simple name, not fully qualified) of the Windows
domain controller host. If multiple domain controllers are specified in the
"<code class="literal">ntlm.dc</code>" property, a corresponding hostname must be specified for each
of them in this property as well, e.g.:</p><pre class="programlisting">ntlm.hostname=hostone,hosttwo</pre><p><span class="strong"><strong><code class="literal">ntlm.backendsMode</code></strong></span></p><p>Allows to enable load-balancing, or failover with a primary system, instead of
simple failover, if multiple AD backends have been configured.</p><p>The <span class="strong"><strong>criterion for backend availability</strong></span> is:
Connect with username/password was successful,
i.e. a valid password is required.</p><p>Example for configuration with multiple hosts for failover support (default):</p><pre class="screen">ntlm.hostname=hostone,hosttwo</pre><p>Or enabling failover with a primary backend:</p><pre class="screen">ntlm.hostname=hostone,hosttwo
ntlm.backendsMode=failoverWithPrimary</pre><p>Or alternatively, enabling load-balancing instead of failover:</p><pre class="screen">ntlm.hostname=hostone,hosttwo
ntlm.backendsMode=loadBalancing</pre><p>The default backend mode is <code class="literal">failover</code>, simple round-robin failover.</p><p>Please see chapter <a class="link" href="#x12345_Heading1Tarsec_loadbalancing_failover" title="Chapter 27. Load-Balancing / Failover">"Load-Balancing / Failover"</a> for details
about failover and load-balancing.</p><p><span class="strong"><strong><code class="literal">ntlm.domain</code></strong></span></p><p>Defines the Windows domain name, e.g.</p><pre class="programlisting">ntlm.domain=ACMECORP</pre><p><span class="strong"><strong><code class="literal">ntlm.user.name</code></strong></span></p><p>The computer account used for the NETLOGON connection between the SLS and the Windows domain controller. NOTE: a computer acocunt name always ends with "$", e.g. "<code class="literal">SLSUSER$</code>". Otherwise, the given account is not a computer account. Also, the account must be specified as <code class="literal">&lt;accountname&gt;@&lt;domain&gt;</code>, e.g.</p><pre class="programlisting">ntlm.user.name=SLSUSER$@ACMECORP.COM</pre><p><span class="emphasis"><em>NOTE: If the account configured here is not a computer account, the legacy NTLM adapter (without NTLMv2 support) will be used!</em></span></p><p><span class="strong"><strong><code class="literal">ntlm.user.password</code></strong></span></p><p>The password of the computer account user. Use the VB script provided in the SLS delivery package to set the password of this account on the domain controller (see <a class="link" href="#x24188_Heading2Tarsec_Computer_Account_Password_Setup" title="51.5. Computer Account Password Setup">"Computer Account Password Setup"</a> for details). The script can be found in the subdirectory  "<code class="literal">tools/vb-scripts</code>" of the delivery archive or the SLS web application.</p><p><span class="strong"><strong><code class="literal">ntlm.max.login.attempts</code></strong></span></p><p>The maximal number of login attemps a user has till the login fails. Supply a number from 1 to 5.</p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_ntlmv2_configuration_example"></a>51.7. NTLMv2 Configuration Example</h2></div></div></div><p>Here is a configuration example for the following setup:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
The domain controller’s IP address is <code class="literal">10.0.1.201</code>
</li><li class="listitem">
The DNS hostname of the domain controller is "dc-acme1" (do NOT use fully qualified name here)
</li><li class="listitem">
The name of the SLS computer (!) account user is "<code class="literal">slsclient$</code>".
</li><li class="listitem">
The Windows domain name is "<code class="literal">AS-TEST</code>"
</li></ul></div><pre class="screen">ntlm.dc=10.0.1.201
ntlm.hostname=dc-acme1
ntlm.user.name=slsclient$
ntlm.user.password=QlG5zK+sC8QGXEQR7ESMWQ==
ntlm.domain=AS-TEST
ntlm.max.login.attempts=3</pre></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_pre_ntlmv2"></a>51.8. Pre-NTLMv2</h2></div></div></div><p>NTLMv1, which was originally developed in 1987 and is by now severely broken
in terms of security, is no longer supported.</p><p><span class="strong"><strong><code class="literal">ntlm.version</code></strong></span></p><p>This setting is ignored. NTLMv1 configurations are recognized by configured
users that neither contain <code class="literal">$@</code> nor end with <code class="literal">$</code>; also for NTLMv2 configuring
a hostname and domain are mandatory.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_ses_configuration"></a>51.9. SES configuration</h2></div></div></div><p>To allow the SLS to send NTLM messages, the HGW_Allow401 SES property is mandatory on the SLS location. Add this property to your configuration in the SRManager and the HttpLstener or HttpsLstener.</p><pre class="screen">&lt;Location /demo/sls/auth&gt;
   HGW_Host                    mydomain.com:14132
   HGW_Allow401
   ...</pre></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_browser_single_sign_on"></a>51.10. Browser Single Sign On</h2></div></div></div><p>Since NTLM works with the Windows credentials, it is possible to configure a Windows client to automatically login. This enables a transparent login and the user doesn't see a login page.</p><p>The configuration is very browser dependent. Please consult the documentation of your browser and version for proper configuration. Following some brief notes about two popular browsers:</p><p><span class="strong"><strong>Internet Explorer</strong></span></p><p>You have to add the site to the trusted Sites in the Browser Preferences.</p><p>In case the SES domain is the same domain as your Windows domain the site is trusted anyway and you don't have to configure anything at all.</p><p><span class="strong"><strong>Firefox</strong></span></p><p>You have to add the site to the trusted Sites in the Browser Preferences. This can be done by using about:config. Just enter about:config in the URL field and press enter. Afterwards, find the propery called +network.automatic-ntlm-auth.trusted-uris+and add the domain name of your SES deployment. You can enter multiple domain names comma seperated.</p></div><div class="glossary"><div class="titlepage"><div><div><h2 class="title"><a id="_glossary"></a>Glossary</h2></div></div></div><p><span class="strong"><strong>NTLM</strong></span></p><p>NTLM employs a challenge-response mechanism for authentication, in which clients are able to prove their identities without sending a password to the server. It consists of three messages, commonly referred to as Type 1 (negotiation), Type 2 (challenge) and Type 3 (authentication).</p><p><span class="strong"><strong>SMB</strong></span></p><p>Server Message Block (SMB) is an application-level network protocol mainly applied to shared access to files, printers, serial ports, and miscellaneous communications between nodes on a network. It also provides an authenticated Inter-process communication mechanism. It is mainly used by Microsoft Windows equipped computers.</p></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="_radius_adapter"></a>Chapter 52. RADIUS Adapter</h2></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_introduction_20"></a>52.1. Introduction</h2></div></div></div><p>The RADIUS adapter allows to carry out RADIUS authentication calls with support for adding custom attributes to the call and receiving custom attributes with the response.</p><p>Custom attributes in the authentication request to the RADIUS server could be used, for example, to send additional credentials (like the NAS-ID) to the RADIUS server. See the following chapter for details.</p><p>The adapter uses the open source Java library "jradius-client" from SourceForge:</p><p><a class="ulink" href="http://jradius-client.sourceforge.net/" target="_top">http://jradius-client.sourceforge.net/</a></p><p><span class="strong"><strong>Challenge / Response</strong></span></p><p>The adapter supports username / password authentication as well as simple challenge / response authentication as defined by RFC 2865:</p><p><a class="ulink" href="http://www.ietf.org/rfc/rfc2865.txt" target="_top">http://www.ietf.org/rfc/rfc2865.txt</a></p><p><span class="strong"><strong>Failover / Load-Balancing</strong></span></p><p>The RADIUS adapter supports simple round-robin failover or load-balancing
between a list of RADIUS server hosts.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_jexl_variables_2"></a>52.2. JEXL Variables</h2></div></div></div><p>All RADIUS response attributes received from the RADIUS server during the authentication callout are available as string variables of the following format in the SLS configuration:</p><pre class="screen">attribute.radius.type&lt;id&gt;</pre><p>Where <code class="literal"><span class="emphasis"><em>&lt;id&gt;</em></span></code> is the numeric RADIUS attribute ID.  The following example shows how to configure the SLS to propagate a custom HTTP header "<code class="literal">RadiusResponse</code>" containing the value of the RADIUS response attribute 14 to the application server after a successful login:</p><pre class="programlisting">app.header.RadiusResponse=${attribute.radius.type14}</pre><p>Furthermore, the numeric code of the last RADIUS response is available in this JEXL variable:</p><pre class="screen">radius.response.type</pre><p>Note that in case of connection problems, this variable may be set to the string "<code class="literal">unknown</code>" (if there was no RADIUS response).</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_configuration_14"></a>52.3. Configuration</h2></div></div></div><p>The RADIUS adapter is configured through a Java properties file, usually named "<code class="literal">radius-adapter.properties</code>". The following paragraphs explain all available configuration properties and values.</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_authentication_5"></a>52.3.1. Authentication</h3></div></div></div><p><span class="strong"><strong><code class="literal">radius.shared.secret</code></strong></span></p><p>The shared secret required to enable the SLS to connect to the RADIUS server. Ask your RADIUS server administrator for the required value.</p><p><span class="strong"><strong><code class="literal">radius.server.acct.port</code></strong></span></p><p>The number of the RADIUS server "accept" port, usually the value is 1813.</p><p><span class="strong"><strong><code class="literal">radius.server.auth.port</code></strong></span></p><p>The number of the RADIUS authentication port, usually the value is 1812.</p><p><span class="strong"><strong><code class="literal">radius.server.host</code></strong></span></p><p>The hostname of the RADIUS server. This property can optionally contain a
comma-separated list of host names. In that case, the adapter will perform
simple round-robin failover by default between these hosts, if one becomes unavailable.
Alternatively, it is possible to enable load-balancing instead.
Note: all other settings (port numbers, shared secret etc.) must be the same
for all hosts in this list.</p><p>The <span class="strong"><strong>criterion for backend availability</strong></span> is:
Got a response from the server when trying to authenticate,
even if the password was wrong.
Typical use case is to define a dummy username/password
just for checking backend availability,
see the corresponding configuration properties <code class="literal">radius.monitor.*</code>
described further below.</p><p>Example for configuration with multiple hosts for failover support (default):</p><pre class="screen">radius.server.host=host.one.com,host.two.com</pre><p>Or enabling failover with a primary backend:</p><pre class="screen">radius.server.host=host.one.com,host.two.com
radius.backendsMode=failoverWithPrimary</pre><p>Or alternatively, enabling load-balancing instead of failover:</p><pre class="screen">radius.server.host=host.one.com,host.two.com
radius.backendsMode=loadBalancing</pre><p>The default backend mode is <code class="literal">failover</code>, simple round-robin failover.</p><p>Please see chapter <a class="link" href="#x12345_Heading1Tarsec_loadbalancing_failover" title="Chapter 27. Load-Balancing / Failover">"Load-Balancing / Failover"</a> for details
about failover and load-balancing.</p><p><span class="strong"><strong><code class="literal">radius.retries</code></strong></span></p><p><span class="emphasis"><em>Optional</em></span>: The number of connection retries. The default value is 3.</p><p><span class="strong"><strong><code class="literal">radius.timeout</code></strong></span></p><p><span class="emphasis"><em>Optional</em></span>: The RADIUS connection timeout in milliseconds (1000 = 1 second).</p><p><span class="strong"><strong><code class="literal">radius.tokencode</code></strong></span></p><p><span class="emphasis"><em>Optional</em></span>: Defines how to handle a 3rd credential token, like a SecurID code or a strike-list number. There are three possible settings:</p><pre class="screen">concat</pre><p>If the property is set to this value, the token will be concatenated to  the password. Note that this is also the default behavior.</p><pre class="screen">&lt;numeric RADIUS attribute ID&gt;</pre><p>If it is set to an integer number that represents a valid RADIUS request attribute, the token will be sent in that RADIUS request attribute.</p><p>If the property is set to the empty string, a third token will be ignored, and only the username and password will be used for authentication.</p><p><span class="strong"><strong><code class="literal">radius.mapping.attribute</code></strong></span></p><p><span class="emphasis"><em>Optional</em></span>: Defines the server response attribute whose value should be used for the mapped user ID. Example:</p><p><code class="literal">radius.mapping.attribute=20</code></p><p>This would create a JEXL variable "<code class="literal">special.mapped.id</code>" (and a credential of semantic type "<code class="literal">MAPPEDID</code>") in the SLS session. The value of the variable (or the credential) would be the value of the RADIUS server response attribute 20 ("<code class="literal">callback_id</code>").</p><p><span class="strong"><strong><code class="literal">radius.request.attr.<span class="emphasis"><em>NO</em></span></code></strong></span></p><p><span class="emphasis"><em>Optional</em></span>: Allows to specify additional, custom RADIUS request attributes to be sent to the RADIUS server. The value of the attribute can be any valid SLS configuration expression (see SLS Administrator's Guide for information about JEXL-based expressions and variables).</p><p>The following example fills the value of the HTTP request header "<code class="literal">hsp-listeneruri</code>" as sent from the SES into the RADIUS attribute 14:</p><pre class="programlisting">radius.request.attr.14=${header.hsp_listeneruri}</pre><p>A typical use case might also be to send a NAS-Identifier (32).</p><p>See e.g. <a class="ulink" href="http://freeradius.org/rfc/attributes.html" target="_top">http://freeradius.org/rfc/attributes.html</a> for a list of all attributes.</p><p><span class="strong"><strong><code class="literal">radius.monitor.username</code></strong></span>
<span class="strong"><strong><code class="literal">radius.monitor.password</code></strong></span></p><p><span class="emphasis"><em>Optional</em></span>: If monitoring of backends is activated (<code class="literal">monitor.check.interval</code> set), all backends
are periodically monitored. The monitor for RADIUS backends tries to perform a "fake" login
with a dummy username and password. The RADIUS server is considered available if
authentication fails (typically the case with dummy credentials) or if it is successful,
but not if the server does not answer or other errors occur.</p><p>Default username and password are both "dummy". However, there can be technical
reasons that cause the RADIUS server not even to answer to login attempts with
these "fake" credentials. In this case, one or both of the above properties
can be used to override the username and/or password to use for monitoring.
Note that normally you would not set a correct password, only one that causes
the RADIUS server to deny access.</p><p><span class="strong"><strong><code class="literal">radius.monitor.request.attr.<span class="emphasis"><em>NO</em></span></code></strong></span></p><p><span class="emphasis"><em>Optional</em></span>: Allows to define arbitrary attributes to send during monitoring.
A typical use case might be to send a NAS-Identifier (32) different from the one
used during authentication in order to signal that the request is from a monitor.
Note that these attributes are only evaluated the first time the monitor checks
the availablility, so JEXL/Groovy expressions can only use things that are
globally available.</p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_radius_challenge_response"></a>52.4. RADIUS Challenge-/Response</h2></div></div></div><p>The RADIUS adapter needs the following states in its login model in order to support both simple username / password and challenge / response authentication:</p><pre class="programlisting"># Login model with support for challenge-/response flow.
model.challengelogin.uri=/auth
model.challengelogin.failedState=get.cred
model.challengelogin.state.10.name=get.cred
model.challengelogin.state.20.name=do.auth
model.challengelogin.state.20.nextState.1=do.success
model.challengelogin.state.20.nextState.1.if=${radius.response.type == '2'}
model.challengelogin.state.30.name=get.cred.challenge
model.challengelogin.state.40.name=do.authresponse
model.challengelogin.state.90.name=do.success</pre><p>Note: In the "<code class="literal">do.authresponse</code>" state, the RADIUS adapter sends the SLS "<code class="literal">challenge</code>" credential (as the RADIUS password), and the username credential to the RADIUS server.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_sls_properties_3"></a>52.5. SLS Properties</h2></div></div></div><p>The following properties must be set in the "<code class="literal">sls.properties</code>" file to use the RADIUS adapter for authentication and challenge / response:</p><pre class="programlisting">adapter.authentication=radius
adapter.mapping=radius
adapter.challenge=radius</pre><p>Note: The "<code class="literal">adapter.mapping</code>" property is only necessary if the model contains a "<code class="literal">do.mapping</code>" step, and the user ID mapping property "<code class="literal">radius.mapping.attribute</code>" has been set.</p></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="_pki_adapter"></a>Chapter 53. PKI Adapter</h2></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_introduction_21"></a>53.1. Introduction</h2></div></div></div><p>The PKI adapter allows to perform authentication using X.509 certificates. It may be deployed in a full PKI environment or in a minimal certificate trust environment.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_features_5"></a>53.2. Features</h2></div></div></div><p>The following features will give you a brief overview of the PKI Adapters functionalities:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
X.509 compliant
</li><li class="listitem">
Certificate validation via OCSP and/or CRLs.
</li><li class="listitem">
CRL caching for local and remote CRLs.
</li><li class="listitem">
Flexible certificate to user mapping.
</li><li class="listitem">
Dynamic selection of trusted CA and OCSP signer certificates as well as
  of CRL and OCSP checks to do during login with configurable trust groups.
</li><li class="listitem">
Support for Microsoft Windows PKI environment.
</li></ul></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_jexl_variable"></a>53.3. JEXL Variable</h2></div></div></div><p>After a successful login, the PKI adapter sets a JEXL variable named "<code class="literal">special.certificate</code>" which holds the X509 certificate object (see <a class="link" href="#x80274_Heading2Tarsec_Special_Variables" title="32.6. Special Variables">"Special Variables"</a> for details).</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_configuration_15"></a>53.4. Configuration</h2></div></div></div><p>The PKI adapter is configured through a property file, usually named "<code class="literal">pki-adapter.properties</code>".</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_srm_location"></a>53.4.1. SRM location</h3></div></div></div><p>There are some settings that have to be adjusted in the SRM configuration. The first is a timeout setting <span class="emphasis"><em>in the server configuration</em></span> (not a virtual host):</p><p><span class="strong"><strong>1. Timeout</strong></span></p><pre class="screen">SE_L1Cds_TimeOutRequestCounterTmo     120</pre><p>The reason is that the user sometimes needs a few seconds to select the appropriate client certificate for the login (based on the browser configuration). If the time gap between the first and second request is too big, a Denial-of-service prevention mechanism of the SRM could invalidate the login session too early, if this timeout setting (default value is 20) is not increased.</p><p>The following settings are to be made within the SLS login location.</p><p><span class="strong"><strong>2. Allow SSL Headers</strong></span></p><p>The following variable must be set in addition to any other headers allowed for the SLS location:</p><pre class="screen">+%HSP_ssl</pre><p>For example:</p><pre class="screen">HGW_RequestHeaders +%SRM_ls_std +%HSP_std +%HSP_ssl</pre><p><span class="strong"><strong>3. URL Query String</strong></span></p><p>Since the SLS performs a redirect to its own URI location during the PKI login process with some additional URL parameter, the query string filter should be set unrestricted for the login location:</p><pre class="screen">AC_StartQueryString          ^.*$</pre><p><span class="strong"><strong>4. Header Size Limit</strong></span></p><p>Some request headers exchanged between SRM and SLS can grow beyond the usual size limit. Because of that, the following directive must be set on the server or virtual host (not the location):</p><pre class="screen">LimitRequestFieldSize       16384</pre><p><span class="strong"><strong>5. Require Mutual Authentication</strong></span></p><p>On the location in question, enable mutual authentication (if it’s not enabled on the virtual host overall):</p><pre class="screen"># Transport Layer Security (SSL/TLS)
Require expr "%{SSL_CLIENT_VERIFY} == 'SUCCESS'"</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_sls_properties_4"></a>53.4.2. sls.properties</h3></div></div></div><p>The following properties are required to use the PKI adapter for the authentication (certificate verification) and mapping step:</p><pre class="programlisting">adapter.authentication=pki
adapter.mapping=pki</pre><p>And the following states are required in the login model:</p><pre class="programlisting">model.login.uri=/auth
model.login.failedState=get.usererror

model.login.state.3.name=do.cert.auth
model.login.state.7.name=do.mapping
model.login.state.9.name=do.success
model.login.state.10.name=get.usererror</pre><p>The PKI credential provider must be activated (check for correct provider numbering based on your current configuration):</p><pre class="programlisting"># PKI Certificate provider
cred.provider._&lt;no&gt;_=certificate
cred.provider._&lt;no&gt;_.cred.1.type=certificate
cred.provider._&lt;no&gt;_.cred.1.source=header
cred.provider._&lt;no&gt;_.cred.1.name=&lt;header-name&gt;</pre><p>Where <code class="literal"><span class="emphasis"><em>&lt;no&gt;</em></span></code> is the number of the credential provider, and <code class="literal"><span class="emphasis"><em>&lt;header-name&gt;</em></span></code> the actual name of the HTTP header containing the client certificate.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_pki_adapter_properties"></a>53.4.3. pki-adapter.properties</h3></div></div></div><p><span class="strong"><strong><code class="literal">pki.trusted.ca.dir</code></strong></span></p><p>A custom directory where the trusted CA certificate files are stored. If no value is supplied, the default directory is <code class="literal">./WEB-INF/trustedCas</code></p><p>(In a CA hierarchy, supply all trusted CA's.)</p><p>You may specify a relative path beginning with a dot from the web application directory. For security reasons make sure you put it into the <code class="literal">/WEB-INF/…</code> directory to keep it private.</p><p><span class="strong"><strong><code class="literal">pki.trusted.ocspsigner.dir</code></strong></span></p><p>A custom directory where certificate files that are trusted as signers of OCSP responses are stored. If no value is supplied, the default directory is <code class="literal">./WEB-INF/trustedOcspSigners</code></p><p>You may specify a relative path beginning with a dot from the web application directory. For security reasons make sure you put it into the +./WEB-INF/…+to keep it private.</p><p><span class="strong"><strong><code class="literal">pki.check.&lt;nr&gt;</code></strong></span></p><p>Certificate validation steps to do. Possible values for identifying the step:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">ocsp</code>  Perform OCSP validation. Fall through to next step if could not obtain a definitive CertStatus of either 'good\' or 'revoked\'.
</li><li class="listitem">
<code class="literal">crl</code>  Perform CRL check.
</li></ul></div><p>If the CRL check is present, it must be the last step. Step numbers must be 1 and up, without gaps (1,2,3,…). Only client certificates will be checked (not CA certificates).</p><p><span class="strong"><strong><code class="literal">pki.crl.check</code></strong></span></p><p>Deprecated setting to enforce CRL checking. Only has an effect if no <code class="literal">pki.check.&lt;nr&gt;</code> settings exist and in that case is equivalent to <code class="literal">pki.check.1=crl</code>, with no further validations steps.</p><p><span class="strong"><strong><code class="literal">pki.validation.timeout</code></strong></span></p><p>Total timeout for all validation steps in seconds. Default is 60.</p><p><span class="strong"><strong><code class="literal">pki.crl.check.ignore.dates</code></strong></span></p><p>Defines if the "issuing date" \&amp; "next update date" should be ignored in all CRLs. This property prevents users from being rejected, if no up to date CRL can be retrieved. Set this property to true to ignore dates. Otherwise set it to false (recommended).</p><p><span class="strong"><strong><code class="literal">pki.crl.plugins</code></strong></span></p><p>Choose how and in what order you want to check the CRLs for revoked certificates. (see <a class="link" href="#x74222_Heading3Tarsec_Plugins" title="53.5.2. Plugins">"Plugins"</a>)</p><p><span class="strong"><strong><code class="literal">pki.crl.update.interval</code></strong></span></p><p>The periodic update interval of cached CRLs in minutes. Supply a number from 1 to \* or 0 for no CRL caching. (30-120 minutes are recommended)</p><p><span class="emphasis"><em>NOTE: If the URL for a CRL is not reachable, the SLS will write a corresponding
exception log, but not change the currenlty locally cached CRL list. So the
certificate validation process will still run with the currently locally
available CRLs.</em></span></p><p><span class="strong"><strong><code class="literal">pki.crl.dir</code></strong></span></p><p>To use local CRL files, set the CRL directory. This property will be used by one of the plugins. (see <a class="link" href="#x72433_Heading4Tarsec_File_CRL_Plugin" title="File CRL Plugin">"File CRL Plugin"</a>)</p><p><span class="strong"><strong><code class="literal">pki.cert.mapping.attribute</code></strong></span></p><p>Defines from what certificate attribute the username should be determinded.</p><p>Valid values are: subjectDN, email or an OID (e.x.: 2.5.29.17)</p><p>(see <a class="link" href="#x48025_Heading2Tarsec_Certificate_mapping" title="53.7. Certificate mapping">"Certificate mapping"</a>)</p><p><span class="strong"><strong><code class="literal">pki.cert.mapping.regex</code></strong></span></p><p>Defines a regular expression for extracting the actual username of the attribute. (see <a class="link" href="#x48025_Heading2Tarsec_Certificate_mapping" title="53.7. Certificate mapping">"Certificate mapping"</a>)</p><p><span class="strong"><strong><code class="literal">pki.ocsp.force.url</code></strong></span></p><p>URL to use for all OCSP requests, independently of what is indicated in the certificate.</p><p><span class="strong"><strong><code class="literal">pki.ocsp.responder.maxage</code></strong></span></p><p>Maximal age than an OCSP response is allowed to have (thisUpdate) in seconds. Default is 0 (no maximal age).</p><p><span class="strong"><strong><code class="literal">pki.trustgroup.&lt;alias&gt;.trusted.ca.certs</code></strong></span></p><p>Comma-separated list of filenames of CA certificates in the configured directory
of CA certificates to trust for this trust group alias. Default is all certificates
in the configured directory for CA certificates.</p><p>Example: <code class="literal">pki.trustgroup.apple.trusted.ca.certs=apple.cer</code></p><p><span class="strong"><strong><code class="literal">pki.trustgroup.&lt;alias&gt;.trusted.ocspsigner.certs</code></strong></span></p><p>Comma-separated list of filenames of OCSP signer certificates in the configured directory
of OCSP signer certificates to trust for this trust group alias. Default is all certificates
in the configured directory for OCSP signer certificates.</p><p>Example: <code class="literal">pki.trustgroup.apple.trusted.ocspsigner.certs=apple-ocsp.cer</code></p><p><span class="strong"><strong><code class="literal">pki.trustgroup.&lt;alias&gt;.useFileCrl</code></strong></span></p><p>Whether to use the file CRL plugin or not for this trust group.
Only has an effect if the file CRL is globally active by configuration.
Default is true.</p><p>Example: <code class="literal">pki.trustgroup.apple.useFileCrl=false</code></p><p><span class="strong"><strong><code class="literal">pki.trustgroup.&lt;alias&gt;.useUriCrl</code></strong></span></p><p>Whether to use the URI CRL plugin or not for this trust group.
Only has an effect if the URO CRL is globally active by configuration.
Default is true.</p><p>Example: <code class="literal">pki.trustgroup.apple.useUriCrl=false</code></p><p><span class="strong"><strong><code class="literal">pki.trustgroup.&lt;alias&gt;.useOcsp</code></strong></span></p><p>Whether to use OCSP or not for this trust group.
Only has an effect if OCSP is globally active by configuration.
Default is true.</p><p>Example: <code class="literal">pki.trustgroup.apple.useOcsp=true</code></p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_crl"></a>53.5. CRL</h2></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_basic"></a>53.5.1. Basic</h3></div></div></div><p>The PKI Adapter may be configured to look up certificate revocation lists of user certificates. This enhances your SES deployment with a tighter security policy. Make sure that you are familiar with the impact of using CRL checking and be aware of the correct configuration settings for your specific deployment.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="x74222_Heading3Tarsec_Plugins"></a>53.5.2. Plugins</h3></div></div></div><p>Currently there are two CRL fetching plugins supplied. They are included in the PKI Adapter distribution. Once you know in which way you want to check certificate revocation, you must configure the correct plugin, for example as follows (usage of the file CRL plugin):</p><p><code class="literal">pki.crl.plugins=com.usp.sls.pki.service.crl.CachedFileCRL</code></p><p>You may specify several plugins separated by commas. Note that in case you specify multiple plugins, verification will stop at the first plugin that found a CRL and the certificte was not revoked on that CRL.</p><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="x72433_Heading4Tarsec_File_CRL_Plugin"></a>File CRL Plugin</h4></div></div></div><p>Name: <code class="literal">com.usp.sls.pki.service.crl.CachedFileCRL</code></p><p>This plugin allows you to manage CRLs in the file system. You must specify a local directory from where all CRLs should be retrieved. For example:</p><p><code class="literal">pki.crl.dir=/data/sls/crls</code></p><p>You may specify a relative path beginning with a dot from the web application directory. For security reasons make sure you put it into the +./WEB-INF/…+to keep it private.</p><p>If you use this plugin, make sure you periodically update the files in the desired CRL directory. All CRL files will be reloaded before expiration or in the defined update interval.</p><p>You may  supply multiple CRL files issued by the same CA. This may come in handy in case you use delta CRLs.</p><p>If no CRL is found for the CA, verification fails (further plugins are not checked).</p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="_http_cdp_crl_plugin"></a>Http CDP CRL Plugin</h4></div></div></div><p>Name: <code class="literal">com.usp.sls.pki.service.crl.CachedURICRL</code></p><p>This plugin downloads dynamically the needed CRL determined by the CDP of a user certificate. Currently supports only CRL retrieval via HTTP.</p></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_validation_process"></a>53.6. Validation Process</h2></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_overview_11"></a>53.6.1. Overview</h3></div></div></div><p>A typical setting might define two validation steps: OCSP followed by CRL as a fallback if OCSP is not accessible. In the future, possibly additional online validation schemes might be supported besides OCSP.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_in_detail"></a>53.6.2. In Detail</h3></div></div></div><p>In the list below validation automatically proceeds to the next line, unless explicitly noted:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
If certificate has expired or is not valid, yet, fail.
</li><li class="listitem">
If certificate is not signed by a trusted CA certificate (one of the certificates in the directory specified by <code class="literal">pki.trusted.ca.dir</code>), fail.
</li><li class="listitem">
If certificate is a CA certificate, success.
</li><li class="listitem"><p class="simpara">
If OCSP validation is configured (<code class="literal">pki.check.&lt;nr&gt;=ocsp</code>):
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem">
If no OCSP URL is forced (<code class="literal">pki.ocsp.force.url</code>) and there is no OCSP URL in the certificate, skip to after OCSP validation.
</li><li class="listitem">
Compose OCSP request and try to get response. If you do not get a ResponseStatus <span class="emphasis"><em>success</em></span>, skip to after OCSP validation.
</li><li class="listitem"><p class="simpara">
Verify signature of OCSP response. There are three cases:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: square; "><li class="listitem">
Response signed by issuer of client certificate.
</li><li class="listitem">
Response signed by an implicitly trusted OCSP signer certificate (one of the certificates in the directory <code class="literal">pki.trusted.ocspsigner.dir</code>).
</li><li class="listitem">
Response signed by a certificate that is valid and signed by the issuer of the client certificate, and the certificate is authorized to sign OCSP responses (certificate extension).
</li></ul></div></li><li class="listitem">
If none of these cases applies, skip to after OCSP validation.
</li><li class="listitem">
If CertStatus is <span class="emphasis"><em>good</em></span>, success. If CertStatus is <span class="emphasis"><em>revoked</em></span>, fail. If CertStatus is <span class="emphasis"><em>unknown</em></span> or something else, continue.
</li></ul></div></li><li class="listitem"><p class="simpara">
If CRL check is configured (<code class="literal">pki.check.&lt;nr&gt;=crl</code>):
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem">
Check certificate status using configured CRL plugins.
</li><li class="listitem">
If suitable CRL found: fail if revoked, success if not revoked.
</li><li class="listitem">
If no suitable CRL found, fail.
</li></ul></div></li><li class="listitem">
Success.
</li></ul></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_validation_timeouts"></a>53.6.3. Validation Timeouts</h3></div></div></div><p>The total validation timeout (<code class="literal">pki.validation.timeout</code>) is divided between validation steps as follows. If the next step is the last one, it gets all of the remaining time, else it gets half of the remaining time. If a validation step times out and there are further steps, these are tried with the remaining time. If no time remains, validation fails.</p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="x48025_Heading2Tarsec_Certificate_mapping"></a>53.7. Certificate mapping</h2></div></div></div><p>There are basically three possibilities to map certificates to a username. First, you must specify which attribute in a certificate you want to use for the mapping process by the property <code class="literal">pki.cert.mapping.attribute</code>. Second, you must specify a correct regular expression to parse the desired username from the attribute value. There is a regular expression reference in the SLS Administration Guide Appendix.</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_subject_dn"></a>53.7.1. Subject DN</h3></div></div></div><p>This is probably the most common way to retrieve a username. It is done as following:</p><p><span class="strong"><strong>Example</strong></span></p><p>Parsing the CN out of <span class="emphasis"><em>CN=<span class="emphasis"><em>username</em></span>,OU=SES development,C=CH</em></span></p><p><code class="literal">pki.cert.mapping.attribute=subjectDN</code></p><p><code class="literal">pki.cert.mapping.regex=CN=(.<span class="strong"><strong>),OU=.</strong></span></code></p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_email"></a>53.7.2. Email</h3></div></div></div><p>Checks all email addresses that are contained in the subject field as well as email addresses that are contained in the SubjectAltName extension, if present.</p><p><span class="strong"><strong>Example</strong></span></p><p>Use the users email address of the certificate.</p><p><code class="literal">pki.cert.mapping.attribute=email</code></p><p><code class="literal">pki.cert.mapping.regex=(.*)</code></p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_certificate_extension_oid"></a>53.7.3. Certificate extension OID</h3></div></div></div><p>List of some extension OID’s:</p><p>2.5.29.17 - Subject Alternative Name</p><p>2.5.29.19 - Basic Constraints</p><p>2.5.29.30 - Name Constraints</p><p>2.5.29.32 - Certificate Policies</p><p>2.5.29.33 - Policy Mappings</p><p>2.5.29.37 - Extended key usage</p><p><span class="strong"><strong>Example</strong></span></p><p>Parsing the Windows Logon ID out of a Subject Alternative Name similar as "<span class="emphasis"><em>username</em></span>@myDomain.com". This may be useful in a Windows PKI environment. The Subject Alternative Name corresponds to the User Principal Name.</p><p><code class="literal">pki.cert.mapping.attribute=2.5.29.17</code></p><p><code class="literal">pki.cert.mapping.regex=.([a-zA-Z]\*)@.</code></p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_apache_tomcat_configuration"></a>53.8. Apache Tomcat configuration</h2></div></div></div><p>Since the PKI Adapter generates extensive traffic between the SES and the SLS it is important to increase the maxHttpHeaderSize to 48k. This property must be set in the server.xml for the specific connector.</p><p><code class="literal">&lt;Connector port="8080" maxHttpHeaderSize="48000" …</code></p><p>If you are using an other Servlet Container, check for a similar property in this context.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_trust_groups"></a>53.9. Trust Groups</h2></div></div></div><p>Trust groups allow to tailor trusted CAs and OCSP signers, as well as whether to
do CRL and/or OCSP verifications dynamically. They are configured with several
configuration proporties documented further above, in the format
<code class="literal">pki.trustgroup.&lt;alias&gt;.&lt;suffix&gt;=&lt;value&gt;</code>.</p><p>Basically, a trust group can define a certain list of trusted CA certificates to
be used for the login (instead of all CA certificates in the "trustedCa"
directory), and if OCSP and / or CRL should be used.</p><p>Each "Trust Group" is basically just an abstract definition of what features to
use for an authentication, grouped together with an alias. When the login starts,
the appropriate "Trust Group" can then be selected in the model, using the
JEXL function "pki.setTrustGroup(alias)".</p><p>The following example shows two trust groups; one of which uses OCSP, the other
one doesn’t. Note that CRL and OCSP must explicitely be disabled for a trust
group if they are not to be used, since they are active by default:</p><pre class="screen"># Trust Group "no-ocsp" with CA "company"
pki.trustgroup.no-ocsp.trusted.ca.certs=company.cer
pki.trustgroup.no-ocsp.useFileCrl=true
pki.trustgroup.no-ocsp.useUriCrl=true
pki.trustgroup.no-ocsp.useOcsp=false

# Trust Group "with-ocsp", with OCSP, and CA's "ACME" and "Portal"
pki.trustgroup.with-ocsp.trusted.ca.certs=acme.cer,portal.cer
pki.trustgroup.with-ocsp.ocspsigner.certs=acme-ocsp.cer
pki.trustgroup.with-ocsp.useFileCrl=true
pki.trustgroup.with-ocsp.useUriCrl=true
pki.trustgroup.with-ocsp.useOcsp=true</pre><p>The following model state would then choose the OCSP-enabled trust group
"with-ocsp":</p><pre class="screen">model.login.state.20.name=do.generic-setTrustGroup
model.login.state.20.action.1=${pki.setTrustGroup('with-ocsp')}</pre></div><div class="glossary"><div class="titlepage"><div><div><h2 class="title"><a id="_glossary_2"></a>Glossary</h2></div></div></div><p><span class="strong"><strong>PKI</strong></span></p><p>A public key infrastructure (PKI) is an environment that establishes a level of trust between different entities. It allows binding of public keys to users. The public keys are typically in X.509 conform certificates.</p><p><span class="strong"><strong>X.509</strong></span></p><p>X.509 specifies a standard format for public key certificates and algorithms.</p><p><span class="strong"><strong>CRL</strong></span></p><p>A certificate revocation list (CRL) is a list of certificates (more accurately: their serial numbers) which have been revoked, are no longer valid, and should not be trusted anymore.</p><p><span class="strong"><strong>CDP</strong></span></p><p>A certificate distribution point (CDP) defines the URI location a CRL may be retrieved to check a certificate for revocation.</p><p><span class="strong"><strong>OCSP</strong></span></p><p>Online Certificate Status Protocol. Defined in RFC 2560. Defines an internet standard for validating certificates without requiring CRLs.</p></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="_rsa_adapter"></a>Chapter 54. RSA Adapter</h2></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_introduction_22"></a>54.1. Introduction</h2></div></div></div><p>The RSA SecurId adapter enables a transparent SecurId logon. It allows users to authenticate with a RSA SecurId token. The SLS will represent an Authentication Agent and pass the user login credentials to the RSA Security Manager to verify them. This connection is based on a proprietary secure protocol.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_features_6"></a>54.2. Features</h2></div></div></div><p>The following features will give you a brief overview of the RSA Adapters functionalities:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
Next Token Mode 
This feature is used for synchronization of the token with the RSA Security Manager and to increase the security level, after a specifyable number of unsuccessful logins.
</li><li class="listitem">
New PIN Mode 
If a user requires to set a new password, the Login Service forces the user to define a new password.
</li></ul></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_environment_prerequisites_5"></a>54.3. Environment / Prerequisites</h2></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_rsa_server_version_compatibility"></a>54.3.1. RSA Server Version Compatibility</h3></div></div></div><p>The current RSA client API used by the SLS provides full support for ACE servers up to version 5. With newer releases, while the authentication process still works, there are known issues concerning the automatic synchronization of the node-secret.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_network_protocols_and_ports_3"></a>54.3.2. Network Protocols and Ports</h3></div></div></div><p>The SecurID adapter requires the following network protocols and ports to be enabled in local firewalls between the SLS and the authentication back-end service:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
UDP over port 5500 between the SLS and the ACE Master and Slave servers.
</li></ul></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_configuration_16"></a>54.4. Configuration</h2></div></div></div><p><span class="strong"><strong><code class="literal">securid-adapter.properties</code></strong></span></p><p>The RSA SecurId adapter is configured through a property file, usually named "<code class="literal">securid-adapter.properties</code>". This is the file where the RSA SecurID settings should be configured.</p><p><span class="strong"><strong><code class="literal">rsa_api.properties</code></strong></span></p><p>The RSA client libraries used by the SLS are configured through a file called "<code class="literal">rsa_api.properties</code>". The SLS will generate this file based on the content of the "<code class="literal">securid-adapter.properties</code>" after the start. Therefore the file "<code class="literal">rsa_api.properties</code>" should never be edited by hand. But the location of this generated file can be changed from its default (in the SLS "WEB-INF" directory) with the following property.</p><p><span class="strong"><strong><code class="literal">securid.rsa.api.file.dir</code></strong></span></p><p><span class="emphasis"><em>Optional</em></span>: Defines the absolute path of a directory where the "rsa_api.properties" file should be created. NOTE: The directory must already exist and be writable!</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_securid_adapter_properties"></a>54.4.1. securid-adapter.properties</h3></div></div></div><p>In a typical system environment you do not have to change any settings in this file.</p><p><span class="strong"><strong><code class="literal">RSA_AGENT_HOST</code></strong></span></p><p>(Optional) Indicates the IP address of the Agent Host in the RSA Authentication Manager database. This property is only used if you have multiple network interfaces on your machine.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_sls_properties_5"></a>54.4.2. sls.properties</h3></div></div></div><p>The following two properties must be set to use the RSA adapter for authentication and challenge / response:</p><pre class="programlisting">adapter.authentication=securid
adapter.changepassword=securid</pre><p>In addition, the login model is configured in this file as well.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_disable_password_check"></a>54.4.3. Disable Password Check</h3></div></div></div><p>In some cases, it may be desirable to disable sending the password to the RSA backend (requires corresponding configuration of the ACE server as well). The following property allows to enable a mode where the adapter will send only the value of the SecurID code (secret) to the ACE server, and ignore the value of the password credential:</p><p><span class="strong"><strong><code class="literal">rsaadapter.pwdcred.autoconcat.disable</code></strong></span></p><p>Optional: Set to "true" to disable inclusion of the password into the passcode. Defaults to "false". Example:</p><pre class="programlisting">rsaadapter.pwdcred.autoconcat.disable=true</pre><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="_securid_login_model"></a>SecurID Login Model</h4></div></div></div><p>The typical default login model looks like this:</p><pre class="programlisting">model.login.uri=/auth
model.login.failedState=1

model.login.state.1.name=get.cred
model.login.state.2.name=do.auth
model.login.state.2.nextState=8
model.login.state.3.name=get.passwordpolicy
model.login.state.4.name=get.changepassword
model.login.state.5.name=do.changepassword
model.login.state.5.failedState=4
model.login.state.6.name=get.changepasswordsuccessful
model.login.state.6.nextState=1
model.login.state.8.name=do.success</pre><p><span class="strong"><strong>IMPORTANT NOTE!</strong></span></p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="x93298_Heading4Tarsec_Next_Tokencode_Required_Problem"></a>"Next Tokencode Required" Problem</h4></div></div></div><p>However, sometimes a login model may be more complex and contain other states before the "<code class="literal">get.cred</code>" state. This can lead to a particular problem whenever the RSA server sends the response code for "<span class="emphasis"><em>next tokencode required</em></span>":</p><p>When "<span class="emphasis"><em>next tokencode required</em></span>" is received, the SLS resets the model back to the first state, expecting it to be the "<code class="literal">get.cred</code>" state. For reasons of backwards compatibility,  this behaviour cannot be changed.</p><p>So, if starting the model from the first state again is a problem, it is possible to use a "<code class="literal">do.generic</code>" state as the first model state, and perform conditional branching to other states, based on the value of the JEXL variable</p><pre class="screen">rsa.auth.status</pre><p>which contains the value of the status code. Example:</p><pre class="programlisting">model.login.uri=/auth
model.login.failedState=1

model.login.state.10.name=do.generic
model.login.state.10.nextState.1=...
model.login.state.10.nextState.1.if=${rsa.auth.status == 'NEXT_CODE_REQUIRED'}
model.login.state.20.name=get.cred
model.login.state.30.name=do.auth</pre></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_installation"></a>54.5. Installation</h2></div></div></div><p>There are several additional installation steps to perform before you will be able to use this adapter.</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_registration"></a>54.5.1. Registration</h3></div></div></div><p>Contact the RSA Security Manager administrator to register your SLS instance as an Agent host in the RSA Security Manager. In the following screenshot you see the required Agent host configuration settings.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_install_the_file_sdconf_rec"></a>54.5.2. Install the file "sdconf.rec"</h3></div></div></div><p>The file <code class="literal">sdconf.rec</code> contains the RSA Security Manager server information. Ask your Security Manager administrator to supply this file. Copy this file into the <code class="literal">WEB-INF</code> directory of your Secure Login Service instance.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_optional_install_the_file_sdopts_rec"></a>54.5.3. Optional: Install the file "sdopts.rec"</h3></div></div></div><p>This file is optional, thought, it may be important to guarantee failover and load-balancing functionalities. You may receive this file from your Security Manager administrator. Install this file as well into the WEB-INF directory of your Secure Login Service instance.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_install_securid_rec_file_aka_node_secret"></a>54.5.4. Install "securid.rec" file, aka node-secret</h3></div></div></div><p>This file contains a secret used for the encryption of the communication between the SLS and the ACE server.</p><p>Please note that this file is client-host (aka SLS-host) specific. Meaning that it cannot just be copied from one SLS system to another one.</p><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="_automatic_creation_installation"></a>Automatic Creation / Installation</h4></div></div></div><p>This file should usually be created automatically the first time the SLS contacts the ACE server. However, for some unknown reasons, this handshake process does not always seem to work. If it fails, the file must be installed manually following as described below.</p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="_manual_installation"></a>Manual Installation</h4></div></div></div><p>The ACE administrator must create the node-secret file in advance. But the file created by the administrator will not be the final node secret, but a special "transportable" form. This "transport"-file must then be installed on the SLS system using a command-line tool from the ACE server software library:</p><pre class="screen">agent_nsload</pre><p>Given that the node secret transport file sent by the ACE administrator was named "nodesecret.rec", the actual command to be performed in the Unix shell would be:</p><pre class="screen">&gt; ./agent_nsload -f nodesecret.rec -p &lt;pwd&gt;</pre><p>Where <span class="emphasis"><em>&lt;pwd&gt;</em></span> is the password with which the file is protected. Ask the administrator to send you that password on a secure / separate channel, such as per SMS or by phone.</p><p>The installed node secret file must be in the "<code class="literal">WEB-INF</code>"-directory of the SLS, and must be named "<code class="literal">securid.rec</code>".</p></div></div></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="SPNEGO_Adapter_Topic"></a>Chapter 55. SPNEGO Adapter</h2></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_introduction_23"></a>55.1. Introduction</h2></div></div></div><p>The SPNEGO adapter allows users to perform authentication over the SPNEGO protocol. SPNEGO describes the exchange of Kerberos tokens over http. This form of authentication is a user friendly solution in a trusted network environment. End users may not have explicitly to log in if they are already authenticated to a Kerberos Realm.</p><p>The following steps explain how the SPNEGO login works:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">
A user requests a restricted site.
</li><li class="listitem">
The user is getting redirected from the SES to the SLS.
</li><li class="listitem">
The SLS initiates an SPNEGO authentication.
</li><li class="listitem">
The browser requests a Kerberos token for the SLS from the designated Key Distribution Center.
</li><li class="listitem">
The browser sends the token to the SLS.
</li><li class="listitem">
If the token is valid, the SLS grants the requested access rights to the client.
</li></ol></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_features_7"></a>55.2. Features</h2></div></div></div><p>The following features will give you a brief overview of the SPNEGO Adapters functionalities:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
Windows compatible
</li><li class="listitem">
Support for Kerberos authentication
</li><li class="listitem">
SSO (Single Sign On) within a Kerberos Domain/Realm
</li></ul></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_environment_prerequisites_6"></a>55.3. Environment / Prerequisites</h2></div></div></div><p>The SPNEGO Adapter implementation has been tested with the following environment. Other Kerberos implementations or software environments could work but are not supported.</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
Windows 2003 Active Directory (for the Kerberos infrastructure)
</li><li class="listitem">
Windows 2000 or XP with Internet Explorer or Mozilla Firefox joined to the AD domain.
</li><li class="listitem">
SLS running on Tomcat 5.5 with JAVA SDK 1.6 (required for the Kerberos GSS-API). To avoid incompatibilities with some combinations of IE and Windows, use at least JAVA SDK 1.6.0_29.
</li></ul></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_important_checklist"></a>55.3.1. Important Checklist</h3></div></div></div><p>The following issues are common to cause hard to track problems with SPNEGO
login:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
The principal name must start with <span class="strong"><strong>"HTTP/"</strong></span>, i.e. "HTTP/&lt;host&gt;@&lt;REALM&gt;".
This is particularly important to implement since at least with Microsoft KDCs login
will most likely still work without this prefix as long as only authentication to
a single KDC is configured at the SLS, but as soon as more than one KDC is
configured, most likely not all KDCs will be able to log in, even if otherwise
configured correctly and would work if configured as only one.
Note that SPNEGO mandates the HTTP prefix (RFC4559, Section 4.1) and that
experimentally with MIT KDCs login only works with that prefix; Microsoft KDCs
in combination with the JDK seem to be a bit more forgiving in that respect.
</li><li class="listitem">
Under Windows, the keytab file <span class="strong"><strong>MUST</strong></span> be generated by the Administrator user.
Other users can generate a keytab file as well, but the SLS will not be able to
perform a login with it!
</li><li class="listitem">
<span class="strong"><strong>NTP</strong></span> not in sync: For a Kerberos login to work, all participating systems must
have the same time. Therefore, enabling NTP is recommended. However, note that
simply enabling NTP does NOT necessarily sync the time immediately, since the
NTP deamon usually brings the time in sync in small, slow increments. So it
may be necessary to force an immediate time sync by hand.
</li><li class="listitem">
<span class="strong"><strong>Communication</strong></span>: The SLS needs to be able to connect to the KDC directly,
because it needs to be able to get a TGT (Ticket Granting Ticket) once.
</li><li class="listitem">
<span class="strong"><strong>Authorization header size</strong></span>: The "Authorization" header can grow to very large
sizes, depending on the user’s roles; this is typically a problem with some
MS Active Directory setups. When a user has a very large number of roles, the
"Authorization" header with the Kerberos ticket can grow to serveral KBs, which
can cause problems due to both some general header size limitations in the HSP
reverse proxy, as well as some specific "Authorization" header size limits in
the HSP. In such cases, it may be advisable to review the AD setup, and check
if it is possible to adapt the user configuration in order to reduce the number
of roles.
</li></ul></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_network_protocols_and_ports_4"></a>55.3.2. Network Protocols and Ports</h3></div></div></div><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
UDP/TCP Port: 88
</li></ul></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_background_2"></a>55.4. Background</h2></div></div></div><p>SPNEGO is a generic super protocol defining the token exchange of the users web
browser and the SLS. We use Kerberos as the underlying authentication schema.</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_spnego"></a>55.4.1. SPNEGO</h3></div></div></div><p>SPNEGO stands for Simple and Protected GSS-API Negotiation Mechanism. It is
defined in RFC 4178, which obsoletes RFC 2478.</p><p>The protection of the negotiation depends on the strength of the integrity
protection. In particular, the strength of SPNEGO is no stronger than the
integrity protection of the weakest mechanism acceptable to GSS-API peers.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_kerberos"></a>55.4.2. Kerberos</h3></div></div></div><p>Kerberos is a computer network authentication protocol, which allows clients and
servers communicating over a network to prove their identity in a secure manner.
First versions of Kerberos were proposed from MIT in the 1980s. There exist
several implementations of the actual Kerberos V5. Variants of Kerberos are the
default authentication protocols in MS Windows 2000, XP, 2003, Vista and MacOS X.</p><p>Kerberos uses as its basis the Needham-Schroeder protocol. It makes use of a
trusted third party, termed a <span class="emphasis"><em>Key Distribution Center</em></span> (KDC), which consists of
two logically separate parts: an <span class="emphasis"><em>Authentication Server</em></span> (AS) and a
<span class="emphasis"><em>Ticket Granting Server</em></span> (TGS). Kerberos works on the basis of <span class="emphasis"><em>tickets</em></span> which
serve to prove the identity of users.</p><p>The KDC maintains a database of secret keys; each entity on the network shares a
secret key known only to itself and to the KDC. Knowledge of this key serves to
prove an entity's identity. For communication between two entities, the KDC
generates a session key which they can use to prove each other their identity.</p><p>For more information on Microsoft implementation of Kerberos v5, please refer to:</p><p><a class="ulink" href="http://www.microsoft.com/windowsserver2003/technologies/security/kerberos/default.mspx" target="_top">http://www.microsoft.com/windowsserver2003/technologies/security/kerberos/default.mspx</a></p><p>Several tutorial/documentation talking about Kerberos can be found on the net.</p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_configuration_17"></a>55.5. Configuration</h2></div></div></div><p>In addition to basic SES/SLS set up, the SPNEGO Adapter needs some special
configurations.</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
A properly configured Kerberos Realm.
</li><li class="listitem">
The Kerberos configuration for Java GSS-API.
</li><li class="listitem">
Adapted SES/SLS configuration.
</li></ul></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_realm_configuration"></a>55.5.1. Realm Configuration</h3></div></div></div><p>Discussing all the configuration details of a Kerberos Realm would really go
beyond the focus of this document. An example of Kerberos Realm is set up in
Section <a class="link" href="#x44667_Heading1Tarsec_Example" title="55.7. Example">"Example"</a>.</p><p>The web browser must be able to request a session ticket for the SLS from the
KDC. We do also show how to generate the mapping of the URL the browser is
asking for and the Kerberos principal.</p><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="x86406_Heading3Tarsec_Browser_Single_Sign_On"></a>Browser Single Sign On</h4></div></div></div><p>In SPNEGO the web browser retrieves the user credentials from KDC. This enables
a transparent login. The user does not see a login page.</p><p>Usually a browser desires permission before sending a SPNEGO token to a certain
web server. You have to add the authentication site to the list of allowed
sites. It is the hidden site where a not yet authenticated client is redirected
to by SES. For illustration we assume the site is "<code class="literal">http://sls.dog.ch/sls/auth</code>".</p><p>The configuration is very browser dependent. Please consult the documentation of
your browser and version for proper configuration. Following some brief notes
about two popular browsers:</p><p><span class="strong"><strong>Internet Explorer</strong></span></p><p>You have to add the authentication site to the local intranet zone in the
Browser Preferences.</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
Internet Properties - Security - Local Intranet - Sites - Enhanced - type
"<code class="literal">sls.dog.ch</code>" and click add.
</li></ul></div><p>The following two default settings are mandatory:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
Internet Properties - Security - Custom Level… - User Authentication -
Logon - [x] Auto logon only in Intranet zone.
</li><li class="listitem">
Internet Properties - Advanced - 
[x] Enable Integrated Windows Authentication
</li></ul></div><p><span class="strong"><strong>Mozilla Firefox</strong></span></p><p>You have to add the authentication site to the trusted sites for negotiation in
the browser preferences. This can be done by using about:config. Just enter
"<code class="literal">about:config</code>" in the URL field and press enter. Afterwards, find the property
called "<code class="literal">network.negotiate-auth.trusted-uris</code>" and add the domain name, in our
example: "<code class="literal">sls.dog.ch</code>". You can enter multiple domain names comma seperated.</p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="x39059_Heading3Tarsec_Mapping"></a>Mapping</h4></div></div></div><p>Kerberos is designed to enable secure point to point communication. The <span class="emphasis"><em>source</em></span>
or initiator of a connection requests the KDC to issue a ticket for a certain
<span class="emphasis"><em>destination</em></span>. In case of SPNEGO, the destination does not directly match to the
Kerberos <span class="emphasis"><em>Principal Name</em></span>. In a Windows domain the Principal Name is the user's
login name.</p><p><span class="strong"><strong>Service Principal Name</strong></span></p><p>A service demanding SPNEGO authentication is associated with a <span class="emphasis"><em>Service
Principal Name</em></span> (SPN). For SPNEGO the full domain name of the authentication
site is important. The web browser will request the KDC for a Kerberos Service
Ticket with the currently logged in user as source, and the SPN "<code class="literal">HTTP/&lt;FQDN&gt;</code>"
as destination.</p><p>The mapping between the Principal Name and the Service Principal Name must be
constructed by hand. A Principal can be associated with many Service Principal
Names.</p><p>If the login page URL of the SLS is "<code class="literal">http://sls.dog.ch/sls/auth</code>", the SPN
would be "<code class="literal">HTTP/sls.dog.ch</code>". The SPN is constructed using the DNS record of
type A. This means that if the URL contains an alias name for the host (a CNAME
entry), the browser will still be able to construct the original SPN.</p><p><span class="strong"><strong>IMPORTANT</strong></span>: As already stated earlier, the SPNEGO standard mandates the "HTTP/"
prefix. Without it, authentication experimentally still works with a single
Microsoft KDC, but that is not guaranteed in any way and as soon as you have
multiple KDCs configured, it experimentally no longer works. Also, experimentally
with an MIT KDC it only ever works if the "HTTP/" prefix is present. Short, setups
that do not use the prefix as part of the Service Principal Name, are not supported!</p><p><span class="strong"><strong>setspn</strong></span></p><p>The utility setspn from Microsoft can add new mappings. The syntax is
"<code class="literal">setspn -a &lt;SPN&gt; &lt;Principal Name&gt;</code>". For example executing the command:
"<code class="literal">setspn -a HTTP/sls.dog.ch SLSaccount</code>" in a command shell maps the above login
domain with the principal "<code class="literal">SLSaccount</code>". The mapping can be tested with
"setspn -L SLSaccount". Note: Sometimes the client needs a restart before the
new setting is accepted.</p></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="x56948_Heading2Tarsec_Kerberos_Configuration_for_JAAS_and_GSS_API"></a>55.5.2. Kerberos Configuration for JAAS and GSS API</h3></div></div></div><p>The Java JAAS and GSS API is used to process the Kerberos authentication.
This API needs two configuration files. Their names and locations must be set in
the default property file for SLS; details in section
<a class="xref" href="#x50516_Heading3Tarsec_SLS_Configuration" title="SLS Configuration">the section called “SLS Configuration”</a>. The first file contains general
realm informations. We will call it always "<code class="literal">krb5.conf</code>". A minimal
configuration only contains one default realm, with its default domain and the
associated KDC.</p><p><span class="strong"><strong><code class="literal">krb5.conf</code></strong></span></p><pre class="screen">[libdefaults]
default_realm = DOG.CH

[realms]
DOG.CH = {
  kdc = 2test.dog.ch
}</pre><p>Several KDCs (for failover) and timeouts can be configured as follows
in the krb5.conf:</p><pre class="screen">[realms]
DOG.CH = {
  kdc = 2test.dog.ch
  kdc = 3test.dog.ch
  kdc_timeout = 3s
}</pre><p>The information about how the SLS logs in to the realm is stated in a file named
"<code class="literal">spnegoLogin.conf</code>". We give again a minimal example, fitting the example
Kerberos realm in Section <a class="link" href="#x44667_Heading1Tarsec_Example" title="55.7. Example">"Example"</a>.</p><p><span class="strong"><strong><code class="literal">kdc_timeout</code></strong></span></p><div class="note" style="margin-left: 0; margin-right: 10%;"><h3 class="title">Note</h3><p>In the Java Kerberos implementation, this setting uses millisecond units
(while many other Kerberos implementations use seconds). However, it is possible
to specify the value in seconds by adding an "s", e.g.</p></div><pre class="screen">   kdc_timeout = 10s</pre><p><span class="strong"><strong><code class="literal">spnegoLogin.conf</code></strong></span></p><pre class="screen">com.sun.security.jgss.krb5.initiate {
  com.sun.security.auth.module.Krb5LoginModule required
  storeKey=true
  principal="HTTP/sls.dog.ch@DOG.CH";
};</pre><p>Using this configuration, you are prompted for a password when starting the SLS.
Mostly using a <span class="emphasis"><em>keytab file</em></span> is the more appropriate solution. in the following
table you can see the possible properties.</p><div class="table"><a id="idm12109"></a><p class="title"><strong>Table 55.1. Possible properties in spnegoLogin.conf</strong></p><div class="table-contents"><table class="table" summary="Possible properties in spnegoLogin.conf" cellpadding="4px" style="border-collapse: collapse;border-top: 3px solid #527bbd; border-bottom: 3px solid #527bbd; border-left: 3px solid #527bbd; border-right: 3px solid #527bbd; "><colgroup><col class="col_1" /><col class="col_2" /><col class="col_3" /></colgroup><thead><tr><th style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top">Key </th><th style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top">Value </th><th style="border-bottom: 1px solid #527bbd; " align="left" valign="top">Description</th></tr></thead><tbody><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>storeKey</p></td><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>true</p></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>mandatory</p></td></tr><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>principal</p></td><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>&lt;username&gt;</p></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>the kerberos principal name</p></td></tr><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>useKeyTab</p></td><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>true|false</p></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>enables the use of a keytab file</p></td></tr><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>keyTab</p></td><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>&lt;filename&gt;</p></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>the name of the keytab file</p></td></tr><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>doNotPrompt</p></td><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>true|false</p></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>avoids prompting for password</p></td></tr><tr><td style="border-right: 1px solid #527bbd; " align="left" valign="top"><p>isInitiator</p></td><td style="border-right: 1px solid #527bbd; " align="left" valign="top"><p>true|false</p></td><td style="" align="left" valign="top"><p>deny the principal initiating of connections</p></td></tr></tbody></table></div></div><br class="table-break" /><p>As result, using a keytab file, you have the following configuration example:</p><pre class="screen">com.sun.security.jgss.krb5.initiate {
  com.sun.security.auth.module.Krb5LoginModule required
  storeKey=true
  principal="HTTP/sls.dog.ch@DOG.CH"
  useKeyTab=true
  keyTab=/export/home/pathtokeytab/keytab.file;
};</pre><p>Multiple principals that are tried one after the other can be configured like this:</p><pre class="screen">com.sun.security.jgss.krb5.initiate {

  com.sun.security.auth.module.Krb5LoginModule optional
    storeKey=true
    useKeyTab=true
    keyTab="/var/lib/usp/sls/default/webapps/login/sls/WEB-INF/sls.coyote.keytab"
    principal="HTTP/coyote.acme.org@ACME.ORG";

  com.sun.security.auth.module.Krb5LoginModule optional
    storeKey=true
    useKeyTab=true
    keyTab="/var/lib/usp/sls/default/webapps/login/sls/WEB-INF/sls.bugs.keytab"
    principal="HTTP/bugs.acme.org@BUGS.ACME.ORG";

};</pre><p>See Javadoc for the JDK class <code class="literal">javax.security.auth.login.Configuration</code>,
e.g. <a class="ulink" href="https://docs.oracle.com/javase/8/docs/api/javax/security/auth/login/Configuration.html" target="_top">https://docs.oracle.com/javase/8/docs/api/javax/security/auth/login/Configuration.html</a>,
for what the allowed values "required", "requisiste", "sufficient"  and "optional" mean.</p><p><span class="strong"><strong>Note</strong></span>: Observed behavior appeared to be that if you used "sufficient" and a KDC rejected login,
then login would fail, i.e. the subsequent KDCs would not be tried, but if you used "optional",
subsequent KDCs would be tried. Conversely, if a KDC was not reachable, observed behavior
appeared to be that then both with  "sufficient" and "optional" following KDCs would be tried.</p><p><span class="strong"><strong>keytab file</strong></span></p><p>The keytab file contains trust information. From a security point of view
possession of a principal's keytab is equivalent to knowing its password.
Therefore the file should be handled carefully, only the SLS must have access
rights to it. We name our keytab file "<code class="literal">keytab.file</code>".</p><p>The command line utility <span class="emphasis"><em>ktab</em></span> can generate keytab files. You can find it in
the "<code class="literal">\\bin</code>" directory of the JDK. The syntax is:</p><pre class="screen">ktab -a &lt;user name&gt; [password] -k &lt;keytab file&gt;</pre><p>If the password is not specified, it will be prompted on enter. Generating a
keytab for our example in section <a class="link" href="#x44667_Heading1Tarsec_Example" title="55.7. Example">"Example"</a>
could be done with the command:</p><p><code class="literal">ktab -a SLSAccount mypwd -k C:\keytab.file</code></p><p>Note, if <code class="literal">useKeyTab</code> is enabled, but the file could not be found, the SLS
prompts the user for a password, unless the property "<code class="literal">doNotPrompt=true</code>" is set.</p><p><span class="strong"><strong>krb5.ini</strong></span></p><p>The Java utility ktab needs a configuration file "<code class="literal">C:\Windows\krb5.ini</code>" which
corresponds exactly to "<code class="literal">krb5.conf</code>". Just copy and rename the file on the
computer you want to use ktab.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="x72584_Heading2Tarsec_SES_SLS_Configuration"></a>55.5.3. SES/SLS Configuration</h3></div></div></div><p>We do not introduce any new or specialized configuration properties for the
SPNEGO adapter. With a few changes the configuration for an SLS to authenticate
by SPNEGO can be adapted from another SES/SLS configuration.</p><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="_ses_configuration_2"></a>SES Configuration</h4></div></div></div><p>To allow the SLS to initiate a SPNEGO authentication, the <span class="emphasis"><em>HGW_Allow401</em></span> SES
property is mandatory on the SLS location. Add this property to your
configuration in the SRManager and the HttpListener or HttpsListener.</p><pre class="screen">&lt;Location /sls/auth&gt;
HGW_Host                    sls.dog.ch:80
HGW_Allow401
...</pre><p>The http headers named <span class="emphasis"><em>WWW-Authenticate</em></span> in the SLS response and
<span class="emphasis"><em>Authorization</em></span> in the request must be able to pass the SES.</p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="x50516_Heading3Tarsec_SLS_Configuration"></a>SLS Configuration</h4></div></div></div><p>The following settings are configured in the default properties definition
for SLS: <code class="literal">sls.properties</code>.</p><p><span class="strong"><strong>Enable the SPNEGO Adapter</strong></span></p><pre class="programlisting"># Spnego Authentication Adapter
adapter.class.spnego=com.usp.sls.spnego.SpnegoAdapter
adapter.authentication=spnego</pre><p><span class="strong"><strong>Login Model</strong></span></p><pre class="programlisting"># Login Model Configuration
model.spnego.uri=/auth
model.spnego.failedState=get.usererror

# Some browsers may send authorization header immediately, in which case
# the "do.spnegoinit"-state must be skipped.
model.spnego.state.1000.name=do.generic-checkChallenge
model.spnego.state.1000.action.1=${session.processNextGETasPOST()}
model.spnego.state.1000.action.1.if.1=${function.hasNonEmptyVariable('header.authorization') &amp;&amp; header.authorization.toLowerCase().startsWith('negotiate ')}
model.spnego.state.1000.nextState.1=do.auth
model.spnego.state.1000.nextState.1.if.1=${function.hasNonEmptyVariable('header.authorization') &amp;&amp; header.authorization.toLowerCase().startsWith('negotiate ')}
model.spnego.state.2000.name=do.spnegoinit
model.spnego.state.3000.name=do.auth
model.spnego.state.5000.name=do.success
model.spnego.state.6000.name=get.usererror</pre><p><span class="strong"><strong>Credential Provider</strong></span></p><pre class="programlisting"># Credential Provider
cred.provider.class.spnego=com.usp.sls.toolkit.http.cred.HttpStringCredentialProvider
cred.provider.spnego=spnego

# SPNEGO token from request header: Authorization
cred.provider.spnego.cred.1.type=string
cred.provider.spnego.cred.1.source=header
cred.provider.spnego.cred.1.name=Authorization</pre><p><span class="strong"><strong>GSS-API Configuration Files</strong></span></p><pre class="programlisting"># System properties for jaas and gss api
system.property.java.security.krb5.conf=krb5.conf
system.property.java.security.auth.login.config=spnegoLogin.conf</pre><p><span class="strong"><strong>Remarks</strong></span></p><p>The Java JAAS and GSS API is used to process the Kerberos authentication. We
need Java System Properties to declare the location and names for configuration
files of this API. The file location can be set using relative or absolute
pathnames.</p><p>Since the user credential in the SPNEGO protocol is a kerberos token sent in an
http header named "<code class="literal">Authorization</code>", the appropriate credential provider is a
"<code class="literal">HttpStringCredentialProvider</code>".</p><p>The SLS does not receive a password credential of the authenticated user.
Therefore it is not possible to use the SES/SLS to authenticate the user for the
backend application with form based or basic authentication. Do not set the
property: "<code class="literal">auth.type</code>".</p></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_jexl_groovy"></a>55.5.4. JEXL/Groovy</h3></div></div></div><p>After a successful login, a "<code class="literal">spnego.realm</code>" script variable with the user’s
SPNEGO realm is created, plus the variables "<code class="literal">spnego_ms_kerberos_password_login</code>"
and "<code class="literal">spnego_ms_kerberos_certificate_login</code>" (see
<a class="link" href="#x59373_Heading2Tarsec_SPNEGO_Adapter_Variables" title="32.7.6. SPNEGO Adapter Variables">"SPNEGO Adapter Variables"</a> for details,
including supported ETypes ("ciphers") for obtaining the MS Login related variables).</p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_installation_checklist"></a>55.6. Installation checklist</h2></div></div></div><p>The following checklist corresponds to a tested and working configuration with
Kerberos V5 (Microsoft Windows 2003 Server Active Directory) and Windows XP Pro
as client/browser. Other configurations could be possible but no support is
given for them.</p><p>The following elements are necessary to make the SPNEGO / Kerberos
authentication mechanism working.</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_server_side_active_directory"></a>55.6.1. Server-side: Active Directory</h3></div></div></div><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
Creation of a domain user within the Active Directory associated with the
SPNEGO Adapter (from now called <span class="emphasis"><em>SLSaccount</em></span>).
</li><li class="listitem">
SPN correctly defined for the <span class="emphasis"><em>SLSaccount</em></span> using the tool "setspn" (Microsoft
Support Tools).
</li></ul></div><p>You can check the configuration with: "setspn -L SLSaccount". You should see in
the result an entry <span class="emphasis"><em>HTTP/sls.dog.ch</em></span> matching with the FQDN of the URL you are
accessing (in this case <span class="emphasis"><em>https://sls.dog.ch/something</em></span>). Refer to Section
<a class="link" href="#x39059_Heading3Tarsec_Mapping" title="Mapping">"Mapping"</a> for more details.</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
The <span class="emphasis"><em>SLSaccount</em></span> must be enabled in the Active Directory and must have the
flag "Password never expires" enabled.
</li></ul></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_workstation_side_the_browser"></a>55.6.2. Workstation-side: the browser</h3></div></div></div><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
The workstation must be joined to a Windows domain.
</li><li class="listitem">
The joined domain is within the same forest where the <span class="emphasis"><em>SLSaccount</em></span> is defined.
If it is not the case, look at the Section
<a class="link" href="#x23251_Heading2Tarsec_Kerberos_cross_domain_checklist" title="55.6.4. Kerberos cross domain checklist">"Kerberos cross-domain checklist"</a>
below for cross domain/forest authentication.
</li><li class="listitem">
The browser (Internet Explorer or Mozilla Firefox) has the correct
configuration to allow Kerberos authentication. Refer to Section
<a class="link" href="#x86406_Heading3Tarsec_Browser_Single_Sign_On" title="Browser Single Sign On">"Browser Single-Sign-On"</a>
for more details.
</li><li class="listitem">
The time is synchronized with the AD Domain Controller. Issued Kerberos
tickets could be invalid otherwise.
</li><li class="listitem">
In case you use the <span class="emphasis"><em>…/system32/drivers/etc/hosts</em></span> file for forcing name
resolutions without DNS, make sure you do not have two names for the same IP
entry. SPNEGO won't work correctly.
</li><li class="listitem">
Security issue: Force NTLM version 2.
If a Kerberos error occurs, the browser will use  NTLM as fallback
authentication protocol. The Windows default configuration (2k and XP) is to
allow NTLMv1 tokens across the network, which is highly not recomended since
passwords are easily recovered from them. To avoid this, force the OS to use
only NTLMv2, which is more secure than NTLMv1.
</li></ul></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_sls_configuration_3"></a>55.6.3. SLS configuration</h3></div></div></div><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
The SLS Framework needs to be running on top of Tomcat 5.5 and JAVA SDK 1.6
(otherwise the Kerberos implementation GSS-API is not available).
</li><li class="listitem">
The <span class="emphasis"><em>krb5.conf</em></span> file exists and contains a "<code class="literal">default_realm</code>" and a "<code class="literal">kdc</code>"
entry. Refer to Section
<a class="link" href="#x56948_Heading2Tarsec_Kerberos_Configuration_for_JAAS_and_GSS_API" title="55.5.2. Kerberos Configuration for JAAS and GSS API">"Kerberos Configuration for JAAS and GSS API"</a>
for configuration help.
</li><li class="listitem">
On the SLS: the <span class="emphasis"><em>spnegoLogin.conf</em></span> file exists and is correctly configured.
When you start the SLS and try to access the SPNEGO login page for the first
time, you should see a log entry into the KDC's System Event Viewer, under
Security, saying that a Kerberos user ticket has been delivered to the SLS for
the user <span class="emphasis"><em>SLSaccount</em></span>.
</li><li class="listitem">
The SLS SPNEGO Adapter has an up to date <span class="emphasis"><em>keytab.file</em></span> file, containing the
current defined password for the <span class="emphasis"><em>SLSaccount</em></span>. Refer to Section
<a class="link" href="#x56948_Heading2Tarsec_Kerberos_Configuration_for_JAAS_and_GSS_API" title="55.5.2. Kerberos Configuration for JAAS and GSS API">"Kerberos Configuration for JAAS and GSS API"</a>
for more details on this file generation (remember to control the krb5.ini file).
</li><li class="listitem">
The time is synchronized with the AD Domain Controller (KDC). If not, the
Kerberos won't work due to the ticket's lifetime.
</li></ul></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="x23251_Heading2Tarsec_Kerberos_cross_domain_checklist"></a>55.6.4. Kerberos cross domain checklist</h3></div></div></div><p>Additionally, if you need to achieve cross domain/forest authentication, you
need to be sure that the following configuration elements are correctly set.</p><p>Several scenario are provided corresponding to different realities and
domain/forest structures.</p><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="_same_forest_but_different_domains"></a>Same forest, but different domains</h4></div></div></div><p>Having one single forest for the entire organisation is the best solution for a
Kerberos infrastructure. Cross domain authentication is transparent and
automatically supported by the Active Directory.</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
First of all, make sure that the SPNEGO Adapter works within the same domain.
</li><li class="listitem">
Make sure that the SPN is correctly configured in the destination/trusting
domain. Kerberos will do the rest for you. The GC (Global Catalog) will locate
the SPN within the forest and indicate to the client in the source/trusted
domain the necessary steps to get a Kerberos service ticket for the destination
domain/user (in our case the <span class="emphasis"><em>SLSaccount</em></span>).
</li></ul></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="_different_forests_forest_trust_between_ad_forests"></a>Different forests: Forest Trust between AD forests</h4></div></div></div><p>This is the first and "clean" method you can use to cross forests with the
SPNEGO authentication.</p><p>The following requirements need to be fullfilled:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
Make sure both forests are raised to functional level 2003. To do this all
domains within the forest need to be raised to functional level 2003 too. If
this is not possible, look at the second method in Section
<a class="link" href="#x58621_Heading3Tarsec_Different_forests_multiple_SLSaccounts_in_each_forests" title="Different forests: multiple SLSaccounts in each forests">"Different forests: multiple SLSaccounts in each forests"</a>.
</li><li class="listitem">
A <span class="strong"><strong>Forest Trust</strong></span> is established between the forests (only possible if both
functional level is 2003). The reason for this is that SPNs (Service Principal
Names) are not accessible/searchable across forests if an <span class="emphasis"><em>External Trust</em></span> type
(or another type) is established.
</li><li class="listitem">
Your SES/SLS FQDN must be in the trusting domain, otherwise the SPN search
across forests won't work. This means that if the trusting domain is <span class="emphasis"><em>A.com</em></span>,
your SLS FQDN must be <span class="emphasis"><em>something.A.com.</em></span>
</li></ul></div><p>Global Catalog can locate SPNs in another forest only if a Forest Trust is
established. With this type of trust, a cross mapping of the type <span class="emphasis"><em>*.A.ch</em></span>
and <span class="emphasis"><em>*.B.ch</em></span> is made in both Global Catalog. This is what allows to find the
SPN <span class="emphasis"><em>HTTP/something.A.ch</em></span> in the other forest.</p><p>Establishing another trust type creates only a mapping with the Kerberos Realm
of the other domain, which is not sufficient for the SPN to <span class="emphasis"><em>SLSaccount</em></span>
resolution problem.</p><p>When you are browsing the Kerberos protected resource, you don't know the exact
user/Realm you are requesting access to. The only information you have is the
FQDN (retrieved from the URL). The FQDN allows you to construct the SPN and only
when it is located in the Kerberos infrastructure, you know for whom you need a
serviceticket!</p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="x58621_Heading3Tarsec_Different_forests_multiple_SLSaccounts_in_each_forests"></a>Different forests: multiple SLSaccounts in each forests</h4></div></div></div><p>There is another really usefull scenario that can be used to establish
authentication across forests if Forest Trust is not possible or if the SLS's
FQDN is not within the domain.</p><p>Kerberos uses shared secrets between entities (KDC - user or KDC - computer) to
encrypt service tickets given to users wanting to access another Kerberos
protected resource. This shared secret is, in the Microsoft Kerberos
implementation, the password for that user or computer. Since Microsoft password
hash function do not yet use a salt, if you replicate the exact username with
the same password in the second domain/forest, you can obtain service tickets
from that second domain's KDC that the first domain's user can decrypt!!</p><p>To use this Microsoft Kerberos leak to cross forests for our SPNEGO
authentication, you need to:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
Create a second <span class="emphasis"><em>SLSaccount</em></span>  in the second domain (same username and
password as in the original domain).
</li><li class="listitem">
Define the correct SPN for this account in the second domain. The SPN is
exactly the same as in the original domain. Ex: in the original domain we
defined <span class="emphasis"><em>HTTP/something.A.ch</em></span>, in the second domain we will set the SPN
<span class="emphasis"><em>HTTP/something.A.ch</em></span> to <span class="emphasis"><em>SLSaccount_even if we are in domain _B.ch</em></span>.
</li><li class="listitem">
No trusts between domains or forests is needed.
</li></ul></div><p>Once this user is replicated, a client in the second domain will be able to
find, within the same domain, a SPN corresponding to the FQDN accessed and will
obtain a service ticket for the <span class="emphasis"><em>SLSaccount_of the second domain. This ticket
will be given to the SLS SPNEGO Adapter and decrypted without any problems
since the two _SLSaccount</em></span> have the same passwod. Access will be granted to the
user.</p></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="x44667_Heading1Tarsec_Example"></a>55.7. Example</h2></div></div></div><p>In this section we will set up a minimal Kerberos Realm including an SLS on a
Windows Network and give some important hints on the general configuration.</p><div class="informalfigure"><div class="mediaobject"><img src="diagram1.png" alt="diagram1.png" /></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_installation_2"></a>55.7.1. Installation</h3></div></div></div><p>Our Network consists of three computers, connected through a ethernet hub. A
Windows 2003 Server takes the role as Active Directory Server, DNS Server, and
KDC. The SLS is running on a Windows XP machine, like the user's web browser.</p><p>.</p><div class="informaltable"><table class="informaltable" cellpadding="4px" style="border-collapse: collapse;border-top: 3px solid #527bbd; border-bottom: 3px solid #527bbd; border-left: 3px solid #527bbd; border-right: 3px solid #527bbd; "><colgroup><col class="col_1" /><col class="col_2" /><col class="col_3" /><col class="col_4" /></colgroup><thead><tr><th style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top">Role </th><th style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top">OS </th><th style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top">Computer Name </th><th style="border-bottom: 1px solid #527bbd; " align="left" valign="top">User Name</th></tr></thead><tbody><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>AD Server</p></td><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>Windows 2003</p></td><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>2test.dog.ch</p></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>Admin</p></td></tr><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>SLS</p></td><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>Windows XP</p></td><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>computer_01.dog.ch</p></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>SLSaccount</p></td></tr><tr><td style="border-right: 1px solid #527bbd; " align="left" valign="top"><p>User PC</p></td><td style="border-right: 1px solid #527bbd; " align="left" valign="top"><p>Windows XP</p></td><td style="border-right: 1px solid #527bbd; " align="left" valign="top"><p>computer_02.dog.ch</p></td><td style="" align="left" valign="top"><p>Alice</p></td></tr></tbody></table></div><p>On the Active Directory Server we generate the domain users "<code class="literal">SLSaccount</code>" and
"<code class="literal">Alice</code>". We always choose default preferences. All the three computers are
part of the domain "<code class="literal">dog.ch</code>". The users can log in to the domain at any of the
computers. For the DNS resolving we add the entry "<code class="literal">sls.dog.ch</code>" and connect it
to the IP of "<code class="literal">computer_01</code>". On this computer we install the SLS and configure
it to listen for "<code class="literal">/sls/auth</code>" on port 80. Section
<a class="link" href="#x56948_Heading2Tarsec_Kerberos_Configuration_for_JAAS_and_GSS_API" title="55.5.2. Kerberos Configuration for JAAS and GSS API">"Kerberos Configuration for JAAS and GSS API"</a>
and <a class="link" href="#x72584_Heading2Tarsec_SES_SLS_Configuration" title="55.5.3. SES/SLS Configuration">"SES/SLS Configuration"</a>
gives more information about configuration of the SPNEGO Adapter.</p><p>Keeping it as simple as possible - we directly access the (hidden) login site of
the SLS "<code class="literal">http://sls.dog.ch/sls/auth</code>". The part of configuring SES not specific
to the SPNEGO Adapter is omitted here. In a productive environment the user
would try to access a restricted site, and the SES would redirect him to the
above site.</p><p>The web browser will request the KDC for a Kerberos Service Ticket with the
currently logged in user as source, and the Service Principal Name
"<code class="literal">HTTP/sls.dog.ch</code>" as destination. We must construct the mapping between this
SPN and the Principal "<code class="literal">SLSaccount</code>". We execute the following command in a
command shell:</p><pre class="screen">setspn -a HTTP/sls.dog.ch SLSaccount</pre><p>The last step is to allow the client browser to send the SPNEGO token to the
server. Section
<a class="link" href="#x86406_Heading3Tarsec_Browser_Single_Sign_On" title="Browser Single Sign On">"Browser Single-Sign-On"</a>
explains it in detail.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_spnego_in_action"></a>55.7.2. SPNEGO in action</h3></div></div></div><p>The diagram contains several main steps (A, B, C, D) which are subdivided in a
sequence of substeps. The dotted components on the bottom are independant of
the SPNEGO Adapter and therefore not installed in our example.</p><p>A       Startup SLS</p><p>B       Logon User</p><p>C       Authentication
When A and B succeed, we start the web browser and try to load the page
"<code class="literal">sls.dog.ch/sls/auth</code>". The SLS initiates the SPNEGO login by answering with
a http status code <code class="literal">401</code> and the header "<code class="literal">WWW-Authenticate: Negotiate</code>". The
browser requests a Service Ticket for the SLS. When the SLS receives the valid
token, the user is authenticated by SLS.</p><p>D       Further processing. The user is now allowed to use the secured application.</p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_troubleshooting"></a>55.8. Troubleshooting</h2></div></div></div><p>Following a list of common problems and hints how they can be solved.</p><p><span class="strong"><strong>Your browser sends a Kerberos token, but the SLS does not accept it.</strong></span></p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
If you changed the SLSaccount password, you need to regenerate the keytab file.
Otherwise the issued Kerberos tokens are not valid. As result, your browser
sends Kerberos token received from the KDC, but the SLS cannot open and use them.
</li><li class="listitem">
Check that the <span class="emphasis"><em>krb5.conf</em></span> file on the SLS is correctly defined. The same for
the <span class="emphasis"><em>spnegoLogin.conf</em></span> file.
</li><li class="listitem">
The time difference between KDC (Domain Controller) and the SLS server is
more than 5 minutes. It is highly advisable to synchronize time periodically.
</li></ul></div><p><span class="strong"><strong>The browser sends an NTLM token (Tl….) instead of a Kerberos token (YII….)</strong></span></p><p>Most of the time it is a problem with Kerberos and its configuration. These are
possible reasons:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="emphasis"><em>SLSaccount</em></span> user is disabled, no Kerberos service ticket can be delivered
from the KDC. As result the browser uses NTLM as fallback.
</li><li class="listitem">
DNS resolution problem. If using hosts file entries, make sure you do not
have multiple names per IP address in your <code class="literal">…/system32/drivers/etc/hosts</code> file.
</li><li class="listitem">
SPN not correctly set. Check that the <span class="emphasis"><em>SLSaccount</em></span> has the correct SPN
corresponding to the host FQDN you are trying to access in your browser URL.
This can be controlled using: "<code class="literal">setspn -L SLSaccount</code>".
</li><li class="listitem">
Restart the client if one of the reasons here above is the problem. Kerberos
keeps a local cache of request failures.
</li><li class="listitem">
The client is trying to access the SES using the IP adress instead of the
FQDN. As result, no mapping with the SPN is correctly made and NTLM is used as
fallback. Check the URL used to access the SES.
</li><li class="listitem">
The Windows client logged on using cached credentials. No communication with
the KDC is possible. As result the Kerberos infrastructure is not available to
access the required resouce. NTLM tokens are used as fallback. Check the network
connectivity and reboot the client.
</li></ul></div><p><span class="strong"><strong>Client does not send any "Authorization: Negotiate …." header</strong></span></p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
Check the browser configuration. Kerberos negotiation need to be allowed for
specific URL. See Section
<a class="link" href="#x86406_Heading3Tarsec_Browser_Single_Sign_On" title="Browser Single Sign On">"Browser Single-Sign-On"</a>
for more details.
</li><li class="listitem">
Your Windows user is not currently logged into the Windows Domain or an error
with the login occured. As conseguence, no Kerberos ticket can be fetched from
the KDC (Domain Controller).
</li></ul></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_activate_kerberos_debug_logging"></a>55.8.1. Activate Kerberos debug logging</h3></div></div></div><p>Set the SLS config property <code class="literal">system.property.sun.security.krb5.debug=true</code> and also <code class="literal">debug=true</code>
in <code class="literal">spnegoLogin.conf</code>,  for example like this:</p><pre class="screen">com.sun.security.jgss.krb5.initiate {

  com.sun.security.auth.module.Krb5LoginModule required debug=true
     storeKey=true
     useKeyTab=true
     keyTab="/path/to/WEB-INF/acme.keytab"
     principal="HTTP/acme.org@ACME.ORG";

};</pre><p>Trace output is written to stdout, which on a Tomcat ends up normally in the <code class="literal">catalina.out</code>
log file.</p><p>Note that if the HTTP Adapter is used with SPNEGO-authenticated callouts, its settings might
interfere. In particular, if the property <code class="literal">sun.security.krb5.debug</code> is set (without
<code class="literal">system.property.</code> prefix),  the HTTP Adapter sets the System Property
<code class="literal">sun.security.krb5.debug</code> to the specified value at very callout with SPNEGO authentication.</p></div></div><div class="glossary"><div class="titlepage"><div><div><h2 class="title"><a id="_glossary_3"></a>Glossary</h2></div></div></div><p><span class="strong"><strong>Active Directory</strong></span></p><p>Directory service by Microsoft for central authentication and authorization in
Windows based networks.</p><p><span class="strong"><strong>FQDN</strong></span></p><p>Full Qualified Domain Name. Ex: www.google.com.</p><p><span class="strong"><strong>GSSAPI</strong></span></p><p>Generic Security Services Application Program Interface</p><p><span class="strong"><strong>Kerberos</strong></span></p><p>A standardized computer network authentication protocol.</p><p><span class="strong"><strong>Keytab</strong></span></p><p>File containing trust (keys) for a kerberos principal.</p><p><span class="strong"><strong>KDC</strong></span></p><p>The Kerberos <span class="emphasis"><em>Key Distribution Center</em></span> manages the Kerberos users, services,
keys, permissions, and tickets.</p><p><span class="strong"><strong>Realm</strong></span></p><p>A Kerberos environment with a specified name and KDC. It can be partitioned in
several Realms, and Realms can be connected.</p><p><span class="strong"><strong>SPN</strong></span></p><p>Kerberos Service Principal Name.</p><p><span class="strong"><strong>SPNEGO</strong></span></p><p>Simple and Protected GSSAPI Negotiation Mechanism</p><p><span class="strong"><strong>ST</strong></span></p><p>Kerberos Service Ticket</p><p><span class="strong"><strong>Ticket</strong></span></p><p>Kerberos uses tickets to authenticate and authorize users.</p><p><span class="strong"><strong>TGT</strong></span></p><p>Kerberos Ticket Granting Ticket.</p><p><span class="strong"><strong>Token</strong></span></p><p>The SPNEGO equivalent to a Kerberos ticket.</p></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="x10007_Heading1Tarsec_SAML_IdP_Adapter"></a>Chapter 56. SAML IdP Adapter</h2></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="SAML_IdP_Adapter_Introduction"></a>56.1. Introduction</h2></div></div></div><p>The SAML IdP Adapter implements a SAML 2.0 Identity Provider (IdP).</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_use_case_saml_login_typical_example"></a>56.1.1. Use Case SAML Login (typical example)</h3></div></div></div><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
The user visits a SAML Service Provider (SP).
</li><li class="listitem">
The SP redirects to the SLS IdP (which is typically at a different domain) with a SAML AuthnRequest (authentication request).
</li><li class="listitem">
The IdP validates the AuthnRequest.
</li><li class="listitem">
The user is  authenticated using some means, typically using other SLS Adapters (e.g. username/password login with an LDAP Adapter).
</li><li class="listitem">
If the user presents the necesssary credentials, the IdP sends back a self-posting form that contains a SAML Response,
which, in turn, contains a signed SAML Assertion that confirms that the user has been authenticated.
</li><li class="listitem">
The Response is posted to the SP, the SP validates the Assertion signature and the user is authenticated at the SP.
</li></ul></div><div class="informalfigure"><div class="mediaobject"><img src="idp-login.png" alt="idp-login.png" /></div></div><p>This shows an SP-initated login. An IdP-initiated login simply starts at the IdP with authentication there
and then the Response containing the Assertion is posted to the SP without a prior AuthnRequest.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_use_case_saml_single_logout_typical_example"></a>56.1.2. Use Case SAML Single Logout (typical example)</h3></div></div></div><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
The client visits the SLS IdP Single Logout location.
</li><li class="listitem">
The IdP redirects to the first SP with a SAML LogoutRequest.
</li><li class="listitem">
The first SP logs out the user and redirects back to the IdP with a SAML LogoutResponse.
</li><li class="listitem">
The IdP redirects to the second SP with a SAML LogoutRequest.
</li><li class="listitem">
The second SP logs out the user and redirects back to the IdP with a SAML LogoutResponse.
</li><li class="listitem">
The IdP returns a page to the client with the result of the logout.
</li></ul></div><div class="informalfigure"><div class="mediaobject"><img src="idp-logout.png" alt="idp-logout.png" /></div></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_features_8"></a>56.2. Features</h2></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_features_overview"></a>56.2.1. Features overview</h3></div></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="_login"></a>Login</h4></div></div></div><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
Supports the SAML 2.0 "Web Browser SSO Profile" ("Login") with HTTP Redirect Binding
and HTTP POST Binding for the AuthnRequest and HTTP POST Binding for the Response,
SP- and IdP-initiated.
</li><li class="listitem">
Optional SAML Single Sign On (SSO). As long as the HSP session remains authenticated after a first login
of a user at the IdP, requests from other SPs (or the same SP) are automatically authenticated - except if
configuration or the AuthnRequest mandate reauthentication of the user.
</li><li class="listitem">
For the AuthnRequest, the signature can be verified, NameID Policies are supported and also enforcing a
given Authentication Context, details further below.
</li><li class="listitem">
The Assertion can contain any number of configurable attributes, is always signed and can optionally be
encrypted. The enclosing Response can optionally be signed.
</li><li class="listitem">
Any number of SPs are supported.
</li><li class="listitem">
AuthnRequest, Assertion and Response can optionally be inspected and directly modified at the level of
OpenSAML or at higher levels using various provided convenience functions.
</li><li class="listitem">
The SLS can act as an IdP Broker, i.e. it can dispatch authentication, acting as an SP, to other IdPs.
</li></ul></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="_single_logout"></a>Single Logout</h4></div></div></div><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
Supports the SAML 2.0 "Single Logout Profile" ("Single Logout") with HTTP Redirect Binding and
HTTP POST Binding for both LogoutRequest and LogoutResponse, IdP-initiated.
</li><li class="listitem">
The LogoutRequest can be sent signed, the signature of the received LogoutResponse can be verified.
</li></ul></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="_general"></a>General</h4></div></div></div><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
Lots of configurable options and JEXL functions for how to handle and create SAML messages, including
the assertion and expecially its attributes, with different levels of abstraction and depth.
</li><li class="listitem">
SAML messages and the assertion can optionally be freely manipulated after receiving them and before
sending them, even down to the OpenSAML Java API, in order to allow to provide workarounds immediately
(without a new SLS release) in cases where SAML SPs are punctually not SAML conformant.
</li></ul></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_saml_message_content_and_processing_in_detail"></a>56.2.2. SAML message content and processing in detail</h3></div></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="_login_2"></a>Login</h4></div></div></div><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p class="simpara">
Attributes and elements in the AuthnRequest are handled as follows:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem">
NameIDPolicy: Supported, the function used to create the NameID is configurable via a JEXL Expression.
</li><li class="listitem">
ForceAuthn: Supported.
</li><li class="listitem">
IsPassive: Not supported, if true authentication fails.
</li><li class="listitem">
AssertionConsumerURL, AssertionConsumerIndex: Supported, if not present URL is obtained from the SP Metadata.
</li><li class="listitem">
ProtocolBinding: Supported, defaults to POST if not present.
</li><li class="listitem">
Subject, Scoping, Conditions, AttributeConsumingServiceIndex, ProviderName: Not supported, ignored if present.
</li></ul></div></li><li class="listitem">
AssertionConsumerURL and ProtocolBinding must match an entry in the Metadata of the corresponding SP, else authentication fails.
</li><li class="listitem">
Typically, if authentication fails for reasons not related to the user not being able to present the
necessary credentials and the AuthnRequest contained both an AssertionConsumerURL and a ProtocolBinding,
a SAML error Response is sent back there.
</li><li class="listitem">
If sending back a SAML error Response is not possible, instead an error page is shown to the user.
</li><li class="listitem">
The Assertion contains Signature, Subject, Conditions, AuthnStatement and AttributeStatement, it can optionally be encrypted.
</li><li class="listitem">
A success Response contains Issuer, Status and Assertion, and optionally a Signature; encryption is not supported.
</li></ul></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="_single_logout_2"></a>Single Logout</h4></div></div></div><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
The LogoutRequest contains Issuer and NameID, and if a RelayState was sent by the SP at login, it is sent along.
</li><li class="listitem">
Logout proceeds sequentially from SP to SP. This means that if one of the SPs does exceptionally not respond
to the LogoutRequest at all, single logout remains incomplete until the user visits the IdP logout location
once more and thus triggers Single Logout to proceed with the next SP (if any). Once logout is complete
(possibly with errors from some SPs) a result page is shown to the user and the user is logged out from
the SLS IdP (the HSP session is terminated).
</li></ul></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="_key_certificate_selection_in_sp_metadata"></a>Key/Certificate selection in SP Metadata</h4></div></div></div><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>Encryption</strong></span>: The first found certificate in SP Metadata with usage "encryption" is used,
  with fallback to the first found certificate in SP Metadata with undefined usage.
</li><li class="listitem">
<span class="strong"><strong>Signature verification</strong></span>: All certificates in SP Metadata with usage "signing" or undefined usage
  are tried one after the other; all with usage "signing" are tried before any with undefined usage.
</li></ul></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_environment_prerequisites_7"></a>56.2.3. Environment / prerequisites</h3></div></div></div><p>A SAML 2.0 Service Provider must be available that supports the required Profiles and Bindings.
Of course, using an SLS as SP is  possible and supported.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_error_handling"></a>56.2.4. Error handling</h3></div></div></div><p>Error handling for a simple password login is shown in the flow chart below. The IdP tries to respond
to a SAML request message with a SAML Response whenever possible. Note that as long as the user can keep
trying to present credentials, the SP gets no response back. This is common to happen, as the user might
also simply change his mind and close the browser window, etc.</p><p>More complex login models regarding the SAML part of authentication are described later on. These cover
features like presenting the user with a SP selection page if no SAML message was present in the initial
request or automatic redirects to an URL at the corresponding SP if a SAML message contained an already
expired AuthnRequest ("bookmark issue").</p><div class="informalfigure"><div class="mediaobject"><img src="idp-errors.png" alt="idp-errors.png" /></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_sso"></a>56.2.5. SSO</h3></div></div></div><p>For SSO, after successful login, the following information is saved in the user info cookie (the cookie
value is encrypted and stored in the HSP, it does not go to the client):</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
All verified string credentials that have not explicitly secret values.
</li><li class="listitem">
A number of configurable attributes (key/value).
</li></ul></div><p>The main purpose of storing these values is that they can be reused as attribute values in the SAML Assertion.
Credentials are restored from the cookie and set to verifed.</p><p>SSO lifetime is as long as the HSP session lifetime. Note that since SPs are usually at different domains
than the IdP and thus user activity is not visible at the HSP except for the IdP logins, the HSP's
SE_L1Cds_InactiveTimeOut setting for the IdP's virtual host should be increased as desired, as well as
maybe other SE_L1Cds_\* settings.</p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_configuration_18"></a>56.3. Configuration</h2></div></div></div><p>The IdP adapter is configured through a Java properties file, usually named "<code class="literal">idp-adapter.properties</code>"
that must be installed in the "<code class="literal">WEB-INF</code>" directory of the SLS web application.</p><p>The standard SLS distribution is shipped with an example configuration file.</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="x_idp_adapter_adoc_SAML_Endpoint_Issue"></a>56.3.1. SAML Endpoint Issue</h3></div></div></div><p>In a typical SAML setup (IdP or SP), there may a problem with how the SAML API
calculcates the endpoint URL for a received message. In a SAML message exchange
between two providers, each message always contains the intended message
recipient URL. The SAML API of a receiver then basically compares the
endpoint URL in the message with the URL of the current request, and if they
don’t match, a message like this will be displayed:</p><pre class="screen">... [CC:...] [RC:...] - SAML message intended destination endpoint 'https://www.acme.com/sls/auth' did not match the recipient endpoint 'https://localhost:13533/sls/auth'</pre><p>In a Tomcat container, the URL of the current request is built from various
factors, one of them the value of the "host" request header. In a regular HSP
and SLS setup, the value of the header "host" in the incoming request will be
the name of the SLS host as configured in the SRM, e.g. "localhost:port" or some
internal hostname. As a result, the destination endpoint calculation of SAML
will fail with the above error, because the SAML message itself contains an
endpoint URL with the external (Virtual) host name, while the "host" header of
the request contains an internal hostname.</p><p><span class="strong"><strong>SLS Remedy (Version 4.40.x and newer)</strong></span></p><p>The SLS of version 4.40.x and newer contains this configuration property which
allows to enable a mechanism that lets the SLS dynamically set the correct,
external hostname in the current request based on custom headers sent by the HSP:</p><p><span class="strong"><strong><code class="literal">auto.host.header.enable</code></strong></span></p><p>Set this property to <code class="literal">true</code> to enable the fix:</p><pre class="programlisting">auto.host.header.enable=true</pre><p>For older SLS releases, where
this mechanism doesn’t exist, a change to the SRM configuration is required.</p><p><span class="strong"><strong>HSP Remedy (SLS pre-4.40.x)</strong></span></p><p>To set the "host" header in the request to the SLS to the required, external
hostname, use the <code class="literal">HGW_ForceHost</code> HSP directive, for example:</p><pre class="screen">HGW_ForceHost idp.acme.com:12345</pre><div class="note" style="margin-left: 0; margin-right: 10%;"><h3 class="title">Note</h3><p>For pre-4.40.x SLS, it is also necessary to use HTTPS (SSL) for the
connection between the SRM and the SLS.</p></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_using_the_idp_adapter"></a>56.3.2. Using the IdP Adapter</h3></div></div></div><p>A SAML credential provider must be defined (replace &lt;no&gt; by an actual number):</p><pre class="programlisting">cred.provider.&lt;no&gt;=samlidp
cred.provider.&lt;no&gt;.cred.1.type=saml
cred.provider.&lt;no&gt;.cred.1.source=header
cred.provider.&lt;no&gt;.cred.1.name=does-not-matter</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_jexl_functions_3"></a>56.3.3. JEXL Functions</h3></div></div></div><p>There are a number of IdP specific JEXL functions that are used in models and JSPs. See the SLS JEXL guide
for a description of these functions ("idp").</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_idp_adapter_configuration_properties"></a>56.3.4. IdP Adapter Configuration Properties</h3></div></div></div><p>In order to use the IdP adapter, some properties have to be defined in the
<code class="literal">idp-adapter.properties</code> file.</p><p><span class="strong"><strong>idp.entity.id</strong></span></p><p>The EntityID of the IdP. Example:</p><pre class="programlisting">idp.entity.id=https://xyz.acme.com/idp/sls</pre><p><span class="strong"><strong>idp.keystore.file</strong></span></p><p>Path and filename of the keystore that contains private key and certificate of
the IdP. Can be an absolute path or a path relative to the web application.
Example:</p><pre class="programlisting">idp.keystore.file=WEB-INF/idp/idp.jks</pre><p><span class="strong"><strong>idp.keystore.type</strong></span></p><p>The IdP keystore type. Default is JKS (a Java keystore). Example:</p><pre class="programlisting">idp.keystore.type=PKCS12</pre><p><span class="strong"><strong>idp.keystore.pass</strong></span></p><p>The IdP keystore passphrase. Example:</p><pre class="programlisting">idp.keystore.pass=jsdi284ksau1m49284j234239c3dleuw</pre><p><span class="strong"><strong>idp.keystore.keypair.alias</strong></span></p><p>The alias of the IdP key pair (private key plus certificate) in the key store.
Example:</p><pre class="programlisting">idp.keystore.keypair.alias=idp</pre><p>The key pair alias can be overridden on a per-SP basis. See the property
<code class="literal">idp.sp.&lt;no&gt;.keystore.keypair.alias</code> below.</p><p><span class="strong"><strong>idp.keystore.future.keypair.alias</strong></span></p><p>The alias of a future IdP key pair (private key plus certificate) in the key store.
Is not used by the IdP except always exported in IdP metadata, see the section
<a class="link" href="#SAML_IdP_Adapter_Replace_Key_Pair_Cert" title="56.6. Replacing the IdP key pair and certificate">Replacing the IdP key pair and certificate</a>
for how to use this setting.</p><p><span class="strong"><strong>idp.sso.&lt;binding&gt;.url</strong></span></p><p>The URL to use for each supported binding for SSO (Web Browser SSO Profile).
Binding can be "redirect", "post" or "artifact". Currently "redirect" and
"post" are supported.
The URL given is so far simply the SLS login location. Example:</p><pre class="programlisting">idp.sso.redirect.url=https://xyz.acme.com/idp/sls/auth</pre><p><span class="strong"><strong>idp.slo.&lt;binding&gt;.url</strong></span></p><p>The URL to use for each supported binding for SLO (Single Logout Profile).
Binding can be "redirect", "post" or "artifact". Currently "redirect" and
"post" are supported.
The URL given is normally the SLS location of the SLO model. Example:</p><pre class="programlisting">idp.slo.redirect.url=https://xyz.acme.com/idp/sls/slo</pre><p><span class="strong"><strong>idp.redirectWithMetaRefresh</strong></span></p><p>Determines whether to use the “meta refresh” mechanism when SAML Redirect
binding is configured.</p><p>“Meta refresh” is a feature of HTML. Redirecting with “meta refresh” is a
(non-standard) alternative to the standard HTTP Redirect (status code 302). This
feature can be a lifesaver in situations where excessive redirection with HTTP
Redirect would fail, typically in SLO scenarios with many SPs. This usually
happens because some major browsers limit the number of redirects they follow.</p><p>Allowed values are <code class="literal">true</code>, <code class="literal">false</code>, or any comma-separated combination of <code class="literal">sso</code>
and <code class="literal">slo</code>. Defaults to <code class="literal">false</code> (that is, never redirect with “meta refresh”).</p><pre class="programlisting">idp.redirectWithMetaRefresh=sso,slo</pre><p><span class="strong"><strong>idp.blockcipher</strong></span></p><p>Defines the block cipher to use for encrypting the assertion (if encrypting the
assertion). Possible values include:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<a class="ulink" href="http://www.w3.org/2001/04/xmlenc#aes256-cbc" target="_top">http://www.w3.org/2001/04/xmlenc#aes256-cbc</a>
</li><li class="listitem">
<a class="ulink" href="http://www.w3.org/2001/04/xmlenc#aes192-cbc" target="_top">http://www.w3.org/2001/04/xmlenc#aes192-cbc</a>
</li><li class="listitem">
<a class="ulink" href="http://www.w3.org/2001/04/xmlenc#aes128-cbc" target="_top">http://www.w3.org/2001/04/xmlenc#aes128-cbc</a>
</li></ul></div><p>Default is the first item in the list (unless a block cipher
is specified for a given SP).</p><p><span class="strong"><strong>idp.message.sigalg</strong></span></p><p>Defines the signature algorithm to use for signing SAML messages.
Possible values include:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<a class="ulink" href="http://www.w3.org/2001/04/xmldsig-more#rsa-sha256" target="_top">http://www.w3.org/2001/04/xmldsig-more#rsa-sha256</a>
</li><li class="listitem">
<a class="ulink" href="http://www.w3.org/2001/04/xmldsig-more#rsa-sha384" target="_top">http://www.w3.org/2001/04/xmldsig-more#rsa-sha384</a>
</li><li class="listitem">
<a class="ulink" href="http://www.w3.org/2001/04/xmldsig-more#rsa-sha512" target="_top">http://www.w3.org/2001/04/xmldsig-more#rsa-sha512</a>
</li><li class="listitem">
<a class="ulink" href="http://www.w3.org/2000/09/xmldsig#rsa-sha1" target="_top">http://www.w3.org/2000/09/xmldsig#rsa-sha1</a> (deprecated, weak)
</li></ul></div><p>Default is the first item in the list (unless a signature algorithm
is specified for a given SP).
Algorithms with SHA-1 should not be used any more unless the partner cannot
handle stronger algorithms, because SHA-1 has been broken.
Note that for Redirect Binding, i.e. signature not in XML but in request
parameters, only exactly the algorithms above are supported.</p><p>Note that for XML signatures you might want to adapt the global setting for the
<a class="link" href="#x10000_Heading1Tarsec_SAML_XML_SigRefDigAlg" title="45.1. XML Signature Reference Digest Algorithm">"XML Signature Reference Digest Algorithm"</a>
to match the strength of the strongest signature algorithm.</p><p><span class="strong"><strong>idp.issueinstant.offset.secs</strong></span></p><p>Offset in seconds to subtract from the issue instant in Assertions and
Responses. Use as workaround for problems with clock sync on IdP and SP. Note
however, that some SPs will conversely not accept Assertions that have nominally
been issued before the Request was created/sent. Default is 0. Example:</p><pre class="programlisting">idp.issueinstant.offset.secs=60</pre><p><span class="strong"><strong>idp.assertion.validity.secs</strong></span></p><p>Validity period of Assertion and conditions in Assertion (issue instant offset
is added to that). Default is 600 sec (10 min). Example:</p><pre class="programlisting">idp.assertion.validity.secs=300</pre><p><span class="strong"><strong>idp.assertion.authentication.method</strong></span></p><p>Authentication method in the Assertion. Example:</p><pre class="programlisting">idp.assertion.authentication.method=urn:oasis:names:tc:SAML:2.0:ac:classes:Password</pre><p><span class="strong"><strong>idp.assertion.sigalg</strong></span></p><p>Defines the signature algorithm to use for signing SAML assertions.
Possible values include:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<a class="ulink" href="http://www.w3.org/2001/04/xmldsig-more#rsa-sha256" target="_top">http://www.w3.org/2001/04/xmldsig-more#rsa-sha256</a>
</li><li class="listitem">
<a class="ulink" href="http://www.w3.org/2001/04/xmldsig-more#rsa-sha384" target="_top">http://www.w3.org/2001/04/xmldsig-more#rsa-sha384</a>
</li><li class="listitem">
<a class="ulink" href="http://www.w3.org/2001/04/xmldsig-more#rsa-sha512" target="_top">http://www.w3.org/2001/04/xmldsig-more#rsa-sha512</a>
</li><li class="listitem">
<a class="ulink" href="http://www.w3.org/2000/09/xmldsig#rsa-sha1" target="_top">http://www.w3.org/2000/09/xmldsig#rsa-sha1</a>
</li></ul></div><p>Default is the first item in the list (unless a signature algorithm
is specified for a given SP).
Algorithms with SHA-1 should not be used any more unless the partner cannot
handle stronger algorithms, because SHA-1 has been broken.</p><p>Note that for XML signatures you might want to adapt the global setting for the
<a class="link" href="#x10000_Heading1Tarsec_SAML_XML_SigRefDigAlg" title="45.1. XML Signature Reference Digest Algorithm">"XML Signature Reference Digest Algorithm"</a>
to match the strength of the strongest signature algorithm.</p><p><span class="strong"><strong>idp.assertion.attributes.legacyFormat</strong></span></p><p>If set to false, attributes in the assertion are created such that the Assertion
is valid according to the respective XML Schema. If set to true
(which is the default if the property is not configured),
the "xs" namespace declaration is missing.</p><p>Some SPs cannot handle the new format in the case of base64 encoded attributes
if the assertion had been sent encrypted, hence the legacy format is the default.
Conversely, the Google Apps SP validates the XML Schema and rejects assertions
with the legacy attribute format. However, in the use case of Google Apps, no
attributes are currently needed anyway.</p><p><span class="strong"><strong>idp.assertion.nameid.&lt;no&gt;.format
idp.assertion.nameid.&lt;no&gt;.allowcreate
idp.assertion.nameid.&lt;no&gt;.value</strong></span></p><p>These settings define supported NameIDs. Settings are numbered from 1 upwards.</p><p>When processing an AuthnRequest, the NameID to be used is determined as follows:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">
If the AuthnRequest contains a NameIDPolicy it is taken to specify the NameID
  to use.
</li><li class="listitem">
Else, the SP metadata is consulted: the first NameIDFormat that has a
  corresponding <code class="literal">ipd.assertion.nameid.&lt;no&gt;.format</code> configuration property is
  used.
</li><li class="listitem">
Else, the first NameID in the configuration is used as a fall-back.
</li></ol></div><p>The suffixes "format" and "allowcreate" correspond to the respective entries in
the NameIDPolicy and must both match for the setting to match. The setting with
the suffix "value" defines the NameID value, typically a JEXL function is used
here.</p><p>Example:</p><pre class="programlisting">idp.assertion.nameid.1.format=urn:oasis:names:tc:SAML:2.0:nameid-format:transient
idp.assertion.nameid.1.allowcreate=true
idp.assertion.nameid.1.value=${idp.createRandomId()}</pre><p><span class="strong"><strong>idp.assertion.attr.&lt;no&gt;.nameformat
idp.assertion.attr.&lt;no&gt;.name
idp.assertion.attr.&lt;no&gt;.friendlyname
idp.assertion.attr.&lt;no&gt;.value
idp.assertion.attr.&lt;no&gt;.value.variable
idp.assertion.attr.&lt;no&gt;.value.type
idp.assertion.attr.&lt;no&gt;.profile</strong></span></p><p>These settings define the attributes to include in the Assertion, settings numbered
from 1 upwards.</p><p>(Side remark: For Google Apps, no attributes should be added,
or set <code class="literal">idp.assertion.attributes.legacyFormat</code> to false.)</p><p>The setting with suffix "nameformat" identifies the NameFormat XML attribute in the
assertion, allowed values are "basic" and "uri". (This replaces the attribute with
suffix "type" that is now deprecated but still supported with same meaning as
suffix "nameformat".)</p><p>The setting with suffix "name" is for the full name (typically a urn), the one with
suffix "friendlyname" is for a shorter name for human readers.</p><p>The value can either be indicated directly as a single string value with the setting
with suffix "value" or indirecty by indicating a variable name in the setting with
suffix "value.variable". In the latter case, the variable may contain either a single
string value or a (possibly empty) array of strings. Note that the variable name</p><p>The optional setting with suffix "value.type" allows to define the type XML attribute
of the attribute value, allowed values are "string", "base64" and "base64.provided".
For "base64", the string value(s) are first UTF-8 and then base64 encoded, for
"base64.provided" it is assumed that the string value(s) have already been encoded.
Default if not indicated is "string".</p><p>The optional setting with suffix "profile" allows to enforce a profile for the attributes.
Allowed settings are "basic" and "x500ldap". Default if not indicated is that no profile is enforced.</p><p>The first setting enforces the "Basic Attribute Profile" (name format must be "basic",
value type must be "string"), the second setting enforces the
"X500/LDAP Attribute Profile" (name format must be "uri", for each attribute value
the XML attribute "Encoding" is set to "LDAP"), see examples below.</p><p>Example 1: Basic Attribute with a single attribute value</p><pre class="programlisting">idp.assertion.attr.1.nameformat=basic
idp.assertion.attr.1.name=urn:oid:0.9.2342.19200300.100.1.1
idp.assertion.attr.1.friendlyname=uid
idp.assertion.attr.1.value=${session.getCred('USERNAME')}
idp.assertion.attr.1.profile=basic</pre><p>which is equivalent to making the following JEXL function call in the login model:</p><pre class="screen">idp.setAssertionAttributeBasic('uid', 'urn:oid:0.9.2342.19200300.100.1.1', session.getCred(\'USERNAME\'))</pre><p>The resulting attribute would look like this:</p><pre class="programlisting">&lt;saml2:Attribute
  FriendlyName="uid"
  Name="urn:oid:0.9.2342.19200300.100.1.1"
  NameFormat="urn:oasis:names:tc:SAML:2.0:attrname-format:basic"
  xmlns:saml2="urn:oasis:names:tc:SAML:2.0:assertion"
&gt;
  &lt;saml2:AttributeValue
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:type="xs:string"&gt;
      myuser
  &lt;/saml2:AttributeValue&gt;
&lt;/saml2:Attribute&gt;</pre><p>Example 2: X500/LDAP attribute with several attribute values</p><pre class="programlisting">idp.assertion.attr.2.nameformat=uri
idp.assertion.attr.2.name=urn:oid:1.3.6.1.4.1.1466.115.121.1.12
idp.assertion.attr.2.friendlyname=dn
idp.assertion.attr.2.value.variable=attribute.ldap.ismemberof
idp.assertion.attr.2.value.type=base64
idp.assertion.attr.2.profile=x500ldap</pre><p>which is equivalent to making the following JEXL function call in the login model:</p><pre class="programlisting">idp.setAssertionAttributeX500Ldap('dn', 'urn:oid:1.3.6.1.4.1.1466.115.121.1.12',attribute.ldap.ismemberof, 'base64')</pre><p>The resulting attribute would look like this (for two values):</p><pre class="programlisting">&lt;saml2:Attribute
  FriendlyName="dn"
  Name="urn:oid:1.3.6.1.4.1.1466.115.121.1.12"
  NameFormat="urn:oasis:names:tc:SAML:2.0:attrname-format:uri"
  x500:Encoding="LDAP"
  xmlns:saml2="urn:oasis:names:tc:SAML:2.0:assertion"
  xmlns:x500="urn:oasis:names:tc:SAML:2.0:profiles:attribute:X500"
&gt;
  &lt;saml2:AttributeValue
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:type="xs:base64Binary"&gt;
      Y249am9lLGRjPWFjbWUsZGM9b3Jn
  &lt;/saml2:AttributeValue&gt;
  &lt;saml2:AttributeValue
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:type="xs:base64Binary"&gt;
      Y249amFuZSxkYz1hY21lLGRjPW9yZw==
  &lt;/saml2:AttributeValue&gt;
&lt;/saml2:Attribute&gt;</pre><p><span class="strong"><strong>idp.sso.attr.&lt;no&gt;.key
idp.sso.attr.&lt;no&gt;.value
idp.sso.attr.&lt;no&gt;.value.variable</strong></span></p><p>SSO attributes, numbered from 1 upwards. Only during a user login, these values
are actually evaluated, for SSO they are taken from the last user login (i.e.
from the user info cookie).</p><p>The value can either be indicated directly as a single string value with the
setting with suffix "value" or indirecty by indicating a variable name in the
setting with suffix "value.variable". In the latter case, the variable may
contain either a single string value or a (possibly empty) array of strings.
Note that the variable name must be indicated as a constant, e.g. "var", not as
a JEXL expression, e.g. "${var}".</p><p>Example:</p><pre class="programlisting">idp.sso.attr.1.key=email
idp.sso.attr.1.value=${&lt;some-jexl-expression&gt;}</pre><p><span class="strong"><strong>idp.sp.&lt;no&gt;.\</strong></span>*</p><p>Settings that define things that are specific per SP. See immediately below for
the specific settings.</p><p><span class="strong"><strong>idp.sp.&lt;no&gt;.alias</strong></span></p><p>This optional setting defines an alias for the SP. Default if not indicated is
the the EntityID from the SP Metadata. The idea is to chose a short unique ID
like "acme-ltd-sp" that can then be used to parametrize things, e.g. as part of
a file name and also serve as a key to a obtain e.g. a human readable
description of the SP from message resources, e.g. "Acme Ltd. Service
Provider".</p><p><span class="strong"><strong>idp.sp.&lt;no&gt;.metadata.provider</strong></span></p><p>Defines the provider to use for obtaining SP Metadata. Currently only "file" is
supported.</p><p><span class="strong"><strong>idp.sp.&lt;no&gt;.metadata.location</strong></span></p><p>Defines the location to get SP Metadata from. Currently for type "file" this
must be the path and file name of the SP Metadata file. Can be an absolute path
or a path relative to the web application.</p><p><span class="strong"><strong>NOTE</strong></span>: The metadata XML file may use <code class="literal">&lt;xi:include</code> tags in order to separate
parts of the metadata file from its XML structure, e.g. the certificate data:</p><pre class="screen">&lt;xi:include xmlns:xi="http://www.w3.org/2001/XInclude" parse="text"
    href="...certificate data text file..."/&gt;&lt;/ds:X509Certificate&gt;</pre><p><span class="strong"><strong>idp.sp.&lt;no&gt;.blockcipher</strong></span></p><p>Defines the block cipher to use for encrypting the assertion to the given SP
(if encrypting the assertion). Possible values include:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<a class="ulink" href="http://www.w3.org/2001/04/xmlenc#aes256-cbc" target="_top">http://www.w3.org/2001/04/xmlenc#aes256-cbc</a>
</li><li class="listitem">
<a class="ulink" href="http://www.w3.org/2001/04/xmlenc#aes192-cbc" target="_top">http://www.w3.org/2001/04/xmlenc#aes192-cbc</a>
</li><li class="listitem">
<a class="ulink" href="http://www.w3.org/2001/04/xmlenc#aes128-cbc" target="_top">http://www.w3.org/2001/04/xmlenc#aes128-cbc</a>
</li></ul></div><p>Default is <code class="literal">idp.blockcipher</code>, resp. if that is not defined the first item
in the list above.</p><p><span class="strong"><strong>idp.sp.&lt;no&gt;.assertion.encrypt</strong></span></p><p>Indicates whether to encrypt SAML Assertions sent to the SP or not. The setting
can be set generally for all profiles and bindings ("true" or "false") or it
can be set individually with a comma separated list of "&lt;profile&gt;.&lt;binding&gt;"
pairs. Allowed values for profile are "sso" and "slo"; allowed values for
binding are "redirect", "post" and "artifact". So far only the pair "sso.post"
has any effect here.</p><p>Default is "false".</p><p><span class="strong"><strong>idp.sp.&lt;no&gt;.assertion.sigalg</strong></span></p><p>Defines the signature algorithm to use for signing SAML assertions for the given SP.
Possible values include:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<a class="ulink" href="http://www.w3.org/2001/04/xmldsig-more#rsa-sha256" target="_top">http://www.w3.org/2001/04/xmldsig-more#rsa-sha256</a>
</li><li class="listitem">
<a class="ulink" href="http://www.w3.org/2001/04/xmldsig-more#rsa-sha384" target="_top">http://www.w3.org/2001/04/xmldsig-more#rsa-sha384</a>
</li><li class="listitem">
<a class="ulink" href="http://www.w3.org/2001/04/xmldsig-more#rsa-sha512" target="_top">http://www.w3.org/2001/04/xmldsig-more#rsa-sha512</a>
</li><li class="listitem">
<a class="ulink" href="http://www.w3.org/2000/09/xmldsig#rsa-sha1" target="_top">http://www.w3.org/2000/09/xmldsig#rsa-sha1</a> (deprecated, weak)
</li></ul></div><p>Default is <code class="literal">idp.assertion.sigalg</code>, resp. if that is not defined the first item
in the list above.
Algorithms with SHA-1 should not be used any more unless the partner cannot
handle stronger algorithms, because SHA-1 has been broken.</p><p>Note that for XML signatures you might want to adapt the global setting for the
<a class="link" href="#x10000_Heading1Tarsec_SAML_XML_SigRefDigAlg" title="45.1. XML Signature Reference Digest Algorithm">"XML Signature Reference Digest Algorithm"</a>
to match the strength of the strongest signature algorithm.</p><p><span class="strong"><strong>idp.sp.&lt;no&gt;.message.sign</strong></span></p><p>Indicates whether to sign SAML messages sent to the SP or not. The setting can
be set generally for all profiles and bindings ("true" or "false") or it can be
set individually with a comma separated list of "&lt;profile&gt;.&lt;binding&gt;" pairs.
Allowed values for profile are "sso" and "slo"; allowed values for binding are
"redirect", "post" and "artifact". So far only the pairs "sso.post",
"slo.redirect" and "slo.post" have any effect here.</p><p>Default is "slo.redirect,slo.post".
(Note that Assertions in a success SAML Response message are always signed.)</p><p><span class="strong"><strong>idp.sp.&lt;no&gt;.message.sigalg</strong></span></p><p>Defines the signature algorithm to use for signing SAML messages to the given SP
(if signing messages). Possible values include:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<a class="ulink" href="http://www.w3.org/2001/04/xmldsig-more#rsa-sha256" target="_top">http://www.w3.org/2001/04/xmldsig-more#rsa-sha256</a>
</li><li class="listitem">
<a class="ulink" href="http://www.w3.org/2001/04/xmldsig-more#rsa-sha384" target="_top">http://www.w3.org/2001/04/xmldsig-more#rsa-sha384</a>
</li><li class="listitem">
<a class="ulink" href="http://www.w3.org/2001/04/xmldsig-more#rsa-sha512" target="_top">http://www.w3.org/2001/04/xmldsig-more#rsa-sha512</a>
</li><li class="listitem">
<a class="ulink" href="http://www.w3.org/2000/09/xmldsig#rsa-sha1" target="_top">http://www.w3.org/2000/09/xmldsig#rsa-sha1</a> (deprecated, weak)
</li></ul></div><p>Default is <code class="literal">idp.message.sigalg</code>, resp. if that is not defined the first item
in the list above.
Algorithms with SHA-1 should not be used any more unless the partner cannot
handle stronger algorithms, because SHA-1 has been broken.
Note that for Redirect Binding, i.e. signature not in XML but in request
parameters, only exactly the algorithms above are supported.</p><p>Note that for XML signatures you might want to adapt the global setting for the
<a class="link" href="#x10000_Heading1Tarsec_SAML_XML_SigRefDigAlg" title="45.1. XML Signature Reference Digest Algorithm">"XML Signature Reference Digest Algorithm"</a>
to match the strength of the strongest signature algorithm.</p><p><span class="strong"><strong>idp.sp.&lt;no&gt;.message.checksign</strong></span></p><p>Indicates whether to check signatures in SAML messages received from the SP or
not. If active, unsigned messages are also rejected. Syntax is the same as for
suffix "message.sign".  So far only the pairs "sso.redirect", "sso.post",
"slo.redirect" and "slo.post" have any effect here.</p><p>Default is "sso.redirect,sso.post,slo.redirect,slo.post".
(Note that the SP is not obligated to sign messages and if message integrity
can be enforced by other means, it may make sense to set this setting to
"false". Besides, this setting may be useful for initial setup and testing.)</p><p><span class="strong"><strong>idp.sp.&lt;no&gt;.sso</strong></span></p><p>Indicates whether to do SAML SSO or not. Default is true.</p><p><span class="strong"><strong>idp.sp.&lt;no&gt;.url</strong></span></p><p>Optional setting that allows to specify a URL at the SP which initiates a SAML
at the IdP. Default if not indicated is none (corresponding JEXL functions
return null).</p><p><span class="strong"><strong>idp.sp.&lt;no&gt;.keystore.keypair.alias</strong></span></p><p>Specifies the key pair alias to use to obtain certificate information from the
key store. This setting overrides the global setting
<code class="literal">idp.keystore.keypair.alias</code>. Specifying a specific key pair alias is
especially useful in a scenario where an IdP whose certificate is about to
expire serves a number of SPs. In such a scenario it may not be possible to
migrate all SPs to the new certificate at once. The property
<code class="literal">idp.sp.&lt;no&gt;.keystore.keypair.alias</code> makes it possible to migrate the SPs one
by one.</p><p>Example:</p><pre class="programlisting">idp.sp.1.alias=acme-ltd-sp
idp.sp.1.metadata.provider=file
idp.sp.1.metadata.location=WEB-INF/idp/acmesp-metadata.xml
idp.sp.1.message.sign=sso.post,slo.redirect
idp.sp.1.message.checksign=true
idp.sp.1.sso=false
idp.sp.1.url=https://www.acme-ltd.com/sp
idp.sp.1.keystore.keypair.alias=myidp</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_models_2"></a>56.3.5. Models</h3></div></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="_simple_login_model"></a>Simple Login Model</h4></div></div></div><p>Here is a simple login model. Note that a second adapter (e.g. LDAP) is assumed
to be defined for authentication. More complex login models essentially have to
extend the part between do.saml.idp.handlemsg and do.saml.idp.sendmsg. It is
important that the failed state of do.saml.idp.handlemsg is
do.saml.idp.sendmsg, because then the SLS attempts to send back a SAML error
Response to the SP, and only if this is not possible, displays an error page to
the user.</p><p>Note also the first model state which does nothing and which is only needed if
the login is initiated with an AuthnRequest sent with POST binding, as then
the SLS skips the first state.</p><pre class="programlisting">model.login.uri=/auth
model.login.failedState=get.cred
model.login.state.5.name=do.generic-skipped-if-post-binding
model.login.state.10.name=do.saml.idp.handlemsg
model.login.state.10.failedState=do.saml.idp.sendmsg
model.login.state.20.name=do.generic
model.login.state.20.nextState.1=do.saml.idp.sendmsg
model.login.state.20.nextState.1.if=${idp.isAuthenticated()}
model.login.state.30.name=get.cred
model.login.state.40.name=do.auth
model.login.state.50.name=do.saml.idp.sendmsg</pre></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="_metadata_model"></a>Metadata Model</h4></div></div></div><p>In order to display IdP Metadata (e.g. for import into SP configuration), a
separate model is used:</p><pre class="programlisting">model.metadata.uri=/metadata
model.metadata.failedState=show.jsp
model.metadata.state.10.name=show.jsp
model.metadata.state.10.param.jsp=jsp.idp.metadata</pre><p>The <code class="literal">IdpMetadata.jsp</code> JSP that is displayed in this model accepts an additional
query parameter <code class="literal">keypairalias</code> that may be used to specify the key pair alias
to use for obtaining the certificate from the key store (overriding the default
key pair alias specified in the global property <code class="literal">idp.keystore.keypair.alias</code>).</p><p>An example request URL for IdP metadata with key pair alias "myidp" then might
look like this:</p><pre class="screen">https://idp.somehost.com/sls/auth?cmd=metadata&amp;keypairalias=myidp</pre></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="_single_logout_model"></a>Single Logout Model</h4></div></div></div><p>Here is the typcial model for Single Logout:</p><pre class="programlisting">model.slo.uri=/slo
model.slo.failedState=show.jsp
model.slo.state.5.name=do.generic-skipped-if-post-binding
model.slo.state.10.name=do.saml.idp.handlemsg
model.slo.state.10.param.profile=SLO
model.slo.state.20.name=do.generic
model.slo.state.20.nextState.1=show.jsp
model.slo.state.20.nextState.1.if=${idp.isSloComplete()}
model.slo.state.30.name=do.saml.idp.sendmsg
model.slo.state.30.nextState=do.saml.idp.handlemsg
model.slo.state.40.name=show.jsp
model.slo.state.40.param.jsp=jsp.idp.logoutresult</pre></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="_login_model_flexible_attributes_with_templates"></a>Login Model: Flexible Attributes with Templates</h4></div></div></div><p>With the settings <code class="literal">idp.sso.attr.&lt;no&gt;.key</code> and <code class="literal">idp.sso.attr.&lt;no&gt;.value</code> it is only possible
to define a fixed list of attributes for the SAML Assertion, i.e. the list is the same for
Responses to all SPs with identical attribute names, only the values can be calculated
selectively with JEXL expressions.</p><p>(Side remark: For Google Apps, no attributes should be added,
or set <code class="literal">idp.assertion.attributes.legacyFormat</code> to false.)</p><p>In cases where this is not flexible enough, it is possible to configure attributes flexibly
in the model and to define attribute templates via JEXL scripts.</p><p>A typical login model which defines attributes separately for its two SPs could be configured as follows:</p><pre class="programlisting">model.login.uri=/auth
model.login.failedState=get.cred
model.login.state.10.name=do.saml.idp.handlemsg
model.login.state.10.failedState=do.saml.idp.sendmsg
model.login.state.20.name=do.generic
model.login.state.20.nextState.1=do.generic-add-attrs
model.login.state.20.nextState.1.if=${idp.isAuthenticated()}
model.login.state.30.name=get.cred
model.login.state.40.name=do.auth
model.login.state.50.name=do.generic-store-sso-variables
model.login.state.50.action.1=${session.setUserInfoValue('domain', &lt;jexl-expression-that-determines-domain&gt;)}
model.login.state.60.name=do.generic-add-attrs
model.login.state.60.action.1=${runscript.jexl('WEB-INF/add-attrs-' + idp.getSamlMessageIssuerAlias() + '.jexl')}
model.login.state.90.name=do.saml.idp.sendmsg</pre><p>After presenting credentials at first login, information that is needed for attributes also
later (for SAML SSO) is stored in the user info cookie in the HSP session, using
<code class="literal">session.setUserInfoValue()</code>. (Note that the USERNAME and TOKENSELECTION credentials are
remembered and restored automatically, no need to store them separately).</p><p>Before creating the Assertion and sending the SAML Response, in the state do.generic-add-attrs,
attributes are set individually per SP, which is identified by its alias obtained with
<code class="literal">idp.getSamlMessageIssuerAlias()</code>. Aliases are usually short strings like "sp1" and "sp2"
so that they can be used as part of file names of JEXL scripts as above.</p><p>(Alternatively, it would also be possible to identify SPs via their EntityID obtained with
<code class="literal">idp.getSamlMessageIssuer()</code>, but then the automatic dispatching to scripts would have
to be replaced by a sequence of ifs).</p><p>The JEXL scripts (acting as attribute templates) contain lists of statements like these:</p><pre class="screen">idp.setAssertionAttributeBasic('email', 'urn:oid:0.9.2342.19200300.100.1.3', session.getCred('USERNAME') + '@' + session.getUserInfoValue('domain'))</pre><p>The attributes defined by <code class="literal">idp.assertion.attr.&lt;no&gt;.*</code> are always added, but their values can be
overwritten in the model and new attributes can be added with the
<code class="literal">idp.setAssertionAttribute[…](…)</code> family of JEXL functions.</p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="_login_model_sp_selection_bookmark_issue"></a>Login Model: SP Selection / Bookmark Issue</h4></div></div></div><p>Experience shows that users bookmark the login location at the IdP. In case of a login with
Redirect Binding, the bookmarked URL would include a formally valid SAML AuthnRequest, which
the IdP would normally process and send a success Reponse to the SP, who would then usually
not be able to handle the response because it was for an old request.</p><p>In this case it is often desired to simply redirect the user to a login location at the
corresponding SP or maybe to let the user choose between several SPs. Similarly for access
to the login location at the IdP without any SAML message.</p><p>For this purpose, there are JEXL functions and a JSP that are typically used similarly to
the example below (the JEXL functions are in bold):</p><pre class="programlisting">model.login.uri=/auth
model.login.failedState=get.cred
# determine if have no AuthnRequest or a bookmarked one+
model.login.state.10.name=do.generic
model.login.state.10.nextState.1=do.generic-redirect-or-select-sp
model.login.state.10.nextState.1.if=${!idp.hasSamlMessage() || idp.getSamlMessageAgeSecs() &gt; 3600}
model.login.state.20.name=do.saml.idp.handlemsg
model.login.state.20.failedState=do.saml.idp.sendmsg
# (rest of normal login model not shown)
# determine redirect URL
model.login.state.10000.name=do.generic-redirect-or-select-sp
model.login.state.10000.action.1=${function.setVariable('redirectUrl', idp.getSamlMessageIssuerSpUrl())}
model.login.state.10000.nextState.1=show.jsp-select-sp
model.login.state.10000.nextState.1.if=${redirectUrl == null}
# redirect to SP
model.login.state.11000.name=do.redirect
model.login.state.11000.param.url=${redirectUrl}
model.login.state.11000.param.url.absolute.allow=true
# show SP selection JSP
model.login.state.12000.name=show.jsp-select-sp
model.login.state.12000.param.jsp=jsp.idp.spselection</pre><p>The JEXL function <code class="literal">idp.getSamlMessageIssuerSpUrl()</code> returns a URL if a SAML message was
present in the HTTP request and if there is a URL configured for the corresponding SP
(correlated via the SP EntityID in the SAML message).</p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="_login_model_idp_initiated_login"></a>Login Model: IdP-initiated Login</h4></div></div></div><p>IdP-initiated login is very similar to the SP selection described above.
The user accesses the IdP and is presented a JSP for SP selection, only that this time,
the links do not point to the login location at the SP but instead point to the IdP itself,
with a request parameter that contains the EntityID of the desired SP to log in.
In fact, it is even the same JSP that is used, except that before using it the
JEXL/Groovy variable <code class="literal">idp_IdpSpSelection_jsp_idp_initiated</code> is created and set to true.</p><p>After selecting the SP, the JEXL/Groovy <code class="literal">idp.setLoginSp(entityIdOrAlias)</code> must be
called to set the SP. Note that calls to <code class="literal">idp.isAuthenticated()</code> and <code class="literal">idp.isReauthentication()</code>
for SSO should only be called <span class="emphasis"><em>after</em></span> setting the SP, because they need to know the SP; before
calling <code class="literal">idp.setLoginSp(entityIdOrAlias)</code> they both return always false.</p><pre class="programlisting">model.login-idp-init.uri=/login-idp-init
model.login-idp-init.failedState=get.cred
#
# skip SP selection JSP if SP is already indicated
model.login-idp-init.state.500.name=do.generic-skip-sp-selection-if-indicated
model.login-idp-init.state.500.nextState.1=do.generic-choose-login-sp
model.login-idp-init.state.500.nextState.1.if=${function.hasNonEmptyVariable('parameter.spentityid')}
#
# show SP selection JSP with URLs for IdP-initiated login
model.login-idp-init.state.1000.name=do.generic-select-sp
model.login-idp-init.state.1000.action.1=${function.setVariable('idp_IdpSpSelection_jsp_idp_initiated', true)}
model.login-idp-init.state.2000.name=show.jsp-select-sp
model.login-idp-init.state.2000.param.jsp=jsp.idp.spselection
#
# choose SP selected by user
model.login-idp-init.state.3000.name=do.generic-choose-login-sp
model.login-idp-init.state.3000.action.1=${function.setVariable('spEntityId', parameter.spentityid)}
model.login-idp-init.state.3000.action.2=${idp.setLoginSp(spEntityId)}
#
# skip authentication if already authenticated (SSO)
model.login-idp-init.state.4000.name=do.generic-check-sso
model.login-idp-init.state.4000.nextState.1=do.generic-store-sso-variables
model.login-idp-init.state.4000.nextState.1.if=${idp.isAuthenticated()}
#
# login at IdP
model.login-idp-init.state.5000.name=get.cred
model.login-idp-init.state.6000.name=do.auth
#
# (set assertion attributes etc., as desired, not shown)
#
# send Response with Assertion to SP
model.login-idp-init.state.9000.name=do.saml.idp.sendmsg
model.login-idp-init.state.9500.name=get.usererror</pre></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="_login_model_direct_access_to_saml_messages"></a>Login Model: Direct access to SAML messages</h4></div></div></div><p>It is possible to separate SAML message creation from message finalization (sign/encrypt)
\+sending and to modify SAML messages between these two steps. This allows, for example,
to implement workarounds in order to interoperate with SPs that punctually violate the
SAML 2.0 standard, and it allows to flexibly provide additional SAML IdP features that
are not or not yet available by SLS configuration properties or JEXL functions.</p><p>The actions and JEXL/Groovy variables in detail (applies to SAML Login, not to SAML Single Logout):</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong><code class="literal">do.saml.idp.handlemsg</code></strong></span> (mandatory):
Creates the variable <span class="emphasis"><em>idp_authn_request</em></span> which wraps the AuthnRequest.
</li><li class="listitem">
<span class="strong"><strong><code class="literal">do.saml.idp.create.assertion</code></strong></span> (optional):
Creates the variable <span class="emphasis"><em>idp_assertion</em></span>, which wraps the (yet) unsigned and unencrypted Assertion.
The assertion contains at this point only a single empty AttributeStatement, i.e.
also missing (yet) in the Assertion are attributes which have been defined by configuration
or have been added with JEXL/Groovy functions.
These attributes are kept in a separate list in the login session and are automatically added
before signing/encrypting the Assertion and sending the Response in the <code class="literal">do.saml.idp.sendmsg</code>
action.
Yet, it is still possible to define a totally custom AttributeStatement (or even several):
Just add attributes to the empty AttributeStatement via OpenSAML and don’t define/add any
attributes by configuration or with JEXL/Groovy functions, and, if desired, add additional
AttributeStatements.
</li><li class="listitem">
<span class="strong"><strong><code class="literal">do.saml.idp.createmsg</code></strong></span> (optional):
Creates the variable <span class="emphasis"><em>idp_response</em></span>, which wraps the (yet) unsigned Response message,
excluding also the Assertion.
</li><li class="listitem"><p class="simpara">
<span class="strong"><strong><code class="literal">do.saml.idp.sendmsg</code></strong></span> (mandatory):
Does two possible things:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem">
Creates the Assertion and Response if everything was OK, unless already created
using the two actions above, signs and encrypts as needed/configured and tries to send the message.
</li><li class="listitem">
Creates a SAML error message if there was an error, or if configured with corresponding
parameters (see <a class="link" href="#x11534_Heading2Tarsec_List_of_model_states" title="7.9. List of model states">"List of model states"</a>,<a class="link" href="#x39680_TableTitleTarsec_Table_4_Alphabetical_list_of_action_states" title="Table 7.3. Alphabetical list of action states">"Table 4: Alphabetical list of action states"</a> for an example of how to create custom SAML error messages).
</li></ul></div></li></ul></div><p>Between these actions, the SAML objects can be manipulated as needed via the variables.
See the JEXL Guide for the prefixes that are same as the variable names above for available methods.</p><p>A method that is available for each variable is one that returns the "raw" Java OpenSAML 2 object.
This object is bascially a 1:1 abstraction of the resulting XML elements, i.e. provides
the lowest level access with still lots of convenience in many cases.</p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="_saml_binding_selection"></a>SAML Binding Selection</h4></div></div></div><p>The Response is always sent with POST binding.</p><p>The LogoutRequest is sent with the supported binding found in the SP Metadata,
i.e. either with redirect or with POST binding.</p><p>In the generated IdP Metadata, redirect binding is listed first if both bindings
are defined via properties. This can be manually adjusted as desired when
deploying the IdP Metadata to different SPs.</p></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_sls_as_saml_2_0_idp_broker"></a>56.4. SLS as SAML 2.0 IdP Broker</h2></div></div></div><p>The SLS can act as a SAML 2.0 IdP Broker by dispatching logins to other IdPs, as follows.</p><p>An SP sends an AuthnRequest to the SLS acting as IdP. The SLS determines in the login model
whether to handle the login directly or to dispatch to another IdP, based on the AuthnRequest,
including especially an IdP list that may be contained in it, and potentially also on other parameters.</p><p>Then the SLS acts in the same login model as an SP adapter and composes an AuthnRequest for
the remote IdP, using the <code class="literal">do.saml.sp.createmsg</code> action, and then sends the AuthnRequest and
receives the Assertion, using the usual SP adapter actions.</p><p>Finally, the IdP extracts attributes from the assertion, plus potentially other elements, and
creates a new assertion for the original SP using <code class="literal">do.saml.idp.create.assertion</code>, and sends
it back to the SP, using the usual IdP adapter actions.</p><p>Here is an overview about what can be get/set in AuthnRequest and Assertion and a list of
corresponding JEXL/Groovy functions.</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_items_to_get_set"></a>56.4.1. Items to get/set</h3></div></div></div><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p class="simpara">
AuthnRequest
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem">
IDPList: The list of IdPs from which one IdP should be chosen for the actual user authentication.
</li></ul></div></li><li class="listitem"><p class="simpara">
Assertion
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem">
Attributes: The attributes of the authenticated user.
</li><li class="listitem">
AuthnContext: Access to the authentication method used to authenticate the user at the IdP.
</li></ul></div></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_proxycount_support"></a>56.4.2. ProxyCount Support</h3></div></div></div><p>There is no automatic handling of the <code class="literal">ProxyCount</code> element in the AuthnRequest.
When creating an AuthnRequest to be sent to another IdP, it must be explicitely set using the JEXL function</p><pre class="screen">sp_authn_request.setProxyCount(int value)</pre><p>Correspondingly, the ProxyCount value of a received AuthnRequest must be read using the JEXL function</p><pre class="screen">int idp_authn_request.getProxyCount()</pre><p>Increasing it during a proxying process must be done in the model using these JEXL functions.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_jexl_groovy_functions"></a>56.4.3. JEXL/Groovy functions</h3></div></div></div><p>See the JEXL Function Guide for details and possibly some additional functionality.</p><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="_idp_authn_request"></a>idp_authn_request</h4></div></div></div><p>Holder for the "AuthnRequest" that the SLS IdP received from an SP.</p><pre class="screen">- AuthnRequest getOpenSamlRequest()
- String getRequestedAuthnContextComparison()
- boolean containsRequestedAuthenticationMethod(String methodURN)
- boolean hasIdpList()
- boolean idpListContains(String providerID)
- IDPEntry getIdpListEntry(String providerID)
- List&lt;IDPEntry&gt; getIdpList()
- boolean hasProxyCount()
- int getProxyCount()</pre></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="_sp_authn_request"></a>sp_authn_request</h4></div></div></div><p>Holder for the "AuthnRequest" in the SP, created by the model state "<code class="literal">do.saml.sp.createmsg</code>", before being sent to another IdP.</p><pre class="screen">- AuthnRequest getOpenSamlRequest()
- void addToIdpList(String providerID, String name, String loc)
- void addToIdpList(String providerID)
- void addToIdpList(IDPEntry)
- void addToIdpList(List&lt;IDPEntry&gt;)
- void setProxyCount(int value)</pre></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="_idp"></a>idp</h4></div></div></div><p>Collection of JEXL functions for the SLS IdP.</p><pre class="screen">- void setAssertionAttribute(AttributeWrapper attr)
- void setAssertionAttributes(List&lt;AttributeWrapper&gt; attrs)
- void setAssertionAttribute(...)
- void setAssertionAttributeBasic(...)
- void setAssertionAttributeX500Ldap(...)
- Assertion createAssertion()
- String sealAssertion()</pre></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="_idp_assertion"></a>idp_assertion</h4></div></div></div><p>Holder for the assertion created in the SLS IdP by the model state "<code class="literal">do.saml.idp.create.assertion</code>",
before being sent to the SP.</p><pre class="screen">- Assertion getOpenSamlAssertion()
- void setAuthenticationMethod(String methodURN)</pre></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="_sp_assertion"></a>sp_assertion</h4></div></div></div><p>Holder for the assertion in the SLS SP, as received from an IdP.</p><pre class="screen">- Assertion getOpenSamlAssertion()
- String getAuthenticationMethod()
- AttributeWrapper getAssertionAttribute(String name)
- AttributeWrapper getAssertionAttributeByFriendlyName(String friendlyName)
- List&lt;AttributeWrapper&gt; getAssertionAttributes()</pre></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="_idp_response"></a>idp_response</h4></div></div></div><p>Holder for the SAML response in the IdP as created by the model state "<code class="literal">do.saml.idp.createmsg</code>",
before being sent to the SP. This state will also create an assertion object if none was created before.</p><pre class="screen">- Response getOpenSamlResponse()
- Assertion getOpenSamlAssertion()</pre></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="_apidoc_saml_attribute_attributewrapper"></a>apidoc_saml_attribute (AttributeWrapper)</h4></div></div></div><pre class="screen">- Attribute getOpenSamlAttribute()
- String getName()
- String getFriendlyName()
- String getNameFormat()
- String getShortNameFormat()
- String getValueType()
- String getShortValueType()
- String getValue()
- List&lt;String&gt; getValues()
- byte[] getBase64DecodedValue()
- List&lt;byte[]&gt; getBase64DecodedValues()</pre></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="_apidoc_saml_idp_entry_idpentry"></a>apidoc_saml_idp_entry (IDPEntry)</h4></div></div></div><pre class="screen">String getProviderID()
void setProviderID(String providerID)
String getName()
void setName(String name)
String getLoc()
void setLoc(String loc)</pre></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_change_of_username_credential"></a>56.5. Change of Username Credential</h2></div></div></div><p>By default, if the username credential stored in the user info cookie of the HSP
session differs from the username credential stored in the login session, the
credential in the session is removed and a warning is logged.</p><p>However, in an IdP Broker, the broker itself does not authenticate users directly
and trusted IdPs may provide different username strings for the same user. This
can happen normally, for example, if the user logged in at IdP A with username
"johndoe" and later on logged in at IdP B with username "jdoe@acme.org".</p><p>In order to support this use case, it is possible to declare the username credential
received from the IdP as "mutable", by adding an additional parameter
<code class="literal">mutableUsernameCredential</code> to the <code class="literal">do.saml.sp.handlemsg</code> action:</p><pre class="programlisting">model.login.state.50.name=do.saml.sp.handlemsg
model.login.state.50.param.mutableUsernameCredential=true</pre><p>For security reasons, this parameter should only be set on an IdP broker and not
for a regular SAML SP. If the same SLS instance does both, determine the use case
in the login model and use a JEXL/Groovy expression for the parameter value.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="SAML_IdP_Adapter_Replace_Key_Pair_Cert"></a>56.6. Replacing the IdP key pair and certificate</h2></div></div></div><p>Say, you have a SAML IdP with 5 SPs, <span class="emphasis"><em>SP1</em></span> to <span class="emphasis"><em>SP5</em></span> and want or need
to change the IdP’s key pair / certificate, and hence also all five
SPs must become aware of the new key pair / certificate via their metadata.</p><p>In the past this required to make changes simultaneously on the IdP
and on at least one of the SPs. To do the change, say, for <span class="emphasis"><em>SP1</em></span> you
would typically add a new key pair / certificate to the keystore at
the IdP and  configure to use it only with SP1, thus you  would set
<code class="literal">idp.sp.&lt;no-of-SP1&gt;.keystore.keypair.alias=&lt;new-keystore-alias&gt;</code>,
restart the IdP and obtain metadata for SP1 with the new certificate
(or alternatively obtain the metadata offline using the command line
SLS Tool), install the new metadata at the SP and restart also the SP.</p><p>This has been greatly simplified so that IdP and SPs can be updated
at different times, basically using the same approach as Microsoft.
You can now proceed as follows:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
Add the new key pair / certificate to the IdP keystore.
</li><li class="listitem">
Configure <code class="literal">idp.keystore.future.keypair.alias=&lt;new-keystore-alias&gt;</code>.
</li><li class="listitem">
Either restart the IdP and obtain IdP metadata with both the current
  and future certificate included or use the SLS command line tool
  to generate SP metadata.
</li><li class="listitem">
Update metadata at SPs and restart them, in any order, at any time,
  the IdP is not using the future key pair / certificate, yet,
  so there is no pressure.
</li><li class="listitem">
Once all SPs have the new metadata, configure the future keystore alias
  as <code class="literal">idp.keystore.keypair.alias=&lt;new-keystore-alias&gt;</code> and restart the IdP.
  (Note that you are not forced to update all SPs, you could still define
  a dedicated key pair alias for the respective SPs at the IdP, if needed.)
</li></ul></div><p>The opposite case, where an SP needs or wants to change its key pair / certificate
that is used by one or more IdPs, is handled analogously, see the
<a class="link" href="#SAML_SP_Adapter_Replace_Key_Pair_Cert" title="57.5. Replacing the SP key pair and certificate">corresponding description</a> in the chapter about the SAML Service Provider.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_assertion_creation_by_state_or_scripted"></a>56.7. Assertion creation by state or scripted</h2></div></div></div><p>The IDP functionality of the SLS allows to create SAML assertions either by using
the corresponding model states, or the following scripting functions:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">idp.createAssertion()</code> - Perform the same functionality as the model state
<code class="literal">do.saml.idp.create.assertion</code>: It creates an assertion object in the SLS session.
Once this function has been called, it is possible to use other scripting functions
for setting / adding custom attributes etc. for the assertion, and the finally to
actually create the signed (and, depending on the configuration, encrypted) assertion
using the function below.
</li><li class="listitem">
<code class="literal">idp.sealAssertion()</code> - Seals the assertion by signing it (and possibly encrypting it)
and returns the final assertion as an XML string. This can be used to create assertions
and the use them to be propagated to an application in a HTTP header, instead of
returning them to an SP in a regular SAML flow.
</li></ul></div><p><span class="strong"><strong>NOTE 1</strong></span>: The function <code class="literal">idp.createAssertion()</code> <span class="emphasis"><em>requires</em></span> that either an actual
SAML AuthnRequest exists in the session (i.e. that an incoming AuthnRequest
had been processed by the state <code class="literal">do.saml.idp.handlemsg</code>), OR that an SP has
been selected using the script function <code class="literal">idp.setLoginSp(<span class="emphasis"><em>alias</em></span>)</code>. The reason
is that when the assertion is created, the SLS needs to know which SP it is
intended for (there must be at least one SP configured).</p><p><span class="strong"><strong>NOTE 2</strong></span>: The function <code class="literal">idp.sealAssertion()</code>, which creates the signed (and possibly
encrypted) assertion, is idempotent. This means that if the function is called once
and the assertion has not been sealed yet, it will be signed and stored in the session.
If the function is then invoked again, it will just return the already created and
finalized assertion.</p><p><span class="strong"><strong>NOTE 3</strong></span>: One <code class="literal">idp.sealAssertion()</code> has been invoked, it is not possible anymore
to change the assertion in any way (since it has been signed already). So other
scripting functions like <code class="literal">idp.setAssertionAttributeBasic()</code> cannot be used anymore
until a new assertion is created with <code class="literal">idp.createAssertion()</code>.</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_example_custom_assertion_creation"></a>56.7.1. Example Custom Assertion Creation</h3></div></div></div><p><span class="strong"><strong>Scripting Only</strong></span></p><p>This example shows some some actions in a model that use this scripting functionality
to create a SAML assertion, without the need for any actual SAML communication:</p><pre class="screen">model.login.state.1000.name=do.generic-createAssertion
model.login.state.1000.action.1=#{idp.setLoginSp('acme')}
model.login.state.1000.action.2=#{idp.createAssertion()}
# Add custom attributes
model.login.state.2000.name=do.generic-createAssertion
model.login.state.2000.action.1=#{idp.setAssertionAttributeBasic('givenName' ,'urn:oid:2.5.4.42', 'Karl-Heinz')}
model.login.state.2000.action.2=#{idp.setAssertionAttributeBasic('email' ,'urn:oid:0.9.2342.19200300.100.1.3', 'karl@acme.com')}
# Finally, create variable "assertionXml" with XML of signed assertion
model.login.state.3000.name=do.generic-createAssertion
model.login.state.3000.action.1=#{setVar('assertionXml', idp.sealAssertion()}</pre></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_sample_saml_messages_and_metadata"></a>56.8. Sample SAML messages and Metadata</h2></div></div></div><p>The following samples are intended to illustrate the SAML elements during a SAML login and logout.
Note that their exact contents depends on configuration (and may possibly also depend on the actual SLS version).</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_sample_login_messages"></a>56.8.1. Sample login messages</h3></div></div></div><p>Here is the request line for a signed SAML AuthnRequest with HTTP Redirect Binding (i.e. sent in a HTTP GET request):</p><pre class="screen">https://idp-domain.org/ite/idp/sls/auth?*SAMLRequest*=rZLdauM...w8%2BfbfYP &amp;*SigAlg*=http...sha1 &amp;*Signature*=nSQ...Y%3D</pre><p>The AuthnRequest is contained in the SAMLRequest parameter. The (optional) signature in the
two other request parameters. The SP may also provide a RelayState parameter that is later
sent back along with the SAML Response in order to correlate request and response.</p><p>Here is a simple decoded AuthnRequest:</p><pre class="programlisting">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;saml2p:AuthnRequest xmlns:saml2p="urn:oasis:names:tc:SAML:2.0:protocol"
        AssertionConsumerServiceURL="http://sp-domain.org/saml/SSO/alias/defaultAlias"
        Destination="https://idp.idp-domain.org/ite/idp/sls/auth" ForceAuthn="false"
        ID="a4i0jgbfhc2613id1g6jb4j13ebai7h" IsPassive="false"
        IssueInstant="2012-10-23T15:35:28.150Z"
        ProtocolBinding="urn:oasis:names:tc:SAML:2.0:bindings:HTTP-POST*"
                Version="2.0"&gt;
    &lt;saml2:Issuer xmlns:saml2="urn:oasis:names:tc:SAML:2.0:assertion"&gt;
        http://sp-domain.org/saml/metadata/alias/defaultAlias
    &lt;/saml2:Issuer&gt;
&lt;/saml2p:AuthnRequest&gt;</pre><p>Destination is the EntityID of the IdP, Issuer the EntityID of the SP. The SP wants a response
sent to the AssertionConsumerServiceURL with HTTP POST Binding.</p><p>To respond with POST Binding the IdP returns a HTML page with a form that posts a SAMLResponse
(plus a RelayState if one was given in request) to the AssertionConsumerServiceURL.</p><p>The Response (if login was successful) contains a SAML Assertion that is signed and contains
some attributes about the user.</p><p>Here is a sample AttributeStatement from an Assertion, which contains only a single attribute:</p><pre class="programlisting">&lt;saml2:AttributeStatement&gt;
        &lt;saml2:Attribute FriendlyName="uid"
                Name="urn:oid:0.9.2342.19200300.100.1.1"
                        NameFormat="urn:oasis:names:tc:SAML:2.0:attrname-format:basic"&gt;
                &lt;saml2:AttributeValue xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                        xsi:type="xs:string"&gt;someuserid&lt;/saml2:AttributeValue&gt;
        &lt;/saml2:Attribute&gt;
&lt;/saml2:AttributeStatement&gt;</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_sample_metadata"></a>56.8.2. Sample Metadata</h3></div></div></div><p>Here is sample IdP Metadata:</p><pre class="programlisting">&lt;?xml version="1.0" encoding="UTF-8"?&gt;&lt;md:EntityDescriptor xmlns:md="urn:oasis:names:tc:SAML:2.0:metadata" entityID="https://idp.idp-domain.org/idp/sls"&gt;
   &lt;md:IDPSSODescriptor protocolSupportEnumeration="urn:oasis:names:tc:SAML:2.0:protocol"&gt;
      &lt;md:KeyDescriptor&gt;
         &lt;ds:KeyInfo xmlns:ds="http://www.w3.org/2000/09/xmldsig#"&gt;
            &lt;ds:X509Data&gt; &lt;ds:X509Certificate&gt;MIIB...QkdjW9&lt;/ds:X509Certificate&gt;
            &lt;/ds:X509Data&gt;
         &lt;/ds:KeyInfo&gt;
      &lt;/md:KeyDescriptor&gt;
      &lt;md:NameIDFormat&gt;urn:oasis:names:tc:SAML:2.0:nameid-format:transient&lt;/md:NameIDFormat&gt;
      &lt;md:SingleSignOnService Binding="urn:oasis:names:tc:SAML:2.0:bindings:HTTP-Redirect"
         Location="https://idp-domain.org/ite/idp/sls/auth"/&gt;
      &lt;md:SingleLogoutService Binding="urn:oasis:names:tc:SAML:2.0:bindings:HTTP-Redirect"
          Location="https://idp-domain.org/ite/idp/sls/slo"/&gt;
   &lt;/md:IDPSSODescriptor&gt;
&lt;/md:EntityDescriptor&gt;</pre><p>The IdP declares its EntityID, a certificate for signatures, a SingleSignOnService and a SingleLogoutService with HTTP Redirect Binding.</p><p>SP Metadata is similarly structured, instead of an IDPSSODescriptor it contains an SPSSODescriptor with its services.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_sample_logout_messages"></a>56.8.3. Sample logout messages</h3></div></div></div><p>Here is a typical LogoutRequest message:</p><pre class="programlisting">&lt;saml2p:LogoutRequest xmlns:saml2p="urn:oasis:names:tc:SAML:2.0:protocol"
              Destination="http://sp-domain.org/saml/SingleLogout/alias/defaultAlias"
              ID="_a54db037-bc9f-4258-be6b-e6f0c3cfc179" IssueInstant="2013-02-06T10:05:07.448Z"
              Version="2.0"&gt;
   &lt;saml2:Issuer xmlns:saml2="urn:oasis:names:tc:SAML:2.0:assertion"&gt;
        https://idp.idp-domain.org/idp/sls*
   &lt;/saml2:Issuer&gt;
   &lt;saml2:NameID xmlns:saml2="urn:oasis:names:tc:SAML:2.0:assertion"
         Format="urn:oasis:names:tc:SAML:2.0:nameid-format:transient"
         NameQualifier="https://idp.idp-domain.org/idp/sls"&gt;
      _2073acb9-db26-4399-947e-371bf8bc848d
   &lt;/saml2:NameID&gt;
&lt;/saml2p:LogoutRequest&gt;</pre><p>and here is a corresponding LogoutResponse message (succesful logout in this example):</p><pre class="programlisting">&lt;saml2p:LogoutResponse xmlns:saml2p="urn:oasis:names:tc:SAML:2.0:protocol"
              Destination="https://idp.idp-domain.org/idp/sls/slo" ID="a3dbibh540h1e52hb04fc79j161f4d"
              InResponseTo="_a54db037-bc9f-4258-be6b-e6f0c3cfc179" IssueInstant="2013-02-06T10:05:07.799Z"
              Version="2.0"&gt;
   &lt;saml2:Issuer xmlns:saml2="urn:oasis:names:tc:SAML:2.0:assertion"&gt;
        http://sp-domain.org/saml/metadata/alias/defaultAlias
   &lt;/saml2:Issuer&gt;
   &lt;saml2p:Status&gt;
      &lt;saml2p:StatusCode Value="urn:oasis:names:tc:SAML:2.0:status:Success" /&gt;
   &lt;/saml2p:Status&gt;
&lt;/saml2p:LogoutResponse&gt;</pre><p>Note that when these messages are sent with Redirect Binding, they are again signed outside
of the message with separate request parameters, and a RelayState is sent along, too,
if one was received from the SP during login.</p></div></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="x10008_Heading1Tarsec_SAML_SP_Adapter"></a>Chapter 57. SAML SP Adapter</h2></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="SAML_SP_Adapter_Introduction"></a>57.1. Introduction</h2></div></div></div><p>The SAML SP Adapter implements a SAML 2.0 Service Provider (SP).</p><p>For an overview of the SAML protocols during login and single logout, including
how exchanged messages typcially look like, see the corresponding sections in
<a class="link" href="#x10007_Heading1Tarsec_SAML_IdP_Adapter" title="Chapter 56. SAML IdP Adapter">"SAML IdP Adapter"</a>.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_features_9"></a>57.2. Features</h2></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_features_overview_2"></a>57.2.1. Features overview</h3></div></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="_login_3"></a>Login</h4></div></div></div><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
Supports the SAML 2.0 "Web Browser SSO Profile" ("Login") with HTTP Redirect
Binding and HTTP POST Binding for the AuthnRequest and HTTP POST Binding for
the Response, SP- and IdP-initiated.
</li><li class="listitem">
The AuthnRequest can optionally be signed.
</li><li class="listitem">
For the Assertion, the signature is verified and decrypted, if necessary.
A signature of the enclosing Response can be verified.
</li><li class="listitem">
Any number of IdPs are supported.
</li></ul></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="_single_logout_3"></a>Single logout</h4></div></div></div><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
Supports the SAML 2.0 "Single Logout Profile" ("Single Logout") with HTTP
Redirect Binding and HTTP POST Binding for both LogoutRequest and LogoutResponse,
IdP-initiated.
</li><li class="listitem">
The signature of the LogoutRequest can be verified, the LogoutResponse
can optionally be signed.
</li></ul></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="_general_2"></a>General</h4></div></div></div><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
Lots of configurable options and JEXL functions for how to handle and create
SAML messages, with different levels of abstraction and depth.
</li><li class="listitem">
SAML messages and the assertion can optionally be freely manipulated after
receiving them and before sending them, even down to the OpenSAML Java API,
in order to allow to provide workarounds immediately (without a new SLS release)
in cases where SAML IdPs are punctually not SAML conformant.
</li></ul></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_saml_message_content_and_processing_in_detail_2"></a>57.2.2. SAML message content and processing in detail</h3></div></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="_login_4"></a>Login</h4></div></div></div><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p class="simpara">
AuthnRequest (sent to the SP):
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem">
The attributes AssertionConsumerServiceURL, Destination, ForceAuthn (false),
ID, IsPassive(false), IssueInstant, ProtocolBinding (always POST) and Version (2.0).
</li><li class="listitem">
Issuer element and an empty Scoping element.
</li><li class="listitem">
Optionally, via a JEXL function, an IdP list can be added.
</li><li class="listitem">
Using OpenSAML and JEXL functions, any part of the AuthnRequest can be modified,
as needed, before sending it.
</li></ul></div></li><li class="listitem"><p class="simpara">
Response/Assertion (received from the SP):
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem">
The signature of the Response is validated if configured to do so
(and then it a signature is mandatory).
</li><li class="listitem">
Multiple assertions in the Response are not supported; the Response must
contain exactly 1 Assertion (possibly encrypted).
</li><li class="listitem">
The Assertion must always be signed and the signature is always validated.
</li><li class="listitem"><p class="simpara">
The Conditions element, which contains, for example the validity period of
the Assertion, and other security relevant items is validated strictly according
to the SAML 2.0 standard by default.
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: square; "><li class="listitem">
By default, AudienceRestriction elements are validated according to the
SAML 2.0 standard. Optionally this check can be omitted, because in some cases
what the IdP mandates may not be relevant for the SP resp. for client and applications.
</li><li class="listitem">
By default, the OneTimeUse element, if present leads to a rejection of the
Assertion in the SLS, because due to the general architecture of the SES,
it cannot be supported strictly according to the SAML 2.0 standard.
The OneTimeUse element is unlikely to be encountered in practice, but if so,
the check can optionally be omitted and this case may then be handled as
desired in the login model.
</li><li class="listitem">
ProxyRestriction elements must be handled in the login model.
</li></ul></div></li><li class="listitem">
The presence of mandatory Assertion attributes, like Version, is verified.
</li><li class="listitem">
An Issuer element must be present.
</li><li class="listitem"><p class="simpara">
A Subject element must be present.
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: square; "><li class="listitem">
Optionally, it can be checked if the assertion contains at least one
InResponseTo attribute within SubjectConfirmationData within SubjectConfirmation
within Subject with a value equal to the ID of the AuthnRequest. This is quite
commonly the case, but several elements in this check are optional according
to the SAML 2.0 standard.
</li></ul></div></li><li class="listitem">
Advice elements are ignored (the SAML 2.0 standard explictly allows to do).
</li><li class="listitem">
Statement elements are ignored.
</li><li class="listitem">
For AuthnStatement elements, if a SessionNotOnOrAfter is specified, it is
validated (as mandated by the SAML 2.0 standard).
</li><li class="listitem">
AttributeStatement and AuthzDecision elements are ignored.
</li><li class="listitem">
Using OpenSAML and JEXL functions, any part of the Response and the Assertion
can be further validated, as needed.
</li></ul></div></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="_key_certificate_selection_in_idp_metadata"></a>Key/Certificate selection in IdP Metadata</h4></div></div></div><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>Encryption</strong></span>: The first found certificate in IdP Metadata with usage "encryption" is used,
  with fallback to the first found certificate in IdP Metadata with undefined usage.
</li><li class="listitem">
<span class="strong"><strong>Signature verification</strong></span>: All certificates in IdP Metadata with usage "signing" or undefined usage
  are tried one after the other; all with usage "signing" are tried before any with undefined usage.
</li></ul></div></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_environment_prerequisites_8"></a>57.3. Environment / prerequisites</h2></div></div></div><p>A SAML 2.0 Identity Provider must be available that supports the required
Profiles and Bindings. Of course, using an SLS as IdP is  possible and supported.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_configuration_19"></a>57.4. Configuration</h2></div></div></div><p>The SP adapter is configured through a Java properties file, usually named
"<code class="literal">sp-adapter.properties</code>" that must be installed in the "<code class="literal">WEB-INF</code>" directory
of the SLS web application.</p><p>The standard SLS distribution is shipped with an example configuration file.</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_saml_endpoint_issues"></a>57.4.1. SAML Endpoint Issues</h3></div></div></div><p>Please see chapter <a class="link" href="#x_idp_adapter_adoc_SAML_Endpoint_Issue" title="56.3.1. SAML Endpoint Issue">"SAML Endpoint Issue"</a>
for important information about avoiding problems with the SAML endpoint URL.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_using_the_sp_adapter"></a>57.4.2. Using the SP Adapter</h3></div></div></div><p>A SAML credential provider must be defined (replace &lt;no&gt; by an actual number):</p><pre class="programlisting">cred.provider.&lt;no&gt;=sp
cred.provider.&lt;no&gt;.cred.1.type=saml
cred.provider.&lt;no&gt;.cred.1.source=header
cred.provider.&lt;no&gt;.cred.1.name=does-not-matter</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_jexl_functions_4"></a>57.4.3. JEXL Functions</h3></div></div></div><p>There are a number of SP specific JEXL functions that are used in models and JSPs.
See the SLS JEXL guide for a description of these functions ("sp").</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_sp_adapter_configuration_properties"></a>57.4.4. SP Adapter Configuration Properties</h3></div></div></div><p>In order to use the SP adapter, some properties have to be defined in the
<code class="literal">sp-adapter.properties</code> file.</p><p>Please also consider the follwing
<a class="link" href="#x_sp_adapter_adoc_Security_Concerns" title="Security Concerns, esp. IdP-Initiated Login">Security Concerns</a>.</p><p><span class="strong"><strong>sp.entity.id</strong></span></p><p>The EntityID of the SP. Example:</p><pre class="programlisting">sp.entity.id=https://xyz.acme.com/sp/sls</pre><p><span class="strong"><strong>sp.keystore.file</strong></span></p><p>Path and filename of the keystore that contains private key and certificate of
the SP. Can be an absolute path or a path relative to the web application.
Example:</p><pre class="programlisting">sp.keystore.file=WEB-INF/sp/sp.jks</pre><p><span class="strong"><strong>sp.keystore.type</strong></span></p><p>The SP keystore type. Default is JKS (a Java keystore). Example:</p><pre class="programlisting">sp.keystore.type=PKCS12</pre><p><span class="strong"><strong>sp.keystore.pass</strong></span></p><p>The SP keystore passphrase. Example:</p><pre class="programlisting">sp.keystore.pass=jsdi284ksau1m49284j234239c3dleuw</pre><p><span class="strong"><strong>sp.keystore.keypair.alias</strong></span></p><p>The alias of the SP key pair (private key plus certificate) in the key store.
Example:</p><pre class="programlisting">sp.keystore.keypair.alias=sp</pre><p>The key pair alias can be overridden on a per-IdP basis. See the property
<code class="literal">sp.idp.&lt;no&gt;.keystore.keypair.alias</code> below.</p><p><span class="strong"><strong>sp.keystore.future.keypair.alias</strong></span></p><p>The alias of a future SP key pair (private key plus certificate) in the key store.
Is not used by the SP except always exported in SP metadata, see the section
<a class="link" href="#SAML_SP_Adapter_Replace_Key_Pair_Cert" title="57.5. Replacing the SP key pair and certificate">Replacing the SP key pair and certificate</a>
for how to use this setting.</p><p><span class="strong"><strong>sp.sso.&lt;binding&gt;.url</strong></span></p><p>The URL to use for each supported binding for SSO (Web Browser SSO Profile).
Binding can be "redirect", "post" or "artifact". Currently only "post" is
supported. The URL given is so far simply the SLS login location. Example:</p><pre class="programlisting">sp.sso.post.url=https://xyz.acme.com/sp/sls/auth</pre><p><span class="strong"><strong>sp.slo.&lt;binding&gt;.url</strong></span></p><p>The URL to use for each supported binding for SLO (Single Logout Profile).
Binding can be "redirect", "post" or "artifact". Currently "redirect" and
"post" are supported. The URL given is normally the SLS location of the SLO model.
Example:</p><pre class="programlisting">sp.slo.redirect.url=https://xyz.acme.com/sp/sls/slo</pre><p><span class="strong"><strong>sp.redirectWithMetaRefresh</strong></span></p><p>Determines whether to use the “meta refresh” mechanism when SAML Redirect
binding is configured.</p><p>“Meta refresh” is a feature of HTML. Redirecting with “meta refresh” is a
(non-standard) alternative to the standard HTTP Redirect (status code 302). This
feature can be a lifesaver in situations where excessive redirection with HTTP
Redirect would fail, typically in SLO scenarios with many SPs. This usually
happens because some major browsers limit the number of redirects they follow.</p><p>Allowed values are <code class="literal">true</code>, <code class="literal">false</code>, or any comma-separated combination of <code class="literal">sso</code>
and <code class="literal">slo</code>. Defaults to <code class="literal">false</code> (that is, never redirect with “meta refresh”).</p><pre class="programlisting">sp.redirectWithMetaRefresh=sso,slo</pre><p><span class="strong"><strong>sp.message.sigalg</strong></span></p><p>Defines the signature algorithm to use for signing SAML messages.
Possible values include:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<a class="ulink" href="http://www.w3.org/2001/04/xmldsig-more#rsa-sha256" target="_top">http://www.w3.org/2001/04/xmldsig-more#rsa-sha256</a>
</li><li class="listitem">
<a class="ulink" href="http://www.w3.org/2001/04/xmldsig-more#rsa-sha384" target="_top">http://www.w3.org/2001/04/xmldsig-more#rsa-sha384</a>
</li><li class="listitem">
<a class="ulink" href="http://www.w3.org/2001/04/xmldsig-more#rsa-sha512" target="_top">http://www.w3.org/2001/04/xmldsig-more#rsa-sha512</a>
</li><li class="listitem">
<a class="ulink" href="http://www.w3.org/2000/09/xmldsig#rsa-sha1" target="_top">http://www.w3.org/2000/09/xmldsig#rsa-sha1</a> (deprecated, weak)
</li></ul></div><p>Default is the first item in the list (unless a signature algorithm
is specified for a given IdP).
Algorithms with SHA-1 should not be used any more unless the partner cannot
handle stronger algorithms, because SHA-1 has been broken.
Note that for Redirect Binding, i.e. signature not in XML but in request
parameters, only exactly the algorithms above are supported.</p><p>Note that for XML signatures you might want to adapt the global setting for the
<a class="link" href="#x10000_Heading1Tarsec_SAML_XML_SigRefDigAlg" title="45.1. XML Signature Reference Digest Algorithm">"XML Signature Reference Digest Algorithm"</a>
to match the strength of the strongest signature algorithm.</p><p><span class="strong"><strong>sp.credential.username.nameidbased</strong></span></p><p>Whether to use the NameID value of the Subject element in the Assertion for the
username credential.</p><p>By default, the SP adapter uses the Attribute name configured in
<code class="literal">sp.credential.username.attrname</code> to extract the username from the SAML
Assertion and use it as the username credential.</p><p>This property allows a SAML setup to use the NameID value as the username
credential instead. When this property is on ("true"), the username credential
will be extracted from the NameID, and the attribute name in
<code class="literal">sp.credential.username.attrname</code> is ignored. Default is false.</p><p>It is an error if this property is true, and the Assertion does not contain a
NameID element.</p><p>See <code class="literal">sp.idp.&lt;no&gt;.credential.username.nameidbased</code> below for how to make this
configuration in an IdP-specific manner.</p><p><span class="strong"><strong>sp.credential.username.attrname</strong></span></p><p>The <code class="literal">name</code> or <code class="literal">friendlyName</code> XML attribute of the SAML attribute in the assertion
to use as the username credential. First searched by <code class="literal">name</code> then by <code class="literal">friendlyName</code>.</p><p><code class="literal">sp.credential.username.nameidbased</code> must be off for this property to have an
effect. If <code class="literal">sp.credential.username.nameidbased</code> is on, the username credential
is based on the NameID element instead, and the attribute name is not taken into
account.</p><p>Default is "urn:oid:0.9.2342.19200300.100.1.1", the UID typically used as the
attribute name.</p><pre class="programlisting">sp.credential.username.nameidbased=false
sp.credential.username.attrname=acme:idp:user-id</pre><p><span class="strong"><strong>sp.assertion.validity.offset.allowed.secs</strong></span></p><p>The tolerated offset for the validity of the received assertion in seconds. If
set, assertions that are not valid yet or not valid any more, but within the
indicated offset, are still accepted. Default is 0. Example</p><p><span class="strong"><strong>sp.default.idp</strong></span></p><p>The EntityID or alias of the IdP to which to use for login by default.
IdP selection is processed as follows in the SLS, with highest precedence first:
HTTP request parameter <code class="literal">idpentityid</code>,
IdP set with the JEXL/Groovy function <code class="literal">idp.selectIdp(entityIdOrAlias))</code>,
property <code class="literal">sp.default.idp</code>,
the IdP with the lowest index in config properties.</p><pre class="programlisting">sp.assertion.validity.offset.allowed.secs=60</pre><p><span class="strong"><strong>sp.idp.&lt;no&gt;.\</strong></span>*</p><p>Settings that define things that are specific per IdP. See immediately below for
the specific settings.</p><p><span class="strong"><strong>sp.idp.&lt;no&gt;.alias</strong></span></p><p>This optional setting defines an alias for the IdP. Default if not indicated is
the the EntityID from the IdP Metadata. The idea is to chose a short unique ID
like "acme-ltd-idp" that can then be used to parametrize things, e.g. as part
of a file name and also serve as a key to a obtain e.g. a human readable
description of the IdP from message resources, e.g. "Acme Ltd. Identity
Provider".</p><p><span class="strong"><strong>sp.idp.&lt;no&gt;.metadata.provider</strong></span></p><p>Defines the provider to use for obtaining SP Metadata. Currently only "file" is
supported.</p><p><span class="strong"><strong>sp.idp.&lt;no&gt;.metadata.location</strong></span></p><p>Defines the location to get IdP Metadata from. Currently for type "file" this
must be the path and file name of the IdP Metadata file. Can be an absolute
path or a path relative to the web application.</p><p><span class="strong"><strong>NOTE</strong></span>: The metadata XML file may use <code class="literal">&lt;xi:include</code> tags in order to separate
parts of the metadata file from its XML structure, e.g. the certificate data:</p><pre class="screen">&lt;xi:include xmlns:xi="http://www.w3.org/2001/XInclude" parse="text"
    href="...certificate data text file..."/&gt;&lt;/ds:X509Certificate&gt;</pre><p><span class="strong"><strong>sp.idp.&lt;no&gt;.message.sign</strong></span></p><p>Indicates whether to sign SAML messages sent to the IdP or not. The setting can
be set generally for all profiles and bindings ("true" or "false") or it can be
set individually with a comma separated list of "&lt;profile&gt;.&lt;binding&gt;" pairs.
Allowed values for profile are "sso" and "slo"; allowed values for binding are
"redirect", "post" and "artifact". So far only the pairs "sso.redirect",
 "sso.post", "slo.redirect" and "slo.post" have any effect here.</p><p>Default is "sso.redirect,sso.post,slo.redirect,slo.post".</p><p><span class="strong"><strong>sp.idp.&lt;no&gt;.message.sigalg</strong></span></p><p>Defines the signature algorithm to use for signing SAML messages to the given IdP.
Possible values include:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<a class="ulink" href="http://www.w3.org/2001/04/xmldsig-more#rsa-sha256" target="_top">http://www.w3.org/2001/04/xmldsig-more#rsa-sha256</a>
</li><li class="listitem">
<a class="ulink" href="http://www.w3.org/2001/04/xmldsig-more#rsa-sha384" target="_top">http://www.w3.org/2001/04/xmldsig-more#rsa-sha384</a>
</li><li class="listitem">
<a class="ulink" href="http://www.w3.org/2001/04/xmldsig-more#rsa-sha512" target="_top">http://www.w3.org/2001/04/xmldsig-more#rsa-sha512</a>
</li><li class="listitem">
<a class="ulink" href="http://www.w3.org/2000/09/xmldsig#rsa-sha1" target="_top">http://www.w3.org/2000/09/xmldsig#rsa-sha1</a> (deprecated, weak)
</li></ul></div><p>Default is <code class="literal">sp.message.sigalg</code>, resp. if that is not defined the first item
in the list above.
Algorithms with SHA-1 should not be used any more unless the partner cannot
handle stronger algorithms, because SHA-1 has been broken.
Note that for Redirect Binding, i.e. signature not in XML but in request
parameters, only exactly the algorithms above are supported.</p><p>Note that for XML signatures you might want to adapt the global setting for the
<a class="link" href="#x10000_Heading1Tarsec_SAML_XML_SigRefDigAlg" title="45.1. XML Signature Reference Digest Algorithm">"XML Signature Reference Digest Algorithm"</a>
to match the strength of the strongest signature algorithm.</p><p><span class="strong"><strong>sp.idp.&lt;no&gt;.message.checksign</strong></span></p><p>Indicates whether to check signatures in SAML messages received from the IdP or
not. If active, unsigned messages are also rejected. Syntax is the same as for
suffix "message.sign". So far only the pairs "sso.post", "slo.redirect" and
"slo.post" have any effect here.</p><p>Default is "slo.redirect,slo.post".
(Note that the assertion received during SSO is always checked for a valid
signature)</p><p><span class="strong"><strong>sp.idp.&lt;no&gt;.credential.username.nameidbased</strong></span></p><p>Whether to use the NameID value of the Subject element in the Assertion for the
username credential. Default is false.</p><p>IdP-specific override for the property <code class="literal">sp.credential.username.nameidbased</code>. See
that property for a detailed explanation.</p><p><span class="strong"><strong>sp.idp.&lt;no&gt;.credential.username.attrname</strong></span></p><p>The full name of the attribute to use as the username credential. Default is
"urn:oid:0.9.2342.19200300.100.1.1", the UID typically used as the attribute
name.</p><p>IdP-specific override for the property <code class="literal">sp.credential.username.attrname</code>. See
that property for a detailed explanation.</p><p><span class="strong"><strong>sp.idp.&lt;no&gt;.assertion.audiencerestrictions.check</strong></span></p><p>Whether to check AudienceRestriction condition elements in the assertion.
Should typically be left at its default value, which is true.</p><p><span class="strong"><strong>sp.idp.&lt;no&gt;.assertion.onetimeuse.ignore</strong></span></p><p>Whether to silently ignore a OneTimeUse condition in the assertion. Default is
false.</p><p>OneTimeUse is unlikely to be encountered in practice, but strictly by the
letter of the SAML 2.0 standard, the SLS has to reject an assertion that
contains it because due to the general architectiure of the SES it is not
possible to support OneTimeUse as required by SAML 2.0, In other words, by
default all assertions that contain OneTimeUse are rejected and by explicitly
setting to ignore, the case can be handled as desired in the login model.</p><p><span class="strong"><strong>sp.idp.&lt;no&gt;.assertion.inresponseto.require</strong></span></p><p>Whether to require that the assertion contains at least one InResponseTo
attribute within SubjectConfirmationData within SubjectConfirmation within
Subject with a value equal to the ID of the AuthnRequest. Default is false.</p><p>It is quite common that IdPs includes this information and if so, it is
recommended to activate this check. However, since several elements in this
check are only optional in the SAML 2.0 standard, the default is false so that
SAML 2.0 conformant assertions are not wrongly rejected with the default
setting.</p><p>This setting has no effect in case of an IdP-initiated login, since then there
was no initiating AuthnRequest.</p><p><span class="strong"><strong>sp.idp.&lt;no&gt;.sso.idpinit.allow</strong></span></p><p>Whether to allow IdP-initiated logins or not. Default is false.
It is recommended keep this at false whenever IdP-initiated login is not needed,
since IdP-initiated login lacks some security checks of SP-initiated login.
See <a class="link" href="#x_sp_adapter_adoc_Security_Concerns" title="Security Concerns, esp. IdP-Initiated Login">"Security Concerns"</a>.</p><p><span class="strong"><strong>sp.idp.&lt;no&gt;.sso.idpinit.inresponseto.allow</strong></span></p><p>Whether to allow <code class="literal">InResponseTo</code> for IdP-initiated login, as a Response attribute
or in the SubjectConfirmation of the Assertion. Default is false.
It is recommended to keep this setting at its default (false).
See <a class="link" href="#x_sp_adapter_adoc_Security_Concerns" title="Security Concerns, esp. IdP-Initiated Login">"Security Concerns"</a>.</p><p><span class="strong"><strong>sp.idp.&lt;no&gt;.keystore.keypair.alias</strong></span></p><p>Specifies the key pair alias to use to obtain certificate information from the
key store. This setting overrides the global setting
<code class="literal">sp.keystore.keypair.alias</code>. Specifying a specific key pair alias is especially
useful in a migration scenario where the certificate of an SP is about to
expire. The property <code class="literal">idp.sp.&lt;no&gt;.keystore.keypair.alias</code> makes it possible to
migrate the dependent IdPs to a new certificate one by one.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_models_3"></a>57.4.5. Models</h3></div></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="_simple_login_model_2"></a>Simple Login Model</h4></div></div></div><p>Here is a simple login model. More complex login models essentially have to
extend the part between <code class="literal">do.saml.sp.handlemsg</code> and <code class="literal">do.saml.sp.sendmsg</code>.</p><pre class="programlisting">model.login.uri=/auth
model.login.failedState=get.usererror
model.login.state.10.name=do.generic-skip-sendmsg-if-idp-initiated-login
model.login.state.10.nextState.1=do.saml.sp.handlemsg
model.login.state.10.nextState.1.if=${sp.hasSamlMessage()}
model.login.state.20.name=do.saml.sp.sendmsg
model.login.state.30.name=do.saml.sp.handlemsg
model.login.state.40.name=do.success
model.login.state.90.name=get.usererror</pre></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="_metadata_model_2"></a>Metadata Model</h4></div></div></div><p>In order to display SP Metadata (e.g. for import into IdP configuration), a
separate model is used:</p><pre class="programlisting">model.metadata.uri=/metadata
model.metadata.failedState=show.jsp
model.metadata.state.10.name=show.jsp
model.metadata.state.10.param.jsp=jsp.sp.metadata</pre><p>The <code class="literal">SpMetadata.jsp</code> JSP that is displayed in this model accepts an additional
query parameter <code class="literal">keypairalias</code> that may be used to specify the key pair alias
to use for obtaining the certificate from the key store (overriding the default
key pair alias specified in the global property <code class="literal">sp.keystore.keypair.alias</code>).</p><p>An example request URL for SP metadata with key pair alias "mysp" then might
look like this:</p><pre class="screen">https://sp.somehost.com/sls/auth?cmd=metadata&amp;keypairalias=mysp</pre></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="_single_logout_model_2"></a>Single Logout Model</h4></div></div></div><p>Here is the typcial model for Single Logout:</p><pre class="programlisting">model.slo.uri=/slo
model.slo.failedState=get.usererror
model.slo.state.5.name=do.generic-skipped-if-post-binding
model.slo.state.10.name=do.saml.sp.handlemsg
model.slo.state.10.param.profile=SLO
model.slo.state.30.name=do.saml.sp.sendmsg
model.slo.state.40.name=get.usererror</pre><p>Note the first model state which does nothing and which is only needed if
the logout is initiated with a LogoutRequest sent with POST binding, as then
the SLS skips the first state.</p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="_login_model_direct_access_to_saml_messages_2"></a>Login Model: Direct access to SAML messages</h4></div></div></div><p>It is possible to separate SAML message creation from message finalization (sign)
\+sending and to modify SAML messages between these two steps. This allows,
for example, to implement workarounds in order to interoperate with IdPs that
punctually violate the SAML 2.0 standard, and it allows to flexibly provide
additional SAML SP features that are not or not yet available by SLS
configuration properties or JEXL functions.</p><p>The actions and JEXL/Groovy variables in detail (applies to SAML Login, not to
SAML Single Logout):</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong><code class="literal">do.saml.sp.createmsg</code></strong></span> (optional):
Creates the variable <span class="emphasis"><em>sp_authn_request</em></span>, which wraps the (yet) unsigned
AuthnRequest message.
</li><li class="listitem">
<span class="strong"><strong><code class="literal">do.saml.sp.sendmsg</code></strong></span> (mandatory):
Creates the AuthnRequest , unless already created using the action above,
and tries to sent the message.
</li><li class="listitem">
<span class="strong"><strong><code class="literal">do.saml.sp.handlemsg</code></strong></span> (mandatory):
Creates the variable <span class="emphasis"><em>sp_assertion</em></span> if the received assertion could be decrypted
(if it was decrypted) and validated.
</li></ul></div><p>Between these actions, the SAML objects can be manipulated as needed via the
variables. See the JEXL Guide for the prefixes that are same as the variable
names above for available methods.</p><p>A method that is available for each variable is one that returns the "raw"
Java OpenSAML 2 object. This object is bascially a 1:1 abstraction of the
resulting XML elements, i.e. provides the lowest level access with still
lots of convenience in many cases.</p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="_saml_binding_selection_2"></a>SAML Binding Selection</h4></div></div></div><p>The AuthnRequest is sent with the first supported binding found in the IdP
Metadata, i.e. either with redirect or with POST binding.</p><p>The LogoutResponse is sent with the same binding as the one with which the
LogoutRequest was received, if the IdP supports it, otherwise the first supported
binding found in the IdP Metadata is used, i.e. either redirect or POST.</p><p>In the generated SP Metadata, redirect binding is listed first if both bindings
are defined via properties. This can be manually adjusted as desired when
deploying the SSP Metadata to different IdPs.</p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="x_sp_adapter_adoc_Security_Concerns"></a>Security Concerns, esp. IdP-Initiated Login</h4></div></div></div><p>IdP-initiated login is generally harder to secure, mainly since there is no
AuthnRequest from the SP that can be correlated to the received <code class="literal">Response</code> and
the <code class="literal">Assertion</code> it contains. From a practical point of view there is the
additional complication that under some circumstances (SP-initiated) logins at
the IdP can  take long enough to have the login session at the SP expire before
the response is sent back from the IdP to the SP, hence a situation that looks
like an IdP-initiated login to the SP, but see details further below.</p><p>Generally it is recommended to disallow IdP-initiated login whenever possible
(keep <code class="literal">sp.idp.&lt;no&gt;.sso.idpinit.allow</code> at its default of false) and to make SP
login sessions live long enough, whenever both is practical.</p><p>In the case of SP-initiated login, the IdP should set both the <code class="literal">InResponseTo</code>
XML attribute of the Response and the <code class="literal">InResponseTo</code> in the <code class="literal">SubjectConfirmation</code>
in the Assertion to the <code class="literal">ID</code> XML attribute of the AuthnRequest.
The latter is especially helpful, as the Assertion is always  signed. Signing
both AuthnRequest and Response is recommended for even better protection.</p><p>If an <code class="literal">InResponseTo</code> is present  and there was an AuthnRequest, these checks are
always made - login fails if IDs do not match.</p><p>Conversely, by default if a Response comes in with an <code class="literal">InResponseTo</code> but there
was no AuthnRequest, the login also fails - since this may be a possible attempt
to replay an assertion obtained otherwise. In order to be able to work around
issues with expiring SP login sessions, however, it is possible to deactivate
these checks (set <code class="literal">sp.idp.&lt;no&gt;.sso.idpinit.inresponseto.allow</code> to true).</p><p>As an additional protection, the SP remembers all received Assertions during
their lifetime, thus preventing replay attacks. (Note that in the case of
several load-balanced SP instances this protection can be circumvented with a
given probability of having new logins directed to a different SP.)</p><p>Note that overall SAML Messages are always protected by TLS connections, so that
getting hold of them is not all that easy (e.g. man in the middle or access to
client or server).</p></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="SAML_SP_Adapter_Replace_Key_Pair_Cert"></a>57.5. Replacing the SP key pair and certificate</h2></div></div></div><p>Say, you have a SAML SP with 5 IdPs, <span class="emphasis"><em>IdP1</em></span> to <span class="emphasis"><em>IdP5</em></span> and want or need
to change the SP’s key pair / certificate, and hence also all five
IdPs must become aware of the new key pair / certificate via their metadata.</p><p>In the past this required to make changes simultaneously on the SP
and on at least one of the IdPs. To do the change, say, for <span class="emphasis"><em>IdP1</em></span> you
would typically add a new key pair / certificate to the keystore at
the SP and  configure to use it only with IdP1, thus you  would set
<code class="literal">sp.idp.&lt;no-of-IdP1&gt;.keystore.keypair.alias=&lt;new-keystore-alias&gt;</code>,
restart the SP and obtain metadata for IdP1 with the new certificate
(or alternatively obtain the metadata offline using the command line
SLS Tool), install the new metadata at the IdP and restart also the IdP.</p><p>This has been greatly simplified so that SP and IdPs can be updated
at different times, basically using the same approach as Microsoft.
You can now proceed as follows:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
Add the new key pair / certificate to the SP keystore.
</li><li class="listitem">
Configure <code class="literal">sp.keystore.future.keypair.alias=&lt;new-keystore-alias&gt;</code>.
</li><li class="listitem">
Either restart the SP and obtain SP metadata with both the current
  and future certificate included or use the SLS command line tool
  to generate IdP metadata.
</li><li class="listitem">
Update metadata at IdPs and restart them, in any order, at any time,
  the SP is not using the future key pair / certificate, yet,
  so there is no pressure.
</li><li class="listitem">
Once all IdPs have the new metadata, configure the future keystore alias
  as <code class="literal">sp.keystore.keypair.alias=&lt;new-keystore-alias&gt;</code> and restart the SP.
  (Note that you are not forced to update all IdPs, you could still define
  a dedicated key pair alias for the respective IdPs at the SP, if needed.)
</li></ul></div><p>The opposite case, where an IdP needs or wants to change its key pair / certificate
that is used by one or more SPs, is handled analogously, see the
<a class="link" href="#SAML_IdP_Adapter_Replace_Key_Pair_Cert" title="56.6. Replacing the IdP key pair and certificate">corresponding description</a> in the chapter about the SAML Identity Provider.</p></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="x10007_Heading1Tarsec_OIDC_OP_Adapter"></a>Chapter 58. OIDC OP Adapter</h2></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="OIDC_OP_Adapter_Introduction"></a>58.1. Introduction</h2></div></div></div><p>The OIDC OP Adapter implements an OpenID Connect (OIDC) 1.0 OpenID Provider (OP).</p><p>OpenID Connect 1.0 is an authentication protocol based on the OAuth 2.0 framework
for authorization protocols. A major use cases for OpenID Connect is mobile Apps.</p><p>The typical use case that the OP implements is the "Authorization Code Flow", in
which a mobile App (called "Client" or "Relying Party" or RP) lets the user
authenticate itself at the OP, obtains an <code class="literal">id_token</code> from the OP and then uses
this <code class="literal">id_token</code> to authenticate against web applications, often in REST calls or
similar WebService calls.</p><p>After authentication, the RP may request additional information using the OAuth
<code class="literal">access_token</code> also obtained during authentication as credential.</p><p>When the <code class="literal">id_token</code> expires, the RP can obtain a new <code class="literal">id_token</code> from the OP
via a "Refresh Request" by presenting the <code class="literal">refresh_token</code>, which had also
been obtained at authentication, as credential. (A new <code class="literal">access_token</code> is also
returned in that case and optionally the <code class="literal">refresh_token</code> can be refreshed, too.)</p><p>An overview of these typical use cases is given just below, followed by
a detailed list of supported features with sample requests and responses,
and then how to configure the OP in detail.</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_plain_oauth_2_0_as_authorization_server"></a>58.1.1. Plain OAuth 2.0 AS (Authorization Server)</h3></div></div></div><p>Since OpenID Connect is based on OAuth 2.0, it is also possible to use the SLS
as an OAuth 2.0 authorization server. As a result, certain request validation
steps are performed slightly different, and the model configuration needs to
be adapted for this. The most notable difference is that the SLS will not create
an id token in its token response when performing plain OAuth. Please refer to
<a class="link" href="#plain_oauth_mode" title="58.9. Plain OAuth 2.0 Mode">"Plain OAuth 2.0 Mode"</a> for more details.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_use_case_authorization_code_flow"></a>58.1.2. Use Case "Authorization Code Flow"</h3></div></div></div><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
The mobile App internally starts a mobile browser instance and visits the OP
  ("Authentication Request").
</li><li class="listitem">
The OP authenticates the user and returns an authorization code as a request
  parameter in the "Location" header of a 302 Redirect HTTP response.
</li><li class="listitem">
This causes the mobile browser to hand control back to the mobile App, which
  then uses the authorization code in order to obtain the actual <code class="literal">id_token</code>,
  as well as an <code class="literal">access_token</code> and a <code class="literal">refresh_token</code> ("Token Request") in a
  direct HTTP request to the OP.
</li><li class="listitem">
The <code class="literal">id_token</code> can then be used to authenticate against various backends,
  the <code class="literal">access_token</code> to retrieve user data, the <code class="literal">refresh_token</code> to refresh
  all of these tokens.
</li></ul></div><div class="informalfigure"><div class="mediaobject"><img src="oidc-op-authorization-code-flow.png" alt="oidc-op-authorization-code-flow.png" /></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_use_case_userinfo_request"></a>58.1.3. Use Case "UserInfo Request"</h3></div></div></div><p>The mobile App (or any target web application called by the RP) uses the
<code class="literal">access_token</code> to obtain further information about the user from the OP,
like name, address, email, and so on.</p><div class="informalfigure"><div class="mediaobject"><img src="oidc-op-userinfo-request.png" alt="oidc-op-userinfo-request.png" /></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_use_case_refresh_request"></a>58.1.4. Use Case "Refresh Request"</h3></div></div></div><p>When the <code class="literal">id_token</code> has expired, the mobile App uses the <code class="literal">refresh_token</code> to obtain
a new <code class="literal">id_token</code> and <code class="literal">access_token</code> and optionally also a renewed <code class="literal">refresh_token</code>.</p><div class="informalfigure"><div class="mediaobject"><img src="oidc-op-refresh-request.png" alt="oidc-op-refresh-request.png" /></div></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_features_10"></a>58.2. Features</h2></div></div></div><p>Broadly speaking, the SLS supports practically all mandatory requirements for
OpenID Connect 1.0 Authorization Code Flow, UserInfo Request and Refresh Request,
many optional requirements automatically, and additional optional requirements
can often be handled flexibly in the SLS login model with JEXL/Groovy expressions
or scripts, as needed/desired.</p><p>In addition, <span class="emphasis"><em>Proof Key for Code Exchange</em></span> (PKCE, "Pixy") and Public Clients
are also supported.</p><p>It is also possible to freely add, remove and modify claims in <code class="literal">id_token</code>,
<code class="literal">refresh_token</code> and userinfo (as well as to temporarily store some attributes
in the authorization code).</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_authorization_code_flow"></a>58.2.1. Authorization Code Flow</h3></div></div></div><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
The Authentication Request supports the parameters "response_type", "scope",
  "client_id", "redirect_uri", "state" and "nonce"; other parameters like "display"
  or "prompt" can be supported flexibly in the login model.
</li><li class="listitem">
The "response_type" must be "code" (this specifies Authorization Code Flow),
  the "scope" parameter must contain "openid", other additional values are ignored.
</li><li class="listitem">
The "max_age" parameter is not supported by default.
</li><li class="listitem">
The Token Request supports parameters "grant_type", "code" and "redirect_uri"
  and client authentication with Basic Auth or with HTTP POST parameters
  (<code class="literal">client_id</code>/<code class="literal">client_secret</code>).
</li><li class="listitem">
The "grant_type" parameter must be "authorization_code" (this identifies the type of request).
</li><li class="listitem">
The issued <code class="literal">id_token</code> is signed with the "RS256" signature algorithm
  (RSASSA-PKCS1-v1_5 using SHA-256).
  Note that the RSA signing key must have a length of at least 2048 bit.
</li><li class="listitem">
The issued <code class="literal">id_token</code> contains by default the claims "sub" (authenticated userid),
  "aud" (audience), "iss" (issuer), "iat" (issue date and time),
  "exp" (expiry date and time), "auth_time" (authentication date and time) and
  "nonce" (if got one in the Authentication Request),
  but it is possible to freely add, remove or modify any claims to the <code class="literal">id_token</code>
  in the SLS login model before the token is signed and sent back to the RP.
</li><li class="listitem">
It is also possible to remember any number of attributes between the two OIDC
  requests to support use cases where user info might only be easily obtainable
  when the user authenticates.
</li><li class="listitem">
The validity of <code class="literal">id_token</code> and <code class="literal">refresh_token</code> is configurable, as well as whether
  to renew the <code class="literal">refresh_token</code> validity period at refresh or not.
</li></ul></div><p>Sample Authentication Request (as in all examples below, additional line breaks
have only been introduced for better readability):</p><pre class="screen">https://acme.org/oidc-op/sls/auth?
response_type=code&amp;
scope=openid&amp;
client_id=s6BhdRkqt3&amp;
state=af0ifjsldkj&amp;
nonce=n-0S6_WzA2Mj&amp;
redirect_uri=app%3A%2F%2Fsome-location</pre><p>Sample Authentication Response (the state parameter is only present if there
was one in the request):</p><pre class="screen">HTTP/1.1 302 Found
Location: app://some-location
?code=SplxlOBeZQQYb
&amp;state=af0ifjsldkj</pre><p>Sample Token Request with Basic Auth:</p><pre class="screen">POST /oidc-op/sls/token HTTP/1.1
Host: acme.org
Content-Type: application/x-www-form-urlencoded
Authorization: Basic ad...ds=

grant_type=authorization_code
&amp;code=SplxlOBeZQQYb
&amp;redirect_uri=myapp%3A%2F%2Fsome-location</pre><p>Sample Token Request with POST parameter client authentication:</p><pre class="screen">POST /oidc-op/sls/token HTTP/1.1
Host: acme.org
Content-Type: application/x-www-form-urlencoded

client_id=myclient&amp;
client_secret=...&amp;
grant_type=authorization_code&amp;
code=SplxlOBeZQQYb&amp;
redirect_uri=myapp%3A%2F%2Fsome-location</pre><p>Sample Token Response:</p><pre class="screen">HTTP/1.1 200 OK
Content-Type: application/json
Cache-Control: no-store
Pragma: no-cache

{
  "id_token": "SlAV32hkKG",
  "access_token": "SlAV32hkKG",
  "refresh_token": "8xLOxBtZp8",
  "token_type": "Bearer",
  "expires_in": 3600
}</pre><p>The <code class="literal">id_token</code> is a signed JWT (JSON Web Token) with by default claims like these:</p><pre class="screen">{
  "iss": "https://acme.org",
  "sub": "24400320",
  "aud": "[acme]",
  "nonce": "n-0S6_WzA2Mj",
  "exp": 1311281970,
  "iat": 1311280970,
  "auth_time": 1311280969
}</pre><p>The "nonce" claim is only set if there was one in the initial Authentication Request.</p><p>The <code class="literal">refresh_token</code> format is not specified in the OIDC standard, in case of the SLS
OP it is currently implemented also as a signed JWT.</p><pre class="screen">{
  "exp": 1311281970,
  "revocation_id": "sdsafsfds",
  "id_token_unsigned": "asd33ed...afsafds3"
}</pre><p>Again, <code class="literal">refresh_token</code> claims can be freely added, removed or modified.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_userinfo_request"></a>58.2.2. UserInfo Request</h3></div></div></div><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
Authorization must be with an "Authorization" HTTP request header of type "Bearer"
  with the <code class="literal">access_token</code> as authentication string.
</li><li class="listitem">
By default, the returned userinfo contains only a single claim, "sub", but again
  claims can be freely added, modified and removed in the login model.
</li></ul></div><p>Sample UserInfo Request:</p><pre class="screen">GET /userinfo HTTP/1.1
Host: server.example.com
Authorization: Bearer SlAV32hkKG</pre><p>The string after "Bearer" is the <code class="literal">access_token</code>.</p><p>Sample UserInfo Response:</p><pre class="screen">HTTP/1.1 200 OK
Content-Type: application/json
Cache-Control: no-store
Pragma: no-cache

{
  "sub": "24400320",
  "email": "joe@acme.org"
}</pre><p>The OIDC 1.0 Core standard defines standard claims in "Section 5.1 Standard Claims".</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_refresh_request"></a>58.2.3. Refresh Request</h3></div></div></div><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
The Refresh Request supports parameters "grant_type" and "refresh_token"
  and client authentication with Basic Auth or with HTTP POST parameters
  (<code class="literal">client_id</code>/<code class="literal">client_secret</code>).
</li><li class="listitem">
The "grant_type" parameter must be "refresh_token" (this identifies the type of request).
</li><li class="listitem">
The returned response is formatted exactly as the response of a Token Request
  and again claims in the <code class="literal">id_token</code> and the <code class="literal">refresh_token</code> can be freely added,
  modified and removed.
</li></ul></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_discovery_endpoint"></a>58.2.4. Discovery Endpoint</h3></div></div></div><p>The SLS OP does support a Discovery endpoint URI; the following URI is mapped in the SLS
"web.xml" file, by default:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
/.well-known/openid-configuration
</li></ul></div><p>It can then be used in a model for the discovery endpoint, like this:</p><pre class="screen"># OIDC well-known configuration

model.oidc-config.uri=/.well-known/openid-configuration
model.oidc-config.failedState=get.usererror

# optionally adapt config before displaying
#model.oidc-config.state.10.name=do.generic-adaptConfig
#model.oidc-config.state.10.action.1=#{config = oidc_op.getConfig()}
#model.oidc-config.state.10.action.2=#{config.claims_supported.addAll(['myOtherClaim','andThisClaim'])}

# mandatory, show the JSP
model.oidc-config.state.30.name=show.jsp-config
model.oidc-config.state.30.property=jsp.op.config

# handle errors
model.oidc-config.state.40.name=get.usererror</pre><p>This model shows how to create a map which contains the configuration metadata, and which is
then slightly changed in the model by adding a custom claim using a script expression. Then,
the JSON is finally displayed using the JSP <code class="literal">OpConfig.jsp</code> (JSP alias <code class="literal">jsp.op.config</code>).</p><p>Example JSON:</p><pre class="screen">{
   "authorization_endpoint": /* URL of the login model for Authentication Request */,
   "token_endpoint": /* URL of the login model for Token/Refresh Request */,
   "issuer": /* oidc.op.issuer property value */,
   "jwks_uri": /* URI for the public key from the configured keystore */,
   "scopes_supported":[
      "openid"
   ],
   "response_types_supported":[
      "code"
   ],
   "token_endpoint_auth_methods_supported":[
      "client_secret_basic",
      "client_secret_post"
   ],
   "code_challenge_methods_supported":[
      "S256"
   ],
   "request_uri_parameter_supported":true,
   "subject_types_supported":[
      "public"
   ],
   "userinfo_endpoint": /* URL of the login model for UserInfo Request */,
   "end_session_endpoint": /* URL of the logout model */,
   "id_token_signing_alg_values_supported":[
      "RS256"
   ],
   "claims_supported":[
      "iss",
      "auth_time",
      "exp",
      "iat",
      "aud",
      "auth_time"
   ]
}</pre><p>(Note that <code class="literal">code_challenge_methods_supported</code> does by default not contain method <code class="literal">plain</code>,
only the more secure <code class="literal">S256</code>, since by default <code class="literal">plain</code> is not allowed unless specifically
activated per configuration property for a specific client/RP. Use the script function
<code class="literal">oidc_op.createConfigAsMap()</code> as described below to add when needed.)</p><p><span class="strong"><strong>Script Functions</strong></span></p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">oidc_op.getConfig()</code> - Returns a JSON string containing the configuration metadata. This method will internally call
<code class="literal">oidc_op.createConfigAsMap()</code>, if it had not been called yet manually (see below), and then render the JSON based on
the information in that map.
</li><li class="listitem">
<code class="literal">oidc_op.createConfigAsMap()</code> - <span class="emphasis"><em>optional</em></span> / creates the configuration metadata as a Java <code class="literal">Map&lt;String, Object&gt;</code> instance, which
can then be changed using Groovy scripting (check Groovy tutorials for how to work with maps). The same instance of
this object is also stored in the session, and used by a call to the function <code class="literal">oidc_op.getConfig()</code>, so any changes
done to the map will be reflected in the generated JSON string.
</li></ul></div><p>So, in order to customize the JSON shown in the JSP, follow these steps:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">
Call <code class="literal">oidc_op.createConfigAsMap()</code> to receive a <code class="literal">Map&lt;String, Object&gt;</code> instance.
</li><li class="listitem">
Edit the map using Groovy code.
</li><li class="listitem">
The <code class="literal">OpConfig.jsp</code> already calls <code class="literal">oidc_op.getConfig()</code> to create the JSON string.
</li></ol></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_jwks_endpoint"></a>58.2.5. JWKS Endpoint</h3></div></div></div><p>The SLS OP does support a JWKS endpoint URI; the following URIs are mapped in the SLS
"web.xml" file, by default:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
/jwks
</li><li class="listitem">
/oidc-jwks
</li><li class="listitem">
/.well-known/openid-configuration/jwks
</li></ul></div><p>One, or multiple of these can then be used in a model for the discovery endpoint, like this:</p><pre class="screen"># OIDC JWKS

model.oidc-jwks.uri.1=/jwks
model.oidc-jwks.uri.2=/oidc-jwks
model.oidc-jwks.uri.3=/.well-known/openid-configuration/jwks
model.oidc-jwks.failedState=show.jsp

# optionally adapt config before displaying
#model.oidc-jwks.state.10.name=do.generic-adaptJwks
#model.oidc-jwks.state.10.action.1=#{jwks = oidc_op.createJwksAsMap()}
#model.oidc-jwks.state.10.action.2=#{jwks.keys[0].kid = 'bla' }

model.oidc-jwks.state.1000.name=show.jsp
model.oidc-jwks.state.1000.param.jsp=jsp.op.jwks</pre><p>This model shows how to create a map which contains the key information, and which is
then slightly changed in the model by changing it using a script expression. Then,
the JSON is finally displayed using the JSP <code class="literal">OpJwks.jsp</code> (JSP alias <code class="literal">jsp.op.jwks</code>).</p><p>Example JSON:</p><pre class="screen">{
   "keys":[
      {
         "kty":"RSA",
         "x5t#S256":"aSF8nngbepSY-EbbPjdc1mqc5_M-ODqm0KLstD_sLPg",
         "e":"AQAB",
         "kid":"uspauth",
         "x5c":[
            "MIIEIjCCAwqgAwIBAgIHANFqQQYpoDANBgkqhkiG9w0BAQsFADCBjDEdMBsGA1UEAwwUU2VjdXJlIExvZ2luIFNlcnZpY2UxHDAaBgNVBAsME1NlY3VyZSBFbnRyeSBTZXJ2ZXIxIjAgBgNVBAoMGVVuaXRlZCBTZWN1cml0eSBQcm92aWRlcnMxDzANBgNVBAcMBlp1cmljaDELMAkGA1UECAwCWkgxCzAJBgNVBAYTAkNIMB4XDTE5MDQyMjE3MzUyMloXDTMwMDQxOTE3MzUyMlowgYwxHTAbBgNVBAMMFFNlY3VyZSBMb2dpbiBTZXJ2aWNlMRwwGgYDVQQLDBNTZWN1cmUgRW50cnkgU2VydmVyMSIwIAYDVQQKDBlVbml0ZWQgU2VjdXJpdHkgUHJvdmlkZXJzMQ8wDQYDVQQHDAZadXJpY2gxCzAJBgNVBAgMAlpIMQswCQYDVQQGEwJDSDCCASIwDQYJKoZIhvcNAQEBBQADggEPADCCAQoCggEBAPuZvCX+IbdYSwH3teN2v+wgs5Yq282twWLfA9I6yB6+xvQZmmhEcAJBXayqaeCC5n5oRmylG/Yp2GK4s/ZGNQFFdMjbmrk2vRdw8ZN5gyLsbY1oEV2RvhBqNfd4dPqEzLynV8ubEwwwoGpebuSB1fhfavP02OaiErtRtLCQjuok5vKSrHFlDRzd7qWrFkvzqrekc8FgDjtlpE0pnizEonI1ICmX2Kk9/LEzyyHBJ0jLrTcsQEGrwIHIPszyUirgm+d/iqnom9Xw2pvZ3WxhLIw4W6J9v89Pr2qrG9U3AFcl+mMThB9gSYilXWF3kWAMDxbMGHhaq8Kk8ILeDvBk8SsCAwEAAaOBhjCBgzAfBgNVHREEGDAWghRTZWN1cmUgTG9naW4gU2VydmljZTALBgNVHQ8EBAMCAbYwDwYDVR0TAQH/BAUwAwEB/zAjBgNVHSUEHDAaBggrBgEFBQcDAQYIKwYBBQUHAwIGBFUdJQAwHQYDVR0OBBYEFLIP03gHk52Vn0B7L4SlGA6my/KnMA0GCSqGSIb3DQEBCwUAA4IBAQA8A2NJEa7voPk+F1tPQE82FiuG0VBgOl8vBZAslUSlwj6FxTXBN5Knw+96A4AEjhlPM4KeT1xcr46rbmHaaeXqKXe9VNU2zhRbT2kJzfjYu4kDSjJiJv1hdfKi+fqCPuUyPI5rsrDGDhhZ+UgZos4n7vXb3hzdjRoMMjxdVsf39czqZpJPe5z5c11h8G3J++Fg8SKx7dqTt7nz+WzUrDdrGXvRKdKpy6p05zF3XrBh9lDcUxiy7SqCNgO3MhCtbfHF5UU0aBRjyyg43iq/AL5ZfYbY17AOh7O7L8Ihyg7F+miBoxFBLR5mTsGns0qcQThgfU9ix1Cw4zhGzZMxv81A"
         ],
         "n":"-5m8Jf4ht1hLAfe143a_7CCzlirbza3BYt8D0jrIHr7G9BmaaERwAkFdrKpp4ILmfmhGbKUb9inYYriz9kY1AUV0yNuauTa9F3Dxk3mDIuxtjWgRXZG-EGo193h0-oTMvKdXy5sTDDCgal5u5IHV-F9q8_TY5qISu1G0sJCO6iTm8pKscWUNHN3upasWS_Oqt6RzwWAOO2WkTSmeLMSicjUgKZfYqT38sTPLIcEnSMutNyxAQavAgcg-zPJSKuCb53-Kqeib1fDam9ndbGEsjDhbon2_z0-vaqsb1TcAVyX6YxOEH2BJiKVdYXeRYAwPFswYeFqrwqTwgt4O8GTxKw"
      }
   ]
}</pre><p><span class="strong"><strong>Script Functions</strong></span></p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">oidc_op.getJwks()</code> - Returns a JSON string containing the public key information. This method will internally call
   <code class="literal">oidc_op.createJwksAsMap()</code>, if it had not been called yet manually (see below), and then render the JSON based on
   the information in that map.
</li><li class="listitem">
<code class="literal">oidc_op.createJwksAsMap()</code> - <span class="emphasis"><em>optional</em></span> / creates the JWKS information as a Java <code class="literal">Map&lt;String, Object&gt;</code> instance, which
   can then be changed using Groovy scripting (check Groovy tutorials for how to work with maps). The same instance of
   this object is also stored in the session, and used by a call to the function <code class="literal">oidc_op.getJwks()</code>, so any changes
   done to the map will be reflected in the generated JSON string.
</li></ul></div><p>So, in order to customize the JSON shown in the JSP, follow these steps:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">
Call <code class="literal">oidc_op.createJwksAsMap()</code> to receive a <code class="literal">Map&lt;String, Object&gt;</code> instance
</li><li class="listitem">
Edit the map using Groovy code
</li><li class="listitem">
Call <code class="literal">oidc_op.getJwks()</code> to create the JSON string
</li></ol></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_environment_prerequisites_9"></a>58.3. Environment / prerequisites</h2></div></div></div><p>An OIDC Client/RP must be available that supports the required protocols etc.</p><p>The RP must provide <code class="literal">client_id</code>, <code class="literal">client_secret</code> and at least one <code class="literal">redirect_uri</code>.
It must be possible to configure the three SLS OP URLs for Authentication Request,
Token/Refresh Request and UserInfo Request, as well as the OP issuer URI,
at the RP.</p><p>Note that strong cryptography must be available in the JDK (at least AES256 and
HMAC-SHA256 must be available).</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_configuration_20"></a>58.4. Configuration</h2></div></div></div><p>The OP adapter is configured through a Java properties file, usually named "<code class="literal">oidc-op-adapter.properties</code>"
that must be installed in the "<code class="literal">WEB-INF</code>" directory of the SLS web application.</p><p>The standard SLS distribution is shipped with an example configuration file.</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_using_the_op_adapter"></a>58.4.1. Using the OP Adapter</h3></div></div></div><p>OIDC messages are automatically obtained from the HTTP request when needed
(no credential provider is needed):
<code class="literal">do.oidc.op.handlemsg</code> model action or <code class="literal">oidc_op</code> JEXL/Groovy functions
that get the OIDC message or check for its existence.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_jexl_groovy_functions_and_variables"></a>58.4.2. JEXL/Groovy Functions and Variables</h3></div></div></div><p>There are a number of OP-specific JEXL/Groovy functions that are used in models and JSPs.
See the SLS JEXL guide for a description of these functions (prefix <span class="strong"><strong><code class="literal">oidc_op</code></strong></span>).</p><p>There is also a set of functions with prefix <span class="strong"><strong><code class="literal">jwt</code></strong></span> that allows to parse and
inspect JSON Web Tokens (JWTs), as well as to validate their signatures, which is
useful in the SLS for validating ID tokens when the RP uses the ID token to
access the application (compared to addressing the SLS as OIDC OP). See also the
SLS JEXL guide for details.</p><p>In addition, the following JEXL variables are made available (see further below
for sample login models that use these variables and see the SLS JEXL guide under
the corresponding variable name for details about available methods on these variables):</p><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="_oidc_op_authorization_code"></a>oidc_op_authorization_code</h4></div></div></div><p>Attributes in the authorization code during Authorization Code Flow, created
during validation of Authentication Request and Token Request, i.e. during
the <code class="literal">oidc.op.handlemsg</code> action.</p><p>Note that - also in order to support setups with multiple load-balanced SLS
instances - any added attributes are transferred via the client browser as the
"code" parameter in the 302 Redirect URL (enciphered and signed), hence the number
of attributes that can be transferred has limits. As of 2017, the main limiting
factor is still MS Internet Explorer which cannot handle more than about
2000 bytes, all other browsers can handle 8000 bytes or more. Without any
additional attributes, the authorization code is about 120-150 bytes, i.e. there
is lots of room for additional attributes in practice. The additionally required
size per attribute is roughly
1.33 x (attribute key length in bytes + value length in bytes + 6).</p><pre class="screen">- String getUserid()
- String getClientId()
- Date getAuthenticationDate()
- Date getExpirationDate()
- String getNonce()
- void setAttribute(String name, Object value)
- Object getAttribute(String name)
- List&lt;String&gt; getAttributeAsStringList(String name)
- Object removeAttribute(String name)
- Set&lt;String&gt; getAttributeNames()</pre></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="_oidc_op_id_token"></a>oidc_op_id_token</h4></div></div></div><p>Claims of the <code class="literal">id_token</code>, created during creation of the responses for
Token Request, UserInfo Request and Refresh Request, i.e. during the
<code class="literal">oidc.op.createmsg</code> action.</p><pre class="screen">- void setClaim(String name, Object value)
- Object getClaim(String name)
- List&lt;String&gt; getClaimAsStringList(String name)
- Object removeClaim(String name)
- Set&lt;String&gt; getClaimNames()</pre></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="_oidc_op_refresh_token"></a>oidc_op_refresh_token</h4></div></div></div><p>Claims of the <code class="literal">refresh_token</code>, created during creation of the responses for
Token Request and Refresh Request, i.e. during the <code class="literal">oidc.op.createmsg</code> action.</p><pre class="screen">- void setClaim(String name, Object value)
- Object getClaim(String name)
- List&lt;String&gt; getClaimAsStringList(String name)
- Object removeClaim(String name)
- Set&lt;String&gt; getClaimNames()</pre></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="_oidc_op_userinfo"></a>oidc_op_userinfo</h4></div></div></div><p>Claims of the userinfo JSON body to be returned from a UserInfo Request, created
during creation of the response, i.e. during the <code class="literal">oidc.op.createmsg</code> action.</p><pre class="screen">- void setClaim(String name, Object value)
- Object getClaim(String name)
- List&lt;String&gt; getClaimAsStringList(String name)
- Object removeClaim(String name)
- Set&lt;String&gt; getClaimNames()</pre></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_op_adapter_configuration_properties"></a>58.4.3. OP Adapter Configuration Properties</h3></div></div></div><p>In order to use the OIDC adapter, some properties have to be defined in the
<code class="literal">oidc-op-adapter.properties</code> file.</p><p><span class="strong"><strong>oidc.op.issuer</strong></span></p><p>An URI that identifies the OP as the issuer of tokens sent to the RP.</p><pre class="programlisting">oidc.op.issuer=https://xyz.acme.com/oidc-op/sls</pre><p><span class="strong"><strong>oidc.op.keystore.file</strong></span></p><p>Path and filename of the keystore that contains private key and certificate of
the OP. Can be an absolute path or a path relative to the web application.
Example:</p><pre class="programlisting">oidc.op.keystore.file=WEB-INF/oidc-op/oidc-op.jks</pre><p><span class="strong"><strong>oidc.op.keystore.type</strong></span></p><p>The OP keystore type. Default is JKS (a Java keystore). Example:</p><pre class="programlisting">oidc.op.keystore.type=PKCS12</pre><p><span class="strong"><strong>oidc.op.keystore.pass</strong></span></p><p>The OP keystore passphrase. Example:</p><pre class="programlisting">oidc.op.keystore.pass=jsdi284ksau1m49284j234239c3dleuw</pre><p><span class="strong"><strong>oidc.op.keystore.keypair.alias</strong></span></p><p>The alias of the OP key pair (private key plus certificate) in the key store.
Example:</p><pre class="programlisting">oidc.op.keystore.keypair.alias=oidc-op</pre><p>The key must be an RSA key and minimal key size is 2048 bit (mandated by JWT
standards, more precisely by RFC 7518 "JSON Web Algorithms (JWA)").</p><p><span class="strong"><strong>oidc.op.authorization_code.validity.secs</strong></span></p><p>Validity period of the authorization code. Default is 60 sec (1 min),
maximally allowed valus is 3600 sec (1 hour).
Example:</p><pre class="programlisting">oidc.op.authorization_code.validity.secs=20</pre><p><span class="strong"><strong>Security Note:</strong></span> Note that normally this validity should be kept short, as the
mobile app usually follows the 302 to make the token request immediately.
Replays can only be prevented in the SLS in setups with a single SLS or in the
case of several load-balanced SLS instances if it can be guaranteed (e.g. via
source IP), that both authentication requests via mobile browser and token
request are sent to the same SLS instance, without a shared HTTP session.</p><p><span class="strong"><strong>oidc.op.id_token.validity.secs</strong></span></p><p>Validity period of the <code class="literal">id_token</code> (and the <code class="literal">access_token</code>). Default is 300 sec (5 min).
Example:</p><pre class="programlisting">oidc.op.id_token.validity.secs=120</pre><p><span class="strong"><strong>oidc.op.id_token.userid</strong></span></p><p>What to use as userid (subject, "sub" claim) in the <code class="literal">id_token</code> (and the <code class="literal">access_token</code>).</p><p>Example:</p><pre class="programlisting">oidc.op.id_token.userid=${session.getVerifiedCred('username')}</pre><p><span class="strong"><strong>oidc.op.refresh_token.validity.hours</strong></span></p><p>Validity period of the refresh_token. Default is 24 hours (one day).</p><p>Example:</p><pre class="programlisting">oidc.op.refresh_token.validity.hours=144</pre><p><span class="strong"><strong>oidc.op.refresh_token.validity.renew</strong></span></p><p>Whether to renew the <code class="literal">refresh_token</code> validity period at refresh request
processing or not. Default is false.</p><p>Example:</p><pre class="programlisting">oidc.op.refresh_token.validity.renew=true</pre><p><span class="strong"><strong>oidc.op.rp.&lt;no&gt;.</strong></span>*</p><p>Settings that define things that are specific per trusted RP.
See immediately below for the specific settings.</p><p><span class="strong"><strong>oidc.op.rp.&lt;no&gt;.client_id</strong></span></p><p>The <code class="literal">client_id</code> of the RP.
Mandatory and must be unique among all configured RPs.
(This is enforced by the SLS OP.)
Fixed string, no expressions are allowed.</p><p><span class="strong"><strong>oidc.op.rp.&lt;no&gt;.client_secret</strong></span></p><p>The <code class="literal">client_secret</code> of the RP.
Mandatory unless public client.
Fixed string, no expressions are allowed.</p><p><span class="strong"><strong>oidc.op.rp.&lt;no&gt;.redirect_uris</strong></span></p><p>Comma-separated list of allowed redirect_uri parameters for authentication.
Mandatory.
Fixed string, no expressions are allowed.</p><p><span class="strong"><strong>oidc.op.rp.&lt;no&gt;.pixy.require</strong></span>,
<span class="strong"><strong>oidc.op.rp.&lt;no&gt;.pixy.allowPlain</strong></span></p><p>These two settings control the handling of <span class="emphasis"><em>Proof Key for Code Exchange</em></span> (PKCE, "Pixy").
By default both are false, which means that then for that RP Pixy is handled if requested
by the RP in the Authentication Request and only the code challenge method <code class="literal">S256</code> is
supported.</p><p>If you set <code class="literal">pixy.require</code> to true, only requests with Pixy are handled for that RP,
while authentications without Pixy fail.
If you set <code class="literal">pixy.allowPlain</code>, the less secure code challenge method <code class="literal">plain</code> is also
allowed and performed for that RP.</p><p>Fixed strings, no expressions are allowed.</p><p><span class="strong"><strong>oidc.op.rp.&lt;no&gt;.publicClient</strong></span></p><p>Whether the RP is a Public Client or not.
If false, the RP must send <code class="literal">client_id</code> and <code class="literal">client_secret</code> in the token request
(either in a basic auth <code class="literal">Authorization</code> header or in POST parameters)
and match the configured ones;
if true, the RP must send the <code class="literal">client_id</code> as a POST parameter and it must match
the configured one (a <code class="literal">client_secret</code> is then not required and ignored if sent).
Optional, defaults to false.
Fixed string, no expressions are allowed.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_models_4"></a>58.4.4. Models</h3></div></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="_model_authorization_code_flow_part_1_authentication_request"></a>Model: Authorization Code Flow Part 1 (Authentication Request)</h4></div></div></div><p>Below is a sample model in which the user authenticates as part 1 of the
Authorization Code flow.</p><p>Note that a second adapter (e.g. LDAP) is assumed to be defined for authentication.
As also with all sample models below, it is  important that the failed state of
<code class="literal">do.oidc.op.handlemsg</code> is <code class="literal">do.oidc.op.sendmsg</code>, because then the SLS attempts to send
back an OIDC error response to the RP with a standardized error code and an
error_description.</p><p>Note also the first model state which does nothing and which is only needed if
the login is initiated with a HTTP request sent with POST binding, as then
the SLS skips the first state.</p><p>Because the second request of the Authorization Code flow will come into the SLS
as a completely new HTTP session, the SLS stores some information about the login
like the userid in a cache, accessed by the authorization code. This cache item
is also  made available as a JEXL/Groovy variable <code class="literal">oidc_op_cache</code>, in which an
arbitrary  number of custom attributes can be stored for later inclusion into
the <code class="literal">id_token</code> as claims.</p><pre class="programlisting">model.authenticate.uri=/auth
model.authenticate.failedState=get.cred
#
# generic "no operation" first state because skipped if first request is a POST
model.authenticate.state.1000.name=do.generic-nop-skipped-if-post
#
# handle oidc message (validate it)
model.authenticate.state.2000.name=do.oidc.op.handlemsg
model.authenticate.state.2000.failedState=do.oidc.op.sendmsg
#
# authenticate user (currently with ldap adapter)
model.authenticate.state.4000.name=get.cred
model.authenticate.state.5000.name=do.auth
#
# create oidc response (optional, would happen automatically at sendmsg)
model.authenticate.state.6000.name=do.oidc.op.createmsg
#
# add custom attributes to authorization code
model.authenticate.state.6500.name=do.generic-add-custom-attributes
model.authenticate.state.6500.action.1=${oidc_op_authorization_code.setAttribute('acme_claim', 'road-runner')}
#
# send oidc response
model.authenticate.state.7000.name=do.oidc.op.sendmsg
model.authenticate.state.7000.failedState=get.usererror
model.authenticate.state.8000.name=get.usererror</pre></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="_model_authorization_code_flow_part_2_token_request_and_refresh_request"></a>Model: Authorization Code Flow Part 2 (Token Request) and Refresh Request</h4></div></div></div><p>Both the second part of the Authorization Code Flow, the Token Request,
and the Refresh Request access the same location at the OP (this is mandated by
the OpenID Connect standard). Because both requests also return essentially the
same information, it thus often makes sense to handle these two requests
in the same login model.</p><p>In case of the Token Request, after request validation, a JEXL/Groovy variable called
<code class="literal">oidc_op_cache</code> is made available to get attributes from the cache. In the case
both requests, after creating the response, a JEXL/Groovy variable called
<code class="literal">oidc_op_id_token</code> is created which allows to add, modify or remove any claims
in the default <code class="literal">id_token</code>, and a JEXL variable <code class="literal">oidc_op_refresh_token</code> which serves
the same purpose for <code class="literal">refresh_token</code> claims.</p><pre class="programlisting">model.token.uri=/oidc-token
model.token.failedState=get.usererror
#
# Detect if incoming request is token request (and not refresh)
model.token.state.1500.name=do.generic-detect-if-token
model.token.state.1500.action.1=#{isTokenRequest = (oidc_op.getOidcRequestWrapper().getType() == 'token')}
#
# generic "no operation" first state because skipped if first request is a POST
model.token.state.1000.name=do.generic-nop-skipped-if-post
#
# handle oidc message (validate it)
model.token.state.2000.name=do.oidc.op.handlemsg
model.token.state.2000.failedState=do.oidc.op.sendmsg
#
# create oidc response (optional, would happen automatically at sendmsg)
model.token.state.3000.name=do.oidc.op.createmsg
model.token.state.3000.failedState=do.oidc.op.sendmsg
#
# add custom claims to id_token, but only if token request
# (are already in id_token if refresh request)
model.token.state.4000.name=do.generic-add-custom-claims
model.token.state.4000.action.1=${oidc_op_id_token.setClaim('acme_claim', oidc_op_authorization_code.getAttribute('acme_claim'))}
model.token.state.4000.action.1.if=${isTokenRequest}
#
# send oidc response
model.token.state.7000.name=do.oidc.op.sendmsg
model.token.state.7000.failedState=get.usererror
model.token.state.8000.name=get.usererror</pre></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="_model_userinfo_request_request"></a>Model: UserInfo Request Request</h4></div></div></div><p>The typical model for handling UserInfo Requests is again very similar.</p><p>This time, a JEXL/Groovy variable called <code class="literal">oidc_op_userinfo</code> is created when the
response is created, which allows to add, modify or remove any claims of the UserInfo.
By default, the UserInfo only contains the mandatory "sub" claim (the subject
resp. userid of the user as in the <code class="literal">id_token</code>.</p><p>For convenience also a JEXL/Groovy variable <code class="literal">oidc_op_id_token</code> is created for
access to claims from the <code class="literal">id_token</code>.</p><pre class="programlisting">model.userinfo.uri=/oidc-userinfo
model.userinfo.failedState=get.usererror
#
# generic "no operation" first state because skipped if first request is a POST
model.userinfo.state.1000.name=do.generic-nop-skipped-if-post
#
# handle oidc message (validate it)
model.userinfo.state.2000.name=do.oidc.op.handlemsg
model.userinfo.state.2000.failedState=do.oidc.op.sendmsg
#
# create oidc response (optional, would happen automatically at sendmsg)
model.userinfo.state.3000.name=do.oidc.op.createmsg
model.userinfo.state.3000.failedState=do.oidc.op.sendmsg
#
# add custom claims to userinfo
model.userinfo.state.4000.name=do.generic-add-custom-claims
model.userinfo.state.4000.action.1=${userid = session.getVerifiedCred('username')}
model.userinfo.state.4000.action.2=${oidc_op_userinfo.setClaim('preferred_username', userid)}
model.userinfo.state.4000.action.3=${oidc_op_userinfo.setClaim('email', userid + '@acme.not')}
#
# send oidc response
model.userinfo.state.7000.name=do.oidc.op.sendmsg
model.userinfo.state.7000.failedState=get.usererror
model.userinfo.state.8000.name=get.usererror</pre></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="_model_send_custom_error_messages"></a>Model: Send custom error messages</h4></div></div></div><p>It is possible to send a custom OIDC error message back to the RP in the login
model. Precondition is that this happens after a <code class="literal">oidc.op.handlemsg</code> action.</p><p>Example:</p><pre class="programlisting">model.userinfo.state.7000.name=do.oidc.op.sendmsg-custom-error
model.userinfo.state.7000.param.error=invalid_request
model.userinfo.state.7000.param.error_description=No xyz parameter in request</pre><p>The <code class="literal">error</code> parameter is mandatory and should normally be one of the standard
error codes for OIDC error responses. Note that these error codes differ for
the different request types and also how they are sent back to the client.
See the OIDC standard for details.</p><p>The <code class="literal">error_description</code> parameter is optional and is intended to provide
additional info, usually rather not for an end user using the RP App, but for
someone who develops or operates the RP.</p></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_op_as_a_hybrid_oidc_saml_broker"></a>58.5. OP as a Hybrid OIDC/SAML Broker</h2></div></div></div><p>Note that the OP could, for example act as a SAML 2.0 SP during the first part of the
Authorization Code Flow, i.e. redirect the client to a SAML IdP and after successful
user authentication remember the SAML Assertion (or some of its attributes) in the cache
for later use as claims in the <code class="literal">id_token</code> during the second part of the
Authorization Code Flow.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_revocation_of_refresh_tokens"></a>58.6. Revocation of refresh_tokens</h2></div></div></div><p>Typically the validity of an <code class="literal">id_token</code> is chosen to be relatively short, because
it is sent to applications, only protected by SSL/TLS, but the validity of a
<code class="literal">refresh_token</code> is often chosen to be quite long, since it is only sent to the OP,
but this long lifetime can still make it necessary to have a way to revoke a
<code class="literal">refresh_token</code> at the OP, for example if a mobile device containing the RP
App with <code class="literal">refresh_token</code> in its storage is stolen or lost.</p><p>The OpenID Connect standard(s) do not yet offer standardized
mechanisms and protocols for <code class="literal">refresh_token</code> revocation.</p><p>The SLS OP offers support for this use case. During handling of the Token
Request, the automatically generated <code class="literal">revocation_id</code> claim of the <code class="literal">refresh_token</code>
could be stored in some persistent storage, e.g. LDAP repository.
During handling of the Refresh Request, an additional check could be performed
for the presence of the <code class="literal">revocation_id</code> in the persistent storage and only
accept the <code class="literal">refresh_token</code> if its <code class="literal">revocation_id</code> is found there.
To revoke a token, you would simply remove the <code class="literal">revocation_id</code> from the
persistent storage, either directly or via a service URL at the SLS
(with suitable administrator authentication).</p><p>Note that there is no obligation to use the automatically generated
<code class="literal">revocation_id</code>, as it is not used in any hard-coded parts of the SLS OP.
The <code class="literal">revocation_id</code> can be replaced before the <code class="literal">refresh_token</code> is returned
or a completely different revocation mechanism might be implemented.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_sample_android_app"></a>58.7. Sample Android App</h2></div></div></div><p>A sample Android App, which is known to have been compatible with the SLS OP in
2016 and can be configured to perform an Authorization Code Flow login followed
by a UserInfo Request and also supports Refresh Requests can be found here:
<a class="ulink" href="https://github.com/learning-layers/android-openid-connect.git" target="_top">https://github.com/learning-layers/android-openid-connect.git</a></p><p>Endpoints and flow, as well as client_id, client_secret and redirect_uri
can be configured in the <code class="literal">com.lnikkila.oidcsample.Config</code> class. After
deploying the App to an Android device or emulator, click the yellow button
and the App will then try to perform a login with Authorization Code flow,
followed by a UserInfo request and then display the logged in user
(<code class="literal">preferred_username</code> claim in the user info). Clicking the button again,
will either get user info again or if the <code class="literal">access_token</code> has expired, try to
refresh the <code class="literal">id_token</code>/<code class="literal">access_token</code>.</p><p>Note that the App remembers the received tokens, so in order to start over,
uninstall the App and reinstall it.</p><p>If you use self-signed certificates on a test server for the SLS OP, you will
have to deactivate some SSL/TLS checks in the App, both for callouts via the
mobile browser and direct callouts using an API from Google. Search the
internet for how to do this or else ask USP for details.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_internal_format_of_tokens"></a>58.8. Internal Format of Tokens</h2></div></div></div><p><span class="strong"><strong>Important:</strong></span>
Except for the <code class="literal">id_token</code>, whose format is defined by the OpenID Connect
standard, the format of the other tokens described here (token <code class="literal">code</code>,
<code class="literal">access_token</code> and <code class="literal">refresh_token</code>) is left open by OpenID Connect and
OAuth 2.0; thus far it may change between SLS releases in ways that would
<span class="emphasis"><em>not be compatible</em></span> for any code <span class="emphasis"><em>outside</em></span> of the OP that makes use of
the internal format of those tokens.
The information provided for those tokens should thus currently
<span class="emphasis"><em>not</em></span> be used by code in related parties - if in doubt, contact USP.
The information here is only provided to make the implementation of the OP
in the SLS transparent, including its security related aspects.</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_format_of_id_token"></a>58.8.1. Format of id_token</h3></div></div></div><p>As defined in the OpenID Connect standard.
The <code class="literal">id_token</code> is signed with the private RSA key of the OP;
currently encrypting it is not supported.
The functions in the JEXL/Groovy variable <code class="literal">oidc_op_id_token</code> allow to add,
modify and remove claims before the <code class="literal">id_token</code> is signed.
Note that accordingly these claims will be visible to any recipients
of the <code class="literal">id_token</code>, which is in line with the standard, but one should
be aware not to expose more information in the <code class="literal">id_token</code> than needed
for the specific OpenID connect use cases.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_format_of_authorization_code"></a>58.8.2. Format of Authorization code</h3></div></div></div><p>The token <code class="literal">code</code> (authorization <code class="literal">code</code>) is implemented as a JSON structure,
which is then encrypted and signed based on the private RSA key of the OP.</p><p>It contains the following fields:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">uid</code>: User ID, get with <code class="literal">oidc_op_authorization_code.getUserId()</code>
</li><li class="listitem">
<code class="literal">cid</code>: Client ID; get with with <code class="literal">oidc_op_authorization_code.getClientId()</code>
</li><li class="listitem">
<code class="literal">aat</code>: Authentication date: get with <code class="literal">oidc_op_authorization_code.getAuthenticationDate()</code>
</li><li class="listitem">
<code class="literal">exp</code>: Expiration date: get with <code class="literal">oidc_op_authorization_code.getExpirationDate()</code>
</li><li class="listitem">
<code class="literal">nonce</code>: Optional nonce: get with <code class="literal">oidc_op_authorization_code.getNonce()</code>
</li><li class="listitem">
<code class="literal">attr</code>: any number of additional named attributes (add/remove/list with corresponding <code class="literal">oidc_op_authorization_code</code> functions)
</li></ul></div><p>Encryption and signing is done as follows:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
Serialize JSON (max compression), convert to bytes (UTF-8).
</li><li class="listitem">
Sign a fixed pattern with the OP private key (SHA256withRSA).
</li><li class="listitem">
Calculate a hash of this signature (SHA-384), this yields a AES256 key with IV.
</li><li class="listitem">
Encipher the serialized JSON bytes (AES/CBC/PKCS5Padding).
</li><li class="listitem">
Sign another fixed pattern with the OP private key (SHA256withRSA).
</li><li class="listitem">
Create a HmacSHA256 from the second signature.
</li><li class="listitem">
Calculate the HmacSHA256 of the above JSON ciphertext.
</li><li class="listitem">
Concat ciphertext and HMAC.
</li><li class="listitem">
Base64 encode these bytes, this is the code.
</li></ul></div><p>The reason that there is encrypted data in the <code class="literal">code</code> at all is use cases
where several load-balanced SLS instances are used;
they need this information, and, so far, different SLS instances cannot
be synchronized internally.
Note that this limitation of the current SLS makes is also harder to prevent
replay attacks where a <code class="literal">code</code> is resent to another load-balanced SLS instance.
If sent to the same SLS again, the <code class="literal">code</code> is rejected,
if sent to another SLS instance, it is accepted.
It is recommended to keep the validity period of the <code class="literal">code</code> short,
especially in load-balanced setups.
The functions in the JEXL/Groovy variable <code class="literal">oidc_op_authorization_code</code> allow to add,
modify and remove claims before the <code class="literal">code</code> is enciphered and signed.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_format_of_access_token"></a>58.8.3. Format of access_token</h3></div></div></div><p>Currently, the <code class="literal">access_token</code> is identical to the <code class="literal">id_token</code>, except that
it is always enciphered as follows:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
Derive an AES256 key with IV, as described for the authorization code above.
</li><li class="listitem">
Encipher the UTF-8 decoded <code class="literal">id_token</code> bytes with this key (AES/CBC/PKCS5Padding).
</li><li class="listitem">
Base64URL encode the resulting bytes.
</li></ul></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_format_of_refresh_token"></a>58.8.4. Format of refresh_token</h3></div></div></div><p>The <code class="literal">refresh_token</code> is a JWT, which is signed with the private RSA key
of the OP (just like the <code class="literal">id_token</code>).
By default, it contains the following claims:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">exp</code>: The expiry time of the <code class="literal">refresh_token</code>.
</li><li class="listitem">
<code class="literal">id_token_unsigned</code>: An unsigned copy of the <code class="literal">id_token</code>, enciphered in
  the same way as the <code class="literal">code</code>, see details above.
  Note that that the missing signature is no security issue, since the
  whole <code class="literal">refresh_token</code> is always signed.
</li></ul></div><p>The functions in the JEXL/Groovy variable <code class="literal">oidc_op_refresh_token</code> allow to add,
modify and remove claims before the <code class="literal">refresh_token</code> is signed.</p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="plain_oauth_mode"></a>58.9. Plain OAuth 2.0 Mode</h2></div></div></div><p>In some use-cases, basic OAuth 2.0 flows are required, not OpenID Connect. The
main differences between the two, in terms of functionality, are:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p class="simpara">
Some request parameters are optional in OAuth, while mandatory in OIDC:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p class="simpara">
<code class="literal">scope</code>
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: square; "><li class="listitem">
With OAuth 2.0, the "<code class="literal">scope</code>" parameter is entirely optional
</li><li class="listitem">
With OpenID Connect, the "<code class="literal">scope</code>" parameter must exist and contain the scope "<code class="literal">openid</code>".
It MAY also connect other scopes, which the SLS ignores; in OAuth mode, the parameter
is ignored by the SLS entirely.
</li></ul></div></li><li class="listitem"><p class="simpara">
<code class="literal">redirect_uri</code>
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: square; "><li class="listitem">
With OAuth 2.0, the "<code class="literal">redirect_uri</code>" parameter is completely optional. However,
IF it is in the request AND the state parameter <code class="literal">verifyRedirectUri</code> has been set
to <code class="literal">true</code>, the SLS will verify that its value equals one of the configured
redirect URIs in the corresponding relying party configuration (this applies
for both the authorization and the token request).
</li><li class="listitem">
With OpenID Connect, the <code class="literal">"redirect_uri"</code> parameter is mandatory for the
Authentication request, and the SLS will also verify that its value equals one
of the configured redirect URIs in the corresponding relying party configuration.
For the token request, the same check is only performed IF the state parameter
<code class="literal">verifyRedirectUri</code> has been set to <code class="literal">true</code>.
</li></ul></div></li></ul></div></li><li class="listitem">
When processing OAuth token requests, the SLS will create only an access and
a refresh token, but no id token.
</li></ul></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_models_5"></a>58.9.1. Models</h3></div></div></div><p>In order to support OAuth 2.0 instead of OIDC, the first request-processing
oidc-state in the model must set the state parameter "mode" to the value "oauth":</p><pre class="screen">model.userinfo.state.2000.name=do.oidc.op.handlemsg
model.userinfo.state.2000.param.mode=oauth
model.userinfo.state.2000.failedState=do.oidc.op.sendmsg</pre><p>In this case, the "oauth" mode will be used for all following requests and
responses in the same SLS session.</p></div></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="x10243_Heading1Tarsec_OIDC_RP_Adapter"></a>Chapter 59. OIDC RP Adapter</h2></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="OIDC_RP_Adapter_Introduction"></a>59.1. Introduction</h2></div></div></div><p>The OIDC RP Adapter implements an OpenID Connect (OIDC) 1.0 Relying Party (RP).</p><p>OpenID Connect 1.0 is an authentication protocol based on the OAuth 2.0 framework
for authorization protocols.</p><p>For an overview of the OpenID Connect flows, including how exchanged requests
and responses typcially look like, see the corresponding sections in
<a class="link" href="#x10007_Heading1Tarsec_OIDC_OP_Adapter" title="Chapter 58. OIDC OP Adapter">"OIDC OP Adapter"</a>.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_features_11"></a>59.2. Features</h2></div></div></div><p>Since the SLS as RP is typically used in different use cases than a mobile app
and the like, the RP Adapter supports less features than the OP Adapter.</p><p>The main supported feature is the <span class="strong"><strong>Authorization Code Flow</strong></span>, with Authentication
Request via web browser redirect, followed by Token Request via an internal
HTTP Callout directly to the OP, bypassing the client. If the flow passed without
errors, by default a verified username credential is created for the subject of
the received id_token.</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
Supports multiple clients (RPs) for multiple OPs.
</li><li class="listitem">
Requests and responses can be modified via scripting before sending resp. before validating.
</li><li class="listitem">
Authentication of the client in the Token Request with Basic Auth.
</li><li class="listitem">
A proxy host and port with optionally proxy authentication can be defined
  for the Token Request and getting the JWKS via URI.
</li><li class="listitem">
OP JWKS can be provided indirectly via a file or directly as a string expression,
  or dynamically from a URI (to support OPs that change it frequently).
</li><li class="listitem">
Authorization codes are cached for a configurable time in order to prevent
  replay attacks on the same SLS instance.
</li><li class="listitem">
Access to id_token claims, as well as to access_token and refresh_token
  strings (for propagation).
</li><li class="listitem">
Signed id_tokens (signed with <code class="literal">RS256</code>).
</li><li class="listitem">
<span class="emphasis"><em>Proof Key for Code Exchange</em></span> (PKCE, "Pixy") and Public Clients.
</li></ul></div><p>Not supported are:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
Refresh and Userinfo Requests.
</li><li class="listitem">
Plain OAuth 2.0.
</li><li class="listitem">
id_tokens that are encrypted, or signed with other algoritms than <code class="literal">RS256</code>.
</li></ul></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_environment_prerequisites_10"></a>59.3. Environment / prerequisites</h2></div></div></div><p>Each OIDC Client/RP to use must be registered at an OP with <code class="literal">client_id</code>, <code class="literal">client_secret</code>
and at least one <code class="literal">redirect_uri</code>.</p><p>Note that strong cryptography must be available in the JDK (at least AES256 and
HMAC-SHA256 must be available).</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_configuration_21"></a>59.4. Configuration</h2></div></div></div><p>The RP adapter is configured through a Java properties file, usually named "<code class="literal">oidc-rp-adapter.properties</code>"
that must be installed in the "<code class="literal">WEB-INF</code>" directory of the SLS web application.</p><p>The standard SLS distribution is shipped with an example configuration file.</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_using_the_rp_adapter"></a>59.4.1. Using the RP Adapter</h3></div></div></div><p>OIDC messages are automatically obtained from the HTTP request when needed
(no credential provider is needed):
<code class="literal">do.oidc.rp.handlemsg</code> model action or <code class="literal">oidc_rp</code> JEXL/Groovy functions
that get the OIDC message or check for its existence.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_jexl_groovy_functions_and_variables_2"></a>59.4.2. JEXL/Groovy Functions and Variables</h3></div></div></div><p>There are a number of RP-specific JEXL/Groovy functions that are used in models and JSPs.
See the SLS JEXL guide for a description of these functions (prefix <span class="strong"><strong><code class="literal">oidc_rp</code></strong></span>).</p><p>There is also a set of functions with prefix <span class="strong"><strong><code class="literal">jwt</code></strong></span> that allows to parse and
inspect JSON Web Tokens (JWTs), as well as to validate their signatures.
See also the SLS JEXL guide for details.</p><p>In addition, the following JEXL variables are made available (see further below
for sample login models that use these variables and see the SLS JEXL guide under
the corresponding variable name for details about available methods on these variables):</p><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="_oidc_rp_auth_request"></a>oidc_rp_auth_request</h4></div></div></div><p>Access to request parameters in the Authentication Request after creating
the request with the <code class="literal">oidc.rp.createmsg</code> model action. The request is
currently sent via 302 Redirect via the browser to the OP.</p><pre class="screen">- String getParameter(String name)
- void setParameter(String name, String value)
- String removeParameter(String name)
- Set&lt;String&gt; getParameterNames()</pre><p>The Authentication Response can be obtained with the call
<code class="literal">oidc_rp.getAuthResponseWrapper()</code> and its method are documented
in the JEXL Guide under <code class="literal">oidc_rp_auth_response</code>. It is possible
to query/modify received parameters before validating the response.</p><pre class="screen">- boolean hasResponse()
- String getParameter(String name)
- void setParameter(String name, String value)
- String removeParameter(String name)
- Set&lt;String&gt; getParameterNames()</pre></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="_oidc_rp_token_request"></a>oidc_rp_token_request</h4></div></div></div><p>Access to HTTP headers and POST parameters in the Token Request after creating
the request with the <code class="literal">oidc.rp.createmsg</code> model action.</p><pre class="screen">- String getHeader(String name)
- void setHeader(String name, String value)
- String removeHeader(String name)
- Set&lt;String&gt; getHeaderNames()
- String getParameter(String name)
- void setParameter(String name, String value)
- String removeParameter(String name)
- Set&lt;String&gt; getParameterNames()</pre><p>The Token Response can be obtained with the call
<code class="literal">oidc_rp.getTokenResponseWrapper()</code> and its method are documented
in the JEXL Guide under <code class="literal">oidc_rp_token_response</code>. It is possible
to query/modify JSOP values and the HTTP response status before
validating the response.</p><pre class="screen">- boolean hasResponse()
- int getStatus()
- void setStatus(int code)
- Object getJsonValue(String key)
- void setJsonValue(String key, Object value)
- Object removeJsonValue(String key)
- Set&lt;String&gt; getJsonKeys()</pre></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="_oidc_rp_id_token"></a>oidc_rp_id_token</h4></div></div></div><p>Access to the claims of the <code class="literal">id_token</code>; the variable is created
after successful validation of a Token Response.</p><pre class="screen">- JWT getJwt()
- Object getClaim()
- List&lt;String&gt; getClaimAsStringList()
- Set&lt;String&gt; getClaimNames()</pre><p>In addition, two more variables are created if the corresponding
items were part the Token Response, each containing the respective
token as a string, exactly as received: <code class="literal">oidc_rp_access_token</code> and
<code class="literal">oidc_rp_refresh_token</code>.</p></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_rp_adapter_configuration_properties"></a>59.4.3. RP Adapter Configuration Properties</h3></div></div></div><p>In order to use the OIDC adapter, some properties have to be defined in the
<code class="literal">oidc-rp-adapter.properties</code> file.</p><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="_general_properties"></a>General Properties</h4></div></div></div><p>The following properties are not specific to an OP or RP.</p><p><span class="strong"><strong>oidc.rp.code.cache.keepsecs</strong></span></p><p>How long to keep the authorization code in the cache in order to prevent
replay attacks with the same authorization code. Note that the cache is
per SLS instance, i.e. it cannot fully protect in setups with several
load-balanced SLS instances for the same RP. Default is 3600 seconds.</p><pre class="programlisting">oidc.rp.code.cache.keepsecs=120</pre><p><span class="strong"><strong>oidc.rp.http.proxy.host</strong></span>,
<span class="strong"><strong>oidc.rp.http.proxy.port</strong></span></p><p>Optional settings for host and port of a proxy to use for HTTP callouts
from the RP Adapter, specifically so far for the Token Request
and for getting the JWKS via URI.
If a proxy host is configured, configuring also the port is mandatory.</p><pre class="programlisting">oidc.rp.http.proxy.host=proxy.acme.org
oidc.rp.http.proxy.port=8443</pre><p><span class="strong"><strong>oidc.rp.http.proxy.auth.username</strong></span></p><p>Optional setting for the username for proxy authentication.</p><p><span class="strong"><strong>oidc.rp.http.proxy.auth.password</strong></span></p><p>Setting for the password for proxy authentication,
mandatory if the username is defined.</p><p><span class="strong"><strong>oidc.rp.http.proxy.auth.type</strong></span></p><p>The type of authentication to the proxy.
Allowed values are <code class="literal">basic</code>, <code class="literal">ntlm</code> and <code class="literal">spnego</code>, default is <code class="literal">basic</code>.</p><p><span class="strong"><strong>oidc.rp.http.proxy.auth.domain</strong></span></p><p>Optional domain or realm for proxy authentication.</p><p>Sample config settings for proxy with basic auth:</p><pre class="programlisting">oidc.rp.http.proxy.host=proxy.acme.org
oidc.rp.http.proxy.port=8443
oidc.rp.http.proxy.auth.username=sls
oidc.rp.http.proxy.auth.password=secret
oidc.rp.http.proxy.auth.type=basic
oidc.rp.http.proxy.auth.domain=acme</pre></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="_op_properties"></a>OP Properties</h4></div></div></div><p>The following properties define OPs.</p><p><span class="strong"><strong>oidc.rp.op.&lt;no&gt;.issuer</strong></span></p><p>Mandatory unique ID of the OP issuer (an URI).
Fixed string, no expressions are allowed.</p><pre class="programlisting">oidc.rp.op.10.issuer=https://op.acme.org/</pre><p><span class="strong"><strong>oidc.rp.op.&lt;no&gt;.authUri</strong></span></p><p>Mandatory URI for the authentication request.
Expressions are allowed (e.g. derive from issuer).</p><pre class="programlisting">oidc.rp.op.10.authUri=https://op.acme.org/auth</pre><p><span class="strong"><strong>oidc.rp.op.&lt;no&gt;.tokenUri</strong></span></p><p>Mandatory URI for the token request.
Expressions are allowed (e.g. derive from issuer).</p><pre class="programlisting">oidc.rp.op.10.tokenUri=https://op.acme.org/token</pre><p><span class="strong"><strong>oidc.rp.op.&lt;no&gt;.jwksSourceType</strong></span>,
<span class="strong"><strong>oidc.rp.op.&lt;no&gt;.jwksSource</strong></span></p><p>Mandatory source type and source for JWKS. Supported source types are:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">file</code>: Source is the path to a JWKS file in the file system, absolute or relative to the webapp.
</li><li class="listitem">
<code class="literal">string</code>: Source is the JWKS string.
</li><li class="listitem">
<code class="literal">uri</code>: Source is the URI where to get the JWKS with an HTTP GET callout.
</li></ul></div><p>Expressions are allowed for the source, but not for the source type.</p><p>In case of source type <code class="literal">uri</code>, the result of the callout is cached and only requeried
with a callout again if a received id_token contains a key ID that is  not part of
the JWKS or the last callout was more than an hour ago, whichever comes first.</p><p>Example for source type <code class="literal">file</code>:</p><pre class="programlisting">oidc.rp.op.10.jwksSourceType=file
oidc.rp.op.10.jwksSource=WEB-INF/oidc-rp/acme-op-jwks.json</pre><p>Example for source type <code class="literal">string</code>:</p><pre class="programlisting">oidc.rp.op.&lt;no&gt;.jwksSourceType=string
oidc.rp.op.&lt;no&gt;.jwksSource=#{myUtil.getJwks('acme-op')}</pre><p>Example for source type <code class="literal">uri</code>:</p><pre class="programlisting">oidc.rp.op.&lt;no&gt;.jwksSourceType=uri
oidc.rp.op.&lt;no&gt;.jwksSource=https://op.acme.org/jwks</pre></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="_client_rp_properties"></a>Client (RP) Properties</h4></div></div></div><p>The following properties define clients (RPs) and which OP they are registered at,
hence also pairing a client (RP) with an OP as defined with settings above.</p><p><span class="strong"><strong>oidc.rp.client.&lt;no&gt;.alias</strong></span></p><p>Mandatory alias that is unique per client (globally, not per OP).
Must be of the form <code class="literal">&lt;client-specific&gt;@&lt;op-specific&gt;</code>;
often might use the client_id for the first part
and maybe the domain of the OP for the second part.
Fixed string, no expressions are allowed.</p><p>Example:</p><pre class="programlisting">oidc.rp.client.200.alias=client1@acme-op</pre><p><span class="strong"><strong>oidc.rp.client.&lt;no&gt;.description</strong></span></p><p>Optional string to display to users to identify the client/OP pairing,
usually shown in a dedicated JSP where the user can select the desired OP.
If not present, defaults to the alias.
Fixed string, no expressions are allowed.</p><pre class="programlisting">oidc.rp.client.200.description=First Client for ACME</pre><p><span class="strong"><strong>oidc.rp.client.&lt;no&gt;.isForCurrentVhost</strong></span></p><p>Optional expression that yields true if the RP is for the current vhost.
Typically used to include/exclude client/OP pairings to offer to the user for login.
Default is true.
Expressions are allowed.</p><pre class="programlisting">oidc.rp.client.200.isForCurrentVhost=#{var('header.host')=='acme.org'}</pre><p><span class="strong"><strong>oidc.rp.client.&lt;no&gt;.op</strong></span></p><p>Mandatory unique issuer identifier (URI) as in the OP configuration above.
Fixed string, no expressionsa are allowed.</p><pre class="programlisting">oidc.rp.client.200.op=https://op.acme.org/</pre><p><span class="strong"><strong>oidc.rp.client.&lt;no&gt;.client_id</strong></span>,
<span class="strong"><strong>oidc.rp.client.&lt;no&gt;.client_secret</strong></span>,
<span class="strong"><strong>oidc.rp.client.&lt;no&gt;.redirect_uri</strong></span>,
<span class="strong"><strong>oidc.rp.client.&lt;no&gt;.pixy.use</strong></span>,
<span class="strong"><strong>oidc.rp.client.&lt;no&gt;.publicClient</strong></span></p><p>Mandatory settings that define the client.</p><p>The <code class="literal">client_id</code> and <code class="literal">client_secret</code> must be fixed strings, no expressions allowed,
and must be registered at the corresponding OP.</p><p>The <code class="literal">redirect_uri</code> can be an expression and it must evaluate to one of the
URIs registered at the corresponding OP.</p><p>The <code class="literal">pixy.use</code> setting is optional (defaults to false) and should be compatible with
the configuration/behavior of the OP.
If true, performs <span class="emphasis"><em>Proof Key for Code Exchange</em></span> (PKCE, "Pixy"), with code challenge
method <code class="literal">S256</code> and a code challenge of 256 secure random bits (base64-encoded 43 characters).
(Note that the less secure code challenge method <code class="literal">plain</code> is not supported because the PKCE
standard forbids clients that can support <code class="literal">S256</code> to also support <code class="literal">plain</code>.)</p><p>The <code class="literal">publicClient</code> setting is optional (defaults to false) and should be compatible
with the configuration/behavior of the OP.
If false, <code class="literal">client_id</code> and <code class="literal">client_secret</code> are sent in a basic auth <code class="literal">Authorization</code>
header in the token request;
if true, only the <code class="literal">client_secret</code> is sent and instead as a POST parameter.
Fixed string, no expressions allowed.</p><pre class="programlisting">oidc.rp.client.200.client_id=client1
oidc.rp.client.200.client_secret=ghd0387
oidc.rp.client.200.redirect_uri=https://client1.xyz.org/redirect</pre><p><span class="strong"><strong>oidc.rp.client.&lt;no&gt;.scopes</strong></span></p><p>Optional comma separated list of scopes to send in addition to <code class="literal">openid</code>.
Expressions are allowed.</p><pre class="programlisting">oidc.rp.client.200.scopes=email,acme</pre></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_models_6"></a>59.4.4. Models</h3></div></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="_model_authorization_code_flow_authentication_and_token_request"></a>Model: Authorization Code Flow (Authentication and Token Request)</h4></div></div></div><p>Below is a sample model in which a user can authenticate with the
Authorization Code flow.</p><p>If the initial request has no parameter <code class="literal">clientopalias</code>,
a JSP is shown for selection of the corresponding client/OP pairing,
and then posted with that parameter.</p><p>After that, it is two times a sequence of <code class="literal">do.oidc.rp.createmsg</code>,
<code class="literal">do.oidc.rp.sendmsg</code> and <code class="literal">do.oidc.rp.handlemsg</code>, first for the
Authentication Request, then for the Token Request.
In between in the sample model some parts of the requests/responses
are logged, but they could also be modified there, if needed.</p><pre class="programlisting">model.login.uri=/auth
model.login.failedState=get.usererror
#
# generic "no operation" first state because skipped if first request is a POST
model.login.state.1000.name=do.generic-nop

# skip client/OP selection JSP if alias already indicated
model.login.state.1500.name=do.generic-clientop-indicated
model.login.state.1500.nextState.1=do.oidc.rp.createmsg-auth
model.login.state.1500.nextState.1.if=#{var('parameter.clientopalias') != null}

# show client/OP selection JSP
model.login.state.1600.name=show.jsp-select-clientop
model.login.state.1600.param.jsp=jsp.rp.clientopselection

# create auth request
model.login.state.2000.name=do.oidc.rp.createmsg-auth
model.login.state.2000.param.mode=oidc
model.login.state.2000.param.alias=#{var('parameter.clientopalias')}
model.login.state.2000.param.request=authentication

# audit log some stuff from auth request
model.login.state.2500.name=do.generic-auth-request
model.login.state.2500.action.1=#{function.logAudit('auth request parameter names: ' + oidc_rp_auth_request.parameterNames)}

# send auth request
model.login.state.3000.name=do.oidc.rp.sendmsg-auth

# audit log some stuff from auth response
model.login.state.3500.name=do.generic-auth-response
model.login.state.3500.action.1=#{function.logAudit('auth response parameter names: ' + oidc_rp.getAuthResponseWrapper().parameterNames)}

# validate auth response
model.login.state.4000.name=do.oidc.rp.handlemsg-auth

# create token request
model.login.state.5000.name=do.oidc.rp.createmsg-token
model.login.state.5000.param.request=token

# audit log some stuff from token request
model.login.state.5500.name=do.generic-token-request
model.login.state.5500.action.1=#{function.logAudit('token request header names: ' + oidc_rp_token_request.headerNames)}
model.login.state.5500.action.2=#{function.logAudit('token request parameter names: ' + oidc_rp_token_request.parameterNames)}

# send token request
model.login.state.6000.name=do.oidc.rp.sendmsg-token

# audit log some stuff from auth response
model.login.state.6500.name=do.generic-token-response
model.login.state.6500.action.1=#{function.logAudit('token response status: ' + oidc_rp.getTokenResponseWrapper().status)}
model.login.state.6500.action.2=#{function.logAudit('token response parameter names: ' + oidc_rp.getTokenResponseWrapper().jsonKeys)}

# validate token response
model.login.state.7000.name=do.oidc.rp.handlemsg-token

model.login.state.8000.name=do.success

model.login.state.9000.name=get.usererror</pre></div></div></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="x10008_Heading1Tarsec_WebAuthn_Adapter"></a>Chapter 60. WebAuthn Adapter</h2></div></div></div><p>The WebAuthn adapter implements support for using authentication tokens according
to the FIDO2 project, using the "WebAuthn" API (short for "Web Authentication").</p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_features_12"></a>60.1. Features</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
Registration Flow
</li><li class="listitem"><p class="simpara">
Authentication Flow
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem">
Multi-factor authentication (FIDO token as additional factor)
</li><li class="listitem">
Single-factor authentication (aka password-less login)
</li></ul></div></li><li class="listitem"><p class="simpara">
Various credential persistence options
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem">
LDAP
</li><li class="listitem">
SES Identity (IDM / Syncope database)
</li><li class="listitem">
In-Memory (for testing / initial integration, lost at SLS restart)
</li></ul></div></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_limitations"></a>60.2. Limitations</h2></div></div></div><p>The following limitations currently exist for the SLS WebAuthn adapter:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
No attestation support: Attestations are currently not required, and are not validated.
</li><li class="listitem">
No metadata support: There is currently no built-in mechanism to look up the metadata
for the authenticator token based on its AAGUID.
</li><li class="listitem">
No token binding support (RFC 8471).
</li></ul></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="WebAuthn_Adapter_Introduction"></a>60.3. Introduction</h2></div></div></div><p>The WebAuthn API is supported by all recent major web browsers; it allows to perform a
challenge-/response flow between a web application and a client, with a hardware
token, either to be used as a second factor (in addition to username and password),
or for password-less login.</p><p>There are many different implementations of such tokens; they can be connected over
USB or NFC, or built right into the client platform, such as fingerprint readers in
smartphones. The probably most common use-cases are:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
Using a USB-connected token (examples are many Yubico tokens etc.) as a second
factor for authentication at a desktop/laptop computer browser.
</li><li class="listitem">
Using a smartphones' own biometric authentication token (like a fingerprint reader)
for password-less authentication at a mobile browser.
</li><li class="listitem">
Using the TPM (Trusted Platform Module) in a Windows PC/Laptop in combination
with a PIN or biometrics (camera, fingerprint, etc.).
</li></ul></div><p>There are also different levels of security supported by the tokens. For example,
some USB tokens may come with a built-in fingerprint reader, so that only the
rightful owner can activate the token during the authentication procedure. Therefore,
such tokens authenticate the enduser themselves, before allowing them to use the token.
Others just have a simple button that needs to be pressed, which means anyone who
gets a hold of the token can use it. It depends on the context and the security
needs of the customer and the application how to best deal with these different
situations.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_how_it_works_3"></a>60.4. How it works</h2></div></div></div><p>The basic idea is that per "website" a private/public key pair is generated on
some sort of "secure authentication device" and the public key is registered on
the server. By proving possession of the private key the client can be strongly
authenticated after registration.</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>Origin / RP ID:</strong></span> The "website" is identified by the so-called "Relying Party
Identifier", short RP ID, which must be the same as the domain ("origin") of the
server or a superdomain of it. For example, if the server is at <code class="literal">coyote.acme.org</code>,
valid RP IDs are <code class="literal">coyote.acme.org</code> (default) and <code class="literal">acme.org</code>, but neither
<code class="literal">roadrunner.acme.org</code> nor just <code class="literal">org</code>.
</li><li class="listitem">
<span class="strong"><strong>Authenticator:</strong></span> The "secure authentication device" (normative name <span class="emphasis"><em>Authenticator</em></span>
or <span class="emphasis"><em>WebAuthn Authenticator</em></span>) can be on the same device as the web browser
(e.g. Trusted Platform Module on a PC/laptop, fingerprint sensor on a mobile
device) or plugged into the device (e.g. USB dongle) or connected wirelessly
(e.g. PC/laptop to cell phone via Bluetooth, etc.).
</li><li class="listitem"><p class="simpara">
<span class="strong"><strong>Flows</strong></span>: There are only two flows:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem">
<span class="strong"><strong>Registration Flow</strong></span>: A private/public key pair is generated, the key pair is stored on the authentication device, the public key on the server.
</li><li class="listitem">
<span class="strong"><strong>Authentication Flow</strong></span>: The client proves its identity with its private key in response to a challenge from the server.
</li></ul></div></li><li class="listitem">
<span class="strong"><strong>Web Authentication API:</strong></span> On the client side all clients (typically web browsers)
must support the corresponding Javascript API, the Web Authentication API (aka "WebAuthn" API).
</li><li class="listitem">
<span class="strong"><strong>Attestation:</strong></span> Statements about the authenticator and the data it provides
(like the public key of a user at registration), signed with a private key related
to the authenticator. Attestation can be demanded by the server at registration
and can then be sent to the server.
</li></ul></div><p>The WebAuthn standard can be found here: <a class="ulink" href="https://www.w3.org/TR/webauthn/" target="_top">https://www.w3.org/TR/webauthn/</a></p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_flows"></a>60.5. Flows</h2></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_registration_flow"></a>60.5.1. Registration Flow</h3></div></div></div><div class="informalfigure"><div class="mediaobject"><img src="webauthn_registration2.png" alt="webauthn_registration2.png" /></div></div><p>The RP Server (SLS) prepares data for a so-called <span class="emphasis"><em>publicKey</em></span> Javascript structure
which is then passed to the browser/client Javascript function <code class="literal">navigator.credentials.create(publicKey)</code>
as the sole argument.</p><p>Here is an example publicKey with related SLS config properties as comments,
which are explained  in detail in the configuration section further below:</p><pre class="screen">{
  "attestation": "none",
  "challenge": base64UrlDecode("M8...ig"), /* generated by SLS */
  "authenticatorSelection": {
    "authenticatorAttachment": "cross-platform", /* webauthn.reg.authenticatorSelection.authenticatorAttachment */
    "userVerification": "preferred",             /* webauthn.reg.authenticatorSelection.userVerification */
    "requireResidentKey": false,                 /* webauthn.reg.authenticatorSelection.requireResidentKey */
    "residentKey": "preferred"                   /* webauthn.reg.authenticatorSelection.residentKey */
  },
  "user": {
    "displayName": "myuser-display-name", /* webauthn.user.displayName */
    "name": "myuser",                     /* SLS username credential */
    "id": base64UrlDecode("PkN...R8Q")    /* opaque user handle, generated by SLS */
  },
  "rp": {
    "name": "ACME RP",         /* webauthn.rp.friendlyName */
    "id": "webauthn.acme.org"  /* webauthn.rp.id */
  },
  "timeout": 60000,       /* webauthn.reg.timeout */
  "excludeCredentials": [ /* &lt;=&gt; webauthn.reg.excludeCredentials.populate */

  ],
  "pubKeyCredParams": [ /* webauthn.reg.pubKeyCredParams.&lt;n&gt;.alg */
    {
      "type": "public-key",
      "alg": -7
    },
    {
      "type": "public-key",
      "alg": -257
    }
  ]
}</pre><p>The client has a secure way of communicating with authenticators, typically via
CTAP, which is part of the FIDO specifications. If the user gives their consent
to register and also otherwise everything is as desired, the authenticator generates
a private/public key pair and the call returns without errors. Then Javascript
by the SLS assembles a JSON data structure which is posted to the SLS (base64url-encoded),
typically as parameter called "webauthnMessage", but the name and source is configurable
as an SLS credential.</p><p>Here is a sample of the posted JSON:</p><pre class="screen">{
  "id": "cgy...SpA",
  "type": "public-key",
  "response": {
    "attestationObject": "o2N...U4E",
    "clientDataJSON": "eyJ...In0",
  }
}</pre><p>The "id" field is the credential ID, a unique identifier for the public key.
There are essentially two cases:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
The authenticator is capable of storing individual private keys and did do so
  at registration, then the credential ID is usually a random string that the
  authenticator also stored.
</li><li class="listitem">
The authenticator is not capable of storing individual private keys or did not
  do so at registration, then the credential ID contains the private key
  encrypted with a single secret of the authenticator.
</li></ul></div><p>This difference will be important later regarding possible ways to authenticate.</p><p>Below the "response" field there are two fields. The field "clientDataJSON" is
rather  high-level information. It is a base64url-encoded JSON structure, example:</p><pre class="screen">{
  "challenge": "M8...ig",
  "clientExtensions": {

  },
  "hashAlgorithm": "SHA-256",
  "origin": "https://webauthn.acme.org",
  "type": "webauthn.create"
}</pre><p>The "challenge" field must match the one in the publicKey Javascript and the
"type" must be "webauthn.create". The origin must be compatible with the RP ID.</p><p>The other field below "response", namely "attestationObject", has a more complex,
more low-level structure, a mix of CBOR (sort of a binary JSON) and fixed data
structures. Some parts of it are always present, others even depend on the type
of authenticator.</p><p>Sample "attestationObject" base64url- and then CBOR-decoded to a pseudo JSON
representation:</p><pre class="screen">{
  "fmt": "packed",
  "attStmt": {
    "alg": -7,
    "sig": "3046...B246",
    "x5c": "3082...4051"
  },
  "authData": "6706...5381"
}</pre><p>The field "sig" is a signature by the authenticator that could be used for what
is called "attestation" (which is currently not supported by the SLS), and "x5c"
contains a certificate as trust anchor for the signature (in some cases even a
self signed certificate of the generated key pair).</p><p>Drilling down further into "authData", again shown as pseudo JSON:</p><pre class="screen">"authData": {
  "credentialData": {
  "aaguid": "-iuZ3J45QlePkkow0jxBGA==",
  "credentialId": "X9FrwMfmzj...",
  "publicKey": {
     ...
  },
  "flags": {
    "AT": true,
    "ED": false,
    "UP": true,
    "UV": false
  },
    "rpIdHash": "xG...7c=",
    "signatureCounter": 7
  }</pre><p>The "aaguid" field is the so-called AAGUID, a globally unique identifier for the
type of authenticator. The "rpIdHash" is a hash over the RP ID (c.f.
"hashAlgorithm" further above), the "credentialId"  is what it says, but this
time in principle part of signed data. The flags give additional  information
about conditions at registration (and they are also available via script functions
in the SLS):</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
UP: User was present (usually mandatory to be the case, e.g. user pressed a button on the token)
</li><li class="listitem">
UV: User identity was verified by the authenticator itself (PIN, fingerprint, etc.)
</li><li class="listitem">
AT: Attested credential data is included
</li><li class="listitem">
ED: Extension data is included
</li></ul></div><p>The SLS makes mandatory validations and, if OK, stores the credential.
More precisely the following data is stored:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>rpId</strong></span>: The RP ID
</li><li class="listitem">
<span class="strong"><strong>userHandle</strong></span>: The opaque user handle (user.id field in the publicKey Javascript)
</li><li class="listitem">
<span class="strong"><strong>slsUsername</strong></span>: The SLS username (username credential)
</li><li class="listitem">
<span class="strong"><strong>credentialId</strong></span>: The credential ID generated by the authenticator
</li><li class="listitem">
<span class="strong"><strong>credentialFriendlyName</strong></span>: A friendly name for the credential optionally chosen
  by the user at registration and posted along, e.g. "My Yubico USB Token"
  (note that this friendly name is not known to the authenticator nor the browser,
  it only serves to help the user to eventually list and delete credentials
  stored on the RP (SLS))
</li><li class="listitem">
<span class="strong"><strong>authenticator</strong></span>: Low-level info required to authenticate the user
  (this includes also the counter value which is later needed at authentication)
</li></ul></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_authentication_flow"></a>60.5.2. Authentication Flow</h3></div></div></div><div class="informalfigure"><div class="mediaobject"><img src="webauthn_authentication2.png" alt="webauthn_authentication2.png" /></div></div><p>Authentication is very similar to registration. The SLS again prepares the
publicKey Javascript structure, here again an example with related SLS config
properties as comments, which are again explained in detail in the configuration
section further below:</p><pre class="screen">{
  "userVerification": "preferred",           /* webauthn.auth.userVerification */
  "challenge": base64UrlDecode("05g...WNQ"), /* generated by SLS */
  "rpId": "webauthn.acme.org",           /* webauthn.rp.id */
  "timeout": 60000,                          /* webauthn.auth.timeout */
  "allowCredentials": [ /* &lt;=&gt; webauthn.auth.allowCredentials.populate */

  ]
}</pre><p>There is again a challenge and the RP ID is indicated. An important security
feature is that the client only allows RP IDs that are compatible with the origin
of the website that provided the publicKey Javascript structure, this helps to
eliminate certain man-in-the-middle attacks.</p><p>The publicKey Javascript is passed to <code class="literal">navigator.credentials.get(publicKey)</code>,
which then offers suitable authenticators.</p><p>There are basically two cases.</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
If the "allowCredentials" field is empty, any available authenticator can be
  used and the RP (SLS) later maps the posted credential ID to the user.
  This is the tpyical case of "password-less login".
  Note that this is only possible with authenticator tokens that are capable
  of storing the private key / credential ID of the credential.
</li><li class="listitem">
If the "allowCredentials" field contains a list of credential IDs, only a
  matching authenticator is allowed. In order to create the list, the RP (SLS)
  must know the user before creating the publicKey Javascript, typically via
  username/password login. In principle also the user could just be asked to
  just provide the username, but that is a <span class="strong"><strong>secrity risk</strong></span>, it would allow an
  attacker to find out which users have credentials and their IDs.
</li></ul></div><p>In other words, password-less login is effectively only possible with tokens
that are capable of storing the private key. To complicate things further
(at least as of summer 2021), administration of credentials on authenticator
tokens is often only possible via command line with admininistrator privileges,
which  makes password-less login even more difficult to handle for customers,
at least with  many tokens that only have space for a small number of credentials.
But, of course, things are expected to evolve there.</p><p>If everything is OK with the authenticator and the user gives their consent,
the call returns without errors and SLS Javascript again assembles a JSON
struture that it posts the same way as at registration. Example:</p><pre class="screen">{
  "id": "cg...pA",
  "type": "public-key",
  "response": {
    "authenticatorData": "Zw...CQ",
    "clientDataJSON": "eyJ...In0",
    "signature": "MEQ...nVw",
    "userHandle": "XX...10"
  }
}</pre><p>The most important field is "signature". With that the authenticator proves
possession of the private key. The "id" is again the credential ID, the
"userHandle"  is, of course, the opaque user handle. The challenge must again
match the one in the publicKey Javascript.</p><p>The "clientDataJSON"  is just like at registration, except that the "type"
must be "webautn.get":</p><pre class="screen">{
  "challenge": "05g...WNQ",
  "clientExtensions": {},
  "hashAlgorithm": "SHA-256",
  "origin": "https://webauthn.acme.org",
  "type": "webauthn.get"
}</pre><p>Sample "authenticatorData" as pseudo JSON:</p><pre class="screen">{
  "rpIdHash": "ZwaNeIU1_JVLqKvBGPD5Px4pMeZeB4TjK1SRkVjLskU",
  "flags": {
    "UP": true,
    "UV": false,
    "AT": false,
    "ED": false
   },
  "counter": 9
}</pre><p>Same flags, but this time indicating what happened at authentication.
The counter is verified to have increased since registration or the last
previous authentication. (Note that the standard only mandates that the
counter is increased by a positive amount, not necessarily by 1. One
reason for that is that some authenticators only have a single counter
for all keys, and at least with Yubico USB tokens the increase is often
more than 1 even if only registering and then using a single key, maybe
because some keys are also used to communicate between token and host
device, or maybe for other internal reasons, in any case such behavior
is allowed by the standard.)</p><p>In most use cases necessary parameters can be set via configuration properties,
as shown in the comments around the publicKey Javascript structure above, but
with the SLS it is also possible to make custom changes both to the publicKey
Javascript before sending it to the client and to the receveived JSON before
processing it regularly in the SLS as WebAuthn RP. Details further below.</p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_configuration_22"></a>60.6. Configuration</h2></div></div></div><p>The WebAuthn adapter is configured through a Java properties file, usually
named "<code class="literal">webauthn-adapter.properties</code>"  that must be installed in the "<code class="literal">WEB-INF</code>"
directory of the SLS web application
(or in additionally configured configuration directories).</p><p>The standard SLS distribution is shipped with an example configuration file.</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_using_the_webauthn_adapter"></a>60.6.1. Using the WebAuthn Adapter</h3></div></div></div><p>A WebAuthn credential provider must be configured:</p><pre class="programlisting">cred.provider.webauthn=webauthn
cred.provider.webauthn.cred.1.type=webauthn
cred.provider.webauthn.cred.1.source=parameter
cred.provider.webauthn.cred.1.name=webauthnMessage</pre><p>The source can be <code class="literal">parameter</code> or <code class="literal">header</code>, while <code class="literal">parameter</code> has precedence
over <code class="literal">header</code> if both are present in the received HTTP request.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_webauthn_adapter_configuration_properties"></a>60.6.2. WebAuthn Adapter Configuration Properties</h3></div></div></div><p>In order to use the WebAuthn adapter, some properties have to be defined in the
<code class="literal">webauthn-adapter.properties</code> file.</p><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="_order_of_adapters"></a>Order of Adapters</h4></div></div></div><p>Using the LDAP backend requires to load the LDAP adapter before the WebAuthn adapter,
so this should be forced with the configuration property <code class="literal">adapter.types</code>, for example:</p><pre class="programlisting">adapter.types=ldap,http,webauthn,ws</pre></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="_general_settings"></a>General Settings</h4></div></div></div><p><span class="strong"><strong>webauthn.rp.id</strong></span></p><p>A hostname that defines the Relying Party ID of the SLS instance.
Allowed values are e.g. <code class="literal">webauthn.acme.com</code> or <code class="literal">acme.com</code>, but not <code class="literal">com</code>.</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<a class="ulink" href="https://www.w3.org/TR/webauthn/#rp-id" target="_top">https://www.w3.org/TR/webauthn/#rp-id</a>
</li></ul></div><pre class="programlisting">webauthn.rp.id=webauthn.acme.com</pre></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="_registration_settings"></a>Registration Settings</h4></div></div></div><p>Settings that apply to the registration flow, i.e. to assembling the publicKey
Javascript structure for registration.</p><p><span class="strong"><strong>webauthn.rp.friendlyName</strong></span></p><p>A human-readable name for the SLS relying party instance, used only to be
displayed to users, never stored.</p><pre class="programlisting">webauthn.rp.friendlyName=ACME WebAuthn SLS</pre><p><span class="strong"><strong>webauthn.user.displayName</strong></span></p><p>Display name of the user, typically a script expression.</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<a class="ulink" href="https://www.w3.org/TR/webauthn/#dom-publickeycredentialuserentity-displayname" target="_top">https://www.w3.org/TR/webauthn/#dom-publickeycredentialuserentity-displayname</a>
</li></ul></div><pre class="programlisting">webauthn.user.displayName=#{session.getCred('username')}-display-name</pre><p><span class="strong"><strong>webauthn.reg.pubKeyCredParams.&lt;n&gt;.alg</strong></span></p><p>Accepted types/algorithms for public keys. The type is always "public-key" (the
only available option to-date); the algorithm can be chosen by COSE algorithm number.</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<a class="ulink" href="https://www.w3.org/TR/webauthn/#dom-publickeycredentialcreationoptions-pubkeycredparams" target="_top">https://www.w3.org/TR/webauthn/#dom-publickeycredentialcreationoptions-pubkeycredparams</a>
</li></ul></div><pre class="programlisting"># ES256 = -7
webauthn.reg.pubKeyCredParams.1.alg=-7
# RS256 = -257
webauthn.reg.pubKeyCredParams.2.alg=-257</pre><p><span class="strong"><strong>webauthn.reg.timeout</strong></span></p><p>The timeout for registration in ms, default 60000 (one minute). This is the
time between when the user clicks the button in the webpage to trigger the
communication with the authenticator token, and the time the manual interaction
with the token (such as pressing a button) is completed.
Note, however, that the client is free to ignore this setting,
and apparently this is often the case.</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<a class="ulink" href="https://www.w3.org/TR/webauthn/#dom-publickeycredentialcreationoptions-timeout" target="_top">https://www.w3.org/TR/webauthn/#dom-publickeycredentialcreationoptions-timeout</a>
</li></ul></div><pre class="programlisting">webauthn.reg.timeout=60000</pre><p><span class="strong"><strong>webauthn.reg.excludeCredentials.populate</strong></span></p><p>Whether to populate the "excludeCredentials" field with all existing credentials
for the user; the default is <code class="literal">true</code>.</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<a class="ulink" href="https://www.w3.org/TR/webauthn/#dom-publickeycredentialcreationoptions-excludecredentials" target="_top">https://www.w3.org/TR/webauthn/#dom-publickeycredentialcreationoptions-excludecredentials</a>
</li></ul></div><pre class="programlisting">webauthn.reg.excludeCredentials.populate=true</pre><p>This can maybe in some cases be useful to prevent an authenticator to register
multiple times for the same user at the same RP, unnecessarily filling the
store of the RP and/or the autenticator if it stores the private keys.</p><p><span class="strong"><strong>webauthn.reg.authenticatorSelection.authenticatorAttachment</strong></span></p><p>The authenticatorAttachment of the authenticatorSelection for registration,
the default if not present or empty is to omit the setting from the generated
publicKey JSON, which is equivalent to "any attachment is allowed".
Standard values: <code class="literal">cross-platform</code> / <code class="literal">platform</code>.</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<a class="ulink" href="https://www.w3.org/TR/webauthn/#dom-authenticatorselectioncriteria-authenticatorattachment" target="_top">https://www.w3.org/TR/webauthn/#dom-authenticatorselectioncriteria-authenticatorattachment</a>
</li><li class="listitem">
<a class="ulink" href="https://www.w3.org/TR/webauthn/#enum-attachment" target="_top">https://www.w3.org/TR/webauthn/#enum-attachment</a>
</li><li class="listitem">
<code class="literal">cross-platform</code> - external authenticator tokens, connected through USB, NFC
or Bluetooth. The point is that a cross-platform device can be used with multiple
computers.
</li><li class="listitem">
<code class="literal">platform</code> - built-in authenticators, such as fingerprint readers, Windows PIN,
TPM, cameras for facial recognition. A platform authenticator therefore is inherently
bound to the device (laptop, smartphone).
</li></ul></div><p>Note that there are some tokens that <span class="emphasis"><em>may</em></span> qualify for both, for instance a USB
fingerprint reader, which is supported by the host OS like a local built-in
(e.g. TPM) authentication device. Such devices <span class="emphasis"><em>may</em></span> work with both settings.</p><pre class="programlisting">webauthn.reg.authenticatorSelection.authenticatorAttachment=cross-platform</pre><p>Dynamic configuration example:</p><pre class="programlisting">webauthn.reg.authenticatorSelection.authenticatorAttachment=#{var('parameter.platformType')}</pre><p>In this example, a JSP could be created that allows a user to first choose if a
cross-platform, or a platform device should be used, sending the choice in a
request parameter with name <code class="literal">platformType</code>.</p><p><span class="strong"><strong>webauthn.reg.authenticatorSelection.requireResidentKey</strong></span></p><p><span class="strong"><strong>webauthn.reg.authenticatorSelection.residentKey</strong></span></p><p>These two properties specify if the private key for the user credential should be
stored on the authenticator device itself, or if it may be stored externally on
the RP. In the latter case, the client would have to send the username first
during the login procedure, so that the RP could perform a lookup and access the
stored private key to be used during the login procedure.</p><p>The reason why there are two similar properties has to do with the evolution of
the FIDO standard and the need for backwards compatibility with older U2F tokens.</p><p>Which option is preferred depends heavily on the use-case scenario, and the
authenticator devices. Older devices may be limited in storage space (or have
none at all). Also, in corporate environments, it may be desirable to manage the
private keys of the users centrally, instead of having them stored on each
individual token. Conversely, in scenarios with external users / customers,
their private key should probably be kept on their device.</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">...requireResidentKey</code>: The <code class="literal">requireResidentKey</code> of the <code class="literal">authenticatorSelection</code> for registration, the
default is <code class="literal">false</code>. <span class="emphasis"><em>SHOULD</em></span> set it to <code class="literal">true</code> if, and only if, <code class="literal">residentKey</code> is
set to <code class="literal">required</code>.
</li><li class="listitem">
<code class="literal">...residentKey</code>: The <code class="literal">residentKey</code> of the authenticatorSelection for registration, the default is
<code class="literal">preferred</code>. Standard values: <code class="literal">required</code> / <code class="literal">preferred</code> / <code class="literal">discouraged</code>
</li><li class="listitem">
<a class="ulink" href="https://www.w3.org/TR/webauthn/#dom-authenticatorselectioncriteria-residentkey" target="_top">https://www.w3.org/TR/webauthn/#dom-authenticatorselectioncriteria-residentkey</a>
</li><li class="listitem">
<a class="ulink" href="https://www.w3.org/TR/webauthn/#dom-authenticatorselectioncriteria-requireresidentkey" target="_top">https://www.w3.org/TR/webauthn/#dom-authenticatorselectioncriteria-requireresidentkey</a>
</li><li class="listitem">
<a class="ulink" href="https://www.w3.org/TR/webauthn/#enum-residentKeyRequirement" target="_top">https://www.w3.org/TR/webauthn/#enum-residentKeyRequirement</a>
</li></ul></div><p>The values of these tokens should be set in one of the following combinations:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p class="simpara">
Allow storing private key on the device, if possible:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem">
<code class="literal">webauthn.reg.authenticatorSelection.residentKey=preferred</code>
</li><li class="listitem">
<code class="literal">webauthn.reg.authenticatorSelection.requireResidentKey=false</code>
</li></ul></div></li></ul></div><p><span class="emphasis"><em>Note that this does not guarantee specific behavior. With Yubico USB tokens
in 2021 this had the effect of not creating a resident key, with TMP with PIN
it had, which both makes sense, as in the TPM space for resident keys is much
less restricted than it was then on the Yubico tokens.</em></span></p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p class="simpara">
Enforce storing the private key on the device:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem">
<code class="literal">webauthn.reg.authenticatorSelection.residentKey=required</code>
</li><li class="listitem">
<code class="literal">webauthn.reg.authenticatorSelection.requireResidentKey=true</code>
</li></ul></div></li></ul></div><p>This had, as expected, both with Yubico and TMP the effect of creating a resident key.</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p class="simpara">
Storing the private key on the RP if possible:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem">
<code class="literal">webauthn.reg.authenticatorSelection.residentKey=discouraged</code>
</li><li class="listitem">
<code class="literal">webauthn.reg.authenticatorSelection.requireResidentKey=false</code>
</li></ul></div></li></ul></div><p><span class="strong"><strong>webauthn.reg.authenticatorSelection.userVerification</strong></span></p><p>Defines if the authenticator token itself should verify the users identity, be
it with a PIN, a fingerprint reader or something similar. The default
is <code class="literal">preferred</code>. Allowed values are: <code class="literal">required</code> / <code class="literal">preferred</code> / <code class="literal">discouraged</code>.</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<a class="ulink" href="https://www.w3.org/TR/webauthn/#dom-authenticatorselectioncriteria-userverification" target="_top">https://www.w3.org/TR/webauthn/#dom-authenticatorselectioncriteria-userverification</a>
</li><li class="listitem">
<a class="ulink" href="https://www.w3.org/TR/webauthn/#enum-userVerificationRequirement" target="_top">https://www.w3.org/TR/webauthn/#enum-userVerificationRequirement</a>
</li></ul></div><pre class="programlisting">webauthn.reg.authenticatorSelection.userVerification=preferred</pre></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="_authentication_settings"></a>Authentication Settings</h4></div></div></div><p>Settings that apply to the authentication flow, i.e. to assembling the publicKey
Javascript structure for authentication.</p><p><span class="strong"><strong>webauthn.auth.timeout</strong></span></p><p>The timeout for authentication in ms, default 60000 (one minute).
Note, however, that the client is free to ignore this setting,
and apparently this is often the case.</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<a class="ulink" href="https://www.w3.org/TR/webauthn/#dom-publickeycredentialrequestoptions-timeout" target="_top">https://www.w3.org/TR/webauthn/#dom-publickeycredentialrequestoptions-timeout</a>
</li></ul></div><pre class="programlisting">webauthn.auth.timeout=60000</pre><p><span class="strong"><strong>webauthn.auth.allowCredentials.populate</strong></span></p><p>Whether to populate the <code class="literal">allowCredentials</code> field with all existing credentials
for the user - only possible with multi-factor authentication, i.e. if the SLS
username is already known when creating the publicKey Javascript for the client
(otherwise silently not created); default is <code class="literal">true</code>.</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<a class="ulink" href="https://www.w3.org/TR/webauthn/#dom-publickeycredentialrequestoptions-allowcredentials" target="_top">https://www.w3.org/TR/webauthn/#dom-publickeycredentialrequestoptions-allowcredentials</a>
</li></ul></div><pre class="programlisting">webauthn.auth.allowCredentials.populate=true</pre><p><span class="strong"><strong>webauthn.auth.userVerification</strong></span></p><p>Defines if the authenticator token itself should verify the users identity, be
it with a PIN, a fingerprint reader or something similar. The default
is <code class="literal">preferred</code>. Allowed values are: <code class="literal">required</code> / <code class="literal">preferred</code> / <code class="literal">discouraged</code>.</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<a class="ulink" href="https://www.w3.org/TR/webauthn/#dom-publickeycredentialrequestoptions-userverification" target="_top">https://www.w3.org/TR/webauthn/#dom-publickeycredentialrequestoptions-userverification</a>
</li><li class="listitem">
<a class="ulink" href="https://www.w3.org/TR/webauthn/#enum-residentKeyRequirement" target="_top">https://www.w3.org/TR/webauthn/#enum-residentKeyRequirement</a>
</li></ul></div><pre class="programlisting">webauthn.auth.userVerification=preferred</pre><p><span class="strong"><strong>webauthn.store.type</strong></span></p><p>The type of store to use, allowed values include <code class="literal">memory</code> and <code class="literal">ldap</code>.
The default is <code class="literal">memory</code> which is ideal for testing and initial integration:
WebAuthn registration data is only persisted for as long as the SLS container
resp. its Java VM is running (but it is possible to export/import to/from
JSON string representiation using script functions for more extended testing).</p><pre class="programlisting">webauthn.store.type=ldap</pre><p>See chapter <a class="link" href="#webauthn_credential_storage" title="60.7. Credential Storage">"Credential Storage"</a> for more
information about the storage types, and for details about LDAP storage configuration.</p></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_models_7"></a>60.6.3. Models</h3></div></div></div><p>Usually the adapter will need at least two different models, one for the credential
registration process, and one for the authentication.</p><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="model_webauthn_registration"></a>Model: Credential Registration</h4></div></div></div><p>Below is a sample model in which the user registers: First presents username
and password the usual way and then does the WebAuthn registration.</p><pre class="programlisting">########################
# WebAuthn Registration
########################
model.webauthn-reg.uri=/webauthn-reg
model.webauthn-reg.failedstate=get.usererror
model.webauthn-reg.state.50.name=do.generic-skipped-if-post-request
# -----------------------

# -----------------------
# Authenticate user with username/password
# -----------------------
model.webauthn-reg.state.1000.name=get.cred
model.webauthn-reg.state.1200.name=do.auth
model.webauthn-reg.state.1200.failedState=get.cred
# -----------------------

# -----------------------
# WebAuthn registration
# -----------------------
model.webauthn-reg.state.2000.name=do.webauthn.createmsg
model.webauthn-reg.state.2000.param.flow=registration
model.webauthn-reg.state.2100.name=get.webauthn.reg.sendmsg
model.webauthn-reg.state.2200.name=do.webauthn.handlemsg

# -----------------------
# Finalize
# -----------------------
model.webauthn-reg.state.5000.name=do.success.jsp
model.webauthn-reg.state.5000.param.jsp=/WEB-INF/jsp/WebAuthnRegOk.jsp
model.webauthn-reg.state.5000.param.credentials=username,password,webauthn
# -----------------------

# -----------------------
# Error handling
# -----------------------
model.webauthn-reg.state.10000.name=get.usererror
# -----------------------</pre></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="model_webauthn_multi_factor_authentication"></a>Model: Multi-factor Authentication (2FA)</h4></div></div></div><p>This sample model shows how to perform a multi-factor authentication, using the
FIDO2 token as a second factor with username / password.</p><p>Multi-factor authentication means that the user still has to enter username and
password, and then additionally provide a credential from a registered
authenticator token. This is often used for desktop-/web-application scenarios,
to further strengthen the security.</p><p>For this scenario, the following combination of configuration settings is recommended:</p><pre class="programlisting">webauthn.reg.authenticatorSelection.residentKey=preferred
webauthn.reg.authenticatorSelection.requireResidentKey=false
webauthn.auth.userVerification=preferred</pre><pre class="programlisting">###########################################
# WebAuthn Authentication Multi-factor MFA (username known when authenticating with WebAuthn)
###########################################

model.webauthn-auth-mfa.uri=/auth
model.webauthn-auth-mfa.failedstate=get.usererror
model.webauthn-auth-mfa.state.50.name=do.generic-skipped-if-post-request
# -----------------------

# -----------------------
# Authenticate user with username/password
# -----------------------
model.webauthn-auth-mfa.state.1000.name=get.cred
model.webauthn-auth-mfa.state.1200.name=do.auth
model.webauthn-auth-mfa.state.1200.failedState=get.cred
# -----------------------

# -----------------------
# WebAuthn authentication
# -----------------------
model.webauthn-auth-mfa.state.2000.name=do.webauthn.createmsg
model.webauthn-auth-mfa.state.2000.param.flow=authentication
model.webauthn-auth-mfa.state.2100.name=get.webauthn.auth.sendmsg
model.webauthn-auth-mfa.state.2200.name=do.webauthn.handlemsg
# -----------------------

# -----------------------
# Finalize
# -----------------------
model.webauthn-auth-mfa.state.5000.name=do.success
model.webauthn-auth-mfa.state.5000.param.credentials=username,password,webauthn
# -----------------------

# -----------------------
# Error handling
# -----------------------
model.webauthn-auth-mfa.state.10000.name=get.usererror
# -----------------------</pre></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="model_webauthn_single_factor_authentication"></a>Model: Single-factor Authentication (password-less)</h4></div></div></div><p>This kind of authentication can be especially useful for web applications that
are used mostly through modern smartphone browsers. Smartphones nowadays usually come
with some form of biometric authentication mechanism (fingerprint reader, face
recognition etc.), and entering complicated passwords on a touchscreen can be
quite difficult for some users. For such scenarios, enabling single-factor
authentication can make sense, meaning the user will not have to enter a password.</p><p>As mentioned in the introduction, asking only for a username without password
or other kind of authentication is a <span class="strong"><strong>security risk</strong></span> as then credential IDs
for any user could be queried. Plus even entering just a username might be too
cumbersome on some mobile devices.</p><p>This means that in most cases only authenticators that have stored the private
key at registration can be used for single-factor / "password-less" authentication.
In this case the username is determined on the SLS when it receives the
credential ID after authentication at the client.</p><p>For single-factor authentication setups, the following combination of configuration
settings is recommended:</p><pre class="programlisting">webauthn.reg.authenticatorSelection.residentKey=required
webauthn.reg.authenticatorSelection.requireResidentKey=true
webauthn.auth.userVerification=required</pre><p>This sample model shows how to perform a single-factor authentication, using
only the FIDO2 token to authenticate the user. A common use-case for this
scenario are smartphone browsers, using a built-in biometric authentication
device like a fingerprint reader.</p><pre class="programlisting">###########################################
# WebAuthn Authentication Single-factor SFA (username not known when authenticating with WebAuthn)
###########################################

model.webauthn-auth-sfa.uri=/webauthn-auth-sfa
model.webauthn-auth-sfa.failedstate=get.usererror
model.webauthn-auth-sfa.state.50.name=do.generic-skipped-if-post-request
# -----------------------

# -----------------------
# WebAuthn authentication
# -----------------------
model.webauthn-auth-sfa.state.2000.name=do.webauthn.createmsg
model.webauthn-auth-sfa.state.2000.param.flow=authentication
model.webauthn-auth-sfa.state.2100.name=get.webauthn.auth.sendmsg
model.webauthn-auth-sfa.state.2200.name=do.webauthn.handlemsg
# -----------------------

# -----------------------
# Finalize
# -----------------------
model.webauthn-auth-sfa.state.5000.name=do.success
# note: username credential is created at do.webauthn.handlemsg, there is no password
model.webauthn-auth-sfa.state.5000.param.credentials=username,webauthn
# -----------------------

# -----------------------
# Error handling
# -----------------------
model.webauthn-auth-sfa.state.10000.name=get.usererror
# -----------------------</pre></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="webauthn_credential_storage"></a>60.7. Credential Storage</h2></div></div></div><p>When a credential is registered on the SLS to be used for later logins, it needs
to be stored somewhere. As of now, the following storage options are supported:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
LDAP
</li><li class="listitem">
IDM (For storing the credentials in a SES Identity API (Syncope) database)
</li><li class="listitem">
Memory (for testing and initial integration, not persistent)
</li></ul></div><p>For more details about the available storage types, check the corresponding
chapters below.</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_memory_storage"></a>60.7.1. Memory Storage</h3></div></div></div><p>The "memory" storage will employ a volatile, static in-memory (RAM) map of all
registered credentials, which will be lost if the service is restarted. The
main purpose of this storage type is to allow for quick testing of the
related WebAuthn functionality such as models (registration, login), JSPs etc.,
without having to configure or set up an external storage, which often means
having to involve other organizational departments, additional delays and efforts
such as changing / adapting the schema of the local LDAP service etc.</p><p>In order to store registered credentials only in memory, set the following
configuration property:</p><pre class="programlisting">webauthn.store.type=memory</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_ses_identity_idm_storage"></a>60.7.2. SES Identity (IDM) Storage</h3></div></div></div><p>The "idm" storage uses a SES Identity instance to store the Webauthn credentials
in a Syncope database. The functionality is supported with any SES 5.13.x appliance
and newer releases.</p><p>In order to store registered credentials in an IDM instance, set the following
configuration property:</p><pre class="programlisting">webauthn.store.type=idm</pre><p>Furthermore, the following configuration properties must be set for the
IDM storage functionality:</p><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="_webauthn_idm_adapter_properties"></a>Webauthn IDM Adapter properties</h4></div></div></div><p>The IDM configuration properties are usually done in the "idm-adapter.properties"
file. See the IDM adapter configuration chapter for details:</p><p><a class="link" href="#IDM_Adapter" title="Chapter 61. IDM (SES Identity) Adapter">"IDM Adapter"</a></p></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_ldap_storage"></a>60.7.3. LDAP Storage</h3></div></div></div><p>The "ldap" storage uses the JNDI API (Java Naming and Directory) to store the
WebAuthn credentials in an LDAP directory server. The functionality should work
with any LDAP-standard compliant server.</p><p>In order to store registered credentials in an LDAP directory, set the following
configuration property:</p><pre class="programlisting">webauthn.store.type=ldap</pre><p>Furthermore, the following configuration properties must be set for the
LDAP storage functionality:</p><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="_important_limitation"></a>Important Limitation</h4></div></div></div><p>Multiple LDAP backends are NOT supported, UNLESS there is a mechanism which ensures
that the entries for registered credentials in the various LDAP instances are all
up-to-date and synchronized at all times.</p><p>The problem with multiple LDAP backends is that when a user registers a credential,
it might be stored in one backend, and then when the same user performs an
authentication procedure later, the SLS might connect to a different backend
(depending on the configuration), which would lead to a failed authentication
attempt since that LDAP backend would not contain the required credential.</p><p>Therefore, it is advised to configure only one single LDAP backend, unless there
are special measures in place which keep all LDAP directories in sync.</p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="_ldap_adapter_default_properties"></a>LDAP Adapter Default Properties</h4></div></div></div><p>The following non-WebAuthn-related 3 properties must be set in order for the
SLS LDAP adapter to be initialized properly at startup time. Note that these
settings will not be used for the WebAuthn-related operations, or only as a
fallback, if the corresponding WebAuthn LDAP properties described further below
are omitted.</p><pre class="programlisting">ldap.url=...URL of LDAP server...
ldap.principal.default=...DN of bind principal...
ldap.password.default=...password of bind principal...</pre><p>The values in these 3 properties <span class="emphasis"><em>may</em></span> bet set to something like "INVALID" or
even left empty (but property key defined), as long as the WebAuthn-related
properties described further below are configured with the correct values; see</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">ldap.webauthn.url</code>
</li><li class="listitem">
<code class="literal">ldap.principal.webauthn</code>
</li><li class="listitem">
<code class="literal">ldap.password.webauthn</code>
</li></ul></div><p><span class="strong"><strong>webauthn.ldap.dn.credentials</strong></span></p><p>Defines the LDAP disginguished name (DN) of the LDAP branch which will store
all the credential entries. Example:</p><pre class="programlisting">webauthn.ldap.dn.credentials=OU=WebAuthnCredential,DC=acme,DC=com</pre><p>The child objects (one for each registered WebAuthn credential) created below
this DN will have (among others) the following attributes:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">objectClass</code>: <code class="literal">top</code>, <code class="literal">person</code>, <code class="literal">organizationalPerson</code>, <code class="literal">user</code>
</li><li class="listitem">
<code class="literal">cn</code>: A hex string with a SHA256 hash of the WebAuthn credential ID
</li></ul></div><p><span class="strong"><strong>ldap.webauthn.url</strong></span></p><p>Specifies the URL of the LDAP service used to store the WebAuthn credential
data. This is just a regular "ldap://" or "ldaps://" URL.</p><pre class="programlisting">ldap.webauthn.url=ldaps://store.acme.com:636</pre><p><span class="emphasis"><em>NOTE: If this property is not set, the SLS adapter will fall back to the
default LDAP url configured by the property <code class="literal">ldap.url</code>.</em></span></p><p>Furthermore, the following two properties must be set to configure the LDAP
bind principal used for all LDAP operations:</p><pre class="programlisting">ldap.principal.webauthn=username
ldap.password.webauthn=password</pre><p><span class="emphasis"><em>NOTE 1: The bind principal must have permissions to read, write and create
entries in the directory.</em></span></p><p><span class="emphasis"><em>NOTE 2: If the principal is not configured, the SLS adapter will fall back to the
default LDAP bind principal configured by the properties <code class="literal">ldap.principal.default</code>
and <code class="literal">ldap.password.default</code>.</em></span></p><p><span class="strong"><strong>ldap.webauthn.backendsMode</strong></span></p><p>Specifies which backend handling mode to use for the configured LDAP server.
See chapters <a class="link" href="#x51438_Heading1Tarsec_LDAP_Adapter" title="Chapter 50. LDAP Adapter">"LDAP Adapter"</a> and
<a class="link" href="#x12345_Heading1Tarsec_loadbalancing_failover" title="Chapter 27. Load-Balancing / Failover">"Load-Balancing / Failover"</a>
for details about backend modes.</p><p><span class="strong"><strong>NOTE</strong></span>: <span class="emphasis"><em>If multiple LDAP backends are used, it is of paramount importance
that the data between them is synchronized at all times! Otherwise, it may
happen that a credential of a user is stored in one backend during registration,
and then another backend is used during later authentication attempts; this could
result in failed logins due to the LDAP server not containing the required
authenticator information!</em></span></p><pre class="programlisting">ldap.webauthn.backendsMode=failover</pre><p>If only one single LDAP server is used, this setting can be omitted.</p><p><span class="strong"><strong>webauthn.ldap.attribute.name.&lt;alias&gt;</strong></span></p><p>The WebAuthn adapter needs to persist a number of fields in the LDAP directory.
To that end, it requires a mapping of each WebAuthn data entity to an LDAP
attribute. The mapping is defined using a set of properties with the following format:</p><pre class="programlisting">webauthn.ldap.attribute.name.&lt;alias&gt;=&lt;LDAP attribute name&gt;</pre><p>The "&lt;alias&gt;" part refers to a specific kind of WebAuthn-related information
entity that needs to be persisted. The following entity types exist:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">slsUsername</code> - The SLS <span class="emphasis"><em>username</em></span> credential value
</li><li class="listitem">
<code class="literal">credentialId</code> - The WebAuthn credential ID generated on the client
</li><li class="listitem">
<code class="literal">userHandle</code> - The The WebAuthn user handle created by the SLS
</li><li class="listitem">
<code class="literal">rpId</code> - The relying party (SLS) ID
</li><li class="listitem">
<code class="literal">authenticator</code> - The Base64 string containing the serialized authenticator state
</li><li class="listitem">
<code class="literal">credentialFriendlyName</code> - Descriptive label for credential, given by user
</li></ul></div><p>All of these information entities are string values, and therefore should be mapped
to LDAP attributes of type <code class="literal">DirectoryString</code>. Most of them are relatively
short, but some are, or may be very long, which means that they must be mapped
to LDAP attributes supporting larger values (up to, or above 2 KB). The following
list details the size requirements of each data entity:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">slsUsername</code> - A short username, usually &lt; 16 characters
</li><li class="listitem">
<code class="literal">credentialId</code> - Base64 string, in some cases very long, <span class="strong"><strong>up to or larger than 2 KB</strong></span>
</li><li class="listitem">
<code class="literal">userHandle</code> - Base64 string, up to 86 characters
</li><li class="listitem">
<code class="literal">rpId</code> - A short hostname-like value, usually &lt; 32 characters, technical limit 253 characters (hostname limit)
</li><li class="listitem">
<code class="literal">authenticator</code> - A long Base64 string, <span class="strong"><strong>up to or larger than 2 KB</strong></span>
</li><li class="listitem">
<code class="literal">credentialFriendlyName</code> - A short string, usually &lt; 32 characters
</li></ul></div><p>The following example shows a complete list of required mapping definitions:</p><pre class="programlisting">webauthn.ldap.attribute.name.slsUsername=middleName
webauthn.ldap.attribute.name.credentialId=businessCategory
webauthn.ldap.attribute.name.userHandle=displayName
webauthn.ldap.attribute.name.rpId=adminDisplayName
webauthn.ldap.attribute.name.authenticator=homePostalAddress
webauthn.ldap.attribute.name.credentialFriendlyName=comment</pre><p><span class="emphasis"><em>NOTE: The example above (ab)uses LDAP attributes that typically exist in an MS Active
Directory, and which fullfil the requirements of each data entity as described
below. <span class="strong"><strong>It is NOT recommended to use these settings in production environments.</strong></span>
Instead, it is advised to adapt the LDAP schema according to the requirements outlined
above, and create new attributes for the webauthn data.</em></span></p></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_script_functions"></a>60.8. Script Functions</h2></div></div></div><p>Various script functions allow to further configure/customize behavior of the
SLS als WebAuthn RP. Here only the basics are described, see the script function
documentation for details.</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_webauthn_related_script_functions"></a>60.8.1. WebAuthn-related Script Functions</h3></div></div></div><p><span class="strong"><strong>webauthn.</strong></span>*</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">Map&lt;String,Object&gt; getPublicKeyJson()</code>
  Call this method after the model step <code class="literal">do.webauthn.createmsg</code> to get a JSON
  representation of the publicKey Javascript structure, as parsed by Groovy’s
  JsonSlurper.
</li><li class="listitem">
<code class="literal">String getPublicKeyJavascript()</code>
  This method is typically only called in the provided JSPs to get the publicKey
  Javascript structure.
</li><li class="listitem">
<code class="literal">Map&lt;String,Object&gt; getReceivedMessageJson()</code>
  Call this method before the model step <code class="literal">do.webauthn.handlemsg</code> to make changes
  to the received JSON, again parsed by Groovy’s JsonSlurper.
</li><li class="listitem">
<code class="literal">String getReceivedMessageFlow()</code>
  Derives the flow, "registration" or "authentication" from the received message.
</li><li class="listitem">
<code class="literal">Map&lt;String,Object&gt; getReceivedMessageClientDataJson</code>
  Extracts and parses the "clientDataJSON" field of the received message.
</li></ul></div><p><span class="strong"><strong>webauthn_message.</strong></span>*</p><p>These methods can be called after the model step <code class="literal">do.webauthn.handlemsg</code> was
successful (at registration or authentication).</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">boolean isUserPresent()</code>
  Whether the user was present at registration resp. authentication (UP flag).
</li><li class="listitem">
<code class="literal">boolean isUserVerified()</code>
  Whether the user was verified at registration resp. authentication (UV flag).
</li><li class="listitem">
<code class="literal">boolean isAttestedCredentialDataIncluded()</code>
  AP flag.
</li><li class="listitem">
<code class="literal">boolean isExtensionDataIncluded()</code>
  ED flag.
</li><li class="listitem">
<code class="literal">Object getDataObject()</code>
  Gets the RegistrationData object at registration resp. the AuthenticationData
  object at authentication from the  WebAuthn4J library that the SLS currently uses.
</li></ul></div><p><span class="strong"><strong>function.</strong></span>*</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">String renderJson(Map&lt;String,Object&gt; map)</code>
  Renders the given JSON map to a single-line JSON string for logging etc.
</li><li class="listitem">
<code class="literal">String renderJson(Map&lt;String,Object&gt; map, boolean heuristicallyBase64UrlEncodeByteArrays)</code>
  Renders the given JSON map to a single-line JSON string for logging etc.,
  while optionally heuristically detecting byte arrays and rendering them
  as base64url-encoded strings for easier handling.
</li></ul></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_memory_store_script_functions"></a>60.8.2. Memory Store Script Functions</h3></div></div></div><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">webauthn.clearMemoryStore()</code>
   Clears all credentials in the memory store.
</li><li class="listitem">
<code class="literal">String webauthn.exportMemoryStore()</code>
   Exports the memory store in a JSON format.
</li><li class="listitem">
<code class="literal">webauthn.importMemoryStore(String storeDataJson)</code>
  Imports the memory store from previously exported JSON format.
</li></ul></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_general_store_script_functions"></a>60.8.3. General Store Script Functions</h3></div></div></div><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">List&lt;WebAuthnScriptCredentialData&gt; webauthn.getStoredCredentials()</code>
  Gets a list of all credentials for the current user and the currently
  configured RP ID.
  The credential data contains two fields, <code class="literal">credentialId</code> and <code class="literal">credentialFriendlyName</code>.
</li><li class="listitem">
<code class="literal">webauthn.deleteStoredCredential(String credentialId)</code>
  Deletes the credential with the given credential ID from the store, but for
  security reasons only if the credential is for the current user and the
  currently configured RP ID.
</li></ul></div></div></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="IDM_Adapter"></a>Chapter 61. IDM (SES Identity) Adapter</h2></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_introduction_24"></a>61.1. Introduction</h2></div></div></div><p>The IDM adapter allows to authenticate user credentials with basic authentication requests to a SES Identity server.
On a SES appliance, this is usually the local SES Identity instance.</p><p>In future releases, this adapter will probably be extended to allow all kinds of custom REST calls on the IDM Syncope
API, but for now, the functionality is restricted to authentication.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_jexl_variables_3"></a>61.2. JEXL Variables</h2></div></div></div><p>The IDM response object received from the SES Identity server during the authentication callout
is available as an object variable <code class="literal">idm.response</code> of the type <code class="literal">UserTO</code>, representing the following JSON structure:</p><pre class="screen">{
   "key":"badafbfc-d6a9-4c09-9afb-fcd6a97c0916",
   "type":"USER",
   "realm":"/someRealm",
   "username":"myuser",
   "creator":"admin",
   "creationDate":"2022-01-25T17:43:24.335+00:00",
   "lastModifier":"admin",
   "lastChangeDate":"2022-01-25T17:43:24.335+00:00",
   "status":"created",
   "password":null,
   "token":null,
   "tokenExpireTime":null,
   "lastLoginDate":"2022-02-01T07:40:55.483+00:00",
   "changePwdDate":"2022-01-25T17:43:23.402+00:00",
   "failedLogins":0,
   "securityQuestion":null,
   "securityAnswer":null,
   "suspended":false,
   "mustChangePassword":false,
   "dynRealms":[

   ],
   "auxClasses":[

   ],
   "plainAttrs":[
      {
         "schema":"passwordNeverExpires",
         "values":[
            "true"
         ]
      }
   ],
   "derAttrs":[

   ],
   "virAttrs":[

   ],
   "resources":[

   ],
   "roles":[

   ],
   "dynRoles":[

   ],
   "privileges":[

   ],
   "relationships":[

   ],
   "memberships":[

   ],
   "dynMemberships":[

   ],
   "linkedAccounts":[

   ]
}</pre><p>This object then has getter and setter methods for all the fields in the JSON structure. So for the example
above, the following example would be possible:</p><pre class="screen">#{var('idm.response').getCreator()}</pre><p>Furthermore, the numeric code of the last HTTP call to the IDM backend is
available in the usual (see HTTP Adapter) variable:</p><pre class="screen">response.code</pre></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_authentication_6"></a>61.3. Authentication</h2></div></div></div><p>To use the IDM adapter for an authentication step, just configure it as usual, e.g.</p><pre class="programlisting">adapter.authentication=idm</pre><p>With that, the model state <code class="literal">do.auth</code> will use the IDM adapter to send a GET request
to the SES Identity API (Syncope) server, to the following URI:</p><pre class="screen">/idm-api/rest/users/self</pre><p>The request will use the users <code class="literal">username</code> and <code class="literal">password</code> credentials, which MUST be
available in the current login session at this point, for the basic authentication header.
If the call is successful, the credentials will be marked as verified.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_configuration_23"></a>61.4. Configuration</h2></div></div></div><p>The IDM adapter is configured through a Java properties file, usually named <code class="literal">idm-adapter.properties</code>.
The following paragraphs explain all available configuration properties and values.</p><p><span class="strong"><strong>idm.url</strong></span></p><p>Defines the base URL (protocol, host and port) of the SES Identity API (Syncope) Server.
The typical value for an IDM instance running on the same appliance as the SLS would be as follows:</p><pre class="programlisting">idm.url=http://localhost:3447</pre><p>By default, the SES Identity API uses the following two ports:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
3447 for plain HTTP
</li><li class="listitem">
3443 for TLS / HTTPS
</li></ul></div><div class="note" style="margin-left: 0; margin-right: 10%;"><h3 class="title">Note</h3><p>If an external IDM instance is used, connections will most likely need
to be made on the HTTPS/SSL enabled port, usually 3443. In such cases, it is
necessary to import the HTTPS server certificate of the IDM target server in
the SLS truststore (same as with any other HTTPS backend server).</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_failover_or_load_balancing"></a>61.4.1. Failover or Load-Balancing</h3></div></div></div><div class="important" style="margin-left: 0; margin-right: 10%;"><h3 class="title">Important</h3><p><span class="emphasis"><em>If any form of failover or load-balancing between multiple IDM API
instances is used, they must be in sync with each other in regards to the user
data. So the underlying databases should be automatically kept in sync, otherwise
the authentication attempts might be unreliable!</em></span></p></div><p>To define more than one IDM backend that should be used as a fall-back in
case the connection to the current directory fails, specify additional IDM URLs,
each one separated by comma:</p><pre class="programlisting">idm.url=https://one.identity.com:3443,https://two.identity.com:3443</pre><p>This will enable simple failover by default. By adding the ".mode" property,
failover with a primary, or load-balancing can be enabled.</p><p>The <span class="strong"><strong>criterion for backend availability</strong></span> is:
Connect with the technical username/password was successful.</p><p>Example for enabling failover with a primary backend:</p><pre class="programlisting">idm.url=https://one.identity.com:3443,https://two.identity.com:3443
idm.backendsMode=failoverWithPrimary</pre><p>Or alternatively, enabling load-balancing instead of failover:</p><pre class="programlisting">idm.url=https://one.identity.com:3443,https://two.identity.com:3443
idm.backendsMode=loadBalancing</pre><p>The default backend mode is <code class="literal">failover</code>, simple round-robin failover.</p><p>Please see chapter <a class="link" href="#x12345_Heading1Tarsec_loadbalancing_failover" title="Chapter 27. Load-Balancing / Failover">"Load-Balancing / Failover"</a> for details
about failover and load-balancing.</p><p><span class="strong"><strong>idm.connectionCheckTenant</strong></span></p><p>An existing tenant MUST be configured using this property. The reason is that
if either load-balancing or fallback with primary is used, monitoring of the backends is
required. It is also possible that monitoring is enabled separately, or due to settings in
another adapter.</p><p>In such a case, a valid tenant must be used for the monitoring requests. Since
the regular tenant property can be an expression (to chose the tenant dynamically from within
the model), there needs to be an additional, fixed, statically configured tenant to be used
for the monitoring requests. Example:</p><pre class="programlisting">idm.connectionCheckTenant=acme</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_general_settings_2"></a>61.4.2. General Settings</h3></div></div></div><p><span class="strong"><strong>idm.tenant</strong></span></p><p>The SES Identity tenant for which to perform the operations. The value configured
here will be used in the request header "X-Syncope-Domain" sent to the IDM API backend.</p><pre class="programlisting">idm.tenant=FoogleCom</pre><p>As with most other SLS configuration properties, it is possible to use a dynamic
expression, if the SLS should serve multiple tenants. Example:</p><pre class="programlisting">idm.tenant=#{var('someVariableSetInTheModel')}</pre><p><span class="strong"><strong>idm.username</strong></span>
<span class="strong"><strong>idm.password</strong></span></p><p>Most requests to the IDM API server require credentials of a technical user, to be
used in an "Authorization" header sent to the Syncope service. These values MUST be
configured with these two properties. Example:</p><pre class="programlisting">idm.username=admin
idm.password=jE73dDW93FOS08W7493nhdw0</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_proxy_support_2"></a>61.4.3. Proxy Support</h3></div></div></div><p>The following properties allow to use a proxy server through which to send all the
REST requests to the IDM API backend.</p><p><span class="strong"><strong>idm.http.proxy.host</strong></span>,
<span class="strong"><strong>idm.http.proxy.port</strong></span></p><p>Optional settings for host and port of a proxy to use for REST calls to the
IDM API backend. If a proxy host is configured, configuring also the port is mandatory.</p><pre class="programlisting">idm.http.proxy.host=proxy.acme.org
idm.http.proxy.port=8443</pre><p><span class="strong"><strong>idm.http.proxy.auth.username</strong></span></p><p>Optional setting for the username for proxy authentication.</p><p><span class="strong"><strong>idm.http.proxy.auth.password</strong></span></p><p>Setting for the password for proxy authentication,
mandatory if the username is defined.</p><p><span class="strong"><strong>idm.http.proxy.auth.type</strong></span></p><p>The type of authentication to the proxy.
Allowed values are <code class="literal">basic</code>, <code class="literal">ntlm</code> and <code class="literal">spnego</code>, default is <code class="literal">basic</code>.</p><p><span class="strong"><strong>idm.http.proxy.auth.domain</strong></span></p><p>Optional domain or realm for proxy authentication.</p><p>Sample config settings for proxy with basic auth:</p><pre class="programlisting">idm.http.proxy.host=proxy.acme.org
idm.http.proxy.port=8443
idm.http.proxy.auth.username=sls
idm.http.proxy.auth.password=secret
idm.http.proxy.auth.type=basic
idm.http.proxy.auth.domain=acme</pre></div></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="MobileID_Login"></a>Chapter 62. Mobile ID Login</h2></div></div></div><p>While the SLS does not feature something like a "Mobile ID" adapter, support for
this login procedure can be implemented using the right combination of model,
HTTP adapter configuration, templates and scripting. The following
components (see folder "examples/mobileid" in the delivery archive)
are required to set up a Mobile ID login:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
Mobile ID login model
</li><li class="listitem"><p class="simpara">
5 JSON request and response template files
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem">
<code class="literal">mobileid-MSS_SignatureReq.json</code> - creates REST signing request
</li><li class="listitem">
<code class="literal">mobileid-MSS_SignatureResp.json</code> - processes REST signing response
</li><li class="listitem">
<code class="literal">mobileid-MSS_StatusReq.json</code> - creates REST status request
</li><li class="listitem">
<code class="literal">mobileid-MSS_StatusResp.json</code> - processes REST status response
</li><li class="listitem">
<code class="literal">mobileid-MSS_RespFault.json</code> - processes REST fault responses
</li></ul></div></li><li class="listitem">
<code class="literal">mobileid.properties</code> - Some Mobile ID related settings
</li><li class="listitem">
<code class="literal">http-adapter.properties</code> - HTTP adapter configuration
</li></ul></div><p>Setting it all up:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">
Add the Swisscom CA certificates to the SLS truststore
</li><li class="listitem">
Add the SLS client certificate for the HTTPS connection to the SLS keystore
</li><li class="listitem">
Copy the 5 JSON template files into the <code class="literal">WEB-INF/templates</code> folder of the SLS
</li><li class="listitem">
Copy the Mobile ID login model file into the <code class="literal">WEB-INF</code> folder of the SLS.
</li><li class="listitem">
Adapt the login model for the authentication step (username / password check) with lookup of mobile number
</li><li class="listitem">
Adapt the Mobile ID settings in the <code class="literal">mobileid.properties</code> file.
</li><li class="listitem">
Adapt the private key alias in the <code class="literal">http-adapter.properties</code> file.
</li><li class="listitem">
If needed, add required proxy settings for the custom HTTP calls in the <code class="literal">http-adapter.properties</code>
</li></ol></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_configuration_details"></a>62.1. Configuration Details</h2></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_login_model_adaptation"></a>62.1.1. Login Model adaptation</h3></div></div></div><p>The "Mobile ID" challenge is just an addition to a previously performed password
verification step. The password verification is usually done with a standard
mechanism like LDAP. It is also important that during, or right after that
step, the user’s mobile number is retrieved from somewhere. In case of an LDAP
authentication, all LDAP user attributes are automatically turned into scripting
variables, so the common attribute "mobile" would create the variable</p><p><code class="literal">attribute.ldap.mobile</code></p><p>which can then be set in the property <code class="literal">mobileid.mobilenumber</code> (see
<a class="link" href="#MobileIdSettings" title="62.1.4. Mobile ID Settings">"Mobile ID Settings"</a>).</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_sls_client_certificate"></a>62.1.2. SLS Client certificate</h3></div></div></div><p>The SLS client certificate which has been registered at Swisscom for the HTTPS
TLS connection to the Mobile ID backend needs to be imported into the SLS keystore.
The alias given to this key then has to be configured in the HTTP adapter configuration
(see <a class="link" href="#MobileIdHttpAdapterSettings" title="62.1.6. HTTP Adapter Settings">"Mobile ID HTTP Adapter settings"</a>).</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_swisscom_ca_certificates"></a>62.1.3. Swisscom CA certificates</h3></div></div></div><p>There are usually at least 2 CA certificates that need to be added to the SLS
truststore. One will be needed to verify the Swisscom REST service HTTPS server,
in the HTTPS connection between the SLS and the REST backend. The second CA
certificate will be needed to verify the signature in the Swisscom response.</p><p>For details about the CA certificates, and where to download the latest versions
of them, please consult the Swisscom Mobile ID Reference Guide.</p><p>Beyond adding those certificates to the truststore, no further configuration is
required. The certificates will be used automatically when needed (no alias
settings required).</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="MobileIdSettings"></a>62.1.4. Mobile ID Settings</h3></div></div></div><p><span class="strong"><strong><code class="literal">mobileid.ap-id</code></strong></span></p><p>Mandatory / Defines the ID of the Mobile ID Access Point (AP / your SLS instance). This
is a credential that must be provided by Swisscom when registering the SLS instance.
Example:</p><pre class="programlisting">mobileid.ap-id=mid://ap.acme.com</pre><p><span class="strong"><strong><code class="literal">mobileid.ap-pwd</code></strong></span></p><p>Optional / Defines the password of the Mobile ID Access Point (AP / your SLS instance). This
is a credential that must be provided by Swisscom when registering the SLS instance. In case
of X509 mutual authentication between the SLS and the Swisscom backend, this may be empty.
Example:</p><pre class="programlisting">mobileid.ap-pwd=somePassword</pre><p><span class="strong"><strong><code class="literal">mobileid.mobilenumber</code></strong></span></p><p>Mandatory / Specifies the source for the value of the end user’s mobile phone
number. This is usually a JEXL / Groovy expression referencing a variable containing
that number, such as an attribute set by the LDAP adapter in a previous look-up.
Example:</p><pre class="programlisting">mobileid.mobilenumber=#{var('attribute.ldap.mobile')}</pre><p><span class="strong"><strong><code class="literal">mobileid.msg-prefix</code></strong></span></p><p>Mandatory / The prefix for the message that must be signed by the user. This prefix
is SLS instance specific and represents a credential provided by Swisscom when
registering the SLS instance. Example:</p><pre class="programlisting">mobileid.msg-prefix=ACME SLS</pre><p><span class="strong"><strong><code class="literal">mobileid.msg-data</code></strong></span></p><p>Mandatory / The message data (the part after the prefix), typically configured
by referencing <code class="literal">text.mobileid.data</code> (see "Data to be signed" further below) from
language resources and by generating the 4-digit secure random digits like this:</p><pre class="programlisting">mobileid.msg-data=#{': ' + function.htmlDecode(function.getLocalizedMessage('text.mobileid.data')) + ' (#' + mobileid.getSecureRandomText() + ')' }</pre><p><span class="strong"><strong><code class="literal">mobileid.truststore.path</code></strong></span>
<span class="strong"><strong><code class="literal">mobileid.truststore.pwd</code></strong></span>
<span class="strong"><strong><code class="literal">mobileid.truststore.type</code></strong></span></p><p>Optional / The path of the Java keystore to be used as truststore for the mobile
ID signature verification step
(absolute path or path relative to the webapp directory).
NOTE: This only allows to adjust the truststore
path for the signature verification; for the HTTPS mutual authentication connection,
the normal truststore will be used.</p><p>If these properties are not set, the same truststore used for TLS connections will
also be used for the signature verification.</p><p>Example:</p><pre class="programlisting">mobileid.truststore.path=/var/acme/keys/truststore
mobileid.truststore.pwd=changeit
mobileid.truststore.type=JKS</pre><p>The default for the property <code class="literal">mobileid.truststore.type</code> is "JKS".</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_data_to_be_signed"></a>62.1.5. Data to be signed</h3></div></div></div><p>The message that is sent to the user and signed by entering the PIN is taken
from the SLS message resource files, from the key</p><p><code class="literal">text.mobileid.data</code></p><p>Adapt the value of this key to change the text of the message. Note that only
German, French, Italian and English are supported by Mobile ID.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="MobileIdHttpAdapterSettings"></a>62.1.6. HTTP Adapter Settings</h3></div></div></div><p>The HTTP adapter configuration requires two custom HTTP actions, like this:</p><pre class="programlisting"># Default JSON fault response template
template.file.mobileid-faultresponse=mobileid-MSS_RespFault.json

# --------------- MobileID signing call -----------------
template.file.http-request-mobileid-sign=mobileid-MSS_SignatureReq.json
template.file.http-response-mobileid-sign=mobileid-MSS_SignatureResp.json

http.mobileid-sign.method=post
http.mobileid-sign.header.Content-Type=application/json;charset=UTF-8
http.mobileid-sign.url=https://mobileid.swisscom.com/rest/service
http.mobileid-sign.body=${function.getTemplateContent('http-request-mobileid-sign')}
http.mobileid-sign.code.error=500,503
http.mobileid-sign.key.alias=&lt;ACME mobileid client&gt;
http.mobileid-sign.action.1=#{mobileid.checkSignatureResponse()}
http.mobileid-sign.action.2=#{function.logAudit("Waiting for MID signature...")}

# --------------- MobileID status call -----------------
template.file.http-request-mobileid-status=mobileid-MSS_StatusReq.json
template.file.http-response-mobileid-status=mobileid-MSS_StatusResp.json

http.mobileid-status.method=post
http.mobileid-status.header.Content-Type=application/json;charset=UTF-8
http.mobileid-status.url=https://mobileid.swisscom.com/rest/service
http.mobileid-status.body=${function.getTemplateContent('http-request-mobileid-status')}
http.mobileid-status.code.error=500,503
http.mobileid-status.key.alias=&lt;ACME mobileid client&gt;</pre><p>Some important notes:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
With the provided request templates, the Swisscom backend will support both
  SIM and app mode (see further below).
</li><li class="listitem">
The ".key.alias" property must contain the alias of the SLS private key, i.e.
  the client certificate that was registered at Swisscom for the HTTPS TLS connection
  with mutual authentication.
</li></ul></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_sample_mobileid_settings"></a>62.1.7. Sample MobileID Settings</h3></div></div></div><pre class="programlisting">mobileid.ap-id=mid://ap.united-security-providers.ch
mobileid.ap-pwd=

mobileid.mobilenumber=#{var('attribute.file.mobileNumber')}
mobileid.msg-prefix=ACME SLS
mobileid.msg-data=#{': ' + function.htmlDecode(function.getLocalizedMessage('text.mobileid.data')) + ' (#' + mobileid.getSecureRandomText() + ')' }

# Optional: Truststore for validation of signer certificate
#mobileid.truststore.path=...file path...
#mobileid.truststore.pwd=...password...</pre></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_sim_vs_app_mode"></a>62.2. SIM vs App mode</h2></div></div></div><p>There are two ways to log in with Mobile ID:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
Using a challenge-/response mechanism performed by the SIM card itself. This
  requires a Mobile ID enabled SIM card.
</li><li class="listitem">
Using an iOS / Android app.
</li></ul></div><p>From the SLS point of view, this is fully transparent.</p><p>Note that the provided request templates use the Swisscom backend which automatically
selects either the SIM- or the App-based login, based on the user’s preferences.</p><p>Also worth noting is the "App" mode is for Swisscom customers only. All other
mobile phone providers only support the SIM mode.</p><p>For details on how to adapt the request templates to either enforce SIM- or app-
based login, adjust the JSON parameter "SignatureProfile" - see Swisscome Mobile ID
Reference Guide for details.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_mobile_id_jsps"></a>62.3. Mobile ID JSPs</h2></div></div></div><p>There are 3 JSPs involved with the Mobile ID login flow:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">
<code class="literal">MobileIDWait.jsp</code> - Is displayed after sending the signing request. It contains
JavaScript code to pull the status of the signing transaction in regular intervals
using AJAX requests.
</li><li class="listitem">
<code class="literal">MobileIDState.jsp</code> - Is used to provide the response to the AJAX request.
.<code class="literal">MobileIDError.jsp</code> - Provides some MobileID specific customizations in case
of an error.
</li></ol></div><p>If CI adaptations need to be made (logo, stylesheets etc.), only the two files
<code class="literal">MobileIDWait.jsp</code> and <code class="literal">MobileIDError.jsp</code> need to be changed. The JSP file
<code class="literal">MobileIDState.jsp</code> is never visible to the end user, it’s only processed
by the JavaScript handler in the browser.</p><p>See <a class="link" href="#x11534_Heading2Tarsec_List_of_model_states" title="7.9. List of model states">"List of model states"</a> for
details about the model states mapped to each one of these JSPs.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_scripting_variables_2"></a>62.4. Scripting Variables</h2></div></div></div><p>The Mobile ID login flow generates a few variables that are used by the request
templates and/or to process and validate the responses. Normally, it should not
be necessary to do anything with them, but just for the sake of information,
this is the list of all the variables:</p><div class="informaltable"><table class="informaltable" cellpadding="4px" style="border-collapse: collapse;border-top: 3px solid #527bbd; border-bottom: 3px solid #527bbd; border-left: 3px solid #527bbd; border-right: 3px solid #527bbd; "><colgroup><col class="col_1" /><col class="col_2" /></colgroup><tbody><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p><code class="literal">MID_LANG</code></p></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>The language of the user sent in the signing request to the Mobile ID backend.
 Supported values are "DE" (German), "FR" (French), "IT" (Italian) and "EN" (English).</p></td></tr><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p><code class="literal">MID_AP_ID</code></p></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>The SLS Mobile ID Authentication Provider ID.</p></td></tr><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p><code class="literal">MID_AP_ID_RECEIVED</code></p></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>In the responses from the Mobile ID backend, the Authentication Provider ID is
also sent back. This is used to validate the response.</p></td></tr><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p><code class="literal">MID_AP_PWD</code></p></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>The SLS Mobile ID Authentication Provider Password (may be empty).</p></td></tr><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p><code class="literal">MID_AP_TRANS_ID</code></p></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>A random 20-digit string used as a transactional identifier. The value is used
in the request sent to the Mobile ID backend, and the response will require to
feature the same value (see variable <code class="literal">MID_AP_ID_RECEIVED</code>).</p></td></tr><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p><code class="literal">MID_AP_TRANS_ID_RECEIVED</code></p></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>In the responses from the Mobile ID backend, the transaction identifier is
also sent back. This is used to validate the response.</p></td></tr><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p><code class="literal">MID_MOBILE_NUMBER</code></p></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>The mobile number of the phone to which the Mobile ID challenge will be sent.</p></td></tr><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p><code class="literal">MID_MOBILE_NUMBER_RECEIVED</code></p></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>In the responses from the Mobile ID backend, the mobile number is
also sent back. This is used to validate the response.</p></td></tr><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p><code class="literal">MID_MSG_TO_BE_SIGNED</code></p></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>The message being sent to the user’s mobile phone, to be signed by them.</p></td></tr><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p><code class="literal">MID_MSSP_SIGNATURE</code></p></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>Contains the signature of the signed data as sent back in the status response
after a successful login. This signature is then validated using the Swisscom
CA certificate in the truststore.</p></td></tr><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p><code class="literal">mobileIdFailureReason</code></p></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>In case of a failed login, this text string contains the error reason to be
displayed to the user in the JSP.</p></td></tr><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p><code class="literal">mobileIdStatusMsg</code></p></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>Contains the Mobile ID status message received in the last response from the
Mobile ID backend.</p></td></tr><tr><td style="border-right: 1px solid #527bbd; " align="left" valign="top"><p><code class="literal">mobileIdStatusCode</code></p></td><td style="" align="left" valign="top"><p>Contains the Mobile ID status code received in the last response from the
Mobile ID backend.</p></td></tr></tbody></table></div></div></div></div><div class="part"><div class="titlepage"><div><div><h1 class="title"><a id="_frontend"></a>Part V. Frontend</h1></div></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="_sls_frontends"></a>Chapter 63. SLS Frontends</h2></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_introduction_25"></a>63.1. Introduction</h2></div></div></div><p>SLS Frontends provide access to SLS authentication capabilities via other protocols (e.g. SOAP or RADIUS). The basic principle is that any such frontend is basically a translator between non-HTTP protocols and the HTTP-based SLS:</p><p>A frontend receives requests in its specific protocol and then makes a local HTTP call to the SLS to perform the actual authentication. The HTTP response of the SLS is then processed by the frontend and translated back to the original protocol.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_configuration_24"></a>63.2. Configuration</h2></div></div></div><p><span class="strong"><strong><code class="literal">frontends</code></strong></span></p><p>Comma separated list of frontend IDs. If this property is set, the corresponding frontends are started, including custom thread-pools etc. Example:</p><pre class="screen">frontends=soap</pre><p>Note: Currently, only "<code class="literal">soap</code>" is a supported value. Others will be implemented in future SLS releases.</p><p>Furthermore, each frontend usually has a separate configuration file for its specific configuration. The name of the file follows the convention "<code class="literal"><span class="emphasis"><em>&lt;type&gt;</em></span>-frontend.properties</code>", like "<code class="literal">soap-frontend.properties</code>".</p></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="x51351_Heading1Tarsec_SOAP_Frontend"></a>Chapter 64. SOAP Frontend</h2></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_introduction_26"></a>64.1. Introduction</h2></div></div></div><p>The SOAP Frontend provides SLS authentication capabilities via a Web Service interface.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_features_13"></a>64.2. Features</h2></div></div></div><p>The following features will give you a brief overview of the SOAP Frontend functionality:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
SOAP 1.1 with document style (wrapped) WSDL
</li><li class="listitem">
Single-step authentication (typical use case username/password login)
</li><li class="listitem">
Currently, the SOAP Frontend cannot be used on an SLS on which the RSA7 adapter is used, due to conflicting 3rd party
Jar library requirements.
</li></ul></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="x27229_Heading2Tarsec_Configuration"></a>64.3. Configuration</h2></div></div></div><p>The SOAP Frontend is configured through a property file, usually named "<code class="literal">soap-frontend.properties</code>".</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="x15833_Heading3Tarsec_soap_frontend_properties"></a>64.3.1. soap-frontend.properties</h3></div></div></div><p><span class="strong"><strong><code class="literal">frontend.soap.publish.uri</code></strong></span></p><p>This configuration property defines the URL at which the Web Service will be published. If the frontend itself is
located behind an SES reverse proxy, this should be the URL as it can be reached from the SRM.</p><p>Note that this is usually a "<code class="literal">http://</code>" URL; as of now, the SOAP frontend does not support the "<code class="literal">https://</code>" protocol
directly. The reason being that it's the HTTPS listener of the reverse proxy which handles the SSL connection with the
client. The actual SOAP client connects to the HTTPS listener, which forwards the connection to the SRM, and the SRM
forwards it to the SLS Tomcat with the SOAP frontend (just as with any common SES setup).</p><p>Therefore, a typical example would look like this:</p><pre class="programlisting">frontend.soap.publish.uri=http://acme.com:3333/sls/soap-frontend</pre><p>Then a corresponding location should be defined in the SRM:</p><pre class="screen">&lt;Location /sls/soap-frontend&gt;
AC_AccessArea                Public
HGW_Host                     slshost.acme.com:3333
&lt;/Location&gt;</pre><p><span class="strong"><strong><code class="literal">frontend.soap.sls.url</code></strong></span></p><p>This configuration property defines the URL at the SLS for the login via HTTP. This is usually the hostname of the local
host and the port of the HTTP listener in the SLS container. Example:</p><pre class="programlisting">frontend.soap.sls.url=http://localhost:8080/sls/auth</pre><p><span class="strong"><strong><code class="literal">frontend.soap.threads</code></strong></span></p><p>This optional property allows to set the size of the listener thread pool. If not
set, it defaults to 200. Example:</p><pre class="programlisting">frontend.soap.threads=500</pre><p><span class="strong"><strong><code class="literal">frontend.soap.forward.header.<span class="emphasis"><em>&lt;id&gt;</em></span></code></strong></span></p><p>This configuration property has two meanings (partially for historical reasons):
* The first meaning is a regex for HTTP response headers received from the SLS
  to return to the client/HSP as HTTP response headers.
* The second meaning is the name (not a regex) of HTTP request headers received
  from the client/HSP to also send back to the client/HSP as HTTP response headers.</p><p>For example, if the HTTP header "<code class="literal">hsp_client_addr</code>", which the SLS received from the reverse proxy,
should be forwarded back to the SOAP client, this setting would be required:</p><pre class="programlisting">frontend.soap.forward.header.0=hsp_client_addr</pre><p>Also returns headers of the exact same name that were received by the HSP</p><p><span class="strong"><strong><code class="literal">frontend.soap. attribute.<span class="emphasis"><em>&lt;name&gt;</em></span></code></strong></span></p><p><span class="emphasis"><em>Optional:</em></span> Allows to define custom attributes in the SOAP response. Each attribute consists of a key and a value. For
example, this would send back an attribute with the key "<code class="literal">info</code>", and with a prefix "<code class="literal">User:</code>", followed by the login ID,
as its value:</p><pre class="programlisting">frontend.soap.attribute.info=User: ${session.getCred('username')}</pre><p><span class="strong"><strong><code class="literal">frontend.soap.status.message</code></strong></span></p><p>_Optional:_Allows to define a text string to be sent back in the XML element "<code class="literal">slsStatusMessage</code>" in the SOAP response.
Example:</p><pre class="programlisting">frontend.soap.status.message=State: ${session.getModelState()}</pre></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_soap_webservice_frontend_logging"></a>64.4. SOAP / Webservice Frontend Logging</h2></div></div></div><p>The default log4j configuration is set up so that the SOAP frontend will write its own logfile (see
<a class="link" href="#x59531_Heading3Tarsec_soap_frontend_log_SOAP_Webservice_frontend_log" title="25.5.6. soap-frontend.log - SOAP / Webservice frontend log">"soap-frontend.log - SOAP / Webservice frontend log"</a> for details).</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_web_service_api"></a>64.5. Web Service API</h2></div></div></div><p>Once the SLS has started, the WSDL for the Web Service is visible at "<code class="literal"><span class="emphasis"><em>&lt;frontend.soap.publish.uri&gt;</em></span></code>+?wsdl+".</p><p><span class="emphasis"><em>Note: The SLS web application must have been started before the SOAP frontend can be used. So, as a general rule, it is
advised to first invoke the login page once manually before accessing any SOAP frontend function URL.</em></span></p><p>There is one method, "authenticate". It is passed credentials as a map of key/value pairs. The exact credentials depend
on the SLS adapter used. A common use case is passing a userid and a password.</p><p>The key of each pair should be the semantic type of an SLS credential, which is one of this list:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">username</code>
</li><li class="listitem">
<code class="literal">password</code>
</li><li class="listitem">
<code class="literal">newpassword</code>
</li><li class="listitem">
<code class="literal">newpassword2</code>
</li><li class="listitem">
<code class="literal">challenge</code>
</li><li class="listitem">
<code class="literal">secret</code>
</li><li class="listitem">
<code class="literal">certificate</code>
</li></ul></div><p>And the value of each pair is the value of the respective credential.</p><p>The method returns a SLS status code and a list of next credentials. The list of next credentials is always empty and
intended for future support of more complex authentication procedures involving several autentication steps. The SLS
status code can have the following numerical values:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
200: User has been successfully authenticated.
</li><li class="listitem">
401: The SLS (not its back-end service!) has denied the request, for example due to invalid or missing credentials.
</li><li class="listitem">
500: Internal error in SLS.
</li><li class="listitem">
503: The back-end system of the SLS has failed.
</li></ul></div><p>The Web Service call may also fail on the HTTP transport level, i.e. return something else than HTTP Status 2xx.
Exceptions are normally not propagated back to the caller of the Web Service and result instead in SLS status code
500 (and a log entry on the SLS).</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_wsdl"></a>64.6. WSDL</h2></div></div></div><p>Below the WSDL; note that the publishing endpoint depends on SLS settings and HSP.</p><pre class="screen">&lt;?xml version='1.0' encoding='UTF-8'?&gt;&lt;wsdl:definitions name="ISlsSoapWebServiceService" targetNamespace="http://soap.frontend.sls.usp.com/" xmlns:ns1="http://schemas.xmlsoap.org/soap/http" xmlns:soap="http://schemas.xmlsoap.org/wsdl/soap/" xmlns:tns="http://soap.frontend.sls.usp.com/" xmlns:wsdl="http://schemas.xmlsoap.org/wsdl/" xmlns:xsd="http://www.w3.org/2001/XMLSchema"&gt;
  &lt;wsdl:types&gt;
    &lt;xs:schema elementFormDefault="qualified" targetNamespace="http://soap.frontend.sls.usp.com/" version="1.0" xmlns:tns="http://soap.frontend.sls.usp.com/" xmlns:xs="http://www.w3.org/2001/XMLSchema"&gt;
      &lt;xs:element name="authenticate" type="tns:authenticate"/&gt;
      &lt;xs:element name="authenticateResponse" type="tns:authenticateResponse"/&gt;
      &lt;xs:complexType name="authenticate"&gt;
        &lt;xs:sequence&gt;
          &lt;xs:element minOccurs="0" name="authenticateRequest" type="tns:slsSoapAuthenticateRequest"/&gt;
        &lt;/xs:sequence&gt;
      &lt;/xs:complexType&gt;
      &lt;xs:complexType name="slsSoapAuthenticateRequest"&gt;
        &lt;xs:sequence&gt;
          &lt;xs:element name="credentials"&gt;
            &lt;xs:complexType&gt;
              &lt;xs:sequence&gt;
                &lt;xs:element maxOccurs="unbounded" minOccurs="0" name="entry" nillable="true"&gt;
                  &lt;xs:complexType&gt;
                    &lt;xs:sequence&gt;
                      &lt;xs:element minOccurs="0" name="key" type="xs:string"/&gt;
                      &lt;xs:element minOccurs="0" name="value" type="xs:string"/&gt;
                    &lt;/xs:sequence&gt;
                  &lt;/xs:complexType&gt;
                &lt;/xs:element&gt;
              &lt;/xs:sequence&gt;
            &lt;/xs:complexType&gt;
          &lt;/xs:element&gt;
        &lt;/xs:sequence&gt;
      &lt;/xs:complexType&gt;
      &lt;xs:complexType name="authenticateResponse"&gt;
        &lt;xs:sequence&gt;
          &lt;xs:element minOccurs="0" name="return" type="tns:slsSoapAuthenticateResponse"/&gt;
        &lt;/xs:sequence&gt;
      &lt;/xs:complexType&gt;
      &lt;xs:complexType name="slsSoapAuthenticateResponse"&gt;
        &lt;xs:sequence&gt;
          &lt;xs:element name="attributes"&gt;
            &lt;xs:complexType&gt;
              &lt;xs:sequence&gt;
                &lt;xs:element maxOccurs="unbounded" minOccurs="0" name="entry" nillable="true"&gt;
                  &lt;xs:complexType&gt;
                    &lt;xs:sequence&gt;
                      &lt;xs:element minOccurs="0" name="key" type="xs:string"/&gt;
                      &lt;xs:element minOccurs="0" name="value" type="xs:string"/&gt;
                    &lt;/xs:sequence&gt;
                  &lt;/xs:complexType&gt;
                &lt;/xs:element&gt;
              &lt;/xs:sequence&gt;
            &lt;/xs:complexType&gt;
          &lt;/xs:element&gt;
          &lt;xs:element maxOccurs="unbounded" minOccurs="0" name="nextCredentialSemanticTypes" nillable="true" type="xs:string"/&gt;
          &lt;xs:element name="slsStatusCode" type="xs:int"/&gt;
          &lt;xs:element minOccurs="0" name="slsStatusMessage" type="xs:string"/&gt;
        &lt;/xs:sequence&gt;
      &lt;/xs:complexType&gt;
    &lt;/xs:schema&gt;
  &lt;/wsdl:types&gt;
  &lt;wsdl:message name="authenticate"&gt;
    &lt;wsdl:part element="tns:authenticate" name="parameters"&gt;
    &lt;/wsdl:part&gt;
  &lt;/wsdl:message&gt;
  &lt;wsdl:message name="authenticateResponse"&gt;
    &lt;wsdl:part element="tns:authenticateResponse" name="parameters"&gt;
    &lt;/wsdl:part&gt;
  &lt;/wsdl:message&gt;
  &lt;wsdl:portType name="ISlsSoapWebService"&gt;
    &lt;wsdl:operation name="authenticate"&gt;
      &lt;wsdl:input message="tns:authenticate" name="authenticate"&gt;
    &lt;/wsdl:input&gt;
      &lt;wsdl:output message="tns:authenticateResponse" name="authenticateResponse"&gt;
    &lt;/wsdl:output&gt;
    &lt;/wsdl:operation&gt;
  &lt;/wsdl:portType&gt;
  &lt;wsdl:binding name="ISlsSoapWebServiceServiceSoapBinding" type="tns:ISlsSoapWebService"&gt;
    &lt;soap:binding style="document" transport="http://schemas.xmlsoap.org/soap/http"/&gt;
    &lt;wsdl:operation name="authenticate"&gt;
      &lt;soap:operation soapAction="" style="document"/&gt;
      &lt;wsdl:input name="authenticate"&gt;
        &lt;soap:body use="literal"/&gt;
      &lt;/wsdl:input&gt;
      &lt;wsdl:output name="authenticateResponse"&gt;
        &lt;soap:body use="literal"/&gt;
      &lt;/wsdl:output&gt;
    &lt;/wsdl:operation&gt;
  &lt;/wsdl:binding&gt;
  &lt;wsdl:service name="ISlsSoapWebServiceService"&gt;
    &lt;wsdl:port binding="tns:ISlsSoapWebServiceServiceSoapBinding" name="ISlsSoapWebServicePort"&gt;
      &lt;soap:address location="https://my.acme.com:8080//sls/soap-frontend"/&gt;
    &lt;/wsdl:port&gt;
  &lt;/wsdl:service&gt;
&lt;/wsdl:definitions&gt;</pre></div></div></div><div class="part"><div class="titlepage"><div><div><h1 class="title"><a id="x17734_Heading1Tarsec_Usage_scenarios"></a>Part VI. Usage Scenarios</h1></div></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="_use_case_examples"></a>Chapter 65. Use Case Examples</h2></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_overview_12"></a>65.1. Overview</h2></div></div></div><p>This chapter describes several use-case scenarios for the SLS. The implementation of these scenarios requires various configuration settings that are described in more detail in separate chapters referenced by these paragraphs here.</p><p>The most important things to keep in mind are:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
The model defines what the SLS will do, based on the URL / parameters / session state of the initial request. For an authentication, a login model is needed, for a password change operation, a password change model is needed etc.
</li><li class="listitem">
The "<code class="literal">adapter.xyz</code>"-properties in the "<code class="literal">sls.properties</code>" file define what type of adapter (LDAP, RADIUS, NTLM…) is used for what kind of operation (authentication, mapping, password change…). The actual configuration for that adapter is then found in the corresponding adapter configuration file, such as "<code class="literal">ldap-adapter.properties</code>".
</li></ul></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_adapter_types"></a>65.1.1. Adapter Types</h3></div></div></div><p>Valid adapter types that can be used for the "<code class="literal"><span class="emphasis"><em>&lt;type&gt;</em></span></code>"-part of the following example configuration properties are:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">file</code> - XML-file based login; supports authentication, authorization and mapping. This adapter is always included in the SLS and is used mostly for test purposes.
</li><li class="listitem">
<code class="literal">ldap</code> - LDAP directory access; supports authentication and mapping.
</li><li class="listitem">
<code class="literal">radius</code> - RADIUS server access; supports authentication only.
</li><li class="listitem">
<code class="literal">ntlm</code> - transparent NTLM-based login in Windows environments; supports authentication only.
</li><li class="listitem">
<code class="literal">securid</code> - RSA ACE-server based SecurID authentication; supports authentication and password (PIN) change.
</li><li class="listitem">
<code class="literal">spnego</code> - transparent Kerberos-based login, usually in Windows environments; supports authentication only.
</li><li class="listitem">
<code class="literal">pki</code> - X.509-certificate based login; supports authentication and mapping.
</li></ul></div><p>Note that processes like user ID mapping, password change etc. can often be implemented by combining different types of adapters. A typical example would be using the NTLM adapter for the authentication against a Microsoft Active Directory Server, and the LDAP adapter for implementing the password change or user ID mapping functionality.</p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_authentication_7"></a>65.2. Authentication</h2></div></div></div><p>The basic job of the Login Service is certainly the login functionality. This allows users to be granted a      ccess to a restricted area. There are two predefined access areas: "<code class="literal">Member</code>" and "<code class="literal">Customer</code>":</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">Member</code>: Named after typical self-registration areas of public websites, where users are authenticated only through username and password (weak authentication).
</li><li class="listitem">
<code class="literal">Customer</code>: Means a closed / internal area, where users need to perform a strong authentication, such as using a hardware token, a digital certificate or a strike list.
</li></ul></div><p>More fine-granular access restrictions can be implemented using the authorization feature of the HSP and SLS (see <a class="link" href="#x12938_Heading3Tarsec_Authorization_Function" title="65.3.2. Authorization Function Options">"Authorization Function Options"</a>).</p><p>The access area that the SLS grants access for after a successful login  must be specified with the property <code class="literal">hsp.access.area</code>. The value of this property should match the value of the location in the HSP configuration. It is also possible to set an access area value in the current SLS session through the invocation of a JEXL function from within the login model.</p><p>Users may login by accessing the URI /auth. This is the default login location to be used.</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_configure_authentication"></a>65.2.1. Configure authentication</h3></div></div></div><p>This property in the file "<code class="literal">sls.properties</code>" defines which type of adapter to use for the authentication:</p><pre class="programlisting">adapter.authentication=&lt;type&gt;</pre><p>Model extract:</p><pre class="programlisting">model.login.state.2.name=do.auth</pre><p>The "<code class="literal">do.auth</code>"-state is mapped to a Java action which invokes the adapter defined by the property "<code class="literal">adapter.authenticate</code>" to perform the actual authentication call-out.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_finding_out_authentication_state"></a>65.2.2. Finding out authentication state</h3></div></div></div><p>If a user has already performed an authentication on an SLS instance and accesses that SLS for any reason, the SLS will receive the name of the authenticated user through a special, encrypted cookie that is stored only in the SES session store (the cookie never reaches the client).</p><p>The SLS creates a credential of the semantic type "<code class="literal">username</code>" (see <a class="link" href="#x38692_Heading1Tarsec_Credential_Providers" title="Chapter 8. Credential Providers">"Credential Providers"</a> for details about credential handling) in its session, based on this cookie. Since the cookie was created by the SLS itself and is encrypted, it is trusted, so the "<code class="literal">username</code>" credential is marked internally as already having been verified.</p><p>This can then be used through these two JEXL functions:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">session.isVerifiedCred(<span class="emphasis"><em>username</em></span>)</code> - Returns "<code class="literal">true</code>" if the "<code class="literal">username</code>" credential exists and has been verified; meaning, the user is already authenticated.
</li><li class="listitem">
<code class="literal">session.getVerifiedCred(<span class="emphasis"><em>username</em></span>)</code> - Returns the actual username value, but only if it already has been verified.
</li></ul></div><p>Note: The existence of this verified credential really only indicates that the current user already had been authenticated in <span class="emphasis"><em>some</em></span> way - it does not give any indication of the level of authentication that had been used (weak or strong).</p><p>See <a class="link" href="#x67466_Heading3Tarsec_Handling_Missing_Authorizations" title="65.3.1. Handling Missing Authorizations">"Handling Missing Authorizations"</a> to find out how to check if a user requires a missing authorization, which could be the case for a user who had performed weak authentication first and then is redirected to the SLS later.</p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_authorization"></a>65.3. Authorization</h2></div></div></div><p>"Authorization" by itself is a term with a very broad scope, and there are many ways how authorization can be implemented using the SLS and the HSP. The recommended way is to use the "<code class="literal">Require_AZ</code>" directive in the HSP location to define what authorization is needed to access the location, for example:</p><pre class="screen">&lt;Location /apps/adminweb&gt;
AC_AccessArea        Member
AC_AuthorizedPath    /apps
AC_LoginPage         /apps/sls/auth
AC_RequireAz         admin
&lt;/Location&gt;</pre><p>Now, once the SLS completes an authentication, it must not only grant access to a certain access area, but it must also send the required authorization information to the HSP. Otherwise, the user will be denied access, even though the authentication may have been successful.</p><p>The SLS now allows to send authorization information to the HSP based on either specific authorization functionality of the adapter, or by using any kind of user data to create that authorization information for the HSP dynamically.</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="x67466_Heading3Tarsec_Handling_Missing_Authorizations"></a>65.3.1. Handling Missing Authorizations</h3></div></div></div><p>When the HSP redirects a client to the SLS due to some missing authorization, it also sends information about those authorizations to the SLS through some custom HTTP headers. It is then possible to either trigger a specific model for the SLS session based on the missing authorization, or to handle it within a model through JEXL expressions.</p><p>For information on how to define a trigger for a certain model based on a missing, required authorization, see <a class="link" href="#x86589_Heading4Tarsec_Missing_Authorization" title="7.7.5. Missing Authorization">"Missing Authorization"</a>.</p><p>Within JEXL expressions in the model (conditions or actions) and / or JSPs, the following functions can be used to deal with information about missing, required authorizations:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">session.getMissingAuthorizationValues()</code> - Returns a list of all authorizations the user lacks, but requires to access the requested URL.
</li><li class="listitem">
<code class="literal">session.requiresAuthorization()</code> - Checks if the user has to authenticate because of any missing authorization
</li><li class="listitem">
<code class="literal">session.requiresAuthorization(String auth)</code> - Checks if the user has to authenticate because of a specific missing authorization
</li></ul></div><p>Please read the JEXL guide for detailled information on how to use these functions.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="x12938_Heading3Tarsec_Authorization_Function"></a>65.3.2. Authorization Function Options</h3></div></div></div><p>Some adapters, like the file adapter, implement support for the HSP authorization feature. This means that they allow to perform a special authorization function (in case of the file adapter through a custom look-up in the XML file) and then create the corresponding information for the HSP automatically.</p><p>As of now, however, most adapters don't provide a specific authorization function, since most used protocols are designed to be used for authentication only.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_option_1_configure_adapter_authorization_function"></a>65.3.3. Option 1: Configure adapter authorization function</h3></div></div></div><p>In order to use this approach, the model must contain an authorization step, and the type of the autorization adapter must be defined similar to the authentication adapter. This property in the file "<code class="literal">sls.properties</code>" defines which type of adapter to use for the authorization:</p><pre class="programlisting">adapter.authorization=&lt;type&gt;</pre><p>Model extract:</p><pre class="programlisting">model.login.state.2.name=do.auth
model.login.state.3.name=do.authorization</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_option_2_use_model_actions"></a>65.3.4. Option 2: Use Model Actions</h3></div></div></div><p>It is also possible to set authorizations through JEXL functions in model state actions (see <a class="link" href="#x47278_Heading3Tarsec_Custom_Actions" title="7.6.1. Custom Actions">"Custom Actions"</a> for details on using JEXL actions in models). This example sets the authorization "admin" just before the final "do.success" state is reached, but only for users whose LDAP-Attribute "isAdmin" contains the value "true":</p><pre class="programlisting">model.login.state.9.name=do.generic
model.login.state.9.action.1=${response.setAuthorization(\'admin\')}
model.login.state.9.action.1.if=${attribute.ldap.isAdmin eq \'true\'}
model.login.state.10.name=do.success</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_option_3_configure_custom_authorization"></a>65.3.5. Option 3: Configure custom authorization</h3></div></div></div><p>If the adapter does not implement a specific authorization functionality, the required authorization information for the HSP can be generated by setting some SES session attribute properties; these properties are evaluated and processed by the SLS after a successful login.</p><p>An example of a group of four properties that together define one SES session attribute that will notify the HSP that the user has the authorization "<code class="literal">admin</code>" would be:</p><pre class="screen">session-attribute.name.1=admin
session-attribute.path.1=/web/admins
session-attribute.type.1=ac-app-az
session-attribute.value.1=allow</pre><p>In a real-world configuration, the value of the "path" property (which corresponds to the "authorized path" as defined in the HSP location) should preferably not be hard-coded. Instead, a JEXL variable should be used which automatically inserts the authorized path as received from the HSP.</p><pre class="screen">session-attribute.name.1=admin
session-attribute.path.1=${special.authorized.path}
session-attribute.type.1=ac-app-az
session-attribute.value.1=allow</pre><p>The "<code class="literal">type</code>"-property must always be set to "<code class="literal">ac-app-az</code>" and the "<code class="literal">value</code>"-property to "<code class="literal">allow</code>".</p><p>The following example also replaces the hard-coded authorization string with a value received in the LDAP user attribute "<code class="literal">userAuth</code>" during the authentication LDAP lookup:</p><pre class="screen">session-attribute.name.1=${attribute.ldap.userAuth)
session-attribute.path.1=${special.authorized.path}
session-attribute.type.1=ac-app-az
session-attribute.value.1=allow</pre></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_combining_weak_and_strong_authentication"></a>65.4. Combining Weak and Strong Authentication</h2></div></div></div><p>Using more than one model in the SLS configuration, it is possible to implement support for weak and strong authentication in one login service instance. The following example fullfils these requirements, showing both the required SES (SRM) and SLS configuration parts:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
Have two main URI locations: "<code class="literal">/</code>" for all applications in general, which defaults to weak authentication, and "<code class="literal">/strong/</code>" for all applications that require strong authentication.
</li><li class="listitem">
The requirement for strong authentication for the "<code class="literal">/strong</code>" URI is enforced by the SES through an authorization named "<code class="literal">strong</code>"
</li><li class="listitem">
Implement weak authentication through LDAP authentication (checks username and password through the bind).
</li><li class="listitem">
If the user accesses any of the applications that do not require strong authentication, the model for weak authentication will be used as a default.
</li><li class="listitem">
If the user accesses an application that requires strong authentication, the model for strong authentication will be triggered due to the missing required authorization.
</li><li class="listitem">
Implement strong authentication through an SMS authentication, where the HTTP adapter is used to trigger the SMS creation through some external SMS provider interface.
</li><li class="listitem">
In the strong authentication model, the first step is the LDAP password check, then the SMS challenge is created based on the username. In the next step, the user has to enter the SMS response code.
</li><li class="listitem">
In the strong authentication model, the first part (LDAP password check) shall be omitted if the user had already performed weak authentication before.
</li></ul></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_ses_srm_location_configuration"></a>65.4.1. SES (SRM) Location Configuration</h3></div></div></div><p>In the SRM configuration, the default root location would be set to use weak authentication, while all applications below the "<code class="literal">/strong"</code> URI path would require the "<code class="literal">strong</code>" authorization.</p><pre class="screen">&lt;Location /&gt;
...
AC_AccessArea Member
AC_StartPage  /sls
AC_LoginPage  /sls
AC_AuthorizedPath /
...
&lt;/Location&gt;

&lt;Location /strong&gt;
# Applications must have "strong" authorization.
# This maps to the "missingAuthorization" trigger
# in the SLS "strong" authentication model example.
AC_RequireAz  strong
&lt;/Location&gt;</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_sls_adapters_configuration"></a>65.4.2. SLS Adapters Configuration</h3></div></div></div><p><span class="emphasis"><em>Note that this example intentionally does not show any details of the LDAP or HTTP adapter configuration, since they are not relevant for the purposes of this example.</em></span></p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_sls_weak_authentication_model"></a>65.4.3. SLS Weak Authentication Model</h3></div></div></div><p>Being mapped to the default action URI "<code class="literal">/auth</code>", this model is used by the SLS as a default.</p><pre class="programlisting"># Default login model for weak authentication
model.weak.uri=/auth
model.weak.failedState=get.cred
# State 10: Show login page
model.weak.state.10.name=get.cred
# State 20: Perform LDAP authentication
model.weak.state.20.name=do.auth
# State 90: success
model.weak.state.90.name=do.success</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_sls_strong_authentication_model"></a>65.4.4. SLS Strong Authentication Model</h3></div></div></div><p>This login model uses two steps. In the first one, it shows the page for entering username and password, which are then checked using LDAP authentication. Then, the challenge is created and sent to the user by SMS, using the HTTP adapter.</p><p>However, the first step (username and password page and check) shall be omitted, if the user had already performend weak authentication before.</p><p>This login model is triggered by the absence of the required "<code class="literal">strong</code>" authorization (as defined by the "<code class="literal">AC_RequireAz</code>" directive in the SRM configuration - see above).</p><pre class="programlisting"># Login model for strong authentication
model.strong.missingAuthorization=strong
model.strong.failedState=get.cred
# State 5: Jump to challenge creation if user is authenticated
model.strong.state.5.name=do.generic
model.strong.state.5.nextState.1=create.challenge
model.strong.state.5.nextState.1.if=${session.hasVerifiedCred(\'username\')}
# State 10: Show login page
model.strong.state.10.name=get.cred
# State 20: Perform LDAP authentication
model.strong.state.20.name=do.auth
# Create challenge
model.strong.state.30.name=create.challenge
# Send SMS using the HTTP adapter
model.strong.state.40.name=do.http
# Show page with input field for response code
model.strong.state.50.name=get.cred.challenge
# Check SMS code
model.strong.state.60.name=do.authresponse
# State 80: set "strong" authorization
model.strong.state.80.action.1=${response.setAuthorization(\'strong\', \'/\')}
# State 90: success
model.strong.state.90.name=do.success</pre></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_logout"></a>65.5. Logout</h2></div></div></div><p>Another use case is to provide a logout functionality which makes sure that the users\' HSP session is immediately invalidated and cannot be used anymore.</p><p>Applications can then use this action from a "logout"-link in the application, without needing any knowledge about how to signal a session invalidation to the HSP reverse proxy; the SLS takes care of that.</p><p>The logout function is available through the "/logout" URI. It will set the required HTTP headers to instruct the HSP to terminate the session, and will redirect the user to a defined page (such as a portal start page). The target of that redirect can also be overridden by supplying the <code class="literal">target</code> parameter with the specified URI location.</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_application_sessions"></a>65.5.1. Application sessions</h3></div></div></div><p>Please note that if a logout is performed directly and only through the SLS, the user is effectively logged out immediately <span class="emphasis"><em>only from the reverse proxy</em></span>, denying any further access to the applications. However, the application sessions will remain alive until they expire due to the users\' inactivity, which often takes up to 30 minutes. During this time, the open sessions still consume resources on the application servers. For this reason, the better and recommended approach for an application is to provide a logout function which terminates the application session first and redirects the user to the SLS logout location afterwards.</p></div></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="_sorbay_risk_integration"></a>Chapter 66. sorbay_risk Integration</h2></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_introduction_27"></a>66.1. Introduction</h2></div></div></div><p>This chapter describes how to integrate the sorbay_risk service specifically in the SLS.
The service calculates a risk score based on various pieces of information gathered directly from the client (browser) like IP (plus country etc. via geolocation), User-Agent header, and a round-trip time (rtt) measured via WebSocket.</p><p>It is assumed here that readers are familiar with the documentation of the service including its general integration with login services as described at <a class="ulink" href="https://doc.sorbay.com" target="_top">doc.sorbay.com</a>.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_prerequisites"></a>66.2. Prerequisites</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p class="simpara">
Setup of CORS settings and API-Key in the sorbay_risk GUI.
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem">
Important detail: When you configure individual origins in the sorbay_risk GUI, make sure <span class="strong"><strong>not</strong></span> to include a trailing slash, e.g. configure <code class="literal">https://mylogin.org</code> (not <code class="literal">https://mylogin.org/</code>) or <code class="literal">https://mylogin.org:8443</code> (not <code class="literal">https://mylogin.org:8443/</code>).
</li></ul></div></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_login_jsp"></a>66.3. Login JSP</h2></div></div></div><p>In the login JSP include a hidden form field for the token (to be posted along with userid and login credentials):</p><pre class="screen">&lt;!-- sorbay risk service integration --&gt;
&lt;input type="hidden" id="token" name="token" value=""&gt;</pre><p>And include the client-side JavaScript, ideally near the end of the body, at least after the hidden field for the token:</p><pre class="screen">&lt;!-- sorbay risk service integration --&gt;
&lt;sls:getScript expression="#{Risk.clientJavaScript()}" /&gt;</pre><p>(A more sophisticated integration would prevent posting the login form before the token calculation completed with a little bit of extra JavaScript. Getting and running the script could exceptionally take a few seconds, while normally it takes less than a second.)</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_login_model_4"></a>66.4. Login Model</h2></div></div></div><p>Here is a minimal login model, without the logic related to the risk score and eventual 2nd factor or sending notifications of the login (see comment in model below):</p><pre class="programlisting">model.login.uri=/auth
model.login.failedState=get.cred

model.login.state.500.name=do.generic-skipped-if-post

# login ("first factor")
model.login.state.1000.name=get.cred
model.login.state.2000.name=do.auth
model.login.state.2000.action.1=#{token = var('parameter.token')}
model.login.state.2000.action.2=#{function.logAudit("token: " + token)}

# send token and userid (from do.auth post)
# to risk service in order to get the risk score
model.login.state.3000.name=do.http
model.login.state.3000.param.alias=risk
model.login.state.3000.action.1=#{risk = Risk.riskFromResponse(var('response.content'))}
model.login.state.3000.action.2=#{function.logAudit("risk: " + risk)}

# **********************************************************************
# Add your logic based on the risk score here, e.g.
# - skip 2nd factor in case of low risk score (typically lower than 0.3)
# - send notification/challenge email to the user on high risk score
# **********************************************************************

# if login was successful, notify the risk server
model.login.state.4000.name=do.http
model.login.state.4000.param.alias=loginok

model.login.state.9000.name=do.success</pre><p>Note that generally the login flow should treat any errors/exceptions when trying to obtain the risk score like a maximal risk score (10.0), for obious security reasons.</p><p>In many error cases on the client-side, the JavaScript sets the token field to an error message instead of to an enciphered token. This error message can usually be posted to the sorbay_risk service, resulting in an error response to the SLS and logging the error on the sorbay_risk service, which may help for later analysis.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_sls_properties_6"></a>66.5. SLS Properties</h2></div></div></div><p>These properties define the base URL for calling the sorbay_risk service, the API-Key for authentication and an HMAC secret used to hide the real userid (set actual service URL and secret values according to your setup):</p><pre class="programlisting"># The base URL of the Risk Service (mandatory)
risk.baseUrl=https://df0675b7-02aa-421b-9ea8-b747e58a71f3.cloud.dev.sorbay.com

# The API-Key for authentication of callouts to the risk service (mandatory)
risk.apikey=your-api-key-typically-protect-with-sls-dataprotector

# The secret for the HMAC that is used to get an opaque userid to send to the risk service (mandatory)
risk.useridHmacSecret=your-hmac-secret-typically-protect-with-sls-dataprotector</pre><p>These properties define the HTTP Adapter callouts to the risk service:</p><pre class="programlisting"># set timeout as desired
http.connection.timeout=30

# calculate risk score
http.risk.url=#{Risk.riskUrl()}
http.risk.method=post
http.risk.code.error=400,401,403,500,501,503
http.risk.response.ok=#{Risk.riskResponseOkRegex()}
http.risk.action.1=#{function.logAudit("risk response.code: " + var('response.code'))}
http.risk.action.2=#{function.logAudit("risk response.content: " + var('response.content'))}
http.risk.body.userid=#{Risk.getOpaqueUserid(session.getCred('username'))}
http.risk.body.token=#{token}
http.risk.header.x-api-key=#{Risk.apiKey()}

# notify risk service of successful login = stores user data
http.loginok.url=#{Risk.loginokUrl()}
http.loginok.method=post
http.loginok.code.error=400,401,403,500,501,503
http.loginok.action.1=#{function.logAudit("loginok response.code: " + var('response.code'))}
http.loginok.action.2=#{function.logAudit("loginok response.content: " + var('response.content'))}
http.loginok.body.userid=#{Risk.getOpaqueUserid(session.getCred('username'))}
http.loginok.body.token=#{token}
http.loginok.header.x-api-key=#{Risk.apiKey()}</pre></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_groovy_script"></a>66.6. Groovy Script</h2></div></div></div><p>The following Groovy script encapsulates a lot of "boilerplate" to make the actual individual configuration as slim and independent of local settings as possible.</p><pre class="screen">// Helper class for integrating the Sorbay Risk Service with the USP SLS.

class Risk {

  /**
   * Gets the baseUrl for risk service calls as to use in Javascript on the client side.
   * Source is the "risk.baseUrl" property.
   */
  static String baseUrl() {
    function.getConfigProperty('risk.baseUrl')
  }

  /** URL for risk callout. */
  static String riskUrl() {
    baseUrl() + "/rest/risk"
  }

  /** URL for loginok callout. */
  static String loginokUrl() {
    baseUrl() + "/rest/loginok"
  }

  /** Get opaque userid for risk service, here using HMAC SHA256. */
  static String getOpaqueUserid(String userid) {
    return crypto.hmacSHA256(function.getConfigProperty('risk.useridHmacSecret'), userid)
  }

  /** Regex for ok response of risk callout. */
  static String riskResponseOkRegex() {
    /^.*"risk":"[\d\.]+".*$/
  }

  /** The API-Key for authentication of callouts. */
  static String apiKey() {
    function.getConfigProperty('risk.apikey')
  }

  /**
   * Gets the risk score from the JSON response of the /risk rest call.
   */
  static double riskFromResponse(String riskResponse) {
    Double.parseDouble(function.parseJson(riskResponse).risk)
  }

  /**
   * Gets the client JavaScript (with baseUrl set).
   */
  static String clientJavaScript() {
    """\
&lt;script&gt;
  function sorbaySetTokenInForm(token) {
    console.log('SLS: setting token in form to: ' + token);
    document.getElementById('token').value = token;
  }
  function sorbayGetSetToken() {
    const baseUrl = "${baseUrl()}";
    import(baseUrl + '/resources/sorbay-risk.min.js')
      .catch(e =&gt; { throw new Error('client-error: import ' + baseUrl + '/resources/sorbay-risk.min.js failed: ' + e); })
      .then(js =&gt; js.sorbayGetToken(baseUrl, sorbaySetTokenInForm))
      .catch(e =&gt; e.message.startsWith('client-error: ') ? e.message : 'client-error: sorbayGetToken() failed: ' + e);
  }
  sorbayGetSetToken();
&lt;/script&gt;"""
  }

}</pre></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="_yubikey_support"></a>Chapter 67. Yubikey Support</h2></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_introduction_28"></a>67.1. Introduction</h2></div></div></div><p>A "Yubikey" is an affordable USB OTP Token for strong authentication. For details about the product, consult the manufacturer homepage:</p><p><code class="literal"><a class="ulink" href="http://www.yubico.com" target="_top">http://www.yubico.com</a></code></p><p>The unique feature of this token is, that it works as a USB keyboard. When the user presses the single button on the token while it is inserted in the USB port, it will send a number of key presses, typing in the one-time passcode for the user. The code itself is calculated based on a secret known by the manufacturer of the token.</p><p><span class="strong"><strong>Yubico Cloud Service</strong></span></p><p>Yubico provides a freely available, public verification service for all tokens manufactured by them. <span class="emphasis"><em>NOTE: This service only verifies that the one-time passcode generated by a certain token is correct for that specific token and time; it does NOT, however, verify in any way that the token belongs to a specific user.</em></span></p><p>In other words, it is the SLS's duty to map the token to a user. This mapping should usually be made persistent with a data source like an LDAP directory, where the ID of the user's Yubikey token could be stored in an  attribute of the user object.</p><p><span class="strong"><strong>Token ID</strong></span></p><p>When the code is generated by the token, it always also contains the ID (similar to  a serial number) of the token itself. This ID is contained in the first 12 characters of the OTP string sent by the token. So, within the SLS, it makes sense to extract that ID from the one-time passcode first and use it to look up  the user data in a data source like an LDAP directory.</p><p>For details, please consult the "<span class="emphasis"><em>Yubikey Manual</em></span>" available for download as PDF on the Yubico homepage.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_implementation"></a>67.2. Implementation</h2></div></div></div><p>To verify a Yubikey one-time passcode, the SLS HTTP adapter can be used, with the publicly available Yubico verification service.</p><p>The HTTP adapter should be configured to be used as an authentication adapter, but most likely a secondary one. Usually, a username and password need to be verified as well, for which one of the traditional adapters like LDAP or RADIUS will be used.</p><p>Then, after verifying username and password, the ID of the token must be extracted from the OTP code, and the SLS must somehow make sure that this token is the one that actually belongs to the user. One way to do this would be to use the token ID as a filter value in an LDAP search, where a user is searched whose attribute "XYZ" must contain that token ID. If the search returns no result, it means no user has that particular token, and the authentication should fail right there.</p><p>If a user was found, an LDAP bind could be performed with the DN of that user to verify the username and password, and then after that the HTTP authentication against the Yubico cloud service would verify the OTP.</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_http_adapter_configuration"></a>67.2.1. HTTP Adapter Configuration</h3></div></div></div><p>The configuration for the HTTP adapter (in the SLS configuration file "http-adapter.properties") would look like this:</p><pre class="programlisting"># NOTE: Insert your own valid API Key ID for the "id" parameter !!
http.auth.url=https://api.yubico.com/wsapi/2.0/verify?id=5695\&amp; +
 otp=${session.getCred('secret')}&amp; +
 nonce=${function.random().substring(1).concat(function.random().substring(1))}&amp; +
 sl=50\&amp;timeout=20\&amp;timestamp=1

# Handle the OTP as credential of type \'secret\'
http.auth.credentials=secret

# non-200 HTTP responses are tech errors
http.auth.code.error=500,503

# Everything other than this in the response body signals an error
# (see validation protocol specification for details)
http.auth.response.ok=status=OK

# Must always be a GET request
http.auth.method=GET</pre><div class="note" style="margin-left: 0; margin-right: 10%;"><h3 class="title">Note</h3><p>The various parameters in the Yubikey service URL may be fine-tuned to suit the needs of a specific use-case. Please consult the Yubico verification protocol specification for details.</p></div><p><span class="strong"><strong>Yubico API Key ID</strong></span></p><p>For the "<code class="literal">id</code>" parameter in the URL, insert your own valid API key ID (request a Yubikey API ID:</p><p><a class="ulink" href="https://upgrade.yubico.com/getapikey/" target="_top">https://upgrade.yubico.com/getapikey/</a></p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_login_model_5"></a>67.2.2. Login Model</h3></div></div></div><p>An example configuration in "<code class="literal">sls.properties</code>" will then look something like this:</p><pre class="programlisting"># Use LDAP adapter to verify "username" and "password" credentials.
# NOTE: This does NOT verify the "secret" credential; that must
# be done 'by hand' in the model (see below).
adapter.authentication=ldap

# Verify the Yubikey OTP with the HTTP adapter
adapter.authentication2=http


#### login model configuration ####
model.login.uri=/auth
model.login.failedState=get.cred.token

# Get username, password and OTP code
model.login.state.10.name=get.cred.token

# Extract Token ID from OTP code by extracting
# the first 12 characters (see Yubico manual for details)
model.login.state.20.name=do.generic
model.login.state.20.action.1=${function.setVariable('tokenid', +
    session.getCred('secret').substring(0, 12))}

# Perform LDAP authentication, preferably with some
# filter that uses the JEXL variable "tokenid" to
# find the user DN.
model.login.state.30.name=do.auth

# Perform authentication with the HTTP adapter
model.login.state.25.name=do.auth2
model.login.state.25.nextState=do.success
model.login.state.25.failedState=do.generic-failure

# If the token verification failed, reset the username
# and password credentials too before starting again
model.login.state.40.name=do.generic-failure
model.login.state.40.action.1=${session.clearCredentials()}
model.login.state.40.nextState=get.cred.token

# Login completed!
model.login.state.90.name=do.success</pre><p>Note that this is an incomplete example, since the specifics of the first authentication step (verifying username and password, and implementing a mapping of the token ID to a username) depend on the use-case.</p></div></div></div></div><div class="part"><div class="titlepage"><div><div><h1 class="title"><a id="_appendix"></a>Part VII. Appendix</h1></div></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="HSP_timeouts_appendix"></a>Chapter 68. HSP Timeouts</h2></div></div></div><p>The WAF (HSP) supports several different times of timeouts that have an impact
on the session of the user. 3 of them can be set dynamically by the SLS either
through static configuration properties (see
<a class="link" href="#x66021_Heading1Tarsec_SES_Session_Attributes" title="Chapter 34. SES Session Attributes">"SES Session Attributes"</a>, usage
type "<code class="literal">ac-cred-tmo</code>") or JEXL functions (see "SLS JEXL Guide" /
<code class="literal">function.setWafSessionTimeout()</code>).</p><p>Each of these timeouts will enforce a re-authentication of the user’s session
once it is triggered. Usually, the user session will still be active after the
re-authentication, except in cases where it was inactive for too long, and has
already been removed from the HSP session store.</p><p><span class="emphasis"><em>NOTE: Setting HSP timeouts dynamically in the SLS requires at least HSP
version 4.18.0.0 or newer!</em></span></p><p>This chapter lists the SRM configuration directives used to configure the
timeout settings in the WAF (for details about these directives, please look
them up in the "HTTP Secure Proxy Administration Guide").</p><p><span class="strong"><strong><code class="literal">AC_HspCredentialValidityPeriod</code></strong></span></p><p><span class="emphasis"><em>JEXL type parameter</em></span>: <span class="emphasis"><em><code class="literal">validity</code></em></span></p><p><span class="emphasis"><em>Triggered by</em></span>: The user being inactive for as long as configured by this
statement (so, basically an idle / inactivity timeout).</p><p><span class="emphasis"><em>Typical value</em></span>: This timeout will usually be set to a rather short value of a
few minutes (5 - 15).</p><p><span class="strong"><strong><code class="literal">AC_HspCredentialUpdateTrigger</code></strong></span></p><p><span class="emphasis"><em>JEXL type parameter</em></span>: <span class="emphasis"><em><code class="literal">updateTrigger</code></em></span></p><p><span class="emphasis"><em>Triggered by</em></span>: This timeout is directly connected to the <span class="emphasis"><em><code class="literal">validity</code></em></span>
timeout and exists only for performance reasons. Basically, whenever a new
request is processed, the HSP would need to update the timestamp in the session
which marks the time from which the time will be measured to decide if the
inactivity timeout has been reached. But updating a session value impedes
performance because it requires to hold a lock on the session store for the
short time of this operation; in high-load environments, this could have a
serious performance impact. For this reason, the <span class="emphasis"><em><code class="literal">update</code></em></span> trigger specifies
basically a shifting window within the inactivity timeout period; whenever
the current time is beyond the timestamp of the <span class="emphasis"><em><code class="literal">validity</code></em></span> timestamp
plus the range specified by <span class="emphasis"><em><code class="literal">updateTrigger</code></em></span>, the HSP will actually update
the timestamp (hence the name).</p><p><span class="emphasis"><em>Typical value</em></span>: Must always be smaller than the value defined by <span class="emphasis"><em><code class="literal">updateTrigger</code></em></span>,
usually about a third of it.</p><p><span class="strong"><strong><code class="literal">AC_HspCredentialFinalTimeout</code></strong></span></p><p><span class="emphasis"><em>JEXL type parameter</em></span>: <span class="emphasis"><em><code class="literal">final</code></em></span></p><p><span class="emphasis"><em>Triggered by</em></span>: Once the given timeout value has been reached (starting with the
initial login), no matter if there was activity in the session or not.</p><p><span class="emphasis"><em>Typical value</em></span>:  This timeout usually set to something like 1, 4 or maybe even
8 hours. Setting it too short would, depending on the authentication requirements,
potentially make work really annoying for the users.</p></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="_migration_guide"></a>Chapter 69. Migration Guide</h2></div></div></div><p>This migration guide will list the deprecated properties and their new values.</p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_mandator_8594_tenant"></a>69.1. Mandator -→ Tenant</h2></div></div></div><p>The new tenant values have been introduced in SLS 4.6.0</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p class="simpara">
config properties
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem">
multimandator.enabled -→ multitenancy.enabled
</li><li class="listitem">
mandator. -→ tenant.
</li><li class="listitem">
multimandator.resolving. -→ multitenancy.resolving
</li></ul></div></li><li class="listitem"><p class="simpara">
jexl variable
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem">
current.mandator -→ current.tenant
</li></ul></div></li><li class="listitem"><p class="simpara">
browser blacklist properties
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem">
.mand -→ .tenant
</li></ul></div></li><li class="listitem"><p class="simpara">
jexl functions
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem">
session.getMandatorSpecific -→ session.getTenantSpecific
</li><li class="listitem">
session.getMandator -→ session.getTenant
</li></ul></div></li><li class="listitem"><p class="simpara">
log4j custom variables
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem">
mand -→ tenant
</li></ul></div></li><li class="listitem"><p class="simpara">
error messages
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem">
MANDATOR_SWITCHING -→ TENANT_SWITCHING
</li><li class="listitem">
MANDATOR_FOUND -→ TENANT_FOUND
</li><li class="listitem">
MANDATOR_NOT_FOUND -→ TENANT_NOT_FOUND
</li></ul></div></li><li class="listitem"><p class="simpara">
url parameters
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem">
mand -→ tenant
</li></ul></div></li><li class="listitem"><p class="simpara">
parameter checking properties
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem">
parameter.http.&lt;id&gt;.mand -→ parameter.http.&lt;id&gt;.tenant
</li></ul></div></li></ul></div></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="_faq"></a>Chapter 70. FAQ</h2></div></div></div><p>This FAQ ("Frequently Asked Questions") addresses some of the most frequent questions and problems around the . It is grouped in two areas, usage questions and troubleshooting.</p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_usage_4"></a>70.1. Usage</h2></div></div></div><p><span class="emphasis"><em>Q: I want my application to receive the user's login ID after a successful login, in a custom HTTP request header. How can I configure that?</em></span></p><p>A: The simple way is to use the "app.header" configuration property, as explained in <a class="link" href="#x11777_Heading3Tarsec_Propagating_HTTP_Headers" title="23.2.2. Propagating Custom HTTP Headers">"Propagating Custom HTTP Headers"</a>. Use the name of the header which the application expects (for example: "userid") in the name-part of the property, and the variable (see <a class="link" href="#x49003_Heading1Tarsec_Expressions" title="Chapter 32. JEXL Expressions">"JEXL Expressions"</a> for details about variables)  which holds the value of the request parameter with the login ID in the value part of the property:</p><pre class="programlisting">app.header.userid = ${parameter.id}</pre></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_troubleshooting_2"></a>70.2. Troubleshooting</h2></div></div></div><p><span class="emphasis"><em>Q: Strange "NoSuchMethodError" or similar messages appear in the log after deploying a new SLS release. Why?</em></span></p><p>A: It is most likely that due to a Tomcat bug, not all the old SLS code (jar files) in Tomcats temporary directory have been replaced by the new SLS jar files. See the next question for an answer to this problem.</p><p><span class="emphasis"><em>Q: New code / JSPs have been deployed, but somehow it seems that old classes are still active, or methods that have been removed are still referenced. Why?</em></span></p><p>A: Tomcat sometimes appears to have problems with its caching directory, mixing up newly deployed JSPs or code with older versions. In such situations, delete the caching directory entirely (the "work" subdirectory of the Tomcat installation) and restart Tomcat. The directory will just be created automatically again (make sure that the user which is used to run the Tomcat process has the proper permissions to do so).</p><p><span class="emphasis"><em>Q: After removing the "work" directory and restarting Tomcat, my web application fails to start up entirely. What's wrong?</em></span></p><p>A: If the user under which the Tomcat process is running does not have the permission to create a subdirectory inside the Tomcat installation directory, Tomcat cannot re-create the "work" subdirectory. If this is the case, create a new "work" subdirectory (with write-permission for the Tomcat-user) yourself.</p><p><span class="emphasis"><em>Q: I only get a "HTTP 404" when I try to access the  login URL, but I don't see any error log messages, and all configuration files are ok. What's going on?</em></span></p><p>A: Experience showed that strange behavior like this is most often caused by problems with file or directory permissions. Make sure that the entire Tomcat installation directory tree has the right user and group IDs and has the correct permissions for that user.</p><p><a id="x41547_Important_TextTarsec_Q_A_cookie_that_was_created_by_the_SLS"></a><span class="emphasis"><em>Q: A cookie that was created by the SLS as a version 0 cookie, and without quotes around the value, ends up being a version 1 cookie with quotes. Why?</em></span></p><p>A: This is a Tomcat behaviour that is documented here:</p><p><a class="ulink" href="http://tomcat.apache.org/tomcat-6.0-doc/config/systemprops.html" target="_top">http://tomcat.apache.org/tomcat-6.0-doc/config/systemprops.html</a></p><p>To avoid this, set this system property in the Tomcat startup script:</p><pre class="screen">-Dorg.apache.catalina.STRICT_SERVLET_COMPLIANCE=true</pre><p><span class="emphasis"><em>Q: I'm having problems with my URI / URL. Which configuration files do I need to check?</em></span></p><p>A: These files contain a URI / URL related to the  in some way. For details about the configuration values, read the documentation that belongs to the component (for :</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p class="simpara">
HSP HTTP and HTTPS listeners:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem">
http.conf
</li></ul></div></li><li class="listitem"><p class="simpara">
SRManager:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem">
http.conf
</li></ul></div></li><li class="listitem"><p class="simpara">
Tomcat:
</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem">
conf/server.xml
</li><li class="listitem">
webapp/sls/WEB-INF/web.xml
</li><li class="listitem">
webapp/sls/WEB-INF/struts-config.xml
</li></ul></div></li></ul></div><p><span class="emphasis"><em>Q: Tomcat or my web application does not find some JAR or resource files to which I have made soft-links (Unix).</em></span></p><p>A: It is a known fact that Tomcat has problems finding files that are available through softlinks. It is generally recommended, therefore, to make all files available to Tomcat as real files and not through links.</p><p><span class="emphasis"><em>Q: The debug or trace log seems to be missing some records. It appears as if, for some mysterious reason, parts of the SLS code suddenly just don't create any debug or trace log anymore.</em></span></p><p>A: This can happen if multitenancy (see <a class="link" href="#x18987_Heading1Tarsec_Multitenancy_Support" title="Chapter 18. Multitenancy Support">"Multitenancy Support"</a>) has been enabled, but the logging configuration has not been adapted accordingly. If the current SLS session has a tenant set, but  no log configuration exists for that tenant (see <a class="link" href="#x59059_Heading2Tarsec_Tenant_specific_logging" title="25.7. Tenant-specific logging">"Tenant-specific logging"</a>), no debug or trace log records may be created.</p><p><span class="emphasis"><em>Q: I have configured authorizations for a location in the HSP and now the login model suddenly restarts in the middle.</em></span></p><p>A: This bug is fixed since SLS 4.20.0. For older SLS versions, see the detailed explanations below:</p><p>This can happen if a login model is retriggered when the HSP sends headers about required authorizations during the login process after the first request of a login.</p><p>Take the following sample configuration which defines an authorization "foo" for the /app location and a login location for it:</p><pre class="screen">&lt;Location /app&gt;
SetHandler                 http_1_1_gw_handler
HGW_Host                   sample:9999
HGW_RequestHeaders         %SRM_as_std
AC_LoginPage               /sls/login
AC_AuthorizedPath          /app
AC_AccessArea              Member
AC_RequireAz               foo
&lt;/Location&gt;

&lt;Location /sls/login&gt;
HGW_Host                   sample:9999
HGW_RequestHeaders         %SRM_ls_std
AC_LoginPage               /sls/login
AC_StartPage               /sls/login
AC_AuthorizedPath          /app
AC_RequireAzNone
&lt;/Location&gt;</pre><p>Now, say, the user starts by sending a request to the the /app location and is redirected by the HSP to the login location with a requested page, as follows:</p><pre class="screen">GET /login/sls?RequestedPage=%2fapp HTTP/1.1</pre><p>In this case, the HSP takes required authorizations from the location of the requested page, i.e. the /app location in this case ("%2f" is "/" URL encoded), which is the "foo" authorization and sends required authorization headers to the SLS:</p><pre class="screen">HSP_AC_SESSION_ATTRIBUTES_REQAZ-0: name="foo",
path="/app", value="allow", vtype="direct",
encoding="string", usage="ac-app-az"</pre><p>Now, suppose as a next step in the login model the SLS sends a login form to the client and the user then posts it:</p><pre class="screen">POST /login/sls HTTP/1.1</pre><p>In this case, since there is no RequestedPage parameter as the first GET parameter in the request, the HSP determines the location to use for determining required authorizations as follows: The location defined in the AC_AuthorizedPath for the login location, which is the /app location again in this example.</p><p>Now the HSP sends again the same required authorization headers in this example, which can cause the SLS model to restart.</p><p>This can be resolved by changing the AC_AuthorizedPath for the login location, which, however, must be a sublocation of the AC_AuthorizedPath location of the /app location. In this case, we use /, which is also the default if no AC_AuthorizedPath is defined.</p><pre class="screen">&lt;Location /sls/login&gt;
HGW_Host                   sample:9999
HGW_RequestHeaders         %SRM_ls_std
AC_LoginPage               /sls/login
AC_StartPage               /sls/login
AC_AuthorizedPath          /
AC_RequireAzNone
&lt;/Location&gt;</pre><p>In other words, the HSP always sends required authorization headers for some location (if that location has any required authorizations), only how that location is determinded is different depending on whether there is a RequestedPage parameter as  the first GET parameter or not.</p><p>Note also, that with SLS &lt;4.20.0 it is not possible to define authorizations for the / location and avoid the described problem (because if the / location requires authorizations, there are no sublocations except / itself), i.e. some login models cannot not be used if the root location has authorizations set.</p><p>Since SLS 4.20.0, the req az headers sent by the HSP are only considered if there is a RequestedPage parameter or if it is the first request for SLS login session.</p></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="_additions"></a>Chapter 71. Additions</h2></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_documentation"></a>71.1. Documentation</h2></div></div></div><div class="table"><a id="idm16101"></a><p class="title"><strong>Table 71.1. Additions</strong></p><div class="table-contents"><table class="table" summary="Additions" cellpadding="4px" style="border-collapse: collapse;border-top: 3px solid #527bbd; border-bottom: 3px solid #527bbd; border-left: 3px solid #527bbd; border-right: 3px solid #527bbd; "><colgroup><col class="col_1" /><col class="col_2" /><col class="col_3" /></colgroup><thead><tr><th style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top">Ref. </th><th style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top">Document </th><th style="border-bottom: 1px solid #527bbd; " align="left" valign="top">Version/Date</th></tr></thead><tbody><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>HTTPADMIN<a id="HTTPADMIN"></a></p></td><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>HSP Administration Guide:</p>
<p><code class="literal">http-admin.pdf</code></p></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>Version 4.2.19.1, 2009</p></td></tr><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>LOGMESSAGES<a id="LOGMESSAGES"></a></p></td><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>Secure Login Service log messages
<code class="literal">sls-log-messages.pdf</code></p></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>same as this document</p></td></tr><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>JEXLGUIDE<a id="JEXLGUIDE"></a></p></td><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>Secure Login Service JEXL Functions
<code class="literal">sls-jexl-guide.pdf</code></p></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><p>same as this document</p></td></tr><tr><td style="border-right: 1px solid #527bbd; " align="left" valign="top"><p>TABLIBGUIDE<a id="TABLIBGUIDE"></a></p></td><td style="border-right: 1px solid #527bbd; " align="left" valign="top"><p>Secure Login Service JSP Tag Library</p></td><td style="" align="left" valign="top"><p>same as this document</p>
<p><code class="literal">ASP_installation_guide_v1.2.pdf</code></p></td></tr></tbody></table></div></div><br class="table-break" /></div><div class="glossary"><div class="titlepage"><div><div><h2 class="title"><a id="_glossary_4"></a>Glossary</h2></div></div></div><div class="table"><a id="idm16153"></a><p class="title"><strong>Table 71.2. Glossary</strong></p><div class="table-contents"><table class="table" summary="Glossary" cellpadding="4px" style="border-collapse: collapse;border-top: 3px solid #527bbd; border-bottom: 3px solid #527bbd; border-left: 3px solid #527bbd; border-right: 3px solid #527bbd; "><colgroup><col class="col_1" /><col class="col_2" /></colgroup><thead><tr><th style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><span class="emphasis"><em>Term</em></span> </th><th style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><span class="emphasis"><em>Definition</em></span></th></tr></thead><tbody><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p><span class="emphasis"><em>HSP</em></span></p></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><p><span class="emphasis"><em>Http Secure Proxy</em></span></p>
<p>This is the reverse proxy part of the SES.</p></td></tr><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p><span class="emphasis"><em>SES</em></span></p></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><p><span class="emphasis"><em>USP Secure Entry Server, the entire software suite, entailing the reverse proxy and the login service.</em></span></p></td></tr><tr><td style="border-right: 1px solid #527bbd; " align="left" valign="top"><p><span class="emphasis"><em>SRM</em></span></p></td><td style="" align="left" valign="top"><p><span class="emphasis"><em>Secure Request Manager, a part of the reverse proxy.</em></span></p></td></tr></tbody></table></div></div><br class="table-break" /></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="x44448_Heading2Tarsec_Regular_expressions"></a>71.2. Regular expressions reference</h2></div></div></div><p>The RegExp library used to evaluate the expression is Sun's regex implementation in the JDK (package "java.util.regex"). Details can be found here:</p><p><a class="ulink" href="http://java.sun.com/j2se/1.5.0/docs/api/java/util/regex/package-summary.html" target="_top">http://java.sun.com/j2se/1.5.0/docs/api/java/util/regex/package-summary.html</a></p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_characters"></a>71.2.1. Characters</h3></div></div></div><p>\\              The backslash character</p><p>\0n             The character with octal value 0n (0 ⇐ n ⇐ 7)</p><p>\0nn            The character with octal value 0nn (0 ⇐ n ⇐ 7)</p><p>\0mnn           The character with octal value 0mnn (0 ⇐ m ⇐ 3, 0 ⇐ n ⇐ 7)</p><p>\xhh            The character with hexadecimal value 0xhh</p><p>\uhhhh          The character with hexadecimal value 0xhhhh</p><p>\t              The tab character (<span class="emphasis"><em>\u0009</em></span>)</p><p>\n              The newline (line feed) character (<span class="emphasis"><em>\u000A</em></span>)</p><p>\r              The carriage-return character (<span class="emphasis"><em>\u000D</em></span>)</p><p>\f              The form-feed character (<span class="emphasis"><em>\u000C</em></span>)</p><p>\a              The alert (bell) character (<span class="emphasis"><em>\u0007</em></span>)</p><p>\e              The escape character (<span class="emphasis"><em>\u001B</em></span>)</p><p>\cx             The control character corresponding to x</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_character_classes"></a>71.2.2. Character Classes</h3></div></div></div><p>[abc]                   a, b, or c (simple class)</p><p>[^abc]                  Any character except a, b, or c (negation)</p><p>[a-zA-Z]                        a through z or A through Z, inclusive (range)</p><p>\[a-z-\[bc\]\]                  a through z, except for b and c: [ad-z] (subtraction)</p><p>\[a-z-\[m-p\]\]                         a through z, except for m through p: [a-lq-z]</p><p>\[a-z-\[^def\]\]                        d, e, or f</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_predefined_character_classes"></a>71.2.3. Predefined Character Classes</h3></div></div></div><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">
Any character (may or may not match line terminators)
</li></ol></div><p>\d      A digit: [0-9]</p><p>\D      A non-digit: [^0-9]</p><p>\s      A whitespace character: [ \t\n\x0B\f\r]</p><p>\S      A non-whitespace character: [^\s]</p><p>\w      A word character: [a-zA-Z_0-9]</p><p>\W      A non-word character: [^\w]</p></div></div></div></div></div></body></html>